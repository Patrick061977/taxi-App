<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <title>Funk Taxi Heringsdorf</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; overflow-x: hidden; }
        .app-container { max-width: 100vw; margin: 0 auto; background: white; min-height: 100vh; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header h1 { font-size: 22px; margin-bottom: 5px; }
        .sync-indicator { display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 11px; margin-top: 5px; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #f59e0b; }
        .sync-dot.online { background: #10b981; animation: pulse 2s infinite; }
        .sync-dot.offline { background: #6b7280; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .view-selector { display: flex; background: white; border-bottom: 2px solid #e0e0e0; position: sticky; top: 90px; z-index: 99; }
        .view-btn { flex: 1; padding: 15px; border: none; background: white; font-size: 14px; font-weight: 500; color: #666; cursor: pointer; position: relative; }
        .view-btn.active { color: #667eea; border-bottom: 3px solid #667eea; }
        .notification-badge { position: absolute; top: 8px; right: 8px; background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; font-weight: bold; display: none; align-items: center; justify-content: center; }
        .notification-badge.show { display: flex; }
        .view { display: none; padding: 15px; padding-bottom: 100px; }
        .view.active { display: block; }
        .section-title { font-size: 18px; font-weight: 600; margin: 20px 0 15px 0; color: #333; }
        .input-group { margin-bottom: 15px; position: relative; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #333; font-size: 14px; }
        .input-group input, .input-group select { width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; }
        .input-group input:focus { border-color: #667eea; outline: none; }
        .autocomplete-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #667eea; border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; display: none; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .autocomplete-dropdown.show { display: block; }
        .autocomplete-item { padding: 12px 14px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        .autocomplete-item:hover { background: #f5f3ff; }
        .autocomplete-loading { padding: 12px 14px; text-align: center; color: #999; font-size: 14px; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 10px; transition: opacity 0.3s; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-success { background: #10b981; color: white; }
        .price-display { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #10b981; border-radius: 12px; padding: 20px; margin: 20px 0; text-align: center; }
        .price-display .price { font-size: 36px; font-weight: bold; color: #047857; }
        .price-breakdown { margin-top: 15px; padding-top: 15px; border-top: 1px solid #10b981; font-size: 13px; color: #059669; text-align: left; }
        .price-breakdown div { display: flex; justify-content: space-between; margin: 5px 0; }
        #map { height: 300px; border-radius: 12px; margin: 15px 0; border: 2px solid #e0e0e0; }
        .ride-card { background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .ride-card .ride-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .ride-id { font-weight: 600; color: #667eea; }
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-new { background: #fef3c7; color: #92400e; }
        .status-accepted { background: #dbeafe; color: #1e40af; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .ride-details { font-size: 14px; color: #666; line-height: 1.8; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; }
        .stat-card .stat-value { font-size: 28px; font-weight: bold; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .alert-success { background: #d1fae5; color: #065f46; border: 2px solid #10b981; }
        .alert-info { background: #dbeafe; color: #1e40af; border: 2px solid #3b82f6; }
        .alert-warning { background: #fef3c7; color: #92400e; border: 2px solid #f59e0b; }
        .quick-test-btn { background: #fef3c7; border: 2px solid #f59e0b; color: #92400e; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: 600; cursor: pointer; text-align: center; }
        .empty-state { text-align: center; padding: 40px 20px; color: #999; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .taxi-marker { font-size: 24px; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>üöï Funk Taxi Heringsdorf</h1>
            <p style="font-size: 11px; opacity: 0.8; margin-bottom: 3px;">Version 2.3.1 - ETA Fix</p>
            <div class="sync-indicator">
                <div class="sync-dot" id="sync-dot"></div>
                <span id="sync-status">Starte...</span>
            </div>
        </div>

        <div class="view-selector">
            <button class="view-btn active" onclick="switchView('passenger')">Fahrgast<span class="notification-badge" id="passenger-badge">0</span></button>
            <button class="view-btn" onclick="switchView('driver')">Fahrer<span class="notification-badge" id="driver-badge">0</span></button>
            <button class="view-btn" onclick="switchView('admin')">Admin</button>
        </div>

        <div id="passenger-view" class="view active">
            <div class="section-title">Neue Fahrt buchen</div>
            <div class="quick-test-btn" onclick="fillTest()">‚ö° Schnelltest laden</div>
            <div class="input-group">
                <label>üìç Abholort</label>
                <input type="text" id="pickup" placeholder="z.B. Bahnhof Heringsdorf" autocomplete="off">
                <div class="autocomplete-dropdown" id="pickup-dropdown"></div>
            </div>
            <div class="input-group">
                <label>üéØ Zielort</label>
                <input type="text" id="destination" placeholder="z.B. Seebr√ºcke Ahlbeck" autocomplete="off">
                <div class="autocomplete-dropdown" id="destination-dropdown"></div>
            </div>
            <div class="input-group">
                <label>üë• Personen</label>
                <select id="passengers">
                    <option value="1">1 Person</option>
                    <option value="2">2 Personen</option>
                    <option value="3">3 Personen</option>
                    <option value="4">4 Personen</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="calcPrice()">üí∞ Preis berechnen</button>
            <div id="price-result"></div>
            <button id="book-btn" class="btn btn-success" style="display: none;" onclick="book()">üöï JETZT BUCHEN</button>
            <div id="confirm"></div>
            <div id="passenger-map-container" style="display: none;">
                <div class="section-title">Dein Taxi</div>
                <div id="map"></div>
                <div id="eta-info" class="alert alert-info" style="display: none;"></div>
            </div>
        </div>

        <div id="driver-view" class="view">
            <div class="section-title">Fahrer Dashboard</div>
            <div class="input-group">
                <label>üöó Fahrzeug</label>
                <select id="vehicle" onchange="setVehicle()">
                    <option value="">-- W√§hlen --</option>
                    <option value="Tesla Model 3 #1">Tesla Model 3 #1</option>
                    <option value="Tesla Model 3 #2">Tesla Model 3 #2</option>
                    <option value="Tesla Model 3 #3">Tesla Model 3 #3</option>
                    <option value="Tesla Model Y #1">Tesla Model Y #1</option>
                    <option value="Tesla Model Y #2">Tesla Model Y #2</option>
                </select>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="d-rides">0</div><div>Fahrten</div></div>
                <div class="stat-card"><div class="stat-value" id="d-money">0‚Ç¨</div><div>Verdienst</div></div>
            </div>
            <div id="driver-current-ride"></div>
            <div class="section-title">Neue Auftr√§ge</div>
            <div id="new-rides"></div>
            <div class="section-title">Meine Fahrten</div>
            <div id="my-rides"></div>
        </div>

        <div id="admin-view" class="view">
            <div class="section-title">Dashboard</div>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="a-total">0</div><div>Fahrten</div></div>
                <div class="stat-card"><div class="stat-value" id="a-revenue">0‚Ç¨</div><div>Umsatz</div></div>
                <div class="stat-card"><div class="stat-value" id="a-pending">0</div><div>Offen</div></div>
                <div class="stat-card"><div class="stat-value" id="a-active">0</div><div>Aktiv</div></div>
            </div>
            <div class="section-title">Alle Fahrten (Live)</div>
            <div id="all-rides"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let firebaseLoadTimeout, firebaseLoaded = false;
        firebaseLoadTimeout = setTimeout(() => { if (!firebaseLoaded) { console.log('‚ö†Ô∏è Firebase Timeout'); initApp(false); } }, 5000);
    </script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js" onload="firebaseLoaded = true;" onerror="initApp(false);"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script>
        console.log('üöÄ Version 2.3.1 - ETA Fix');
        const TARIF = { grundgebuehr: 4.00, kmPreis: 2.20, nachtZuschlag: 0.20, sonntagZuschlag: 0.25, feiertagZuschlag: 0.50 };
        const FEIERTAGE = ['2024-12-25','2024-12-26','2025-01-01','2025-04-18','2025-04-21','2025-05-01','2025-05-29','2025-06-09','2025-10-03','2025-12-25','2025-12-26'];
        let db = null, isFirebaseReady = false, isConnected = false, currentVehicle = null, currentView = 'passenger', rides = [], ridesCache = {}, updateInterval = null;
        let searchTimeout = null, pickupCoords = null, destCoords = null;
        let map = null, taxiMarker = null, routeLine = null, watchId = null, etaUpdateInterval = null;

        function setupAutocomplete() {
            const pickupInput = document.getElementById('pickup'), destInput = document.getElementById('destination');
            pickupInput.addEventListener('input', () => handleAutocomplete(pickupInput, 'pickup-dropdown'));
            destInput.addEventListener('input', () => handleAutocomplete(destInput, 'destination-dropdown'));
            document.addEventListener('click', (e) => { if (!e.target.closest('.input-group')) closeAllDropdowns(); });
        }

        function handleAutocomplete(input, dropdownId) {
            const query = input.value.trim(), dropdown = document.getElementById(dropdownId);
            if (query.length < 3) { dropdown.classList.remove('show'); return; }
            clearTimeout(searchTimeout);
            dropdown.innerHTML = '<div class="autocomplete-loading">Suche...</div>';
            dropdown.classList.add('show');
            searchTimeout = setTimeout(() => { searchLocations(query, dropdown, dropdownId); }, 500);
        }

        async function searchLocations(query, dropdown, dropdownId) {
            try {
                const viewbox = '13.7,53.9,14.2,54.1';
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&viewbox=${viewbox}&bounded=1&limit=5`;
                const response = await fetch(url);
                const results = await response.json();
                if (results.length === 0) { dropdown.innerHTML = '<div class="autocomplete-loading">Keine Ergebnisse</div>'; return; }
                dropdown.innerHTML = results.map(result => {
                    const name = result.display_name.split(',').slice(0, 2).join(',');
                    return `<div class="autocomplete-item" onclick='selectLocation(${JSON.stringify(result)}, "${dropdownId}")'>${name}</div>`;
                }).join('');
            } catch (error) { dropdown.innerHTML = '<div class="autocomplete-loading">Fehler</div>'; }
        }

        function selectLocation(location, dropdownId) {
            const inputId = dropdownId.replace('-dropdown', ''), input = document.getElementById(inputId);
            const shortName = location.display_name.split(',').slice(0, 2).join(',');
            input.value = shortName;
            if (inputId === 'pickup') pickupCoords = { lat: parseFloat(location.lat), lon: parseFloat(location.lon) };
            else destCoords = { lat: parseFloat(location.lat), lon: parseFloat(location.lon) };
            closeAllDropdowns();
        }

        function closeAllDropdowns() { document.querySelectorAll('.autocomplete-dropdown').forEach(d => d.classList.remove('show')); }

        async function calculateRoute(pickup, dest) {
            try {
                const url = `https://router.project-osrm.org/route/v1/driving/${pickup.lon},${pickup.lat};${dest.lon},${dest.lat}?overview=false`;
                const response = await fetch(url);
                const data = await response.json();
                if (data.code !== 'Ok' || !data.routes || data.routes.length === 0) throw new Error('Keine Route');
                const route = data.routes[0];
                return { distance: parseFloat((route.distance / 1000).toFixed(1)), duration: Math.round(route.duration / 60) };
            } catch (error) {
                const distance = calculateDistance(pickup.lat, pickup.lon, dest.lat, dest.lon);
                return { distance: parseFloat(distance.toFixed(1)), duration: Math.round(distance / 0.5) };
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371, dLat = (lat2 - lat1) * Math.PI / 180, dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function calculatePrice(distance) {
            const now = new Date(), hour = now.getHours(), day = now.getDay(), dateStr = now.toISOString().split('T')[0];
            let basePrice = TARIF.grundgebuehr + (distance * TARIF.kmPreis), zuschlag = 0, zuschlagText = [];
            if (hour >= 22 || hour < 6) { zuschlag += basePrice * TARIF.nachtZuschlag; zuschlagText.push('Nacht +20%'); }
            if (day === 0) { zuschlag += basePrice * TARIF.sonntagZuschlag; zuschlagText.push('Sonntag +25%'); }
            if (FEIERTAGE.includes(dateStr)) { zuschlag += basePrice * TARIF.feiertagZuschlag; zuschlagText.push('Feiertag +50%'); }
            const total = basePrice + zuschlag;
            return { base: basePrice.toFixed(2), zuschlag: zuschlag.toFixed(2), total: total.toFixed(2), zuschlagText: zuschlagText };
        }

        async function calcPrice() {
            const pickup = document.getElementById('pickup').value, dest = document.getElementById('destination').value;
            if (!pickup || !dest) { alert('‚ùå Bitte Orte eingeben!'); return; }
            if (!pickupCoords || !destCoords) { alert('‚ùå Bitte Orte aus Dropdown ausw√§hlen!'); return; }
            const result = document.getElementById('price-result');
            result.innerHTML = '<div class="alert alert-info"><div class="loading"></div> Berechne Route...</div>';
            try {
                const route = await calculateRoute(pickupCoords, destCoords);
                const pricing = calculatePrice(route.distance);
                window.currentPrice = pricing.total;
                window.currentDistance = route.distance;
                window.currentDuration = route.duration;
                let priceBreakdown = `<div class="price-breakdown"><div><span>Grundgeb√ºhr:</span><span>${TARIF.grundgebuehr.toFixed(2)}‚Ç¨</span></div><div><span>Kilometer (${route.distance} km):</span><span>${(route.distance * TARIF.kmPreis).toFixed(2)}‚Ç¨</span></div>`;
                if (pricing.zuschlag > 0) priceBreakdown += `<div><span>${pricing.zuschlagText.join(', ')}:</span><span>+${pricing.zuschlag}‚Ç¨</span></div>`;
                priceBreakdown += `</div>`;
                result.innerHTML = `<div class="price-display"><div style="font-size: 14px; color: #059669; margin-bottom: 5px;">Fahrpreis</div><div class="price">${pricing.total}‚Ç¨</div><div style="margin-top: 10px; font-size: 13px; color: #059669;">üìç ${route.distance} km ‚Ä¢ ‚è±Ô∏è ca. ${route.duration} Min<br>Tarif: Vorpommern-Greifswald</div>${priceBreakdown}</div>`;
                document.getElementById('book-btn').style.display = 'block';
                document.getElementById('book-btn').scrollIntoView({ behavior: 'smooth' });
            } catch (e) { result.innerHTML = '<div class="alert alert-warning">‚ùå Routenberechnung fehlgeschlagen.</div>'; }
        }

        async function book() {
            try {
                const pickup = document.getElementById('pickup').value, dest = document.getElementById('destination').value, pass = document.getElementById('passengers').value;
                if (!window.currentPrice) { alert('‚ùå Bitte erst Preis berechnen!'); return; }
                const ride = { id: Date.now(), pickup, destination: dest, passengers: pass, price: window.currentPrice, distance: window.currentDistance, duration: window.currentDuration, pickupCoords, destCoords, status: 'new', time: new Date().toLocaleString('de-DE'), vehicle: null, driver: null, driverLocation: null, createdAt: Date.now() };
                const bookBtn = document.getElementById('book-btn');
                bookBtn.disabled = true; bookBtn.textContent = '‚è≥ Speichere...';
                await saveRide(ride);
                const syncMode = isFirebaseReady ? '‚òÅÔ∏è Cloud' : 'üíæ Lokal';
                document.getElementById('confirm').innerHTML = `<div class="alert alert-success"><strong>‚úì Buchung erfolgreich!</strong><br>Fahrt-ID: <strong>#${ride.id}</strong><br>Preis: <strong>${ride.price}‚Ç¨</strong><br><small>${syncMode} gespeichert</small></div>`;
                document.getElementById('pickup').value = ''; document.getElementById('destination').value = ''; document.getElementById('price-result').innerHTML = '';
                bookBtn.style.display = 'none'; bookBtn.disabled = false; bookBtn.textContent = 'üöï JETZT BUCHEN';
                setTimeout(() => { document.getElementById('confirm').innerHTML = ''; }, 5000);
            } catch (e) { alert('‚ùå FEHLER: ' + e.message); const bookBtn = document.getElementById('book-btn'); bookBtn.disabled = false; bookBtn.textContent = 'üöï JETZT BUCHEN'; }
        }

        function initMap() {
            if (!map) {
                map = L.map('map').setView([53.99, 14.15], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);
            }
        }

        function startDriverTracking(rideId) {
            if (!navigator.geolocation) return;
            watchId = navigator.geolocation.watchPosition((position) => {
                const location = { lat: position.coords.latitude, lon: position.coords.longitude, timestamp: Date.now() };
                if (isFirebaseReady && rideId) updateRide(rideId, { driverLocation: location });
            }, (error) => console.error('GPS:', error), { enableHighAccuracy: true, maximumAge: 10000 });
        }

        function stopDriverTracking() { if (watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; } }

        async function updateETAWithRealRoute(ride) {
            if (!ride.driverLocation || !ride.pickupCoords) return;
            try {
                const route = await calculateRoute(ride.driverLocation, ride.pickupCoords);
                const etaDiv = document.getElementById('eta-info');
                etaDiv.style.display = 'block';
                etaDiv.innerHTML = `üöï Dein Taxi ist <strong>${route.distance} km</strong> entfernt (ca. <strong>${route.duration} Min</strong>)`;
            } catch (error) {
                const dist = calculateDistance(ride.driverLocation.lat, ride.driverLocation.lon, ride.pickupCoords.lat, ride.pickupCoords.lon);
                const eta = Math.round((dist / 0.5) * 60);
                const etaDiv = document.getElementById('eta-info');
                etaDiv.style.display = 'block';
                etaDiv.innerHTML = `üöï Dein Taxi ist <strong>${dist.toFixed(1)} km</strong> entfernt (ca. <strong>${eta} Min</strong>)`;
            }
        }

        function showTaxiOnMap(ride) {
            if (!ride.driverLocation) return;
            initMap();
            const loc = ride.driverLocation;
            if (taxiMarker) taxiMarker.setLatLng([loc.lat, loc.lon]);
            else taxiMarker = L.marker([loc.lat, loc.lon], { icon: L.divIcon({ html: '<div class="taxi-marker">üöï</div>', className: '', iconSize: [30, 30] }) }).addTo(map);
            if (ride.pickupCoords && !routeLine) L.marker([ride.pickupCoords.lat, ride.pickupCoords.lon], { icon: L.divIcon({ html: 'üìç', className: '', iconSize: [20, 20] }) }).addTo(map);
            updateETAWithRealRoute(ride);
            map.setView([loc.lat, loc.lon], 14);
            document.getElementById('passenger-map-container').style.display = 'block';
            if (!etaUpdateInterval) {
                etaUpdateInterval = setInterval(() => { updateETAWithRealRoute(ride); }, 30000);
            }
        }

        function initApp(hasFirebase) {
            clearTimeout(firebaseLoadTimeout);
            if (hasFirebase && typeof firebase !== 'undefined') {
                try {
                    firebase.initializeApp({ apiKey: "AIzaSyD2eHFuplImxBCijd3MWlKyCwXUZHLmhhE", authDomain: "taxi-heringsdorf.firebaseapp.com", databaseURL: "https://taxi-heringsdorf-default-rtdb.europe-west1.firebasedatabase.app", projectId: "taxi-heringsdorf", storageBucket: "taxi-heringsdorf.firebasestorage.app", messagingSenderId: "886448081276", appId: "1:886448081276:web:1b54875801c5d89f8efcf9" });
                    db = firebase.database(); isFirebaseReady = true;
                    db.ref('.info/connected').on('value', (snapshot) => { isConnected = snapshot.val() === true; updateConnectionStatus(); });
                    listenToFirebase();
                } catch (error) { startLocalMode(); }
            } else startLocalMode();
        }

        function startLocalMode() { isFirebaseReady = false; isConnected = false; updateConnectionStatus(); loadFromLocalStorage(); updateInterval = setInterval(() => { loadFromLocalStorage(); }, 2000); }

        function updateConnectionStatus() {
            const dot = document.getElementById('sync-dot'), status = document.getElementById('sync-status');
            if (isFirebaseReady && isConnected) { dot.classList.add('online'); dot.classList.remove('offline'); status.textContent = 'üü¢ Live'; }
            else if (isFirebaseReady && !isConnected) { dot.classList.remove('online'); dot.classList.add('offline'); status.textContent = 'üî¥ Offline'; }
            else { dot.classList.remove('online'); dot.classList.remove('offline'); status.textContent = 'üíæ Lokal'; }
        }

        function listenToFirebase() {
            db.ref('rides').on('value', (snapshot) => {
                rides = [];
                snapshot.forEach((child) => {
                    const ride = child.val(); ride.firebaseId = child.key; rides.push(ride);
                    if (!ridesCache[child.key] && ride.status === 'new') playNotificationSound();
                    ridesCache[child.key] = true;
                    if (currentView === 'passenger' && ride.status === 'accepted' && ride.driverLocation) showTaxiOnMap(ride);
                });
                updateAllViews();
            });
        }

        async function saveRide(ride) { if (isFirebaseReady) { try { const ridesRef = db.ref('rides'), newRideRef = ridesRef.push(); ride.firebaseId = newRideRef.key; await newRideRef.set(ride); return ride; } catch (error) { return saveLocal(ride); } } else return saveLocal(ride); }
        async function updateRide(rideId, updates) { if (isFirebaseReady) { try { await db.ref('rides/' + rideId).update(updates); } catch (error) { updateLocal(rideId, updates); } } else updateLocal(rideId, updates); }
        function saveLocal(ride) { ride.firebaseId = 'local-' + Date.now(); rides.push(ride); localStorage.setItem('taxi-rides', JSON.stringify(rides)); updateAllViews(); return ride; }
        function updateLocal(rideId, updates) { const ride = rides.find(r => r.firebaseId === rideId); if (ride) { Object.assign(ride, updates); localStorage.setItem('taxi-rides', JSON.stringify(rides)); updateAllViews(); } }
        function loadFromLocalStorage() { try { const data = localStorage.getItem('taxi-rides'); if (data) { rides = JSON.parse(data); updateAllViews(); } } catch (e) {} }

        function setVehicle() { currentVehicle = document.getElementById('vehicle').value; updateAllViews(); }
        async function acceptRide(rideId) { if (!currentVehicle) { alert('‚ùå Bitte erst Fahrzeug w√§hlen!'); return; } await updateRide(rideId, { status: 'accepted', vehicle: currentVehicle, driver: currentVehicle }); startDriverTracking(rideId); alert('‚úÖ Auftrag angenommen! GPS aktiv.'); }
        async function completeRide(rideId) { await updateRide(rideId, { status: 'completed', driverLocation: null }); stopDriverTracking(); if (etaUpdateInterval) { clearInterval(etaUpdateInterval); etaUpdateInterval = null; } alert('‚úÖ Fahrt abgeschlossen!'); }

        function updateDriverView() {
            const newRides = rides.filter(r => r.status === 'new'), myRides = currentVehicle ? rides.filter(r => r.vehicle === currentVehicle) : [];
            const currentRide = myRides.find(r => r.status === 'accepted'), completed = myRides.filter(r => r.status === 'completed');
            const badge = document.getElementById('driver-badge');
            if (newRides.length > 0) { badge.textContent = newRides.length; badge.classList.add('show'); } else badge.classList.remove('show');
            const currentRideDiv = document.getElementById('driver-current-ride');
            if (currentRide) currentRideDiv.innerHTML = `<div class="alert alert-info"><strong>üöó Aktuelle Fahrt #${currentRide.id}</strong><br>Von: ${currentRide.pickup}<br>Nach: ${currentRide.destination}<br>Distanz: ${currentRide.distance} km<br>Preis: ${currentRide.price}‚Ç¨<br><small>üìç GPS-Tracking aktiv</small><button class="btn btn-success" style="margin-top: 10px;" onclick="completeRide('${currentRide.firebaseId}')">‚úì Abschlie√üen</button></div>`;
            else currentRideDiv.innerHTML = currentVehicle ? '<div class="alert alert-info">üü¢ Bereit f√ºr Auftr√§ge</div>' : '';
            const newList = document.getElementById('new-rides');
            if (!currentVehicle) newList.innerHTML = '<div class="alert alert-warning">Bitte erst Fahrzeug w√§hlen</div>';
            else if (newRides.length === 0) newList.innerHTML = '<div class="empty-state">Keine neuen Auftr√§ge</div>';
            else newList.innerHTML = newRides.map(r => `<div class="ride-card"><div class="ride-header"><span class="ride-id">#${r.id}</span><span class="status-badge status-new">Neu</span></div><div class="ride-details"><strong>Von:</strong> ${r.pickup}<br><strong>Nach:</strong> ${r.destination}<br><strong>Distanz:</strong> ${r.distance} km ‚Ä¢ ${r.duration} Min<br><strong>Preis:</strong> ${r.price}‚Ç¨</div>${!currentRide ? `<button class="btn btn-success" style="margin-top: 10px;" onclick="acceptRide('${r.firebaseId}')">‚úì Annehmen</button>` : '<small style="color: #999;">Schlie√üe erst aktuelle Fahrt ab</small>'}</div>`).join('');
            const myList = document.getElementById('my-rides');
            if (!currentVehicle) myList.innerHTML = '';
            else if (myRides.length === 0) myList.innerHTML = '<div class="empty-state">Keine Fahrten</div>';
            else myList.innerHTML = myRides.map(r => `<div class="ride-card"><div class="ride-header"><span class="ride-id">#${r.id}</span><span class="status-badge status-${r.status}">${r.status}</span></div><div class="ride-details">Von: ${r.pickup}<br>Nach: ${r.destination}<br>${r.distance} km ‚Ä¢ ${r.duration} Min<br>Preis: ${r.price}‚Ç¨</div></div>`).join('');
            const revenue = completed.reduce((sum, r) => sum + parseFloat(r.price), 0);
            document.getElementById('d-rides').textContent = completed.length;
            document.getElementById('d-money').textContent = revenue.toFixed(2) + '‚Ç¨';
        }

        function updateAdminView() {
            const completed = rides.filter(r => r.status === 'completed'), pending = rides.filter(r => r.status === 'new'), active = rides.filter(r => r.status === 'accepted');
            const revenue = completed.reduce((sum, r) => sum + parseFloat(r.price), 0);
            document.getElementById('a-total').textContent = completed.length;
            document.getElementById('a-revenue').textContent = revenue.toFixed(2) + '‚Ç¨';
            document.getElementById('a-pending').textContent = pending.length;
            document.getElementById('a-active').textContent = active.length;
            const list = document.getElementById('all-rides');
            if (rides.length === 0) list.innerHTML = '<div class="empty-state">Keine Fahrten</div>';
            else list.innerHTML = rides.slice().reverse().map(r => `<div class="ride-card"><div class="ride-header"><span class="ride-id">#${r.id}</span><span class="status-badge status-${r.status}">${r.status}</span></div><div class="ride-details">Von: ${r.pickup}<br>Nach: ${r.destination}<br>${r.distance} km ‚Ä¢ ${r.duration} Min<br>Preis: ${r.price}‚Ç¨<br>${r.vehicle ? `Fahrzeug: ${r.vehicle}<br>` : ''}Zeit: ${r.time}</div></div>`).join('');
        }

        function fillTest() { document.getElementById('pickup').value = 'Bahnhof Heringsdorf'; document.getElementById('destination').value = 'Seebr√ºcke Ahlbeck'; pickupCoords = { lat: 53.9553, lon: 14.1508 }; destCoords = { lat: 53.9426, lon: 14.2062 }; }
        function switchView(view) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active')); document.getElementById(view + '-view').classList.add('active'); event.target.classList.add('active'); currentView = view; updateAllViews(); }
        function updateAllViews() { if (currentView === 'driver') updateDriverView(); else if (currentView === 'admin') updateAdminView(); }
        function playNotificationSound() { try { const audioContext = new (window.AudioContext || window.webkitAudioContext)(), oscillator = audioContext.createOscillator(), gainNode = audioContext.createGain(); oscillator.connect(gainNode); gainNode.connect(audioContext.destination); oscillator.frequency.value = 800; oscillator.type = 'sine'; gainNode.gain.setValueAtTime(0.3, audioContext.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3); oscillator.start(audioContext.currentTime); oscillator.stop(audioContext.currentTime + 0.3); } catch (e) {} }
        
        window.addEventListener('DOMContentLoaded', function() {
            console.log('üì± App geladen - Version 2.3.1 - ETA Fix');
            setupAutocomplete();
            setTimeout(() => { if (firebaseLoaded && typeof firebase !== 'undefined') initApp(true); else if (!isFirebaseReady) initApp(false); }, 100);
        });
    </script>
</body>
</html>
