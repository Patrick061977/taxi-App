<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!--
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ğŸš• FUNK TAXI HERINGSDORF - WEB APP
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ“¦ VERSION: v5.90.659
    ğŸ“… BUILD: 19.01.2026 23:00 Uhr
    ğŸ‘¨â€ğŸ’» ENTWICKELT MIT: Claude (Anthropic)
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ğŸ“‹ CHANGELOG v5.90.659
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸš¨ v5.90.659 (19.01.2026):
       â€¢ KRITISCHER FIX: Zeit-Ãœberschneidung wird jetzt erkannt!
       â€¢ PrÃ¼ft ob neue Fahrt zur gleichen Zeit wie bestehende
       â€¢ PrÃ¼ft ob Taxi rechtzeitig von vorheriger Fahrt zurÃ¼ck ist
       â€¢ ALLE Zeiten mit Ein-/Ausstieg (+ 4 Min)
       â€¢ Detaillierte Zeitberechnung in der Analyse
       â€¢ Verhindert Doppelbuchungen zur gleichen Zeit!
    
    â±ï¸ v5.90.657 (19.01.2026):
       â€¢ NEU: EIN-/AUSSTIEGSZEIT EINBERECHNET!
    
    ğŸ—ºï¸ v5.90.651 (19.01.2026):
       â€¢ NEU: POI-Marker auf Karten-Picker (BahnhÃ¶fe, Hotels, Restaurants)!
       â€¢ Filter: Nur echte POIs (keine Privatadressen)
       â€¢ Klickbar: POI-Marker â†’ Adresse direkt Ã¼bernehmen
       â€¢ Icons: ğŸš‰ BahnhÃ¶fe, ğŸ¨ Hotels, ğŸ½ï¸ Restaurants, â˜• CafÃ©s, etc.
       â€¢ Schnelle Orientierung fÃ¼r Kunden beim Adresse wÃ¤hlen!
    
    ğŸ¨ v5.90.650 (19.01.2026):
       â€¢ FIX: Autocomplete zeigt jetzt POIs (Hotels, Restaurants) wie CRM-Picker!
       â€¢ LierstraÃŸe 11 zeigt jetzt "Strandhotel Heringsdorf" statt "Poolsauna"
       â€¢ API-Calls mit extratags=1 + namedetails=1 fÃ¼r volle POI-Daten
       â€¢ Verbesserte POI-Extraktion: hotel, restaurant, cafe, tourism, amenity
       â€¢ Gilt fÃ¼r: Taxi buchen + Schnellbuchung Autocomplete
    
    ğŸ› v5.90.339 (12.01.2026):
       â€¢ FIX: "distance is not defined" Fehler behoben
       â€¢ distance wird jetzt vor if/else Block definiert (Scope-Fix)
       â€¢ Rechnung-Modal funktioniert jetzt fehlerfrei
    
    ğŸ’¬ v5.90.338 (11.01.2026):
       â€¢ NEU: WhatsApp + SMS Buttons im Kalender-Modal
       â€¢ 4 Nachrichtenvorlagen: "Taxi ist da", "5 Min", "Tracking", "VerzÃ¶gerung"
       â€¢ Ã–ffnet WhatsApp/SMS direkt auf dem Handy
       â€¢ Tesla-Browser kompatibel
    
    ğŸ¯ v5.90.337 (11.01.2026):
       â€¢ FIX: Auto-Zuweisung funktioniert jetzt!
       â€¢ Doppelte leere startAutoAssignment() Funktion entfernt
       â€¢ Auto-Zuweisung lÃ¤uft ab dieser Version korrekt!
    
    ğŸšŒ v5.90.336 (11.01.2026):
       â€¢ FIX: Fahrplan (Ã–ffentliche Verkehrsmittel) lÃ¤dt automatisch
       â€¢ switchView prÃ¼fte falsch auf 'calendar' statt 'schedule'
       â€¢ loadSchedule() wird jetzt beim Ã–ffnen aufgerufen
    
    ğŸ“… v5.90.335 (11.01.2026):
       â€¢ FIX: Tracking-Link wird im Kalender wieder erstellt
       â€¢ saveEditedRide() erstellt Link + sendet SMS an Kunde
    
    ğŸ”— v5.90.334 (11.01.2026):
       â€¢ FIX: Tracking-Link bei acceptRide() erstellt
       â€¢ Kein extra "Fahrt zum Kunden" Button mehr nÃ¶tig
       â€¢ Link wird automatisch erstellt wenn Fahrer annimmt
    
    ğŸš€ v5.90.333 (11.01.2026):
       â€¢ FIX: startAutoAssignment() wird aufgerufen
       â€¢ Auto-Zuweisung fÃ¼r Sofort-Fahrten implementiert
       â€¢ Schnellbuchung ohne Fahrzeug â†’ System weist automatisch zu
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ğŸ¯ WICHTIGE INFOS FÃœR ENTWICKLER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ“¦ TECH-STACK:
       â€¢ Single-Page Application (SPA)
       â€¢ Vanilla JavaScript (keine Frameworks!)
       â€¢ Firebase Realtime Database + Auth
       â€¢ Leaflet (Karten), OSRM (Routing), Nominatim (Geocoding)
       â€¢ 61.000+ Zeilen in einer HTML-Datei
    
    ğŸ”¥ FIREBASE STRUKTUR:
       /rides          - Alle Fahrten
       /vehicles       - Fahrzeuge (mit Live-GPS)
       /users          - Benutzer (role: passenger/driver/admin)
       /drivers        - Fahrer-Details
       /customers      - CRM-Kunden
       /pois           - POI-Favoriten
       /settings       - Tarife, System-Config
    
    ğŸ‘¥ USER ROLES:
       â€¢ passenger: Buchen, eigene Buchungen sehen
       â€¢ driver: + AuftrÃ¤ge annehmen, GPS-Tracking
       â€¢ admin: + ALLES (Verwaltung, Statistiken, Settings)
    
    ğŸš€ AUTO-ZUWEISUNG:
       â€¢ Funktioniert ab v5.90.337!
       â€¢ findNearestAvailableVehicle() sucht freies Taxi
       â€¢ startAutoAssignment() weist automatisch zu
       â€¢ Telegram-Nachricht an Fahrer
    
    ğŸ’¡ WICHTIGE FUNKTIONEN:
       â€¢ editRide(rideId) - Fahrt bearbeiten im Kalender
       â€¢ acceptRide(rideId) - Fahrer nimmt Fahrt an
       â€¢ startAutoAssignment(rideId, ride) - Auto-Zuweisung
       â€¢ sendQuickWhatsApp(rideId, template) - WhatsApp senden
       â€¢ sendQuickSMS(rideId, template) - SMS senden
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -->
    
    <!-- ğŸ›¡ï¸ v5.87.21: SECURITY HEADERS -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="geolocation=(self), camera=(), microphone=()">
    
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Taxi HGW">
    
    <!-- ğŸ†• v5.86.13: ADMIN DEV MODE -->
    <script>
        // URL-Parameter prÃ¼fen
        const urlParams = new URLSearchParams(window.location.search);
        const isNoCacheMode = urlParams.has('nocache');
        const isTestMode = urlParams.has('test');
        
        if (isNoCacheMode) {
            console.log('ğŸ”§ ADMIN DEV MODE: Cache deaktiviert!');
            // Cache komplett aus!
            document.write('<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">');
            document.write('<meta http-equiv="Pragma" content="no-cache">');
            document.write('<meta http-equiv="Expires" content="0">');
        } else {
            // Normal: 1 Stunde Cache
            document.write('<meta http-equiv="Cache-Control" content="max-age=3600, must-revalidate">');
            document.write('<meta http-equiv="Pragma" content="max-age=3600">');
        }
        
        if (isTestMode) {
            console.log('ğŸ§ª TEST MODE: Nutze TEST-Datenbank!');
            window.isTestMode = true;
        }
    </script>
    
    <!-- ğŸ”„ Cache-Control (wird dynamisch gesetzt) -->
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <title>Funk Taxi Heringsdorf</title>
    
    <!-- ğŸ“‹ VERSION INFO -->
    <!-- Version: v5.90.645 | Build: 2026-01-18_0330 | Fix: PERFORMANCE - Nur Fahrten ab HEUTE -->
    <script>
        // ğŸ†• v5.42.6: Console mit Pause/Export Controls!
        (function() {
            const originalLog = console.log;
            const originalError = console.error;
            const originalWarn = console.warn;
            
            // ğŸ†• Speichere alle Logs
            window.consoleLogHistory = [];
            window.consolePaused = false;
            
            function formatTimestamp() {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                const ms = String(now.getMilliseconds()).padStart(3, '0');
                return `[${hours}:${minutes}:${seconds}.${ms}]`;
            }
            
            console.log = function(...args) {
                const timestamp = formatTimestamp();
                const message = [timestamp, ...args].map(a => 
                    typeof a === 'object' ? JSON.stringify(a) : String(a)
                ).join(' ');
                
                // Speichere in History
                window.consoleLogHistory.push(message);
                
                // Zeige nur wenn nicht pausiert
                if (!window.consolePaused) {
                    originalLog.apply(console, [timestamp, ...args]);
                }
            };
            
            console.error = function(...args) {
                const timestamp = formatTimestamp();
                const message = [timestamp, 'ğŸ’¾', ...args].map(a => 
                    typeof a === 'object' ? JSON.stringify(a) : String(a)
                ).join(' ');
                
                window.consoleLogHistory.push(message);
                
                if (!window.consolePaused) {
                    originalError.apply(console, [timestamp, 'ğŸ’¾', ...args]);
                }
            };
            
            console.warn = function(...args) {
                const timestamp = formatTimestamp();
                const message = [timestamp, 'âš ï¸', ...args].map(a => 
                    typeof a === 'object' ? JSON.stringify(a) : String(a)
                ).join(' ');
                
                window.consoleLogHistory.push(message);
                
                if (!window.consolePaused) {
                    originalWarn.apply(console, [timestamp, 'âš ï¸', ...args]);
                }
            };
        })();
        
        // ğŸ†• v5.90.552: GLOBAL saveTabSettings (MUST BE EARLY!)
        async function saveTabSettings() {
            const checkboxes = document.querySelectorAll('#tab-checkboxes input[type="checkbox"]');
            const defaultTab = document.getElementById('default-tab-select').value;
            
            const visible = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            if (visible.length === 0) {
                alert('âš ï¸ Du musst mindestens einen Tab auswÃ¤hlen!');
                return;
            }
            
            const settings = {
                visible: visible,
                default: defaultTab
            };
            
            // Speichere lokal
            localStorage.setItem('tabSettings', JSON.stringify(settings));
            
            // Speichere in Firebase (fÃ¼r alle GerÃ¤te)
            if (typeof currentUser !== 'undefined' && currentUser && typeof db !== 'undefined' && db) {
                try {
                    await db.ref(`users/${currentUser.uid}/tabSettings`).set(settings);
                    console.log('âœ… Tab-Einstellungen in Firebase gespeichert');
                } catch (error) {
                    console.error('ğŸ’¾ Firebase-Speicherung fehlgeschlagen:', error);
                }
            }
            
            alert('âœ… Einstellungen gespeichert!\n\nSeite wird neu geladen...');
            location.reload();
        }
        
        // ğŸ†• v5.90.544: CRITICAL HELPER FUNCTIONS (MUST BE FIRST!)
        // Diese Funktionen werden in DOMContentLoaded verwendet - mÃ¼ssen GANZ AM ANFANG sein!
        function getLocalDateString(date) {
            if (!date) date = new Date();
            if (typeof date === 'number') date = new Date(date);
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;  // YYYY-MM-DD (lokal!)
        }
        
        // ğŸ†• v5.90.545: MISSING FUNCTIONS (Stubs to prevent errors)
        function loadQuickLoginData() {
            console.log('â„¹ï¸ loadQuickLoginData() stub');
            // Diese Funktion ist optional - verhindert nur Fehler
        }
        
        function loadMyProfile() {
            console.log('â„¹ï¸ loadMyProfile() stub');
            // Diese Funktion ist optional - verhindert nur Fehler
        }
        
        console.log('ğŸš• Funk Taxi App v5.90.659 - ZEIT-ÃœBERSCHNEIDUNG GEFIXT! ğŸš¨â° (Build 2026-01-19_2300)');
        console.log('ğŸš¨ v5.90.659: KRITISCHER FIX - Verhindert Doppelbuchungen!');
        console.log('â° v5.90.659: PrÃ¼ft exakte Zeit-Ãœberschneidung + RÃ¼ckfahrt-Zeit');
        console.log('ğŸ”§ v5.90.659: Alle Zeiten mit Ein-/Ausstieg (+4 Min)');
        console.log('ğŸ“Š v5.90.656: Detaillierte Analyse fÃ¼r Admin + Kunde');
        console.log('');
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('âœ… v5.90.652: Slot-Check mit konsistenten Texten!');
        console.log('âœ… v5.90.652: "Termin verfÃ¼gbar" / "Termin nicht verfÃ¼gbar"');
        console.log('ğŸ—ºï¸ v5.90.651: POI-MARKER auf Karten-Picker!');
        console.log('ğŸ”§ v5.90.651: Nur echte POIs (BahnhÃ¶fe, Hotels) - keine Privatadressen');
        console.log('ğŸ”§ v5.90.651: Klickbare Marker mit Icons (ğŸš‰ ğŸ¨ ğŸ½ï¸ â˜•)');
        console.log('ğŸ¯ v5.90.651: Schnelle Orientierung fÃ¼r Kunden!');
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('');
        console.log('ğŸ”§ v5.90.525: renderDriverRides() nutzt Isarfunk HTML!');
        console.log('ğŸš— v5.90.525: FAHRER-TAB aus v450 + Status Ã¤ndern + Export!');
        console.log('ğŸ“± v5.90.525: Fahrzeug-Status zeigt Datum, Uhrzeit, Von, Nach!');
        console.log('âš™ï¸ v5.90.525: Fahrt-Status Badge + Status-Ã¤ndern Button!');
        console.log('ğŸ§­ v5.90.525: Karten-Popup zeigt Fahrtrichtung (Ziel)!');
        console.log('ğŸ“± v5.90.525: Karten-Popup mit ALLEN Details (Datum, Zeit, Von, Nach)!');
        console.log('ğŸ”„ v5.90.525: Status-Ã„nderung lÃ¤dt View neu (Fahrzeug-Ãœbersicht + Fahrer)!');
        console.log('ğŸ“‹ v5.90.525: ALLE Fahrer-Status im Dialog (assigned, on_way, picked_up)!');
        console.log('ğŸ”„ v5.90.525: on_way zeigt Fahrzeug als besetzt! new/assigned = frei!');
        console.log('ğŸš€ v5.90.525: DYNAMISCHES AUTO-ASSIGN! Anfahrtszeit-basierte Aktivierung!');
        console.log('â±ï¸ v5.90.525: FAHRTDAUER im Kalender + Timeline nutzt ECHTE duration!');
        console.log('ğŸŸ¢ v5.90.525: Fahrzeug-Ãœbersicht zeigt wann Fahrzeug frei wird!');
        console.log('ğŸ”” v5.90.525: Fahrzeug-Ãœbersicht zeigt nÃ¤chsten Termin!');
        console.log('ğŸ”„ v5.90.525: Fahrzeug-Ãœbersicht - Auto-Refresh + Fahrzeuge in der NÃ¤he!');
        console.log('ğŸ”§ v5.90.525: GPS Debug Logging umfangreich!');
        console.log('ğŸ“‹ v5.90.525: Kompakte Termin-Liste nÃ¤chste Stunde!');
        console.log('ğŸ—ºï¸ v5.90.525: Fahrzeug-Ãœbersicht nutzt jetzt Admin Fleet Map!');
        console.log('ğŸ”§ v5.90.525: Fahrzeug-Ãœbersicht Tab nach vorne + Fahrten klickbar!');
        console.log('ğŸ”¥ v5.90.525: NEW Status + 2h Vorbestellungen im Fahrer-Tab!');
        console.log('ğŸ“± v5.90.525: Modal MOBIL-optimiert + Fahrzeug-Sync Status!');
        console.log('ğŸš— v5.90.525: Fahrzeug-Ãœbersicht Tab = ECHTE Admin-Ãœbersicht!');
        console.log('ğŸ” v5.90.525: Sync-Check Tool + Debug fÃ¼r Badge vs Timeline!');
        console.log('âœ… v5.90.525: Fahrer-Login optimiert - nur Fahrer-Tab + eigene Fahrten!');
        console.log('âœ… v5.90.525: Completed Fahrten werden nicht mehr gezÃ¤hlt!');
        console.log('âœ… v5.90.525: Badge Ã¶ffnet jetzt Sync-Check Modal!');
        console.log('âœ… v5.90.525: Sync-Check Karten sind klickbar + Abschluss-Button!');
        console.log('âœ… v5.90.525: Fahrzeug-Ãœbersicht Tab lÃ¤dt jetzt Daten (Fix aus v474)!');
        console.log('ğŸ—‘ï¸ v5.90.525: Stornierte Fahrten aus Badge-Counter entfernt!');
        console.log('ğŸ”¥ v5.90.525: Fahrzeug IMMER in Firebase erstellen - kein localStorage!');
        console.log('ğŸ”¥ v5.90.525: GPS schreibt in vehicles/ UND drivers/ fÃ¼r Sync!');
        console.log('ğŸ·ï¸ v5.90.525: Klarere Sync-Labels: KEIN SYNC statt OFFLINE!');
        console.log('ğŸ”§ v5.90.525: checkOnlineDrivers() zeigt WARUM nicht verfÃ¼gbar!');
        console.log('ğŸ”§ v5.90.525: Monitoring Cleanup verbessert!');
        console.log('ğŸš€ v5.90.374: Firebase Query statt 3000 Fahrten laden!');
        console.log('ğŸ§¹ v5.90.373: Monitoring Cleanup + possibleIds Fix');
        console.log('ğŸ”§ v5.90.365: Fahrer-View Crash gefixt!');
        console.log('ğŸ”§ v5.90.365: v.name undefined â†’ Kein Crash mehr!');
        console.log('ğŸ”§ v5.90.365: Alle Vehicle-Dropdowns sicher!');
        console.log('ğŸ”§ v5.90.364: Repair-Button wenn Fahrzeugdaten fehlen!');
        console.log('âœ… v5.90.355: ALLE Zeit- und Datums-Felder 100% lokal!');
        console.log('âœ… v5.90.355: Beide Schnellbuchungs-Modals gefixt!');
        console.log('âœ… v5.90.355: Auto-Assign mit timestamp!');
        console.log('âœ… v5.90.355: Fahrer-View Filter lokal!');
        console.log('âœ… v5.90.338: Ã–ffnet WhatsApp/SMS auf deinem Handy!');
        console.log('ğŸš¨ v5.90.331: sendDriverLocation Fehler GEFIXT!');
        console.log('ğŸ¯ v5.90.328: vehicleId wird bei Zuweisung gesetzt!');
        console.log('ğŸ“‹ v5.90.327: updateCustomerCRM Funktion hinzugefÃ¼gt!');
        console.log('ğŸ”§ v5.90.325: Gleicher Check wie showAvailableTaxis!');
        console.log('âœ… v5.90.325: Sofort-Buchung sollte jetzt funktionieren!');
        console.log('âœï¸ v5.90.314: Status-Dropdown + Zeit-Editor!');
        console.log('â° v5.90.312: Vorbestellungen-Filter in ISARFUNK-View!');
        console.log('ğŸ”§ v5.90.312: Frau Seeger wird endlich ausgeblendet!');
        console.log('ğŸ“¦ v5.90.311: Firebase Storage SDK hinzugefÃ¼gt!');
        console.log('ğŸ’¾ v5.90.311: Fahrer-Header mit Name + Rolle + Fahrzeug!');
        console.log('ğŸ­ v5.90.311: System-Rolle Ã¼berall sichtbar!');
        console.log('â° v5.90.311: Vorbestellungen-Filter verbessert!');
        console.log('ğŸ”§ v5.90.310: Alle Fehler gefixt!');
        console.log('â° v5.90.310: Vorbestellungen rausgefiltert!');
        console.log('ğŸ“… v5.90.310: Datum-Picker mit Kalender!');
        console.log('âœï¸ v5.90.310: Bearbeiten funktioniert!');
        console.log('ğŸŸ¢ v5.90.310: GPS-Status mit Genauigkeit!');
        console.log('ğŸ¯ v5.90.310: Null-Checks Ã¼berall!');
        console.log('ğŸ§¹ v5.90.300: Header VERSTECKT im Fahrer-View!');
        console.log('âœ¨ v5.90.300: Tabs VERSTECKT im Fahrer-View!');
        console.log('ğŸ’¾ v5.90.300: Anruf-Button VERSTECKT im Fahrer-View!');
        console.log('ğŸ¯ v5.90.300: NUR Karte + GO-Button sichtbar!');
        console.log('ğŸš— v5.90.283: Fahrzeug wird freigegeben!');
        console.log('ğŸ“… v5.90.283: Fahrt wieder verfÃ¼gbar zur Zuweisung!');
        console.log('ğŸŠ v5.90.282: Kalender funktioniert endlich!');
        console.log('ğŸ“… v5.90.282: calendar-view statt schedule-view!');
        console.log('âœ… v5.90.280: Telefonnummer klickbar!');
        console.log('âœ… v5.90.157: ADMINS KÃ–NNEN JETZT VERGANGENE TAGE IM KALENDER WÃ„HLEN!');
        console.log('âœ… v5.90.157: Kalender-Picker blockiert Vergangenheit nicht mehr fÃ¼r Admins!');
        console.log('âœ… v5.90.157: Vergangene Tage: Grau & kursiv (aber klickbar fÃ¼r Admin)!');
        console.log('âœ… v5.90.156: Rechnung-Modal Fix!');
        console.log('âœ… v5.90.155: POI-Namen im Kalender!');
        console.log('âœ… v5.90.154: Vergangenheit fÃ¼r Admins!');
        console.log('âœ… v5.90.119: Warnung wenn Zielort in Kalender fehlt');
        console.log('âœ… v5.90.118: GrÃ¼ner Haken prÃ¼ft Slot-VerfÃ¼gbarkeit!');
        console.log('âœ… v5.90.111: Liste lÃ¤dt neu nach Speichern');
        console.log('âœ… v5.90.110: Format: 20-26-001 / 20-26-NS-001');
        console.log('âœ… v5.90.109: Counter pro Jahr!');
        console.log('âœ… v5.90.108: Modus-Umschalter!');
        console.log('âœ… v5.90.107: Tagesprogramm fÃ¼r Fahrer!');
        console.log('âœ… v5.90.84: Admin-Buchungen haben jetzt userId!');
        console.log('âœ… v5.90.84: Erscheinen in "Meine Fahrten"!');
        console.log('ğŸ” v5.90.84: Auto-Suche nach userId via Name + Phone!');
        console.log('â° v5.90.83: Mindestvorlauf 1 Stunde!');
        console.log('ğŸ• v5.90.83: Minuten auf :00 bei Stundenwechsel!');
        console.log('ğŸ“± v5.90.82: customerPhone aus /users!');
        console.log('ğŸ’¾ v5.90.77: Rotes X â†’ Nur Ziel Ã¤ndern (Rest bleibt!)');
        console.log('ğŸ”„ v5.90.77: Neues Ziel â†’ Preis automatisch neu berechnet!');
        console.log('âœ¨ v5.90.77: Bessere UX - kein kompletter Reset mehr nÃ¶tig!');
        console.log('â­ v5.90.69: "Als POI speichern" Button!');
        console.log('ğŸ“ v5.90.69: Marker verschieben â†’ POI an exakter Position!');
        console.log('ğŸ”„ v5.90.69: POI sofort Ã¼berall verfÃ¼gbar!');
        console.log('âœ… v5.90.68: Gleiches Geocoding-System Ã¼berall!');
        console.log('âœ… v5.90.52: Button IN gelber Box: "ğŸ”— Jetzt Link erstellen"');
        console.log('ğŸ”§ v5.90.52: createSingleTrackingLink() fÃ¼r einzelne Fahrten!');
        console.log('ğŸ‘† v5.90.52: Klick â†’ Link erstellt â†’ GrÃ¼ne Box!');
        console.log('âœ… v5.90.51: Button "Links Nachholen" fÃ¼r alle auf einmal!');
        console.log('ğŸ¯ v5.90.43: VollstÃ¤ndige Adressen mit PLZ!');
        console.log('ğŸ–ï¸ v5.90.43: Marker sind verschiebbar!');
        console.log('âœ… v5.90.43: BestÃ¤tigungs-Dialog nach Verschieben!');
        console.log('âš¡ v5.90.43: Zoom Level 17 fÃ¼r Genauigkeit!');
        console.log('âœ… v5.90.42: Auto-Abschluss nach 24h!');
        console.log('âœ… v5.90.42: NICHT mehr storniert - sondern completed!');
        console.log('ğŸ’° v5.90.42: Preis wird gespeichert!');
        console.log('ğŸ“± v5.90.42: Im Verlauf sichtbar!');
        console.log('ğŸ—„ï¸ v5.90.41: Archiv komplett!');
        console.log('âœ… v5.90.41: Alle Tabs jetzt konfigurierbar!');
        console.log('ğŸ—„ï¸ v5.90.40: Archiv-System!');
        console.log('âœ… v5.90.40: Sehe ALLE Auto-Stornos!');
        console.log('ğŸ” v5.90.40: Filter & Suche!');
        console.log('ğŸ”„ v5.90.40: Wiederherstellen-Funktion!');
        console.log('ğŸ“± v5.90.40: Statistiken & GrÃ¼nde!');
        console.log('ğŸ”§ v5.90.39: Tab-Einstellungen Fix!');
        console.log('âœ… v5.90.39: Checkboxen zeigen korrekten Status!');
        console.log('âœ… v5.90.39: Speichern funktioniert!');
        console.log('ğŸ‰ v5.90.38: Feiertags-Tarif!');
        console.log('âœ… v5.90.38: Heute (1.1.) = Feiertag erkannt!');
        console.log('ğŸ“± v5.90.38: Anzeige: "ğŸ‰ Feiertag (Nachttarif)"');
        console.log('ğŸ›¡ï¸ v5.90.37: Admin-Fahrt-Schutz!');
        console.log('âœ… v5.90.37: Schnellbuchung geschÃ¼tzt!');
        console.log('âœ… v5.90.37: Admin-Panel geschÃ¼tzt!');
        console.log('ğŸ¥ v5.90.36: Krankenfahrt-Schutz!');
        console.log('âœ… v5.90.36: Schutz auch ohne Preis!');
        console.log('ğŸ›¡ï¸ v5.90.36: Vorbestellungen geschÃ¼tzt!');
        console.log('ğŸ’° v5.90.35: Preis-Fix!');
        console.log('âœ… v5.90.35: Funktioniert bei ALLEN Fahrten!');
        console.log('ğŸ’¾ v5.90.34: Abbrechen-Button!');
        console.log('âœ… v5.90.34: Modal schlieÃŸt korrekt!');
        console.log('ğŸ§¹ v5.90.33: Clean Up!');
        console.log('âœ… v5.90.33: Neues Tab-Einstellungen Panel nutzen!');
        console.log('ğŸ”’ v5.90.32: Stripe Security!');
        console.log('âœ… v5.90.32: Nur Public Key (sicher)!');
        console.log('ğŸ’³ v5.90.31: Zahlungsmethoden UI bereit!');
        console.log('âœ… v5.90.31: Stripe Integration (TEST MODE)!');
        console.log('âœ… v5.90.31: Karte hinzufÃ¼gen/lÃ¶schen!');
        console.log('âœ… v5.90.31: Standard setzen!');
        console.log('ğŸ§ª v5.90.31: TEST-KARTEN: 4242 4242 4242 4242!');
        console.log('âœ… v5.90.30: Modal schlieÃŸt richtig!');
        console.log('âœ… v5.90.30: AbschlieÃŸen funktioniert!');
        console.log('âš™ï¸ v5.90.29: Tab-Einstellungen!');
        console.log('âœ… v5.90.29: Checkboxen + Dropdown!');
        console.log('ğŸ’¾ v5.90.29: Speichern in Firebase!');
        console.log('ğŸ¯ v5.90.29: FUNKTIONIERT GARANTIERT!');
        console.log('âœ… v5.90.28: Einfach und klar!');
        console.log('ğŸ¯ v5.90.27: Kein unnÃ¶tiges Neu-Laden mehr!');
        console.log('âš¡ v5.90.26: Performance Optimierungen!');
        console.log('âš¡ v5.90.26: Tab-Reihenfolge nur 1x laden!');
        console.log('ğŸ”§ v5.90.26: Keine unnÃ¶tigen Re-Initialisierungen!');
        console.log('ğŸ’¾ v5.90.25: Tabs speichern!');
        console.log('ğŸ“Œ v5.90.25: Letzter aktiver Tab wird gespeichert!');
        console.log('ğŸ”§ v5.90.25: Fix invoice.brutto.toFixed Fehler!');
        console.log('â° v5.90.24: WhatsApp-Style Zeit Admin!');
        console.log('âœ… v5.90.24: Gilt fÃ¼r ALLE Zeit-Inputs (Admin, Kalender)!');
        console.log('ğŸš— v5.90.23: Fahrer Taxameter-Preis!');
        console.log('ğŸ’° v5.90.23: 2 Buttons: Fertig / Mit Rechnung!');
        console.log('ğŸ“± v5.90.24: Neues Rechnungsformat 20-26-001 + Rechnung-Tab!');
        console.log('ğŸ“± v5.90.23: Rechnung mit richtigem Preis!');
        console.log('âœ… v5.90.22: Kalender AbschlieÃŸen-Button!');
        console.log('ğŸ’° v5.90.22: Preis bearbeiten beim AbschlieÃŸen!');
        console.log('ğŸ“± v5.90.22: Kunde kann Rechnung runterladen!');
        console.log('ğŸ”§ v5.90.21: Telegram-Bot Fahrten Fix!');
        console.log('ğŸ”§ v5.90.21: Fallback-Suche nach customerName!');
        console.log('âœ… v5.90.21: Telegram-Bot Fahrten im Verlauf!');
        console.log('ğŸ¤– v5.90.20: Email-Bot Slot-Check API!');
        console.log('ğŸ“… v5.90.20: window.checkSlotForBot() API!');
        console.log('âœ… v5.90.20: Alternative Zeiten fÃ¼r Bot!');
        console.log('âœ… v5.90.19: Kunde sieht Admin-Buchungen!');
        console.log('â° v5.90.19: Vorbestellung min. 1 Stunde im Voraus!');
        console.log('ğŸ”’ v5.90.19: Validierung bei Zeit-Ã„nderung!');
        console.log('ğŸ• v5.90.18: Stunde Ã¤ndern â†’ Minuten auf :00!');
        console.log('âœ¨ v5.90.18: Bessere UX bei Zeitauswahl!');
        console.log('ğŸ”§ v5.90.17: Admin bekommt automatisch ALLE Tabs!');
        console.log('ğŸ”§ v5.90.17: Auto-Fix fÃ¼r falsche Firebase Permissions!');
        console.log('âœ… v5.90.17: Hotel-Calendar in Admin Tabs!');
        console.log('ğŸ”§ v5.90.16: Slot-Check zeigt mehr Status!');
        console.log('ğŸ”§ v5.90.16: Admin-Override Warnung!');
        console.log('ğŸ”§ v5.90.16: Bessere Debug-Logs!');
        console.log('ğŸ“¤ v5.90.15: WhatsApp-Button bei ALLEN Rechnungen!');
        console.log('ğŸ“± v5.90.15: In Rechnungs-Liste!');
        console.log('ğŸ“… v5.90.15: Im Kalender!');
        console.log('ğŸ’¬ v5.90.15: Im Modal!');
        console.log('ğŸ“± v5.90.14: Telefonnummer automatisch vorausgefÃ¼llt!');
        console.log('ğŸ“± v5.90.14: Telefonnummer automatisch vorausgefÃ¼llt!');
        console.log('ğŸ’¬ v5.90.14: WhatsApp Ã¶ffnet direkt mit Nachricht!');
        console.log('ğŸ“… v5.90.13: Rechnungs-Info im Kalender Day-View!');
        console.log('ğŸ’° v5.90.13: Preis + Rechnung sichtbar!');
        console.log('ğŸ“± v5.90.12: Phone immer zu International Format (+49...)!');
        console.log('ğŸ”§ v5.90.12: normalizePhoneNumber() Funktion!');
        console.log('âœ… v5.90.12: Konsistente Phone-Formate Ã¼berall!');
        console.log('ğŸ« v5.90.11: Kunden kÃ¶nnen ihre Rechnungen runterladen!');
        console.log('ğŸ“± v5.90.11: userId = Phone wenn Admin fÃ¼r Kunden bucht!');
        console.log('ğŸ” v5.90.11: Suche auch nach Phone in Firebase!');
        console.log('ğŸ“¥ v5.90.11: Download-Button fÃ¼r Rechnungen!');
        console.log('ğŸ“± v5.90.10: Rechnungs-Info wird im Verlauf angezeigt!');
        console.log('ğŸ”„ v5.90.10: Distanz neu berechnen im Rechnungs-Modal!');
        console.log('ğŸ”— v5.90.10: Rechnung wird in Fahrt verknÃ¼pft!');
        console.log('ğŸ”§ v5.90.9: Zahlungsart ohne Emojis in PDF!');
        console.log('ğŸ’³ v5.90.8: Zahlungsart-Auswahl im Rechnungs-Modal!');
        console.log('ğŸ“± v5.90.8: Zahlungsart wird auf PDF angezeigt!');
        console.log('ğŸ§¹ v5.90.7: Alte "aktive" Fahrten abschlieÃŸen!');
        console.log('ğŸ”§ v5.90.7: Surge Pricing Fix - 410% â†’ 100%!');
        console.log('ğŸ¯ v5.90.6: Tabs per Drag & Drop verschieben!');
        console.log('ğŸ“ v5.90.5: Beliebtes Ziel Fix!');
        console.log('ğŸ“ v5.90.5: "Beliebtes Ziel" wird nicht mehr an Adresse angehÃ¤ngt!');
        console.log('ğŸ§¹ v5.90.5: Datenbank-Bereinigungs-Tool im Admin-Bereich!');
        console.log('âœ… v5.90.5: Geocoding funktioniert jetzt mit beliebten Zielen!');
        console.log('ğŸ¯ v5.90.5: Preis-Berechnung sollte jetzt korrekt sein!');
        console.log('ğŸ” v5.90.4: Firebase Auth null-check hinzugefÃ¼gt!');
        console.log('âœ… v5.90.4: App startet jetzt ohne Fehler!');
        console.log('ğŸ¯ v5.90.4: Tab-Listener wartet auf Auth-Initialisierung!');
        console.log('â±ï¸ v5.90.3: 5-Sekunden Tab-Timer ENTFERNT!');
        console.log('âœ… v5.90.3: Tabs bleiben jetzt stabil - kein ZurÃ¼ckspringen mehr!');
        console.log('ğŸ¯ v5.90.3: Tab-Checks nur noch beim Login - nicht permanent!');
        console.log('ğŸ” v5.90.2: Tab-Berechtigungen FIXED!');
        console.log('âœ… v5.90.2: querySelector nutzt jetzt .admin-tab-btn!');
        console.log('ğŸ¯ v5.90.2: Tabs werden jetzt richtig versteckt/angezeigt!');
        console.log('ğŸ“… v5.90.1: EIGENER KALENDER-VIEW erstellt!');
        console.log('âœ… v5.90.1: Kalender-Button funktioniert jetzt!');
        console.log('ğŸ¯ v5.90.1: calendar-view zeigt Fahrtenkalender!');
        console.log('ğŸ” v5.90.0: MEGA DEBUG VERSION!');
        console.log('ğŸ–±ï¸ v5.90.0: Tab-Button Click Logger installiert!');
        console.log('ğŸ“‹ v5.90.0: switchView() zeigt Stack Trace!');
        console.log('ğŸ¯ v5.90.0: Sehe GENAU was beim Klick passiert!');
        console.log('âœ… v5.89.3: updateTabPermission ist jetzt GLOBAL!');
        console.log('âœ… v5.89.3: Checkboxen speichern jetzt!');
        console.log('ğŸ” v5.89.2: TAB-BERECHTIGUNGEN GLOBAL!');
        console.log('âœ… v5.89.2: Firebase COMPAT Syntax gefixed!');
        console.log('ğŸ¯ v5.89.2: Admin stellt ein wer was sieht!');
        console.log('ğŸ’¾ v5.89.2: In Firebase gespeichert - gilt fÃ¼r ALLE GerÃ¤te!');
        console.log('ğŸ“‘ v5.89.1: BUGFIX - Firebase Auth Check hinzugefÃ¼gt!');
        console.log('ğŸ“‘ v5.89.0: TAB MANAGER - WÃ¤hle deine Tabs!');
        console.log('ğŸ“… v5.89.0: NEUER KALENDER-TAB - Direkt zur Ãœbersicht!');
        console.log('ğŸ’¾ v5.89.0: Settings pro User in Firebase!');
        console.log('ğŸ¨ v5.89.0: Tabs ein/ausblenden nach Wunsch!');
        console.log('ğŸ”§ v5.88.0: SCRIPT MANAGER MIT APPS SCRIPT API!');
        console.log('ğŸ”§ v5.87.69: ALLE Funktionsaufrufe in setTimeout() gewrappt!');
        console.log('ğŸ’¾ v5.87.68: CallMonitor Funktionen nach oben verschoben!');
        console.log('ğŸ’¾ v5.87.27: Auto-Save alle 5 Min!');
        console.log('ğŸ”„ v5.87.23: GOOGLE CALENDAR OAUTH INTEGRATION!');
        console.log('ğŸ“… v5.87.22: HOTEL-KALENDER IMPORTIERT ALLES!');
        console.log('ğŸ›¡ï¸ v5.87.21: SECURITY HEADERS + NO 404!');
        console.log('âœ… v5.87.20: ADRESS-VALIDIERUNG BEIM KUNDEN ANLEGEN!');
        console.log('ğŸš« v5.86.34: AUTO-STORNO KOMPLETT DEAKTIVIERT!');
        console.log('ğŸ¤– v5.62.0: AI-ASSISTENT FÃœR E-MAIL/TELEGRAM BUCHUNGEN!');
        console.log('ğŸš¨ v5.61.0: GPS-WARNUNG BEI EINGEFRORENEM GPS!');
        console.log('   âœ… CRM-Panel nur fÃ¼r Admin sichtbar!');
        console.log('   ğŸ’¾ Fahrer sehen CRM NICHT!');
        console.log('   ğŸ’¾ FahrgÃ¤ste sehen CRM NICHT!');
        console.log('   âœ… Klare Rollen-Trennung!');
        console.log('ğŸ“± v5.55.0: KONTAKT-IMPORT INS CRM!');
        console.log('ğŸ“± v5.54.0: NATIVE KONTAKT-AUSWAHL (Buchung)!');
        console.log('');
        console.log('âœ… ADMIN: Sieht alles inkl. CRM!');
        console.log('ğŸ’¾ FAHRER: Kein CRM-Zugriff!');
    </script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- ğŸ› v5.87.21: Eruda Debug-Panel NUR MIT ?debug URL-Parameter! -->
    <script>
        // Verwende urlParams von oben (bereits deklariert)
        if (urlParams.has('debug')) {
            // Debug-Modus aktiv - lade Eruda
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/eruda';
            script.onload = function() {
                if (!/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                    // Desktop - Eruda nicht aktivieren
                } else {
                    // Mobile - Eruda aktivieren
                    eruda.init();
                    console.log('ğŸ› Debug-Panel aktiviert! Button unten rechts Ã¶ffnen.');
                }
            };
            document.head.appendChild(script);
            console.log('ğŸ”§ Debug-Modus: Eruda wird geladen...');
        }
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 22px; margin-bottom: 5px; }
        .status-row { display: flex; justify-content: center; gap: 20px; margin-top: 8px; font-size: 11px; }
        .status-item { display: flex; align-items: center; gap: 8px; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #f59e0b; }
        .sync-dot.online { background: #10b981; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        #gps-indicator { display: none; align-items: center; gap: 8px; font-size: 11px; }
        #gps-dot { width: 8px; height: 8px; border-radius: 50%; background: #6b7280; }
        #gps-dot.online { background: #10b981; animation: pulse 2s infinite; }
        .view-selector { display: flex; background: white; border-bottom: 2px solid #e0e0e0; position: sticky; top: 90px; z-index: 99; }
        .view-btn { flex: 1; padding: 15px; border: none; background: white; font-size: 14px; cursor: pointer; }
        .view-btn.active { color: #667eea; border-bottom: 3px solid #667eea; }
        
        /* ğŸ†• v5.33.1: Admin-Tab Buttons */
        .admin-tab-btn:hover {
            background: #667eea !important;
            color: white !important;
        }
        .admin-tab-btn.active {
            background: #667eea !important;
            color: white !important;
        }
        
        /* ğŸ”§ v5.90.103: ADMIN-ONLY - NUR verstecken wenn NICHT Admin! */
        body:not(.is-admin) .admin-only {
            display: none !important;
        }
        
        /* ğŸ¯ v5.90.6: DRAG & DROP TAB STYLING */
        .admin-tab-btn.dragging {
            opacity: 0.4;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
        }
        .admin-tab-btn.drag-over {
            border-left: 3px solid #10b981 !important;
            margin-left: 5px;
            transform: translateX(5px);
        }
        .admin-tab-btn[draggable="true"] {
            cursor: grab !important;
        }
        .admin-tab-btn[draggable="true"]:active {
            cursor: grabbing !important;
        }
        .admin-tab-btn {
            transition: all 0.2s ease !important;
        }
        .view { display: none; padding: 15px; }
        .view.active { display: block; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }
        .input-group input, .input-group select { width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; }
        .btn { padding: 15px 25px; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; width: 100%; }
        .btn-primary { background: #667eea; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-success { background: #10b981; color: white; }
        .alert-success { background: #d1fae5; border: 2px solid #10b981; padding: 15px; border-radius: 8px; margin-bottom: 15px; color: #065f46; }
        .alert-info { background: #dbeafe; border: 2px solid #3b82f6; padding: 15px; border-radius: 8px; margin-bottom: 15px; color: #1e40af; }
        .ride-card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #e0e0e0; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0; }
        .online-toggle { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e0e0e0; }
        .toggle-switch { position: relative; width: 60px; height: 34px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(26px); }
        .available-taxis { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #10b981; }
        .taxi-item { padding: 10px; background: #f0f9ff; border-radius: 6px; margin-top: 8px; }
        #map { height: 300px; border-radius: 8px; margin-top: 15px; }
        .ride-status-box { background: white; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 12px; }
        .eta-display { font-size: 32px; font-weight: bold; margin: 15px 0; }
        .eta-display.green { color: #10b981; }
        .eta-display.yellow { color: #f59e0b; }
        .eta-display.red { color: #ef4444; }
        .progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin: 15px 0; }
        .progress-fill { height: 100%; transition: width 0.3s ease; }
        .autocomplete-dropdown { position: relative; background: white; border: 1px solid #e0e0e0; border-radius: 4px; margin-top: 4px; max-height: 200px; overflow-y: auto; display: none; }
        .autocomplete-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .autocomplete-item:hover { background: #f0f9ff; }
        
        /* DRIVER MAP STYLES */
        #driver-map { height: 450px; border-radius: 12px; margin: 15px 0; border: 3px solid #667eea; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .route-info-box { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .route-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px; }
        .route-stat { text-align: center; padding: 12px; background: rgba(255,255,255,0.2); border-radius: 8px; backdrop-filter: blur(10px); }
        .route-stat-value { font-size: 28px; font-weight: bold; color: white; }
        .route-stat-label { font-size: 12px; color: rgba(255,255,255,0.9); margin-top: 4px; }
        
        /* ğŸ” LOGIN SYSTEM STYLES */
        .user-profile { display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: rgba(255,255,255,0.15); border-radius: 6px; margin-top: 6px; font-size: 11px; }
        .user-avatar { width: 28px; height: 28px; border-radius: 50%; background: white; color: #667eea; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; flex-shrink: 0; }
        .user-info { flex: 1; min-width: 0; overflow: hidden; }
        .user-info > div { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .btn-logout { background: #ef4444; padding: 4px 8px; font-size: 10px; border: none; border-radius: 4px; color: white; cursor: pointer; white-space: nowrap; }
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 10% auto; padding: 30px; border-radius: 12px; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .modal-header { font-size: 24px; font-weight: bold; margin-bottom: 20px; text-align: center; }
        .modal-input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; }
        .modal-btn { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-google { background: white; color: #333; border: 2px solid #e0e0e0; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-primary-modal { background: #667eea; color: white; }
        .modal-divider { text-align: center; margin: 20px 0; color: #999; }
        .modal-link { text-align: center; margin-top: 15px; color: #667eea; cursor: pointer; text-decoration: underline; }
        
        /* ğŸš¨ Admin Alarm Animationen */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        /* ğŸ“± MOBILE RESPONSIVE CSS */
        @media only screen and (max-width: 768px) {
            /* GrÃ¶ÃŸere Touch-Targets */
            .btn { 
                padding: 18px 25px !important; 
                font-size: 16px !important;
                min-height: 50px;
            }
            
            /* ğŸ”§ FIX: Driver Top-Bar auf Mobile - flex-wrap aktivieren */
            #driver-top-bar {
                flex-wrap: wrap !important;
                gap: 6px !important;
                padding: 8px !important;
            }
            
            /* Batterie-Display auf der rechten Seite der ersten Zeile halten */
            #battery-display {
                margin-left: auto !important;
                order: 10 !important;
            }
            
            /* Power-Save und Settings in neuer Zeile auf voller Breite */
            #power-save-btn {
                order: 11 !important;
                flex: 1 !important;
                justify-content: center !important;
                min-width: 45% !important;
            }
            
            #settings-btn {
                order: 12 !important;
                flex: 0 !important;
                min-width: 50px !important;
            }
            
            /* Fahrzeug-Select nicht zu breit */
            #vehicle {
                max-width: 80px !important;
                flex: 0 0 auto !important;
            }
            
            /* Stats kompakter */
            #driver-top-bar > div[style*="font-size: 10px"] {
                font-size: 11px !important;
                white-space: nowrap !important;
            }
            
            /* Online Toggle kleiner auf Mobile */
            #driver-top-bar .toggle-switch {
                transform: scale(0.55) !important;
            }
            
            /* Menu Button */
            #driver-top-bar button[onclick*="toggleDebugPanel"] {
                padding: 6px 8px !important;
            }
            
            /* Input-Felder grÃ¶ÃŸer */
            .input-group input,
            .input-group select {
                padding: 16px !important;
                font-size: 16px !important;
                min-height: 50px;
            }
            
            /* Header kompakter auf Mobile */
            .header {
                padding: 15px 10px !important;
            }
            
            .header h1 {
                font-size: 18px !important;
            }
            
            /* Status-Row responsive */
            .status-row {
                gap: 10px !important;
                font-size: 10px !important;
                flex-wrap: wrap;
            }
            
            /* View-Selector grÃ¶ÃŸer */
            .view-btn {
                padding: 18px 10px !important;
                font-size: 15px !important;
                min-height: 50px;
            }
            
            /* Karten mit mehr Padding */
            .ride-card,
            .stat-card {
                padding: 18px !important;
                font-size: 15px !important;
            }
            
            /* Map auf Mobile hÃ¶her */
            #map,
            #driver-map {
                height: 400px !important;
            }
            
            /* Modal auf Mobile anpassen */
            .modal-content {
                margin: 5% auto !important;
                padding: 25px 20px !important;
                max-width: 95% !important;
            }
            
            /* Online Toggle grÃ¶ÃŸer */
            .toggle-switch {
                width: 70px !important;
                height: 40px !important;
            }
            
            .slider:before {
                height: 32px !important;
                width: 32px !important;
            }
            
            input:checked + .slider:before {
                transform: translateX(30px) !important;
            }
            
            /* Stats Grid auf Mobile single column */
            .stats-grid {
                grid-template-columns: 1fr !important;
            }
            
            /* User Profile kompakter */
            .user-profile {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            /* Telegram Box auf Mobile */
            #telegram-box {
                padding: 15px !important;
            }
            
            #telegram-box input {
                font-size: 16px !important;
                padding: 14px !important;
            }
            
            /* Besseres Spacing auf Mobile */
            .view {
                padding: 12px !important;
            }
            
            /* Alert-Boxen grÃ¶ÃŸer */
            .alert-success,
            .alert-info {
                padding: 16px !important;
                font-size: 14px !important;
            }
        }
        
        /* ğŸ“± Sehr kleine Screens (unter 400px) */
        @media only screen and (max-width: 400px) {
            .header h1 {
                font-size: 16px !important;
            }
            
            .status-row {
                font-size: 9px !important;
            }
            
            .view-btn {
                font-size: 13px !important;
                padding: 15px 5px !important;
            }
        }

        /* ğŸ“± MENÃœ ANIMATIONEN */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* ğŸš€ v5.52.8: Toast Animation */
        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateX(100px);
            }
            to { 
                opacity: 1; 
                transform: translateX(0);
            }
        }

        /* Hamburger Button Hover */
        #menu-toggle-btn:hover {
            background: rgba(255,255,255,0.3) !important;
            transform: translateY(-50%) scale(1.05) !important;
        }

        #menu-toggle-btn:active {
            transform: translateY(-50%) scale(0.95) !important;
        }

        /* 2 HAUPT-TABS: Fahrgast & Verlauf */
        .view-btn {
            transition: all 0.2s !important;
        }

        .view-btn:hover {
            opacity: 0.9 !important;
            transform: translateY(-2px) !important;
        }

        .view-btn:active {
            transform: translateY(0) !important;
        }

        .view-btn.active {
            background: #667eea !important;
            color: white !important;
        }

        .view-btn:not(.active) {
            background: #e5e7eb !important;
            color: #6b7280 !important;
        }

        .view-btn:not(.active):hover {
            background: #d1d5db !important;
            color: #4b5563 !important;
        }
        
        /* ğŸ†• v5.90.43: Toast Animationen */
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
    
    <!-- ğŸ”’ STRIPE DEAKTIVIERT - LÃ¶st "betrÃ¼gerische Website" Warnung aus! -->
    <!-- <script src="https://js.stripe.com/v3/"></script> -->
</head>
<body>
    
    <!-- ğŸ†• v5.81.0: GLOBALE .ICS REVIEW COMPONENTS -->
    
    <!-- ICS File Input (hidden) -->
    <input type="file" id="ics-file-input" accept=".ics" style="display:none;" onchange="handleIcsFileUpload(event)">
    
    <!-- ğŸ†• v5.84.0: CSV File Input (hidden) -->
    <input type="file" id="csv-file-input" accept=".csv" style="display:none;" onchange="handleCsvFileUpload(event)">
    
    <!-- ICS Review Container -->
    <div id="ics-review-container" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:100000;padding:20px;overflow-y:auto;">
        <div style="max-width:1200px;margin:50px auto;background:white;border-radius:12px;padding:20px;">
            <div style="background:#f9fafb;border-radius:8px;padding:15px;margin-bottom:15px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <div>
                        <div style="font-weight:700;font-size:16px;color:#1f2937;">
                            ğŸ“‹ <span id="ics-hotel-name"></span> - Fahrten prÃ¼fen
                        </div>
                        <div style="font-size:12px;color:#6b7280;margin-top:4px;">
                            Datei: <span id="ics-file-name"></span>
                        </div>
                    </div>
                    <button onclick="closeIcsReview()" style="padding:8px 16px;background:#ef4444;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;">
                        ğŸ’¾ Abbrechen
                    </button>
                </div>
                
                <!-- ğŸ†• v5.82.0: FILTER -->
                <div style="background:#fff;border:2px solid #e5e7eb;border-radius:8px;padding:12px;margin-bottom:12px;">
                    <div style="font-weight:700;font-size:14px;color:#1f2937;margin-bottom:10px;">ğŸ” Filter</div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr auto;gap:10px;align-items:end;">
                        <div>
                            <label style="display:block;font-weight:600;font-size:12px;color:#6b7280;margin-bottom:4px;">Jahr</label>
                            <select id="ics-filter-year" onchange="applyIcsFilter()" style="width:100%;padding:8px;border:2px solid #e5e7eb;border-radius:6px;font-size:13px;">
                                <option value="">Alle Jahre</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display:block;font-weight:600;font-size:12px;color:#6b7280;margin-bottom:4px;">Monat</label>
                            <select id="ics-filter-month" onchange="applyIcsFilter()" style="width:100%;padding:8px;border:2px solid #e5e7eb;border-radius:6px;font-size:13px;">
                                <option value="">Alle Monate</option>
                                <option value="1">Januar</option>
                                <option value="2">Februar</option>
                                <option value="3">MÃ¤rz</option>
                                <option value="4">April</option>
                                <option value="5">Mai</option>
                                <option value="6">Juni</option>
                                <option value="7">Juli</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">Oktober</option>
                                <option value="11">November</option>
                                <option value="12">Dezember</option>
                            </select>
                        </div>
                        
                        <button onclick="resetIcsFilter()" style="padding:8px 16px;background:#6b7280;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;">
                            ğŸ”„ Alle
                        </button>
                    </div>
                    
                    <div id="ics-filter-stats" style="margin-top:10px;padding:8px;background:#f3f4f6;border-radius:4px;font-size:12px;color:#6b7280;">
                        Gesamt: 0 Fahrten | Angezeigt: 0 Fahrten
                    </div>
                </div>
                
                <div style="display:flex;gap:10px;margin-bottom:12px;">
                    <button onclick="selectAllIcsRides()" style="flex:1;padding:10px;background:#10b981;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;">
                        âœ… Alle auswÃ¤hlen
                    </button>
                    <button onclick="deselectAllIcsRides()" style="flex:1;padding:10px;background:#6b7280;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;">
                        â˜ Alle abwÃ¤hlen
                    </button>
                </div>
                
                <div id="ics-selection-info" style="padding:10px;background:#dbeafe;border-radius:6px;font-size:13px;font-weight:600;color:#1e40af;margin-bottom:12px;">
                    AusgewÃ¤hlt: 0 von 0 | Summe: 0,00â‚¬
                </div>
            </div>
            
            <!-- Tabelle -->
            <div id="ics-rides-table" style="overflow-x:auto;border:2px solid #e5e7eb;border-radius:8px;margin-bottom:15px;">
                <!-- Wird dynamisch gefÃ¼llt -->
            </div>
            
            <button onclick="confirmIcsImport()" style="width:100%;padding:16px;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:16px;box-shadow:0 4px 12px rgba(16,185,129,0.3);">
                âœ… AusgewÃ¤hlte Fahrten importieren
            </button>
        </div>
    </div>
    
    <!-- Bearbeiten-Modal -->
    <div id="edit-ics-ride-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:100001;padding:20px;overflow-y:auto;">
        <div style="max-width:500px;margin:50px auto;background:white;border-radius:12px;padding:20px;">
            <h3 style="margin:0 0 20px 0;font-size:18px;">âœï¸ Fahrt bearbeiten</h3>
            
            <div style="margin-bottom:12px;">
                <label style="display:block;font-weight:600;font-size:13px;color:#374151;margin-bottom:6px;">Gast</label>
                <input type="text" id="edit-ics-guest" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:6px;font-size:14px;box-sizing:border-box;">
            </div>
            
            <div style="margin-bottom:12px;">
                <label style="display:block;font-weight:600;font-size:13px;color:#374151;margin-bottom:6px;">Von</label>
                <input type="text" id="edit-ics-from" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:6px;font-size:14px;box-sizing:border-box;">
            </div>
            
            <div style="margin-bottom:12px;">
                <label style="display:block;font-weight:600;font-size:13px;color:#374151;margin-bottom:6px;">Nach</label>
                <input type="text" id="edit-ics-to" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:6px;font-size:14px;box-sizing:border-box;">
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block;font-weight:600;font-size:13px;color:#374151;margin-bottom:6px;">Preis (â‚¬)</label>
                <input type="number" id="edit-ics-price" step="0.01" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:6px;font-size:14px;box-sizing:border-box;">
            </div>
            
            <div style="display:flex;gap:10px;">
                <button onclick="saveIcsRideEdit()" style="flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;">
                    ğŸ’¾ Speichern
                </button>
                <button onclick="closeEditIcsRideModal()" style="flex:1;padding:12px;background:#6b7280;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;">
                    Abbrechen
                </button>
            </div>
        </div>
    </div>
    
    <!-- ğŸ› v5.46.4: FLOATING DEBUG PANEL (NUR ADMIN!) -->
    <div id="debug-panel" style="
        display: none;
        position: fixed;
        top: 80px;
        right: 20px;
        width: 600px;
        max-height: 700px;
        background: white;
        border: 3px solid #ef4444;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        z-index: 999999999;
        font-family: monospace;
    ">
        <!-- Header (verschiebbar) -->
        <div id="debug-header" style="
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 10px 15px;
            border-radius: 9px 9px 0 0;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        ">
            <span style="font-weight: 700; font-size: 14px;">ğŸ› DEBUG LOGS</span>
            <div style="display: flex; gap: 8px;">
                <button onclick="minimizeDebugPanel()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Minimieren">âˆ’</button>
                <button onclick="copyDebugLogs()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Logs kopieren">ğŸ“‹</button>
                <button onclick="clearDebugLogs()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;" title="LÃ¶schen">ğŸ—‘ï¸</button>
                <button onclick="closeDebugPanel()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;" title="SchlieÃŸen">âœ•</button>
            </div>
        </div>
        
        <!-- Content -->
        <div id="debug-content" style="display: block;">
            <!-- Filter -->
            <div style="padding: 10px; background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
                <div style="font-size: 11px; font-weight: 600; margin-bottom: 5px; color: #6b7280;">FILTER:</div>
                <div style="display: flex; gap: 5px;">
                    <button onclick="setDebugFilter('all')" id="debug-filter-all" style="flex: 1; padding: 5px; border: 2px solid #10b981; background: #d1fae5; color: #065f46; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;">âœ… Alle</button>
                    <button onclick="setDebugFilter('warn')" id="debug-filter-warn" style="flex: 1; padding: 5px; border: 1px solid #f59e0b; background: white; color: #92400e; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;">âš ï¸ Warn</button>
                    <button onclick="setDebugFilter('error')" id="debug-filter-error" style="flex: 1; padding: 5px; border: 1px solid #ef4444; background: white; color: #dc2626; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;">ğŸ’¾ Error</button>
                </div>
            </div>
            
            <!-- Logs -->
            <div id="debug-logs-container" style="
                max-height: 550px;
                overflow-y: auto;
                padding: 10px;
                font-size: 11px;
                line-height: 1.6;
                background: #fafafa;
            ">
                <div style="color: #10b981; font-weight: 600;">ğŸ› Debug Panel aktiviert!</div>
                <div style="color: #6b7280; font-size: 10px;">Logs erscheinen hier in Echtzeit...</div>
            </div>
            
            <!-- Actions -->
            <div style="padding: 10px; background: #f9fafb; border-top: 1px solid #e5e7eb; display: flex; gap: 8px;">
                <button onclick="copyDebugLogs()" style="flex: 1; padding: 8px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px;">ğŸ“‹ Kopieren</button>
                <button onclick="clearDebugLogs()" style="flex: 1; padding: 8px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px;">ğŸ—‘ï¸ LÃ¶schen</button>
            </div>
        </div>
    </div>
    
    <!-- ğŸ› DEBUG KÃ„FER-BUTTON (NUR ADMIN!) -->
    <button id="debug-toggle-btn" style="
        display: none;
        position: fixed;
        top: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 999999998;
        transition: transform 0.2s;
    " onclick="toggleDebugPanel()" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
        ğŸ›
    </button>
    
    <div class="header" id="main-header" style="cursor: pointer; position: relative;" onclick="toggleHeader()">
        <!-- ğŸ†• v5.42.1: Avatar-Icon fÃ¼r eingeloggte User -->
        <button id="user-avatar-btn" onclick="openMenuAndScrollToProfile(event)" style="
            display: none;
            position: absolute;
            right: 65px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.9);
            border: 2px solid rgba(255,255,255,0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
            z-index: 1001;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        ">
            <span id="user-avatar-text">ğŸ’¾</span>
        </button>
        
        <!-- Hamburger Menu Button -->
        <button id="menu-toggle-btn" onclick="toggleMenu(event)" style="
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            color: white;
            z-index: 1001;
            transition: all 0.2s;
        ">â˜°</button>
        
        <div id="header-content">
            <p style="font-size: 11px; opacity: 0.9; margin: 4px 0 0 0; font-weight: 600;">ğŸš¨ Version 5.90.659 - ZEIT-ÃœBERSCHNEIDUNG GEFIXT! â° (Build 20260119-2300)</p>
            
            <!-- Cache Leeren Button -->
            <button onclick="clearAppCache(event)" style="
                margin-top: 8px;
                padding: 6px 12px;
                background: rgba(255,255,255,0.2);
                border: 1px solid rgba(255,255,255,0.3);
                border-radius: 6px;
                color: white;
                font-size: 11px;
                font-weight: 600;
                cursor: pointer;
                display: inline-flex;
                align-items: center;
                gap: 4px;
            ">
                ğŸ”„ Cache & Daten leeren
            </button>
            
            <!-- ğŸ†• v5.90.253: DEV MODE BUTTON! -->
            <button id="dev-mode-toggle" onclick="toggleDevMode()" style="
                margin-top: 8px;
                padding: 6px 12px;
                background: rgba(255,255,255,0.2);
                border: 1px solid rgba(255,255,255,0.3);
                border-radius: 6px;
                color: white;
                font-size: 11px;
                font-weight: 600;
                cursor: pointer;
                display: inline-flex;
                align-items: center;
                gap: 4px;
            ">
                ğŸ” Dev Mode: <span id="dev-mode-status">AUS</span>
            </button>
            
            <div class="status-row" id="header-status-row">
                <div class="status-item">
                    <div class="sync-dot" id="sync-dot"></div>
                    <span id="sync-status">ğŸ’¾ Lokal</span>
                </div>
                <div class="status-item" id="gps-indicator">
                    <div id="gps-dot"></div>
                    <span id="gps-status">ğŸ“ GPS Off</span>
                </div>
                <div class="status-item" id="alerts-indicator" style="display:none;">
                    <span id="sound-status" style="font-size:16px;" title="Sound Status">ğŸ”‡</span>
                    <span id="vibration-status" style="font-size:16px;margin-left:5px;" title="Vibration Status">ğŸ“³</span>
                </div>
            </div>
        </div>
        <div id="header-toggle" style="text-align: center; margin-top: 5px; font-size: 12px; opacity: 0.7;">â–¼</div>
    </div>

    <!-- ğŸ†• v5.33.1: TAB-LEISTE - NUR FÃœR ADMIN! -->
    <!-- ğŸ†• v5.90.65: MAIN TAB BAR - Zentrale Tab-Navigation -->
    <div id="main-tab-bar" class="main-navigation-tabs" style="
        display: none;
        background: white;
        padding: 10px 15px;
        border-bottom: 2px solid #e5e7eb;
        position: sticky;
        top: 0;
        z-index: 999;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    ">
        <div style="display: flex; gap: 8px; overflow-x: auto; overflow-y: hidden; -webkit-overflow-scrolling: touch; scrollbar-width: thin; scrollbar-color: #667eea #e5e7eb; padding-bottom: 5px;">
            <!-- ğŸ†• v5.90.562: SCROLL-HINWEIS -->
            <div style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); background: linear-gradient(to left, white 50%, transparent); padding: 5px 15px; pointer-events: none; font-size: 20px; opacity: 0.6;">
                â–¶
            </div>
            <!-- ğŸ†• v5.90.548: EXPRESS-BOOKING TAB! -->
            <button onclick="switchView('express-booking')" class="admin-tab-btn tab-toggleable" data-view="express-booking" data-tab-id="express-booking" style="
                padding: 10px 16px;
                border: 2px solid #f59e0b;
                background: linear-gradient(135deg, #fbbf24, #f59e0b);
                color: white;
                border-radius: 8px;
                font-weight: 700;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
                box-shadow: 0 2px 4px rgba(245,158,11,0.3);
            ">
                âš¡ Express-Buchung
            </button>
            <!-- ğŸ†• v5.90.553: SIMULATOR TAB! -->
            <button onclick="switchView('simulator')" class="admin-tab-btn tab-toggleable" data-view="simulator" data-tab-id="simulator" style="
                padding: 10px 16px;
                border: 2px solid #8b5cf6;
                background: linear-gradient(135deg, #a78bfa, #8b5cf6);
                color: white;
                border-radius: 8px;
                font-weight: 700;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
                box-shadow: 0 2px 4px rgba(139,92,246,0.3);
            ">
                ğŸ® Simulator
            </button>
            <button onclick="switchView('passenger')" class="admin-tab-btn admin-only tab-toggleable" data-view="passenger" data-tab-id="passenger" style="
                padding: 10px 16px;
                border: 2px solid #667eea;
                background: white;
                color: #667eea;
                border-radius: 8px;
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
            ">
                ğŸš• Taxi buchen
            </button>
            <button onclick="switchView('schedule')" class="admin-tab-btn admin-only tab-toggleable" data-view="schedule" data-tab-id="schedule" style="
                padding: 10px 16px;
                border: 2px solid #667eea;
                background: white;
                color: #667eea;
                border-radius: 8px;
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
            ">
                ğŸšŒğŸš‚ Fahrplan
            </button>
            <button onclick="switchView('history')" class="admin-tab-btn admin-only tab-toggleable" data-view="history" data-tab-id="history" style="
                padding: 10px 16px;
                border: 2px solid #667eea;
                background: white;
                color: #667eea;
                border-radius: 8px;
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
            ">
                ğŸ“– Verlauf
            </button>
            <!-- ğŸ†• v5.89: KALENDER-TAB (Direkt-Sprung zu Vorbestellungen!) -->
            <button onclick="switchView('calendar')" class="admin-tab-btn admin-only tab-toggleable" data-view="calendar" data-tab-id="calendar" style="
                padding: 10px 16px;
                border: 2px solid #3b82f6;
                background: white;
                color: #3b82f6;
                border-radius: 8px;
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
            ">
                ğŸ“… Kalender
            </button>
            <!-- ğŸ†• v5.90.24: RECHNUNG-TAB -->
            <button onclick="switchView('rechnung')" class="admin-tab-btn admin-only tab-toggleable" data-view="rechnung" data-tab-id="rechnung" style="
                padding: 10px 16px;
                border: 2px solid #8b5cf6;
                background: white;
                color: #8b5cf6;
                border-radius: 8px;
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
            ">
                ğŸ“± Rechnung
            </button>
            <button onclick="switchView('hotel-calendar')" class="admin-tab-btn admin-only tab-toggleable" data-view="hotel-calendar" data-tab-id="hotel-calendar" style="
                padding: 10px 16px;
                border: 2px solid #f59e0b;
                background: white;
                color: #f59e0b;
                border-radius: 8px;
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
            ">
                ğŸ¨ Hotel-Kalender
            </button>
            <!-- ğŸ†• v5.87.63: SCHNELLBUCHUNGS-BUTTON IN TAB-LEISTE! -->
            <button onclick="openQuickBookingModal()" class="admin-tab-btn admin-only tab-toggleable" data-tab-id="quick-booking" style="
                padding: 10px 16px;
                border: 2px solid #10b981;
                background: white;
                color: #10b981;
                border-radius: 8px;
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
            ">
                âš¡ Schnellbuchung
            </button>
            <button onclick="switchView('driver')" class="admin-tab-btn driver-visible tab-toggleable" data-view="driver" data-tab-id="driver" style="
                padding: 10px 16px;
                border: 2px solid #667eea;
                background: white;
                color: #667eea;
                border-radius: 8px;
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
            ">
                ğŸš— Fahrer
            </button>
            <!-- ğŸ†• v5.90.190: CRM TAB! -->
            <button onclick="switchView('crm')" class="admin-tab-btn admin-only tab-toggleable" data-view="crm" data-tab-id="crm" style="
                padding: 10px 16px;
                border: 2px solid #10b981;
                background: white;
                color: #10b981;
                border-radius: 8px;
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
            ">
                ğŸ‘¥ CRM
            </button>
            <button onclick="switchView('email-inbox')" class="admin-tab-btn admin-only tab-toggleable" data-view="email-inbox" data-tab-id="email-inbox" style="
                padding: 10px 16px;
                border: 2px solid #3b82f6;
                background: white;
                color: #3b82f6;
                border-radius: 8px;
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
            ">
                ğŸ“§ Email
            </button>
            <button onclick="switchView('admin')" class="admin-tab-btn admin-only tab-toggleable" data-view="admin" data-tab-id="admin" style="
                padding: 10px 16px;
                border: 2px solid #667eea;
                background: white;
                color: #667eea;
                border-radius: 8px;
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
            ">
                âš™ï¸ Admin
            </button>
            <button onclick="switchView('fleet-overview')" class="admin-tab-btn admin-only tab-toggleable" data-view="fleet-overview" data-tab-id="fleet-overview" style="
                padding: 12px 18px;
                border: 2px solid #10b981;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                border-radius: 8px;
                font-weight: 700;
                font-size: 14px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
                box-shadow: 0 2px 8px rgba(16,185,129,0.3);
            ">
                ğŸš— Fahrzeug-Ãœbersicht
            </button>
            <button onclick="switchView('shift-plan')" class="admin-tab-btn admin-only tab-toggleable" data-view="shift-plan" data-tab-id="shift-plan" style="
                padding: 10px 16px;
                border: 2px solid #10b981;
                background: white;
                color: #10b981;
                border-radius: 8px;
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
            ">
                ğŸ“± Schichtplan
            </button>
            <button onclick="switchView('system-diagnostics')" class="admin-tab-btn admin-only tab-toggleable" data-view="system-diagnostics" data-tab-id="system-diagnostics" style="
                padding: 10px 16px;
                border: 3px solid #dc2626;
                background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
                color: white;
                border-radius: 8px;
                font-weight: 900;
                font-size: 14px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
                box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
                animation: pulse 2s infinite;
            ">
                ğŸ”¥ DIAGNOSTICS
            </button>
            <button onclick="switchView('live-monitor')" class="admin-tab-btn admin-only tab-toggleable" data-view="live-monitor" data-tab-id="live-monitor" style="
                padding: 10px 16px;
                border: 3px solid #7c3aed;
                background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
                color: white;
                border-radius: 8px;
                font-weight: 900;
                font-size: 14px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
                box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);
                animation: pulse 2s infinite;
            ">
                ğŸ‘ï¸ LIVE MONITOR
            </button>
            <button id="old-debug-tab-btn" onclick="switchView('debug')" class="admin-tab-btn tab-toggleable" data-view="debug" data-tab-id="debug" style="
                display: none;
                padding: 10px 16px;
                border: 2px solid #ef4444;
                background: white;
                color: #ef4444;
                border-radius: 8px;
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
            ">
                ğŸ” DEBUG
            </button>
            <button onclick="switchView('ai-assistant')" class="admin-tab-btn tab-toggleable" data-view="ai-assistant" data-tab-id="ai-assistant" style="
                padding: 10px 16px;
                border: 2px solid #10b981;
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
                border-radius: 8px;
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
                box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
            ">
                ğŸ¤– AI-Assistent
            </button>
            <button onclick="switchView('booking-requests')" class="admin-tab-btn tab-toggleable" data-view="booking-requests" data-tab-id="booking-requests" style="
                padding: 10px 16px;
                border: 2px solid #3b82f6;
                background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                color: white;
                border-radius: 8px;
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
                box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            ">
                ğŸ“¬ Anfragen
            </button>
            <button onclick="switchView('poi-management')" class="admin-tab-btn admin-only tab-toggleable" data-view="poi-management" data-tab-id="poi-management" style="
                padding: 10px 16px;
                border: 2px solid #f59e0b;
                background: white;
                color: #f59e0b;
                border-radius: 8px;
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
            ">
                â­ Favoriten-Ziele
            </button>
            <button onclick="switchView('backup')" class="admin-tab-btn admin-only tab-toggleable" data-view="backup" data-tab-id="backup" style="
                padding: 10px 16px;
                border: 2px solid #8b5cf6;
                background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
                color: white;
                border-radius: 8px;
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
                box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
            ">
                ğŸ”½ Backup
            </button>
            
            <!-- ğŸ†• v5.90.40: ARCHIV TAB -->
            <button onclick="switchView('archive')" class="admin-tab-btn admin-only tab-toggleable" data-view="archive" data-tab-id="archive" style="
                padding: 10px 16px;
                border: 2px solid #dc2626;
                background: white;
                color: #dc2626;
                border-radius: 8px;
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
            ">
                ğŸ—„ï¸ Archiv
            </button>
        </div>
    </div>

    <!-- ğŸ”” PUSH DEAKTIVIERT - Telegram Ã¼bernimmt! -->

    <!-- ğŸ†• v5.26.0: TELEFON-REGISTRIERUNG / LOGIN SCREEN -->
    <div id="phone-auth-screen" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        z-index: 10000;
        padding: 20px;
        overflow-y: auto;
    ">
        <div style="max-width: 400px; margin: 40px auto;">
            <!-- Logo & Titel -->
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="font-size: 64px; margin-bottom: 10px;">ğŸš•</div>
                <h1 style="color: white; font-size: 24px; margin-bottom: 5px;">Funk Taxi Heringsdorf</h1>
                <p style="color: rgba(255,255,255,0.8); font-size: 14px;">Anmelden um Taxi zu buchen</p>
                <!-- ğŸ†• v5.90.562: VERSION BADGE -->
                <div style="margin-top: 10px;">
                    <span style="background: rgba(255,255,255,0.2); color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; backdrop-filter: blur(10px);">
                        ğŸš¨ v5.90.659 - ZEIT-ÃœBERSCHNEIDUNG GEFIXT
                    </span>
                </div>
            </div>
            
            <!-- SCHRITT 1: Telefonnummer eingeben -->
            <div id="phone-step-1" style="background: white; border-radius: 16px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                <h3 style="margin: 0 0 20px 0; font-size: 18px; text-align: center;">ğŸ“± Telefonnummer eingeben</h3>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">Deine Handynummer</label>
                    <div style="display: flex; gap: 8px;">
                        <select id="phone-country-code" style="padding: 14px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; width: 90px; box-sizing: border-box;">
                            <option value="+49">ğŸ‡©ğŸ‡ª +49</option>
                            <option value="+43">ğŸ‡¦ğŸ‡¹ +43</option>
                            <option value="+41">ğŸ‡¨ğŸ‡­ +41</option>
                            <option value="+48">ğŸ‡µğŸ‡± +48</option>
                        </select>
                        <input type="tel" id="phone-number-input" placeholder="173 1234827" 
                            onblur="addCountryCode(this)"
                            style="flex: 1; padding: 14px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; box-sizing: border-box; min-width: 0;"
                            oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                    </div>
                </div>
                
                <!-- reCAPTCHA Container -->
                <div id="recaptcha-container" style="margin-bottom: 15px;"></div>
                
                <!-- PrimÃ¤rer Button: PrÃ¼ft ob Kunde bekannt ist -->
                <button onclick="checkAndLogin()" id="check-login-btn" style="
                    width: 100%;
                    padding: 16px;
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    color: white;
                    border: none;
                    border-radius: 10px;
                    font-size: 16px;
                    font-weight: 700;
                    cursor: pointer;
                    margin-bottom: 20px;
                ">
                    ğŸ”“ Anmelden
                </button>
                
                <!-- ğŸ†• v5.75.0: ALTERNATIVE E-MAIL LOGIN (dezent) -->
                <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.1);">
                    <button onclick="showEmailLoginInAuthScreen()" style="
                        background: none;
                        border: none;
                        color: rgba(0,0,0,0.5);
                        font-size: 12px;
                        cursor: pointer;
                        text-decoration: underline;
                        padding: 8px;
                    ">
                        Alternativ: Mit E-Mail anmelden
                    </button>
                </div>
            </div>
            
            <!-- ğŸ†• v5.75.0: E-MAIL LOGIN BEREICH (versteckt) -->
            <div id="email-login-section" style="display: none; background: white; border-radius: 16px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                <h3 style="margin: 0 0 20px 0; font-size: 18px; text-align: center;">âœ‰ï¸ E-Mail Anmeldung</h3>
                
                <button onclick="loginWithGoogleFromAuthScreen()" style="
                    width: 100%;
                    padding: 14px;
                    background: white;
                    border: 2px solid #e5e7eb;
                    border-radius: 10px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    margin-bottom: 15px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 10px;
                ">
                    <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Mit Google anmelden
                </button>
                
                <div style="text-align: center; color: #999; font-size: 12px; margin: 15px 0;">oder</div>
                
                <input type="email" id="email-login-input" placeholder="E-Mail" style="
                    width: 100%;
                    padding: 14px;
                    border: 2px solid #e5e7eb;
                    border-radius: 8px;
                    font-size: 14px;
                    margin-bottom: 10px;
                    box-sizing: border-box;
                ">
                <input type="password" id="email-password-input" placeholder="Passwort" style="
                    width: 100%;
                    padding: 14px;
                    border: 2px solid #e5e7eb;
                    border-radius: 8px;
                    font-size: 14px;
                    margin-bottom: 15px;
                    box-sizing: border-box;
                ">
                
                <button onclick="loginWithEmailFromAuthScreen()" style="
                    width: 100%;
                    padding: 14px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    border-radius: 10px;
                    font-size: 14px;
                    font-weight: 700;
                    cursor: pointer;
                    margin-bottom: 15px;
                ">
                    âœ… Anmelden
                </button>
                
                <div style="text-align: center;">
                    <button onclick="showPhoneLoginInAuthScreen()" style="
                        background: none;
                        border: none;
                        color: #667eea;
                        font-size: 13px;
                        cursor: pointer;
                        text-decoration: underline;
                    ">
                        â† ZurÃ¼ck zu Telefon
                    </button>
                </div>
            </div>
            
            <!-- SCHRITT 2: Code eingeben (anfangs versteckt) -->
            <div id="phone-step-2" style="display: none; background: white; border-radius: 16px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                <h3 style="margin: 0 0 10px 0; font-size: 18px; text-align: center;">âœ… Code eingeben</h3>
                <p id="phone-sent-to" style="text-align: center; font-size: 13px; color: #666; margin-bottom: 20px;"></p>
                
                <div style="display: flex; gap: 8px; justify-content: center; margin-bottom: 20px;">
                    <input type="text" id="code-1" maxlength="1" class="code-input" style="width: 45px; height: 55px; text-align: center; font-size: 24px; font-weight: bold; border: 2px solid #e5e7eb; border-radius: 8px;" oninput="moveToNext(this, 'code-2')">
                    <input type="text" id="code-2" maxlength="1" class="code-input" style="width: 45px; height: 55px; text-align: center; font-size: 24px; font-weight: bold; border: 2px solid #e5e7eb; border-radius: 8px;" oninput="moveToNext(this, 'code-3')">
                    <input type="text" id="code-3" maxlength="1" class="code-input" style="width: 45px; height: 55px; text-align: center; font-size: 24px; font-weight: bold; border: 2px solid #e5e7eb; border-radius: 8px;" oninput="moveToNext(this, 'code-4')">
                    <input type="text" id="code-4" maxlength="1" class="code-input" style="width: 45px; height: 55px; text-align: center; font-size: 24px; font-weight: bold; border: 2px solid #e5e7eb; border-radius: 8px;" oninput="moveToNext(this, 'code-5')">
                    <input type="text" id="code-5" maxlength="1" class="code-input" style="width: 45px; height: 55px; text-align: center; font-size: 24px; font-weight: bold; border: 2px solid #e5e7eb; border-radius: 8px;" oninput="moveToNext(this, 'code-6')">
                    <input type="text" id="code-6" maxlength="1" class="code-input" style="width: 45px; height: 55px; text-align: center; font-size: 24px; font-weight: bold; border: 2px solid #e5e7eb; border-radius: 8px;" oninput="verifyCodeAuto()">
                </div>
                
                <button onclick="verifyCode()" id="verify-code-btn" style="
                    width: 100%;
                    padding: 16px;
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    color: white;
                    border: none;
                    border-radius: 10px;
                    font-size: 16px;
                    font-weight: 700;
                    cursor: pointer;
                ">
                    âœ… BestÃ¤tigen
                </button>
                
                <div style="text-align: center; margin-top: 15px;">
                    <button onclick="goBackToPhone()" style="background: none; border: none; color: #667eea; font-size: 13px; cursor: pointer;">
                        â† Andere Nummer verwenden
                    </button>
                </div>
                
                <div id="resend-timer" style="text-align: center; font-size: 12px; color: #999; margin-top: 10px;"></div>
            </div>
            
            <!-- Error Message -->
            <div id="phone-auth-error" style="display: none; background: #fef2f2; color: #dc2626; padding: 12px; border-radius: 8px; margin-top: 15px; text-align: center; font-size: 14px;"></div>
        </div>
    </div>

    <!-- ğŸ“± MENÃœ OVERLAY -->
    <div id="menu-overlay" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        animation: fadeIn 0.2s;
    " onclick="closeMenu()">
        <div id="menu-panel" style="
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 280px;
            max-width: 85%;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.3);
            overflow-y: auto;
            animation: slideInRight 0.3s;
        " onclick="event.stopPropagation()">
            <!-- MenÃ¼ Header -->
            <div style="
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px;
                position: sticky;
                top: 0;
                z-index: 1;
            ">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; font-size: 20px;">ğŸ“± MenÃ¼</h2>
                    <button onclick="closeMenu()" style="
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        font-size: 24px;
                        width: 36px;
                        height: 36px;
                        border-radius: 8px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">Ã—</button>
                </div>
            </div>

            <!-- MenÃ¼ Items -->
            <div style="padding: 15px;">
                <div style="font-size: 12px; color: #6b7280; font-weight: 600; margin-bottom: 10px; text-transform: uppercase;">
                    â„¹ï¸ Informationen
                </div>

                <!-- Bus & Zug Fahrplan -->
                <div onclick="openScheduleFromMenu()" style="
                    background: white;
                    border: 2px solid #e5e7eb;
                    border-radius: 12px;
                    padding: 15px;
                    margin-bottom: 12px;
                    cursor: pointer;
                    transition: all 0.2s;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                " onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 2px 8px rgba(59,130,246,0.2)'"
                   onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                    <div style="font-size: 28px;">ğŸšŒğŸš‚</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 700; color: #1f2937; font-size: 15px; margin-bottom: 2px;">
                            Bus & Zug Fahrplan
                        </div>
                        <div style="font-size: 12px; color: #6b7280;">
                            Live-Abfahrten in Ihrer NÃ¤he
                        </div>
                    </div>
                    <div style="color: #3b82f6; font-size: 20px;">â†’</div>
                </div>

                <!-- Mein Verlauf -->
                <div onclick="openHistoryFromMenu()" style="
                    background: white;
                    border: 2px solid #e5e7eb;
                    border-radius: 12px;
                    padding: 15px;
                    margin-bottom: 12px;
                    cursor: pointer;
                    transition: all 0.2s;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                " onmouseover="this.style.borderColor='#667eea'; this.style.boxShadow='0 2px 8px rgba(102,126,234,0.2)'"
                   onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                    <div style="font-size: 28px;">ğŸ“‹</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 700; color: #1f2937; font-size: 15px; margin-bottom: 2px;">
                            Mein Verlauf
                        </div>
                        <div style="font-size: 12px; color: #6b7280;">
                            Ihre Taxifahrten
                        </div>
                    </div>
                    <div style="color: #667eea; font-size: 20px;">â†’</div>
                </div>

                <!-- ğŸ’¾ Mein Konto - Nur fÃ¼r eingeloggte User -->
                <div id="menu-profile-item" style="
                    display: none;
                    background: white;
                    border: 2px solid #e5e7eb;
                    border-radius: 12px;
                    padding: 15px;
                    margin-bottom: 12px;
                    cursor: pointer;
                    transition: all 0.2s;
                " onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 2px 8px rgba(59,130,246,0.2)'"
                   onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
                   onclick="showMyProfileModalFromMenu()">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="font-size: 28px;">ğŸ’¾</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 700; color: #1f2937; font-size: 15px; margin-bottom: 2px;">
                                Mein Konto
                            </div>
                            <div id="menu-profile-name" style="font-size: 12px; color: #6b7280;">
                                Profildaten verwalten
                            </div>
                        </div>
                        <div style="color: #3b82f6; font-size: 20px;">â†’</div>
                    </div>
                    <div id="menu-profile-details" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb; font-size: 12px; color: #6b7280;">
                        <!-- Wird dynamisch gefÃ¼llt -->
                    </div>
                    <button onclick="event.stopPropagation(); useMyProfileDataFromMenu();" style="
                        width: 100%; 
                        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); 
                        color: white; 
                        border: none; 
                        padding: 10px; 
                        border-radius: 8px; 
                        font-weight: 600; 
                        cursor: pointer; 
                        font-size: 13px; 
                        margin-top: 10px;
                        transition: all 0.2s;
                    " onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                        âš¡ Meine Daten Ã¼bernehmen
                    </button>
                </div>

                <!-- ğŸ› Debug Panel - Nur fÃ¼r Admin -->
                <div id="menu-debug-item" style="
                    display: none;
                    background: white;
                    border: 2px solid #ef4444;
                    border-radius: 12px;
                    padding: 15px;
                    margin-bottom: 12px;
                    cursor: pointer;
                    transition: all 0.2s;
                " onmouseover="this.style.borderColor='#dc2626'; this.style.boxShadow='0 2px 8px rgba(239,68,68,0.2)'"
                   onmouseout="this.style.borderColor='#ef4444'; this.style.boxShadow='none'"
                   onclick="openDebugPanelFromMenu()">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="font-size: 28px;">ğŸ›</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 700; color: #1f2937; font-size: 15px; margin-bottom: 2px;">
                                Debug Panel
                            </div>
                            <div style="font-size: 12px; color: #6b7280;">
                                Live-Logs & Diagnose
                            </div>
                        </div>
                        <div style="color: #ef4444; font-size: 20px;">â†’</div>
                    </div>
                </div>

                <div style="border-top: 1px solid #e5e7eb; margin: 20px 0;"></div>

                <!-- ZurÃ¼ck zur Buchung -->
                <div onclick="backToBookingFromMenu()" style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border-radius: 12px;
                    padding: 15px;
                    cursor: pointer;
                    text-align: center;
                    font-weight: 700;
                    font-size: 15px;
                    transition: all 0.2s;
                " onmouseover="this.style.opacity='0.9'"
                   onmouseout="this.style.opacity='1'">
                    ğŸš• ZurÃ¼ck zur Buchung
                </div>
            </div>
        </div>
    </div>

    <div id="passenger-view" class="view active">
        <h3 style="margin:0 0 15px 0;">ğŸš• Taxi buchen</h3>
        
        <!-- ğŸ—‘ï¸ v5.58.0: CRM-BUCHUNGS-BANNER ENTFERNT! -->
        <!-- "Buchst fÃ¼r CRM-Kunde" ist Admin-Funktion! -->
        <!-- Nur im Admin-Panel! -->
        
        <!-- ğŸ’¾ MEINE DATEN - Nur fÃ¼r eingeloggte User -->
        <!-- ğŸ†• v5.26.0: EINGELOGGT ALS (Quick-Login) -->
        <!-- ğŸ†• v5.42.1: Quick-Login Box DEAKTIVIERT - zu groÃŸ! -->
        <!-- Stattdessen: Avatar-Icon im Header -->
        <div id="quick-login-box" style="display:none !important;">
            <!-- Nicht mehr verwendet -->
        </div>
        
        <!-- ğŸ’¾ ALTE MEIN KONTO BOX - DEAKTIVIERT in v5.42.0! -->
        <!-- Jetzt im Hamburger-MenÃ¼ integriert! -->
        <div id="my-profile-box" style="display:none !important;">
            <!-- Nicht mehr verwendet - siehe MenÃ¼ -->
        </div>
        
        <!-- ğŸŒŸ STAMMKUNDEN-SCHNELLBUCHUNG -->
        <div id="regular-customer-box" style="display:none; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                <h4 style="margin: 0; font-size: 16px;">ğŸŒŸ Willkommen zurÃ¼ck!</h4>
                <button onclick="clearRegularCustomer()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 6px; font-size: 11px; cursor: pointer; font-weight: 600;">
                    âœ• LÃ¶schen
                </button>
            </div>
            <div id="regular-customer-info" style="font-size: 13px; line-height: 1.6; margin-bottom: 12px;"></div>
            <button onclick="useRegularCustomerData()" style="width: 100%; background: white; color: #059669; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                âš¡ Daten Ã¼bernehmen
            </button>
        </div>
        
        <!-- ğŸ†• v5.49.2: ECHTES MODAL MIT OVERLAY -->
        <div id="ride-status-container" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;padding:20px;overflow-y:auto;"></div>
        
        <!-- ğŸ—‘ï¸ v5.58.0: ADMIN-BUTTONS ENTFERNT! -->
        <!-- Kontakt auswÃ¤hlen & Zwischenablage sind ADMIN-Funktionen! -->
        <!-- Nur im Admin-Panel verfÃ¼gbar! -->
        
        <div id="booking-form">
            <div class="input-group">
                <label>ğŸ“ Abholort</label>
                <div style="display:flex;gap:8px;align-items:center;">
                    <div style="flex:1;position:relative;">
                        <input type="text" id="pickup" placeholder="z.B. Bahnhof Heringsdorf" oninput="toggleClearButton('pickup'); triggerSlotCheck();" style="width:100%;padding:12px;padding-right:40px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;">
                        <button id="clear-pickup-btn" onclick="clearField('pickup')" style="display:none;position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:#6b7280;font-size:18px;padding:4px;line-height:1;" title="LÃ¶schen">
                            âœ•
                        </button>
                    </div>
                    <button onclick="openUniversalMapPicker('pickup', 'ğŸ“ Abholort auf Karte wÃ¤hlen')" style="padding:12px 14px;border:2px solid #10b981;background:#d1fae5;color:#065f46;border-radius:8px;font-weight:600;cursor:pointer;font-size:16px;" title="Auf Karte wÃ¤hlen">
                        ğŸ—ºï¸
                    </button>
                    <button onclick="saveLocationPOI('pickup')" style="padding:12px 14px;border:2px solid #f59e0b;background:#fef3c7;color:#92400e;border-radius:8px;font-weight:600;cursor:pointer;font-size:16px;" title="Ort speichern">
                        â­
                    </button>
                    <!-- ğŸ†• v5.90.73: GPS als Icon-Button (wie Stern!) -->
                    <button onclick="useMyLocation()" style="padding:12px 14px;border:2px solid #3b82f6;background:#dbeafe;color:#1e40af;border-radius:8px;font-weight:600;cursor:pointer;font-size:16px;" title="Meinen GPS-Standort verwenden">
                        ğŸ“
                    </button>
                    <!-- ğŸ†• v5.90.73: BestÃ¤tigung als kleines Icon -->
                    <span id="pickup-confirmation-icon" style="display:none;font-size:20px;"></span>
                </div>
                
                <!-- ğŸ†• v5.90.73: NUR Fehler-Hinweis (groÃŸ), Erfolg = nur Icon -->
                <div id="pickup-confirmation" style="
                    display: none;
                    margin-top: 8px;
                    padding: 10px 12px;
                    border-radius: 8px;
                    font-size: 13px;
                    font-weight: 600;
                ">
                    <!-- Wird nur bei FEHLER angezeigt -->
                </div>
                
                <!-- ğŸ“ GESPEICHERTE ORTE - Schnellauswahl -->
                <div id="pickup-saved-locations" style="display:none;margin-top:8px;"></div>
                
                <!-- ğŸ†• v5.90.73: GPS Button ist jetzt Icon neben Eingabefeld! -->
                <div class="autocomplete-dropdown" id="pickup-dropdown"></div>
            </div>
            
            <!-- ğŸ†• v5.90.527: ZWISCHENSTOPPS -->
            <div id="waypoints-container" style="margin-top:15px;">
                <!-- Zwischenstopps werden hier dynamisch eingefÃ¼gt -->
            </div>
            
            <!-- ğŸ†• v5.90.527: BUTTON ZUM HINZUFÃœGEN -->
            <div style="margin-top:10px;margin-bottom:15px;">
                <button id="add-waypoint-btn" onclick="addWaypoint()" style="
                    width:100%;
                    padding:8px;
                    border:2px dashed #10b981;
                    background:white;
                    border-radius:6px;
                    color:#10b981;
                    font-weight:600;
                    cursor:pointer;
                    transition:all 0.2s;
                    font-size:13px;
                " onmouseover="this.style.background='#d1fae5'" onmouseout="this.style.background='white'">
                    + Zwischenstopp
                </button>
            </div>
            
            <div class="input-group">
                <label>ğŸ¯ Zielort</label>
                <div style="display:flex;gap:8px;align-items:center;">
                    <div style="flex:1;position:relative;">
                        <input type="text" id="destination" placeholder="z.B. SeebrÃ¼cke Ahlbeck" oninput="toggleClearButton('destination'); triggerSlotCheck();" style="width:100%;padding:12px;padding-right:40px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;">
                        <button id="clear-destination-btn" onclick="clearField('destination')" style="display:none;position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:#6b7280;font-size:18px;padding:4px;line-height:1;" title="LÃ¶schen">
                            âœ•
                        </button>
                    </div>
                    <button onclick="openUniversalMapPicker('destination', 'ğŸ¯ Zielort auf Karte wÃ¤hlen')" style="padding:12px 14px;border:2px solid #10b981;background:#d1fae5;color:#065f46;border-radius:8px;font-weight:600;cursor:pointer;font-size:16px;" title="Auf Karte wÃ¤hlen">
                        ğŸ—ºï¸
                    </button>
                    <button onclick="saveLocationPOI('destination')" style="padding:12px 14px;border:2px solid #f59e0b;background:#fef3c7;color:#92400e;border-radius:8px;font-weight:600;cursor:pointer;font-size:16px;" title="Ort speichern">
                        â­
                    </button>
                    <!-- ğŸ†• v5.90.73: BestÃ¤tigung als kleines Icon -->
                    <span id="destination-confirmation-icon" style="display:none;font-size:20px;"></span>
                </div>
                
                <!-- ğŸ†• v5.90.73: NUR Fehler-Hinweis (groÃŸ), Erfolg = nur Icon -->
                <div id="destination-confirmation" style="
                    display: none;
                    margin-top: 8px;
                    padding: 10px 12px;
                    border-radius: 8px;
                    font-size: 13px;
                    font-weight: 600;
                ">
                    <!-- Wird nur bei FEHLER angezeigt -->
                </div>
                
                <!-- ğŸ“ GESPEICHERTE ORTE - Schnellauswahl -->
                <div id="destination-saved-locations" style="display:none;margin-top:8px;"></div>
                
                <div class="autocomplete-dropdown" id="destination-dropdown"></div>
            </div>
            
            <!-- ğŸ†• v5.30.0: WANN MÃ–CHTEN SIE FAHREN? -->
            <div class="input-group" style="margin-top:25px;">
                <label style="font-size:16px;font-weight:700;margin-bottom:15px;display:block;">â±ï¸ Wann mÃ¶chten Sie fahren?</label>
                
                <div id="ride-type-buttons-container" style="display:grid;grid-template-columns:1fr;gap:12px;">
                    <!-- SOFORT Button - ğŸ†• v5.90.116: Initial versteckt, nur wenn Fahrer verfÃ¼gbar! -->
                    <button id="btn-sofort" onclick="selectRideType('sofort')" style="display:none;padding:20px 15px;border:3px solid #10b981;background:white;border-radius:12px;cursor:pointer;transition:all 0.3s;">
                        <div style="font-size:32px;margin-bottom:8px;">âš¡</div>
                        <div style="font-weight:700;font-size:16px;color:#059669;margin-bottom:4px;">SOFORT</div>
                        <div style="font-size:12px;color:#666;">NÃ¤chstes verfÃ¼gbares Taxi</div>
                    </button>
                    
                    <!-- VORBESTELLEN Button -->
                    <button id="btn-vorbestellen" onclick="selectRideType('vorbestellen')" style="padding:20px 15px;border:3px solid #e5e7eb;background:white;border-radius:12px;cursor:pointer;transition:all 0.3s;">
                        <div style="font-size:32px;margin-bottom:8px;">ğŸ“…</div>
                        <div style="font-weight:700;font-size:16px;color:#6b7280;margin-bottom:4px;">VORBESTELLEN</div>
                        <div style="font-size:12px;color:#666;">Datum & Zeit wÃ¤hlen</div>
                    </button>
                </div>
            </div>
            
            <!-- ğŸš• SOFORT-BEREICH: VerfÃ¼gbare Taxis -->
            <div id="sofort-bereich" style="display:none;">
                <div id="available-taxis-display"></div>
            </div>
            
            <!-- ğŸ“… VORBESTELLEN-BEREICH: Datum & Zeit direkt wÃ¤hlen -->
            <div id="vorbestellen-bereich" style="display:none;">
                <div class="input-group">
                    <label>ğŸ“… Abholzeit wÃ¤hlen</label>
                    
                    <!-- ğŸ†• v5.90.123: ZIFFERNBLOCK MIT SLOT-CHECK! -->
                    <div id="custom-datetime-container" style="margin-top:0;">
                        <input type="date" id="custom-date" onchange="triggerSlotCheck();" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:15px;width:100%;margin-bottom:8px;">
                        
                        <!-- Zeit mit Ziffernblock -->
                        <div style="display:flex;gap:8px;align-items:center;">
                            <button id="time-display-btn" onclick="openTimeKeypadForBooking()" style="flex:1;padding:15px 12px;border:2px solid #667eea;background:white;border-radius:8px;font-size:18px;font-weight:600;color:#667eea;cursor:pointer;text-align:center;font-family:'Courier New',monospace;">
                                09:00
                            </button>
                            <button onclick="openTimeKeypadForBooking()" style="padding:12px 16px;border:2px solid #667eea;background:#667eea;color:white;border-radius:8px;font-weight:600;cursor:pointer;font-size:16px;" title="Zeit eingeben">
                                âŒ¨ï¸
                            </button>
                            <!-- Hidden inputs fÃ¼r KompatibilitÃ¤t -->
                            <input type="hidden" id="custom-hour" value="09">
                            <input type="hidden" id="custom-minute" value="00">
                        </div>
                        
                        <!-- Slot-Status Anzeige -->
                        <div id="slot-status-display" style="display:none;margin-top:10px;padding:12px;border-radius:8px;font-size:14px;font-weight:600;">
                            <!-- Wird dynamisch gefÃ¼llt -->
                        </div>
                    </div>
                    
                    <!-- ğŸ†• v5.41.5: LIVE SLOT-CHECK Display -->
                    <div id="live-slot-check" style="display:none;margin-top:12px;padding:12px;border-radius:8px;font-size:14px;">
                        <!-- Wird dynamisch gefÃ¼llt -->
                    </div>
                    
                    <div id="datetime-help" style="margin-top:8px;padding:10px;background:#dbeafe;border-radius:6px;font-size:13px;color:#1e40af;">
                        ğŸ’¡ <strong>Tipp:</strong> Ideal fÃ¼r Flughafentransfers oder Hotel-Buchungen im Voraus!
                    </div>
                </div>
            </div>
            
            <div class="input-group">
                <label>ğŸ‘¥ Personen</label>
                <select id="passengers">
                    <option value="1">1 Person</option>
                    <option value="2">2 Personen</option>
                    <option value="3">3 Personen</option>
                    <option value="4">4 Personen</option>
                </select>
            </div>
            <button id="price-btn" class="btn btn-primary" onclick="handlePriceButton()">ğŸ’° Preis berechnen</button>
            <div id="price-display" style="margin-top: 15px;"></div>
            <div id="route-map" style="height: 300px; margin-top: 15px; border-radius: 8px; overflow: hidden; display: none;"></div>
            
            <!-- CRM Speicher-Option -->
            <div id="crm-save-option" style="display:none;margin-top:15px;padding:12px;background:#f0fdf4;border:2px solid #10b981;border-radius:8px;">
                <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                    <input type="checkbox" id="save-to-crm" checked style="width:20px;height:20px;accent-color:#10b981;">
                    <span style="font-size:14px;">
                        <strong>ğŸ“‹ Kundendaten im CRM aktualisieren</strong><br>
                        <span style="font-size:12px;color:#666;">Adresse und Telefon werden gespeichert</span>
                    </span>
                </label>
            </div>
            
            <!-- ğŸ’³ ZAHLUNGSMETHODE -->
            <div class="input-group" style="margin-top:15px;">
                <label>ğŸ’³ Zahlungsmethode</label>
                <select id="payment-method" style="padding:14px;border:2px solid #10b981;border-radius:8px;font-size:15px;font-weight:600;background:white;color:#333;cursor:pointer;width:100%;">
                    <option value="bar">ğŸ’¶ Bar (Bargeld)</option>
                    <option value="karte">ğŸ’³ EC-Karte / Kreditkarte</option>
                    <option value="paypal">ğŸ“± PayPal / Digitale Zahlung</option>
                    <option value="rechnung">ğŸ§¾ Rechnung (Firmenkunden)</option>
                </select>
                <div style="font-size:12px;color:#666;margin-top:5px;">
                    â„¹ï¸ Der Fahrer sieht Ihre Zahlungsmethode
                </div>
            </div>
            
            <!-- ğŸ†• v5.88.0: 50/50 TICKET MV -->
            <div id="fifty-fifty-section" class="input-group" style="margin-top:15px;display:none;">
                <div style="background:linear-gradient(135deg,#fbbf24,#f59e0b);border-radius:12px;padding:15px;color:#78350f;">
                    <label style="display:flex;align-items:flex-start;gap:12px;cursor:pointer;">
                        <input type="checkbox" id="fifty-fifty-enabled" onchange="toggleFiftyFifty()" style="width:24px;height:24px;margin-top:2px;cursor:pointer;flex-shrink:0;">
                        <div style="flex:1;">
                            <div style="font-weight:700;font-size:16px;margin-bottom:4px;">ğŸ« 50/50 Taxi-Ticket nutzen</div>
                            <div style="font-size:13px;opacity:0.9;">Bist du 16-25 Jahre? Zahle nur die HÃ¤lfte!</div>
                        </div>
                    </label>
                    
                    <div id="fifty-fifty-details" style="display:none;margin-top:12px;padding-top:12px;border-top:2px solid rgba(120,53,15,0.2);">
                        <div style="font-size:13px;margin-bottom:10px;">
                            <strong>ğŸ“‹ FÃ¼r 50/50 benÃ¶tigt:</strong>
                        </div>
                        <div style="margin-bottom:10px;">
                            <label style="font-size:13px;font-weight:600;display:block;margin-bottom:4px;">Geburtsdatum:</label>
                            <input type="date" id="fifty-fifty-birthdate" style="width:100%;padding:12px;border:2px solid #78350f;border-radius:8px;font-size:15px;background:white;" onchange="validateFiftyFifty()">
                        </div>
                        <div id="fifty-fifty-status" style="padding:10px;border-radius:8px;font-size:13px;font-weight:600;text-align:center;"></div>
                        <div style="margin-top:10px;font-size:11px;opacity:0.8;text-align:center;">
                            â„¹ï¸ Gilt Fr/Sa + Feiertage, 20:00-08:00 Uhr<br>
                            Das Land MV Ã¼bernimmt 50% der Fahrtkosten!
                        </div>
                    </div>
                </div>
            </div>
            
            <button id="book-btn" class="btn btn-success" onclick="book()" style="margin-top: 10px; display: none;">ğŸš• Taxi buchen</button>
            <button id="show-slots-btn" class="btn" onclick="showFreeTimeSlots()" style="margin-top: 10px; display: none; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px 30px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(102,126,234,0.3);">
                ğŸ“… Freie Zeiten anzeigen
            </button>
        </div>
        
        <!-- ğŸ†• v5.38.2: OFFLINE MESSAGE -->
        <div id="offline-message" style="display:none;padding:25px;background:linear-gradient(135deg,#ef4444,#dc2626);border-radius:12px;color:white;text-align:center;margin-bottom:20px;">
            <div style="font-size:48px;margin-bottom:15px;">ğŸ”´</div>
            <div style="font-size:20px;font-weight:700;margin-bottom:10px;">Buchungssystem offline</div>
            <div style="font-size:14px;margin-bottom:20px;opacity:0.9;">
                Aktuell kÃ¶nnen keine Online-Buchungen angenommen werden.
            </div>
            <div style="padding:20px;background:rgba(255,255,255,0.15);border-radius:10px;margin-bottom:20px;">
                <div style="font-size:16px;font-weight:600;margin-bottom:8px;">Bitte rufen Sie uns an:</div>
                <a href="tel:+4915229117722" style="font-size:32px;font-weight:700;color:white;text-decoration:none;display:block;">
                    ğŸ’¾ 0152 29117722
                </a>
            </div>
            <div style="font-size:12px;opacity:0.8;">
                Wir sind gerne fÃ¼r Sie da und nehmen Ihre Buchung telefonisch entgegen!
            </div>
        </div>
        
        <div id="confirm"></div>
        
        <!-- ğŸ§¹ Cache-Button fÃ¼r ALLE sichtbar -->
        <div style="margin-top:30px;padding:15px;background:#f0f9ff;border-radius:8px;text-align:center;">
            <p style="font-size:13px;color:#666;margin-bottom:10px;">
                âš ï¸ Probleme mit der App? Alte Version wird angezeigt?
            </p>
            <button onclick="clearAppCache()" style="padding:12px 24px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                ğŸ§¹ Cache leeren & App neu laden
            </button>
        </div>
    </div>

    <!-- ğŸ†• v5.90.548: EXPRESS-BOOKING VIEW! -->
    <div id="express-booking-view" class="view" style="display:none;">
        <div style="max-width:1400px;margin:0 auto;padding:20px;">
            
            <!-- HEADER -->
            <div style="background:linear-gradient(135deg,#fbbf24,#f59e0b);padding:20px;border-radius:12px;margin-bottom:20px;color:white;box-shadow:0 4px 12px rgba(245,158,11,0.3);">
                <h2 style="margin:0 0 8px 0;font-size:24px;font-weight:700;">âš¡ Express-Buchung</h2>
                <p style="margin:0;opacity:0.95;font-size:14px;">Klicke 2x auf die Karte: ğŸ“ Abholort (grÃ¼n) â†’ ğŸ¯ Zielort (blau)</p>
            </div>

            <!-- KARTE -->
            <div style="position:relative;margin-bottom:20px;">
                <div id="express-booking-map" style="height:500px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);"></div>
                
                <!-- RESET BUTTON -->
                <button id="express-reset-btn" onclick="resetExpressBooking()" style="
                    position:absolute;
                    top:10px;
                    right:10px;
                    background:white;
                    border:2px solid #ef4444;
                    color:#ef4444;
                    padding:10px 16px;
                    border-radius:8px;
                    font-weight:700;
                    cursor:pointer;
                    box-shadow:0 2px 8px rgba(0,0,0,0.2);
                    z-index:1000;
                    display:none;
                ">
                    ğŸ”„ ZurÃ¼cksetzen
                </button>
            </div>

            <!-- INFO PANEL -->
            <div id="express-info-panel" style="
                background:white;
                padding:20px;
                border-radius:12px;
                box-shadow:0 2px 8px rgba(0,0,0,0.1);
                border-left:4px solid #f59e0b;
            ">
                <div style="color:#666;font-size:14px;line-height:1.6;">
                    <p style="margin:0 0 10px 0;"><strong>ğŸ“ Schritt 1:</strong> Klicke auf die Karte um den Abholort zu setzen (grÃ¼ner Pin)</p>
                    <p style="margin:0;"><strong>ğŸ¯ Schritt 2:</strong> Klicke nochmal um das Ziel zu setzen (blauer Pin)</p>
                </div>
            </div>

        </div>
    </div>

    <!-- ğŸ†• v5.90.556: PERFEKTER SIMULATOR VIEW! -->
    <div id="simulator-view" class="view" style="display:none;">
        <div style="max-width:1800px;margin:0 auto;padding:15px;">
            
            <!-- HEADER -->
            <div style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);padding:15px 20px;border-radius:10px;margin-bottom:15px;color:white;box-shadow:0 4px 12px rgba(139,92,246,0.3);">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        <h2 style="margin:0 0 4px 0;font-size:20px;font-weight:700;">ğŸ® Taxi-Simulator (Realistisch)</h2>
                        <p style="margin:0;opacity:0.95;font-size:12px;">Live-Simulation mit OSRM-Routing, Auto-Assign und echter Fahrzeug-Bewegung</p>
                    </div>
                    <div id="sim-status-badge" style="background:rgba(255,255,255,0.2);padding:8px 16px;border-radius:8px;font-weight:700;font-size:14px;backdrop-filter:blur(10px);">
                        â¸ Pausiert
                    </div>
                </div>
            </div>

            <!-- ZEIT-STEUERUNG -->
            <div style="background:white;padding:12px 15px;border-radius:10px;margin-bottom:15px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
                    <div style="font-weight:700;color:#8b5cf6;font-size:13px;">â° Zeit:</div>
                    
                    <button onclick="simRewind()" style="padding:6px 12px;background:#6b7280;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:12px;">
                        â—€â—€ -1h
                    </button>
                    
                    <button id="sim-play-btn" onclick="toggleSimulation()" style="padding:6px 16px;background:#10b981;color:white;border:none;border-radius:6px;font-weight:700;cursor:pointer;font-size:13px;">
                        â–¶ Start
                    </button>
                    
                    <button onclick="simForward()" style="padding:6px 12px;background:#6b7280;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:12px;">
                        +1h â–¶â–¶
                    </button>
                    
                    <select id="sim-speed" onchange="updateSimSpeed()" style="padding:6px 10px;border:2px solid #8b5cf6;border-radius:6px;font-weight:600;font-size:12px;">
                        <option value="1">1x</option>
                        <option value="5">5x</option>
                        <option value="10" selected>10x</option>
                        <option value="30">30x</option>
                        <option value="60">60x</option>
                    </select>
                    
                    <div id="sim-time" style="padding:6px 12px;background:#f3f4f6;border-radius:6px;font-weight:600;color:#1f2937;font-size:13px;">
                        ğŸ• 16.01.2026 15:00:00
                    </div>
                    
                    <button onclick="resetSimulation()" style="padding:6px 12px;background:#ef4444;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:12px;">
                        ğŸ”„ Reset
                    </button>
                </div>
                
                <!-- Auto-Generate -->
                <div style="display:flex;align-items:center;gap:8px;padding-top:8px;border-top:1px solid #e5e7eb;">
                    <label style="font-weight:600;color:#6b7280;font-size:12px;">ğŸ“Š Fahrten/Stunde:</label>
                    <input id="rides-per-hour" type="number" value="5" min="0" max="50" style="width:60px;padding:4px 8px;border:2px solid #8b5cf6;border-radius:6px;font-weight:600;font-size:12px;">
                    <button onclick="toggleRideGeneration()" id="ride-gen-btn" style="padding:4px 10px;background:#8b5cf6;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:11px;">
                        â–¶ Auto-Gen Start
                    </button>
                    <span id="next-ride-info" style="color:#6b7280;font-size:11px;"></span>
                </div>
            </div>

            <!-- MAIN CONTENT: Karte + Sidebar -->
            <div style="display:grid;grid-template-columns:1fr 380px;gap:15px;">
                
                <!-- LINKE SEITE: GROSSE KARTE -->
                <div>
                    <div id="simulator-map" style="height:600px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);"></div>
                    
                    <!-- EVENT LOG -->
                    <div style="background:white;padding:12px;border-radius:10px;margin-top:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <div style="font-weight:700;color:#8b5cf6;font-size:13px;">ğŸ“Š Event-Log:</div>
                            <button onclick="clearSimLog()" style="padding:3px 8px;background:#ef4444;color:white;border:none;border-radius:4px;font-size:10px;cursor:pointer;font-weight:600;">
                                ğŸ—‘ï¸ Clear
                            </button>
                        </div>
                        <div id="sim-event-log" style="max-height:150px;overflow-y:auto;font-size:11px;font-family:monospace;line-height:1.5;background:#f9fafb;padding:8px;border-radius:6px;"></div>
                    </div>
                </div>

                <!-- RECHTE SEITE: PANELS -->
                <div style="display:flex;flex-direction:column;gap:12px;">
                    
                    <!-- FAHRZEUGE PANEL -->
                    <div style="background:white;padding:12px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <div style="font-weight:700;color:#8b5cf6;font-size:13px;">ğŸš— Fahrzeuge:</div>
                            <button onclick="addSimVehicle()" style="padding:3px 8px;background:#10b981;color:white;border:none;border-radius:4px;font-weight:600;cursor:pointer;font-size:10px;">
                                â• Neu
                            </button>
                        </div>
                        <div id="sim-vehicles-list" style="max-height:200px;overflow-y:auto;"></div>
                    </div>

                    <!-- FAHRTEN PANEL -->
                    <div style="background:white;padding:12px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <div style="font-weight:700;color:#8b5cf6;font-size:13px;">ğŸ“‹ Fahrten:</div>
                            <button onclick="addSimRideSync()" style="padding:3px 8px;background:#3b82f6;color:white;border:none;border-radius:4px;font-weight:600;cursor:pointer;font-size:10px;">
                                â• Neu
                            </button>
                        </div>
                        <div id="sim-rides-list" style="max-height:200px;overflow-y:auto;"></div>
                    </div>

                    <!-- AUTO-ASSIGN INFO PANEL -->
                    <div id="auto-assign-panel" style="background:white;padding:12px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);display:none;">
                        <div style="font-weight:700;color:#f59e0b;font-size:13px;margin-bottom:8px;">ğŸ¯ Auto-Assign lÃ¤uft...</div>
                        <div id="auto-assign-content" style="font-size:11px;"></div>
                    </div>

                    <!-- SCHNELL-AKTIONEN -->
                    <div style="background:white;padding:12px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                        <div style="font-weight:700;color:#8b5cf6;font-size:13px;margin-bottom:8px;">âš¡ Aktionen:</div>
                        <button onclick="runAutoAssignNow()" style="width:100%;margin-bottom:6px;padding:8px;background:#f59e0b;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:12px;">
                            ğŸ¯ Auto-Assign Alle
                        </button>
                        <button onclick="exportSimulation()" style="width:100%;margin-bottom:6px;padding:8px;background:#6b7280;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:12px;">
                            ğŸ’¾ Szenario speichern
                        </button>
                        <button onclick="createRushHourScenario()" style="width:100%;padding:8px;background:#8b5cf6;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:12px;">
                            ğŸš¦ Rush Hour Test
                        </button>
                    </div>

                </div>

            </div>

        </div>
    </div>

    <!-- ğŸ†• v5.45.0: FAHRPLAN-VIEW - Abfahrtstafel + Ã–PNV-Taxi -->
    <div id="schedule-view" class="view">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;gap:8px;">
            <h3 style="margin:0;flex:1;">ğŸš Abfahrtstafel</h3>
            <button onclick="switchView('passenger')" class="view-btn" style="padding:10px 15px;background:#667eea;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;">
                ğŸš• Taxi buchen
            </button>
        </div>
        
        <!-- GPS-basierte Abfahrtstafel -->
        <div style="background:white;padding:20px;border-radius:12px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
            <div style="font-size:16px;font-weight:700;margin-bottom:15px;color:#1f2937;">
                ğŸ“ Abfahrten in Ihrer NÃ¤he
            </div>
            <div style="font-size:13px;color:#6b7280;margin-bottom:15px;">
                Wir zeigen Ihnen automatisch die nÃ¤chsten ZÃ¼ge und Busse basierend auf Ihrem aktuellen Standort.
            </div>
            
            <!-- Container fÃ¼r Haltestellenauswahl -->
            <div id="schedule-nearest-stop"></div>
            
            <!-- Container fÃ¼r ZÃ¼ge -->
            <div id="schedule-trains" style="margin-bottom:20px;"></div>
            
            <!-- Container fÃ¼r Busse -->
            <div id="schedule-buses"></div>
        </div>
        
        <!-- Info -->
        <div style="background:#f0f9ff;padding:15px;border-radius:10px;font-size:13px;color:#1e40af;">
            <strong>ğŸ’¡ Hinweis:</strong> Fahrplandaten werden live von der Deutschen Bahn API abgerufen und enthalten Echtzeit-VerspÃ¤tungen.
        </div>
    </div>

    <div id="history-view" class="view">
        <h3 style="margin: 20px 0;">Meine Fahrten</h3>
        
        <!-- ğŸ“… TABS fÃ¼r Kommende / Vergangene Fahrten -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button id="tab-upcoming" onclick="showHistoryTab('upcoming')" style="flex: 1; padding: 12px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 8px; font-weight: 600; cursor: pointer;">
                ğŸ“… Kommende Fahrten
            </button>
            <button id="tab-past" onclick="showHistoryTab('past')" style="flex: 1; padding: 12px; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 8px; font-weight: 600; cursor: pointer;">
                ğŸ“– Vergangene Fahrten
            </button>
        </div>
        
        <div id="history-list"></div>
        
        <!-- ğŸ§¹ Cache-Button fÃ¼r alle -->
        <div style="margin-top:30px;padding:15px;background:#f0f9ff;border-radius:8px;text-align:center;">
            <p style="font-size:13px;color:#666;margin-bottom:10px;">
                âš ï¸ Probleme mit der App? Alte Version wird angezeigt?
            </p>
            <button onclick="clearAppCache()" style="padding:12px 24px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                ğŸ§¹ Cache leeren & App neu laden
            </button>
        </div>
    </div>

    <!-- ğŸ†• v5.90.24: RECHNUNG VIEW -->
    <div id="rechnung-view" class="view admin-only">
        <div style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;padding:20px;border-radius:12px;margin-bottom:20px;box-shadow:0 4px 12px rgba(139,92,246,0.3);">
            <h2 style="margin:0 0 10px 0;font-size:24px;">ğŸ“± Rechnungs-Zentrale</h2>
            <p style="margin:0;font-size:14px;opacity:0.95;">Verwalte alle Rechnungen & Fahrten an einem Ort</p>
        </div>
        
        <!-- ğŸ†• v5.90.309: SCHNELL-FILTER -->
        <div style="background:white;padding:16px;border-radius:12px;border:2px solid #e5e7eb;margin-bottom:15px;">
            <div style="font-weight:600;font-size:14px;color:#374151;margin-bottom:12px;">âš¡ Schnell-Filter:</div>
            <div style="display:flex;flex-wrap:wrap;gap:8px;">
                <button onclick="setInvoiceFilter('completed_no_invoice')" id="filter-completed-no-invoice"
                        style="padding:8px 14px;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;box-shadow:0 2px 6px rgba(16,185,129,0.3);">
                    âœ… Abgeschlossen ohne Rechnung
                </button>
                <button onclick="setInvoiceFilter('all')" id="filter-all"
                        style="padding:8px 14px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;">
                    ğŸ“± Alle Fahrten
                </button>
                <button onclick="setInvoiceFilter('completed')" id="filter-completed"
                        style="padding:8px 14px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;">
                    âœ… Nur Abgeschlossen
                </button>
                <button onclick="setInvoiceFilter('pending')" id="filter-pending"
                        style="padding:8px 14px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;">
                    â³ Nur Offen
                </button>
                <button onclick="setInvoiceFilter('with_invoice')" id="filter-with-invoice"
                        style="padding:8px 14px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;">
                    ğŸ’° Mit Rechnung
                </button>
                <button onclick="setInvoiceFilter('no_invoice')" id="filter-no-invoice"
                        style="padding:8px 14px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;">
                    ğŸ’¾ Ohne Rechnung
                </button>
            </div>
        </div>
        
        <!-- ğŸ†• v5.90.309: DETAILSUCHE -->
        <div style="background:white;padding:16px;border-radius:12px;border:2px solid #e5e7eb;margin-bottom:15px;">
            <div style="font-weight:600;font-size:14px;color:#374151;margin-bottom:12px;">ğŸ” Detailsuche:</div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:12px;">
                <!-- Textsuche -->
                <div style="grid-column:1/-1;">
                    <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px;font-weight:600;">ğŸ” Suche (Kunde, Rechnungsnr., Gast):</label>
                    <input type="text" id="invoice-search-text" placeholder="z.B. Max, RE-2026-001, Mozart..." 
                           style="width:100%;padding:10px;border:2px solid #d1d5db;border-radius:8px;font-size:14px;box-sizing:border-box;">
                </div>
                
                <!-- Status Dropdown -->
                <div>
                    <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px;font-weight:600;">ğŸ“± Status:</label>
                    <select id="invoice-search-status" style="width:100%;padding:10px;border:2px solid #d1d5db;border-radius:8px;font-size:14px;box-sizing:border-box;">
                        <option value="">Alle Status</option>
                        <option value="completed">âœ… Abgeschlossen</option>
                        <option value="accepted">ğŸš— Angenommen</option>
                        <option value="pending">â³ Wartend</option>
                        <option value="cancelled">ğŸ’¾ Storniert</option>
                    </select>
                </div>
                
                <!-- Datum Von -->
                <div>
                    <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px;font-weight:600;">ğŸ“… Von:</label>
                    <input type="date" id="invoice-search-date-from" 
                           style="width:100%;padding:10px;border:2px solid #d1d5db;border-radius:8px;font-size:14px;box-sizing:border-box;">
                </div>
                
                <!-- Datum Bis -->
                <div>
                    <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px;font-weight:600;">ğŸ“… Bis:</label>
                    <input type="date" id="invoice-search-date-to" 
                           style="width:100%;padding:10px;border:2px solid #d1d5db;border-radius:8px;font-size:14px;box-sizing:border-box;">
                </div>
            </div>
            
            <!-- Buttons -->
            <div style="display:flex;gap:8px;">
                <button onclick="applyDetailedSearch()" 
                        style="flex:1;padding:10px;background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;box-shadow:0 2px 6px rgba(59,130,246,0.3);">
                    ğŸ” Suchen
                </button>
                <button onclick="resetDetailedSearch()" 
                        style="padding:10px 20px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                    ğŸ”„ ZurÃ¼cksetzen
                </button>
            </div>
        </div>
        
        <!-- ğŸ†• v5.90.309: STATISTIKEN -->
        <div id="invoice-statistics" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);padding:16px;border-radius:12px;margin-bottom:15px;color:white;display:none;">
            <div style="font-weight:700;font-size:14px;margin-bottom:8px;">ğŸ“± Statistiken (aktueller Filter):</div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;font-size:13px;">
                <div style="background:rgba(255,255,255,0.1);padding:10px;border-radius:8px;text-align:center;">
                    <div style="font-size:20px;font-weight:700;" id="stat-total-count">0</div>
                    <div style="opacity:0.9;font-size:11px;">Fahrten gesamt</div>
                </div>
                <div style="background:rgba(255,255,255,0.1);padding:10px;border-radius:8px;text-align:center;">
                    <div style="font-size:20px;font-weight:700;" id="stat-total-amount">0,00â‚¬</div>
                    <div style="opacity:0.9;font-size:11px;">Gesamtsumme</div>
                </div>
                <div style="background:rgba(255,255,255,0.1);padding:10px;border-radius:8px;text-align:center;">
                    <div style="font-size:20px;font-weight:700;" id="stat-with-invoice">0</div>
                    <div style="opacity:0.9;font-size:11px;">Mit Rechnung</div>
                </div>
            </div>
        </div>
        
        <!-- Button: Neue Rechnung -->
        <div style="background:white;padding:16px;border-radius:12px;border:2px solid #e5e7eb;margin-bottom:15px;">
            <button onclick="openInvoiceModalEmpty()" style="width:100%;padding:14px;background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-size:15px;box-shadow:0 4px 12px rgba(139,92,246,0.3);">
                âœï¸ Neue Rechnung erstellen (leer)
            </button>
        </div>
        
        <!-- Fahrten Liste -->
        <div id="rechnung-single-invoices-container" style="background:white;padding:20px;border-radius:12px;border:2px solid #e5e7eb;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                <span style="font-weight:600;font-size:15px;">ğŸ“‹ Fahrten <span id="rechnung-single-invoices-count" style="background:#8b5cf6;color:white;padding:2px 8px;border-radius:10px;font-size:12px;margin-left:8px;">0</span></span>
                <span id="rechnung-filter-info" style="font-size:12px;color:#6b7280;font-weight:600;"></span>
            </div>
            <div style="background:#f0fdf4;border:2px solid #10b981;border-radius:8px;padding:12px;margin-bottom:15px;font-size:13px;color:#065f46;">
                ğŸ’¡ <strong>Performance-Optimierung:</strong> Es werden nur die letzten 100 Fahrten durchsucht.<br>
                <span style="font-size:12px;opacity:0.8;">FÃ¼r Ã¤ltere Fahrten nutze bitte den Kalender-Verlauf.</span>
            </div>
            <div id="rechnung-single-invoices-list"></div>
        </div>
    </div>

    <!-- ğŸ†• v5.86.0: HOTEL-KALENDER VIEW -->
    <div id="hotel-calendar-view" class="view admin-only">
        <!-- ğŸ†• v5.87.44: GLEICHER CONTENT WIE IM ADMIN (funktioniert gut!) -->
        
        <!-- Info-Box -->
        <div style="background:#dbeafe;border:2px solid #3b82f6;border-radius:8px;padding:12px;margin-bottom:15px;font-size:13px;">
            <div style="font-weight:700;margin-bottom:8px;color:#1e40af;font-size:15px;">ğŸ” Google Calendar OAuth Integration!</div>
            
            <div style="background:#fff;border-radius:6px;padding:10px;margin-bottom:10px;border:2px solid #60a5fa;">
                <div style="font-weight:700;margin-bottom:6px;color:#1e40af;">âœ¨ Direkt mit Google verbinden</div>
                <ol style="margin:0;padding-left:20px;color:#1e40af;line-height:1.6;">
                    <li>Klicke "Mit Google Kalender verbinden"</li>
                    <li>Melde dich mit deinem Google-Account an</li>
                    <li>WÃ¤hle Hotel-Kalender aus</li>
                    <li>Fertig! Automatischer Sync</li>
                </ol>
            </div>
        </div>
        
        <!-- Buttons -->
        <button onclick="addNewHotelWithOAuth()" style="width:100%;padding:14px;background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;margin-bottom:10px;font-size:15px;box-shadow:0 4px 12px rgba(59,130,246,0.3);">
            ğŸ” Mit Google Kalender verbinden (OAuth)
        </button>
        
        <button onclick="showAddHotelCalendarForm()" style="width:100%;padding:14px;background:linear-gradient(135deg,#f97316,#ea580c);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;margin-bottom:10px;font-size:15px;box-shadow:0 4px 12px rgba(249,115,22,0.3);">
            ğŸ“ Neuen Hotel-Kalender hinzufÃ¼gen
        </button>
        
        <!-- Add Form (versteckt) -->
        <div id="add-hotel-calendar-form" style="display:none;background:#f9fafb;padding:15px;border-radius:8px;margin-bottom:15px;border:2px solid #3b82f6;">
            <h4 style="margin:0 0 15px 0;color:#1f2937;">Neuen Hotel-Kalender hinzufÃ¼gen</h4>
            
            <div style="margin-bottom:12px;">
                <label style="display:block;font-weight:600;font-size:13px;color:#374151;margin-bottom:6px;">ğŸ¨ Hotel-Name</label>
                <input type="text" id="hotel-name-input" placeholder="z.B. Hotel SeebrÃ¼cke" style="width:100%;padding:10px;border:2px solid #d1d5db;border-radius:6px;font-size:14px;box-sizing:border-box;">
            </div>
            
            <div style="margin-bottom:12px;">
                <label style="display:block;font-weight:600;font-size:13px;color:#374151;margin-bottom:6px;">ğŸ”— iCal-Link</label>
                <input type="text" id="hotel-ical-url-input" placeholder="https://calendar.google.com/..." style="width:100%;padding:10px;border:2px solid #d1d5db;border-radius:6px;font-size:14px;box-sizing:border-box;">
            </div>
            
            <div style="display:flex;gap:8px;">
                <button onclick="saveHotelCalendar()" style="flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;">
                    âœ… Speichern
                </button>
                <button onclick="cancelAddHotelCalendar()" style="flex:1;padding:12px;background:#ef4444;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;">
                    ğŸ’¾ Abbrechen
                </button>
            </div>
        </div>
        
        <!-- Hotel Calendar List (hier wird die funktionierende View geladen!) -->
        <div id="hotel-calendar-list">
            <div style="text-align:center;padding:40px;color:#6b7280;">
                Lade Hotel-Kalender...
            </div>
        </div>
        
        <!-- ğŸ†• v5.87.46: HOTEL-RECHNUNGEN IM HOTEL-KALENDER TAB! -->
        <div style="margin-top:30px;padding-top:20px;border-top:2px solid #e5e7eb;">
            <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:12px;border-radius:8px;margin-bottom:15px;">
                <div style="font-weight:700;font-size:16px;">ğŸ“± Hotel-Rechnungen</div>
            </div>
            
            <!-- Filter -->
            <div style="background:#f9fafb;border-radius:8px;padding:15px;margin-bottom:15px;">
                <div style="font-weight:700;margin-bottom:12px;color:#1f2937;">ğŸ” Filter</div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
                    <!-- Hotel auswÃ¤hlen -->
                    <div>
                        <label style="display:block;font-weight:600;font-size:13px;color:#374151;margin-bottom:6px;">ğŸ¨ Hotel</label>
                        <select id="invoice-hotel-select" onchange="loadInvoiceRides()" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:6px;font-size:14px;background:white;">
                            <option value="">Alle Hotels</option>
                        </select>
                    </div>
                    
                    <!-- Monat auswÃ¤hlen -->
                    <div>
                        <label style="display:block;font-weight:600;font-size:13px;color:#374151;margin-bottom:6px;">ğŸ“… Monat</label>
                        <select id="invoice-month-select" onchange="loadInvoiceRides()" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:6px;font-size:14px;background:white;">
                            <!-- Wird dynamisch befÃ¼llt -->
                        </select>
                    </div>
                </div>
                
                <button onclick="loadInvoiceRides()" style="width:100%;padding:12px;background:#10b981;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;">
                    ğŸ”„ Fahrten laden
                </button>
            </div>
            
            <!-- Statistik -->
            <div id="invoice-stats" style="display:none;background:linear-gradient(135deg,#10b981,#059669);color:white;border-radius:8px;padding:15px;margin-bottom:15px;">
                <!-- Wird dynamisch gefÃ¼llt -->
            </div>
            
            <!-- Fahrten-Tabelle -->
            <div id="invoice-rides-container" style="margin-bottom:15px;">
                <div style="text-align:center;padding:40px;color:#6b7280;">
                    <div style="font-size:48px;margin-bottom:10px;">ğŸ“±</div>
                    <div style="font-weight:600;margin-bottom:6px;">WÃ¤hle Hotel und Monat</div>
                    <div style="font-size:13px;">Dann werden alle Fahrten angezeigt</div>
                </div>
            </div>
            
            <!-- Rechnung erstellen Button -->
            <div id="invoice-create-button" style="display:none;">
                <button onclick="createHotelInvoicePDF()" style="width:100%;padding:16px;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:16px;box-shadow:0 4px 12px rgba(16,185,129,0.3);">
                    ğŸ“± Rechnung als PDF erstellen
                </button>
            </div>
            
            <!-- Rechnungs-Historie -->
            <div style="margin-top:30px;padding-top:20px;border-top:2px solid #e5e7eb;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                    <h4 style="margin:0;font-size:15px;color:#1f2937;">ğŸ“‹ Rechnungs-Historie</h4>
                    <button onclick="loadInvoiceHistory()" style="padding:8px 12px;background:#6b7280;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;">
                        ğŸ”„ Aktualisieren
                    </button>
                </div>
                <div id="invoice-history-list">
                    <div style="text-align:center;padding:20px;color:#6b7280;font-size:13px;">
                        Lade Historie...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ†• v5.90.1: KALENDER VIEW (Eigener View!) -->
    <div id="calendar-view" class="view admin-only">
        <h3 style="margin: 0 0 20px 0; color: #1f2937;">ğŸ“… Fahrten-Kalender</h3>
        
        <!-- Ansichts-Toggle -->
        <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
            <button id="cal-month-btn" onclick="switchCalendarView('month')" style="flex: 1; min-width: 120px; padding: 12px; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                ğŸ“… Monat
            </button>
            <button id="cal-week-btn" onclick="switchCalendarView('week')" style="flex: 1; min-width: 120px; padding: 12px; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                ğŸ“± Woche
            </button>
            <button id="cal-day-btn" onclick="switchCalendarView('day')" style="flex: 1; min-width: 120px; padding: 12px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                ğŸ“‹ Tag
            </button>
            <button id="cal-timeline-btn" onclick="switchCalendarView('timeline')" style="flex: 1; min-width: 140px; padding: 12px; border: 2px solid #10b981; background: white; color: #10b981; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                ğŸš—â±ï¸ Fahrzeug-Timeline
            </button>
            <button id="quick-booking-btn" onclick="openQuickBookingModal()" style="flex: 1; min-width: 140px; padding: 12px; border: 2px solid #f59e0b; background: #f59e0b; color: white; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);">
                âš¡ Schnellbuchung
            </button>
            <button id="fix-tracking-btn" onclick="fixMissingTrackingLinks()" style="flex: 1; min-width: 140px; padding: 12px; border: 2px solid #8b5cf6; background: #8b5cf6; color: white; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);">
                ğŸ”— Links Nachholen
            </button>
            <button onclick="renderCalendar()" style="flex: 1; min-width: 140px; padding: 12px; border: 2px solid #10b981; background: #10b981; color: white; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);">
                ğŸ”„ Neu laden
            </button>
        </div>
        
        <!-- Monats-Navigation -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 12px; background: #f9fafb; border-radius: 8px; flex-wrap: wrap; gap: 10px;">
            <button onclick="previousPeriod()" style="padding: 8px 16px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; font-weight: 600; cursor: pointer;">
                â—€ï¸ ZurÃ¼ck
            </button>
            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: center;">
                <div style="font-weight: 700; font-size: 16px; color: #1f2937;" id="calendar-period-title-standalone">
                    <!-- Wird mit JavaScript aktualisiert -->
                </div>
                <input type="date" id="calendar-jump-date-standalone" 
                    style="padding: 8px 12px; border: 2px solid #667eea; border-radius: 6px; font-size: 14px; cursor: pointer;"
                    onchange="jumpToDate(this.value)"
                    title="Springe zu Datum">
                <button onclick="jumpToToday()" style="padding: 8px 12px; background: #10b981; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px;">
                    ğŸ“… Heute
                </button>
            </div>
            <button onclick="nextPeriod()" style="padding: 8px 16px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; font-weight: 600; cursor: pointer;">
                Vor â–¶ï¸
            </button>
        </div>
        
        <!-- Legende -->
        <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 15px; padding: 12px; background: #f9fafb; border-radius: 8px; font-size: 13px;">
            <div style="font-weight: 600; width: 100%; margin-bottom: 5px; color: #1f2937;">Status:</div>
            <div style="display: flex; align-items: center; gap: 4px;">
                <div style="width: 12px; height: 12px; background: #10b981; border-radius: 50%;"></div>
                <span>Abgeschlossen</span>
            </div>
            <div style="display: flex; align-items: center; gap: 4px;">
                <div style="width: 12px; height: 12px; background: #ef4444; border-radius: 50%;"></div>
                <span>Storniert</span>
            </div>
            <div style="display: flex; align-items: center; gap: 4px;">
                <div style="width: 12px; height: 12px; background: #f59e0b; border-radius: 50%;"></div>
                <span>Vorbestellt</span>
            </div>
            <div style="display: flex; align-items: center; gap: 4px;">
                <div style="width: 12px; height: 12px; background: #3b82f6; border-radius: 50%;"></div>
                <span>In Bearbeitung</span>
            </div>
        </div>
        
        <!-- Auslastungs-Legende -->
        <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; padding: 12px; background: #fffbeb; border-radius: 8px; font-size: 13px; border: 2px solid #fcd34d;">
            <div style="font-weight: 600; width: 100%; margin-bottom: 5px; color: #1f2937;">ğŸ”¥ Auslastung:</div>
            <div style="display: flex; align-items: center; gap: 6px;">
                <div style="padding: 4px 8px; background: #f0fdf4; border: 2px solid #86efac; border-radius: 6px; font-weight: 600; color: #166534;">
                    âœ… 1-3
                </div>
                <span style="color: #166534;">OK</span>
            </div>
            <div style="display: flex; align-items: center; gap: 6px;">
                <div style="padding: 4px 8px; background: #fef3c7; border: 2px solid #fcd34d; border-radius: 6px; font-weight: 600; color: #92400e;">
                    âš ï¸ 4-5
                </div>
                <span style="color: #92400e;">KÃ¶nnte eng werden</span>
            </div>
            <div style="display: flex; align-items: center; gap: 6px;">
                <div style="padding: 4px 8px; background: #fef2f2; border: 2px solid #fca5a5; border-radius: 6px; font-weight: 600; color: #991b1b;">
                    ğŸ”¥ 6+
                </div>
                <span style="color: #991b1b;">Viele Fahrten!</span>
            </div>
        </div>
        
        <!-- Kalender-Container (nutzt den gleichen wie im Admin!) -->
        <div id="calendar-container" style="margin-bottom: 20px; position: relative;">
            <!-- Wird dynamisch gefÃ¼llt -->
        </div>
        
        <!-- Statistik -->
        <div id="calendar-stats" style="padding: 15px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 12px; font-size: 14px;">
            <!-- Wird dynamisch gefÃ¼llt -->
        </div>
    </div>

    <!-- ğŸ†• v5.90.190: CRM VIEW! -->
    <div id="crm-view" class="view admin-only">
        <h2 style="margin-bottom:15px;">ğŸ‘¥ Kunden-CRM</h2>
        
        <div style="background:#f0fdf4;border:2px solid #10b981;border-radius:8px;padding:15px;margin-bottom:15px;">
            <div style="font-weight:700;margin-bottom:8px;color:#065f46;">ğŸ“‹ Kunden-Datenbank</div>
            <div style="font-size:13px;color:#048257;line-height:1.6;">
                â€¢ Alle Kunden aus Buchungen<br>
                â€¢ Telefonnummern & Adressen<br>
                â€¢ Buchungshistorie & Favoriten<br>
                â€¢ Notizen & Kategorien
            </div>
        </div>
        
        <!-- Statistiken -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:15px;">
            <div style="background:linear-gradient(135deg,#10b981,#059669);padding:8px 12px;border-radius:8px;color:white;">
                <div style="font-size:18px;font-weight:bold;" id="crm-total-customers">0</div>
                <div style="font-size:11px;opacity:0.9;">Gesamt Kunden</div>
            </div>
            <div style="background:linear-gradient(135deg,#3b82f6,#2563eb);padding:8px 12px;border-radius:8px;color:white;">
                <div style="font-size:18px;font-weight:bold;" id="crm-this-month">0</div>
                <div style="font-size:11px;opacity:0.9;">Diesen Monat</div>
            </div>
            <div style="background:linear-gradient(135deg,#f59e0b,#d97706);padding:8px 12px;border-radius:8px;color:white;">
                <div style="font-size:18px;font-weight:bold;" id="crm-favorites">0</div>
                <div style="font-size:11px;opacity:0.9;">Favoriten</div>
            </div>
        </div>
        
        <!-- Suche & Filter -->
        <div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;">
            <input 
                type="text" 
                id="crm-search-input" 
                placeholder="ğŸ” Name, Telefon oder Adresse suchen..."
                oninput="filterCRMCustomers()"
                style="flex:1;min-width:200px;padding:12px;border:2px solid #d1d5db;border-radius:8px;font-size:14px;">
            
            <!-- ğŸ†• v5.90.245: CUSTOM DROPDOWN FÃœR TESLA! -->
            <div style="position:relative;">
                <button id="crm-filter-category-btn" onclick="toggleCRMFilterDropdown()" style="padding:12px;border:2px solid #d1d5db;border-radius:8px;font-size:14px;background:white;min-width:180px;text-align:left;cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
                    <span id="crm-filter-category-label">Alle Kategorien</span>
                    <span>â–¼</span>
                </button>
                <div id="crm-filter-category-dropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:white;border:2px solid #d1d5db;border-radius:8px;margin-top:4px;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,0.15);max-height:300px;overflow-y:auto;">
                    <div class="crm-filter-option" data-value="" onclick="selectCRMFilterCategory('', 'Alle Kategorien')" style="padding:12px;cursor:pointer;border-bottom:1px solid #e5e7eb;transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                        Alle Kategorien
                    </div>
                    <div class="crm-filter-option" data-value="favorite" onclick="selectCRMFilterCategory('favorite', 'â­ Favorit')" style="padding:12px;cursor:pointer;border-bottom:1px solid #e5e7eb;transition:background 0.2s;" onmouseover="this.style.background='#fef3c7'" onmouseout="this.style.background='white'">
                        â­ Favorit
                    </div>
                    <div class="crm-filter-option" data-value="driver" onclick="selectCRMFilterCategory('driver', 'ğŸš— Fahrer')" style="padding:12px;cursor:pointer;border-bottom:1px solid #e5e7eb;transition:background 0.2s;" onmouseover="this.style.background='#dbeafe'" onmouseout="this.style.background='white'">
                        ğŸš— Fahrer
                    </div>
                    <div class="crm-filter-option" data-value="hotel" onclick="selectCRMFilterCategory('hotel', 'ğŸ¨ Hotel')" style="padding:12px;cursor:pointer;border-bottom:1px solid #e5e7eb;transition:background 0.2s;" onmouseover="this.style.background='#f3e8ff'" onmouseout="this.style.background='white'">
                        ğŸ¨ Hotel
                    </div>
                    <div class="crm-filter-option" data-value="restaurant" onclick="selectCRMFilterCategory('restaurant', 'ğŸ½ï¸ Restaurant')" style="padding:12px;cursor:pointer;border-bottom:1px solid #e5e7eb;transition:background 0.2s;" onmouseover="this.style.background='#fef3c7'" onmouseout="this.style.background='white'">
                        ğŸ½ï¸ Restaurant
                    </div>
                    <div class="crm-filter-option" data-value="vip" onclick="selectCRMFilterCategory('vip', 'ğŸ‘‘ VIP')" style="padding:12px;cursor:pointer;border-bottom:1px solid #e5e7eb;transition:background 0.2s;" onmouseover="this.style.background='#fef3c7'" onmouseout="this.style.background='white'">
                        ğŸ‘‘ VIP
                    </div>
                    <div class="crm-filter-option" data-value="business" onclick="selectCRMFilterCategory('business', 'ğŸ’¼ GeschÃ¤ftskunde')" style="padding:12px;cursor:pointer;transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                        ğŸ’¼ GeschÃ¤ftskunde
                    </div>
                </div>
            </div>
            <input type="hidden" id="crm-filter-category" value="">
            
            <button onclick="showAddCustomerModal()" style="padding:12px 20px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                â• Neuer Kunde
            </button>
        </div>
        
        <!-- Kunden-Liste -->
        <div id="crm-customers-list" style="display:grid;gap:10px;">
            <!-- Wird dynamisch gefÃ¼llt -->
        </div>
    </div>

    <!-- ğŸ“§ EMAIL INBOX VIEW -->
    <div id="email-inbox-view" class="view admin-only">
        <h2 style="margin-bottom:15px;">ğŸ“§ Email-Postfach</h2>
        
        <div style="background:#dbeafe;border:2px solid #3b82f6;border-radius:8px;padding:15px;margin-bottom:15px;">
            <div style="font-weight:700;margin-bottom:8px;color:#1e40af;">ğŸ“¬ Automatische Email-Weiterleitung</div>
            <div style="font-size:13px;color:#1e3a8a;line-height:1.6;">
                Alle Emails an <strong><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="2c584d54482b55485e4d6c4b43434b4049414d4820024f4341">[email&#160;protected]</a></strong> werden automatisch hier angezeigt<br>
                âœ… Buchungsanfragen erkennen<br>
                âœ… Direkt in Buchung umwandeln<br>
                âœ… Auto-Antwort senden
            </div>
        </div>
        
        <!-- Email-Statistiken -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:15px;">
            <div style="background:linear-gradient(135deg,#3b82f6,#2563eb);padding:15px;border-radius:8px;color:white;">
                <div style="font-size:24px;font-weight:bold;" id="email-total">0</div>
                <div style="font-size:13px;opacity:0.9;">Gesamt Emails</div>
            </div>
            <div style="background:linear-gradient(135deg,#f59e0b,#d97706);padding:15px;border-radius:8px;color:white;">
                <div style="font-size:24px;font-weight:bold;" id="email-unread">0</div>
                <div style="font-size:13px;opacity:0.9;">Ungelesen</div>
            </div>
            <div style="background:linear-gradient(135deg,#10b981,#059669);padding:15px;border-radius:8px;color:white;">
                <div style="font-size:24px;font-weight:bold;" id="email-bookings">0</div>
                <div style="font-size:13px;opacity:0.9;">Buchungen</div>
            </div>
        </div>
        
        <!-- Filter & Suche -->
        <div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;">
            <input 
                type="text" 
                id="email-search-input" 
                placeholder="ğŸ” Suche in Emails..."
                oninput="filterEmails()"
                style="flex:1;min-width:200px;padding:12px;border:2px solid #d1d5db;border-radius:8px;font-size:14px;">
            
            <select id="email-filter-type" onchange="filterEmails()" style="padding:12px;border:2px solid #d1d5db;border-radius:8px;font-size:14px;background:white;">
                <option value="all">Alle Emails</option>
                <option value="unread">Ungelesen</option>
                <option value="bookings">Buchungsanfragen</option>
                <option value="replies">Antworten</option>
            </select>
            
            <button onclick="refreshEmails()" style="padding:12px 20px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                ğŸ”„ Aktualisieren
            </button>
        </div>
        
        <!-- Email-Liste -->
        <div id="email-list" style="display:grid;gap:10px;">
            <div style="padding:40px;text-align:center;color:#9ca3af;">
                <div style="font-size:64px;margin-bottom:15px;">ğŸ“§</div>
                <div style="font-size:18px;font-weight:600;margin-bottom:8px;">Noch keine Emails</div>
                <div style="font-size:14px;">
                    Emails werden automatisch synchronisiert sobald welche eingehen
                </div>
            </div>
        </div>
    </div>

    <div id="driver-view" class="view">
        <!-- ğŸ¯ DESIGN C: FULLSCREEN MAP - Google Maps Style -->
        
        <!-- Ultra-Mini Top Bar (transparent, sticky) -->
        <div id="driver-top-bar" style="
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 8px 10px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        ">
            <!-- GPS Status Indicator -->
            <div id="gps-status-compact" style="
                display: flex;
                align-items: center;
                gap: 4px;
                padding: 4px 8px;
                background: rgba(239,68,68,0.1);
                border-radius: 12px;
                font-size: 11px;
                color: #ef4444;
            ">
                <span id="gps-icon-compact">ğŸ’¾</span>
                <span id="gps-text-compact">GPS</span>
            </div>
            
            <!-- ğŸ†• v5.90.525: FAHRZEUG-SYNC STATUS! -->
            <div id="vehicle-sync-status" style="
                display: flex;
                align-items: center;
                gap: 4px;
                padding: 4px 8px;
                background: rgba(16,185,129,0.1);
                border-radius: 12px;
                font-size: 11px;
                color: #10b981;
            " title="Firebase Synchronisation Status">
                <span id="sync-icon">âœ…</span>
                <span id="sync-text">SYNC OK</span>
            </div>
            
            <!-- Stornierung Badge (NEU!) -->
            <button id="cancellation-badge" onclick="showCancellationPanel()" style="
                display: none;
                background: #ef4444;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 20px;
                font-weight: bold;
                cursor: pointer;
                font-size: 13px;
                animation: pulse 1s infinite;
            ">
                ğŸš¨ <span id="cancellation-count">0</span>
            </button>
            
            <!-- Fahrzeug Select -->
            <select id="vehicle" onchange="setVehicle()" style="
                padding: 6px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 12px;
                flex: 1;
                max-width: 140px;
            ">
                <option value="">Fahrzeug wÃ¤hlen</option>
                <!-- ğŸ†• v5.90.403: Wird dynamisch geladen! -->
            </select>
            
            <!-- Stats Mini -->
            <div style="font-size: 10px; color: #666; white-space: nowrap;">
                <span id="d-rides">0</span>â†‘ <span id="d-money">0â‚¬</span>
            </div>
            
            <!-- Online Toggle Mini -->
            <label class="toggle-switch" style="transform: scale(0.6);">
                <input type="checkbox" id="online-toggle" onchange="toggleOnline()" disabled style="opacity: 0.5; cursor: not-allowed;">
                <span class="slider"></span>
            </label>
            
            <!-- Menu Button -->
            <button onclick="toggleDebugPanel()" style="
                background: rgba(102,126,234,0.2);
                color: #667eea;
                border: none;
                padding: 6px 10px;
                border-radius: 6px;
                cursor: pointer;
                font-weight: bold;
            ">
                â‰¡
            </button>
        </div>
        
        <!-- ğŸ†• v5.90.578: STATUS-BOX (FREI/BESETZT) -->\n        <div id="driver-status-box" style="margin:10px;">
            <!-- Wird dynamisch von updateDriverViewIsarfunk() gefÃ¼llt -->
        </div>
        
        <!-- ğŸ†• v5.90.491: AKTUELLE FAHRTEN DIREKT ANZEIGEN! -->
        <div id="current-rides-display" style="
            margin: 10px;
            display: none;
        ">
            <!-- Wird dynamisch mit Fahrten gefÃ¼llt -->
        </div>
        
        <!-- ğŸ†• v5.61.0: GPS-WARNUNG FÃœR FAHRER! -->
        <div id="gps-warning-banner" style="display:none; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 15px; margin: 10px; border-radius: 12px; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4); animation: shake 0.5s;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 700; margin-bottom: 6px;">
                        ğŸš¨ GPS-PROBLEM ERKANNT!
                    </div>
                    <div id="gps-warning-text" style="font-size: 13px; opacity: 0.95; margin-bottom: 8px;">
                        GPS sendet keine Updates mehr!
                    </div>
                    <div style="font-size: 12px; opacity: 0.85;">
                        âš ï¸ Patrick sieht mÃ¶glicherweise alte Position!
                    </div>
                </div>
            </div>
        </div>

        <!-- ğŸ†• FAHRTEN PANEL - DIREKT IM DRIVER VIEW! -->
        <div id="new-rides-panel" style="
            display: none;
            background: white;
            margin: 10px;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border: 3px solid #667eea;
        ">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                <h3 style="margin:0;color:#667eea;">ğŸ“‹ Neue AuftrÃ¤ge</h3>
                <div style="display:flex;gap:8px;">
                    <!-- ğŸ†• v5.90.525: SYNC-CHECK BUTTON! -->
                    <button onclick="showSyncCheck()" style="background:#10b981;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;">ğŸ” Sync-Check</button>
                    <button onclick="toggleNewRidesPanel()" style="background:#ef4444;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;">âœ• SchlieÃŸen</button>
                </div>
            </div>
            <div id="new-rides"></div>
        </div>

                <button onclick="location.reload()" style="background: white; color: #ef4444; border: none; padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 700; cursor: pointer; white-space: nowrap; margin-left: 10px;">
                    ğŸ”„ Neu laden
                </button>
            </div>
        </div>
        
        <!-- Debug Panel (versteckt by default) -->
        <div id="debug-panel" style="
            display: none;
            padding: 10px;
            background: #f3f4f6;
            font-size: 11px;
            color: #666;
        ">
            <!-- ğŸ†• v5.42.7: CONSOLE CONTROLS GANZ OBEN! -->
            <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="font-size: 16px; font-weight: 700; color: #667eea; margin-bottom: 12px;">
                    ğŸ›ï¸ Console Controls
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <button onclick="pauseConsole()" id="console-pause-btn" style="
                        padding: 18px;
                        background: #f59e0b;
                        color: white;
                        border: none;
                        border-radius: 12px;
                        font-size: 16px;
                        font-weight: 700;
                        cursor: pointer;
                        box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
                        transition: transform 0.2s;
                    " onmousedown="this.style.transform='scale(0.95)'" onmouseup="this.style.transform='scale(1)'">
                        â¸ï¸ PAUSE
                    </button>
                    
                    <button onclick="playConsole()" id="console-play-btn" style="
                        padding: 18px;
                        background: #10b981;
                        color: white;
                        border: none;
                        border-radius: 12px;
                        font-size: 16px;
                        font-weight: 700;
                        cursor: pointer;
                        box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
                        display: none;
                        transition: transform 0.2s;
                    " onmousedown="this.style.transform='scale(0.95)'" onmouseup="this.style.transform='scale(1)'">
                        â–¶ï¸ PLAY
                    </button>
                    
                    <button onclick="copyConsole()" style="
                        padding: 18px;
                        background: #667eea;
                        color: white;
                        border: none;
                        border-radius: 12px;
                        font-size: 16px;
                        font-weight: 700;
                        cursor: pointer;
                        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
                        transition: transform 0.2s;
                    " onmousedown="this.style.transform='scale(0.95)'" onmouseup="this.style.transform='scale(1)'">
                        ğŸ“‹ COPY
                    </button>
                    
                    <button onclick="exportConsole()" style="
                        padding: 18px;
                        background: #3b82f6;
                        color: white;
                        border: none;
                        border-radius: 12px;
                        font-size: 16px;
                        font-weight: 700;
                        cursor: pointer;
                        box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
                        transition: transform 0.2s;
                    " onmousedown="this.style.transform='scale(0.95)'" onmouseup="this.style.transform='scale(1)'">
                        ğŸ’¾ EXPORT
                    </button>
                </div>
                <button onclick="clearConsoleLog()" style="
                    width: 100%;
                    padding: 18px;
                    background: #ef4444;
                    color: white;
                    border: none;
                    border-radius: 12px;
                    font-size: 16px;
                    font-weight: 700;
                    cursor: pointer;
                    box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
                    margin-bottom: 10px;
                    transition: transform 0.2s;
                " onmousedown="this.style.transform='scale(0.95)'" onmouseup="this.style.transform='scale(1)'">
                    ğŸ—‘ï¸ CLEAR
                </button>
                <div id="console-status" style="text-align: center; font-size: 13px; color: #10b981; font-weight: 700; padding: 8px; background: #d1fae5; border-radius: 8px;">
                    â–¶ï¸ Console lÃ¤uft
                </div>
            </div>
            
            <div style="border-top: 2px solid #ddd; padding-top: 15px;">
            FB: <span id="debug-firebase">â“</span> | 
            Fahrten: <span id="debug-rides">â“</span> | 
            Neu: <span id="debug-new">â“</span> | 
            Sync: <span id="debug-sync">â“</span>
            
            <!-- ğŸ†• v5.18.0: TELEGRAM FÃœR FAHRER -->
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                <b>ğŸ“± Telegram-Alarm aktivieren:</b>
                <div style="margin-top: 8px; display: flex; gap: 8px; align-items: center;">
                    <input type="text" id="driver-telegram-id" placeholder="Deine Chat-ID" style="
                        flex: 1;
                        padding: 8px;
                        border: 1px solid #ccc;
                        border-radius: 6px;
                        font-size: 12px;
                    ">
                    <button onclick="saveDriverTelegramId()" style="
                        padding: 8px 12px;
                        background: #0088cc;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        font-size: 12px;
                        cursor: pointer;
                    ">ğŸ’¾</button>
                    <button onclick="testDriverTelegram()" style="
                        padding: 8px 12px;
                        background: #10b981;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        font-size: 12px;
                        cursor: pointer;
                    ">ğŸ“¤ Test</button>
                </div>
                <div id="driver-telegram-status" style="margin-top: 6px; font-size: 10px; color: #888;">
                    â“ Noch nicht eingerichtet
                </div>
                <div style="margin-top: 6px; font-size: 10px; color: #666;">
                    Hol dir deine Chat-ID: Schreibe /getid an <a href="https://t.me/myidbot" target="_blank" style="color: #0088cc;">@myidbot</a>
                </div>
            </div>
        </div>
        
            <div style="padding: 10px;">
                <div id="new-rides"></div>
                <div id="completed-rides" style="display: none;"></div>
                <div id="cancelled-rides" style="display: none;"></div>
            </div>
        </div>
        
        <style>
            .rides-tab.active {
                background: white !important;
                border-bottom-color: #667eea !important;
                color: #667eea !important;
            }
        </style>
        
        <script>
            function switchRidesTab(tab) {
                // Hide all content
                document.getElementById('new-rides-list').style.display = 'none';
                document.getElementById('completed-rides').style.display = 'none';
                document.getElementById('cancelled-rides').style.display = 'none';
                
                // Remove active from all tabs
                document.querySelectorAll('.rides-tab').forEach(t => {
                    t.classList.remove('active');
                    t.style.background = 'transparent';
                    t.style.borderBottomColor = 'transparent';
                    t.style.color = '#666';
                });
                
                // Show selected content & activate tab
                if (tab === 'new') {
                    document.getElementById('new-rides-list').style.display = 'block';
                    document.getElementById('rides-tab-new').classList.add('active');
                } else if (tab === 'completed') {
                    document.getElementById('completed-rides').style.display = 'block';
                    document.getElementById('rides-tab-completed').classList.add('active');
                    loadCompletedRides();
                } else if (tab === 'cancelled') {
                    document.getElementById('cancelled-rides').style.display = 'block';
                    document.getElementById('rides-tab-cancelled').classList.add('active');
                    loadCancelledRides();
                }
            }
            
            function loadCompletedRides() {
                const myRides = currentVehicle ? rides.filter(r => r.vehicleId === currentVehicle || r.vehicle === (VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle)) : [];
                const completed = myRides.filter(r => r.status === 'completed');
                
                if (completed.length === 0) {
                    document.getElementById('completed-rides').innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Keine abgeschlossenen Fahrten</div>';
                    return;
                }
                
                // ğŸ†• v5.25.6: Mit Zeitstempel anzeigen
                let html = completed.map(r => {
                    // Buchungszeit formatieren
                    let buchungZeit = '?';
                    if (r.timestamp || r.createdAt) {
                        const bookingDate = new Date(r.timestamp || r.createdAt);
                        buchungZeit = bookingDate.toLocaleString('de-DE', {
                            day: '2-digit', month: '2-digit', 
                            hour: '2-digit', minute: '2-digit'
                        });
                    }
                    
                    // Abschlusszeit formatieren
                    let abschlussZeit = '?';
                    if (r.completedAt) {
                        const completeDate = new Date(r.completedAt);
                        abschlussZeit = completeDate.toLocaleString('de-DE', {
                            day: '2-digit', month: '2-digit', 
                            hour: '2-digit', minute: '2-digit'
                        });
                    }
                    
                    return `
                    <div class="ride-card" style="background:#f0fdf4;border-left:4px solid #10b981;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <span style="font-size:11px;color:#888;">ğŸ“… ${buchungZeit}</span>
                            <span style="background:#10b981;color:white;padding:4px 8px;border-radius:12px;font-size:11px;">âœ… Fertig</span>
                        </div>
                        ${r.customerName ? `<div style="font-weight:600;color:#065f46;margin-bottom:5px;">ğŸ’¾ ${r.customerName}</div>` : ''}
                        <div style="font-size:13px;color:#666;">
                            Von: ${r.pickup}<br>
                            Nach: ${r.destination}<br>
                            Preis: <strong>${r.price}â‚¬</strong> â€¢ ${r.distance} km<br>
                            <span style="font-size:11px;color:#10b981;">âœ… Abgeschlossen: ${abschlussZeit}</span>
                        </div>
                    </div>
                `}).join('');
                
                document.getElementById('completed-rides').innerHTML = html;
            }
            
            function loadCancelledRides() {
                // ğŸ†• v5.20.8: Auch assignedTo prÃ¼fen (nicht nur vehicleId)!
                const myRides = currentVehicle ? rides.filter(r => 
                    r.vehicleId === currentVehicle || 
                    r.assignedTo === currentVehicle ||
                    r.vehicle === (VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle)
                ) : [];
                const cancelled = myRides.filter(r => r.status === 'cancelled' || r.status === 'cancelled_pending_driver' || r.status === 'storniert');
                
                if (cancelled.length === 0) {
                    document.getElementById('cancelled-rides').innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Keine stornierten Fahrten</div>';
                    return;
                }
                
                // ğŸ†• v5.20.7: Mit Uhrzeiten anzeigen
                let html = cancelled.map(r => {
                    // Buchungszeit formatieren
                    let buchungZeit = '?';
                    if (r.timestamp || r.createdAt) {
                        const bookingDate = new Date(r.timestamp || r.createdAt);
                        buchungZeit = bookingDate.toLocaleString('de-DE', {
                            day: '2-digit', month: '2-digit', 
                            hour: '2-digit', minute: '2-digit'
                        });
                    }
                    
                    // Stornierungszeit formatieren
                    let stornoZeit = '?';
                    if (r.cancelledAt) {
                        const cancelDate = new Date(r.cancelledAt);
                        stornoZeit = cancelDate.toLocaleString('de-DE', {
                            day: '2-digit', month: '2-digit', 
                            hour: '2-digit', minute: '2-digit'
                        });
                    }
                    
                    // Abholzeit formatieren (falls Vorbestellung)
                    let abholZeit = '';
                    if (r.pickupTime && r.pickupTime !== 'Sofort') {
                        abholZeit = `â° Geplant: ${r.pickupTime}<br>`;
                    }
                    
                    return `
                    <div class="ride-card" style="background:#fef2f2;border-left:4px solid #ef4444;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <span style="font-size:11px;color:#888;">ğŸ“… ${buchungZeit}</span>
                            <span style="background:#ef4444;color:white;padding:4px 8px;border-radius:12px;font-size:11px;">ğŸš¨ Storniert</span>
                        </div>
                        ${r.customerName ? `<div style="font-weight:600;color:#991b1b;margin-bottom:5px;">ğŸ’¾ ${r.customerName}</div>` : ''}
                        <div style="font-size:13px;color:#666;">
                            ğŸ“ Von: ${r.pickup}<br>
                            ğŸ¯ Nach: ${r.destination}<br>
                            ${abholZeit}
                            ğŸ’° Preis: ${r.price || '?'}â‚¬<br>
                            ${r.cancellationFee ? `<strong style="color:#dc2626;">ğŸ’¶ StornogebÃ¼hr: ${r.cancellationFee.toFixed(2)}â‚¬</strong><br>` : ''}
                            ğŸ’¾ Storniert: ${stornoZeit}<br>
                            ${r.cancellationReason ? `ğŸ“ Grund: ${r.cancellationReason}` : ''}
                        </div>
                    </div>
                `;
                }).join('');
                
                document.getElementById('cancelled-rides').innerHTML = html;
            }
        </script>
        
        <!-- ğŸš¨ STORNIERUNG PANEL (NEU!) -->
        <div id="cancellation-panel" style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            padding: 20px;
            overflow-y: auto;
        ">
            <div id="cancellation-list" style="
                background: white;
                border-radius: 12px;
                padding: 20px;
                max-width: 500px;
                margin: 0 auto;
            "></div>
        </div>
        
        <!-- ğŸš• NEUER AUFTRAG FULLSCREEN POPUP (NEU!) -->
        <div id="new-ride-fullscreen" style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 10002;
            padding: 15px;
            overflow-y: auto;
            display: none;
            align-items: center;
            justify-content: center;
        ">
            <div style="
                background: white;
                border-radius: 16px;
                padding: 0;
                max-width: 380px;
                width: 100%;
                margin: 20px auto;
                box-shadow: 0 10px 40px rgba(0,0,0,0.4);
                overflow: hidden;
            ">
                <!-- Header - kompakter -->
                <div style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    padding: 15px;
                    text-align: center;
                    position: relative;
                ">
                    <button onclick="closeNewRideFullscreen()" style="
                        position: absolute;
                        top: 8px;
                        right: 8px;
                        background: rgba(0,0,0,0.4);
                        color: white;
                        border: 2px solid white;
                        width: 36px;
                        height: 36px;
                        border-radius: 50%;
                        font-size: 20px;
                        cursor: pointer;
                        font-weight: bold;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">âœ•</button>
                    
                    <div style="font-size: 40px; margin-bottom: 5px;">ğŸš•</div>
                    <div style="font-size: 22px; font-weight: bold; color: white;">
                        NEUE FAHRT!
                    </div>
                </div>
                
                <!-- Content -->
                <div id="new-ride-fullscreen-content" style="padding: 15px;">
                    <!-- Wird dynamisch gefÃ¼llt -->
                </div>
                </div>
            </div>
        </div>
        
        <!-- FULLSCREEN KARTE Container -->
        <div id="driver-route-info" style="
            display: none;
            position: relative;
            height: calc(100vh - 150px);
        ">
            <!-- ğŸ´ CARDS INFO TOP (A3/B3 Design) -->
            <div id="driver-cards-container" style="
                padding: 10px;
                background: white;
                box-shadow: 0 2px 6px rgba(0,0,0,0.1);
                display: grid;
                gap: 8px;
            ">
                <!-- Kunde Card (mit Telefon) -->
                <div id="driver-customer-card" style="
                    background: #f8f9fa;
                    padding: 10px;
                    border-radius: 8px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    border-left: 4px solid #667eea;
                ">
                    <div style="flex: 1;">
                        <div style="font-size: 10px; color: #999; text-transform: uppercase; margin-bottom: 3px;">
                            Kunde
                        </div>
                        <div id="driver-customer-name" style="font-size: 14px; font-weight: 600; color: #333;">
                            ğŸ’¾ Kunde
                        </div>
                    </div>
                    <button id="driver-call-button" onclick="callCustomer()" style="
                        background: #10b981;
                        color: white;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 16px;
                        font-size: 12px;
                        font-weight: 600;
                        cursor: pointer;
                        display: none;
                    ">ğŸ’¾</button>
                </div>
                
                <!-- Preis Card (nur bei picked_up) -->
                <div id="driver-price-card" style="
                    background: #f8f9fa;
                    padding: 10px;
                    border-radius: 8px;
                    border-left: 4px solid #10b981;
                    display: none;
                ">
                    <div style="font-size: 10px; color: #999; text-transform: uppercase; margin-bottom: 3px;">
                        Preis
                    </div>
                    <div id="driver-price-value" style="font-size: 14px; font-weight: 600; color: #333;">
                        ğŸ’° -
                    </div>
                </div>
                
                <!-- Pickup Card (nur bei accepted) -->
                <div id="driver-pickup-card" style="
                    background: #f8f9fa;
                    padding: 10px;
                    border-radius: 8px;
                    border-left: 4px solid #667eea;
                    display: none;
                ">
                    <div style="font-size: 10px; color: #999; text-transform: uppercase; margin-bottom: 3px;">
                        ğŸ“ Abholen
                    </div>
                    <div id="driver-pickup-value" style="font-size: 14px; font-weight: 600; color: #333;">
                        -
                    </div>
                </div>
                
                <!-- Destination Card -->
                <div id="driver-dest-card" style="
                    background: #ecfdf5;
                    padding: 10px;
                    border-radius: 8px;
                    border-left: 4px solid #10b981;
                ">
                    <div style="font-size: 10px; color: #059669; text-transform: uppercase; margin-bottom: 3px;">
                        ğŸ¯ Ziel
                    </div>
                    <div id="driver-dest-value" style="font-size: 14px; font-weight: 600; color: #065f46;">
                        -
                    </div>
                </div>
                
                <!-- Action Button -->
                <button id="driver-action-button" style="
                    width: 100%;
                    padding: 12px;
                    background: #667eea;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    font-size: 14px;
                    cursor: pointer;
                ">ğŸš— Beim Kunden angekommen</button>
            </div>
            
            <!-- ğŸ’¾ KARTE ENTFERNT - NUR INFO! -->
            
            <!-- Turn-by-Turn Central Overlay (GROÃŸ in der Mitte) -->
            <div id="turn-by-turn" style="
                display: none;
                position: absolute;
                top: 60px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(255,255,255,0.98);
                border-radius: 16px;
                padding: 20px 30px;
                text-align: center;
                box-shadow: 0 8px 24px rgba(0,0,0,0.3);
                backdrop-filter: blur(10px);
                border: 3px solid #667eea;
                z-index: 900;
            ">
                <div style="font-size: 56px; color: #667eea; margin-bottom: 8px;" id="turn-icon">â†‘</div>
                <div style="font-size: 36px; font-weight: bold; color: #333; margin-bottom: 5px;" id="turn-distance">150m</div>
                <div style="font-size: 18px; color: #666;" id="turn-instruction">Geradeaus</div>
            </div>
            
            <!-- Bottom Panel - Nur ETA -->
            <div id="bottom-panel" style="
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                padding: 10px;
                box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
                text-align: center;
                font-size: 12px;
                color: #666;
                z-index: 900;
            ">
                <span><b id="route-distance">-</b>km</span>
                <span> â€¢ </span>
                <span><b id="route-duration">-</b>min</span>
                <span> â€¢ </span>
                <span>ETA <b id="route-eta">-</b></span>
            </div>
        </div>
        
        <!-- Ready State (wenn keine Fahrt) - NUR FÃœR FAHRER -->
        <div id="driver-ready" style="
            display: none;
            padding: 80px 20px;
            text-align: center;
        ">
            <div style="font-size: 80px; margin-bottom: 20px;">ğŸš•</div>
            <div style="font-size: 28px; font-weight: 600; color: #667eea; margin-bottom: 10px;">Bereit!</div>
            <div style="font-size: 14px; color: #999;">WÃ¤hle Fahrzeug & gehe Online</div>
        </div>
        
        <script>
            // ğŸ“± HEADER TOGGLE
            let headerCollapsed = false;
            function toggleHeader() {
                const header = document.getElementById('main-header');
                const content = document.getElementById('header-content');
                const toggle = document.getElementById('header-toggle');
                
                headerCollapsed = !headerCollapsed;
                
                if (headerCollapsed) {
                    content.style.display = 'none';
                    toggle.textContent = 'â–¶';
                    header.style.padding = '8px 15px';
                } else {
                    content.style.display = 'block';
                    toggle.textContent = 'â–¼';
                    header.style.padding = '15px';
                }
            }
            
            // ğŸ”„ CACHE & DATEN LEEREN
            function clearAppCache(event) {
                // Verhindere dass Header collapsed wird
                if (event) event.stopPropagation();
                
                console.log('ğŸ”„ CACHE LEEREN GESTARTET...');
                
                const confirmed = confirm(
                    'ğŸ”„ Cache & Daten leeren?\n\n' +
                    'Das lÃ¶scht:\n' +
                    'âœ“ LocalStorage (gespeicherte Daten)\n' +
                    'âœ“ SessionStorage\n' +
                    'âœ“ Service Worker\n\n' +
                    'Die Seite wird neu geladen.\n\n' +
                    'Fortfahren?'
                );
                
                if (!confirmed) {
                    console.log('ğŸ’¾ Abgebrochen');
                    return;
                }
                
                let cleared = [];
                
                try {
                    // ğŸ†• v5.86.12: SELECTIVE CLEAR - Behalte wichtige App-Config!
                    console.log('ğŸ”„ LocalStorage wird selektiv geleert...');
                    
                    // âœ… DIESE KEYS BLEIBEN ERHALTEN (App-Config):
                    const keysToKeep = [
                        'anthropic_api_key',           // AI-Assistent API Key
                        'telegram_bot_token',          // Telegram Bot Token
                        'telegram_admin_chat_id',      // Admin Telegram Chat ID
                        'google_calendar_id',          // Google Calendar ID
                        'fritzbox_config',             // FritzBox Config
                        'app_settings'                 // App-Einstellungen
                    ];
                    
                    // Speichere wichtige Keys temporÃ¤r
                    const savedData = {};
                    keysToKeep.forEach(key => {
                        const value = localStorage.getItem(key);
                        if (value) {
                            savedData[key] = value;
                            console.log('ğŸ’¾ Behalte:', key);
                        }
                    });
                    
                    // LÃ¶sche ALLES
                    localStorage.clear();
                    
                    // Stelle wichtige Keys wieder her
                    Object.keys(savedData).forEach(key => {
                        localStorage.setItem(key, savedData[key]);
                        console.log('âœ… Wiederhergestellt:', key);
                    });
                    
                    console.log('âœ… LocalStorage selektiv gelÃ¶scht (Config behalten)');
                    cleared.push('LocalStorage (User-Daten)');
                } catch (e) {
                    console.error('ğŸ’¾ LocalStorage Fehler:', e);
                }
                
                try {
                    // 2. SessionStorage leeren
                    sessionStorage.clear();
                    console.log('âœ… SessionStorage gelÃ¶scht');
                    cleared.push('SessionStorage');
                } catch (e) {
                    console.error('ğŸ’¾ SessionStorage Fehler:', e);
                }
                
                try {
                    // 3. Service Worker deregistrieren
                    if ('serviceWorker' in navigator) {
                        navigator.serviceWorker.getRegistrations().then(registrations => {
                            registrations.forEach(registration => {
                                registration.unregister();
                                console.log('âœ… Service Worker deregistriert');
                            });
                            cleared.push('Service Worker');
                        });
                    }
                } catch (e) {
                    console.error('ğŸ’¾ Service Worker Fehler:', e);
                }
                
                // 4. IndexedDB leeren (falls vorhanden)
                try {
                    if (window.indexedDB) {
                        indexedDB.databases().then(databases => {
                            databases.forEach(db => {
                                indexedDB.deleteDatabase(db.name);
                                console.log('âœ… IndexedDB gelÃ¶scht:', db.name);
                            });
                        });
                        cleared.push('IndexedDB');
                    }
                } catch (e) {
                    console.error('ğŸ’¾ IndexedDB Fehler:', e);
                }
                
                console.log('âœ… GelÃ¶scht:', cleared.join(', '));
                
                // Zeige Erfolg + Anleitung fÃ¼r Browser-Cache
                alert(
                    'âœ… App-Daten gelÃ¶scht!\n\n' +
                    'GelÃ¶scht: ' + cleared.join(', ') + '\n\n' +
                    'âš ï¸ BROWSER-CACHE:\n' +
                    'Muss manuell gelÃ¶scht werden:\n\n' +
                    'Desktop: Strg+Shift+R\n' +
                    'Android: Chrome MenÃ¼ â†’ Verlauf â†’\n' +
                    'Browserdaten lÃ¶schen â†’ Cache\n\n' +
                    'Seite wird jetzt neu geladen...'
                );
                
                // Hard Reload
                setTimeout(() => {
                    console.log('ğŸ”„ Hard Reload...');
                    window.location.reload(true);
                }, 500);
            }
            
            // ğŸ†• v5.38.5: DEBUG-MODUS TOGGLE
            function toggleDebugMode() {
                debugMode = !debugMode;
                localStorage.setItem('debugMode', debugMode);
                
                const icon = document.getElementById('debug-icon');
                
                if (debugMode) {
                    // Aktiviere Console
                    if (console._originalLog) {
                        console.log = console._originalLog;
                        console.error = console._originalError;
                        console.warn = console._originalWarn;
                    }
                    
                    icon.textContent = 'ğŸŸ¢';
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    console.log('âœ… DEBUG-MODUS AKTIVIERT!');
                    console.log('ğŸ“± Console-Logs sind jetzt sichtbar!');
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                } else {
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    console.log('ğŸ”´ DEBUG-MODUS DEAKTIVIERT!');
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    
                    // Deaktiviere Console
                    console.log = function() {};
                    console.error = function() {};
                    console.warn = function() {};
                    
                    icon.textContent = 'ğŸ›';
                }
            }
            
            
            function toggleNewRidesPanel() {
                console.log('ğŸ”§ v5.90.403: toggleNewRidesPanel() aufgerufen');
                const panel = document.getElementById('new-rides-panel');
                console.log('  - Panel gefunden:', !!panel);
                if (panel) {
                    // ğŸ†• v5.90.403: NUR Ã–FFNEN, kein Toggle!
                    panel.style.display = 'block';
                    panel.style.visibility = 'visible';
                    panel.style.opacity = '1';
                    panel.style.zIndex = '99999';
                    console.log('  - Panel GEÃ–FFNET (ohne Alert)!');
                    
                    const ridesDiv = document.getElementById('new-rides-list');
                    console.log('  - Rides DIV innerHTML length:', ridesDiv ? ridesDiv.innerHTML.length : 0);
                }
            }
            
            // ğŸ†• v5.90.403: Close-Funktion
            function closeNewRidesPanel() {
                const panel = document.getElementById('new-rides-panel');
                if (panel) {
                    panel.style.display = 'none';
                    console.log('ğŸ”§ v5.90.403: Panel geschlossen');
                }
            }
            
            // ğŸ†• v5.90.525: SYNC-CHECK FUNKTION!
            async function showSyncCheck() {
                if (!currentVehicle) {
                    alert('ğŸ’¾ Kein Fahrzeug ausgewÃ¤hlt!');
                    return;
                }
                
                console.log('ğŸ” v5.90.525: SYNC-CHECK START');
                
                // 1. Lade ALLE Fahrten mit dieser vehicleId aus Firebase
                const snapshot = await db.ref('rides')
                    .orderByChild('vehicleId')
                    .equalTo(currentVehicle)
                    .once('value');
                
                const firebaseRides = snapshot.val() || {};
                const ridesList = Object.entries(firebaseRides).map(([id, ride]) => ({ id, ...ride }));
                
                // ğŸ†• v5.90.525: Speichere Rides fÃ¼r onclick-Zugriff!
                window.syncCheckRides = {};
                ridesList.forEach(ride => {
                    window.syncCheckRides[ride.id] = ride;
                });
                
                // 2. Filter nach Status
                // ğŸ†• v5.90.487: NUR AKTUELLE FAHRTEN (die JETZT laufen)!
                const validStatuses = ['assigned', 'accepted', 'picked_up', 'on_way'];
                const activeRides = ridesList.filter(r => validStatuses.includes(r.status));
                
                // ğŸ†• v5.90.487: KEIN Zeit-Filter! Zeige die aktuelle Fahrt!
                
                // 4. Erstelle Report - ğŸ†• v5.90.487: AKTUELLE FAHRT!
                let html = `
                    <div style="padding:20px;background:white;border-radius:12px;">
                        <h2 style="margin:0 0 20px 0;color:#667eea;">ğŸ“‹ Deine Fahrten</h2>
                        
                        <div style="background:#f9fafb;padding:15px;border-radius:8px;margin-bottom:20px;">
                            <h3 style="margin:0 0 10px 0;font-size:16px;">ğŸ“± Statistik:</h3>
                            <div style="font-size:14px;line-height:1.8;">
                                <div><strong>âœ… Aktuelle Fahrten:</strong> <span style="color:#667eea;font-weight:700;font-size:18px;">${activeRides.length}</span></div>
                                <div style="font-size:12px;color:#6b7280;margin-top:4px;">Status: assigned, accepted, picked_up, on_way</div>
                            </div>
                        </div>
                        
                        ${activeRides.length === 0 ? `
                            <div style="text-align:center;padding:40px 20px;color:#6b7280;">
                                <div style="font-size:48px;margin-bottom:10px;">âœ…</div>
                                <div style="font-size:18px;font-weight:600;">Keine aktuelle Fahrt!</div>
                                <div style="font-size:14px;margin-top:8px;">Warte auf neue Zuweisung...</div>
                            </div>
                        ` : `
                            <h3 style="margin:20px 0 10px 0;font-size:16px;">ğŸš— ${activeRides.length} aktuelle Fahrt${activeRides.length !== 1 ? 'en' : ''}:</h3>
                        `}
                `;
                
                activeRides.forEach((ride, idx) => {
                    const time = ride.pickupTimestamp ? new Date(ride.pickupTimestamp).toLocaleString('de-DE') : 'Sofort';
                    const minutesUntil = ride.pickupTimestamp ? Math.round((ride.pickupTimestamp - now) / 60000) : 0;
                    const statusColor = validStatuses.includes(ride.status) ? '#10b981' : '#6b7280';
                    
                    // ğŸ†• v5.90.485: Zeit-Info ohne Warnung
                    let timeInfo = '';
                    if (minutesUntil > 0) {
                        if (minutesUntil > 1440) { // > 1 Tag
                            const days = Math.floor(minutesUntil / 1440);
                            timeInfo = `(in ${days} Tag${days > 1 ? 'en' : ''})`;
                        } else if (minutesUntil > 60) { // > 1 Stunde
                            const hours = Math.floor(minutesUntil / 60);
                            timeInfo = `(in ${hours} Std)`;
                        } else {
                            timeInfo = `(in ${minutesUntil} Min)`;
                        }
                    } else if (minutesUntil < 0) {
                        timeInfo = `(vor ${Math.abs(minutesUntil)} Min)`;
                    }
                    
                    // ğŸ†• v5.90.485: KARTEN SIND KLICKBAR!
                    html += `
                        <div onclick="
                            document.getElementById('modal-sync-check').remove(); 
                            showRideDetailsModal(window.syncCheckRides['${ride.id}']);
                        " style="
                            background:#f9fafb;
                            padding:12px;
                            border-radius:8px;
                            margin-bottom:8px;
                            border-left:4px solid ${statusColor};
                            cursor:pointer;
                            transition:all 0.2s;
                        " onmouseover="this.style.background='#e0e7ff';" onmouseout="this.style.background='#f9fafb';">
                            <div style="font-weight:700;margin-bottom:4px;">
                                ${idx + 1}. ${ride.customerName || 'Unbekannt'} 
                                <span style="background:${statusColor};color:white;padding:2px 8px;border-radius:4px;font-size:12px;margin-left:8px;">${ride.status.toUpperCase()}</span>
                            </div>
                            <div style="font-size:13px;color:#6b7280;">
                                ğŸ“ ${ride.pickup || 'N/A'} â†’ ${ride.dropoff || 'N/A'}
                            </div>
                            <div style="font-size:13px;color:#6b7280;font-weight:600;">
                                â° ${time} ${timeInfo}
                            </div>
                            <div style="font-size:12px;color:#667eea;margin-top:8px;font-weight:600;">
                                ğŸ‘‰ Zum Ã–ffnen antippen
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        <button onclick="this.closest('div[id^=\\'modal-\\']').remove()" style="
                            width:100%;
                            padding:14px;
                            background:#667eea;
                            color:white;
                            border:none;
                            border-radius:8px;
                            font-weight:700;
                            cursor:pointer;
                            margin-top:20px;
                        ">âœ• SchlieÃŸen</button>
                    </div>
                `;
                
                // Modal erstellen
                const modal = document.createElement('div');
                modal.id = 'modal-sync-check';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.85);
                    z-index: 999999;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                    overflow-y: auto;
                `;
                modal.innerHTML = html;
                document.body.appendChild(modal);
                
                console.log('âœ… Sync-Check abgeschlossen');
            }
            
            
            // ğŸš¨ STORNIERUNG PANEL FUNKTIONEN
            function showCancellationPanel() {
                const myRides = currentVehicle ? rides.filter(r => r.vehicleId === currentVehicle || r.vehicle === (VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle)) : [];
                // ğŸ†• VEREINFACHT: Nur cancelled Fahrten die noch nicht gesehen wurden
                const pendingCancellations = myRides.filter(r => 
                    r.status === 'cancelled' && r.driverNotified === false
                );
                
                if (pendingCancellations.length === 0) {
                    alert('Keine Stornierungen!');
                    return;
                }
                
                let html = `
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h2 style="margin:0;color:#ef4444;">ğŸš¨ Stornierungen</h2>
                        <button onclick="closeCancellationPanel()" style="
                            background:#ef4444;
                            color:white;
                            border:none;
                            padding:8px 16px;
                            border-radius:8px;
                            cursor:pointer;
                            font-weight:600;
                        ">âœ• SchlieÃŸen</button>
                    </div>
                `;
                
                pendingCancellations.forEach(ride => {
                    const cancellationFee = calculateCancellationFee(ride);
                    html += `
                        <div style="
                            background:#fef2f2;
                            border:3px solid #ef4444;
                            border-radius:12px;
                            padding:20px;
                            margin-bottom:15px;
                        ">
                            <div style="font-size:24px;font-weight:bold;color:#ef4444;margin-bottom:15px;">
                                Fahrt #${ride.id}
                            </div>
                            
                            ${ride.customerName ? `
                            <div style="padding:12px;background:#dbeafe;border-radius:8px;margin-bottom:12px;">
                                <div style="font-size:18px;font-weight:600;color:#1e40af;">
                                    ğŸ’¾ ${ride.customerName}
                                </div>
                            </div>
                            ` : ''}
                            
                            <div style="margin-bottom:12px;font-size:14px;">
                                <strong>Von:</strong> ${ride.pickup}<br>
                                <strong>Nach:</strong> ${ride.destination}<br>
                                <strong>Abholung:</strong> ${ride.pickupTime || 'Sofort'}<br>
                                <strong>Preis:</strong> ${ride.price}â‚¬
                            </div>
                            
                            ${ride.cancellationReason ? `
                            <div style="
                                padding:12px;
                                background:#fff7ed;
                                border-left:4px solid #f59e0b;
                                border-radius:6px;
                                margin-bottom:12px;
                            ">
                                <strong>Grund:</strong> ${ride.cancellationReason}
                            </div>
                            ` : ''}
                            
                            <div style="
                                padding:15px;
                                background:white;
                                border-radius:8px;
                                margin-bottom:15px;
                                text-align:center;
                            ">
                                <div style="font-size:12px;color:#666;margin-bottom:5px;">
                                    StornierungsgebÃ¼hr
                                </div>
                                <div style="font-size:32px;font-weight:bold;color:#ef4444;">
                                    ${cancellationFee.toFixed(2)}â‚¬
                                </div>
                            </div>
                            
                            <button onclick="confirmCancellation('${ride.firebaseId || ride.id}')" style="
                                width:100%;
                                padding:16px;
                                background:#ef4444;
                                color:white;
                                border:none;
                                border-radius:12px;
                                font-size:16px;
                                font-weight:bold;
                                cursor:pointer;
                            ">
                                âœ“ OK, verstanden
                            </button>
                            
                            <button onclick="showRideDetails('${ride.firebaseId || ride.id}')" style="
                                width:100%;
                                padding:12px;
                                background:white;
                                color:#ef4444;
                                border:2px solid #ef4444;
                                border-radius:12px;
                                font-size:14px;
                                font-weight:600;
                                cursor:pointer;
                                margin-top:10px;
                            ">
                                Details ansehen
                            </button>
                        </div>
                    `;
                });
                
                document.getElementById('cancellation-list').innerHTML = html;
                document.getElementById('cancellation-panel').style.display = 'block';
            }
            
            function closeCancellationPanel() {
                document.getElementById('cancellation-panel').style.display = 'none';
            }
            
            async function confirmCancellation(rideId) {
                try {
                    const ride = rides.find(r => (r.firebaseId || r.id) === rideId);
                    if (!ride) {
                        alert('ğŸ’¾ Fahrt nicht gefunden!');
                        return;
                    }
                    
                    // ğŸ†• VEREINFACHT: Nur als "gesehen" markieren, kein Status-Wechsel nÃ¶tig
                    const updates = {
                        driverNotified: true,
                        driverConfirmedAt: new Date().toISOString()
                    };
                    
                    if (isFirebaseReady) {
                        await db.ref('rides/' + rideId).update(updates);
                        console.log('âœ… Stornierung zur Kenntnis genommen:', rideId);
                    }
                    
                    // Update lokal
                    Object.assign(ride, updates);
                    saveRides();
                    
                    // âœ… Panel schlieÃŸen
                    closeCancellationPanel();
                    
                    // UI Update
                    updateViews();
                    
                    // ğŸ†• Einfache BestÃ¤tigung
                    const feeText = ride.cancellationFee ? ` (GebÃ¼hr: ${ride.cancellationFee.toFixed(2)}â‚¬)` : '';
                    alert('âœ… OK!' + feeText);
                    
                } catch (error) {
                    console.error('ğŸ’¾ Fehler:', error);
                    alert('ğŸ’¾ Fehler: ' + error.message);
                }
            }
            
            function calculateCancellationFee(ride) {
                // StornierungsgebÃ¼hr = Grundpreis (4â‚¬) + 10% vom Fahrpreis
                const baseFee = 4.00;
                const percentageFee = ride.price ? ride.price * 0.1 : 0;
                const total = baseFee + percentageFee;
                
                // Runde auf 10 Cent
                return Math.round(total * 10) / 10;
            }
        </script>
    </div>

    <div id="admin-view" class="view admin-only">
        <!-- Header mit Suchleiste -->
        <div style="display:flex;justify-content:space-between;align-items:center;margin:20px 0;">
            <h3 style="margin:0;">âš™ï¸ Admin Dashboard</h3>
        </div>
        
        <!-- ğŸ†• v5.90.362: VEHICLE ID MIGRATION BUTTON! -->
        <div id="migration-banner" style="
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 8px 24px rgba(220, 38, 38, 0.4);
            border: 3px solid #dc2626;
            display: none;
        ">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 20px;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                        <div style="font-size: 36px;">âš ï¸</div>
                        <div>
                            <div style="font-size: 22px; font-weight: 700; color: white; margin-bottom: 4px;">
                                ALTE FAHRZEUG-IDs GEFUNDEN!
                            </div>
                            <div style="font-size: 14px; color: rgba(255,255,255,0.9);">
                                Deine Fahrzeuge nutzen noch alte IDs (tesla_model3_1). Klicke auf Migration um auf Kennzeichen-basierte IDs umzustellen!
                            </div>
                        </div>
                    </div>
                </div>
                <button onclick="runMigrationFromButton()" style="
                    padding: 16px 32px;
                    background: white;
                    color: #dc2626;
                    border: none;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 700;
                    cursor: pointer;
                    white-space: nowrap;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    transition: all 0.2s;
                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    ğŸ”„ JETZT MIGRIEREN
                </button>
            </div>
        </div>
        
        <!-- ğŸ†• v5.90.108: FAHRZEUG-ZUTEILUNGS-MODUS UMSCHALTER! -->
        <div id="assignment-mode-banner" style="
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.3);
            border: 3px solid #f59e0b;
        ">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 20px;">
                <!-- Mode Indicator -->
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                        <div id="mode-icon" style="font-size: 36px;">ğŸ”§</div>
                        <div>
                            <div style="font-size: 22px; font-weight: 700; color: white; margin-bottom: 4px;" id="mode-title">
                                MANUELLER MODUS
                            </div>
                            <div style="font-size: 14px; color: rgba(255,255,255,0.9);" id="mode-description">
                                Du teilst Fahrten manuell den Fahrzeugen zu
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Toggle Switch -->
                <div style="text-align: center;">
                    <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-bottom: 8px; font-weight: 600;">
                        MODUS WECHSELN
                    </div>
                    <label style="
                        position: relative;
                        display: inline-block;
                        width: 80px;
                        height: 40px;
                        cursor: pointer;
                    ">
                        <input type="checkbox" id="assignment-mode-toggle" onchange="toggleAssignmentMode()" style="opacity: 0; width: 0; height: 0;">
                        <span style="
                            position: absolute;
                            cursor: pointer;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: rgba(255,255,255,0.3);
                            transition: .4s;
                            border-radius: 40px;
                            border: 3px solid white;
                        ">
                            <span style="
                                position: absolute;
                                content: '';
                                height: 28px;
                                width: 28px;
                                left: 3px;
                                bottom: 3px;
                                background-color: white;
                                transition: .4s;
                                border-radius: 50%;
                            " id="mode-slider"></span>
                        </span>
                    </label>
                    <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 11px; color: white; font-weight: 600;">
                        <span>ğŸ”§</span>
                        <span>ğŸ¤–</span>
                    </div>
                </div>
            </div>
            
            <!-- Info Box -->
            <div id="mode-info-box" style="
                margin-top: 15px;
                padding: 12px;
                background: rgba(255,255,255,0.15);
                border-radius: 8px;
                border-left: 4px solid white;
                font-size: 13px;
                color: white;
            ">
                â„¹ï¸ Im manuellen Modus musst du jede Fahrt selbst einem Fahrzeug zuteilen.
            </div>
        </div>
        
        <!-- ğŸ†• v5.86.0: INTELLIGENTE SUCHE -->
        <div style="background:white;padding:15px;border-radius:12px;margin-bottom:20px;border:2px solid #667eea;box-shadow:0 4px 12px rgba(102,126,234,0.15);position:relative;">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                <div style="font-size:24px;">ğŸ”</div>
                <div style="flex:1;position:relative;">
                    <label style="display:block;font-weight:600;font-size:14px;color:#1f2937;margin-bottom:8px;">
                        Intelligente Suche
                    </label>
                    <input 
                        type="text" 
                        id="ride-id-search" 
                        placeholder="Kundenname oder Telefonnummer..." 
                        style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;"
                        oninput="liveSearch(this.value)"
                        onkeypress="if(event.key==='Enter') intelligentSearch()"
                        onfocus="liveSearch(this.value)">
                    
                    <!-- ğŸ†• v5.86.21: LIVE-SUCHE DROPDOWN -->
                    <div id="live-search-dropdown" style="
                        display:none;
                        position:absolute;
                        top:100%;
                        left:0;
                        right:0;
                        background:white;
                        border:2px solid #667eea;
                        border-radius:8px;
                        margin-top:4px;
                        max-height:400px;
                        overflow-y:auto;
                        box-shadow:0 8px 24px rgba(0,0,0,0.15);
                        z-index:1000;
                    ">
                        <!-- Wird dynamisch gefÃ¼llt -->
                    </div>
                </div>
                <button 
                    onclick="intelligentSearch()" 
                    style="padding:12px 20px;background:#667eea;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;white-space:nowrap;font-size:14px;">
                    ğŸ” Suchen
                </button>
            </div>
            <div style="font-size:12px;color:#6b7280;">
                ğŸ’¡ Tippe Namen oder Telefon â†’ Ergebnisse erscheinen sofort!
            </div>
        </div>
        
        <!-- ğŸ†• v5.90.5: DATENBANK BEREINIGEN -->
        <div style="background:white;padding:20px;border-radius:12px;margin-bottom:20px;border:2px solid #f59e0b;box-shadow:0 4px 12px rgba(245,158,11,0.15);">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:15px;">
                <div style="font-size:28px;">ğŸ§¹</div>
                <div>
                    <h4 style="margin:0;font-size:18px;color:#92400e;">Datenbank Bereinigen</h4>
                    <p style="margin:4px 0 0 0;font-size:13px;color:#78350f;">Finde und entferne ", Beliebtes Ziel" aus Adressen</p>
                </div>
            </div>
            
            <button onclick="findDirtyRides()" style="
                width:100%;
                padding:14px;
                background:linear-gradient(135deg, #f59e0b, #d97706);
                color:white;
                border:none;
                border-radius:8px;
                font-weight:700;
                font-size:15px;
                cursor:pointer;
                box-shadow:0 4px 8px rgba(245,158,11,0.3);
                transition:transform 0.2s;
            " onmousedown="this.style.transform='scale(0.98)'" onmouseup="this.style.transform='scale(1)'">
                ğŸ” Betroffene Fahrten suchen
            </button>
            
            <div id="cleanup-results" style="margin-top:15px;display:none;">
                <!-- Wird dynamisch gefÃ¼llt -->
            </div>
        </div>
        
 ABSCHLIESSEN -->
        <div style="background:white;padding:20px;border-radius:12px;margin-bottom:20px;border:2px solid #ef4444;box-shadow:0 4px 12px rgba(239,68,68,0.15);">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:15px;">
                <div style="font-size:28px;">ğŸš—</div>
                <div>
                    <h4 style="margin:0;font-size:18px;color:#991b1b;">Alte Fahrten abschlieÃŸen</h4>
                    <p style="margin:4px 0 0 0;font-size:13px;color:#7f1d1d;">Finde "aktive" Fahrten die hÃ¤ngen geblieben sind</p>
                </div>
            </div>
            
            <div style="background:#fef2f2;padding:12px;border-radius:6px;margin-bottom:15px;border-left:4px solid #ef4444;">
                <div style="font-size:13px;color:#7f1d1d;">
                    <div style="font-weight:600;margin-bottom:5px;">âš ï¸ Problem: Surge Pricing zu hoch?</div>
                    <div>Fahrten die als "Akzeptiert" oder "Unterwegs" hÃ¤ngen bleiben, erhÃ¶hen das Auto-Surge Pricing!</div>
                </div>
            </div>
            
            <button onclick="findOldActiveRides()" style="
                width:100%;
                padding:14px;
                background:linear-gradient(135deg, #ef4444, #dc2626);
                color:white;
                border:none;
                border-radius:8px;
                font-weight:700;
                font-size:15px;
                cursor:pointer;
                box-shadow:0 4px 8px rgba(239,68,68,0.3);
                transition:transform 0.2s;
            " onmousedown="this.style.transform='scale(0.98)'" onmouseup="this.style.transform='scale(1)'">
                ğŸ” Alte aktive Fahrten suchen
            </button>
            
            <div id="old-rides-results" style="margin-top:15px;">
                <!-- Wird dynamisch gefÃ¼llt -->
            </div>
        </div>
        
        <!-- ğŸ’¾ ANRUFHISTORIE -->
        <div style="background:white;padding:15px;border-radius:12px;margin-bottom:20px;border:2px solid #10b981;box-shadow:0 4px 12px rgba(16,185,129,0.15);">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:15px;">
                <div style="display:flex;align-items:center;gap:10px;">
                    <div style="font-size:24px;">ğŸ’¾</div>
                    <div style="font-weight:600;font-size:16px;color:#1f2937;">Anrufhistorie</div>
                </div>
                <button onclick="refreshCallHistory()" style="padding:8px 16px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;">
                    ğŸ”„ Aktualisieren
                </button>
            </div>
            
            <div id="call-history-container" style="max-height:400px;overflow-y:auto;">
                <div style="text-align:center;padding:40px;color:#6b7280;">
                    Lade Anrufhistorie...
                </div>
            </div>
        </div>
        
        <!-- ğŸ—‘ï¸ v5.90.33: TAB-BERECHTIGUNGEN ENTFERNT - Jetzt in Tab-Einstellungen! -->
        
        <!-- ğŸ†• v5.90.147: TAB-VERWALTUNG ZURÃœCK! -->
        <div style="background:white;padding:20px;border-radius:12px;margin-bottom:20px;border:2px solid #3b82f6;box-shadow:0 4px 12px rgba(59,130,246,0.15);">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:15px;">
                <div style="font-size:28px;">ğŸ“±</div>
                <div>
                    <h4 style="margin:0;font-size:18px;color:#1e40af;">Tab-Verwaltung</h4>
                    <p style="margin:4px 0 0 0;font-size:13px;color:#3730a3;">WÃ¤hle welche Tabs oben angezeigt werden sollen</p>
                </div>
            </div>
            
            <!-- Checkboxen fÃ¼r Tabs -->
            
            <!-- ğŸ†• v5.90.589: DYNAMISCHE TAB-VERWALTUNG (PRO USER!) -->
            <div id="tab-permissions-container" style="margin-bottom:20px;">
                <!-- Wird dynamisch von fillUserTabManagement() gefÃ¼llt -->
                <p style="text-align:center;color:#94a3b8;padding:40px;font-size:14px;">
                    â³ Lade Tab-Einstellungen...
                </p>
            </div>
            
            <!-- Standard-Tab Auswahl -->
            <div style="background:#eff6ff;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #3b82f6;">
                <label style="display:block;font-weight:600;color:#1e40af;margin-bottom:8px;">
                    ğŸ¯ Standard-Tab (wird beim Start geÃ¶ffnet):
                </label>
                <select id="default-tab-select" style="width:100%;padding:10px;border:2px solid #3b82f6;border-radius:6px;font-size:14px;">
                    <option value="passenger">ğŸš• Fahrgast</option>
                    <option value="schedule">ğŸ“… Termine</option>
                    <option value="history">ğŸ“œ Verlauf</option>
                    <option value="calendar">ğŸ“† Kalender</option>
                    <option value="hotel-calendar">ğŸ¨ Hotel-Kalender</option>
                    <option value="driver">ğŸš— Fahrer</option>
                    <option value="admin">âš™ï¸ Admin</option>
                    <option value="shift-plan">ğŸ—“ï¸ Schichtplan</option>
                    <option value="poi-management">â­ POI-Verwaltung</option>
                    <option value="vehicle-overview">ğŸš™ Fahrzeug-Ãœbersicht</option>
                    <option value="express-booking">âš¡ Express-Buchung</option>
                    <option value="simulator">ğŸ® Simulator</option>
                    <option value="booking-requests">ğŸ“‹ Buchungsanfragen</option>
                    <option value="ai-assistant">ğŸ¤– AI Assistant</option>
                    <option value="backup">ğŸ’¾ Backup</option>
                    <option value="archive">ğŸ“¦ Archiv</option>
                    <option value="debug">ğŸ› Debug</option>
                </select>
            </div>
        </div>
        
        <!-- ğŸ†• v5.87.86: EINSTELLUNGEN (MWST + ZAHLUNGSARTEN) -->
        <div style="background:white;padding:15px;border-radius:12px;margin-bottom:20px;border:2px solid #8b5cf6;box-shadow:0 4px 12px rgba(139,92,246,0.15);">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px;">
                <div style="font-size:24px;">âš™ï¸</div>
                <div style="font-weight:700;font-size:16px;color:#6d28d9;">Einstellungen</div>
            </div>
            
            <!-- MWST-SÃ„TZE -->
            <div style="background:#f5f3ff;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #8b5cf6;">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
                    <div style="font-weight:600;color:#6d28d9;">ğŸ’¶ MwSt-SÃ¤tze</div>
                    <button onclick="openAddVatRateModal()" style="padding:6px 12px;background:#8b5cf6;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:12px;">
                        â• Neuer Satz
                    </button>
                </div>
                <div id="vat-rates-list" style="display:flex;flex-direction:column;gap:8px;">
                    <!-- Wird dynamisch gefÃ¼llt -->
                    <div style="text-align:center;padding:20px;color:#6b7280;font-size:13px;">
                        Lade MwSt-SÃ¤tze...
                    </div>
                </div>
            </div>
            
            <!-- ZAHLUNGSARTEN -->
            <div style="background:#fef3c7;padding:15px;border-radius:8px;border-left:4px solid #f59e0b;">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
                    <div style="font-weight:600;color:#92400e;">ğŸ’³ Zahlungsarten</div>
                    <button onclick="openAddPaymentMethodModal()" style="padding:6px 12px;background:#f59e0b;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:12px;">
                        â• Neue Zahlungsart
                    </button>
                </div>
                <div id="payment-methods-list" style="display:flex;flex-direction:column;gap:8px;">
                    <!-- Wird dynamisch gefÃ¼llt -->
                    <div style="text-align:center;padding:20px;color:#6b7280;font-size:13px;">
                        Lade Zahlungsarten...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ğŸ†• v5.86.30: POI-VERWALTUNG (FAVORITEN-ZIELE) -->
        <div style="background:white;padding:15px;border-radius:12px;margin-bottom:20px;border:2px solid #f59e0b;box-shadow:0 4px 12px rgba(245,158,11,0.15);">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:15px;">
                <div style="display:flex;align-items:center;gap:10px;">
                    <div style="font-size:24px;">â­</div>
                    <div style="font-weight:700;font-size:16px;color:#92400e;">POI-Verwaltung (Favoriten-Ziele)</div>
                </div>
                <button onclick="openAddPOIModal()" style="padding:8px 16px;background:#f59e0b;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;">
                    â• Neues Ziel
                </button>
            </div>
            
            <div style="background:#fef3c7;padding:12px;border-radius:8px;margin-bottom:15px;border-left:4px solid #f59e0b;">
                <div style="font-size:13px;color:#78350f;">
                    <strong>ğŸ’¡ Info:</strong> Diese Favoriten-Ziele erscheinen mit gelbem Stern â­ in der Schnellbuchung!
                </div>
            </div>
            
            <div id="admin-poi-list-container" style="max-height:400px;overflow-y:auto;">
                <div style="text-align:center;padding:40px;color:#6b7280;">
                    Lade POIs...
                </div>
            </div>
        </div>
        
        <!-- ğŸ†• v5.27.1: KALENDER (NUR FÃœR ADMIN!) -->
        <div onclick="toggleAdminSection('calendar')" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ“… Fahrten-Kalender</span>
            <span id="calendar-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="calendar-content" style="display:none;margin-bottom:20px;background:white;padding:15px;border-radius:8px;border:1px solid #e5e7eb;">
            <!-- Ansichts-Toggle -->
            <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
                <button id="cal-month-btn" onclick="switchCalendarView('month')" style="flex: 1; min-width: 120px; padding: 12px; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    ğŸ“… Monat
                </button>
                <button id="cal-week-btn" onclick="switchCalendarView('week')" style="flex: 1; min-width: 120px; padding: 12px; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    ğŸ“± Woche
                </button>
                <button id="cal-day-btn" onclick="switchCalendarView('day')" style="flex: 1; min-width: 120px; padding: 12px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    ğŸ“‹ Tag
                </button>
                <button id="cal-timeline-btn" onclick="switchCalendarView('timeline')" style="flex: 1; min-width: 140px; padding: 12px; border: 2px solid #10b981; background: white; color: #10b981; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    ğŸš—â±ï¸ Fahrzeug-Timeline
                </button>
                <button id="quick-booking-btn" onclick="openQuickBookingModal()" style="flex: 1; min-width: 140px; padding: 12px; border: 2px solid #f59e0b; background: #f59e0b; color: white; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);">
                    âš¡ Schnellbuchung
                </button>
            </div>
            
            <!-- Monats-Navigation -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 12px; background: #f9fafb; border-radius: 8px; flex-wrap: wrap; gap: 10px;">
                <button onclick="previousPeriod()" style="padding: 8px 16px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; font-weight: 600; cursor: pointer;">
                    â—€ï¸ ZurÃ¼ck
                </button>
                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: center;">
                    <div style="font-weight: 700; font-size: 16px; color: #1f2937;" id="calendar-period-title">
                        November 2025
                    </div>
                    <!-- ğŸ†• v5.88.27: SPRINGE ZU DATUM -->
                    <input type="date" id="calendar-jump-date" 
                        style="padding: 8px 12px; border: 2px solid #667eea; border-radius: 6px; font-size: 14px; cursor: pointer;"
                        onchange="jumpToDate(this.value)"
                        title="Springe zu Datum">
                    <button onclick="jumpToToday()" style="padding: 8px 12px; background: #10b981; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px;">
                        ğŸ“… Heute
                    </button>
                </div>
                <button onclick="nextPeriod()" style="padding: 8px 16px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; font-weight: 600; cursor: pointer;">
                    Vor â–¶ï¸
                </button>
            </div>
            
            <!-- Legende -->
            <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 15px; padding: 12px; background: #f9fafb; border-radius: 8px; font-size: 13px;">
                <div style="font-weight: 600; width: 100%; margin-bottom: 5px; color: #1f2937;">Status:</div>
                <div style="display: flex; align-items: center; gap: 4px;">
                    <div style="width: 12px; height: 12px; background: #10b981; border-radius: 50%;"></div>
                    <span>Abgeschlossen</span>
                </div>
                <div style="display: flex; align-items: center; gap: 4px;">
                    <div style="width: 12px; height: 12px; background: #ef4444; border-radius: 50%;"></div>
                    <span>Storniert</span>
                </div>
                <div style="display: flex; align-items: center; gap: 4px;">
                    <div style="width: 12px; height: 12px; background: #f59e0b; border-radius: 50%;"></div>
                    <span>Vorbestellt</span>
                </div>
                <div style="display: flex; align-items: center; gap: 4px;">
                    <div style="width: 12px; height: 12px; background: #3b82f6; border-radius: 50%;"></div>
                    <span>In Bearbeitung</span>
                </div>
            </div>
            
            <!-- ğŸ†• v5.29.0: KAPAZITÃ„TS-LEGENDE -->
            <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; padding: 12px; background: #fffbeb; border-radius: 8px; font-size: 13px; border: 2px solid #fcd34d;">
                <div style="font-weight: 600; width: 100%; margin-bottom: 5px; color: #1f2937;">ğŸ”¥ Auslastung:</div>
                <div style="display: flex; align-items: center; gap: 6px;">
                    <div style="padding: 4px 8px; background: #f0fdf4; border: 2px solid #86efac; border-radius: 6px; font-weight: 600; color: #166534;">
                        âœ… 1-3
                    </div>
                    <span style="color: #166534;">OK</span>
                </div>
                <div style="display: flex; align-items: center; gap: 6px;">
                    <div style="padding: 4px 8px; background: #fef3c7; border: 2px solid #fcd34d; border-radius: 6px; font-weight: 600; color: #92400e;">
                        âš ï¸ 4-5
                    </div>
                    <span style="color: #92400e;">KÃ¶nnte eng werden</span>
                </div>
                <div style="display: flex; align-items: center; gap: 6px;">
                    <div style="padding: 4px 8px; background: #fef2f2; border: 2px solid: #fca5a5; border-radius: 6px; font-weight: 600; color: #991b1b;">
                        ğŸ”¥ 6+
                    </div>
                    <span style="color: #991b1b;">Viele Fahrten!</span>
                </div>
            </div>
            
            <!-- Kalender-Container -->
            <div id="calendar-container" style="margin-bottom: 20px; position: relative;">
                <!-- Wird dynamisch gefÃ¼llt -->
            </div>
            
            <!-- Statistik -->
            <div id="calendar-stats" style="padding: 15px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 12px; font-size: 14px;">
                <!-- Wird dynamisch gefÃ¼llt -->
            </div>
        </div>
        
        <!-- ğŸ†• v5.77.0: HOTEL-KALENDER VERWALTUNG -->
        <div onclick="toggleAdminSection('hotel-calendars')" style="background:linear-gradient(135deg,#f97316,#ea580c);color:white;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ¨ Hotel-Kalender <span id="hotel-calendar-count" style="background:white;color:#ea580c;padding:2px 8px;border-radius:10px;font-size:12px;margin-left:8px;">0</span></span>
            <span id="hotel-calendars-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="hotel-calendars-content" style="display:none;margin-bottom:20px;background:white;padding:15px;border-radius:8px;border:1px solid #e5e7eb;">
            
            <!-- Info-Box -->
            <div style="background:#dbeafe;border:2px solid #3b82f6;border-radius:8px;padding:12px;margin-bottom:15px;font-size:13px;">
                <div style="font-weight:700;margin-bottom:8px;color:#1e40af;font-size:15px;">ğŸ” v5.87.23: Google Calendar OAuth Integration!</div>
                
                <div style="background:#fff;border-radius:6px;padding:10px;margin-bottom:10px;border:2px solid #60a5fa;">
                    <div style="font-weight:700;margin-bottom:6px;color:#1e40af;">âœ¨ NEU: Direkt mit Google verbinden (empfohlen!)</div>
                    <ol style="margin:0;padding-left:20px;color:#1e40af;line-height:1.6;">
                        <li>Klicke "Mit Google Kalender verbinden"</li>
                        <li>Melde dich mit deinem Google-Account an</li>
                        <li>WÃ¤hle Hotel-Kalender aus der Liste aus</li>
                        <li>Fertig! Automatischer Sync via API</li>
                    </ol>
                    <div style="margin-top:8px;padding:6px;background:#dbeafe;border-radius:4px;font-size:12px;">
                        ğŸ’¡ <strong>Vorteil:</strong> Kein iCal-Link nÃ¶tig! Direkter Zugriff, schneller Sync
                    </div>
                </div>
                
                <div style="background:#fff;border-radius:6px;padding:10px;border:2px solid #cbd5e1;">
                    <div style="font-weight:700;margin-bottom:6px;color:#482569;">ğŸ“ Alternative: iCal-Link (fÃ¼r nicht-Google Kalender)</div>
                    <ol style="margin:0;padding-left:20px;color:#482569;line-height:1.6;">
                        <li>Hotel teilt Google Calendar iCal-Link</li>
                        <li>Link hier einfÃ¼gen</li>
                        <li>Automatische Synchronisation alle 15min</li>
                        <li>Termine erscheinen farbcodiert im Kalender</li>
                    </ol>
                </div>
                
                <div style="margin-top:10px;padding:8px;background:#fff;border-radius:6px;border:2px solid #10b981;">
                    <div style="font-weight:700;font-size:12px;color:#065f46;margin-bottom:4px;">ğŸ”„ VollstÃ¤ndiger Import:</div>
                    <div style="font-size:12px;color:#065f46;">
                        Es werden <strong>ALLE Termine</strong> importiert:<br>
                        âœ… Vergangene Events (Historie)<br>
                        âœ… Aktuelle Events<br>
                        âœ… ZukÃ¼nftige Events (unbegrenzt)<br>
                        ğŸ”„ Automatische Sync alle 15min
                    </div>
                </div>
            </div>
            
            <!-- ğŸ“… v5.87.23: GOOGLE CALENDAR OAUTH BUTTON -->
            <button onclick="connectGoogleCalendar()" style="width:100%;padding:16px;background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;margin-bottom:12px;font-size:15px;box-shadow:0 4px 12px rgba(59,130,246,0.3);display:flex;align-items:center;justify-content:center;gap:10px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z" fill="white"/>
                </svg>
                ğŸ” Mit Google Kalender verbinden (OAuth)
            </button>
            
            <div style="text-align:center;margin-bottom:12px;color:#6b7280;font-size:13px;font-weight:600;">
                â”â”â”â”â” ODER â”â”â”â”â”
            </div>
            
            <!-- Add Button -->
            <button onclick="showAddHotelCalendarForm()" style="width:100%;padding:14px;background:linear-gradient(135deg,#f97316,#ea580c);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;margin-bottom:10px;font-size:15px;box-shadow:0 4px 12px rgba(249,115,22,0.3);">
                â• Neuen Hotel-Kalender hinzufÃ¼gen
            </button>
            
            <!-- ğŸ†• v5.84.0: CSV IMPORT BUTTON -->
            <button onclick="showCSVImportDialog()" style="width:100%;padding:14px;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;margin-bottom:15px;font-size:15px;box-shadow:0 4px 12px rgba(16,185,129,0.3);">
                ğŸ“± CSV Importieren (Calengoo)
            </button>
            
            <!-- Add Form (versteckt) -->
            <div id="add-hotel-calendar-form" style="display:none;background:#f9fafb;border:2px solid #e5e7eb;border-radius:8px;padding:15px;margin-bottom:15px;">
                <h4 style="margin:0 0 15px 0;font-size:15px;color:#1f2937;">â• Hotel-Kalender hinzufÃ¼gen</h4>
                
                <div style="margin-bottom:12px;">
                    <label style="display:block;font-weight:600;font-size:13px;color:#374151;margin-bottom:6px;">ğŸ¨ Hotel-Name</label>
                    <input type="text" id="new-hotel-name" placeholder="z.B. Hotel SeebrÃ¼cke" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:6px;font-size:14px;box-sizing:border-box;">
                </div>
                
                <div style="margin-bottom:12px;">
                    <label style="display:block;font-weight:600;font-size:13px;color:#374151;margin-bottom:6px;">
                        ğŸ“… Google Calendar iCal URL <span style="color:#9ca3af;font-weight:400;">(optional)</span>
                    </label>
                    <input type="url" id="new-hotel-ical-url" placeholder="Leer lassen fÃ¼r OAuth-Verbindung (empfohlen!)" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:6px;font-size:13px;box-sizing:border-box;font-family:monospace;">
                    <div style="font-size:11px;color:#6b7280;margin-top:4px;line-height:1.4;">
                        ğŸ’¡ <strong>Empfohlen:</strong> Feld leer lassen â†’ OAuth-Verbindung (sicherer, schneller)<br>
                        ğŸ“ <strong>Alternative:</strong> iCal-URL eingeben (Google Calendar â†’ Einstellungen â†’ iCal-URL kopieren)
                    </div>
                </div>
                
                <div style="margin-bottom:12px;">
                    <label style="display:block;font-weight:600;font-size:13px;color:#374151;margin-bottom:6px;">ğŸ¨ Farbe im Kalender</label>
                    <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;">
                        <button onclick="selectHotelColor('#f97316')" class="color-btn" data-color="#f97316" style="width:100%;aspect-ratio:1;border:3px solid #e5e7eb;border-radius:8px;cursor:pointer;background:#f97316;"></button>
                        <button onclick="selectHotelColor('#3b82f6')" class="color-btn" data-color="#3b82f6" style="width:100%;aspect-ratio:1;border:3px solid #e5e7eb;border-radius:8px;cursor:pointer;background:#3b82f6;"></button>
                        <button onclick="selectHotelColor('#10b981')" class="color-btn" data-color="#10b981" style="width:100%;aspect-ratio:1;border:3px solid #e5e7eb;border-radius:8px;cursor:pointer;background:#10b981;"></button>
                        <button onclick="selectHotelColor('#f59e0b')" class="color-btn" data-color="#f59e0b" style="width:100%;aspect-ratio:1;border:3px solid #e5e7eb;border-radius:8px;cursor:pointer;background:#f59e0b;"></button>
                        <button onclick="selectHotelColor('#ef4444')" class="color-btn" data-color="#ef4444" style="width:100%;aspect-ratio:1;border:3px solid #e5e7eb;border-radius:8px;cursor:pointer;background:#ef4444;"></button>
                        <button onclick="selectHotelColor('#8b5cf6')" class="color-btn" data-color="#8b5cf6" style="width:100%;aspect-ratio:1;border:3px solid #e5e7eb;border-radius:8px;cursor:pointer;background:#8b5cf6;"></button>
                    </div>
                    <input type="hidden" id="new-hotel-color" value="#f97316">
                </div>
                
                <div style="display:flex;gap:10px;">
                    <button onclick="saveHotelCalendar()" style="flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;">
                        ğŸ’¾ Speichern
                    </button>
                    <button onclick="cancelAddHotelCalendar()" style="flex:1;padding:12px;background:#ef4444;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;">
                        ğŸ’¾ Abbrechen
                    </button>
                </div>
            </div>
            
            <!-- Hotel Calendar List -->
            <div id="hotel-calendar-list">
                <div style="text-align:center;padding:40px;color:#6b7280;">
                    Lade Hotel-Kalender...
                </div>
            </div>
        </div>
        
        <!-- ğŸ†• v5.78.0: HOTEL-RECHNUNGEN -->
        <div onclick="toggleAdminSection('hotel-invoices')" style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ“± Hotel-Rechnungen <span id="hotel-invoices-count" style="background:white;color:#059669;padding:2px 8px;border-radius:10px;font-size:12px;margin-left:8px;">0</span></span>
            <span id="hotel-invoices-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="hotel-invoices-content" style="display:none;margin-bottom:20px;background:white;padding:15px;border-radius:8px;border:1px solid #e5e7eb;">
            
            <!-- Filter -->
            <div style="background:#f9fafb;border-radius:8px;padding:15px;margin-bottom:15px;">
                <div style="font-weight:700;margin-bottom:12px;color:#1f2937;">ğŸ” Filter</div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
                    <!-- Hotel auswÃ¤hlen -->
                    <div>
                        <label style="display:block;font-weight:600;font-size:13px;color:#374151;margin-bottom:6px;">ğŸ¨ Hotel</label>
                        <select id="invoice-hotel-select" onchange="loadInvoiceRides()" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:6px;font-size:14px;background:white;">
                            <option value="">Alle Hotels</option>
                        </select>
                    </div>
                    
                    <!-- Monat auswÃ¤hlen -->
                    <div>
                        <label style="display:block;font-weight:600;font-size:13px;color:#374151;margin-bottom:6px;">ğŸ“… Monat</label>
                        <input type="month" id="invoice-month-select" min="2020-01" onchange="loadInvoiceRides()" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:6px;font-size:14px;">
                    </div>
                </div>
                
                <button onclick="loadInvoiceRides()" style="width:100%;padding:12px;background:#10b981;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;">
                    ğŸ”„ Fahrten laden
                </button>
            </div>
            
            <!-- Statistik -->
            <div id="invoice-stats" style="display:none;background:linear-gradient(135deg,#10b981,#059669);color:white;border-radius:8px;padding:15px;margin-bottom:15px;">
                <!-- Wird dynamisch gefÃ¼llt -->
            </div>
            
            <!-- Fahrten-Tabelle -->
            <div id="invoice-rides-container" style="margin-bottom:15px;">
                <div style="text-align:center;padding:40px;color:#6b7280;">
                    <div style="font-size:48px;margin-bottom:10px;">ğŸ“±</div>
                    <div style="font-weight:600;margin-bottom:6px;">WÃ¤hle Hotel und Monat</div>
                    <div style="font-size:13px;">Dann werden alle Fahrten angezeigt</div>
                </div>
            </div>
            
            <!-- Rechnung erstellen Button -->
            <div id="invoice-create-button" style="display:none;">
                <button onclick="createHotelInvoicePDF()" style="width:100%;padding:16px;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:16px;box-shadow:0 4px 12px rgba(16,185,129,0.3);">
                    ğŸ“± Rechnung als PDF erstellen
                </button>
            </div>
            
            <!-- Rechnungs-Historie -->
            <div style="margin-top:30px;padding-top:20px;border-top:2px solid #e5e7eb;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                    <h4 style="margin:0;font-size:15px;color:#1f2937;">ğŸ“‹ Rechnungs-Historie</h4>
                    <button onclick="loadInvoiceHistory()" style="padding:8px 12px;background:#6b7280;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;">
                        ğŸ”„ Aktualisieren
                    </button>
                </div>
                <div id="invoice-history-list">
                    <div style="text-align:center;padding:20px;color:#6b7280;font-size:13px;">
                        Lade Historie...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ğŸ†• v5.87.90: EINZEL-RECHNUNGEN VERWALTUNG -->
        <div onclick="toggleAdminSection('single-invoices')" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ“± Einzel-Rechnungen <span id="single-invoices-count" style="background:white;color:#7c3aed;padding:2px 8px;border-radius:10px;font-size:12px;margin-left:8px;">0</span></span>
            <span id="single-invoices-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="single-invoices-content" style="display:none;margin-bottom:20px;background:white;padding:15px;border-radius:8px;border:1px solid #e5e7eb;">
            
            <!-- Filter -->
            <div style="background:#f9fafb;border-radius:8px;padding:15px;margin-bottom:15px;">
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
                    <div>
                        <label style="display:block;font-weight:600;font-size:13px;color:#374151;margin-bottom:6px;">ğŸ” Suche</label>
                        <input type="text" id="invoice-search" placeholder="Kunde, RE-Nr..." oninput="filterInvoicesList()" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:6px;font-size:14px;">
                    </div>
                    <div>
                        <label style="display:block;font-weight:600;font-size:13px;color:#374151;margin-bottom:6px;">ğŸ“± Status</label>
                        <select id="invoice-status-filter" onchange="filterInvoicesList()" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:6px;font-size:14px;">
                            <option value="">Alle</option>
                            <option value="offen">Offen</option>
                            <option value="bezahlt">Bezahlt</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block;font-weight:600;font-size:13px;color:#374151;margin-bottom:6px;">ğŸ“… Zeitraum</label>
                        <input type="month" id="invoice-month-filter" onchange="filterInvoicesList()" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:6px;font-size:14px;">
                    </div>
                </div>
            </div>
            
            <!-- Rechnungsliste -->
            <div id="single-invoices-list" style="max-height:500px;overflow-y:auto;">
                <div style="text-align:center;padding:40px;color:#6b7280;">
                    <div style="font-size:48px;margin-bottom:10px;">ğŸ“±</div>
                    <div style="font-weight:600;margin-bottom:6px;">Lade Rechnungen...</div>
                </div>
            </div>
            
            <!-- Zusammenfassung -->
            <div id="invoices-summary" style="display:none;margin-top:15px;padding:15px;background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;border-radius:8px;">
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;text-align:center;">
                    <div>
                        <div style="font-size:24px;font-weight:700;" id="invoices-total-count">0</div>
                        <div style="font-size:12px;opacity:0.9;">Gesamt</div>
                    </div>
                    <div>
                        <div style="font-size:24px;font-weight:700;" id="invoices-open-amount">0â‚¬</div>
                        <div style="font-size:12px;opacity:0.9;">Offen</div>
                    </div>
                    <div>
                        <div style="font-size:24px;font-weight:700;" id="invoices-paid-amount">0â‚¬</div>
                        <div style="font-size:12px;opacity:0.9;">Bezahlt</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ğŸš¨ NEU: AKTIVE FAHRTEN ÃœBERSICHT -->
        <div onclick="toggleAdminSection('activerides')" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸš¨ Aktive Fahrten <span id="active-rides-count" style="background:white;color:#d97706;padding:2px 8px;border-radius:10px;font-size:12px;margin-left:8px;">0</span></span>
            <span id="activerides-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="activerides-content" style="display:none;margin-bottom:20px;">
            <div style="display:flex;gap:10px;margin-bottom:10px;">
                <button onclick="loadActiveRides()" style="padding:10px 15px;background:#f59e0b;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ”„ Aktualisieren
                </button>
                <button onclick="cleanupAllStuckRides()" style="padding:10px 15px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ§¹ HÃ¤ngende zurÃ¼cksetzen
                </button>
            </div>
            <div id="active-rides-list" style="background:#fff;border-radius:8px;border:1px solid #e5e7eb;max-height:400px;overflow-y:auto;">
                <div style="padding:20px;text-align:center;color:#999;">Lade aktive Fahrten...</div>
            </div>
        </div>
        
        <!-- ğŸ—ºï¸ NEU: FAHRZEUG-KARTE -->
        <div onclick="toggleAdminSection('fleetmap')" style="background:linear-gradient(135deg,#0ea5e9,#0284c7);color:white;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ—ºï¸ Fahrzeug-Ãœbersicht <span id="fleet-status" style="font-size:12px;opacity:0.8;"></span></span>
            <span id="fleetmap-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="fleetmap-content" style="display:none;margin-bottom:20px;">
            <!-- ğŸ” NEU v5.88.31: Adresssuche -->
            <div style="margin-bottom:12px;position:relative;">
                <div style="display:flex;gap:8px;">
                    <input type="text" id="fleet-address-search" 
                        placeholder="ğŸ” Adresse suchen..." 
                        autocomplete="off"
                        style="flex:1;padding:12px;border:2px solid #0ea5e9;border-radius:8px;font-size:14px;">
                    <button id="fleet-share-btn" onclick="shareFleetAddress()" style="display:none;padding:12px 16px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">ğŸ“¤</button>
                    <button onclick="clearFleetSearch()" style="padding:12px 16px;background:#6b7280;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">âœ•</button>
                </div>
                <div id="fleet-address-dropdown" style="display:none;position:absolute;top:100%;left:0;right:100px;background:white;border:1px solid #e5e7eb;border-radius:8px;max-height:250px;overflow-y:auto;z-index:1000;box-shadow:0 4px 15px rgba(0,0,0,0.15);margin-top:4px;"></div>
            </div>
            
            <!-- Legende -->
            <div style="display:flex;gap:15px;margin-bottom:10px;font-size:13px;">
                <div style="display:flex;align-items:center;gap:5px;">
                    <div style="width:12px;height:12px;background:#22c55e;border-radius:50%;"></div>
                    <span>Frei</span>
                </div>
                <div style="display:flex;align-items:center;gap:5px;">
                    <div style="width:12px;height:12px;background:#ef4444;border-radius:50%;"></div>
                    <span>Besetzt</span>
                </div>
                <div style="display:flex;align-items:center;gap:5px;">
                    <div style="width:12px;height:12px;background:#f59e0b;border-radius:50%;"></div>
                    <span>Zugewiesen</span>
                </div>
                <div style="display:flex;align-items:center;gap:5px;">
                    <div style="width:12px;height:12px;background:#6b7280;border-radius:50%;"></div>
                    <span>Offline</span>
                </div>
            </div>
            
            <!-- Karte -->
            <div id="fleet-map" style="height:350px;border-radius:8px;border:2px solid #e0e0e0;"></div>
            
            <!-- Fahrzeug-Liste -->
            <div id="fleet-vehicle-list" style="margin-top:10px;"></div>
            
            <!-- Buttons -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
                <button onclick="refreshFleetMap()" style="padding:12px;background:#0ea5e9;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ”„ Aktualisieren
                </button>
                <button onclick="toggleFleetAutoRefresh()" id="fleet-auto-btn" style="padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    â–¶ï¸ Auto-Update
                </button>
            </div>
        </div>
        
        <!-- ğŸ”´ NEU: LIVE-LOG -->
        <div onclick="toggleAdminSection('livelog')" style="background:linear-gradient(135deg,#dc2626,#b91c1c);color:white;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ”´ Live-Log <span id="live-log-status" style="font-size:12px;opacity:0.8;">(gestoppt)</span></span>
            <span id="livelog-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="livelog-content" style="display:none;margin-bottom:20px;">
            <!-- Live-Log Konsole -->
            <div id="live-log-console" style="background:#1e1e1e;color:#00ff00;font-family:monospace;font-size:12px;padding:15px;border-radius:8px;height:300px;overflow-y:auto;margin-bottom:10px;">
                <div style="color:#888;">// Live-Log gestartet...</div>
                <div style="color:#888;">// Warte auf Ereignisse...</div>
            </div>
            
            <!-- Live-Log Controls -->
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
                <button id="live-log-toggle-btn" onclick="toggleLiveLog()" style="padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    â–¶ï¸ Starten
                </button>
                <button onclick="clearLiveLogConsole()" style="padding:12px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ—‘ï¸ Console leeren
                </button>
                <button onclick="exportLiveLog()" style="padding:12px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ“‹ Kopieren
                </button>
            </div>
            
            <!-- Filter fÃ¼r Live-Log -->
            <div style="margin-top:10px;display:flex;flex-wrap:wrap;gap:5px;">
                <label style="display:flex;align-items:center;gap:4px;font-size:12px;background:#f3f4f6;padding:5px 10px;border-radius:15px;cursor:pointer;">
                    <input type="checkbox" id="live-filter-booking" checked onchange="updateLiveFilters()"> ğŸ“± Buchungen
                </label>
                <label style="display:flex;align-items:center;gap:4px;font-size:12px;background:#f3f4f6;padding:5px 10px;border-radius:15px;cursor:pointer;">
                    <input type="checkbox" id="live-filter-driver" checked onchange="updateLiveFilters()"> ğŸš— Fahrer
                </label>
                <label style="display:flex;align-items:center;gap:4px;font-size:12px;background:#f3f4f6;padding:5px 10px;border-radius:15px;cursor:pointer;">
                    <input type="checkbox" id="live-filter-assignment" checked onchange="updateLiveFilters()"> ğŸ¯ Vermittlung
                </label>
                <label style="display:flex;align-items:center;gap:4px;font-size:12px;background:#f3f4f6;padding:5px 10px;border-radius:15px;cursor:pointer;">
                    <input type="checkbox" id="live-filter-status" checked onchange="updateLiveFilters()"> ğŸ“± Status
                </label>
                <label style="display:flex;align-items:center;gap:4px;font-size:12px;background:#f3f4f6;padding:5px 10px;border-radius:15px;cursor:pointer;">
                    <input type="checkbox" id="live-filter-gps" onchange="updateLiveFilters()"> ğŸ“ GPS
                </label>
                <label style="display:flex;align-items:center;gap:4px;font-size:12px;background:#f3f4f6;padding:5px 10px;border-radius:15px;cursor:pointer;">
                    <input type="checkbox" id="live-filter-system" checked onchange="updateLiveFilters()"> âš™ï¸ System
                </label>
            </div>
        </div>
        
        <!-- ğŸ†• v5.28.0: ANTI-BETRUGS-ALARME -->
        <div id="antifraud-alert-badge" onclick="toggleAdminSection('antifraud')" style="background:linear-gradient(135deg,#dc2626,#991b1b);color:white;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:none;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸš¨ Anti-Betrugs-Alarme <span id="antifraud-alert-count" style="background:white;color:#dc2626;padding:2px 8px;border-radius:10px;font-size:12px;margin-left:8px;">0</span></span>
            <span id="antifraud-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="antifraud-content" style="display:none;margin-bottom:20px;">
            <div style="padding:15px;background:#fef2f2;border-radius:8px;margin-bottom:15px;">
                <div style="font-weight:600;margin-bottom:8px;color:#991b1b;">âš ï¸ VerdÃ¤chtige Ã–PNV-Mehrfach-Abrechnungen</div>
                <div style="font-size:13px;color:#7f1d1d;">
                    Diese Fahrten kÃ¶nnten Mehrfach-Abrechnungen derselben Fahrt sein.<br>
                    PrÃ¼fen Sie ob es sich um verschiedene Personen oder um Betrug handelt.
                </div>
            </div>
            
            <!-- Buttons -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px;">
                <button onclick="loadAntiFraudAlerts()" style="padding:10px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ”„ Aktualisieren
                </button>
                <button onclick="clearResolvedAlerts()" style="padding:10px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ—‘ï¸ Erledigte lÃ¶schen
                </button>
            </div>
            
            <!-- Alarm-Liste -->
            <div id="antifraud-alerts-list" style="background:#fff;border-radius:8px;border:1px solid #e5e7eb;max-height:400px;overflow-y:auto;">
                <div style="padding:20px;text-align:center;color:#999;">Keine Alarme vorhanden</div>
            </div>
        </div>
        
        <!-- ğŸ“œ NEU: AKTIVITÃ„TS-PROTOKOLL -->
        <div onclick="toggleAdminSection('activitylog')" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ“œ AktivitÃ¤ts-Protokoll</span>
            <span id="activitylog-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="activitylog-content" style="display:none;margin-bottom:20px;">
            <!-- Filter -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
                <select id="log-filter-type" onchange="filterActivityLog()" style="padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                    <option value="all">Alle AktivitÃ¤ten</option>
                    <option value="booking">ğŸ“± Buchungen</option>
                    <option value="driver">ğŸš— Fahrer</option>
                    <option value="assignment">ğŸ¯ Vermittlung</option>
                    <option value="status">ğŸ“± Status</option>
                    <option value="deleted">ğŸ—‘ï¸ GelÃ¶scht</option>
                    <option value="gps">ğŸ“ GPS</option>
                </select>
                <select id="log-filter-time" onchange="filterActivityLog()" style="padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                    <option value="today">Heute</option>
                    <option value="yesterday">Gestern</option>
                    <option value="week">Diese Woche</option>
                    <option value="all">Alle</option>
                </select>
            </div>
            
            <!-- Live-Statistik -->
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:15px;">
                <div style="background:#dbeafe;padding:10px;border-radius:8px;text-align:center;">
                    <div style="font-size:20px;font-weight:bold;color:#1d4ed8;" id="log-stat-bookings">0</div>
                    <div style="font-size:11px;color:#666;">Buchungen</div>
                </div>
                <div style="background:#dcfce7;padding:10px;border-radius:8px;text-align:center;">
                    <div style="font-size:20px;font-weight:bold;color:#16a34a;" id="log-stat-completed">0</div>
                    <div style="font-size:11px;color:#666;">Abgeschlossen</div>
                </div>
                <div style="background:#fef3c7;padding:10px;border-radius:8px;text-align:center;">
                    <div style="font-size:20px;font-weight:bold;color:#d97706;" id="log-stat-online">0</div>
                    <div style="font-size:11px;color:#666;">Fahrer Online</div>
                </div>
                <div style="background:#fee2e2;padding:10px;border-radius:8px;text-align:center;">
                    <div style="font-size:20px;font-weight:bold;color:#dc2626;" id="log-stat-deleted">0</div>
                    <div style="font-size:11px;color:#666;">GelÃ¶scht</div>
                </div>
            </div>
            
            <!-- Protokoll-Liste -->
            <div id="activity-log-list" style="max-height:400px;overflow-y:auto;background:#f9fafb;border-radius:8px;padding:10px;">
                <p style="text-align:center;color:#999;">Protokoll wird geladen...</p>
            </div>
            
            <!-- Buttons -->
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px;">
                <button onclick="loadActivityLog()" style="padding:12px;background:#f59e0b;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ”„ Aktualisieren
                </button>
                <button onclick="exportActivityLog()" style="padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ“¥ Exportieren
                </button>
                <button onclick="clearActivityLog()" style="padding:12px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ—‘ï¸ Leeren
                </button>
            </div>
        </div>
        
        <!-- ğŸ—‘ï¸ NEU: GELÃ–SCHTE FAHRTEN -->
        <div onclick="toggleAdminSection('deleted')" style="background:linear-gradient(135deg,#ef4444,#dc2626);color:white;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ—‘ï¸ GelÃ¶schte Fahrten</span>
            <span id="deleted-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="deleted-content" style="display:none;margin-bottom:20px;">
            <div style="margin-bottom:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <select id="deleted-filter-time" onchange="loadDeletedRides()" style="padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                    <option value="today">Heute</option>
                    <option value="yesterday">Gestern</option>
                    <option value="week">Diese Woche</option>
                    <option value="all">Alle</option>
                </select>
                <button onclick="loadDeletedRides()" style="padding:10px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ”„ Aktualisieren
                </button>
            </div>
            <div id="deleted-rides-list" style="max-height:400px;overflow-y:auto;background:#f9fafb;border-radius:8px;padding:10px;">
                <p style="text-align:center;color:#999;">Klicke auf "Aktualisieren" um gelÃ¶schte Fahrten zu laden</p>
            </div>
        </div>
        
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- ğŸ†• v5.90.126: KATEGORIE 1 - VERWALTUNG -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div onclick="toggleAdminSection('cat-management')" style="background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;padding:18px;border-radius:12px;cursor:pointer;margin:30px 0 15px 0;display:flex;justify-content:space-between;align-items:center;box-shadow:0 6px 16px rgba(59,130,246,0.3);">
            <div style="display:flex;align-items:center;gap:15px;">
                <span style="font-size:32px;">ğŸ“±</span>
                <div>
                    <div style="font-weight:700;font-size:18px;">VERWALTUNG</div>
                    <div style="font-size:13px;opacity:0.9;">Kunden, Fahrzeuge & Benutzer</div>
                </div>
            </div>
            <span id="cat-management-toggle" style="font-size:28px;">â–¼</span>
        </div>
        <div id="cat-management-content" style="display:block;padding:0 10px;">
        
        <!-- ğŸ” NEU: BENUTZER-VERWALTUNG -->
        <div onclick="toggleAdminSection('users')" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ‘¥ Benutzer-Verwaltung</span>
            <span id="users-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="users-content" style="display:none;margin-bottom:20px;">
            <div style="margin-bottom:15px;">
                <input type="text" id="user-search" placeholder="ğŸ” Benutzer suchen..." oninput="searchUsers()" onpaste="setTimeout(searchUsers, 100)" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
            </div>
            <div id="users-list" style="max-height:300px;overflow-y:auto;"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
                <button onclick="loadAllUsers()" style="padding:12px;background:#667eea;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ”„ Benutzer laden
                </button>
                <button onclick="showAddUserModal()" style="padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    â• Neuer Mitarbeiter
                </button>
            </div>
        </div>
        
        <!-- ğŸš— NEU: FAHRZEUG-VERWALTUNG -->
        <div onclick="toggleAdminSection('vehicles')" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸš— Fahrzeug-Verwaltung</span>
            <span id="vehicles-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="vehicles-content" style="display:none;margin-bottom:20px;">
            <div id="vehicles-list" style="margin-bottom:15px;"></div>
            <button onclick="showAddVehicleModal()" style="width:100%;padding:12px;background:#f59e0b;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                â• Neues Fahrzeug hinzufÃ¼gen
            </button>
        </div>
        
        <!-- ğŸ“‹ CRM-SECTION - NUR FÃœR ADMIN! v5.56.0 -->
        <div id="crm-section" style="display:none;">
        <!-- ğŸ“‹ NEU: STAMMKUNDEN-CRM -->
        <div onclick="toggleAdminSection('customers')" style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ“‹ Stammkunden-CRM</span>
            <span id="customers-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="customers-content" style="display:none;margin-bottom:20px;">
            <!-- ğŸ”€ Tab-Auswahl: Stammkunden vs App-User -->
            <div style="display:flex;margin-bottom:15px;border-radius:8px;overflow:hidden;border:2px solid #e0e0e0;">
                <button id="crm-tab-customers" onclick="switchCrmTab('customers')" style="flex:1;padding:10px;border:none;background:#10b981;color:white;font-weight:600;cursor:pointer;">
                    ğŸ“‹ Stammkunden
                </button>
                <button id="crm-tab-users" onclick="switchCrmTab('users')" style="flex:1;padding:10px;border:none;background:#f3f4f6;color:#333;font-weight:600;cursor:pointer;">
                    ğŸ“± App-User
                </button>
            </div>
            
            <div style="margin-bottom:15px;">
                <input type="text" id="customer-search" placeholder="ğŸ” Kunde suchen (Name, Email, Telefon)..." oninput="searchCustomers()" onpaste="setTimeout(searchCustomers, 100)" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
            </div>
            <div id="customers-list" style="max-height:400px;overflow-y:auto;"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
                <button onclick="loadAllCustomers()" style="padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ”„ Kunden laden
                </button>
                <button onclick="showAddCustomerModal()" style="padding:12px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    â• Neuer Kunde
                </button>
            </div>
            <!-- ğŸ†• v5.55.0: Kontakte importieren -->
            <div style="margin-top:10px;">
                <button onclick="importContactsToCRM()" style="
                    width:100%;
                    padding:12px;
                    background:linear-gradient(135deg, #10b981 0%, #059669 100%);
                    color:white;
                    border:none;
                    border-radius:8px;
                    font-weight:600;
                    cursor:pointer;
                    box-shadow:0 2px 8px rgba(16, 185, 129, 0.3);
                    transition:transform 0.2s;
                " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                    ğŸ“± Kontakte aus Telefon importieren
                </button>
            </div>
            <!-- ğŸ†• v5.90.125: ALLE KUNDEN ALS VCF EXPORTIEREN! -->
            <div style="margin-top:10px;">
                <button onclick="exportAllCustomersToVCF()" style="
                    width:100%;
                    padding:12px;
                    background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                    color:white;
                    border:none;
                    border-radius:8px;
                    font-weight:600;
                    cursor:pointer;
                    box-shadow:0 2px 8px rgba(245, 158, 11, 0.3);
                    transition:transform 0.2s;
                " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                    ğŸ“± Alle zu Kontakten exportieren
                </button>
                <div style="font-size:12px;color:#6b7280;margin-top:4px;text-align:center;">
                    Alle Kunden als .vcf Datei herunterladen
                </div>
            </div>
            <div style="margin-top:10px;">
                <label for="csv-import" style="display:block;padding:12px;background:#8b5cf6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;text-align:center;">
                    ğŸ“¥ Google Kontakte importieren (CSV)
                </label>
                <input type="file" id="csv-import" accept=".csv" onchange="importGoogleCSV(this)" style="display:none;">
            </div>
            <div style="margin-top:10px;">
                <button onclick="deleteAllCustomers()" style="width:100%;padding:12px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ—‘ï¸ Alle Kunden lÃ¶schen
                </button>
            </div>
        </div>
        <!-- END: CRM-SECTION -->
        </div>
        
        </div><!-- Ende VERWALTUNG -->
        
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- ğŸ†• v5.90.126: KATEGORIE 2 - ERWEITERT -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div onclick="toggleAdminSection('cat-advanced')" style="background:linear-gradient(135deg,#6b7280,#4b5563);color:white;padding:18px;border-radius:12px;cursor:pointer;margin:30px 0 15px 0;display:flex;justify-content:space-between;align-items:center;box-shadow:0 6px 16px rgba(107,114,128,0.3);">
            <div style="display:flex;align-items:center;gap:15px;">
                <span style="font-size:32px;">ğŸ› ï¸</span>
                <div>
                    <div style="font-weight:700;font-size:18px;">ERWEITERT</div>
                    <div style="font-size:13px;opacity:0.9;">Tools, Logs & Weitere Funktionen</div>
                </div>
            </div>
            <span id="cat-advanced-toggle" style="font-size:28px;">â–¼</span>
        </div>
        <div id="cat-advanced-content" style="display:none;padding:0 10px;">
        
        <!-- COLLAPSIBLE: Controls -->
        <div onclick="toggleAdminSection('controls')" style="background:#f3f4f6;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">âš™ï¸ Admin Controls</span>
            <span id="controls-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="controls-content" style="display:none;margin-bottom:20px;">
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px;">
                <button onclick="clearAppCache()" style="padding:15px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                    ğŸ§¹ Cache leeren
                </button>
                <button onclick="exportDebugLogs()" style="padding:15px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                    ğŸ“‹ Logs kopieren
                </button>
                <button onclick="exportSuperDebug()" style="padding:15px;background:#8b5cf6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                    ğŸ› Super Debug
                </button>
            </div>
            <div style="display:grid;grid-template-columns:1fr;gap:10px;">
                <button onclick="resetDatabase()" style="padding:15px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                    ğŸ—‘ï¸ Datenbank lÃ¶schen
                </button>
            </div>
        </div>
        
        <!-- Stats - immer sichtbar -->
        <div class="stats-grid">
            <div class="stat-card"><div style="font-size: 28px;" id="a-total">0</div><div>Fahrten</div></div>
            <div class="stat-card"><div style="font-size: 28px;" id="a-revenue">0â‚¬</div><div>Umsatz</div></div>
            <div class="stat-card"><div style="font-size: 28px;" id="a-pending">0</div><div>Offen</div></div>
            <div class="stat-card"><div style="font-size: 28px;" id="a-active">0</div><div>Aktiv</div></div>
        </div>
        
        <!-- ğŸ†• v5.90.126: QUICK ACTIONS -->
        <div style="background:white;padding:20px;border-radius:12px;margin-bottom:20px;border:2px solid #667eea;box-shadow:0 4px 12px rgba(102,126,234,0.15);">
            <div style="font-weight:700;font-size:16px;margin-bottom:15px;color:#4c51bf;display:flex;align-items:center;gap:8px;">
                âš¡ Quick Actions
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
                <button onclick="openQuickBookingFromAdmin()" style="padding:15px;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;box-shadow:0 2px 8px rgba(16,185,129,0.3);display:flex;flex-direction:column;align-items:center;gap:8px;">
                    <span style="font-size:24px;">ğŸš•</span>
                    <span>Schnellbuchung</span>
                </button>
                <button onclick="loadAllCustomers()" style="padding:15px;background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;box-shadow:0 2px 8px rgba(59,130,246,0.3);display:flex;flex-direction:column;align-items:center;gap:8px;">
                    <span style="font-size:24px;">ğŸ‘¥</span>
                    <span>Kunden laden</span>
                </button>
                <button onclick="navigateToTab('calendar')" style="padding:15px;background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;box-shadow:0 2px 8px rgba(139,92,246,0.3);display:flex;flex-direction:column;align-items:center;gap:8px;">
                    <span style="font-size:24px;">ğŸ“…</span>
                    <span>Kalender</span>
                </button>
            </div>
        </div>
        
        <!-- ğŸ†• v5.31.5: DEZENTE BENACHRICHTIGUNG fÃ¼r neue Fahrten -->
        <div id="admin-notification-bar" style="display:none;background:linear-gradient(135deg,#dc2626,#ef4444);color:white;padding:15px;border-radius:12px;margin:15px 0;box-shadow:0 4px 12px rgba(220,38,38,0.3);">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div style="flex:1;">
                    <div style="font-size:18px;font-weight:700;margin-bottom:5px;">
                        ğŸš• <span id="notification-ride-count">0</span> neue Fahrt(en)!
                    </div>
                    <div style="font-size:14px;opacity:0.9;">
                        Bitte Fahrer zuweisen
                    </div>
                </div>
                <button onclick="scrollToOpenRides()" 
                    style="padding:10px 20px;background:white;color:#dc2626;border:none;border-radius:8px;font-weight:700;cursor:pointer;white-space:nowrap;">
                    ğŸ‘‰ Zuweisen
                </button>
            </div>
        </div>
        
        <!-- ğŸ†• v5.31.5: ALARM EINSTELLUNGEN -->
        <div style="background:#f9fafb;border:2px solid #e5e7eb;padding:15px;border-radius:12px;margin:15px 0;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <div style="font-weight:600;font-size:15px;">ğŸ”” Alarm-Einstellungen</div>
            </div>
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px;background:white;border-radius:8px;border:2px solid #e5e7eb;">
                <input type="checkbox" id="disable-admin-alarm" onchange="toggleAdminAlarm()" 
                    style="width:20px;height:20px;cursor:pointer;">
                <div>
                    <div style="font-weight:600;font-size:14px;color:#1f2937;">Alarm-Modal deaktivieren</div>
                    <div style="font-size:12px;color:#6b7280;margin-top:2px;">Keine Pop-ups & Sound (nur dezente Benachrichtigung oben)</div>
                </div>
            </label>
        </div>
        
        <!-- ğŸ†• v5.32.5h: AUTO-BOOKING EINSTELLUNGEN -->
        <div style="background:#f9fafb;border:2px solid #e5e7eb;padding:15px;border-radius:12px;margin:15px 0;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <div style="font-weight:600;font-size:15px;">ğŸ¤– Auto-Booking</div>
            </div>
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px;background:white;border-radius:8px;border:2px solid #e5e7eb;">
                <input type="checkbox" id="enable-auto-booking" onchange="toggleAutoBooking()" 
                    style="width:20px;height:20px;cursor:pointer;">
                <div>
                    <div style="font-weight:600;font-size:14px;color:#1f2937;">Auto-Booking aktivieren</div>
                    <div style="font-size:12px;color:#6b7280;margin-top:2px;">
                        System schlÃ¤gt bei belegten Zeiten automatisch Alternativen vor
                    </div>
                </div>
            </label>
            <div id="auto-booking-status" style="margin-top:10px;padding:8px;border-radius:6px;font-size:13px;text-align:center;"></div>
        </div>
        
        <!-- ğŸ†• v5.33.2: ZEITSLOT-EINSTELLUNGEN -->
        <div style="background:#f9fafb;border:2px solid #e5e7eb;padding:15px;border-radius:12px;margin:15px 0;">
            <div style="font-weight:600;font-size:15px;margin-bottom:15px;display:flex;align-items:center;gap:8px;">
                â° Zeitslot-Einstellungen
                <span style="font-size:11px;background:#dbeafe;color:#1e40af;padding:2px 8px;border-radius:4px;font-weight:600;">NEU!</span>
            </div>
            
            <div style="background:white;padding:15px;border-radius:8px;border:1px solid #e5e7eb;">
                <p style="font-size:13px;color:#6b7280;margin:0 0 15px 0;">
                    Passe die Zeitpuffer an, um zu steuern wie eng Fahrten hintereinander gebucht werden kÃ¶nnen.
                </p>
                
                <!-- Fahrtdauer Fallback -->
                <div style="margin-bottom:20px;">
                    <label style="display:block;font-weight:600;font-size:13px;color:#1f2937;margin-bottom:8px;">
                        ğŸ“ Standard-Fahrtdauer
                    </label>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <input type="range" id="ride-duration-slider" min="5" max="30" value="10" 
                            oninput="updateTimeslotSettings()" 
                            style="flex:1;height:6px;border-radius:3px;cursor:pointer;">
                        <span id="ride-duration-value" style="font-weight:600;color:#667eea;min-width:50px;text-align:right;">10 Min</span>
                    </div>
                    <div style="font-size:11px;color:#9ca3af;margin-top:4px;">
                        âš ï¸ Notfall-Wert: Wird nur verwendet wenn Route nicht berechnet werden kann (z.B. OSRM offline)
                    </div>
                </div>
                
                <!-- Anfahrtszeit Fallback -->
                <div style="margin-bottom:20px;">
                    <label style="display:block;font-weight:600;font-size:13px;color:#1f2937;margin-bottom:8px;">
                        ğŸš— Standard-Fahrzeit zwischen Fahrten
                    </label>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <input type="range" id="travel-time-slider" min="2" max="20" value="5" 
                            oninput="updateTimeslotSettings()" 
                            style="flex:1;height:6px;border-radius:3px;cursor:pointer;">
                        <span id="travel-time-value" style="font-weight:600;color:#667eea;min-width:50px;text-align:right;">5 Min</span>
                    </div>
                    <div style="font-size:11px;color:#9ca3af;margin-top:4px;">
                        âš ï¸ Notfall-Wert: Zeit die das Taxi vom Ziel einer Fahrt zum Start der nÃ¤chsten braucht (wenn Entfernung unbekannt)
                    </div>
                </div>
                
                <!-- Zeitpuffer -->
                <div style="margin-bottom:20px;">
                    <label style="display:block;font-weight:600;font-size:13px;color:#1f2937;margin-bottom:8px;">
                        â±ï¸ Sicherheits-Puffer
                    </label>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <input type="range" id="buffer-time-slider" min="0" max="15" value="3" 
                            oninput="updateTimeslotSettings()" 
                            style="flex:1;height:6px;border-radius:3px;cursor:pointer;">
                        <span id="buffer-time-value" style="font-weight:600;color:#667eea;min-width:50px;text-align:right;">3 Min</span>
                    </div>
                    <div style="font-size:11px;color:#9ca3af;margin-top:4px;">
                        Extra Zeit fÃ¼r VerzÃ¶gerungen, Tankstopps, etc.
                    </div>
                </div>
                
                <!-- ğŸ†• v5.90.528: EINSTEIGEN -->
                <div style="margin-bottom:20px;">
                    <label style="display:block;font-weight:600;font-size:13px;color:#1f2937;margin-bottom:8px;">
                        ğŸšª Einsteigen (Start)
                    </label>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <input type="range" id="boarding-time-slider" min="1" max="10" value="3" 
                            oninput="updateTimeslotSettings()" 
                            style="flex:1;height:6px;border-radius:3px;cursor:pointer;">
                        <span id="boarding-time-value" style="font-weight:600;color:#667eea;min-width:50px;text-align:right;">3 Min</span>
                    </div>
                    <div style="font-size:11px;color:#9ca3af;margin-top:4px;">
                        Zeit fÃ¼r Einsteigen, Kofferraum packen, etc.
                    </div>
                </div>
                
                <!-- ğŸ†• v5.90.528: AUSSTEIGEN -->
                <div style="margin-bottom:20px;">
                    <label style="display:block;font-weight:600;font-size:13px;color:#1f2937;margin-bottom:8px;">
                        ğŸ Aussteigen (Ziel)
                    </label>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <input type="range" id="alighting-time-slider" min="1" max="10" value="2" 
                            oninput="updateTimeslotSettings()" 
                            style="flex:1;height:6px;border-radius:3px;cursor:pointer;">
                        <span id="alighting-time-value" style="font-weight:600;color:#667eea;min-width:50px;text-align:right;">2 Min</span>
                    </div>
                    <div style="font-size:11px;color:#9ca3af;margin-top:4px;">
                        Zeit fÃ¼r Aussteigen, Bezahlung, etc.
                    </div>
                </div>
                
                <!-- ğŸ†• v5.90.528: WAYPOINT-STOPP -->
                <div style="margin-bottom:20px;">
                    <label style="display:block;font-weight:600;font-size:13px;color:#1f2937;margin-bottom:8px;">
                        ğŸ›‘ Waypoint-Stopp
                    </label>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <input type="range" id="waypoint-stop-slider" min="1" max="15" value="5" 
                            oninput="updateTimeslotSettings()" 
                            style="flex:1;height:6px;border-radius:3px;cursor:pointer;">
                        <span id="waypoint-stop-value" style="font-weight:600;color:#667eea;min-width:50px;text-align:right;">5 Min</span>
                    </div>
                    <div style="font-size:11px;color:#9ca3af;margin-top:4px;">
                        Wartezeit pro Zwischenstopp (z.B. Einkauf, Passagier abholen)
                    </div>
                </div>
                
                <!-- Total Buffer Anzeige -->
                <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;padding:12px;border-radius:8px;text-align:center;margin-bottom:15px;">
                    <div style="font-size:12px;opacity:0.9;margin-bottom:2px;">ğŸ“± Total Buffer zwischen Fahrten:</div>
                    <div id="total-buffer-display" style="font-size:24px;font-weight:700;">18 Min</div>
                    <div style="font-size:11px;opacity:0.8;margin-top:4px;">
                        = Fahrtdauer + Anfahrtszeit + Puffer
                    </div>
                </div>
                
                <!-- Admin Override Toggle -->
                <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px;background:#fef3c7;border-radius:8px;border:2px solid #fbbf24;margin-bottom:15px;">
                    <input type="checkbox" id="admin-override-enabled" onchange="updateTimeslotSettings()" 
                        style="width:20px;height:20px;cursor:pointer;">
                    <div>
                        <div style="font-weight:600;font-size:13px;color:#92400e;">
                            ğŸ¯ Admin-Override aktivieren
                        </div>
                        <div style="font-size:11px;color:#78350f;margin-top:2px;">
                            Als Admin kannst du Zeitslot-Checks ignorieren und trotzdem buchen
                        </div>
                    </div>
                </label>
                
                <!-- Speichern Button -->
                <button onclick="saveTimeslotSettings()" style="
                    width:100%;
                    padding:12px;
                    background:#10b981;
                    color:white;
                    border:none;
                    border-radius:8px;
                    font-weight:600;
                    cursor:pointer;
                    font-size:14px;
                ">
                    ğŸ’¾ Einstellungen speichern
                </button>
                
                <div id="timeslot-save-status" style="margin-top:8px;text-align:center;font-size:12px;"></div>
            </div>
        </div>
        
        <!-- ğŸ†• v5.90.132: SYSTEM-VERWALTUNG -->
        <div style="background:#fef3c7;border:2px solid #fbbf24;padding:15px;border-radius:12px;margin:15px 0;">
            <div style="font-weight:600;font-size:15px;margin-bottom:15px;display:flex;align-items:center;gap:8px;">
                ğŸ”§ System-Verwaltung
                <span style="font-size:11px;background:#dc2626;color:white;padding:2px 8px;border-radius:4px;font-weight:600;">ADMIN</span>
            </div>
            
            <div style="background:white;padding:15px;border-radius:8px;border:1px solid #fbbf24;margin-bottom:10px;">
                <div style="font-weight:600;font-size:14px;color:#92400e;margin-bottom:5px;">
                    ğŸ’¾ Telefonnummern normalisieren
                </div>
                <div style="font-size:12px;color:#78350f;margin-bottom:10px;">
                    Alle Mobilnummern auf einheitliches Format "+49..." umstellen
                </div>
                <button onclick="normalizePhoneNumbers()" style="
                    width:100%;
                    padding:12px;
                    background:#f59e0b;
                    color:white;
                    border:none;
                    border-radius:8px;
                    font-weight:600;
                    cursor:pointer;
                    font-size:14px;
                ">
                    ğŸ”„ Jetzt normalisieren
                </button>
                <div id="normalize-status" style="margin-top:8px;text-align:center;font-size:12px;"></div>
            </div>
        </div>
        
        <!-- ğŸ†• v5.34.0: SCHNELLBUCHUNG BUTTON -->
        <button onclick="openQuickBookingModal()" style="
            width:100%;
            padding:15px;
            background:linear-gradient(135deg, #10b981 0%, #059669 100%);
            color:white;
            border:none;
            border-radius:12px;
            font-weight:700;
            font-size:16px;
            cursor:pointer;
            margin-bottom:15px;
            box-shadow:0 4px 6px rgba(16, 185, 129, 0.3);
            display:flex;
            align-items:center;
            justify-content:center;
            gap:10px;
        ">
            âš¡ Schnellbuchung fÃ¼r Kunde
        </button>
        
        <!-- COLLAPSIBLE: Online-Fahrer -->
        <div onclick="toggleAdminSection('drivers')" style="background:#f3f4f6;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸš— Online-Fahrer</span>
            <span id="drivers-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="drivers-content" style="display:none;">
            <div id="online-drivers-list" style="margin-bottom:20px;"></div>
        </div>
        
        <!-- COLLAPSIBLE: Offene Fahrten -->
        <div onclick="toggleAdminSection('open')" style="background:#f3f4f6;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ“‹ Offene Fahrten</span>
            <span id="open-toggle" style="font-size:20px;">â–²</span>
        </div>
        <div id="open-content" style="display:block;">
            <div id="upcoming-rides-admin" style="margin-bottom: 20px;"></div>
        </div>
        
        <!-- ğŸ†• v5.49.0: COLLAPSIBLE: Abgelaufene Fahrten -->
        <div onclick="toggleAdminSection('expired')" style="background:#f3f4f6;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">â° Abgelaufene Fahrten</span>
            <span id="expired-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="expired-content" style="display:none;">
            <div id="expired-rides-admin" style="margin-bottom: 20px;"></div>
        </div>
        
        <!-- COLLAPSIBLE: Abgelehnte Fahrten -->
        <div onclick="toggleAdminSection('rejected')" style="background:#f3f4f6;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ’¾ Abgelehnte Fahrten</span>
            <span id="rejected-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="rejected-content" style="display:none;">
            <div id="rejected-rides-admin" style="margin-bottom: 20px;"></div>
        </div>
        
        <!-- COLLAPSIBLE: Abgeschlossene Fahrten -->
        <div onclick="toggleAdminSection('completed')" style="background:#f3f4f6;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">âœ… Abgeschlossene Fahrten</span>
            <span id="completed-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="completed-content" style="display:none;">
            <div id="all-rides"></div>
        </div>
        
        <!-- COLLAPSIBLE: Stornierungen -->
        <div onclick="toggleAdminSection('cancelled')" style="background:#f3f4f6;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ’¶ Stornierungen</span>
            <span id="cancelled-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="cancelled-content" style="display:none;">
            <div id="cancellations-list"></div>
        </div>
        
        <!-- ğŸ“… NEU: VORBESTELLUNGEN mit ICS Export -->
        <div onclick="toggleAdminSection('prebookings')" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ“… Vorbestellungen</span>
            <span id="prebookings-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="prebookings-content" style="display:none;margin-bottom:20px;padding:15px;background:#fff;border-radius:8px;border:1px solid #e5e7eb;">
            <button onclick="exportPrebookingsToICS()" style="width:100%;padding:15px;background:#8b5cf6;color:white;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;margin-bottom:15px;box-shadow:0 4px 12px rgba(139,92,246,0.3);">
                ğŸ“… Als Kalender exportieren (.ics)
            </button>
            <div id="prebookings-list" style="max-height:400px;overflow-y:auto;"></div>
        </div>
        
        <!-- ğŸ†• v5.64.45: KALENDER-EXPORT EINSTELLUNGEN -->
        <div onclick="toggleAdminSection('calendar-settings')" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">âš™ï¸ Kalender-Export Einstellungen</span>
            <span id="calendar-settings-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="calendar-settings-content" style="display:none;margin-bottom:20px;padding:15px;background:#fff;border-radius:8px;border:1px solid #e5e7eb;">
            <div style="background:#f0f9ff;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #3b82f6;">
                <div style="font-weight:600;margin-bottom:8px;color:#1e40af;">ğŸ“… Was soll in Google Calendar angezeigt werden?</div>
                <div style="font-size:13px;color:#1e40af;">Diese Einstellungen gelten fÃ¼r manuelle Exports UND automatische Synchronisation!</div>
            </div>
            
            <div style="display:grid;gap:12px;">
                <label style="display:flex;align-items:center;padding:12px;background:#f9fafb;border-radius:8px;cursor:pointer;border:2px solid #e5e7eb;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='#f9fafb'">
                    <input type="checkbox" id="cal-setting-customer-name" checked style="width:20px;height:20px;cursor:pointer;margin-right:12px;">
                    <span style="font-size:14px;font-weight:600;">ğŸ’¾ Kundenname anzeigen</span>
                </label>
                
                <label style="display:flex;align-items:center;padding:12px;background:#e0f2fe;border-radius:8px;cursor:pointer;border:2px solid #0ea5e9;" onmouseover="this.style.background='#bae6fd'" onmouseout="this.style.background='#e0f2fe'">
                    <input type="checkbox" id="cal-setting-guest-name" checked style="width:20px;height:20px;cursor:pointer;margin-right:12px;">
                    <span style="font-size:14px;font-weight:600;">ğŸ§³ Gastname anzeigen (Hotel-Buchungen)</span>
                </label>
                
                <label style="display:flex;align-items:center;padding:12px;background:#e0f2fe;border-radius:8px;cursor:pointer;border:2px solid #0ea5e9;" onmouseover="this.style.background='#bae6fd'" onmouseout="this.style.background='#e0f2fe'">
                    <input type="checkbox" id="cal-setting-guest-phone" checked style="width:20px;height:20px;cursor:pointer;margin-right:12px;">
                    <span style="font-size:14px;font-weight:600;">ğŸ“± Gast-Telefon anzeigen</span>
                </label>
                
                <label style="display:flex;align-items:center;padding:12px;background:#f9fafb;border-radius:8px;cursor:pointer;border:2px solid #e5e7eb;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='#f9fafb'">
                    <input type="checkbox" id="cal-setting-phone" checked style="width:20px;height:20px;cursor:pointer;margin-right:12px;">
                    <span style="font-size:14px;font-weight:600;">ğŸ“± Telefonnummer anzeigen</span>
                </label>
                
                <label style="display:flex;align-items:center;padding:12px;background:#f9fafb;border-radius:8px;cursor:pointer;border:2px solid #e5e7eb;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='#f9fafb'">
                    <input type="checkbox" id="cal-setting-pickup" checked style="width:20px;height:20px;cursor:pointer;margin-right:12px;">
                    <span style="font-size:14px;font-weight:600;">ğŸ“ Abholort anzeigen</span>
                </label>
                
                <label style="display:flex;align-items:center;padding:12px;background:#f9fafb;border-radius:8px;cursor:pointer;border:2px solid #e5e7eb;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='#f9fafb'">
                    <input type="checkbox" id="cal-setting-destination" checked style="width:20px;height:20px;cursor:pointer;margin-right:12px;">
                    <span style="font-size:14px;font-weight:600;">ğŸ¯ Zielort anzeigen</span>
                </label>
                
                <label style="display:flex;align-items:center;padding:12px;background:#f9fafb;border-radius:8px;cursor:pointer;border:2px solid #e5e7eb;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='#f9fafb'">
                    <input type="checkbox" id="cal-setting-passengers" checked style="width:20px;height:20px;cursor:pointer;margin-right:12px;">
                    <span style="font-size:14px;font-weight:600;">ğŸ‘¥ Passagieranzahl anzeigen</span>
                </label>
                
                <label style="display:flex;align-items:center;padding:12px;background:#fff3cd;border-radius:8px;cursor:pointer;border:2px solid #fbbf24;" onmouseover="this.style.background='#fef3c7'" onmouseout="this.style.background='#fff3cd'">
                    <input type="checkbox" id="cal-setting-price" checked style="width:20px;height:20px;cursor:pointer;margin-right:12px;">
                    <span style="font-size:14px;font-weight:600;">ğŸ’° Preis anzeigen</span>
                </label>
                
                <label style="display:flex;align-items:center;padding:12px;background:#fff3cd;border-radius:8px;cursor:pointer;border:2px solid #fbbf24;" onmouseover="this.style.background='#fef3c7'" onmouseout="this.style.background='#fff3cd'">
                    <input type="checkbox" id="cal-setting-distance" checked style="width:20px;height:20px;cursor:pointer;margin-right:12px;">
                    <span style="font-size:14px;font-weight:600;">ğŸ“ Distanz anzeigen</span>
                </label>
                
                <label style="display:flex;align-items:center;padding:12px;background:#f9fafb;border-radius:8px;cursor:pointer;border:2px solid #e5e7eb;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='#f9fafb'">
                    <input type="checkbox" id="cal-setting-vehicle" checked style="width:20px;height:20px;cursor:pointer;margin-right:12px;">
                    <span style="font-size:14px;font-weight:600;">ğŸš— Fahrzeug anzeigen</span>
                </label>
                
                <label style="display:flex;align-items:center;padding:12px;background:#f9fafb;border-radius:8px;cursor:pointer;border:2px solid #e5e7eb;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='#f9fafb'">
                    <input type="checkbox" id="cal-setting-notes" checked style="width:20px;height:20px;cursor:pointer;margin-right:12px;">
                    <span style="font-size:14px;font-weight:600;">ğŸ“ Notizen anzeigen</span>
                </label>
                
                <!-- ğŸ†• v5.90.44: MAP-NULL-CHECK-FIX-LINKS IN CALENDAR -->
                <label style="display:flex;align-items:center;padding:12px;background:#dcfce7;border-radius:8px;cursor:pointer;border:2px solid #10b981;" onmouseover="this.style.background='#bbf7d0'" onmouseout="this.style.background='#dcfce7'">
                    <input type="checkbox" id="cal-setting-tracking-links" onchange="toggleCalendarTrackingLinks(this.checked)" style="width:20px;height:20px;cursor:pointer;margin-right:12px;">
                    <div style="flex:1;">
                        <div style="font-size:14px;font-weight:600;">ğŸ“ Tracking-Links (NEU!)</div>
                        <div style="font-size:11px;color:#059669;margin-top:2px;">FÃ¼r Hotel-Fahrten: Link zum Live-Tracking wird automatisch zum Google Calendar Event hinzugefÃ¼gt</div>
                    </div>
                </label>
                
                <label style="display:flex;align-items:center;padding:12px;background:#dcfce7;border-radius:8px;cursor:pointer;border:2px solid #10b981;" onmouseover="this.style.background='#bbf7d0'" onmouseout="this.style.background='#dcfce7'">
                    <input type="checkbox" id="cal-setting-reminder" checked style="width:20px;height:20px;cursor:pointer;margin-right:12px;">
                    <span style="font-size:14px;font-weight:600;">â° Erinnerung 30 Min vorher</span>
                </label>
            </div>
            
            <button onclick="saveCalendarExportSettings()" style="width:100%;margin-top:20px;padding:15px;background:linear-gradient(135deg, #10b981 0%, #059669 100%);color:white;border:none;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(16, 185, 129, 0.3);">
                ğŸ’¾ Einstellungen speichern
            </button>
            
            <div style="margin-top:15px;padding:12px;background:#fef3c7;border-radius:8px;border-left:4px solid #f59e0b;">
                <div style="font-size:13px;color:#92400e;">
                    <div style="font-weight:600;margin-bottom:4px;">ğŸ’¡ Hinweis:</div>
                    Diese Einstellungen werden in Firebase gespeichert und gelten fÃ¼r:<br>
                    â€¢ Manuellen Kalender-Export aus der App<br>
                    â€¢ Automatische Google Calendar Synchronisation
                </div>
            </div>
            
            <div style="margin-top:10px;padding:12px;background:#e0f2fe;border-radius:8px;border-left:4px solid #0ea5e9;">
                <div style="font-size:13px;color:#0369a1;">
                    <div style="font-weight:600;margin-bottom:4px;">ğŸ“± Telefon im Titel:</div>
                    â€¢ <strong>Mobilnummern</strong> (015x, 016x, 017x) â†’ Im Titel sichtbar<br>
                    â€¢ <strong>Festnetz</strong> â†’ Nur in der Beschreibung (keine SMS mÃ¶glich)
                </div>
            </div>
        </div>
        
        <!-- ğŸ“± NEU: TELEGRAM-ALARME -->
        <div onclick="toggleAdminSection('telegram')" style="background:linear-gradient(135deg,#0088cc,#0077b3);color:white;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ“± Telegram-Alarme</span>
            <span id="telegram-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="telegram-content" style="display:none;margin-bottom:20px;padding:15px;background:#fff;border-radius:8px;border:1px solid #e5e7eb;">
            <!-- ğŸ†• v5.90.525: BOT TOKEN EINGABE -->
            <div style="background:#fef3c7;padding:15px;border-radius:8px;margin-bottom:15px;border:2px solid #f59e0b;">
                <div style="font-weight:600;margin-bottom:8px;color:#92400e;">ğŸ”‘ Telegram Bot Token</div>
                <div style="font-size:13px;color:#78350f;margin-bottom:10px;">
                    Token wird in Firebase gespeichert (NICHT in GitHub!)<br>
                    <a href="https://t.me/BotFather" target="_blank" style="color:#0088cc;">â†’ Neuen Bot erstellen bei @BotFather</a>
                </div>
                <div style="display:flex;gap:8px;">
                    <input type="text" id="telegram-bot-token-input" placeholder="123456:ABC-DEF1234..." 
                           style="flex:1;padding:10px;border:2px solid #f59e0b;border-radius:8px;font-family:monospace;font-size:12px;">
                    <button onclick="saveTelegramBotToken()" style="padding:10px 20px;background:#f59e0b;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                        ğŸ’¾ Speichern
                    </button>
                </div>
                <div id="telegram-token-status" style="margin-top:8px;font-size:12px;"></div>
            </div>
            
            <div style="background:#e0f2fe;padding:15px;border-radius:8px;margin-bottom:15px;">
                <div style="font-weight:600;margin-bottom:8px;color:#0369a1;">âœ… Funktioniert auch bei:</div>
                <div style="font-size:14px;color:#0c4a6e;line-height:1.8;">
                    â€¢ ğŸ“± Handy gesperrt<br>
                    â€¢ ğŸŒ™ App geschlossen<br>
                    â€¢ ğŸ”‡ Browser im Hintergrund<br>
                    â€¢ ğŸ“µ Keine Internet-Verbindung (Nachricht kommt spÃ¤ter)
                </div>
            </div>
            
            <button onclick="showTelegramActivation()" style="width:100%;padding:15px;background:#0088cc;color:white;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;margin-bottom:15px;box-shadow:0 4px 12px rgba(0,136,204,0.3);">
                ğŸ“± Telegram-Alarme aktivieren
            </button>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px;">
                <button onclick="sendTelegramTest()" style="padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;">
                    ğŸ§ª Test-Nachricht
                </button>
                <button onclick="updateTelegramStatus()" style="padding:12px;background:#f3f4f6;color:#333;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;">
                    ğŸ”„ Status
                </button>
            </div>
            
            <div id="telegram-status" style="margin-top:0;padding:12px;background:#f9fafb;border-radius:8px;font-size:13px;color:#666;">â³ Status wird geladen...</div>
        </div>
        
        <!-- ğŸ’° PREIS-STEUERUNG (SURGE PRICING) -->
        
        <!-- ğŸš Ã–PNV-TAXI SYSTEM -->
        <div onclick="toggleAdminSection('oepnv')" style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸš Ã–PNV-Taxi System</span>
            <span id="oepnv-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="oepnv-content" style="display:none;padding:15px;background:#fff;border-radius:8px;margin-bottom:20px;border:1px solid #e5e7eb;">
            
            <!-- AKTIVIERUNG -->
            <div style="margin-bottom:20px;padding:15px;background:#f0fdf4;border-radius:8px;">
                <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                    <input type="checkbox" id="oepnv-enabled" onchange="saveOEPNVSettings()" style="width:20px;height:20px;">
                    <div>
                        <div style="font-weight:600;font-size:16px;">ğŸš Ã–PNV-Taxi aktivieren</div>
                        <div style="font-size:12px;color:#666;margin-top:2px;">Fahrer kÃ¶nnen bei Fahrtannahme zwischen Normal und Ã–PNV wÃ¤hlen</div>
                    </div>
                </label>
            </div>
            
            <div id="oepnv-settings" style="display:none;">
                
                <!-- TAXI-ZUSCHLAG -->
                <div style="margin-bottom:20px;">
                    <div style="font-weight:600;font-size:14px;margin-bottom:8px;">ğŸ’° Taxi-Zuschlag (einmalig pro Fahrt)</div>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <input type="number" id="oepnv-surcharge" step="0.50" min="0" value="2.00" style="padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;width:100px;">
                        <span>â‚¬</span>
                    </div>
                    <div style="font-size:12px;color:#666;margin-top:5px;">Wird einmalig zum Busticket addiert (weil Taxi komfortabler als Bus)</div>
                </div>
                
                <!-- TARIFSTUFEN -->
                <div style="margin-bottom:20px;">
                    <div style="font-weight:600;font-size:14px;margin-bottom:10px;">ğŸ“± Busticket-Tarifstufen</div>
                    
                    <!-- Kurzstrecke -->
                    <div style="padding:12px;background:#f9fafb;border-radius:8px;margin-bottom:10px;">
                        <div style="font-weight:600;margin-bottom:8px;">Kurzstrecke (bis <input type="number" id="tarif-kurz-km" value="3" min="1" style="width:50px;padding:4px;border:1px solid #d1d5db;border-radius:4px;"> km)</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                            <div>
                                <label style="font-size:12px;color:#666;">Erwachsener</label>
                                <div style="display:flex;align-items:center;gap:5px;">
                                    <input type="number" id="tarif-kurz-erw" step="0.50" value="2.00" style="padding:8px;border:2px solid #e0e0e0;border-radius:6px;width:80px;">
                                    <span>â‚¬</span>
                                </div>
                            </div>
                            <div>
                                <label style="font-size:12px;color:#666;">Kind (6-14 J.)</label>
                                <div style="display:flex;align-items:center;gap:5px;">
                                    <input type="number" id="tarif-kurz-kind" step="0.50" value="1.50" style="padding:8px;border:2px solid #e0e0e0;border-radius:6px;width:80px;">
                                    <span>â‚¬</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Normalstrecke -->
                    <div style="padding:12px;background:#f9fafb;border-radius:8px;margin-bottom:10px;">
                        <div style="font-weight:600;margin-bottom:8px;">Normalstrecke (bis <input type="number" id="tarif-normal-km" value="7" min="1" style="width:50px;padding:4px;border:1px solid #d1d5db;border-radius:4px;"> km)</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                            <div>
                                <label style="font-size:12px;color:#666;">Erwachsener</label>
                                <div style="display:flex;align-items:center;gap:5px;">
                                    <input type="number" id="tarif-normal-erw" step="0.50" value="3.00" style="padding:8px;border:2px solid #e0e0e0;border-radius:6px;width:80px;">
                                    <span>â‚¬</span>
                                </div>
                            </div>
                            <div>
                                <label style="font-size:12px;color:#666;">Kind (6-14 J.)</label>
                                <div style="display:flex;align-items:center;gap:5px;">
                                    <input type="number" id="tarif-normal-kind" step="0.50" value="2.00" style="padding:8px;border:2px solid #e0e0e0;border-radius:6px;width:80px;">
                                    <span>â‚¬</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- LÃ¤ngere Strecke -->
                    <div style="padding:12px;background:#f9fafb;border-radius:8px;margin-bottom:10px;">
                        <div style="font-weight:600;margin-bottom:8px;">LÃ¤ngere Strecke (bis <input type="number" id="tarif-lang-km" value="15" min="1" style="width:50px;padding:4px;border:1px solid #d1d5db;border-radius:4px;"> km)</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                            <div>
                                <label style="font-size:12px;color:#666;">Erwachsener</label>
                                <div style="display:flex;align-items:center;gap:5px;">
                                    <input type="number" id="tarif-lang-erw" step="0.50" value="4.50" style="padding:8px;border:2px solid #e0e0e0;border-radius:6px;width:80px;">
                                    <span>â‚¬</span>
                                </div>
                            </div>
                            <div>
                                <label style="font-size:12px;color:#666;">Kind (6-14 J.)</label>
                                <div style="display:flex;align-items:center;gap:5px;">
                                    <input type="number" id="tarif-lang-kind" step="0.50" value="3.00" style="padding:8px;border:2px solid #e0e0e0;border-radius:6px;width:80px;">
                                    <span>â‚¬</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Insel-Ticket -->
                    <div style="padding:12px;background:#f9fafb;border-radius:8px;">
                        <div style="font-weight:600;margin-bottom:8px;">Insel-Ticket (Ã¼ber 15 km)</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                            <div>
                                <label style="font-size:12px;color:#666;">Erwachsener</label>
                                <div style="display:flex;align-items:center;gap:5px;">
                                    <input type="number" id="tarif-insel-erw" step="0.50" value="6.00" style="padding:8px;border:2px solid #e0e0e0;border-radius:6px;width:80px;">
                                    <span>â‚¬</span>
                                </div>
                            </div>
                            <div>
                                <label style="font-size:12px;color:#666;">Kind (6-14 J.)</label>
                                <div style="display:flex;align-items:center;gap:5px;">
                                    <input type="number" id="tarif-insel-kind" step="0.50" value="4.00" style="padding:8px;border:2px solid #e0e0e0;border-radius:6px;width:80px;">
                                    <span>â‚¬</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- GEMEINDE/ABRECHNUNGSSTELLE -->
                <div style="margin-bottom:20px;">
                    <div style="font-weight:600;font-size:14px;margin-bottom:8px;">ğŸ›ï¸ Abrechnungsstelle</div>
                    <div style="margin-bottom:10px;">
                        <label style="font-size:12px;color:#666;display:block;margin-bottom:4px;">Name</label>
                        <input type="text" id="oepnv-community-name" value="Gemeinde Heringsdorf" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="font-size:12px;color:#666;display:block;margin-bottom:4px;">Email</label>
                        <input type="email" id="oepnv-community-email" placeholder="finanzen@heringsdorf.de" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;box-sizing:border-box;">
                    </div>
                </div>
                
                <!-- BELEG-OPTIONEN -->
                <div style="margin-bottom:20px;">
                    <div style="font-weight:600;font-size:14px;margin-bottom:8px;">ğŸ“± Beleg-Optionen fÃ¼r Kunden</div>
                    <div style="display:flex;flex-direction:column;gap:8px;">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:#f9fafb;border-radius:6px;">
                            <input type="checkbox" id="oepnv-beleg-qr" checked style="width:18px;height:18px;">
                            <span style="font-size:14px;">QR-Code anzeigen</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:#f9fafb;border-radius:6px;">
                            <input type="checkbox" id="oepnv-beleg-app" checked style="width:18px;height:18px;">
                            <span style="font-size:14px;">In-App Beleg (Verlauf)</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:#f9fafb;border-radius:6px;">
                            <input type="checkbox" id="oepnv-beleg-pdf" checked style="width:18px;height:18px;">
                            <span style="font-size:14px;">PDF-Download anbieten</span>
                        </label>
                    </div>
                </div>
                
                <!-- BEISPIEL-BERECHNUNG -->
                <div style="padding:15px;background:#fef3c7;border-radius:8px;">
                    <div style="font-weight:600;margin-bottom:8px;">ğŸ“‹ Beispiel-Berechnung:</div>
                    <div style="font-size:13px;color:#666;">
                        <strong>Strecke:</strong> 5 km (Normalstrecke)<br>
                        <strong>Personen:</strong> 2 Erwachsene + 1 Kind<br>
                        <br>
                        <strong>Bustickets:</strong><br>
                        2Ã— 3,00â‚¬ = 6,00â‚¬<br>
                        1Ã— 2,00â‚¬ = 2,00â‚¬<br>
                        Busticket gesamt: 8,00â‚¬<br>
                        + Taxi-Zuschlag: 2,00â‚¬<br>
                        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br>
                        <strong>Kunde zahlt: 10,00â‚¬</strong><br>
                        <br>
                        Bei Taxi-Preis 15,00â‚¬:<br>
                        <strong>Gemeinde zahlt: 5,00â‚¬</strong>
                    </div>
                </div>
                
                <!-- ğŸ†• v5.28.0: ANTI-BETRUGS-SYSTEM -->
                <div style="margin-top:30px;padding:20px;background:#fef2f2;border:2px solid #ef4444;border-radius:12px;">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px;">
                        <div style="font-size:28px;">ğŸš¨</div>
                        <div>
                            <div style="font-weight:700;font-size:16px;color:#991b1b;">Anti-Betrugs-System</div>
                            <div style="font-size:12px;color:#7f1d1d;">Verhindert Mehrfach-Abrechnungen bei Sammelfahrten</div>
                        </div>
                    </div>
                    
                    <!-- TOGGLE -->
                    <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:12px;background:white;border-radius:8px;margin-bottom:15px;">
                        <input type="checkbox" id="oepnv-antifraud-enabled" onchange="saveOEPNVSettings()" style="width:20px;height:20px;">
                        <div style="flex:1;">
                            <div style="font-weight:600;font-size:14px;color:#1f2937;">ğŸ›¡ï¸ Anti-Betrugs-System aktivieren</div>
                            <div style="font-size:12px;color:#6b7280;margin-top:2px;">Erkennt automatisch verdÃ¤chtige Mehrfach-Abrechnungen</div>
                        </div>
                    </label>
                    
                    <!-- MODUS -->
                    <div id="antifraud-mode-section" style="display:none;padding:12px;background:white;border-radius:8px;margin-bottom:15px;">
                        <div style="font-weight:600;font-size:13px;color:#1f2937;margin-bottom:10px;">Betriebsmodus:</div>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:#f9fafb;border-radius:6px;margin-bottom:6px;">
                            <input type="radio" name="antifraud-mode" value="warn" checked style="width:16px;height:16px;">
                            <div>
                                <div style="font-weight:600;font-size:13px;color:#10b981;">âš ï¸ Nur Warnen (Empfohlen fÃ¼r Start)</div>
                                <div style="font-size:11px;color:#6b7280;">Erkennt Duplikate, blockiert aber nicht â†’ Admin sieht Warnungen</div>
                            </div>
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:#f9fafb;border-radius:6px;">
                            <input type="radio" name="antifraud-mode" value="block" style="width:16px;height:16px;">
                            <div>
                                <div style="font-weight:600;font-size:13px;color:#ef4444;">ğŸš« Blockieren</div>
                                <div style="font-size:11px;color:#6b7280;">Verhindert Mehrfach-Abrechnungen aktiv â†’ Blockiert zweite Buchung</div>
                            </div>
                        </label>
                    </div>
                    
                    <!-- ERKENNUNGS-KRITERIEN -->
                    <div id="antifraud-criteria" style="display:none;padding:12px;background:white;border-radius:8px;margin-bottom:15px;">
                        <div style="font-weight:600;font-size:13px;color:#1f2937;margin-bottom:8px;">ğŸ” Erkennungs-Kriterien:</div>
                        <div style="font-size:12px;color:#4b5563;line-height:1.6;">
                            System markiert als verdÃ¤chtig wenn:<br>
                            âœ“ Gleicher Fahrer<br>
                            âœ“ Gleiche Start-Adresse<br>
                            âœ“ Gleiches Ziel<br>
                            âœ“ Zeitdifferenz &lt; 5 Minuten<br>
                            <br>
                            <div style="padding:8px;background:#fef3c7;border-radius:6px;font-size:11px;">
                                <strong>ğŸ’¡ Tipp:</strong> Starten Sie im "Nur Warnen" Modus um Daten zu sammeln, bevor Sie blockieren!
                            </div>
                        </div>
                    </div>
                    
                    <!-- INFO BOX -->
                    <div style="padding:12px;background:#dbeafe;border-radius:8px;font-size:12px;color:#1e40af;">
                        <strong>â„¹ï¸ Was passiert bei Aktivierung?</strong><br>
                        â€¢ Admin sieht verdÃ¤chtige Muster im Dashboard<br>
                        â€¢ Automatische Duplikats-Erkennung<br>
                        â€¢ Warnungen in Echtzeit<br>
                        â€¢ Excel-Export fÃ¼r Gemeinde<br>
                        <br>
                        <strong>ğŸ‘ Vorteile:</strong> Gemeinde spart Geld, Betrug wird verhindert, professionelles System!
                    </div>
                </div>
                
                <button onclick="saveOEPNVSettings()" style="width:100%;margin-top:15px;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:15px;">
                    ğŸ’¾ Einstellungen speichern
                </button>
                
            </div>
        </div>
        
        <!-- ğŸ†• v5.38.2: BUCHUNGSSYSTEM AN/AUS -->
        <div onclick="toggleAdminSection('booking-system')" style="background:#f3f4f6;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ”´ Buchungssystem</span>
            <span id="booking-system-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="booking-system-content" style="display:none;padding:15px;background:#fff;border-radius:8px;margin-bottom:20px;border:1px solid #e5e7eb;">
            
            <!-- Status Anzeige -->
            <div id="booking-system-status" style="text-align:center;margin-bottom:20px;padding:20px;border-radius:12px;color:white;">
                <div style="font-size:14px;opacity:0.9;margin-bottom:8px;">Aktueller Status</div>
                <div id="booking-status-text" style="font-size:32px;font-weight:bold;">ğŸŸ¢ ONLINE</div>
                <div style="font-size:12px;opacity:0.8;margin-top:8px;">Buchungen werden angenommen</div>
            </div>
            
            <!-- ON/OFF Schalter -->
            <div style="margin-bottom:20px;">
                <div style="font-weight:600;font-size:14px;margin-bottom:15px;">ğŸ“± Buchungen aktivieren/deaktivieren</div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                    <button onclick="setBookingSystem(true)" id="btn-booking-on" style="padding:15px;border:3px solid #10b981;background:#10b981;border-radius:12px;font-weight:700;cursor:pointer;font-size:15px;color:white;transition:all 0.2s;">
                        âœ… ONLINE<br>
                        <span style="font-size:11px;font-weight:normal;opacity:0.9;">Buchungen mÃ¶glich</span>
                    </button>
                    <button onclick="setBookingSystem(false)" id="btn-booking-off" style="padding:15px;border:3px solid #e5e7eb;background:white;border-radius:12px;font-weight:700;cursor:pointer;font-size:15px;color:#666;transition:all 0.2s;">
                        ğŸ”´ OFFLINE<br>
                        <span style="font-size:11px;font-weight:normal;opacity:0.8;">Nur Anrufen</span>
                    </button>
                </div>
            </div>
            
            <!-- Info-Box -->
            <div style="padding:12px;background:#fef3c7;border-radius:8px;font-size:12px;">
                <strong>ğŸ’¡ Was passiert wenn OFFLINE?</strong><br>
                â€¢ Buchungs-Button wird ausgeblendet<br>
                â€¢ FahrgÃ¤ste sehen "Bitte anrufen"<br>
                â€¢ Telefonnummer wird angezeigt<br>
                â€¢ Ideal fÃ¼r Urlaub oder Wartung<br>
            </div>
        </div>
        
        <div onclick="toggleAdminSection('pricing')" style="background:#f3f4f6;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ’° Preis-Steuerung</span>
            <span id="pricing-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="pricing-content" style="display:none;padding:15px;background:#fff;border-radius:8px;margin-bottom:20px;border:1px solid #e5e7eb;">
            
            <!-- Aktueller Multiplikator Anzeige -->
            <div style="text-align:center;margin-bottom:20px;padding:15px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:12px;color:white;">
                <div style="font-size:12px;opacity:0.9;">Aktueller Preis-Multiplikator</div>
                <div id="current-multiplier-display" style="font-size:36px;font-weight:bold;">100%</div>
                <div id="multiplier-reason" style="font-size:11px;opacity:0.8;">Normalpreis</div>
            </div>
            
            <!-- Automatische Anpassung -->
            <div style="margin-bottom:20px;">
                <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px;background:#f9fafb;border-radius:8px;">
                    <input type="checkbox" id="auto-surge-enabled" onchange="savePricingSettings()" style="width:20px;height:20px;">
                    <div>
                        <div style="font-weight:600;font-size:14px;">ğŸ“± Automatisch (Auslastung)</div>
                        <div style="font-size:12px;color:#666;">âš ï¸ Standard: AUS (Normalpreise fÃ¼r Kunden)</div>
                    </div>
                </label>
                <div style="margin-top:10px;padding:10px;background:#f0fdf4;border-radius:8px;">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                        <span style="font-size:13px;">Pro zusÃ¤tzlichem Taxi:</span>
                        <select id="surge-per-taxi" onchange="savePricingSettings()" style="padding:8px;border-radius:6px;border:1px solid #d1d5db;font-size:14px;">
                            <option value="5">+5%</option>
                            <option value="10" selected>+10%</option>
                            <option value="15">+15%</option>
                            <option value="20">+20%</option>
                        </select>
                    </div>
                    <div style="font-size:11px;color:#666;line-height:1.4;">
                        ğŸ’¡ <strong>Beispiel:</strong> 1 Auto = 0%, 2 Autos = +10%, 3 Autos = +20%
                    </div>
                </div>
            </div>
            
            <!-- ğŸ†• v5.90.525: AUTO-ASSIGN PUFFER -->
            <div style="margin-bottom:20px;">
                <div style="font-weight:600;font-size:14px;margin-bottom:10px;">â±ï¸ Auto-Assign Puffer</div>
                <div style="padding:10px;background:#f0fdf4;border-radius:8px;">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                        <span style="font-size:13px;">Sicherheits-Puffer:</span>
                        <select id="auto-assign-buffer" onchange="saveAutoAssignBuffer()" style="padding:8px;border-radius:6px;border:1px solid #d1d5db;font-size:14px;">
                            <option value="5">5 Min</option>
                            <option value="10" selected>10 Min</option>
                            <option value="15">15 Min</option>
                            <option value="20">20 Min</option>
                            <option value="30">30 Min</option>
                        </select>
                    </div>
                    <div style="font-size:11px;color:#666;line-height:1.4;">
                        ğŸ’¡ <strong>Beispiel:</strong> Anfahrt 8 Min + Puffer 10 Min = Auto-Assign 18 Min vor Abholung
                    </div>
                </div>
            </div>
            
            <!-- Manueller Aufschlag/Rabatt -->
            <div style="margin-bottom:20px;">
                <div style="font-weight:600;font-size:14px;margin-bottom:10px;">ğŸšï¸ Manueller Aufschlag/Rabatt</div>
                <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;">
                    <button onclick="setManualMultiplier(-20)" class="multiplier-btn" data-value="-20" style="padding:12px 5px;border:2px solid #e5e7eb;background:white;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;color:#10b981;">-20%</button>
                    <button onclick="setManualMultiplier(-10)" class="multiplier-btn" data-value="-10" style="padding:12px 5px;border:2px solid #e5e7eb;background:white;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;color:#10b981;">-10%</button>
                    <button onclick="setManualMultiplier(0)" class="multiplier-btn active" data-value="0" style="padding:12px 5px;border:2px solid #667eea;background:#667eea;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;color:white;">0%</button>
                    <button onclick="setManualMultiplier(10)" class="multiplier-btn" data-value="10" style="padding:12px 5px;border:2px solid #e5e7eb;background:white;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;color:#ef4444;">+10%</button>
                    <button onclick="setManualMultiplier(20)" class="multiplier-btn" data-value="20" style="padding:12px 5px;border:2px solid #e5e7eb;background:white;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;color:#ef4444;">+20%</button>
                </div>
            </div>
            
            <!-- Status-Info -->
            <div style="padding:12px;background:#fef3c7;border-radius:8px;font-size:12px;">
                <strong>ğŸ“ˆ So wird der Preis berechnet:</strong><br>
                Grundpreis Ã— (100% + Auto-Surge + Manuell) = Endpreis<br>
                <span id="pricing-example" style="color:#666;">Beispiel: 14.60â‚¬ Ã— 100% = 14.60â‚¬</span>
            </div>
        </div>
        
        <!-- ğŸ†• v5.83.0: ADMIN-EINSTELLUNGEN -->
        <div onclick="toggleAdminSection('settings')" style="background:linear-gradient(135deg,#6366f1,#4f46e5);color:white;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">âš™ï¸ Einstellungen</span>
            <span id="settings-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="settings-content" style="display:none;margin-bottom:20px;background:white;padding:15px;border-radius:8px;border:1px solid #e5e7eb;">
            
            <!-- Info-Box -->
            <div style="background:#eff6ff;border:2px solid #93c5fd;border-radius:8px;padding:12px;margin-bottom:20px;font-size:13px;">
                <div style="font-weight:700;margin-bottom:6px;color:#1e40af;">â„¹ï¸ Hinweis:</div>
                <div style="color:#1e40af;">
                    Einstellungen werden in Firebase gespeichert und bleiben auch nach App-Updates erhalten.
                </div>
            </div>
            
            <!-- FritzBox Click-to-Call -->
            <div style="background:#f9fafb;border:2px solid #e5e7eb;border-radius:8px;padding:15px;margin-bottom:15px;">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px;">
                    <div style="font-size:24px;">ğŸ’¾</div>
                    <div style="font-weight:700;font-size:16px;color:#1f2937;">FritzBox Click-to-Call</div>
                </div>
                
                <div style="margin-bottom:12px;">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                        <input type="checkbox" id="fritzbox-enabled" onchange="saveFritzBoxSettings()" style="width:20px;height:20px;cursor:pointer;">
                        <span style="font-weight:600;font-size:14px;color:#374151;">Aktiviert</span>
                    </label>
                </div>
                
                <div style="margin-bottom:12px;">
                    <label style="display:block;font-weight:600;font-size:13px;color:#374151;margin-bottom:6px;">Host</label>
                    <input type="text" id="fritzbox-host" placeholder="fritz.box" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:6px;font-size:14px;box-sizing:border-box;">
                </div>
                
                <div style="margin-bottom:12px;">
                    <label style="display:block;font-weight:600;font-size:13px;color:#374151;margin-bottom:6px;">Port</label>
                    <input type="number" id="fritzbox-port" placeholder="49000" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:6px;font-size:14px;box-sizing:border-box;">
                </div>
                
                <div style="margin-bottom:12px;">
                    <label style="display:block;font-weight:600;font-size:13px;color:#374151;margin-bottom:6px;">Benutzername</label>
                    <input type="text" id="fritzbox-username" placeholder="admin" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:6px;font-size:14px;box-sizing:border-box;">
                </div>
                
                <div style="margin-bottom:12px;">
                    <label style="display:block;font-weight:600;font-size:13px;color:#374151;margin-bottom:6px;">Passwort</label>
                    <input type="password" id="fritzbox-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:6px;font-size:14px;box-sizing:border-box;">
                </div>
                
                <div style="margin-bottom:12px;">
                    <label style="display:block;font-weight:600;font-size:13px;color:#374151;margin-bottom:6px;">Telefon (DECT)</label>
                    <input type="text" id="fritzbox-phone" placeholder="**610" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:6px;font-size:14px;box-sizing:border-box;">
                    <div style="font-size:11px;color:#6b7280;margin-top:4px;">
                        ğŸ’¡ Deine DECT-Telefon Nummer (z.B. **610)
                    </div>
                </div>
                
                <button onclick="saveFritzBoxSettings()" style="width:100%;padding:12px;background:linear-gradient(135deg,#6366f1,#4f46e5);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px;box-shadow:0 4px 12px rgba(99,102,241,0.3);">
                    ğŸ’¾ Speichern
                </button>
            </div>
            
            <!-- ğŸ†• v5.87.94: SMS BENACHRICHTIGUNGEN - SEPARAT SCHALTBAR -->
            <div style="background:#f0fdf4;border:2px solid #10b981;border-radius:8px;padding:15px;margin-bottom:15px;">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px;">
                    <div style="font-size:24px;">ğŸ“±</div>
                    <div style="font-weight:700;font-size:16px;color:#166534;">SMS-Benachrichtigungen (seven.io)</div>
                </div>
                
                <!-- SMS 1: BuchungsbestÃ¤tigung -->
                <div style="background:white;border:2px solid #e5e7eb;border-radius:8px;padding:12px;margin-bottom:10px;">
                    <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                        <input type="checkbox" id="sms-booking-enabled" onchange="saveSMSSettings()" style="width:22px;height:22px;cursor:pointer;">
                        <div>
                            <div style="font-weight:600;font-size:14px;color:#374151;">âœ… BuchungsbestÃ¤tigung</div>
                            <div style="font-size:12px;color:#6b7280;">SMS direkt nach Buchung</div>
                        </div>
                    </label>
                </div>
                
                <!-- SMS 2: Fahrer unterwegs -->
                <div style="background:white;border:2px solid #e5e7eb;border-radius:8px;padding:12px;margin-bottom:10px;">
                    <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                        <input type="checkbox" id="sms-tracking-enabled" onchange="saveSMSSettings()" style="width:22px;height:22px;cursor:pointer;">
                        <div>
                            <div style="font-weight:600;font-size:14px;color:#374151;">ğŸš• Fahrer unterwegs + Tracking</div>
                            <div style="font-size:12px;color:#6b7280;">SMS wenn Fahrer Fahrt annimmt</div>
                        </div>
                    </label>
                </div>
                
                <div style="background:#dcfce7;border-radius:6px;padding:10px;font-size:13px;color:#166534;margin-bottom:12px;">
                    <div style="margin-bottom:5px;">â„¹ï¸ <strong>Info:</strong></div>
                    <div>â€¢ Absender: <strong>FunkTaxi</strong></div>
                    <div>â€¢ Preis: ~0,075â‚¬ pro SMS</div>
                </div>
                
                <button onclick="testSMSActive()" style="width:100%;padding:14px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px;">
                    ğŸ“± Test-SMS senden (aktive Optionen)
                </button>
            </div>
            
            <!-- ğŸ†• v5.88.0: 50/50 TICKET ABRECHNUNG -->
            <div style="background:linear-gradient(135deg,#fef3c7,#fde68a);border:2px solid #f59e0b;border-radius:8px;padding:15px;margin-bottom:15px;">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px;">
                    <div style="font-size:24px;">ğŸ«</div>
                    <div style="font-weight:700;font-size:16px;color:#92400e;">50/50 Taxi-Ticket MV</div>
                </div>
                
                <!-- EIN/AUS SCHALTER -->
                <div style="background:white;border:2px solid #e5e7eb;border-radius:8px;padding:12px;margin-bottom:12px;">
                    <label style="display:flex;align-items:center;gap:12px;cursor:pointer;">
                        <input type="checkbox" id="fifty-fifty-system-enabled" onchange="saveFiftyFiftySettings()" style="width:24px;height:24px;cursor:pointer;">
                        <div>
                            <div style="font-weight:700;font-size:15px;color:#374151;">50/50 Ticket aktivieren</div>
                            <div style="font-size:12px;color:#6b7280;">Zeigt Option im Buchungsformular (Fr/Sa 20-08 Uhr)</div>
                        </div>
                    </label>
                </div>
                
                <div style="background:white;border-radius:8px;padding:12px;margin-bottom:12px;">
                    <div style="font-size:14px;color:#78350f;margin-bottom:8px;">
                        <strong>Abrechnung fÃ¼r Landesverband:</strong>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;">
                        <div>
                            <label style="font-size:12px;color:#6b7280;">Von:</label>
                            <input type="date" id="fifty-fifty-export-from" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;">
                        </div>
                        <div>
                            <label style="font-size:12px;color:#6b7280;">Bis:</label>
                            <input type="date" id="fifty-fifty-export-to" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;">
                        </div>
                    </div>
                    <div id="fifty-fifty-stats" style="font-size:13px;color:#6b7280;margin-bottom:10px;padding:8px;background:#f9fafb;border-radius:6px;">
                        ğŸ“± Lade Statistik...
                    </div>
                </div>
                
                <button onclick="exportFiftyFiftyReport()" style="width:100%;padding:14px;background:#f59e0b;color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px;">
                    ğŸ“± 50/50 Abrechnung exportieren (CSV)
                </button>
                
                <div style="margin-top:10px;font-size:11px;color:#92400e;text-align:center;">
                    â„¹ï¸ Export fÃ¼r Erstattung beim Landesverband MV
                </div>
            </div>
            
        </div>
        
        </div><!-- Ende ERWEITERT -->
        
    </div><!-- Ende admin-view -->

    <!-- ğŸ†• v5.43.0: SCHICHTPLAN-VIEW -->
    <div id="shift-plan-view" class="view admin-only">
        <div style="max-width: 1200px; margin: 20px auto; padding: 0 15px;">
            <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
                <!-- Header -->
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 8px;">ğŸ“±</div>
                    <h2 style="font-size: 24px; margin: 0 0 5px 0;">SCHICHTPLAN</h2>
                    <p style="font-size: 14px; margin: 0; opacity: 0.9;">Auto-Bedarf basierend auf Vorbestellungen</p>
                </div>
                
                <!-- Datum-Wahl -->
                <div style="padding: 20px; border-bottom: 2px solid #e5e7eb;">
                    <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #1f2937;">
                        ğŸ“… Datum wÃ¤hlen:
                    </label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input 
                            type="date" 
                            id="shift-plan-date" 
                            style="flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px;"
                            onchange="analyzeShiftPlan()">
                        <button 
                            onclick="setShiftPlanToday()" 
                            style="padding: 12px 20px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                            ğŸ“… Heute
                        </button>
                    </div>
                </div>
                
                <!-- Analyse-Ergebnis -->
                <div id="shift-plan-result" style="padding: 20px;">
                    <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“…</div>
                        <div style="font-size: 16px; font-weight: 600;">Bitte Datum wÃ¤hlen</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ—ºï¸ v5.90.202: FAHRZEUG-ÃœBERSICHT VIEW -->
    <!-- ğŸ†• v5.90.525: FAHRZEUG-ÃœBERSICHT VIEW - ADMIN FLEET MAP! -->
    <div id="fleet-overview-view" class="view admin-only">
        <!-- ğŸ†• v5.90.525: ECHTE Fahrzeug-Ãœbersicht aus Admin kopiert! -->
        <div style="background:linear-gradient(135deg,#0ea5e9,#0284c7);color:white;padding:20px;border-radius:12px;margin-bottom:20px;box-shadow:0 4px 12px rgba(14,165,233,0.3);">
            <h2 style="margin:0 0 10px 0;font-size:24px;">ğŸ—ºï¸ Fahrzeug-Ãœbersicht</h2>
            <p style="margin:0;font-size:14px;opacity:0.95;">Live-Status â€¢ Zuweisungen â€¢ Online/Offline â€¢ NÃ¤chster Termin</p>
            <div id="fleet-status" style="margin-top:10px;font-size:12px;opacity:0.8;"></div>
        </div>
        
        <!-- ğŸ” Adresssuche -->
        <div style="margin-bottom:12px;position:relative;">
            <div style="display:flex;gap:8px;">
                <input type="text" id="fleet-address-search" 
                    placeholder="ğŸ” Adresse suchen..." 
                    autocomplete="off"
                    style="flex:1;padding:12px;border:2px solid #0ea5e9;border-radius:8px;font-size:14px;">
                <button id="fleet-share-btn" onclick="shareFleetAddress()" style="display:none;padding:12px 16px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">ğŸ“¤</button>
                <button onclick="clearFleetSearch()" style="padding:12px 16px;background:#6b7280;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">âœ•</button>
            </div>
            <div id="fleet-address-dropdown" style="display:none;position:absolute;top:100%;left:0;right:100px;background:white;border:1px solid #e5e7eb;border-radius:8px;max-height:250px;overflow-y:auto;z-index:1000;box-shadow:0 4px 15px rgba(0,0,0,0.15);margin-top:4px;"></div>
        </div>
        
        <!-- Legende -->
        <div style="display:flex;gap:15px;margin-bottom:10px;font-size:13px;">
            <div style="display:flex;align-items:center;gap:5px;">
                <div style="width:12px;height:12px;background:#22c55e;border-radius:50%;"></div>
                <span>Frei</span>
            </div>
            <div style="display:flex;align-items:center;gap:5px;">
                <div style="width:12px;height:12px;background:#ef4444;border-radius:50%;"></div>
                <span>Besetzt</span>
            </div>
            <div style="display:flex;align-items:center;gap:5px;">
                <div style="width:12px;height:12px;background:#f59e0b;border-radius:50%;"></div>
                <span>Zugewiesen</span>
            </div>
            <div style="display:flex;align-items:center;gap:5px;">
                <div style="width:12px;height:12px;background:#6b7280;border-radius:50%;"></div>
                <span>Offline</span>
            </div>
        </div>
        
        <!-- ğŸ†• v5.90.488: NÃ„CHSTER TERMIN + TIMELINE! -->
        <div style="display:grid;grid-template-columns:2fr 1fr;gap:15px;margin-bottom:15px;">
            <!-- LINKS: NÃ¤chster Termin (groÃŸ) -->
            <div id="fleet-next-appointment" style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(16,185,129,0.3);">
                <div style="font-size:14px;opacity:0.9;margin-bottom:8px;font-weight:600;">â° NÃ„CHSTER TERMIN</div>
                <div style="font-size:24px;font-weight:700;margin-bottom:10px;">Lade...</div>
            </div>
            
            <!-- RECHTS: Timeline (nÃ¤chste Stunde) -->
            <div id="fleet-upcoming-timeline" style="background:white;border:2px solid #0ea5e9;border-radius:12px;padding:15px;max-height:200px;overflow-y:auto;">
                <div style="font-size:14px;font-weight:700;color:#0ea5e9;margin-bottom:10px;">ğŸ“… NÃ„CHSTE STUNDE</div>
                <div id="fleet-upcoming-list" style="font-size:13px;color:#6b7280;">
                    Lade...
                </div>
            </div>
        </div>
        
        <!-- ğŸ†• v5.90.525: EIGENE MAP-ID fÃ¼r Fleet-Overview! -->
        <!-- Karte (ADMIN-Version aber eigene ID!) -->
        <div id="fleet-map-overview" style="height:400px;border-radius:12px;border:2px solid #0ea5e9;box-shadow:0 4px 12px rgba(14,165,233,0.2);margin-bottom:15px;"></div>
        
        <!-- Fahrzeug-Liste (OVERVIEW-Version!) -->
        <div id="fleet-vehicle-list-overview" style="margin-bottom:15px;"></div>
        
        <!-- Buttons (OVERVIEW-Version!) -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <button onclick="refreshFleetMapOverview()" style="padding:14px;background:linear-gradient(135deg,#0ea5e9,#0284c7);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(14,165,233,0.3);">
                ğŸ”„ Aktualisieren
            </button>
            <button onclick="toggleFleetAutoRefreshOverview()" id="fleet-auto-btn-overview" style="padding:14px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;">
                â–¶ï¸ Auto-Update
            </button>
        </div>
    </div>

    <!-- ğŸ” DEBUG-VIEW - v5.39.4 -->
    <!-- ğŸ†• v5.90.370: LIVE DRIVER MONITOR - GOD MODE! -->
    <div id="live-monitor-view" class="view admin-only" style="display:none; max-width: 1800px; margin: 20px auto; padding: 0 15px;">
        
        <!-- MEGA HEADER -->
        <div style="background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); border-radius: 16px; padding: 40px; text-align: center; box-shadow: 0 10px 40px rgba(124, 58, 237, 0.5); margin-bottom: 30px; border: 4px solid #7c3aed;">
            <div style="font-size: 80px; margin-bottom: 15px; text-shadow: 0 4px 20px rgba(0,0,0,0.5);">ğŸ‘ï¸</div>
            <h1 style="font-size: 48px; margin: 0 0 10px 0; color: white; font-weight: 900; text-shadow: 0 2px 10px rgba(0,0,0,0.3);">
                LIVE DRIVER MONITOR
            </h1>
            <p style="font-size: 20px; opacity: 0.95; margin: 0; color: white; font-weight: 600;">
                Sieh ALLES was deine Fahrer machen - LIVE! ğŸ‘ï¸â€ğŸ—¨ï¸
            </p>
        </div>

        <!-- AUTO-REFRESH Control -->
        <div style="text-align: center; margin-bottom: 30px;">
            <button id="monitor-auto-refresh-btn" onclick="toggleMonitorAutoRefresh()" style="
                padding: 20px 50px;
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
                border: none;
                border-radius: 12px;
                font-size: 20px;
                font-weight: 900;
                cursor: pointer;
                box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
                transition: all 0.3s;
            " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                ğŸ”„ START LIVE MONITORING
            </button>
            <div style="margin-top: 15px; font-size: 14px; color: #6b7280;">
                Aktualisiert alle <strong>2 Sekunden</strong> automatisch
            </div>
        </div>

        <!-- Driver Cards Container -->
        <div id="live-monitor-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(550px, 1fr)); gap: 25px;">
            <!-- Wird dynamisch gefÃ¼llt -->
        </div>
    </div>

    <!-- ğŸ†• v5.90.369: ULTIMATE SYSTEM DIAGNOSTICS -->
    <div id="system-diagnostics-view" class="view admin-only" style="display:none; max-width: 1600px; margin: 20px auto; padding: 0 15px;">
        
        <!-- MEGA HEADER -->
        <div style="background: linear-gradient(135deg, #dc2626 0%, #7f1d1d 100%); border-radius: 16px; padding: 40px; text-align: center; box-shadow: 0 10px 40px rgba(220, 38, 38, 0.5); margin-bottom: 30px; border: 4px solid #dc2626;">
            <div style="font-size: 80px; margin-bottom: 15px; text-shadow: 0 4px 20px rgba(0,0,0,0.5);">ğŸ”¥</div>
            <h1 style="font-size: 48px; margin: 0 0 10px 0; color: white; font-weight: 900; text-shadow: 0 2px 10px rgba(0,0,0,0.3);">
                ULTIMATE SYSTEM DIAGNOSTICS
            </h1>
            <p style="font-size: 20px; opacity: 0.95; margin: 0; color: white; font-weight: 600;">
                Der Debug-Logger den die Welt noch nicht gesehen hat! ğŸ’¥
            </p>
        </div>

        <!-- AUTO-REFRESH Button -->
        <div style="text-align: center; margin-bottom: 30px;">
            <button id="diagnostics-auto-refresh-btn" onclick="toggleDiagnosticsAutoRefresh()" style="
                padding: 20px 50px;
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
                border: none;
                border-radius: 12px;
                font-size: 20px;
                font-weight: 900;
                cursor: pointer;
                box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
                transition: all 0.3s;
            " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                ğŸ”„ START AUTO-REFRESH (1s)
            </button>
            <button onclick="runFullSystemDiagnostics()" style="
                padding: 20px 50px;
                background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
                color: white;
                border: none;
                border-radius: 12px;
                font-size: 20px;
                font-weight: 900;
                cursor: pointer;
                box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
                margin-left: 15px;
                transition: all 0.3s;
            " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                âš¡ SCAN JETZT!
            </button>
        </div>

        <div id="diagnostics-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px;">
            <!-- Wird dynamisch gefÃ¼llt -->
        </div>
    </div>

    <div id="debug-view" class="view admin-only" style="display:none; max-width: 1400px; margin: 20px auto; padding: 0 15px;">
        
        <!-- ğŸ†• v5.90.363: VEHICLE ID DIAGNOSTICS -->
        <div style="background: white; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); margin-bottom: 20px; overflow: hidden;">
            <div style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); color: white; padding: 20px; text-align: center;">
                <div style="font-size: 48px; margin-bottom: 8px;">ğŸš—</div>
                <h2 style="font-size: 24px; margin: 0 0 5px 0;">VEHICLE ID DIAGNOSTICS</h2>
                <p style="font-size: 13px; opacity: 0.9; margin: 0;">PrÃ¼fe Fahrzeug-IDs und GPS-Daten</p>
            </div>
            
            <div style="padding: 20px;">
                <button onclick="runVehicleDiagnostics()" style="
                    width: 100%;
                    padding: 16px;
                    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 700;
                    cursor: pointer;
                    margin-bottom: 20px;
                    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                    ğŸ” VEHICLE IDS PRÃœFEN
                </button>
                
                <div id="vehicle-diagnostics-output" style="
                    background: #f9fafb;
                    border: 2px solid #e5e7eb;
                    border-radius: 8px;
                    padding: 15px;
                    font-family: 'Courier New', monospace;
                    font-size: 13px;
                    max-height: 400px;
                    overflow-y: auto;
                    white-space: pre-wrap;
                    color: #374151;
                ">
                    Klicke auf "VEHICLE IDS PRÃœFEN" um zu starten...
                </div>
                
                <button id="migration-action-btn" onclick="runMigrationFromDebug()" style="
                    display: none;
                    width: 100%;
                    padding: 16px;
                    background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 700;
                    cursor: pointer;
                    margin-top: 15px;
                    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
                " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                    ğŸ”„ MIGRATION JETZT AUSFÃœHREN!
                </button>
            </div>
        </div>
        
        <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 20px; text-align: center;">
                <div style="font-size: 48px; margin-bottom: 8px;">ğŸ”</div>
                <h2 style="font-size: 24px; margin: 0 0 5px 0;">LIVE DEBUG MONITOR</h2>
                <p style="font-size: 13px; opacity: 0.9; margin: 0;">Alle Console-Logs in Echtzeit</p>
            </div>

            <!-- Controls -->
            <div style="padding: 15px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                <button id="debug-pause-btn" onclick="toggleDebugPause()" style="
                    padding: 10px 20px;
                    background: #f59e0b;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                    font-size: 14px;
                ">
                    â¸ Paused
                </button>
                <button onclick="clearDebugLogs()" style="
                    padding: 10px 20px;
                    background: #6b7280;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                    font-size: 14px;
                ">
                    ğŸ—‘ï¸ Clear
                </button>
                <button onclick="copyDebugLogs()" style="
                    padding: 10px 20px;
                    background: #3b82f6;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                    font-size: 14px;
                ">
                    ğŸ“‹ Copy All
                </button>
                <button onclick="exportDebugLogs()" style="
                    padding: 10px 20px;
                    background: #8b5cf6;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                    font-size: 14px;
                ">
                    ğŸ’¾ Export
                </button>
                <button onclick="exportStoredLogs()" style="
                    padding: 10px 20px;
                    background: #10b981;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                    font-size: 14px;
                ">
                    ğŸ“¥ Storage (24h)
                </button>
                <div style="flex: 1; min-width: 200px;">
                    <input type="text" id="debug-filter" placeholder="ğŸ” Filter logs..." onkeyup="filterDebugLogs()" style="
                        width: 100%;
                        padding: 10px 15px;
                        border: 2px solid #e5e7eb;
                        border-radius: 8px;
                        font-size: 14px;
                    ">
                </div>
            </div>

            <!-- Stats -->
            <div style="padding: 15px; background: #f0f9ff; border-bottom: 1px solid #e5e7eb; display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; font-size: 13px;">
                <div><strong>Total:</strong> <span id="debug-count-total">0</span></div>
                <div style="color: #10b981;"><strong>âœ… Info:</strong> <span id="debug-count-info">0</span></div>
                <div style="color: #f59e0b;"><strong>âš ï¸ Warn:</strong> <span id="debug-count-warn">0</span></div>
                <div style="color: #ef4444;"><strong>ğŸ’¾ Error:</strong> <span id="debug-count-error">0</span></div>
            </div>

            <!-- Log Container -->
            <div id="debug-log-container" style="
                padding: 15px;
                max-height: 70vh;
                overflow-y: auto;
                background: #1f2937;
                color: #f3f4f6;
                font-family: 'Courier New', monospace;
                font-size: 12px;
                line-height: 1.6;
            ">
                <div style="color: #9ca3af; text-align: center; padding: 40px 20px;">
                    ğŸ” Warte auf Logs...<br>
                    <span style="font-size: 11px;">Alle console.log(), console.warn(), console.error() werden hier angezeigt</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ†• v5.62.0: AI-ASSISTENT VIEW -->
    <div id="ai-assistant-view" class="view admin-only" style="display:none; max-width: 1200px; margin: 20px auto; padding: 0 15px;">
        <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; text-align: center;">
                <div style="font-size: 48px; margin-bottom: 8px;">ğŸ¤–</div>
                <h2 style="font-size: 24px; margin: 0 0 5px 0;">AI-BUCHUNGS-ASSISTENT</h2>
                <p style="font-size: 13px; opacity: 0.9; margin: 0;">E-Mails & Telegram-Nachrichten automatisch analysieren & buchen</p>
            </div>

            <!-- Info Banner -->
            <div style="padding: 15px; background: #ecfdf5; border-bottom: 2px solid #10b981;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="font-size: 24px;">â„¹ï¸</div>
                    <div style="flex: 1; font-size: 13px; color: #065f46;">
                        <strong>So funktioniert's:</strong> Kopiere eine E-Mail oder Telegram-Nachricht in das Textfeld.
                        Der AI-Assistent erkennt automatisch Datum, Zeit, Abholort, Zielort und Anzahl Personen.
                        Du bestÃ¤tigst die Buchung mit einem Klick!
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div style="padding: 20px;">
                
                <!-- Input Area -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                        ğŸ“§ E-Mail, Telegram oder WhatsApp-Nachricht:
                    </label>
                    <textarea id="ai-input-text" placeholder="Beispiel:&#10;&#10;Guten Tag,&#10;ich mÃ¶chte ein Taxi fÃ¼r morgen 14:30 Uhr buchen.&#10;Abholung: Bahnhof Heringsdorf&#10;Ziel: Strandhotel Ahlbeck&#10;2 Personen&#10;&#10;Mit freundlichen GrÃ¼ÃŸen&#10;Maria Schmidt&#10;+49 170 1234827" 
                        style="width: 100%; height: 200px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; font-family: monospace; resize: vertical;">
                    </textarea>
                    
                    <!-- ğŸ†• v5.88.11: Screenshot-Upload fÃ¼r WhatsApp! -->
                    <div style="margin-top: 12px; padding: 15px; background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); border-radius: 8px;">
                        <div style="color: white; font-weight: 600; margin-bottom: 10px; font-size: 14px;">
                            ğŸ“± WhatsApp-Screenshot hochladen:
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <label style="flex: 1; min-width: 150px; padding: 12px; background: white; border-radius: 6px; cursor: pointer; text-align: center; font-weight: 600; color: #128C7E;">
                                ğŸ“· Screenshot wÃ¤hlen
                                <input type="file" id="ai-screenshot-input" accept="image/*" onchange="analyzeScreenshot(this)" style="display: none;">
                            </label>
                            <button onclick="pasteFromClipboard('ai-input-text')" style="flex: 1; min-width: 150px; padding: 12px; background: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; font-weight: 600; color: #128C7E;">
                                ğŸ“‹ Text einfÃ¼gen
                            </button>
                        </div>
                        <div style="color: rgba(255,255,255,0.9); font-size: 12px; margin-top: 8px;">
                            ğŸ’¡ Mach einen Screenshot von der WhatsApp-Nachricht - ich lese Name, Telefon & Buchungsdetails automatisch aus!
                        </div>
                        <div id="ai-screenshot-preview" style="display: none; margin-top: 10px;"></div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button onclick="analyzeBookingRequest()" id="ai-analyze-btn" style="
                        flex: 1;
                        padding: 14px 24px;
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 15px;
                        font-weight: 700;
                        cursor: pointer;
                        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
                    ">
                        ğŸ” Analysieren
                    </button>
                    <button onclick="clearAIAssistant()" style="
                        padding: 14px 24px;
                        background: #6b7280;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 15px;
                        font-weight: 700;
                        cursor: pointer;
                    ">
                        ğŸ—‘ï¸ LÃ¶schen
                    </button>
                </div>

                <!-- Loading Indicator -->
                <div id="ai-loading" style="display: none; text-align: center; padding: 20px; background: #f9fafb; border-radius: 8px; margin-bottom: 20px;">
                    <div style="font-size: 32px; margin-bottom: 10px; animation: pulse 1.5s infinite;">ğŸ¤–</div>
                    <div style="font-size: 14px; color: #6b7280; font-weight: 600;">AI analysiert Nachricht...</div>
                </div>

                <!-- Results Area -->
                <div id="ai-results" style="display: none;">
                    <!-- Analysis Result -->
                    <div style="background: #f9fafb; border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 2px solid #10b981;">
                        <div style="font-size: 16px; font-weight: 700; color: #065f46; margin-bottom: 15px;">
                            âœ… Buchungs-Daten erkannt:
                        </div>
                        <div id="ai-analysis-result" style="font-size: 14px; line-height: 1.8;"></div>
                    </div>

                    <!-- Booking Form -->
                    <div style="background: white; border: 2px solid #10b981; border-radius: 8px; padding: 20px;">
                        <div style="font-size: 16px; font-weight: 700; color: #065f46; margin-bottom: 15px;">
                            ğŸ“ Buchung erstellen:
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">Datum & Zeit:</label>
                                <input type="datetime-local" id="ai-booking-datetime" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">Anzahl Personen:</label>
                                <input type="number" id="ai-booking-passengers" min="1" max="8" value="1" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">Abholort:</label>
                            <div style="position: relative;display:flex;gap:8px;">
                                <input type="text" id="ai-booking-pickup" placeholder="z.B. Bahnhof Heringsdorf" style="flex:1; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                                <button onclick="openUniversalMapPicker('ai-booking-pickup', 'ğŸ“ Abholort auf Karte wÃ¤hlen')" style="background:#10b981;color:white;border:none;border-radius:6px;padding:10px 14px;cursor:pointer;font-size:16px;flex-shrink:0;" title="Auf Karte wÃ¤hlen">
                                    ğŸ—ºï¸
                                </button>
                                <div class="autocomplete-dropdown" id="ai-booking-pickup-dropdown" style="display: none;"></div>
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">Zielort:</label>
                            <div style="position: relative;display:flex;gap:8px;">
                                <input type="text" id="ai-booking-destination" placeholder="z.B. Strandhotel Ahlbeck" style="flex:1; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                                <button onclick="openUniversalMapPicker('ai-booking-destination', 'ğŸ¯ Zielort auf Karte wÃ¤hlen')" style="background:#10b981;color:white;border:none;border-radius:6px;padding:10px 14px;cursor:pointer;font-size:16px;flex-shrink:0;" title="Auf Karte wÃ¤hlen">
                                    ğŸ—ºï¸
                                </button>
                                <div class="autocomplete-dropdown" id="ai-booking-destination-dropdown" style="display: none;"></div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">Kunden-Name:</label>
                                <input type="text" id="ai-booking-name" placeholder="z.B. Maria Schmidt" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">Telefon:</label>
                                <input type="tel" id="ai-booking-phone" placeholder="z.B. +49 170 1234827" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">ğŸ“ Notizen (optional):</label>
                            <textarea id="ai-booking-notes" placeholder="z.B. Zwischenstopps, Kindersitz, besondere WÃ¼nsche..." style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px; min-height: 60px; resize: vertical; font-family: inherit;"></textarea>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">Berechneter Preis:</label>
                            <div id="ai-booking-price" style="font-size: 24px; font-weight: 700; color: #10b981;">-- â‚¬</div>
                        </div>

                        <div style="display: flex; gap: 10px;">
                            <button onclick="createAndSubmitBookingFromAI()" style="
                                flex: 1;
                                padding: 16px;
                                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                                color: white;
                                border: none;
                                border-radius: 8px;
                                font-size: 16px;
                                font-weight: 700;
                                cursor: pointer;
                                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
                            ">
                                âœ… Direkt buchen (in Kalender)
                            </button>
                            <button onclick="createBookingFromAI()" style="
                                flex: 1;
                                padding: 16px;
                                background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                                color: white;
                                border: none;
                                border-radius: 8px;
                                font-size: 16px;
                                font-weight: 700;
                                cursor: pointer;
                                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
                            ">
                                ğŸ“‹ Erst prÃ¼fen (Modal)
                            </button>
                            <button onclick="calculateAIPrice()" style="
                                padding: 16px 24px;
                                background: #3b82f6;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                font-size: 16px;
                                font-weight: 700;
                                cursor: pointer;
                            ">
                                ğŸ’° Preis berechnen
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Examples -->
                <div style="margin-top: 30px; padding: 20px; background: #f9fafb; border-radius: 8px;">
                    <div style="font-size: 14px; font-weight: 700; color: #374151; margin-bottom: 12px;">
                        ğŸ’¡ Beispiel-Nachrichten:
                    </div>
                    <div style="display: grid; gap: 10px;">
                        <button onclick="loadAIExample(1)" style="
                            text-align: left;
                            padding: 12px;
                            background: white;
                            border: 2px solid #e5e7eb;
                            border-radius: 6px;
                            font-size: 13px;
                            cursor: pointer;
                            transition: all 0.2s;
                        " onmouseover="this.style.borderColor='#10b981'" onmouseout="this.style.borderColor='#e5e7eb'">
                            ğŸ“§ E-Mail: "Taxi fÃ¼r morgen 14:30, Bahnhof â†’ Hotel, 2 Personen"
                        </button>
                        <button onclick="loadAIExample(2)" style="
                            text-align: left;
                            padding: 12px;
                            background: white;
                            border: 2px solid #e5e7eb;
                            border-radius: 6px;
                            font-size: 13px;
                            cursor: pointer;
                            transition: all 0.2s;
                        " onmouseover="this.style.borderColor='#10b981'" onmouseout="this.style.borderColor='#e5e7eb'">
                            ğŸ’¬ Telegram: "Brauche Taxi 15.12. 10:00 Uhr Flughafen abholen 4 Personen"
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ğŸ†• v5.63.0: BUCHUNGSANFRAGEN VIEW (Telegram-Bot fÃ¼r FahrgÃ¤ste) -->
    <div id="booking-requests-view" class="view admin-only" style="display:none; max-width: 1200px; margin: 20px auto; padding: 0 15px;">
        <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 20px; text-align: center;">
                <div style="font-size: 48px; margin-bottom: 8px;">ğŸ“¬</div>
                <h2 style="font-size: 24px; margin: 0 0 5px 0;">BUCHUNGSANFRAGEN</h2>
                <p style="font-size: 13px; opacity: 0.9; margin: 0;">FahrgÃ¤ste kÃ¶nnen Ã¼ber Telegram Fahrten anfragen</p>
            </div>

            <!-- API-Key Einstellungen -->
            <div id="api-key-section" style="padding: 20px; background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                    <div style="font-size: 24px;">ğŸ”‘</div>
                    <div style="flex: 1;">
                        <div style="font-size: 16px; font-weight: 700; color: #374151; margin-bottom: 4px;">
                            Anthropic API-Key
                        </div>
                        <div style="font-size: 13px; color: #6b7280;">
                            BenÃ¶tigt fÃ¼r automatische Buchungsanalyse mit Claude AI
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="password" id="anthropic-api-key" placeholder="sk-ant-api03-..." 
                        style="flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; font-family: monospace;">
                    
                    <!-- ğŸ†• v5.64.7: ANZEIGEN BUTTON -->
                    <button onclick="toggleAPIKeyVisibility()" id="toggle-key-btn" style="
                        padding: 12px 16px;
                        background: #f3f4f6;
                        color: #374151;
                        border: 2px solid #e5e7eb;
                        border-radius: 8px;
                        font-size: 18px;
                        cursor: pointer;
                        white-space: nowrap;
                    " title="Anzeigen/Verstecken">
                        ğŸ‘ï¸
                    </button>
                    
                    <!-- ğŸ†• v5.64.7: KOPIEREN BUTTON -->
                    <button onclick="copyAPIKey()" style="
                        padding: 12px 16px;
                        background: #dbeafe;
                        color: #1e40af;
                        border: 2px solid #3b82f6;
                        border-radius: 8px;
                        font-size: 18px;
                        cursor: pointer;
                        white-space: nowrap;
                    " title="In Zwischenablage kopieren">
                        ğŸ“‹
                    </button>
                    
                    <button onclick="saveAnthropicAPIKey()" style="
                        padding: 12px 24px;
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 14px;
                        font-weight: 700;
                        cursor: pointer;
                        white-space: nowrap;
                    ">
                        ğŸ’¾ Speichern
                    </button>
                </div>
                
                <div id="api-key-status" style="font-size: 12px; color: #6b7280;">
                    Status: <span id="api-key-status-text">Nicht konfiguriert</span>
                </div>
                
                <div style="margin-top: 10px; padding: 10px; background: #fef3c7; border-radius: 6px; font-size: 12px; color: #92400e;">
                    â„¹ï¸ <strong>API-Key holen:</strong> 
                    <a href="https://console.anthropic.com/" target="_blank" style="color: #92400e; text-decoration: underline;">
                        console.anthropic.com
                    </a> â†’ API Keys â†’ Create Key
                </div>
            </div>

            <!-- Test-Bereich -->
            <div style="padding: 20px;">
                <div style="font-size: 18px; font-weight: 700; color: #374151; margin-bottom: 15px;">
                    ğŸ§ª Test-Bereich
                </div>
                
                <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border: 2px solid #10b981; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: start; gap: 12px;">
                        <div style="font-size: 28px;">âœ…</div>
                        <div style="flex: 1;">
                            <div style="font-size: 15px; font-weight: 700; color: #065f46; margin-bottom: 8px;">
                                Buchungssystem aktiv!
                            </div>
                            <div style="font-size: 13px; color: #048257; line-height: 1.6;">
                                Claude AI analysiert eingehende Nachrichten und erstellt automatisch Buchungen.<br>
                                Die Buchungen werden direkt in Firebase gespeichert und an die Fahrer verteilt.
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="background: #f9fafb; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                        Telegram-Nachricht simulieren:
                    </label>
                    <textarea id="test-telegram-message" placeholder="Beispiel:&#10;&#10;Hallo, ich brauche ein Taxi morgen um 14 Uhr vom Bahnhof zum Hotel Ahlbeck. Wir sind 2 Personen.&#10;&#10;MfG Max Mustermann&#10;+49 170 1234827" 
                        style="width: 100%; height: 150px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; font-family: sans-serif; resize: vertical;">
                    </textarea>
                    
                    <button onclick="testTelegramMessage()" id="test-telegram-btn" style="
                        width: 100%;
                        margin-top: 10px;
                        padding: 14px;
                        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 15px;
                        font-weight: 700;
                        cursor: pointer;
                        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
                    ">
                        ğŸ” Nachricht analysieren
                    </button>
                </div>

                <!-- Test-Ergebnis -->
                <div id="test-result" style="display: none;"></div>

                <!-- Anfragen-Liste -->
                <div style="margin-top: 30px;">
                    <div style="font-size: 18px; font-weight: 700; color: #374151; margin-bottom: 15px;">
                        ğŸ“‹ Offene Anfragen
                    </div>
                    
                    <div id="booking-requests-list" style="display: grid; gap: 15px;">
                        <div style="text-align: center; padding: 40px; color: #9ca3af; font-size: 14px;">
                            Keine offenen Anfragen
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ†• v5.86.30: POI-MANAGEMENT VIEW -->
    <div id="poi-management-view" class="view admin-only" style="display:none; max-width: 1200px; margin: 20px auto; padding: 0 15px;">
        <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 20px; text-align: center;">
                <div style="font-size: 48px; margin-bottom: 8px;">â­</div>
                <h2 style="font-size: 24px; margin: 0 0 5px 0;">FAVORITEN-ZIELE VERWALTEN</h2>
                <p style="font-size: 13px; opacity: 0.9; margin: 0;">HÃ¤ufig genutzte Ziele fÃ¼r schnellere Buchungen</p>
            </div>

            <!-- Aktionen -->
            <div style="padding: 20px; background: #fef3c7; border-bottom: 2px solid #fde68a; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 24px;">ğŸ“</div>
                    <div>
                        <div style="font-weight: 700; color: #92400e; font-size: 15px;">Favoriten-Ziele</div>
                        <div style="font-size: 13px; color: #78350f;">Werden mit â­ in der Schnellbuchung angezeigt</div>
                    </div>
                </div>
                <button onclick="openAddPOIModal()" style="
                    padding: 12px 20px;
                    background: #f59e0b;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-weight: 700;
                    cursor: pointer;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
                    transition: all 0.3s;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(245, 158, 11, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 8px rgba(245, 158, 11, 0.3)'">
                    â• Neues Ziel hinzufÃ¼gen
                </button>
            </div>

            <!-- POI-Liste -->
            <div id="poi-list-container" style="padding: 20px;">
                <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                    <div style="font-size: 64px; margin-bottom: 16px; opacity: 0.5;">â³</div>
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Lade Favoriten-Ziele...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ†• v5.86.14: BACKUP VIEW -->
    <div id="backup-view" class="view admin-only" style="display:none; max-width: 1200px; margin: 20px auto; padding: 0 15px;">
        <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 20px; text-align: center;">
                <div style="font-size: 48px; margin-bottom: 8px;">ğŸ”½</div>
                <h2 style="font-size: 24px; margin: 0 0 5px 0;">DATENBANK-BACKUP</h2>
                <p style="font-size: 13px; opacity: 0.9; margin: 0;">Automatisches Backup alle 4 Stunden â€¢ Letzte 5 Backups gespeichert</p>
            </div>

            <!-- Status -->
            <div style="padding: 20px; background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                    <div style="font-size: 24px;">â°</div>
                    <div style="flex: 1;">
                        <div style="font-size: 16px; font-weight: 700; color: #374151; margin-bottom: 4px;">
                            Auto-Backup Status
                        </div>
                        <div id="backup-status" style="font-size: 13px; color: #10b981; font-weight: 600;">
                            âœ… Aktiv (alle 4 Stunden)
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button onclick="createAutoBackup()" style="
                        flex: 1;
                        padding: 14px;
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 14px;
                        font-weight: 700;
                        cursor: pointer;
                    ">
                        ğŸ”½ JETZT BACKUP ERSTELLEN
                    </button>
                    
                    <button onclick="uploadBackupFile()" style="
                        flex: 1;
                        padding: 14px;
                        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 14px;
                        font-weight: 700;
                        cursor: pointer;
                    ">
                        ğŸ”¼ BACKUP HOCHLADEN
                    </button>
                </div>
                
                <div style="font-size: 12px; color: #6b7280; padding: 10px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    âš ï¸ <strong>Hinweis:</strong> Backups werden im Browser gespeichert (IndexedDB). FÃ¼r Multi-Device-Nutzung: Backup downloaden und auf anderem GerÃ¤t hochladen.
                </div>
            </div>

            <!-- Backup-Liste -->
            <div style="padding: 20px;">
                <h3 style="font-size: 18px; font-weight: 700; color: #374151; margin: 0 0 15px 0;">
                    ğŸ“¦ VerfÃ¼gbare Backups
                </h3>
                
                <div id="backup-list">
                    <div style="padding:40px;text-align:center;color:#999;">
                        <div style="font-size:48px;margin-bottom:10px;">â³</div>
                        <div>Lade Backups...</div>
                    </div>
                </div>
            </div>

            <!-- Info -->
            <div style="padding: 20px; background: #f9fafb; border-top: 2px solid #e5e7eb;">
                <h3 style="font-size: 16px; font-weight: 700; color: #374151; margin: 0 0 12px 0;">
                    â„¹ï¸ So funktioniert's
                </h3>
                <div style="font-size: 13px; color: #6b7280; line-height: 1.6;">
                    <p style="margin: 0 0 8px 0;">
                        <strong>Automatisch:</strong> Alle 4 Stunden wird automatisch ein Backup erstellt (erstes nach 5 Minuten).
                    </p>
                    <p style="margin: 0 0 8px 0;">
                        <strong>Speicherung:</strong> Backups werden im Browser (IndexedDB) gespeichert und bleiben auch nach Neustart erhalten.
                    </p>
                    <p style="margin: 0 0 8px 0;">
                        <strong>Anzahl:</strong> Nur die letzten 5 Backups werden behalten, Ã¤ltere werden automatisch gelÃ¶scht.
                    </p>
                    <p style="margin: 0 0 8px 0;">
                        <strong>Download:</strong> Du kannst Backups herunterladen und lokal/in der Cloud speichern.
                    </p>
                    <p style="margin: 0;">
                        <strong>Restore:</strong> Mit einem Klick kannst du ein Backup wiederherstellen (Ã¼berschreibt aktuelle Daten!).
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ†• v5.90.40: ARCHIV VIEW - GelÃ¶schte Fahrten -->
    <div id="archive-view" class="view admin-only" style="display:none; max-width: 1200px; margin: 20px auto; padding: 0 15px;">
        <div style="background:linear-gradient(135deg,#dc2626,#991b1b);color:white;padding:20px;border-radius:12px;margin-bottom:20px;box-shadow:0 4px 12px rgba(220,38,38,0.3);">
            <h2 style="margin:0;font-size:24px;font-weight:700;">ğŸ—„ï¸ Fahrt-Archiv</h2>
            <p style="margin:8px 0 0 0;opacity:0.9;font-size:14px;">Alle stornierten & gelÃ¶schten Fahrten</p>
        </div>
        
        <!-- Statistik -->
        <div id="archive-stats" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px;">
            <!-- Wird dynamisch gefÃ¼llt -->
        </div>
        
        <!-- Filter -->
        <div style="background:white;padding:15px;border-radius:12px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
                <div>
                    <label style="display:block;font-weight:600;margin-bottom:8px;color:#374151;">ğŸ“… Zeitraum</label>
                    <select id="archive-time-filter" onchange="loadArchive()" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;">
                        <option value="today">Heute</option>
                        <option value="week" selected>Diese Woche</option>
                        <option value="month">Dieser Monat</option>
                        <option value="all">Alle</option>
                    </select>
                </div>
                
                <div>
                    <label style="display:block;font-weight:600;margin-bottom:8px;color:#374151;">ğŸ” Grund</label>
                    <select id="archive-reason-filter" onchange="filterArchive()" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;">
                        <option value="all">Alle GrÃ¼nde</option>
                        <option value="auto24h">Auto: Ã„lter als 24h</option>
                        <option value="autotime">Auto: Zeit verpasst</option>
                        <option value="manual">Manuell storniert</option>
                        <option value="other">Andere</option>
                    </select>
                </div>
                
                <div>
                    <label style="display:block;font-weight:600;margin-bottom:8px;color:#374151;">ğŸ” Suche</label>
                    <input type="text" id="archive-search" oninput="filterArchive()" placeholder="Kunde, Telefon, Route..." style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;">
                </div>
            </div>
        </div>
        
        <!-- Fahrten-Liste -->
        <div id="archive-list" style="display:flex;flex-direction:column;gap:15px;">
            <div style="text-align:center;padding:40px;color:#6b7280;">
                Lade Archiv...
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        let firebaseLoadTimeout, firebaseLoaded = false;
        firebaseLoadTimeout = setTimeout(() => { 
            if (!firebaseLoaded && typeof initApp === 'function') initApp(false); 
        }, 5000);
    </script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js" onload="firebaseLoaded = true;" onerror="if(typeof initApp === 'function') initApp(false);"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- ğŸ“… v5.87.23: Google Calendar API -->
    <script src="https://apis.google.com/js/api.js"></script>
    
    <script>
        // ğŸ› DEBUG STUB - Wird spÃ¤ter Ã¼berschrieben, aber verhindert Fehler bei frÃ¼hen Aufrufen
        let debugPanelLogs = [];
        let isDebugPanelOpen = false;
        let debugFilter = 'all';
        let debugPanelMinimized = false;
        
        function debugLog(type, message) {
            const time = new Date().toLocaleTimeString('de-DE');
            debugPanelLogs.push({ time, type, message });
            const icon = type === 'error' ? 'ğŸ’¾' : type === 'warn' ? 'âš ï¸' : 'âœ…';
            console.log(`${icon} [DEBUG] ${message}`);
        }
        
        function addLogToPanel() {} // Stub
        function refreshDebugPanel() {} // Stub
        
        // ğŸ› DEBUG MODE - Global Variable (fÃ¼r alte Debug-Button KompatibilitÃ¤t)
        let debugMode = false; // Wird vom Console-Interceptor verwaltet
        
        // ğŸ†• v5.89.0: USER ROLE - Global Variable (wird spÃ¤ter durch applyRoleRestrictions gesetzt)
        let userRole = 'fahrgast'; // Standard-Rolle
        
        // CONFIGURATION
        // ğŸš— FAHRZEUGE - werden aus Firebase geladen, Fallback auf Hardcoded
        // ğŸ†• v5.90.262: KENNZEICHEN = ID! Zukunftssicher!
        function normalizeVehicleId(plate) {
            if (!plate) return '';
            return plate.toLowerCase().trim().replace(/\s+/g, '-');
        }
        
        function findVehicle(idOrPlate) {
            if (!idOrPlate) return null;
            if (VEHICLES[idOrPlate]) return VEHICLES[idOrPlate];
            const normalized = normalizeVehicleId(idOrPlate);
            if (VEHICLES[normalized]) return VEHICLES[normalized];
            for (let id in VEHICLES) {
                const v = VEHICLES[id];
                if (normalizeVehicleId(v.plate) === normalized) return v;
                if (v.legacyId === idOrPlate) return v;
            }
            return null;
        }
        
        // ğŸ”¥ v5.90.372: OFFIZIELLE FAHRZEUG-LISTE (WHITELIST)
        // NUR DIESE FAHRZEUGE SIND ERLAUBT!
        const OFFICIAL_VEHICLES = {
            'pw-my-222-e': { 
                name: 'Tesla Model Y', 
                plate: 'PW-MY 222 E',
                priority: 1
            },
            'pw-ik-222': { 
                name: 'Toyota Prius IK', 
                plate: 'PW-IK 222',
                priority: 2
            },
            'pw-ki-222': { 
                name: 'Toyota Prius II', 
                plate: 'PW-KI 222',
                priority: 3
            },
            'pw-sk-222': { 
                name: 'Renault Traffic 8 Pax', 
                plate: 'PW-SK 222',
                priority: 4
            },
            'vg-lk-111': { 
                name: 'Mercedes Vito 8 Pax', 
                plate: 'VG-LK 111',
                priority: 5
            }
        };
        
        const DEFAULT_VEHICLES = { ...OFFICIAL_VEHICLES }; // FÃ¼r KompatibilitÃ¤t
        let VEHICLES = { ...DEFAULT_VEHICLES }; // Wird aus Firebase Ã¼berschrieben
        const TARIF = { 
            grundgebuehr: 4.00,
            // Gestaffelte Kilometerpreise (offizieller Tarif August 2022)
            km_1_2: 3.30,      // Kilometer 1-2
            km_3_4: 2.80,      // Kilometer 3-4
            km_ab_5: 2.20,     // Ab Kilometer 5
            // ZuschlÃ¤ge
            nachtZuschlag: 0.20, 
            sonntagZuschlag: 0.25, 
            feiertagZuschlag: 0.50,
            // Nachttarif
            nacht_grundgebuehr: 5.50,
            nacht_km_1_2: 3.30,
            nacht_km_3_4: 2.80,
            nacht_km_ab_5: 2.40
        };
        
        // ğŸ†• v5.90.38: DEUTSCHE FEIERTAGE
        const FEIERTAGE = [
            '01-01', // Neujahr
            '05-01', // Tag der Arbeit
            '10-03', // Tag der Deutschen Einheit
            '12-24', // Heiligabend
            '12-25', // 1. Weihnachtstag
            '12-26', // 2. Weihnachtstag
            '12-31'  // Silvester
            // Ostern, Pfingsten etc. sind variabel - spÃ¤ter ergÃ¤nzen
        ];
        
        // ğŸ†• v5.90.38: PrÃ¼fe ob Feiertag
        function isFeiertag(date) {
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateStr = `${month}-${day}`;
            
            const result = FEIERTAGE.includes(dateStr);
            
            if (result) {
                console.log(`ğŸ‰ FEIERTAG ERKANNT: ${day}.${month}. â†’ Nachttarif!`);
            }
            
            return result;
        }
        
        const USEDOM_ORTE = ['Heringsdorf', 'Ahlbeck', 'Bansin', 'Zinnowitz', 'Ãœckeritz', 'Loddin', 'Zempin', 'Koserow', 'Karlshagen', 'PeenemÃ¼nde', 'Trassenheide'];
        
        // ğŸ”„ VERSION-CHECK SYSTEM (jetzt im <head> - siehe oben!)
        const APP_VERSION = '5.89.1';
        const APP_BUILD = '20251228-1500-SCRIPT-MANAGER';
        
        // âœ… v5.10.0: Auto-Update System KOMPLETT ENTFERNT!
        // War zu fehleranfÃ¤llig mit Service Worker Cache-Problemen.
        // Jetzt: Stabile Version, User lÃ¤dt bei Bedarf manuell neu.
        // â†’ Kein rekursiver Aufruf mehr
        // â†’ Nur 1x beim Start
        // â†’ "SpÃ¤ter" Button funktioniert korrekt
        
        // Bekannte Koordinaten fÃ¼r wichtige Orte (Fallback)
        const KNOWN_PLACES = {
            'heringsdorf': { lat: 53.9533, lon: 14.1633, name: 'Heringsdorf', fullAddress: 'Heringsdorf, Usedom' },
            'bahnhof heringsdorf': { lat: 53.9533, lon: 14.1633, name: 'Bahnhof Heringsdorf', fullAddress: 'Bahnhof Heringsdorf, 17424 Heringsdorf' },
            'ahlbeck': { lat: 53.9444, lon: 14.1933, name: 'Ahlbeck', fullAddress: 'Ahlbeck, Usedom' },
            'seebrÃ¼cke ahlbeck': { lat: 53.9444, lon: 14.1933, name: 'SeebrÃ¼cke Ahlbeck', fullAddress: 'SeebrÃ¼cke Ahlbeck, 17419 Ahlbeck' },
            'bansin': { lat: 53.9633, lon: 14.1433, name: 'Bansin', fullAddress: 'Bansin, Usedom' },
            'seebrÃ¼cke bansin': { lat: 53.9633, lon: 14.1433, name: 'SeebrÃ¼cke Bansin', fullAddress: 'SeebrÃ¼cke Bansin, 17429 Bansin' },
            'zinnowitz': { lat: 54.0908, lon: 13.9167, name: 'Zinnowitz', fullAddress: 'Zinnowitz, Usedom' },
            'bahnhof zinnowitz': { lat: 54.0908, lon: 13.9167, name: 'Bahnhof Zinnowitz', fullAddress: 'Bahnhof Zinnowitz, 17482 Zinnowitz' },
            'Ã¼ckeritz': { lat: 53.9878, lon: 14.0519, name: 'Ãœckeritz', fullAddress: 'Ãœckeritz, Usedom' },
            'loddin': { lat: 54.0083, lon: 13.9917, name: 'Loddin', fullAddress: 'Loddin, Usedom' },
            'zempin': { lat: 54.0194, lon: 13.9611, name: 'Zempin', fullAddress: 'Zempin, Usedom' },
            'koserow': { lat: 54.0681, lon: 13.9764, name: 'Koserow', fullAddress: 'Koserow, Usedom' },
            'karlshagen': { lat: 54.1078, lon: 13.8333, name: 'Karlshagen', fullAddress: 'Karlshagen, Usedom' },
            'peenemÃ¼nde': { lat: 54.1422, lon: 13.7753, name: 'PeenemÃ¼nde', fullAddress: 'PeenemÃ¼nde, Usedom' },
            'trassenheide': { lat: 54.0997, lon: 13.8875, name: 'Trassenheide', fullAddress: 'Trassenheide, Usedom' },
            'usedom': { lat: 53.9533, lon: 14.1633, name: 'Usedom', fullAddress: 'Usedom, Deutschland' },
            // ğŸ‡µğŸ‡± POLEN - Deutsche UND polnische Namen!
            'swinemÃ¼nde': { lat: 53.9108, lon: 14.2482, name: 'SwinemÃ¼nde', fullAddress: 'ÅšwinoujÅ›cie, Polen' },
            'swinemunde': { lat: 53.9108, lon: 14.2482, name: 'SwinemÃ¼nde', fullAddress: 'ÅšwinoujÅ›cie, Polen' },
            'Å›winoujÅ›cie': { lat: 53.9108, lon: 14.2482, name: 'ÅšwinoujÅ›cie', fullAddress: 'ÅšwinoujÅ›cie, Polen' },
            'swinoujscie': { lat: 53.9108, lon: 14.2482, name: 'ÅšwinoujÅ›cie', fullAddress: 'ÅšwinoujÅ›cie, Polen' },
            'misdroy': { lat: 53.9283, lon: 14.4017, name: 'Misdroy', fullAddress: 'MiÄ™dzyzdroje, Polen' },
            'miÄ™dzyzdroje': { lat: 53.9283, lon: 14.4017, name: 'MiÄ™dzyzdroje', fullAddress: 'MiÄ™dzyzdroje, Polen' },
            'miedzyzdroje': { lat: 53.9283, lon: 14.4017, name: 'MiÄ™dzyzdroje', fullAddress: 'MiÄ™dzyzdroje, Polen' },
            'wollin': { lat: 53.8406, lon: 14.6175, name: 'Wollin', fullAddress: 'Wolin, Polen' },
            'wolin': { lat: 53.8406, lon: 14.6175, name: 'Wolin', fullAddress: 'Wolin, Polen' },
            'stettin': { lat: 53.4285, lon: 14.5528, name: 'Stettin', fullAddress: 'Szczecin, Polen' },
            'szczecin': { lat: 53.4285, lon: 14.5528, name: 'Szczecin', fullAddress: 'Szczecin, Polen' },
            'kolberg': { lat: 54.1756, lon: 15.5831, name: 'Kolberg', fullAddress: 'KoÅ‚obrzeg, Polen' },
            'koÅ‚obrzeg': { lat: 54.1756, lon: 15.5831, name: 'KoÅ‚obrzeg', fullAddress: 'KoÅ‚obrzeg, Polen' },
            'kolobrzeg': { lat: 54.1756, lon: 15.5831, name: 'KoÅ‚obrzeg', fullAddress: 'KoÅ‚obrzeg, Polen' }
        };

        // ğŸ†• v5.88.16: Deutsche â†’ Polnische Ortsnamen Mapping (OBEN definiert fÃ¼r alle Funktionen!)
        const GERMAN_TO_POLISH = {
            'swinemÃ¼nde': 'ÅšwinoujÅ›cie',
            'swinemunde': 'ÅšwinoujÅ›cie',
            'swinoujscie': 'ÅšwinoujÅ›cie',
            'swine': 'ÅšwinoujÅ›cie',
            'misdroy': 'MiÄ™dzyzdroje',
            'stettin': 'Szczecin',
            'wollin': 'Wolin',
            'kolberg': 'KoÅ‚obrzeg',
            'danzig': 'GdaÅ„sk',
            'breslau': 'WrocÅ‚aw',
            'posen': 'PoznaÅ„',
            'krakau': 'KrakÃ³w',
            'warschau': 'Warszawa'
        };
        
        // Konvertiere deutsche Ortsnamen zu polnischen fÃ¼r bessere Suche
        function convertGermanToPolish(query) {
            const lower = query.toLowerCase();
            // ğŸ†• v5.88.24: Sortiere nach LÃ¤nge (lÃ¤ngste zuerst) damit "swinemÃ¼nde" vor "swine" geprÃ¼ft wird
            const sortedEntries = Object.entries(GERMAN_TO_POLISH).sort((a, b) => b[0].length - a[0].length);
            
            let result = query;
            for (const [german, polish] of sortedEntries) {
                // PrÃ¼fe ob das deutsche Wort enthalten ist (case-insensitive)
                const regex = new RegExp(german.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                if (regex.test(result)) {
                    result = result.replace(regex, polish);
                    break; // Nur eine Ersetzung pro Aufruf
                }
            }
            return result;
        }

        // STATE
        // ğŸ”§ FIX v5.90.624: Globale Variablen fÃ¼r Cross-Script Zugriff
        let db = window.db = null;
        let isFirebaseReady = window.isFirebaseReady = false;
        let isConnected = false, currentVehicle = null, currentView = 'passenger', rides = [], drivers = {};
        let currentBookingCustomerId = null; // FÃ¼r CRM-Update bei Stammkunden-Buchung
        let pickupCoords = null, destCoords = null, map = null, watchId = null, isOnline = false, myCurrentRide = null;
        
        // ğŸ†• v5.90.527: WAYPOINTS (Zwischenstopps)
        let waypoints = []; // Array von {id, address, coords, autocompleteId, dropdownId}
        let waypointCounter = 0;
        
        // ğŸ†• v5.90.559: QUICK-BOOKING WAYPOINTS
        let qbWaypoints = [];
        let qbWaypointCounter = 0;
        
        let qbPanelPickupCoords = null, qbPanelDestCoords = null; // ğŸ†• v5.50.7: Admin-Panel Koordinaten
        let newCustomerAddressCoords = null; // ğŸ†• v5.87.20: Koordinaten fÃ¼r neuen Kunden
        
        // ğŸ†• v5.42.7: Adressen-BestÃ¤tigungs-Status
        let pickupConfirmed = false;
        let destinationConfirmed = false;
        
        // ğŸ†• v5.42.8: Aktuelles Autocomplete-Feld
        let currentAutocompleteField = null;
        
        // ğŸ†• v5.44.0: Ã–PNV-Taxi Modus
        let isOPNVMode = false;
        let currentTrackingRideId = null; // ğŸ†• Aktuelle Fahrt fÃ¼r GPS-Tracking
        let taxiMarker = null, pickupMarker = null, etaUpdateInterval = null, lastSoundDistance = 999;
        let wakeLock = null;
        let cancellations = []; // Neue Variable fÃ¼r Stornierungen
        let notifiedCancellations = new Set(); // ğŸ†• v5.21.7: Verhindert doppelte Stornierung-Alerts
        let bookingSystemOnline = true; // ğŸ†• v5.38.2: Buchungssystem AN/AUS (Standard: AN)
        
        // ğŸ†• v5.90.632: PERFORMANCE-FIX - Rides Listener statt stÃ¤ndiges neu laden!
        let ridesListener = null;
        let ridesLoadedOnce = false;
        
        // ğŸ†• v5.38.5: DEBUG-MODUS (Legacy - umbenannt um Konflikt mit Floating Debug zu vermeiden)
        // debugMode ist bereits global definiert!
        
        // Legacy Debug-Console Wrapper (umbenannt in v5.46.5)
        const legacyDebugLog = (...args) => {
            if (debugMode) console.log(...args);
        };
        const legacyDebugError = (...args) => {
            if (debugMode) console.error(...args);
        };
        const legacyDebugWarn = (...args) => {
            if (debugMode) console.warn(...args);
        };
        
        // ğŸ†• v5.19.0: DUAL-GPS MODUS
        let gpsMode = 'off'; // 'off', 'standby' (LTE), 'active' (GPS)
        let standbyIntervalId = null; // Interval fÃ¼r Standby-Modus
        
        // ğŸ›¡ï¸ DUPLIKAT-SCHUTZ fÃ¼r Telegram
        const sentTelegramRides = new Set(); // Speichert Ride-IDs die schon gesendet wurden
        const warnedOpenRides = new Set(); // ğŸ†• Speichert Ride-IDs fÃ¼r die schon Warnungen gesendet wurden
        
        // ğŸ› SUPER DEBUG SYSTEM (ALT - fÃ¼r Legacy Debug-Button)
        let debugErrors = [];
        // oldDebugLogs entfernt - wird vom neuen Debug Panel ersetzt!
        let debugFirebaseQueries = [];
        let debugStateChanges = [];
        const MAX_DEBUG_LOGS = 200;
        
        // Catche ALLE JavaScript Errors
        window.addEventListener('error', (e) => {
            const errorInfo = {
                time: new Date().toISOString(),
                message: e.message,
                filename: e.filename || 'unknown',
                line: e.lineno || 0,
                column: e.colno || 0,
                stack: e.error?.stack || 'no stack trace'
            };
            debugErrors.push(errorInfo);
            console.error('ğŸ”´ ERROR CAUGHT:', errorInfo);
        });
        
        // Catche Promise Rejections
        window.addEventListener('unhandledrejection', (e) => {
            const errorInfo = {
                time: new Date().toISOString(),
                message: 'Unhandled Promise Rejection: ' + (e.reason?.message || e.reason),
                stack: e.reason?.stack || 'no stack trace'
            };
            debugErrors.push(errorInfo);
            console.error('ğŸ”´ PROMISE REJECTION:', errorInfo);
        });
        
        // ğŸ” Console-Override wird jetzt vom neuen Debug Panel (Zeile 3342) gehandhabt!
        // Altes Console-Override hier entfernt um Kollisionen zu vermeiden.
        
        // Helper: Log State Change
        function logStateChange(description, oldValue, newValue) {
            debugStateChanges.push({
                time: new Date().toISOString(),
                description,
                oldValue,
                newValue
            });
        }
        
        // Helper: Log Firebase Query
        function logFirebaseQuery(path, result) {
            debugFirebaseQueries.push({
                time: new Date().toISOString(),
                path,
                result: typeof result === 'object' ? JSON.stringify(result).substring(0, 200) : String(result)
            });
        }
        
        // ğŸ†• AUTO-ZUWEISUNG & PUSH
        let assignmentTimers = {}; // Timer fÃ¼r 30-Sek-Countdown
        let notificationPermission = null;
        let serviceWorkerRegistration = null;
        let pushSubscription = null;
        let regularCustomer = null; // Stammkunden-Daten
        
        // ğŸ“… HISTORY TAB STATE
        let currentHistoryTab = 'upcoming'; // 'upcoming' oder 'past'
        
        // ğŸ” AUTH STATE
        let auth = null;
        let currentUser = null;
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ’¾ v5.87.68: FRITZBOX CALL MONITOR - FUNKTIONEN NACH OBEN VERSCHOBEN!
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // WICHTIG: Funktionen mÃ¼ssen VOR dem Aufruf definiert sein!
        // Daher jetzt hier oben statt unten bei Zeile 37000+
        
        function initCallPopupListener() {
            console.log('ğŸ” initCallPopupListener() aufgerufen!');
            console.log('ğŸ” isFirebaseReady:', isFirebaseReady);
            console.log('ğŸ” db:', typeof db);
            
            if (!isFirebaseReady) {
                console.error('ğŸ’¾ Firebase not ready for CallPopup listener');
                return;
            }
            
            console.log('ğŸ’¾ Initialisiere CallPopup Listener...');
            console.log('ğŸ’¾ Registriere Firebase Listener auf: callPopup');
            
            db.ref('callPopup').on('value', snapshot => {
                console.log('ğŸ”¥ FIREBASE EVENT GETRIGGERT!');
                console.log('ğŸ”¥ snapshot:', snapshot);
                
                const data = snapshot.val();
                console.log('ğŸ”¥ data:', data);
                
                if (!data) {
                    console.log('âš ï¸ Keine Daten in callPopup (null)');
                    return;
                }
                
                console.log('ğŸ’¾ ANRUF EMPFANGEN!', data);
                console.log('ğŸ’¾ Rufe showCallPopup() auf...');
                
                // Zeige Popup
                try {
                    showCallPopup(data);
                    console.log('âœ… showCallPopup() erfolgreich!');
                } catch (err) {
                    console.error('ğŸ’¾ Fehler in showCallPopup():', err);
                }
                
                // Auto-Delete nach 2 Sekunden
                console.log('â±ï¸ Auto-Delete in 2 Sekunden...');
                setTimeout(() => {
                    db.ref('callPopup').remove();
                    console.log('ğŸ—‘ï¸ callPopup gelÃ¶scht!');
                }, 2000);
            });
            
            console.log('âœ… CallPopup Listener aktiv');
        }
        
        
        function showCallPopup(data) {
            console.log('ğŸ¯ showCallPopup() gestartet!');
            console.log('ğŸ¯ data:', data);
            
            const { type, caller, called, timestamp, customer, lastRides } = data;
            console.log('ğŸ¯ type:', type);
            console.log('ğŸ¯ caller:', caller);
            console.log('ğŸ¯ customer:', customer);
            
            // Erstelle Popup HTML
            let popupHTML = `
                <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s;" id="call-popup">
                    <div style="background:white;border-radius:16px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.4);animation:slideUp 0.3s;">
                        
                        <!-- Header -->
                        <div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;border-radius:16px 16px 0 0;">
                            <div style="display:flex;align-items:center;justify-content:space-between;">
                                <div style="display:flex;align-items:center;gap:12px;">
                                    <div style="font-size:40px;">ğŸ’¾</div>
                                    <div>
                                        <div style="font-size:24px;font-weight:700;">Eingehender Anruf</div>
                                        <div style="font-size:14px;opacity:0.9;">${new Date(timestamp).toLocaleString('de-DE')}</div>
                                    </div>
                                </div>
                                <button onclick="closeCallPopup()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:40px;height:40px;border-radius:50%;cursor:pointer;font-size:24px;display:flex;align-items:center;justify-content:center;">Ã—</button>
                            </div>
                        </div>
                        
                        <!-- Body -->
                        <div style="padding:24px;">
                            <div style="margin-bottom:20px;padding:16px;background:#f3f4f6;border-radius:12px;">
                                <div style="font-size:14px;color:#6b7280;margin-bottom:4px;">Anrufer</div>
                                <div style="font-size:24px;font-weight:700;color:#1f2937;">${caller}</div>
                            </div>
            `;
            
            if (type === 'existing' && customer) {
                // BEKANNTER KUNDE
                popupHTML += `
                    <div style="background:#d1fae5;padding:16px;border-radius:12px;margin-bottom:20px;border:2px solid #10b981;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                            <span style="font-size:24px;">âœ…</span>
                            <span style="font-size:18px;font-weight:700;color:#065f46;">Bekannter Kunde</span>
                        </div>
                        
                        <div style="margin-bottom:12px;">
                            <div style="font-size:24px;font-weight:700;color:#048257;">${customer.name || 'Kein Name'}</div>
                            ${customer.address ? `<div style="font-size:14px;color:#065f46;margin-top:4px;">ğŸ“ ${customer.address}</div>` : ''}
                            ${customer.email ? `<div style="font-size:14px;color:#065f46;margin-top:4px;">ğŸ“§ ${customer.email}</div>` : ''}
                        </div>
                        
                        ${lastRides && lastRides.length > 0 ? `
                            <div style="margin-top:16px;padding-top:16px;border-top:2px solid #10b981;">
                                <div style="font-weight:600;color:#065f46;margin-bottom:8px;">ğŸš• Letzte Fahrten:</div>
                                ${lastRides.slice(0, 3).map(ride => `
                                    <div style="background:white;padding:8px;border-radius:6px;margin-bottom:6px;font-size:13px;">
                                        <div style="font-weight:600;">${ride.pickup || 'Unbekannt'} â†’ ${ride.destination || 'Unbekannt'}</div>
                                        <div style="color:#6b7280;font-size:12px;">${new Date(ride.timestamp).toLocaleDateString('de-DE')}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Buttons -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                        <button onclick="callCustomer('${caller}')" style="background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;padding:16px;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(59,130,246,0.3);">
                            ğŸ’¾ ZurÃ¼ckrufen
                        </button>
                        <button onclick="openQuickBookingWithCustomer('${customer.id}')" style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:16px;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(16,185,129,0.3);">
                            ğŸš• Neue Fahrt buchen
                        </button>
                    </div>
                    <button onclick="closeCallPopup()" style="width:100%;background:#f3f4f6;color:#1f2937;padding:16px;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;margin-top:12px;">
                        SchlieÃŸen
                    </button>
                `;
            } else {
                // ğŸ†• v5.90.266: NEUER KUNDE â†’ Schnellbuchung mit Telefon!
                console.log('ğŸ†• Unbekannter Anruf â†’ Ã–ffne Schnellbuchung mit Telefonnummer!');
                
                // SchlieÃŸe Popup
                closeCallPopup();
                
                // ğŸ†• v5.90.266: Ã–ffne Schnellbuchung mit Telefonnummer (nicht Neuer-Kunde-Modal!)
                setTimeout(() => {
                    openQuickBookingWithPhone(caller);
                }, 300);
                
                return; // Popup wird nicht angezeigt - direkt zur Schnellbuchung!
            }
            
            popupHTML += `
                        </div>
                    </div>
                </div>
                
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideUp {
                        from { transform: translateY(50px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                </style>
            `;
            
            // FÃ¼ge Popup ins DOM ein
            const existingPopup = document.getElementById('call-popup');
            if (existingPopup) existingPopup.remove();
            
            document.body.insertAdjacentHTML('beforeend', popupHTML);
            
            // Sound abspielen
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGGS56+mcTgwOUKXh8LhlHAU5kdPyynkrBSR3yO/ekj8JFFyx6OmnUxMJQ5/e8rxrIAUrlM/y2Yg1Bxhju+rqm0wLDU+k4O+7aRsFOZDT8sp4KgUjdsju35NAChNYr+jprFQUCj+c3vC6aB8FKpHP8tmINQcXYrvo7aVPDAxPo+Duu2gaBTiPz/LKdyoEI3bI7+CSQAoTVq3n7axUFAk9mt7wuWgfBSmRz/HajDQHF2K7+eetShALPp/d8cxwJwUdhcXy146RQQoRUarnr6pTEQo7mN3wuGYeCCWPz/HajDQHFl+65+OkSxALO5zd8ctwJwUdhsTy156QQQoQT6nm8KlRFA');
                audio.volume = 0.3;
                audio.play().catch(() => {});
            } catch (e) {}
            
            console.log('âœ… CallPopup angezeigt!');
        }
        
        function closeCallPopup() {
            const popup = document.getElementById('call-popup');
            if (popup) popup.remove();
            
            // LÃ¶sche Firebase Event
            if (typeof db !== 'undefined') {
                db.ref('callPopup').remove();
                console.log('âœ… CallPopup Event gelÃ¶scht');
            }
        }
        
        console.log('âœ… v5.87.68: CallMonitor Funktionen definiert (OBEN im Script)!');
        
        //  ANRUFHISTORIE FUNKTIONEN
        let callHistoryListener = null;
        
        function initCallHistory() {
            console.log('ğŸ’¾ [CallHistory] Initialisiere Anrufhistorie Listener...');
            
            if (!isFirebaseReady) {
                console.error('ğŸ’¾ [CallHistory] Firebase not ready for CallHistory listener');
                return;
            }
            
            // PrÃ¼fe ob Container existiert
            const container = document.getElementById('call-history-container');
            if (!container) {
                console.warn('âš ï¸ [CallHistory] Container nicht gefunden - erstelle spÃ¤ter wenn Admin-View geÃ¶ffnet wird');
                // Kein return - Listener trotzdem erstellen!
            }
            
            // LÃ¶sche alten Listener falls vorhanden
            if (callHistoryListener) {
                console.log('ğŸ”„ [CallHistory] LÃ¶sche alten Listener...');
                db.ref('callHistory').off('value', callHistoryListener);
            }
            
            console.log('ğŸ“¡ [CallHistory] Erstelle LIVE Listener auf callHistory...');
            
            // Erstelle neuen Listener
            callHistoryListener = db.ref('callHistory')
                .orderByChild('timestamp')
                .limitToLast(20)
                .on('value', snapshot => {
                    console.log('ğŸ”¥ [CallHistory] FIREBASE EVENT! Neue Daten empfangen!');
                    const count = snapshot.numChildren();
                    console.log(`ğŸ“± [CallHistory] Anzahl Anrufe: ${count}`);
                    displayCallHistory(snapshot);
                });
            
            console.log('âœ… [CallHistory] Anrufhistorie Listener AKTIV - wartet auf LIVE Updates!');
        }
        
        async function displayCallHistory(snapshot) {
            const container = document.getElementById('call-history-container');
            if (!container) {
                console.warn('âš ï¸ [CallHistory] Container nicht gefunden');
                return;
            }
            
            const calls = [];
            snapshot.forEach(child => {
                calls.push({
                    id: child.key,
                    ...child.val()
                });
            });
            console.log(`ğŸ“‹ [CallHistory] ${calls.length} Anrufe aus Firebase geladen`);
            
            // ğŸ†• v5.87.74: LADE ADRESSEN fÃ¼r bekannte Kunden!
            for (const call of calls) {
                if (call.customerFound && call.customerId && !call.customerAddress) {
                    try {
                        const customerSnapshot = await db.ref('customers/' + call.customerId).once('value');
                        const customer = customerSnapshot.val();
                        if (customer && customer.address) {
                            call.customerAddress = customer.address;
                        }
                    } catch (err) {
                        console.error('ğŸ’¾ [CallHistory] Fehler beim Laden der Kundenadresse:', err);
                    }
                }
            }
            console.log(`âœ… [CallHistory] ${calls.length} Anrufe im UI angezeigt`);

            // Sortiere nach Timestamp (neueste zuerst)
            calls.sort((a, b) => b.timestamp - a.timestamp);
            
            if (calls.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;padding:40px;color:#6b7280;">
                        <div style="font-size:48px;margin-bottom:10px;">ğŸ’¾</div>
                        <div style="font-weight:600;margin-bottom:5px;">Keine Anrufe</div>
                        <div style="font-size:13px;">Anrufe erscheinen hier automatisch</div>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display:grid;gap:8px;">';
            
            calls.forEach(call => {
                const date = new Date(call.timestamp);
                const timeStr = date.toLocaleString('de-DE', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const bgColor = call.customerFound ? '#d1fae5' : '#fef3c7';
                const borderColor = call.customerFound ? '#10b981' : '#f59e0b';
                const icon = call.customerFound ? 'âœ…' : 'âš ï¸';
                const statusText = call.customerFound ? 'Bekannter Kunde' : 'Neuer Kunde';
                
                html += `
                    <div style="background:${bgColor};border:2px solid ${borderColor};border-radius:8px;padding:12px;display:flex;align-items:center;gap:12px;">
                        <div style="font-size:32px;">${icon}</div>
                        <div style="flex:1;">
                            <div style="display:flex;justify-content:between;align-items:start;gap:10px;">
                                <div style="flex:1;">
                                    <div style="font-weight:700;font-size:15px;color:#1f2937;margin-bottom:4px;">
                                        ${call.customerName || call.caller}
                                    </div>
                                    ${call.customerFound && call.customerAddress ? `
                                        <div style="font-size:13px;color:#059669;margin-bottom:2px;font-weight:600;">
                                            ğŸ  ${call.customerAddress}
                                        </div>
                                    ` : ''}
                                    ${call.customerFound && call.customerName ? `
                                        <div style="font-size:13px;color:#6b7280;margin-bottom:2px;">
                                            ğŸ’¾ ${call.caller}
                                        </div>
                                    ` : ''}
                                    <div style="font-size:12px;color:#6b7280;">
                                        ${statusText} â€¢ ${timeStr}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                            ${call.customerFound ? `
                                <button onclick="callCustomer('${call.caller.replace(/'/g, "\\'")}')" 
                                        style="padding:8px 12px;background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:12px;white-space:nowrap;box-shadow:0 2px 6px rgba(59,130,246,0.3);">
                                    ğŸ’¾ Anrufen
                                </button>
                                <button onclick="editCustomer('${call.customerId}')" 
                                        style="padding:8px 12px;background:#8b5cf6;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:12px;white-space:nowrap;">
                                    âœï¸ Bearbeiten
                                </button>
                                <button onclick="openQuickBookingWithCustomer('${call.customerId}')" 
                                        style="padding:8px 12px;background:#10b981;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:12px;white-space:nowrap;">
                                    ğŸš• Buchen
                                </button>
                            ` : `
                                <button onclick="openQuickBookingWithPhone('${call.caller}')" 
                                        style="padding:8px 12px;background:#f59e0b;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:12px;white-space:nowrap;">
                                    ğŸš• Buchen
                                </button>
                            `}
                            <button onclick="deleteCallHistoryEntry('${call.id}')" 
                                    style="padding:8px 12px;background:#ef4444;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:12px;white-space:nowrap;">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            html += `
                <div style="text-align:center;margin-top:12px;font-size:12px;color:#6b7280;">
                    Zeige letzte ${calls.length} Anrufe
                </div>
            `;
            
            container.innerHTML = html;
            console.log(`ğŸ’¾ ${calls.length} Anrufe angezeigt`);
        }
        
        async function refreshCallHistory() {
            console.log('ğŸ”„ Aktualisiere Anrufhistorie...');
            
            // ğŸ†• v5.88.16: KUNDEN NEU ERKENNEN!
            try {
                // Lade alle Anrufe
                const callsSnapshot = await db.ref('callHistory').once('value');
                if (!callsSnapshot.exists()) {
                    console.log('ğŸ’¾ Keine Anrufe vorhanden');
                    initCallHistory();
                    return;
                }
                
                // Lade alle Kunden
                const customersSnapshot = await db.ref('customers').once('value');
                const customers = [];
                customersSnapshot.forEach(child => {
                    customers.push({
                        id: child.key,
                        ...child.val()
                    });
                });
                console.log(`ğŸ‘¥ ${customers.length} Kunden geladen fÃ¼r Abgleich`);
                
                // PrÃ¼fe jeden Anruf
                const updates = {};
                let updatedCount = 0;
                
                callsSnapshot.forEach(child => {
                    const call = child.val();
                    const callId = child.key;
                    
                    // ğŸ†• v5.90.274: NORMALISIERE TELEFONNUMMER!
                    let callerDigits = (call.caller || '').replace(/\D/g, ''); // Nur Ziffern
                    
                    // Entferne fÃ¼hrende "00" (internationale Vorwahl)
                    if (callerDigits.startsWith('00')) {
                        callerDigits = callerDigits.substring(2);
                    }
                    
                    // ğŸ†• v5.88.18: Ignoriere ungÃ¼ltige Anrufer-Nummern
                    if (callerDigits.length < 6) {
                        console.log(`âš ï¸ Ãœberspringe ungÃ¼ltige Anrufer-Nummer: ${call.caller}`);
                        return;
                    }
                    
                    // ğŸ†• v5.88.17: Finde ALLE passenden Kunden
                    const matchingCustomers = customers.filter(c => {
                        if (!c.phone) return false;
                        // PrÃ¼fe alle Telefonnummern (getrennt durch /)
                        const phones = c.phone.split('/').map(p => {
                            let digits = p.replace(/\D/g, ''); // Nur Ziffern
                            // ğŸ†• v5.90.274: Entferne fÃ¼hrende "00"
                            if (digits.startsWith('00')) {
                                digits = digits.substring(2);
                            }
                            return digits;
                        });
                        return phones.some(p => {
                            // ğŸ†• v5.88.18: Ignoriere zu kurze Kunden-Nummern (min 6 Ziffern)
                            if (p.length < 6) return false;
                            
                            // Vergleiche letzte 8-10 Ziffern (ignoriert Vorwahl-Unterschiede)
                            const callerEnd = callerDigits.slice(-10);
                            const customerEnd = p.slice(-10);
                            return callerEnd === customerEnd || 
                                   callerDigits === p ||
                                   (callerDigits.length >= 8 && p.length >= 8 && callerDigits.endsWith(p)) ||
                                   (callerDigits.length >= 8 && p.length >= 8 && p.endsWith(callerDigits));
                        });
                    });
                    
                    // ğŸ†• v5.88.17: Wenn mehrere Kunden â†’ bevorzuge Hotels/Firmen
                    let matchedCustomer = null;
                    if (matchingCustomers.length === 1) {
                        matchedCustomer = matchingCustomers[0];
                    } else if (matchingCustomers.length > 1) {
                        console.log(`âš ï¸ ${matchingCustomers.length} Kunden mit gleicher Nummer:`, matchingCustomers.map(c => c.name));
                        // Bevorzuge Hotels/Pensionen/Firmen
                        const hotelKeywords = ['hotel', 'pension', 'resort', 'haus', 'hof', 'villa', 'residenz', 'quality', 'radisson', 'maritim', 'steigenberger'];
                        const hotel = matchingCustomers.find(c => {
                            const nameLower = (c.name || '').toLowerCase();
                            return hotelKeywords.some(kw => nameLower.includes(kw));
                        });
                        matchedCustomer = hotel || matchingCustomers[0]; // Hotel oder erster
                        console.log(`âœ… Bevorzuge: ${matchedCustomer.name}`);
                    }
                    
                    // Update wenn Kunde gefunden (egal ob schon markiert oder nicht!)
                    // ğŸ†• v5.90.272: Auch aktualisieren wenn customerFound=false!
                    if (matchedCustomer && (!call.customerFound || call.customerFound === false)) {
                        console.log(`âœ… Kunde erkannt: ${call.caller} â†’ ${matchedCustomer.name}`);
                        updates[`callHistory/${callId}/customerFound`] = true;
                        updates[`callHistory/${callId}/customerName`] = matchedCustomer.name;
                        updates[`callHistory/${callId}/customerId`] = matchedCustomer.id;
                        if (matchedCustomer.address) {
                            updates[`callHistory/${callId}/customerAddress`] = matchedCustomer.address;
                        }
                        updatedCount++;
                    }
                });
                
                // Updates anwenden
                if (Object.keys(updates).length > 0) {
                    await db.ref().update(updates);
                    console.log(`âœ… ${updatedCount} Anrufe aktualisiert!`);
                    showToast(`âœ… ${updatedCount} Kunden erkannt!`);
                } else {
                    console.log('â„¹ï¸ Keine neuen Kunden zu erkennen');
                }
                
            } catch (err) {
                console.error('ğŸ’¾ Fehler beim Aktualisieren:', err);
            }
            
            // Liste neu laden
            initCallHistory();
        }
        
        // ğŸ—‘ï¸ v5.87.72: ANRUF LÃ–SCHEN
        async function deleteCallHistoryEntry(callId) {
            console.log('ğŸ—‘ï¸ [CallHistory] LÃ¶sche Anruf:', callId);
            
            // BestÃ¤tigung
            if (!confirm('Diesen Anruf wirklich lÃ¶schen?')) {
                console.log('ğŸ’¾ [CallHistory] LÃ¶schen abgebrochen');
                return;
            }
            
            try {
                // Aus Firebase lÃ¶schen
                await db.ref('callHistory/' + callId).remove();
                console.log('âœ… [CallHistory] Anruf aus Firebase gelÃ¶scht!');
                
                // Listener aktualisiert automatisch die Liste!
                
            } catch (error) {
                console.error('ğŸ’¾ [CallHistory] Fehler beim LÃ¶schen:', error);
                alert('Fehler beim LÃ¶schen des Anrufs!');
            }
        }
        
        // ğŸš• v5.87.72: BUCHEN-FUNKTIONEN (aus CallHistory)
        function openQuickBookingWithCustomer(customerId) {
            console.log('ğŸš• [CallHistory] Ã–ffne Schnellbuchung fÃ¼r Kunde:', customerId);
            
            // Lade Kundendaten
            db.ref('customers/' + customerId).once('value').then(snapshot => {
                const customer = snapshot.val();
                if (!customer) {
                    alert('ğŸ’¾ Kunde nicht gefunden!');
                    return;
                }
                
                console.log('âœ… Kunde geladen:', customer.name);
                
                // Wechsle zu Admin-Bereich
                switchView('admin');
                
                // Warte kurz, dann Ã¶ffne Schnellbuchungs-Modal
                setTimeout(() => {
                    // FÃ¼ge ID zum Customer-Objekt hinzu
                    customer.id = customerId;
                    
                    // Ã–ffne das Schnellbuchungs-Modal mit vorausgefÃ¼llten Kundendaten
                    openQuickBookingModal(customer);
                    
                    console.log('âœ… Schnellbuchungs-Modal geÃ¶ffnet fÃ¼r:', customer.name);
                }, 500);
                
            }).catch(err => {
                console.error('ğŸ’¾ Fehler beim Laden des Kunden:', err);
                alert('ğŸ’¾ Fehler beim Laden der Kundendaten!');
            });
        }
        
        function openQuickBookingWithPhone(phone) {
            console.log('ğŸš• [CallHistory] Ã–ffne Schnellbuchung fÃ¼r neue Nummer:', phone);
            
            // Erstelle temporÃ¤res Kunden-Objekt mit nur Telefon
            const tempCustomer = {
                id: 'new',
                name: '',  // LEER - wird eingegeben!
                phone: phone,
                address: '',
                email: '',
                isNew: true  // Marker dass Kunde neu ist
            };
            
            // FÃ¼ge temporÃ¤ren Kunden zu allCustomers hinzu damit er gefunden wird
            const existingTempIndex = allCustomers.findIndex(c => c.id === 'new');
            if (existingTempIndex >= 0) {
                allCustomers[existingTempIndex] = tempCustomer;
            } else {
                allCustomers.push(tempCustomer);
            }
            console.log('âœ… TemporÃ¤rer Kunde in allCustomers');
            
            // Wechsle zu Admin-Bereich
            switchView('admin');
            
            // Warte kurz, dann Ã¶ffne Schnellbuchungs-Modal
            setTimeout(() => {
                // Ã–ffne das Schnellbuchungs-Modal
                openQuickBookingModal(tempCustomer);
                
                console.log('âœ… Schnellbuchungs-Modal geÃ¶ffnet fÃ¼r neue Nummer:', phone);
            }, 500);
        }
        
        console.log('âœ… v5.87.68: CallHistory Funktionen definiert (OBEN im Script)!');
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.90.121: ZIFFERNBLOCK ZEIT-EINGABE (wie Google Calendar)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // ğŸ†• v5.90.138: GLOBALE Ziffernblock-Variablen (wie alle anderen Modals!)
        let keypadCurrentInput = '';
        let keypadDisplay = null;
        let keypadCallback = null;
        
        // ğŸ†• v5.90.146: ROLLING WINDOW - Immer weiter tippen!
        let keypadFirstInput = true;  // Flag ob erster Input
        
        function keypadDigit(digit) {
            console.log('âœ… v5.90.146: Ziffer:', digit);
            
            // ğŸ†• v5.90.146: Beim ERSTEN Klick â†’ Leere Input!
            if (keypadFirstInput) {
                console.log('ğŸ”§ v5.90.146: Erster Input - leere keypadCurrentInput!');
                keypadCurrentInput = '';
                keypadFirstInput = false;
            }
            
            // ğŸ†• v5.90.146: IMMER WEITER TIPPEN - Nimm nur die letzten 4!
            keypadCurrentInput += digit;
            
            // Wenn mehr als 4 Ziffern â†’ Nimm nur die letzten 4!
            if (keypadCurrentInput.length > 4) {
                keypadCurrentInput = keypadCurrentInput.slice(-4);  // Letzte 4!
                console.log('ğŸ”„ v5.90.146: Rolling Window â†’ Letzte 4 Ziffern:', keypadCurrentInput);
            }
            
            console.log('ğŸ”§ v5.90.146: Aktueller Input:', keypadCurrentInput);
            keypadUpdateDisplay();
        }
        
        function keypadBackspace() {
            console.log('âŒ« v5.90.145: Backspace');
            
            // ğŸ†• v5.90.145: Backspace deaktiviert First-Input Flag!
            if (keypadFirstInput) {
                console.log('ğŸ”§ v5.90.145: First-Input deaktiviert');
                keypadFirstInput = false;
            }
            
            if (keypadCurrentInput.length > 0) {
                keypadCurrentInput = keypadCurrentInput.slice(0, -1);
                console.log('ğŸ”§ v5.90.145: Nach Backspace:', keypadCurrentInput);
                keypadUpdateDisplay();
            }
        }
        
        function keypadUpdateDisplay() {
            console.log('ğŸ”§ v5.90.146: keypadUpdateDisplay() aufgerufen');
            console.log('   keypadCurrentInput:', keypadCurrentInput);
            
            const display = document.querySelector('#time-keypad-modal #keypad-display');
            console.log('   display gefunden:', display ? 'JA' : 'NEIN');
            
            if (!display) {
                console.warn('âš ï¸ Display nicht gefunden!');
                return;
            }
            
            let newText = '';
            
            // ğŸ†• v5.90.146: BEHALTE FÃœHRENDE NULLEN!
            if (keypadCurrentInput.length === 0) {
                newText = '0:00';
            } else if (keypadCurrentInput.length === 1) {
                // "8" â†’ "8:00"
                newText = keypadCurrentInput + ':00';
            } else if (keypadCurrentInput.length === 2) {
                // "08" â†’ "08:00"
                newText = keypadCurrentInput + ':00';
            } else if (keypadCurrentInput.length === 3) {
                // "081" â†’ "08:1" (erste 2 = Stunde, letzte 1 = Minute)
                const hour = keypadCurrentInput.substring(0, 2);
                const min = keypadCurrentInput.substring(2, 3);
                newText = hour + ':' + min;
            } else if (keypadCurrentInput.length === 4) {
                // "0815" â†’ "08:15"
                const hour = keypadCurrentInput.substring(0, 2);
                const min = keypadCurrentInput.substring(2, 4);
                newText = hour + ':' + min;
            }
            
            console.log('   Display Text:', newText);
            display.textContent = newText;
            console.log('   Display aktualisiert!');
        }
        
        function keypadOk() {
            console.log('âœ… v5.90.146: OK geklickt');
            
            // Parse Eingabe - ğŸ†• v5.90.146: KONSISTENT mit Display!
            let hour = 0;
            let minute = 0;
            
            if (keypadCurrentInput.length === 0) {
                // Leer â†’ 0:00
                hour = 0;
                minute = 0;
            } else if (keypadCurrentInput.length === 1) {
                // "8" â†’ 8:00
                hour = parseInt(keypadCurrentInput);
                minute = 0;
            } else if (keypadCurrentInput.length === 2) {
                // "08" â†’ 08:00
                hour = parseInt(keypadCurrentInput);
                minute = 0;
            } else if (keypadCurrentInput.length === 3) {
                // "081" â†’ 08:1 â†’ Parse als 08:10 (fÃ¼ge 0 hinten an)
                hour = parseInt(keypadCurrentInput.substring(0, 2));
                minute = parseInt(keypadCurrentInput.substring(2, 3) + '0');
            } else if (keypadCurrentInput.length === 4) {
                // "0815" â†’ 08:15
                hour = parseInt(keypadCurrentInput.substring(0, 2));
                minute = parseInt(keypadCurrentInput.substring(2, 4));
            }
            
            // Validierung
            if (hour > 23) hour = 23;
            if (minute > 59) minute = 59;
            
            // Auto-Rundung auf 5-Min
            minute = Math.round(minute / 5) * 5;
            if (minute === 60) {
                minute = 0;
                hour++;
                if (hour > 23) hour = 0;
            }
            
            // Format mit fÃ¼hrenden Nullen!
            const timeString = String(hour).padStart(2, '0') + ':' + String(minute).padStart(2, '0');
            console.log('âœ… v5.90.146: Zeit gewÃ¤hlt:', timeString);
            
            // ğŸ†• v5.90.655: VERGANGENHEITS-CHECK (nur fÃ¼r HEUTE!)
            const dateInput = document.getElementById('pickup-date') || document.getElementById('date');
            if (dateInput && dateInput.value) {
                const selectedDate = new Date(dateInput.value + 'T00:00:00');
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                // Nur prÃ¼fen wenn HEUTE gewÃ¤hlt
                if (selectedDate.getTime() === today.getTime()) {
                    const now = new Date();
                    const selectedDateTime = new Date();
                    selectedDateTime.setHours(hour, minute, 0, 0);
                    
                    // ğŸ†• 30 MINUTEN PUFFER!
                    const minBookingTime = new Date(now.getTime() + 30 * 60000);
                    
                    console.log('ğŸš« v5.90.655: Vergangenheits-Check');
                    console.log('   Jetzt:', now.toLocaleTimeString('de-DE'));
                    console.log('   GewÃ¤hlt:', selectedDateTime.toLocaleTimeString('de-DE'));
                    console.log('   Min. Zeit (+ 30 Min):', minBookingTime.toLocaleTimeString('de-DE'));
                    
                    if (selectedDateTime < minBookingTime) {
                        // âŒ ZU FRÃœH!
                        const minHour = String(minBookingTime.getHours()).padStart(2, '0');
                        const minMinute = String(minBookingTime.getMinutes()).padStart(2, '0');
                        
                        console.log('âŒ v5.90.655: Zeit liegt in Vergangenheit!');
                        alert(`â° Bitte wÃ¤hle eine Zeit in der Zukunft!\n\nFrÃ¼heste mÃ¶gliche Zeit: ${minHour}:${minMinute} Uhr\n(Jetzt + 30 Min Vorlauf)`);
                        return; // Abbrechen!
                    } else {
                        console.log('âœ… v5.90.655: Zeit liegt in Zukunft - OK!');
                    }
                }
            }
            
            // Callback aufrufen
            if (keypadCallback) keypadCallback(timeString);
            
            // Modal schlieÃŸen
            const modal = document.getElementById('time-keypad-modal');
            if (modal) modal.remove();
            
            // Cleanup
            keypadCurrentInput = '';
            keypadDisplay = null;
            keypadCallback = null;
            keypadFirstInput = true;  // ğŸ†• v5.90.145: Reset Flag!
        }
        
        function keypadCancel() {
            console.log('ğŸ’¾ Abgebrochen');
            
            // Modal schlieÃŸen
            const modal = document.getElementById('time-keypad-modal');
            if (modal) modal.remove();
            
            // Cleanup
            keypadCurrentInput = '';
            keypadDisplay = null;
            keypadCallback = null;
            keypadFirstInput = true;  // ğŸ†• v5.90.145: Reset Flag!
        }
        
        function showTimeKeypad(currentValue, callback) {
            console.log('âŒ¨ï¸ Ziffernblock Ã¶ffnen mit:', currentValue);
            
            // ğŸ†• v5.90.145: Reset First-Input Flag!
            keypadFirstInput = true;
            
            // Setze globale Variablen
            keypadCallback = callback;
            
            // Parse aktuelle Zeit
            let displayValue = '';
            if (currentValue) {
                // Entferne alle nicht-Ziffern
                displayValue = currentValue.replace(/[^0-9]/g, '');
            }
            keypadCurrentInput = displayValue;
            
            // ğŸ†• v5.90.143: Format initial Display richtig!
            let initialDisplayText = '0:00';
            if (displayValue.length === 1) {
                initialDisplayText = displayValue + ':00';
            } else if (displayValue.length === 2) {
                initialDisplayText = displayValue + ':00';
            } else if (displayValue.length === 3) {
                const hour = displayValue.substring(0, 1);
                const min = displayValue.substring(1, 3);
                initialDisplayText = hour + ':' + min;
            } else if (displayValue.length === 4) {
                const hour = displayValue.substring(0, 2);
                const min = displayValue.substring(2, 4);
                initialDisplayText = hour + ':' + min;
            }
            console.log('ğŸ”§ v5.90.143: Initial Display Text:', initialDisplayText);
            
            // Modal erstellen
            const modal = document.createElement('div');
            modal.id = 'time-keypad-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:99999;display:flex;align-items:center;justify-content:center;';
            
            modal.innerHTML = `
                <div style="background:white;border-radius:16px;padding:20px;max-width:350px;width:90%;box-shadow:0 10px 40px rgba(0,0,0,0.3);">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;border-bottom:2px solid #3b82f6;padding-bottom:10px;">
                        <div style="font-size:14px;font-weight:600;color:#667eea;">âŒ¨ï¸ Zeit eingeben</div>
                    </div>
                    
                    <!-- Zeit-Anzeige -->
                    <div id="keypad-display" style="font-size:48px;font-weight:bold;color:#667eea;text-align:center;margin-bottom:20px;font-family:'Courier New', monospace;min-height:60px;display:flex;align-items:center;justify-content:center;">
                        ${initialDisplayText}
                    </div>
                    
                    <!-- Ziffernblock -->
                    <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:10px;margin-bottom:15px;">
                        <button onclick="keypadDigit('1')" style="padding:15px;font-size:24px;font-weight:600;border:2px solid #e0e0e0;border-radius:8px;background:white;cursor:pointer;">1</button>
                        <button onclick="keypadDigit('2')" style="padding:15px;font-size:24px;font-weight:600;border:2px solid #e0e0e0;border-radius:8px;background:white;cursor:pointer;">2</button>
                        <button onclick="keypadDigit('3')" style="padding:15px;font-size:24px;font-weight:600;border:2px solid #e0e0e0;border-radius:8px;background:white;cursor:pointer;">3</button>
                        <button onclick="keypadDigit('4')" style="padding:15px;font-size:24px;font-weight:600;border:2px solid #e0e0e0;border-radius:8px;background:white;cursor:pointer;">4</button>
                        <button onclick="keypadDigit('5')" style="padding:15px;font-size:24px;font-weight:600;border:2px solid #e0e0e0;border-radius:8px;background:white;cursor:pointer;">5</button>
                        <button onclick="keypadDigit('6')" style="padding:15px;font-size:24px;font-weight:600;border:2px solid #e0e0e0;border-radius:8px;background:white;cursor:pointer;">6</button>
                        <button onclick="keypadDigit('7')" style="padding:15px;font-size:24px;font-weight:600;border:2px solid #e0e0e0;border-radius:8px;background:white;cursor:pointer;">7</button>
                        <button onclick="keypadDigit('8')" style="padding:15px;font-size:24px;font-weight:600;border:2px solid #e0e0e0;border-radius:8px;background:white;cursor:pointer;">8</button>
                        <button onclick="keypadDigit('9')" style="padding:15px;font-size:24px;font-weight:600;border:2px solid #e0e0e0;border-radius:8px;background:white;cursor:pointer;">9</button>
                        <button onclick="keypadDigit('0')" style="padding:15px;font-size:24px;font-weight:600;border:2px solid #e0e0e0;border-radius:8px;background:white;cursor:pointer;grid-column:2;">0</button>
                        <button onclick="keypadBackspace()" style="padding:15px;font-size:20px;font-weight:600;border:2px solid #e0e0e0;border-radius:8px;background:white;cursor:pointer;">âŒ«</button>
                    </div>
                    
                    <!-- Buttons -->
                    <div style="display:flex;gap:10px;">
                        <button onclick="keypadOk()" style="flex:1;padding:15px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;font-size:16px;cursor:pointer;">
                            Ok
                        </button>
                        <button onclick="keypadCancel()" style="flex:1;padding:15px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;font-size:16px;cursor:pointer;">
                            Abbrechen
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Setze Display-Referenz
            keypadDisplay = modal.querySelector('#keypad-display');
            
            // Initial Display aktualisieren
            keypadUpdateDisplay();
            
            // ESC zum SchlieÃŸen
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    if (modal.parentNode) {
                        document.body.removeChild(modal);
                    }
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
            
            // ğŸ†• v5.90.144: Initial display update - RICHTIGER FUNKTIONSNAME!
            keypadUpdateDisplay();
        }
        
        console.log('âœ… v5.90.121: Ziffernblock-Interface geladen!');
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // ğŸ’¾ SAVE RIDES TO LOCALSTORAGE
        function saveRides() {
            try {
                localStorage.setItem('rides', JSON.stringify(rides));
                console.log('ğŸ’¾ Rides gespeichert:', rides.length);
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Speichern:', error);
            }
        }
        
        // ğŸŒŸ STAMMKUNDEN-FUNKTIONEN
        function loadRegularCustomer() {
            // âœ… Nur laden wenn User eingeloggt
            if (!currentUser) return;
            
            // âœ… Stammkunden-Daten pro Email-Adresse
            const storageKey = `regularCustomer_${currentUser.email}`;
            const saved = localStorage.getItem(storageKey);
            if (saved) {
                regularCustomer = JSON.parse(saved);
                showRegularCustomerBox();
            }
        }
        
        function showRegularCustomerBox() {
            if (!regularCustomer) return;
            
            const box = document.getElementById('regular-customer-box');
            const info = document.getElementById('regular-customer-info');
            
            // ğŸ›¡ï¸ Sicherheitscheck: Nur setzen wenn Element existiert
            if (!info || !box) {
                console.log('Stammkunden-Elemente noch nicht geladen, versuche spÃ¤ter...');
                return;
            }
            
            info.innerHTML = `
                ğŸ’¾ <strong>${regularCustomer.name}</strong><br>
                ${regularCustomer.phone ? `ğŸ’¾ ${regularCustomer.phone}<br>` : ''}
                ğŸ“ HÃ¤ufig: ${regularCustomer.favoritePickup || 'Noch keine Fahrten'}<br>
                ğŸš• ${regularCustomer.rideCount || 0} Fahrten bisher
            `;
            
            box.style.display = 'block';
        }
        
        function useRegularCustomerData() {
            if (!regularCustomer) return;
            
            document.getElementById('customer-name').value = regularCustomer.name;
            if (regularCustomer.favoritePickup) {
                document.getElementById('pickup').value = regularCustomer.favoritePickup;
            }
            if (regularCustomer.favoriteDestination) {
                document.getElementById('destination').value = regularCustomer.favoriteDestination;
            }
            // âœ… TELEFON LADEN!
            if (regularCustomer.phone) {
                document.getElementById('customer-phone').value = regularCustomer.phone;
            }
            
            alert('âœ… Deine Daten wurden eingefÃ¼gt!\n\nÃœberprÃ¼fe die Adresse und buche dann dein Taxi.');
        }
        
        function clearRegularCustomer() {
            if (confirm('âš ï¸ Stammkundendaten lÃ¶schen?\n\nDu musst beim nÃ¤chsten Mal alles neu eingeben.')) {
                if (currentUser) {
                    const storageKey = `regularCustomer_${currentUser.email}`;
                    localStorage.removeItem(storageKey);
                }
                regularCustomer = null;
                document.getElementById('regular-customer-box').style.display = 'none';
                alert('âœ… Stammkundendaten gelÃ¶scht');
            }
        }
        
        function saveRegularCustomerData(name, pickup, destination) {
            // Alte Funktion - nicht mehr benÃ¶tigt
            // CRM wird jetzt automatisch Ã¼ber updateCustomerCRM() aktualisiert
        }
        
        // ğŸ“… HISTORY TAB FUNCTIONS
        function showHistoryTab(tab) {
            currentHistoryTab = tab;
            
            // Update Button Styles
            const upcomingBtn = document.getElementById('tab-upcoming');
            const pastBtn = document.getElementById('tab-past');
            
            if (tab === 'upcoming') {
                upcomingBtn.style.background = '#667eea';
                upcomingBtn.style.color = 'white';
                pastBtn.style.background = 'white';
                pastBtn.style.color = '#667eea';
            } else {
                upcomingBtn.style.background = 'white';
                upcomingBtn.style.color = '#667eea';
                pastBtn.style.background = '#667eea';
                pastBtn.style.color = 'white';
            }
            
            // Update History List
            updateHistoryView();
        }
        
        async function updateHistoryView() {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ“– v5.90.88 - updateHistoryView DEBUG START');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ“‹ Tab:', currentHistoryTab);
            console.log('ğŸ’¾ currentUser:', currentUser ? 'eingeloggt' : 'nicht eingeloggt');
            if (currentUser) {
                console.log('   ğŸ’¾ UID:', currentUser.uid);
                console.log('   ğŸ’¾ phoneNumber:', currentUser.phoneNumber || 'NICHT GESETZT ğŸ’¾');
                console.log('   ğŸ’¾ displayName:', currentUser.displayName || 'NICHT GESETZT ğŸ’¾');
                console.log('   ğŸ’¾ email:', currentUser.email || 'NICHT GESETZT ğŸ’¾');
            }
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            const historyList = document.getElementById('history-list');
            let allRides = [];
            
            // ğŸ“¦ Hole Fahrten aus localStorage
            const localHistory = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            console.log('ğŸ” DEBUG - localStorage Fahrten:', localHistory.length);
            console.log('ğŸ” DEBUG - currentHistoryTab:', currentHistoryTab);
            console.log('ğŸ” DEBUG - currentUser:', currentUser ? 'eingeloggt' : 'nicht eingeloggt');
            
            // ğŸ”¥ Hole MEINE Fahrten aus Firebase (wenn verfÃ¼gbar)
            let firebaseRides = [];
            let firebaseRideIds = [];
            if (isFirebaseReady && currentUser) {
                try {
                    // ğŸ†• v5.90.11: Suche nach UID ODER Phone
                    const snapshot = await db.ref('rides').orderByChild('userId').equalTo(currentUser.uid).once('value');
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            const ride = childSnapshot.val();
                            ride.firebaseId = childSnapshot.key;
                            firebaseRides.push(ride);
                            firebaseRideIds.push(ride.id);
                        });
                    }
                    
                    // ğŸ†• v5.90.12: AUCH nach Phone suchen (wenn vorhanden)
                    // ğŸ†• v5.90.19: Suche auch nach customerPhone!
                    if (currentUser.phoneNumber) {
                        const normalizedPhone = normalizePhoneNumber(currentUser.phoneNumber);
                        console.log('â•â•â•â•â•â• PHONE-SUCHE START â•â•â•â•â•â•');
                        console.log('ğŸ“± Originale Phone:', currentUser.phoneNumber);
                        console.log('ğŸ“± Normalisiert:', normalizedPhone);
                        
                        // Suche nach userId = Phone
                        console.log('ğŸ” Suche 1: userId =', normalizedPhone);
                        const phoneSnapshot = await db.ref('rides').orderByChild('userId').equalTo(normalizedPhone).once('value');
                        if (phoneSnapshot.exists()) {
                            phoneSnapshot.forEach(childSnapshot => {
                                const ride = childSnapshot.val();
                                ride.firebaseId = childSnapshot.key;
                                // ğŸ”§ v5.90.88: FIX - Nutze firebaseId statt ride.id
                                if (!firebaseRides.some(r => r.firebaseId === childSnapshot.key)) {
                                    firebaseRides.push(ride);
                                    if (ride.id) firebaseRideIds.push(ride.id);
                                    console.log('   âœ… Gefunden:', ride.pickup, 'â†’', ride.destination, '(', ride.status, ')');
                                }
                            });
                            console.log('âœ… Fahrten via userId=Phone gefunden:', phoneSnapshot.numChildren());
                        } else {
                            console.log('ğŸ’¾ Keine Fahrten via userId=Phone');
                        }
                        
                        // ğŸ†• v5.90.19: AUCH nach customerPhone suchen!
                        console.log('ğŸ” Suche 2: customerPhone =', normalizedPhone);
                        const customerPhoneSnapshot = await db.ref('rides').orderByChild('customerPhone').equalTo(normalizedPhone).once('value');
                        if (customerPhoneSnapshot.exists()) {
                            customerPhoneSnapshot.forEach(childSnapshot => {
                                const ride = childSnapshot.val();
                                ride.firebaseId = childSnapshot.key;
                                // ğŸ”§ v5.90.88: FIX - Nutze firebaseId statt ride.id (kann undefined sein!)
                                if (!firebaseRides.some(r => r.firebaseId === childSnapshot.key)) {
                                    firebaseRides.push(ride);
                                    if (ride.id) firebaseRideIds.push(ride.id);
                                    console.log('   âœ… Gefunden:', ride.pickup, 'â†’', ride.destination, '(', ride.status, ')');
                                }
                            });
                            console.log('âœ… Fahrten via customerPhone gefunden:', customerPhoneSnapshot.numChildren());
                        } else {
                            console.log('ğŸ’¾ Keine Fahrten via customerPhone');
                        }
                        
                        // ğŸ†• v5.90.21: FALLBACK - Suche auch in phoneNumber Feld!
                        console.log('ğŸ” Suche 3: phoneNumber =', normalizedPhone);
                        const phoneFieldSnapshot = await db.ref('rides').orderByChild('phoneNumber').equalTo(normalizedPhone).once('value');
                        if (phoneFieldSnapshot.exists()) {
                            phoneFieldSnapshot.forEach(childSnapshot => {
                                const ride = childSnapshot.val();
                                ride.firebaseId = childSnapshot.key;
                                // ğŸ”§ v5.90.88: FIX - Nutze firebaseId statt ride.id
                                if (!firebaseRides.some(r => r.firebaseId === childSnapshot.key)) {
                                    firebaseRides.push(ride);
                                    if (ride.id) firebaseRideIds.push(ride.id);
                                    console.log('   âœ… Gefunden:', ride.pickup, 'â†’', ride.destination, '(', ride.status, ')');
                                }
                            });
                            console.log('âœ… Fahrten via phoneNumber gefunden:', phoneFieldSnapshot.numChildren());
                        } else {
                            console.log('ğŸ’¾ Keine Fahrten via phoneNumber');
                        }
                        console.log('â•â•â•â•â•â• PHONE-SUCHE ENDE â•â•â•â•â•â•');
                    } else {
                        console.log('âš ï¸ KEINE TELEFONNUMMER GESETZT - Phone-Suche Ã¼bersprungen!');
                    }
                    
                    // ğŸ†• v5.90.79: ERWEITERTE SUCHE NACH customerId (Admin-Buchungen)!
                    console.log('â•â•â•â•â•â• CUSTOMER-ID-SUCHE START â•â•â•â•â•â•');
                    console.log('ğŸ” Suche 4: customerId =', currentUser.uid);
                    if (currentUser.uid) {
                        const customerIdSnapshot = await db.ref('rides').orderByChild('customerId').equalTo(currentUser.uid).once('value');
                        console.log('ğŸ“± customerIdSnapshot exists:', customerIdSnapshot.exists());
                        console.log('ğŸ“± customerIdSnapshot numChildren:', customerIdSnapshot.numChildren());
                        
                        if (customerIdSnapshot.exists()) {
                            customerIdSnapshot.forEach(childSnapshot => {
                                const ride = childSnapshot.val();
                                ride.firebaseId = childSnapshot.key;
                                console.log('   âœ… Gefunden:', ride.pickup, 'â†’', ride.destination, '(', ride.status, ')');
                                // ğŸ”§ v5.90.88: FIX - Nutze firebaseId statt ride.id
                                if (!firebaseRides.some(r => r.firebaseId === childSnapshot.key)) {
                                    firebaseRides.push(ride);
                                    if (ride.id) firebaseRideIds.push(ride.id);
                                }
                            });
                            console.log('âœ… Fahrten via customerId gefunden:', customerIdSnapshot.numChildren());
                        } else {
                            console.log('ğŸ’¾ KEINE Fahrten via customerId (Auth-UID stimmt nicht mit CRM-ID Ã¼berein)');
                        }
                    }
                    console.log('â•â•â•â•â•â• CUSTOMER-ID-SUCHE ENDE â•â•â•â•â•â•');
                    
                    // ğŸ†• v5.90.87: NAME-SUCHE IMMER DURCHFÃœHREN!
                    // Problem: displayName ist oft leer, aber customerName in Fahrten ist gesetzt!
                    // LÃ¶sung: Suche nach bekannten Namen ODER Telefonnummer-Matching
                    console.log('â•â•â•â•â•â• NAME-SUCHE START â•â•â•â•â•â•');
                    
                    // BEKANNTE NAMEN FÃœR DIESEN USER (aus customerPhone-Suche extrahieren)
                    const knownNames = new Set();
                    if (currentUserPhone) {
                        // Durchsuche bereits gefundene Fahrten nach Namen
                        firebaseRides.forEach(r => {
                            if (r.customerName && r.customerName !== 'Unbekannt') {
                                knownNames.add(r.customerName);
                            }
                        });
                    }
                    
                    // Falls wir Namen gefunden haben, suche nach diesen
                    if (knownNames.size > 0) {
                        for (const name of knownNames) {
                            console.log('ğŸ” Suche 5: customerName =', name);
                            try {
                                const nameSnapshot = await db.ref('rides').orderByChild('customerName').equalTo(name).once('value');
                                if (nameSnapshot.exists()) {
                                    nameSnapshot.forEach(childSnapshot => {
                                        const ride = childSnapshot.val();
                                        ride.firebaseId = childSnapshot.key;
                                        // Nur hinzufÃ¼gen wenn noch nicht vorhanden
                                        if (!firebaseRides.some(r => r.firebaseId === childSnapshot.key)) {
                                            console.log('   âœ… Gefunden:', ride.pickup, 'â†’', ride.destination, '(', ride.status, ')');
                                            firebaseRides.push(ride);
                                            if (ride.id) firebaseRideIds.push(ride.id);
                                        }
                                    });
                                    console.log('âœ… Fahrten via customerName gefunden:', nameSnapshot.numChildren());
                                }
                            } catch (error) {
                                console.error('ğŸ’¾ Fehler bei Name-Suche:', error);
                            }
                        }
                    } else if (currentUser.displayName) {
                        // Fallback: Versuche displayName wenn vorhanden
                        console.log('ğŸ” Suche 5: customerName (displayName) =', currentUser.displayName);
                        try {
                            const nameSnapshot = await db.ref('rides').orderByChild('customerName').equalTo(currentUser.displayName).once('value');
                            if (nameSnapshot.exists()) {
                                nameSnapshot.forEach(childSnapshot => {
                                    const ride = childSnapshot.val();
                                    ride.firebaseId = childSnapshot.key;
                                    if (!firebaseRides.some(r => r.firebaseId === childSnapshot.key)) {
                                        console.log('   âœ… Gefunden:', ride.pickup, 'â†’', ride.destination, '(', ride.status, ')');
                                        firebaseRides.push(ride);
                                        if (ride.id) firebaseRideIds.push(ride.id);
                                    }
                                });
                                console.log('âœ… Fahrten via customerName gefunden:', nameSnapshot.numChildren());
                            }
                        } catch (error) {
                            console.error('ğŸ’¾ Fehler bei Name-Suche:', error);
                        }
                    }
                    console.log('â•â•â•â•â•â• NAME-SUCHE ENDE â•â•â•â•â•â•');
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim Laden der Firebase Fahrten:', error);
                }
                
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('ğŸ“± SUCH-ERGEBNIS ZUSAMMENFASSUNG:');
                console.log('   Gefundene Firebase-Fahrten:', firebaseRides.length);
                console.log('   Unique Ride IDs:', firebaseRideIds.length);
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            }
            
            // ğŸ†• v5.26.14g: FIREBASE HAT VORRANG!
            // Merge-Logik: Firebase-Status Ã¼berschreibt localStorage
            const rideMap = new Map();
            
            // 1. FÃ¼ge localStorage-Fahrten hinzu (als Basis)
            localHistory.forEach(localRide => {
                rideMap.set(localRide.id, localRide);
            });
            
            // 2. Ãœberschreibe mit Firebase-Fahrten (haben Vorrang!)
            firebaseRides.forEach(fbRide => {
                rideMap.set(fbRide.id, fbRide);
                console.log('âœ… Firebase-Fahrt hat Vorrang:', fbRide.id, 'Status:', fbRide.status);
            });
            
            // 3. Entferne Fahrten die in Firebase gelÃ¶scht wurden
            if (currentUser && isFirebaseReady) {
                localHistory.forEach(localRide => {
                    const existsInFirebase = firebaseRideIds.includes(localRide.id);
                    if (!existsInFirebase) {
                        console.log('ğŸ—‘ï¸ Entferne gelÃ¶schte Fahrt:', localRide.id);
                        rideMap.delete(localRide.id);
                    }
                });
            }
            
            // 4. Konvertiere Map zurÃ¼ck zu Array
            allRides = Array.from(rideMap.values());
            
            // 5. Aktualisiere localStorage mit aktuellen Status
            if (currentUser && isFirebaseReady && allRides.length > 0) {
                localStorage.setItem('rideHistory', JSON.stringify(allRides));
                console.log('âœ… localStorage aktualisiert mit Firebase-Status:', allRides.length, 'Fahrten');
            }
            
            console.log('ğŸ” DEBUG - Alle Fahrten nach Merge:', allRides.length);
            if (allRides.length > 0) {
                console.log('ğŸ” DEBUG - Status der Fahrten:', allRides.map(r => r.status));
            }
            
            if (allRides.length === 0) {
                historyList.innerHTML = '<div style="text-align:center;padding:40px;color:#999;"><p>Noch keine Fahrten</p></div>';
                return;
            }
            
            const now = Date.now();
            let filteredRides = [];
            
            if (currentHistoryTab === 'upcoming') {
                // ğŸ“… KOMMENDE FAHRTEN: vorbestellt, new, accepted, picked_up, etc.
                filteredRides = allRides.filter(r => {
                    const activeStatuses = ['vorbestellt', 'new', 'accepted', 'picked_up', 'akzeptiert', 'unterwegs', 'angekommen', 'assigned_to_driver', 'assigned'];
                    const isActiveStatus = activeStatuses.includes(r.status);
                    
                    // ğŸ†• v5.32.5d: FÃ¼r vorbestellte Fahrten â†’ PrÃ¼fe ob Zeit noch nicht vorbei!
                    if (r.status === 'vorbestellt' && r.pickupTimestamp) {
                        const isFuture = r.pickupTimestamp > now;
                        if (!isFuture) {
                            console.log('â° Ãœberspringe alte Vorbestellung:', r.firebaseId, new Date(r.pickupTimestamp));
                        }
                        return isFuture;
                    }
                    
                    return isActiveStatus;
                }).sort((a, b) => (a.pickupTimestamp || a.createdAt) - (b.pickupTimestamp || b.createdAt));
            } else {
                // ğŸ“– VERGANGENE FAHRTEN: completed, cancelled, storniert + alte Vorbestellungen
                filteredRides = allRides.filter(r => {
                    const completedStatuses = ['completed', 'abgeschlossen', 'cancelled', 'storniert'];
                    const isCompletedStatus = completedStatuses.includes(r.status);
                    
                    // ğŸ†• v5.32.5d: Alte Vorbestellungen auch hier anzeigen!
                    const isOldPreorder = r.status === 'vorbestellt' && r.pickupTimestamp && r.pickupTimestamp < now;
                    
                    return isCompletedStatus || isOldPreorder;
                }).sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            }
            
            console.log('ğŸ” DEBUG - Gefilterte Fahrten:', filteredRides.length);
            console.log('ğŸ” DEBUG - Gefilterte Status:', filteredRides.map(r => r.status));
            
            if (filteredRides.length === 0) {
                const emptyMessage = currentHistoryTab === 'upcoming' 
                    ? 'ğŸ“… Keine kommenden Fahrten'
                    : 'ğŸ“– Noch keine vergangenen Fahrten';
                historyList.innerHTML = `<div style="text-align:center;padding:40px;color:#999;"><p>${emptyMessage}</p></div>`;
                return;
            }
            
            historyList.innerHTML = filteredRides.map(r => {
                const isActive = currentHistoryTab === 'upcoming';
                
                // ğŸ¨ Farben basierend auf Status
                let bgColor, borderColor, statusEmoji, statusText;
                
                switch(r.status) {
                    case 'vorbestellt':
                        bgColor = '#fef3c7';
                        borderColor = '#f59e0b';
                        statusEmoji = 'ğŸ“…';
                        statusText = 'Vorbestellt';
                        break;
                    case 'new':
                        bgColor = '#dbeafe';
                        borderColor = '#3b82f6';
                        statusEmoji = 'ğŸ””';
                        statusText = 'Sucht Fahrer...';
                        break;
                    case 'akzeptiert':
                        bgColor = '#d1fae5';
                        borderColor = '#10b981';
                        statusEmoji = 'âœ…';
                        statusText = 'Fahrer akzeptiert';
                        break;
                    case 'unterwegs':
                        bgColor = '#e0f2fe';
                        borderColor = '#0ea5e9';
                        statusEmoji = 'ğŸš—';
                        statusText = 'Fahrer unterwegs';
                        break;
                    case 'angekommen':
                        bgColor = '#fce7f3';
                        borderColor = '#ec4899';
                        statusEmoji = 'ğŸ¯';
                        statusText = 'Fahrer angekommen';
                        break;
                    case 'abgeschlossen':
                        bgColor = 'white';
                        borderColor = '#e0e0e0';
                        statusEmoji = 'âœ…';
                        statusText = 'Abgeschlossen';
                        break;
                    case 'storniert':
                        bgColor = '#fee2e2';
                        borderColor = '#ef4444';
                        statusEmoji = 'ğŸ’¾';
                        statusText = 'Storniert';
                        break;
                    default:
                        bgColor = 'white';
                        borderColor = '#e0e0e0';
                        statusEmoji = 'ğŸ“±';
                        statusText = r.status;
                }
                
                // ğŸ• Zeitanzeige
                let timeDisplay = r.pickupTime || 'Sofort';
                if (r.pickupTimestamp) {
                    const pickupDate = new Date(r.pickupTimestamp);
                    timeDisplay = pickupDate.toLocaleString('de-DE', {
                        weekday: 'short',
                        day: '2-digit',
                        month: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
                
                // ğŸš— Fahrzeug-Info (falls vorhanden)
                let vehicleInfo = '';
                if (r.assignedDriver && (r.vehicleLabel || r.vehicle)) {
                    const vehicleName = r.vehicleLabel || r.vehicle;
                    const plateInfo = r.vehiclePlate ? ` (${r.vehiclePlate})` : '';
                    vehicleInfo = `<div style="margin-top:8px;padding:8px;background:rgba(102,126,234,0.1);border-radius:6px;font-size:12px;">
                        ğŸš— <strong>${vehicleName}${plateInfo}</strong>
                    </div>`;
                }
                
                // â±ï¸ ETA Info (falls Fahrer unterwegs)
                let etaInfo = '';
                if (r.status === 'unterwegs' && r.eta) {
                    etaInfo = `<div style="margin-top:8px;padding:8px;background:#dcfce7;border-radius:6px;font-size:13px;font-weight:600;color:#166534;">
                        â±ï¸ Ankunft in ca. ${r.eta} Min
                    </div>`;
                }
                
                // ğŸš¨ STORNIERUNGSGRUND (falls vorhanden)
                let cancellationInfo = '';
                if (r.status === 'storniert' && r.cancellationReason) {
                    cancellationInfo = `<div style="margin-top:8px;padding:10px;background:#fee2e2;border-left:4px solid #ef4444;border-radius:6px;font-size:13px;color:#991b1b;">
                        <strong>ğŸš¨ Stornierungsgrund:</strong><br>
                        ${r.cancellationReason}
                    </div>`;
                }
                
                // ğŸ”˜ Aktions-Buttons
                let actionButtons = '';
                
                // ğŸ†• v5.32.3: MAP-NULL-CHECK-FIX-LINK BUTTON (fÃ¼r alle Fahrten!)
                const trackingLink = r.firebaseId ? `${window.location.origin}${window.location.pathname}?ride=${r.firebaseId}` : null;
                let trackingButton = '';
                if (trackingLink) {
                    trackingButton = `
                        <button onclick="openTrackingLink('${trackingLink}')" 
                            style="width:100%;margin-top:10px;padding:10px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">
                            ğŸ”— Tracking Ã¶ffnen
                        </button>
                        <button onclick="shareTrackingLink('${trackingLink}')" 
                            style="width:100%;margin-top:8px;padding:8px;background:white;color:#3b82f6;border:2px solid #3b82f6;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;">
                            ğŸ“² Link teilen
                        </button>
                    `;
                }
                
                // ğŸ†• v5.32.3: SMS/TELEGRAM STATUS ANZEIGEN
                let notificationStatus = '';
                if (r.notificationsSent) {
                    const smsIcon = r.notificationsSent.sms ? 'âœ…' : 'â³';
                    const telegramIcon = r.notificationsSent.telegram ? 'âœ…' : 'â³';
                    notificationStatus = `
                        <div style="margin-top:10px;padding:8px;background:#f0f9ff;border:1px solid #bfdbfe;border-radius:6px;font-size:11px;color:#1e40af;">
                            ğŸ“² <strong>Benachrichtigungen:</strong><br>
                            ${smsIcon} SMS ${r.notificationsSent.sms ? 'gesendet' : 'ausstehend'} | 
                            ${telegramIcon} Telegram ${r.notificationsSent.telegram ? 'gesendet' : 'nicht verknÃ¼pft'}
                        </div>
                    `;
                }
                
                if (isActive && r.status !== 'storniert') {
                    // ğŸ†• v5.26.14f: Keine Stornierung bei picked_up!
                    if (r.status === 'picked_up') {
                        actionButtons = `
                            <div style="padding:12px;background:#fef3c7;border-left:4px solid #f59e0b;border-radius:6px;font-size:13px;color:#92400e;margin-top:10px;">
                                âš ï¸ <strong>Fahrt lÃ¤uft bereits</strong><br>
                                Stornierung nicht mehr mÃ¶glich
                            </div>
                        `;
                    } else if (r.status === 'vorbestellt' || r.status === 'new') {
                        // Vorbestellungen + Neue Fahrten: Bearbeiten & Stornieren
                        actionButtons = `
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;">
                                <button onclick="editRide('${r.firebaseId || r.id}')" 
                                    style="padding:10px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">
                                    âœï¸ Bearbeiten
                                </button>
                                <button onclick="cancelRideFromHistory('${r.firebaseId || r.id}')" 
                                    style="padding:10px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">
                                    ğŸ—‘ï¸ Stornieren
                                </button>
                            </div>
                        `;
                    } else if (r.firebaseId) {
                        actionButtons = `<button onclick="viewRideDetails('${r.firebaseId}')" 
                            style="width:100%;margin-top:10px;padding:10px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">
                            ğŸ‘ï¸ Details anzeigen
                        </button>`;
                    }
                } else {
                    // Vergangene Fahrten: Buttons inkl. Rechnung + Stornobeleg
                    
                    // ğŸ“± RECHNUNG-Button fÃ¼r abgeschlossene Fahrten
                    // ğŸ†• v5.26.14g: RECHNUNG REGELN
                    let documentButton = '';
                    
                    if (r.status === 'abgeschlossen' || r.status === 'completed') {
                        // âœ… Normale Rechnung fÃ¼r abgeschlossene Fahrten
                        // ğŸ†• v5.90.11: Wenn Rechnung existiert â†’ Download, sonst erstellen
                        if (r.invoiceNumber) {
                            documentButton = `
                                <div style="margin-top:10px;padding:10px;background:#d1fae5;border-left:3px solid #10b981;border-radius:6px;">
                                    <div style="font-size:13px;color:#048257;font-weight:600;margin-bottom:8px;">
                                        ğŸ“± Rechnung: ${r.invoiceNumber}${r.invoiceAmount ? ' Â· ' + r.invoiceAmount.toFixed(2) + 'â‚¬' : ''}
                                    </div>
                                    <button onclick="downloadInvoicePDF('${r.invoiceNumber}', '${r.firebaseId || r.id}')" 
                                        style="width:100%;padding:10px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">
                                        ğŸ“¥ PDF Download
                                    </button>
                                </div>
                            `;
                        } else {
                            documentButton = `
                                <button onclick="downloadReceipt(${r.createdAt || r.id})" 
                                    style="width:100%;margin-top:8px;padding:10px;background:#8b5cf6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">
                                    ğŸ“± Rechnung laden
                                </button>
                            `;
                        }
                    } else if (r.status === 'storniert' || r.status === 'cancelled') {
                        // ğŸš¨ Stornobeleg NUR wenn innerhalb 60 Minuten storniert!
                        const createdAt = r.createdAt || 0;
                        const cancelledAt = r.cancelledAt || r.completedAt || 0;
                        const timeDiff = cancelledAt - createdAt;
                        const minutesDiff = Math.floor(timeDiff / (60 * 1000));
                        
                        if (minutesDiff <= 60 && minutesDiff >= 0) {
                            // Innerhalb 60 Min â†’ 15% StornogebÃ¼hr
                            const cancellationFee = Math.round((r.price || 0) * 0.15 * 100) / 100;
                            documentButton = `
                                <button onclick="downloadCancellationReceipt(${r.createdAt || r.id})" 
                                    style="width:100%;margin-top:8px;padding:10px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">
                                    ğŸ“± Stornobeleg laden (${cancellationFee.toFixed(2)}â‚¬)
                                </button>
                            `;
                        }
                        // Sonst: Kein Button (kostenlose Stornierung)
                    }
                    
                    actionButtons = `
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;">
                            <button onclick="rebookRide(${r.createdAt || r.id})" 
                                style="padding:10px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">
                                ğŸ” Nochmal
                            </button>
                            <button onclick="reverseRouteFromHistory(${r.createdAt || r.id})" 
                                style="padding:10px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">
                                ğŸ”„ Umdrehen
                            </button>
                        </div>
                        <button onclick="saveAsFavorite(${r.createdAt || r.id})" 
                            style="width:100%;margin-top:8px;padding:10px;background:#f59e0b;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">
                            â­ Als Favorit
                        </button>
                        ${documentButton}
                    `;
                }
                
                return `
                    <div style="background:${bgColor};border:2px solid ${borderColor};border-radius:12px;padding:15px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                        <div style="font-weight:600;color:#374151;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                            <span>${statusEmoji} ${statusText}</span>
                            ${isActive ? '<span style="font-size:11px;color:#6b7280;">ğŸ• ' + timeDisplay + '</span>' : ''}
                        </div>
                        ${!isActive ? `<div style="font-size:12px;color:#666;margin-bottom:8px;">ğŸ• ${timeDisplay}</div>` : ''}
                        <div style="margin:10px 0;font-size:14px;">
                            ğŸ“ <strong>Von:</strong> ${r.pickup}<br>
                            ğŸ¯ <strong>Nach:</strong> ${r.destination}
                        </div>
                        <div style="display:flex;gap:12px;margin-top:8px;font-size:13px;color:#666;">
                            <span>ğŸ’° ${r.price}â‚¬</span>
                            <span>ğŸ“ ${r.distance} km</span>
                            ${r.passengers ? `<span>ğŸ‘¥ ${r.passengers}</span>` : ''}
                        </div>
                        ${vehicleInfo}
                        ${etaInfo}
                        ${cancellationInfo}
                        ${notificationStatus}
                        ${trackingButton}
                        ${actionButtons}
                    </div>
                `;
            }).join('');
        }

        // ğŸ“… DATUM & ZEIT PICKER
        // NOTE: Diese Funktion wird in v5.30.0 nicht mehr verwendet (Sofort/Vorbestellen UX)
        function handlePickupTimeChange() {
            const select = document.getElementById('pickup-time');
            if (!select) return; // Element existiert nicht mehr in v5.30.0
            
            const datetimePicker = document.getElementById('custom-datetime');
            const datetimeContainer = document.getElementById('custom-datetime-container');
            const helpText = document.getElementById('datetime-help');
            
            if (select.value === 'datetime') {
                // Verstecke alten Picker, zeige neuen Container
                datetimePicker.style.display = 'none';
                datetimeContainer.style.display = 'block';
                if (helpText) helpText.style.display = 'block';
                
                // Setze Standard auf jetzt + 1 Stunde (gerundet auf 5 Min)
                const defaultTime = new Date();
                defaultTime.setHours(defaultTime.getHours() + 1);
                
                // ğŸ”§ Runde auf nÃ¤chste 5 Minuten
                const roundedMinutes = Math.ceil(defaultTime.getMinutes() / 5) * 5;
                defaultTime.setMinutes(roundedMinutes % 60);
                if (roundedMinutes >= 60) defaultTime.setHours(defaultTime.getHours() + 1);
                
                // Setze Werte
                const dateInput = document.getElementById('custom-date');
                const hourSelect = document.getElementById('custom-hour');
                const minuteSelect = document.getElementById('custom-minute');
                
                // Datum im Format YYYY-MM-DD
                const year = defaultTime.getFullYear();
                const month = String(defaultTime.getMonth() + 1).padStart(2, '0');
                const day = String(defaultTime.getDate()).padStart(2, '0');
                dateInput.value = `${year}-${month}-${day}`;
                
                // Minimum-Datum auf heute setzen
                const today = new Date();
                const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                dateInput.min = todayStr;
                
                // Stunde und Minute
                hourSelect.value = String(defaultTime.getHours()).padStart(2, '0');
                minuteSelect.value = String(defaultTime.getMinutes()).padStart(2, '0');
                
            } else {
                datetimePicker.style.display = 'none';
                datetimeContainer.style.display = 'none';
                if (helpText) helpText.style.display = 'none';
            }
        }
        
        // ğŸ†• v5.30.0: Fahrt-Typ wÃ¤hlen (Sofort / Vorbestellen)
        let currentRideType = null; // 'sofort' oder 'vorbestellen'
        let isRebooking = false; // ğŸ†• v5.49.0: Merkt sich ob es eine "Nochmal buchen" ist
        
        function selectRideType(type) {
            currentRideType = type;
            
            const btnSofort = document.getElementById('btn-sofort');
            const btnVorbestellen = document.getElementById('btn-vorbestellen');
            const sofortBereich = document.getElementById('sofort-bereich');
            const vorbestellenBereich = document.getElementById('vorbestellen-bereich');
            
            if (type === 'sofort') {
                // âš¡ SOFORT Button aktiv
                btnSofort.style.border = '3px solid #10b981';
                btnSofort.style.background = 'linear-gradient(135deg,#10b981,#059669)';
                btnSofort.querySelector('div:nth-child(2)').style.color = 'white';
                btnSofort.querySelector('div:nth-child(3)').style.color = 'rgba(255,255,255,0.9)';
                
                // ğŸ“… VORBESTELLEN Button inaktiv
                btnVorbestellen.style.border = '3px solid #e5e7eb';
                btnVorbestellen.style.background = 'white';
                btnVorbestellen.querySelector('div:nth-child(2)').style.color = '#6b7280';
                btnVorbestellen.querySelector('div:nth-child(3)').style.color = '#666';
                
                // Bereiche zeigen/verstecken
                sofortBereich.style.display = 'block';
                vorbestellenBereich.style.display = 'none';
                
                // âœ… WENN Abholadresse bereits eingegeben â†’ Lade Taxis!
                const pickupInput = document.getElementById('pickup');
                if (pickupInput && pickupInput.value.trim()) {
                    console.log('ğŸ“ Abholadresse vorhanden, lade Taxis...');
                    
                    // Zeige Loading
                    const display = document.getElementById('available-taxis-display');
                    display.innerHTML = `
                        <div style="padding:20px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:12px;text-align:center;margin-top:10px;">
                            <div style="font-size:20px;margin-bottom:10px;">ğŸ“</div>
                            <div style="font-weight:600;font-size:16px;margin-bottom:5px;">Suche verfÃ¼gbare Taxis...</div>
                            <div style="font-size:13px;opacity:0.9;">Bitte warten...</div>
                        </div>
                    `;
                    
                    setTimeout(() => {
                        showAvailableTaxis();
                    }, 500);
                }
                
            } else if (type === 'vorbestellen') {
                // ğŸ“… VORBESTELLEN Button aktiv
                btnVorbestellen.style.border = '3px solid #667eea';
                btnVorbestellen.style.background = 'linear-gradient(135deg,#667eea,#764ba2)';
                btnVorbestellen.querySelector('div:nth-child(2)').style.color = 'white';
                btnVorbestellen.querySelector('div:nth-child(3)').style.color = 'rgba(255,255,255,0.9)';
                
                // âš¡ SOFORT Button inaktiv
                btnSofort.style.border = '3px solid #e5e7eb';
                btnSofort.style.background = 'white';
                btnSofort.querySelector('div:nth-child(2)').style.color = '#6b7280';
                btnSofort.querySelector('div:nth-child(3)').style.color = '#666';
                
                // Bereiche zeigen/verstecken
                sofortBereich.style.display = 'none';
                vorbestellenBereich.style.display = 'block';
                
                // ğŸ“… Initialisiere Datum/Zeit-Felder mit sinnvollen Defaults
                initVorbestellenDefaults();
            }
        }
        
        // ğŸ†• v5.90.114: KEINE AUTO-AKTIVIERUNG! Nutzer wÃ¤hlt selbst SOFORT oder VORBESTELLEN
        // (Code entfernt - Buttons sind beide sichtbar und gleichwertig)
        
        // ğŸ†• v5.32.0: Setze Default-Werte fÃ¼r Vorbestellen-Felder
        // ğŸ”§ v5.90.123: Angepasst fÃ¼r Ziffernblock mit Slot-Check
        function initVorbestellenDefaults() {
            const datetimeContainer = document.getElementById('custom-datetime-container');
            const helpText = document.getElementById('datetime-help');
            
            // Zeige die Felder
            datetimeContainer.style.display = 'block';
            if (helpText) helpText.style.display = 'block';
            
            // ğŸ†• v5.90.117: Default = +1 Stunde (nur Vorschlag, keine Regel!)
            const defaultTime = new Date();
            defaultTime.setHours(defaultTime.getHours() + 1);
            
            // Runde auf 5 Minuten
            const roundedMinutes = Math.ceil(defaultTime.getMinutes() / 5) * 5;
            defaultTime.setMinutes(roundedMinutes % 60);
            if (roundedMinutes >= 60) defaultTime.setHours(defaultTime.getHours() + 1);
            
            // Setze Datum
            const dateInput = document.getElementById('custom-date');
            const year = defaultTime.getFullYear();
            const month = String(defaultTime.getMonth() + 1).padStart(2, '0');
            const day = String(defaultTime.getDate()).padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;
            
            // Min-Datum = Heute
            const today = new Date();
            const minDateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            dateInput.min = minDateStr;
            
            // Setze Zeit im Button
            const timeBtn = document.getElementById('time-display-btn');
            const hourInput = document.getElementById('custom-hour');
            const minuteInput = document.getElementById('custom-minute');
            
            const timeStr = `${String(defaultTime.getHours()).padStart(2, '0')}:${String(defaultTime.getMinutes()).padStart(2, '0')}`;
            if (timeBtn) timeBtn.textContent = timeStr;
            hourInput.value = String(defaultTime.getHours()).padStart(2, '0');
            minuteInput.value = String(defaultTime.getMinutes()).padStart(2, '0');
            
            console.log('â° Vorbestellen initialisiert:', timeStr);
        }
        
        // ğŸ†• v5.90.19: VALIDIERE MINIMUM 1 STUNDE
        function validateMinimumTime() {
            const dateInput = document.getElementById('custom-date');
            const hourSelect = document.getElementById('custom-hour');
            const minuteSelect = document.getElementById('custom-minute');
            
            if (!dateInput || !hourSelect || !minuteSelect) return true;
            
            const dateVal = dateInput.value;
            const hourVal = hourSelect.value;
            const minuteVal = minuteSelect.value;
            
            if (!dateVal) return true; // Kein Datum = OK (noch nicht ausgefÃ¼llt)
            
            // GewÃ¤hlte Zeit
            const selectedTime = new Date(dateVal);
            selectedTime.setHours(parseInt(hourVal), parseInt(minuteVal), 0, 0);
            
            // ğŸ†• v5.90.117: KEINE 1-Stunde-Regel mehr!
            // Nur prÃ¼fen ob Zeit nicht in der Vergangenheit ist
            // ğŸ†• v5.90.154: ADMINS DÃœRFEN VERGANGENHEIT!
            const now = new Date();
            
            if (selectedTime < now) {
                // PrÃ¼fe ob User Admin ist
                const isAdmin = currentUser && (currentUser.email === 'patrick061977@gmail.com' || currentUser.email === 'admin@taxi-heringsdorf.de');
                
                if (!isAdmin) {
                    alert(`âš ï¸ Die gewÃ¤hlte Zeit liegt in der Vergangenheit!\n\nBitte wÃ¤hle eine zukÃ¼nftige Zeit.`);
                    return false;
                } else {
                    console.log('âœ… Admin darf Vergangenheit!');
                }
            }
            
            return true;
        }

        // ğŸ—‘ï¸ Fahrt aus Verlauf stornieren
        async function cancelRideFromHistory(rideId) {
            // ğŸ†• v5.87.58: Lade Fahrt um Hotel-Status zu prÃ¼fen
            let ride = null;
            if (isFirebaseReady && rideId) {
                try {
                    const snapshot = await db.ref(`rides/${rideId}`).once('value');
                    ride = snapshot.val();
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim Laden:', error);
                }
            }
            
            // ğŸ†• v5.87.58: STORNO-SCHUTZ fÃ¼r Hotel-Fahrten! ğŸ”’
            if (ride && ride.hotelCalendarId) {
                const hotelName = ride.hotelName || 'Hotel';
                alert(
                    `ğŸ”’ HOTEL-FAHRT GESCHÃœTZT!\n\n` +
                    `ğŸ¨ Hotel: ${hotelName}\n` +
                    `ğŸ’¾ Gast: ${ride.guestName || ride.customerName || '?'}\n\n` +
                    `âš ï¸ Diese Fahrt wurde vom Hotel-Kalender importiert\n` +
                    `und kann NICHT storniert werden!\n\n` +
                    `ğŸ’¡ Bitte kontaktiere das Hotel direkt.`
                );
                console.log('ğŸ”’ Hotel-Fahrt Stornierung BLOCKIERT!');
                return;
            }
            
            const confirmCancel = confirm('ğŸ—‘ï¸ Fahrt wirklich stornieren?');
            if (!confirmCancel) return;
            
            // Update Firebase mit updateRide() fÃ¼r Telegram-Benachrichtigung
            if (isFirebaseReady && rideId) {
                try {
                    await updateRide(rideId, { 
                        status: 'storniert',
                        cancelledAt: Date.now(),
                        cancelledBy: 'passenger',  // ğŸ†• v5.87.59: Tracking wer storniert hat
                        cancelledReason: 'Storniert durch Fahrgast aus Verlauf'
                    });
                    console.log('âœ… Fahrt in Firebase storniert');
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim Stornieren in Firebase:', error);
                }
            }
            
            // Update localStorage
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            const historyRide = history.find(r => r.firebaseId === rideId || r.id === rideId);
            if (historyRide) {
                historyRide.status = 'storniert';
                historyRide.cancelledAt = Date.now();
                localStorage.setItem('rideHistory', JSON.stringify(history));
                console.log('âœ… Fahrt in localStorage storniert');
            }
            
            alert('âœ… Fahrt wurde storniert');
            updateHistoryView();
        }
        
        // ğŸ‘ï¸ Fahrtdetails anzeigen (wechselt zum Fahrgast-Tab und zeigt Status)
        function viewRideDetails(rideId) {
            if (!isFirebaseReady || !rideId) return;
            
            // Lade Fahrt und zeige Status an
            db.ref('rides/' + rideId).once('value', (snapshot) => {
                const ride = snapshot.val();
                if (ride) {
                    ride.firebaseId = rideId;
                    
                    // ğŸ†• v5.50.9: ADMIN-SCHUTZ! Admin-Fahrten dÃ¼rfen nicht hier angezeigt werden!
                    if (ride.bookedBy === 'admin') {
                        console.log('ğŸ›¡ï¸ ADMIN-FAHRT! Kann nicht in Passenger-View angezeigt werden!');
                        alert('â„¹ï¸ Dies ist eine Admin-Buchung.\n\nBitte verwende das Admin-Panel zum Bearbeiten.');
                        return;
                    }
                    
                    myCurrentRide = ride;
                    localStorage.setItem('myCurrentRideId', rideId);
                    
                    // Wechsel zum Fahrgast-Tab
                    switchView('passenger');
                    
                    // Zeige Fahrt-Status
                    showRideStatus(ride);
                    
                    // Starte Live-Listener
                    listenToMyRide(rideId);
                }
            });
        }
        
        // ğŸ” FAHRT WIEDERHOLEN
        function rebookRide(rideId) {
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            const ride = history.find(r => r.createdAt === rideId || r.id === rideId);
            
            if (!ride) {
                alert('ğŸ’¾ Fahrt nicht gefunden');
                return;
            }
            
            // ğŸ†• v5.49.0: Merke dass dies eine Rebooking ist!
            isRebooking = true;
            console.log('ğŸ”„ v5.49.0: isRebooking gesetzt auf true');
            
            // Wechsel zum Fahrgast-Tab
            switchView('passenger');
            
            // âœ… Warte kurz bis View gewechselt hat
            setTimeout(() => {
                // FÃ¼lle Formular aus
                document.getElementById('pickup').value = ride.pickup;
                document.getElementById('destination').value = ride.destination;
                document.getElementById('customer-name').value = ride.customerName || '';
                document.getElementById('passengers').value = ride.passengers || '1';
                
                // âœ… LÃ¶sche alte Koordinaten (mÃ¼ssen neu berechnet werden)
                pickupCoords = null;
                destCoords = null;
                
                // âœ… Setze Preis-Anzeige zurÃ¼ck
                document.getElementById('price-display').innerHTML = '';
                
                // âœ… Deaktiviere "Taxi buchen" Button
                const bookBtn = document.getElementById('book-taxi-btn');
                if (bookBtn) {
                    bookBtn.disabled = true;
                    bookBtn.style.opacity = '0.5';
                    bookBtn.style.cursor = 'not-allowed';
                }
                
                // âœ… Stelle sicher dass Formular sichtbar ist
                const bookingForm = document.getElementById('booking-form');
                if (bookingForm) {
                    bookingForm.style.display = 'block';
                    // Scroll zum Formular
                    bookingForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                
                // Zeige Hinweis
                setTimeout(() => {
                    alert('âœ… Fahrtdaten Ã¼bernommen!\n\nâš ï¸ WICHTIG:\nBitte PREIS NEU BERECHNEN\n(Tarif kÃ¶nnte sich geÃ¤ndert haben!)');
                }, 300);
            }, 100);
        }
        
        // ğŸ”„ ROUTE UMDREHEN
        function reverseRouteFromHistory(rideId) {
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            const ride = history.find(r => r.createdAt === rideId || r.id === rideId);
            
            if (!ride) {
                alert('ğŸ’¾ Fahrt nicht gefunden');
                return;
            }
            
            // Wechsel zum Fahrgast-Tab
            switchView('passenger');
            
            // âœ… Warte kurz bis View gewechselt hat
            setTimeout(() => {
                // FÃ¼lle Formular aus MIT UMGEDREHTER ROUTE
                document.getElementById('pickup').value = ride.destination;  // â† GETAUSCHT
                document.getElementById('destination').value = ride.pickup;   // â† GETAUSCHT
                document.getElementById('customer-name').value = ride.customerName || '';
                document.getElementById('passengers').value = ride.passengers || '1';
                
                // âœ… LÃ¶sche alte Koordinaten (mÃ¼ssen neu berechnet werden)
                pickupCoords = null;
                destCoords = null;
                
                // âœ… Setze Preis-Anzeige zurÃ¼ck
                document.getElementById('price-display').innerHTML = '';
                
                // âœ… Deaktiviere "Taxi buchen" Button
                const bookBtn = document.getElementById('book-taxi-btn');
                if (bookBtn) {
                    bookBtn.disabled = true;
                    bookBtn.style.opacity = '0.5';
                    bookBtn.style.cursor = 'not-allowed';
                }
                
                // âœ… Stelle sicher dass Formular sichtbar ist
                const bookingForm = document.getElementById('booking-form');
                if (bookingForm) {
                    bookingForm.style.display = 'block';
                    // Scroll zum Formular
                    bookingForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                
                // Zeige Hinweis
                setTimeout(() => {
                    alert('ğŸ”„ Route umgedreht!\n\n' + 
                          'Von: ' + ride.destination + '\n' +
                          'Nach: ' + ride.pickup + '\n\n' +
                          'âš ï¸ WICHTIG:\nBitte PREIS NEU BERECHNEN\n(Tarif kÃ¶nnte sich geÃ¤ndert haben!)');
                }, 300);
            }, 100);
        }
        
        // â­ ALS FAVORIT SPEICHERN
        function saveAsFavorite(rideId) {
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            const ride = history.find(r => r.createdAt === rideId || r.id === rideId);
            
            if (!ride) {
                alert('ğŸ’¾ Fahrt nicht gefunden');
                return;
            }
            
            // Lade bestehende Favoriten
            const favorites = JSON.parse(localStorage.getItem('favoritRides') || '[]');
            
            // PrÃ¼fe ob schon vorhanden
            const exists = favorites.some(f => 
                f.pickup === ride.pickup && f.destination === ride.destination
            );
            
            if (exists) {
                alert('â­ Diese Route ist bereits ein Favorit!');
                return;
            }
            
            // FÃ¼ge hinzu
            const favorite = {
                id: Date.now(),
                name: `${ride.pickup} â†’ ${ride.destination}`,
                pickup: ride.pickup,
                destination: ride.destination,
                distance: ride.distance,
                price: ride.price,
                addedAt: Date.now()
            };
            
            favorites.push(favorite);
            localStorage.setItem('favoritRides', JSON.stringify(favorites));
            
            alert('â­ Als Favorit gespeichert!\n\n' +
                  ride.pickup + ' â†’ ' + ride.destination + '\n\n' +
                  'Favoriten findest du im Fahrgast-Tab oben.');
            
            // TODO: Favoriten-Anzeige implementieren
        }
        
        // ğŸ†• v5.90.155: POI MIT KOORDINATEN AUSWÃ„HLEN!
        function selectPOIForEdit(type, address, lat, lon, name) {
            console.log(`â­ v5.90.155: POI ausgewÃ¤hlt fÃ¼r ${type}:`, name, address, lat, lon);
            
            // ğŸ†• v5.90.155: VERWENDE NAME statt Adresse!
            const displayName = name || address;
            
            if (type === 'pickup') {
                document.getElementById('edit-pickup').value = displayName;
                document.getElementById('edit-pickup-lat').value = lat;
                document.getElementById('edit-pickup-lon').value = lon;
                document.getElementById('edit-pickup').focus();
                console.log('âœ… Abholort gesetzt:', displayName);
            } else if (type === 'destination') {
                document.getElementById('edit-destination').value = displayName;
                document.getElementById('edit-destination-lat').value = lat;
                document.getElementById('edit-destination-lon').value = lon;
                document.getElementById('edit-destination').focus();
                console.log('âœ… Zielort gesetzt:', displayName);
            }
        }
        
        // âœï¸ FAHRT BEARBEITEN
        async function editRide(rideId) {
            // ğŸ†• v5.86.17: ENTFERNE ALTE MODALS ZUERST!
            const oldModals = document.querySelectorAll('[id*="edit-modal"], [style*="position:fixed"][style*="z-index:9999"]');
            oldModals.forEach(modal => {
                // Nur entfernen wenn es wirklich ein Edit-Modal ist
                if (modal.innerHTML && (modal.innerHTML.includes('Fahrt bearbeiten') || modal.innerHTML.includes('edit-pickup'))) {
                    console.log('ğŸ—‘ï¸ Entferne altes Edit-Modal');
                    modal.remove();
                }
            });
            
            // Lade Fahrt aus Firebase
            let ride = null;
            
            if (isFirebaseReady) {
                const snapshot = await db.ref('rides/' + rideId).once('value');
                ride = snapshot.val();
                if (ride) ride.firebaseId = rideId;
            }
            
            // Falls nicht in Firebase, suche in localStorage
            if (!ride) {
                const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
                ride = history.find(r => r.firebaseId === rideId || r.id === rideId);
            }
            
            if (!ride) {
                alert('ğŸ’¾ Fahrt nicht gefunden');
                return;
            }
            
            // Erstelle Bearbeitungs-Modal
            const pickupDate = ride.pickupTimestamp ? new Date(ride.pickupTimestamp) : new Date();
            // FIX: Konvertiere zu lokaler Zeit fÃ¼r datetime-local Input
            const year = pickupDate.getFullYear();
            const month = String(pickupDate.getMonth() + 1).padStart(2, '0');
            const day = String(pickupDate.getDate()).padStart(2, '0');
            const hours = String(pickupDate.getHours()).padStart(2, '0');
            const minutes = String(pickupDate.getMinutes()).padStart(2, '0');
            const formattedDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;max-width:400px;width:90%;max-height:80vh;overflow-y:auto;">
                    <h3 style="margin-bottom:15px;">âœï¸ Fahrt bearbeiten</h3>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block;margin-bottom:5px;font-weight:600;">ğŸ“ Abholort</label>
                        <input type="text" id="edit-pickup" value="${ride.pickup}" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:6px;" autocomplete="off">
                        
                        <!-- ğŸ†• v5.90.155: KOORDINATEN FÃœR POI-GENAUIGKEIT -->
                        <input type="hidden" id="edit-pickup-lat" value="${ride.pickupLat || ''}">
                        <input type="hidden" id="edit-pickup-lon" value="${ride.pickupLon || ''}">
                        
                        <!-- ğŸ†• v5.87.63: AUTOCOMPLETE DROPDOWN -->
                        <div class="autocomplete-dropdown" id="edit-pickup-dropdown" style="position:relative;z-index:10001;"></div>
                        
                        <!-- ğŸ†• v5.87.62: DYNAMISCHE FAVORITEN aus POI-Verwaltung -->
                        <div id="edit-pickup-favorites" style="margin-top:8px;">
                            <div style="font-size:11px;font-weight:600;color:#6b7280;margin-bottom:4px;">â­ FAVORITEN:</div>
                            <div style="display:flex;flex-wrap:wrap;gap:6px;">
                                <div style="font-size:12px;color:#9ca3af;padding:6px;">Lade Favoriten...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block;margin-bottom:5px;font-weight:600;">ğŸ¯ Zielort</label>
                        <input type="text" id="edit-destination" value="${ride.destination}" style="width:100%;padding:10px;border:2px solid#e0e0e0;border-radius:6px;" autocomplete="off">
                        
                        <!-- ğŸ†• v5.90.155: KOORDINATEN FÃœR POI-GENAUIGKEIT -->
                        <input type="hidden" id="edit-destination-lat" value="${ride.destinationLat || ''}">
                        <input type="hidden" id="edit-destination-lon" value="${ride.destinationLon || ''}">
                        
                        <!-- ğŸ†• v5.87.63: AUTOCOMPLETE DROPDOWN -->
                        <div class="autocomplete-dropdown" id="edit-destination-dropdown" style="position:relative;z-index:10001;"></div>
                        
                        <!-- ğŸ†• v5.87.62: DYNAMISCHE FAVORITEN aus POI-Verwaltung -->
                        <div id="edit-destination-favorites" style="margin-top:8px;">
                            <div style="font-size:11px;font-weight:600;color:#6b7280;margin-bottom:4px;">â­ FAVORITEN:</div>
                            <div style="display:flex;flex-wrap:wrap;gap:6px;">
                                <div style="font-size:12px;color:#9ca3af;padding:6px;">Lade Favoriten...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block;margin-bottom:5px;font-weight:600;">ğŸ’¾ Kundenname (Rechnung)</label>
                        <input type="text" id="edit-customer" value="${ride.customerName || ''}" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
                    </div>
                    
                    <!-- ğŸ†• v5.75.2: GAST-NAME -->
                    <div style="margin-bottom:15px;">
                        <label style="display:block;margin-bottom:5px;font-weight:600;">
                            ğŸ“ Gast-Name (optional)
                            <span style="font-weight:400;font-size:11px;color:#6b7280;margin-left:4px;">fÃ¼r Hotels</span>
                        </label>
                        <input type="text" id="edit-guest-name" value="${ride.guestName || ''}" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
                        <div style="font-size:11px;color:#6b7280;margin-top:4px;">
                            ğŸ’¡ Rechnung geht an Kunde, Fahrt wird fÃ¼r Gast durchgefÃ¼hrt
                        </div>
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block;margin-bottom:5px;font-weight:600;">ğŸ• Abholzeit</label>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                            <div>
                                <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px;">Datum</label>
                                <input type="date" id="edit-date" value="${formattedDateTime.split('T')[0]}" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
                            </div>
                            <div>
                                <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px;">Uhrzeit</label>
                                <div style="display:flex;gap:6px;">
                                    <button type="button" id="edit-time-btn" onclick="openEditTimeKeypad()" style="flex:1;padding:10px;border:2px solid #667eea;background:white;border-radius:6px;font-size:14px;font-weight:600;color:#667eea;cursor:pointer;font-family:'Courier New',monospace;">
                                        ${formattedDateTime.split('T')[1] || '09:00'}
                                    </button>
                                    <button type="button" onclick="openEditTimeKeypad()" style="padding:10px 12px;border:2px solid #667eea;background:#667eea;color:white;border-radius:6px;font-weight:600;cursor:pointer;font-size:14px;">
                                        âŒ¨ï¸
                                    </button>
                                </div>
                                <input type="hidden" id="edit-time" value="${formattedDateTime.split('T')[1] || '09:00'}">
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block;margin-bottom:5px;font-weight:600;">ğŸš— Fahrzeug</label>
                        <select id="edit-vehicle" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
                            <option value="">Kein Fahrzeug zugewiesen</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block;margin-bottom:5px;font-weight:600;">ğŸ‘¥ Personen</label>
                        <select id="edit-passengers" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
                            <option value="1" ${ride.passengers == 1 ? 'selected' : ''}>1 Person</option>
                            <option value="2" ${ride.passengers == 2 ? 'selected' : ''}>2 Personen</option>
                            <option value="3" ${ride.passengers == 3 ? 'selected' : ''}>3 Personen</option>
                            <option value="4" ${ride.passengers == 4 ? 'selected' : ''}>4 Personen</option>
                        </select>
                    </div>
                    
                    <!-- ğŸ†• v5.90.121: PREIS-BERECHNUNG OPTION mit Krankenfahrt -->
                    <div style="margin-bottom:15px;padding:12px;background:#f0fdf4;border:2px solid #10b981;border-radius:8px;">
                        <div style="font-weight:600;margin-bottom:8px;">ğŸ’° Preis-Berechnung:</div>
                        
                        <label style="display:flex;align-items:center;gap:8px;margin-bottom:6px;cursor:pointer;">
                            <input type="radio" name="edit-price-mode" value="normal" ${(!ride.isKrankenfahrt && ride.price !== 0) || !ride.isKrankenfahrt ? 'checked' : ''} style="width:16px;height:16px;">
                            <span>ğŸ’µ Normaler Preis berechnen</span>
                        </label>
                        
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;" title="Krankenfahrt - kein Preis wird berechnet">
                            <input type="radio" name="edit-price-mode" value="medical" ${ride.isKrankenfahrt === true ? 'checked' : ''} style="width:16px;height:16px;">
                            <span>ğŸ¥ Krankenfahrt (kein Preis)</span>
                        </label>
                        
                        <div style="font-size:12px;color:#065f46;margin-top:6px;">
                            ğŸ’¡ Krankenfahrten werden nicht berechnet
                        </div>
                    </div>
                    
                    <!-- ğŸ†• v5.75.0: FAHRTDAUER OPTION -->
                    <div style="margin-bottom:15px;padding:12px;background:#eff6ff;border:2px solid #3b82f6;border-radius:8px;">
                        <div style="font-weight:600;margin-bottom:8px;">â±ï¸ Fahrtdauer:</div>
                        <label style="display:flex;align-items:center;gap:8px;margin-bottom:6px;cursor:pointer;">
                            <input type="radio" name="edit-duration-mode" value="calculated" ${!ride.duration || ride.duration > 15 ? 'checked' : ''} style="width:16px;height:16px;">
                            <span>ğŸ“ Aus Distanz berechnen</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <input type="radio" name="edit-duration-mode" value="fixed" ${ride.duration === 15 ? 'checked' : ''} style="width:16px;height:16px;">
                            <span>ğŸ• Feste Zeit (15 Min)</span>
                        </label>
                    </div>
                    
                    <!-- ğŸ†• v5.90.338: WHATSAPP + SMS SCHNELL-NACHRICHTEN -->
                    <div style="margin-bottom:20px;padding:15px;background:linear-gradient(135deg,#f0f9ff,#e0f2fe);border:2px solid #3b82f6;border-radius:10px;">
                        <div style="font-weight:700;margin-bottom:12px;color:#1e40af;font-size:15px;">
                            ğŸ’¬ Schnell-Nachrichten an Kunde
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                            
                            <!-- WhatsApp Button mit Dropdown -->
                            <div style="position:relative;">
                                <button type="button" onclick="toggleQuickMsgDropdown('wa-${rideId}')" 
                                        style="width:100%;
                                               padding:12px;
                                               background:linear-gradient(135deg,#25D366,#128C7E);
                                               color:white;
                                               border:none;
                                               border-radius:8px;
                                               font-weight:600;
                                               cursor:pointer;
                                               font-size:14px;
                                               box-shadow:0 2px 8px rgba(37,211,102,0.3);
                                               display:flex;
                                               align-items:center;
                                               justify-content:center;
                                               gap:6px;">
                                    ğŸ’¬ WhatsApp <span style="font-size:10px;">â–¼</span>
                                </button>
                                
                                <!-- Dropdown -->
                                <div id="wa-dropdown-${rideId}" 
                                     style="display:none;
                                            position:absolute;
                                            top:100%;
                                            left:0;
                                            right:0;
                                            background:white;
                                            border-radius:8px;
                                            box-shadow:0 4px 12px rgba(0,0,0,0.2);
                                            margin-top:5px;
                                            z-index:10002;
                                            overflow:hidden;
                                            border:2px solid #25D366;">
                                    <a onclick="sendQuickWhatsApp('${rideId}', 'arrived'); event.stopPropagation();" 
                                       style="display:block;
                                              padding:12px;
                                              cursor:pointer;
                                              border-bottom:1px solid #e5e7eb;
                                              color:#1f2937;
                                              text-decoration:none;
                                              font-size:13px;
                                              font-weight:500;">
                                        ğŸš• Taxi ist da!
                                    </a>
                                    <a onclick="sendQuickWhatsApp('${rideId}', '5min'); event.stopPropagation();" 
                                       style="display:block;
                                              padding:12px;
                                              cursor:pointer;
                                              border-bottom:1px solid #e5e7eb;
                                              color:#1f2937;
                                              text-decoration:none;
                                              font-size:13px;
                                              font-weight:500;">
                                        â±ï¸ Komme in 5 Min
                                    </a>
                                    <a onclick="sendQuickWhatsApp('${rideId}', 'tracking'); event.stopPropagation();" 
                                       style="display:block;
                                              padding:12px;
                                              cursor:pointer;
                                              border-bottom:1px solid #e5e7eb;
                                              color:#1f2937;
                                              text-decoration:none;
                                              font-size:13px;
                                              font-weight:500;">
                                        ğŸ“ Tracking-Link
                                    </a>
                                    <a onclick="sendQuickWhatsApp('${rideId}', 'delay'); event.stopPropagation();" 
                                       style="display:block;
                                              padding:12px;
                                              cursor:pointer;
                                              color:#1f2937;
                                              text-decoration:none;
                                              font-size:13px;
                                              font-weight:500;">
                                        â° VerzÃ¶gerung (10 Min)
                                    </a>
                                </div>
                            </div>
                            
                            <!-- SMS Button mit Dropdown -->
                            <div style="position:relative;">
                                <button type="button" onclick="toggleQuickMsgDropdown('sms-${rideId}')" 
                                        style="width:100%;
                                               padding:12px;
                                               background:linear-gradient(135deg,#3b82f6,#2563eb);
                                               color:white;
                                               border:none;
                                               border-radius:8px;
                                               font-weight:600;
                                               cursor:pointer;
                                               font-size:14px;
                                               box-shadow:0 2px 8px rgba(59,130,246,0.3);
                                               display:flex;
                                               align-items:center;
                                               justify-content:center;
                                               gap:6px;">
                                    ğŸ“± SMS <span style="font-size:10px;">â–¼</span>
                                </button>
                                
                                <!-- Dropdown -->
                                <div id="sms-dropdown-${rideId}" 
                                     style="display:none;
                                            position:absolute;
                                            top:100%;
                                            left:0;
                                            right:0;
                                            background:white;
                                            border-radius:8px;
                                            box-shadow:0 4px 12px rgba(0,0,0,0.2);
                                            margin-top:5px;
                                            z-index:10002;
                                            overflow:hidden;
                                            border:2px solid #3b82f6;">
                                    <a onclick="sendQuickSMS('${rideId}', 'arrived'); event.stopPropagation();" 
                                       style="display:block;
                                              padding:12px;
                                              cursor:pointer;
                                              border-bottom:1px solid #e5e7eb;
                                              color:#1f2937;
                                              text-decoration:none;
                                              font-size:13px;
                                              font-weight:500;">
                                        ğŸš• Taxi ist da!
                                    </a>
                                    <a onclick="sendQuickSMS('${rideId}', '5min'); event.stopPropagation();" 
                                       style="display:block;
                                              padding:12px;
                                              cursor:pointer;
                                              border-bottom:1px solid #e5e7eb;
                                              color:#1f2937;
                                              text-decoration:none;
                                              font-size:13px;
                                              font-weight:500;">
                                        â±ï¸ Komme in 5 Min
                                    </a>
                                    <a onclick="sendQuickSMS('${rideId}', 'tracking'); event.stopPropagation();" 
                                       style="display:block;
                                              padding:12px;
                                              cursor:pointer;
                                              border-bottom:1px solid #e5e7eb;
                                              color:#1f2937;
                                              text-decoration:none;
                                              font-size:13px;
                                              font-weight:500;">
                                        ğŸ“ Tracking-Link
                                    </a>
                                    <a onclick="sendQuickSMS('${rideId}', 'delay'); event.stopPropagation();" 
                                       style="display:block;
                                              padding:12px;
                                              cursor:pointer;
                                              color:#1f2937;
                                              text-decoration:none;
                                              font-size:13px;
                                              font-weight:500;">
                                        â° VerzÃ¶gerung (10 Min)
                                    </a>
                                </div>
                            </div>
                            
                        </div>
                        
                        <div style="font-size:11px;color:#1e40af;margin-top:10px;text-align:center;">
                            ğŸ’¡ Ã–ffnet WhatsApp/SMS auf deinem Handy
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button onclick="saveEditedRide('${rideId}')" style="flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                            âœ… Speichern
                        </button>
                        <button onclick="closeEditModal()" style="flex:1;padding:12px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                            ğŸ’¾ Abbrechen
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentEditModal = modal;
            
            // ğŸ†• v5.64.40: Fahrzeuge laden und setzen
            const vehicleSelect = document.getElementById('edit-vehicle');
            if (isFirebaseReady && vehicleSelect) {
                try {
                    // ğŸ†• v5.90.545: Lade BEIDE vehicles UND drivers!
                    const [vehiclesSnap, driversSnap] = await Promise.all([
                        db.ref('vehicles').once('value'),
                        db.ref('drivers').once('value')
                    ]);
                    
                    const vehiclesMap = new Map();
                    
                    // Vehicles zuerst
                    vehiclesSnap.forEach(child => {
                        vehiclesMap.set(child.key, {id: child.key, ...child.val()});
                    });
                    
                    // Dann drivers (Ã¼berschreiben falls beide vorhanden)
                    driversSnap.forEach(child => {
                        if (!vehiclesMap.has(child.key)) {
                            vehiclesMap.set(child.key, {id: child.key, ...child.val()});
                        }
                    });
                    
                    const vehicles = Array.from(vehiclesMap.values());
                    console.log('ğŸš— Fahrzeuge geladen:', vehicles.length);
                    
                    vehicles.forEach(v => {
                        const option = document.createElement('option');
                        option.value = v.id;
                        option.textContent = `${v.name || 'Unbekannt'}${v.plate ? ' (' + v.plate + ')' : ''}`;
                        if (ride.vehicleId === v.id) option.selected = true;
                        vehicleSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim Laden der Fahrzeuge:', error);
                }
            }
            
            // ğŸ†• v5.87.62: POIs laden und Favoriten-Buttons rendern
            if (isFirebaseReady) {
                try {
                    const poisSnapshot = await db.ref('pois').once('value');
                    const pois = [];
                    poisSnapshot.forEach(child => {
                        pois.push({
                            id: child.key,
                            ...child.val()
                        });
                    });
                    
                    console.log(`â­ ${pois.length} POIs fÃ¼r Favoriten geladen`);
                    
                    // Render Buttons fÃ¼r "Von"
                    const pickupFavContainer = document.getElementById('edit-pickup-favorites');
                    if (pickupFavContainer && pois.length > 0) {
                        pickupFavContainer.innerHTML = `
                            <div style="font-size:11px;font-weight:600;color:#6b7280;margin-bottom:4px;">â­ FAVORITEN:</div>
                            <div style="display:flex;flex-wrap:wrap;gap:6px;">
                                ${pois.map(poi => `
                                    <button onclick="selectPOIForEdit('pickup', '${poi.address.replace(/'/g, "\\'")}', ${poi.lat}, ${poi.lon}, '${poi.name.replace(/'/g, "\\'")}');" 
                                            style="padding:6px 12px;background:#fef3c7;color:#d97706;border:1px solid #f59e0b;border-radius:6px;font-size:12px;cursor:pointer;font-weight:500;">
                                        â­ ${poi.name}
                                    </button>
                                `).join('')}
                            </div>
                        `;
                    } else if (pickupFavContainer) {
                        pickupFavContainer.innerHTML = `
                            <div style="font-size:11px;color:#9ca3af;padding:6px;">
                                ğŸ’¡ Noch keine Favoriten. Gehe zu POI-Verwaltung zum HinzufÃ¼gen.
                            </div>
                        `;
                    }
                    
                    // Render Buttons fÃ¼r "Nach"
                    const destFavContainer = document.getElementById('edit-destination-favorites');
                    if (destFavContainer && pois.length > 0) {
                        destFavContainer.innerHTML = `
                            <div style="font-size:11px;font-weight:600;color:#6b7280;margin-bottom:4px;">â­ FAVORITEN:</div>
                            <div style="display:flex;flex-wrap:wrap;gap:6px;">
                                ${pois.map(poi => `
                                    <button onclick="selectPOIForEdit('destination', '${poi.address.replace(/'/g, "\\'")}', ${poi.lat}, ${poi.lon}, '${poi.name.replace(/'/g, "\\'")}');" 
                                            style="padding:6px 12px;background:#fef3c7;color:#d97706;border:1px solid #f59e0b;border-radius:6px;font-size:12px;cursor:pointer;font-weight:500;">
                                        â­ ${poi.name}
                                    </button>
                                `).join('')}
                            </div>
                        `;
                    } else if (destFavContainer) {
                        destFavContainer.innerHTML = `
                            <div style="font-size:11px;color:#9ca3af;padding:6px;">
                                ğŸ’¡ Noch keine Favoriten. Gehe zu POI-Verwaltung zum HinzufÃ¼gen.
                            </div>
                        `;
                    }
                    
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim Laden der POIs:', error);
                }
            }
            
            // ğŸ†• v5.87.63: AUTOCOMPLETE FÃœR EDIT-FELDER AKTIVIEREN!
            setupEditAutocomplete();
        }
        
        function closeEditModal() {
            if (window.currentEditModal) {
                window.currentEditModal.remove();
                window.currentEditModal = null;
            }
        }
        
        // ğŸ†• v5.90.338: WHATSAPP + SMS SCHNELL-NACHRICHTEN
        
        // Toggle Dropdown
        function toggleQuickMsgDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) return;
            
            // SchlieÃŸe alle anderen Dropdowns
            document.querySelectorAll('[id^="wa-dropdown-"], [id^="sms-dropdown-"]').forEach(d => {
                if (d.id !== dropdownId) d.style.display = 'none';
            });
            
            // Toggle aktuelles Dropdown
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }
        
        // SchlieÃŸe Dropdowns beim Klick auÃŸerhalb
        document.addEventListener('click', (e) => {
            if (!e.target.closest('[onclick*="toggleQuickMsgDropdown"]') && 
                !e.target.closest('[id^="wa-dropdown-"], [id^="sms-dropdown-"]')) {
                document.querySelectorAll('[id^="wa-dropdown-"], [id^="sms-dropdown-"]').forEach(d => {
                    d.style.display = 'none';
                });
            }
        });
        
        // WhatsApp senden
        async function sendQuickWhatsApp(rideId, template) {
            console.log('ğŸ’¬ WhatsApp wird gesendet:', rideId, template);
            
            // Hole Fahrt-Daten
            let ride = null;
            if (isFirebaseReady) {
                const snapshot = await db.ref('rides/' + rideId).once('value');
                ride = snapshot.val();
            }
            
            if (!ride) {
                alert('ğŸ’¾ Fahrt nicht gefunden');
                return;
            }
            
            // PrÃ¼fe Telefonnummer
            if (!ride.customerPhone) {
                alert('ğŸ’¾ Keine Telefonnummer vorhanden');
                return;
            }
            
            // Formatiere Telefonnummer (entferne alles auÃŸer Zahlen)
            let phone = ride.customerPhone.replace(/[^0-9+]/g, '');
            
            // FÃ¼ge +49 hinzu wenn nicht vorhanden
            if (!phone.startsWith('+')) {
                if (phone.startsWith('0')) {
                    phone = '+49' + phone.substring(1);
                } else if (!phone.startsWith('49')) {
                    phone = '+49' + phone;
                } else {
                    phone = '+' + phone;
                }
            }
            
            console.log('ğŸ’¾ Telefonnummer:', phone);
            
            // Erstelle Nachricht
            let message = '';
            const customerName = ride.customerName || 'Kunde';
            const pickup = ride.pickup || 'Abholort';
            const destination = ride.destination || 'Zielort';
            const trackingLink = ride.trackingLink || 'https://funk-taxi.app';
            
            switch(template) {
                case 'arrived':
                    message = `ğŸš• Ihr Taxi ist da!

Guten Tag ${customerName},
Ihr Taxi wartet vor der TÃ¼r.

ğŸ“ Abholung: ${pickup}
ğŸ¯ Ziel: ${destination}

Funk Taxi Heringsdorf`;
                    break;
                    
                case '5min':
                    message = `â±ï¸ Bin in 5 Minuten da!

Hallo ${customerName},
Ihr Taxi kommt gleich.

ğŸ“ Abholung: ${pickup}

Funk Taxi Heringsdorf`;
                    break;
                    
                case 'tracking':
                    message = `ğŸ“ Ihr Taxi ist unterwegs!

Live verfolgen:
${trackingLink}

ğŸ• Abholung: ${new Date(ride.pickupTimestamp).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})} Uhr

Funk Taxi Heringsdorf`;
                    break;
                    
                case 'delay':
                    message = `â±ï¸ Kleine VerzÃ¶gerung

Hallo ${customerName},
es dauert ca. 10 Minuten lÃ¤nger.

Wir bitten um Entschuldigung!

Funk Taxi Heringsdorf`;
                    break;
            }
            
            // Ã–ffne WhatsApp
            const whatsappURL = `https://wa.me/${phone.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(message)}`;
            console.log('ğŸ”— WhatsApp URL:', whatsappURL);
            
            // Ã–ffne in neuem Tab/Fenster
            window.open(whatsappURL, '_blank');
            
            // SchlieÃŸe Dropdown
            document.getElementById('wa-dropdown-' + rideId).style.display = 'none';
            
            // Feedback
            console.log('âœ… WhatsApp geÃ¶ffnet!');
        }
        
        // SMS senden
        async function sendQuickSMS(rideId, template) {
            console.log('ğŸ“± SMS wird gesendet:', rideId, template);
            
            // Hole Fahrt-Daten
            let ride = null;
            if (isFirebaseReady) {
                const snapshot = await db.ref('rides/' + rideId).once('value');
                ride = snapshot.val();
            }
            
            if (!ride) {
                alert('ğŸ’¾ Fahrt nicht gefunden');
                return;
            }
            
            // PrÃ¼fe Telefonnummer
            if (!ride.customerPhone) {
                alert('ğŸ’¾ Keine Telefonnummer vorhanden');
                return;
            }
            
            // Formatiere Telefonnummer
            let phone = ride.customerPhone.replace(/[^0-9+]/g, '');
            if (!phone.startsWith('+')) {
                if (phone.startsWith('0')) {
                    phone = '+49' + phone.substring(1);
                } else if (!phone.startsWith('49')) {
                    phone = '+49' + phone;
                } else {
                    phone = '+' + phone;
                }
            }
            
            console.log('ğŸ’¾ Telefonnummer:', phone);
            
            // Erstelle Nachricht (KÃœRZER fÃ¼r SMS!)
            let message = '';
            const pickup = ride.pickup || 'Abholort';
            const destination = ride.destination || 'Zielort';
            const trackingLink = ride.trackingLink || 'https://funk-taxi.app';
            
            // KÃ¼rze Adressen fÃ¼r SMS
            const shortPickup = pickup.length > 30 ? pickup.substring(0, 30) + '...' : pickup;
            const shortDest = destination.length > 30 ? destination.substring(0, 30) + '...' : destination;
            
            switch(template) {
                case 'arrived':
                    message = `Taxi ist da! Von: ${shortPickup} Nach: ${shortDest} - Funk Taxi`;
                    break;
                    
                case '5min':
                    message = `Komme in 5 Min zu ${shortPickup} - Funk Taxi`;
                    break;
                    
                case 'tracking':
                    message = `Taxi-Tracking: ${trackingLink}`;
                    break;
                    
                case 'delay':
                    message = `Ca. 10 Min VerzÃ¶gerung. Entschuldigung! - Funk Taxi`;
                    break;
            }
            
            // Ã–ffne SMS-App
            const smsURL = `sms:${phone}?body=${encodeURIComponent(message)}`;
            console.log('ğŸ”— SMS URL:', smsURL);
            
            // Ã–ffne SMS-App (funktioniert auf Handy!)
            window.location.href = smsURL;
            
            // SchlieÃŸe Dropdown
            document.getElementById('sms-dropdown-' + rideId).style.display = 'none';
            
            // Feedback
            console.log('âœ… SMS-App geÃ¶ffnet!');
        }
        
        // ğŸ†• v5.87.63: AUTOCOMPLETE FÃœR EDIT-MODAL
        function setupEditAutocomplete() {
            console.log('â­ setupEditAutocomplete wird initialisiert...');
            
            ['edit-pickup', 'edit-destination'].forEach(id => {
                const input = document.getElementById(id);
                const dropdown = document.getElementById(id + '-dropdown');
                
                if (!input || !dropdown) {
                    console.log(`â„¹ï¸ ${id} nicht gefunden (normal wenn Modal geschlossen)`);
                    return;
                }
                
                console.log('âœ… Autocomplete registriert fÃ¼r:', id);
                
                // FOCUS - Zeige Favoriten
                input.addEventListener('focus', () => {
                    const value = input.value.trim();
                    if (!value || value.length < 3) {
                        searchAddresses('', id);
                    }
                });
                
                // INPUT - Suche bei Tippen
                let timeout = null;
                input.addEventListener('input', (e) => {
                    clearTimeout(timeout);
                    const value = e.target.value.trim();
                    
                    if (value.length === 0) {
                        searchAddresses('', id);
                        return;
                    }
                    
                    if (value.length < 3) {
                        dropdown.innerHTML = '<div style="padding:10px;color:#999;">Mindestens 3 Zeichen...</div>';
                        dropdown.style.display = 'block';
                        return;
                    }
                    
                    timeout = setTimeout(() => {
                        searchAddresses(value, id);
                    }, 300);
                });
                
                // BLUR - SchlieÃŸe Dropdown nach kurzer VerzÃ¶gerung
                input.addEventListener('blur', () => {
                    setTimeout(() => {
                        if (dropdown) dropdown.style.display = 'none';
                    }, 200);
                });
            });
            
            console.log('âœ… setupEditAutocomplete abgeschlossen!');
        }
        
        // ğŸ†• v5.90.123: ZIFFERNBLOCK FÃœR BEARBEITEN-MODAL
        function openEditTimeKeypad() {
            const timeBtn = document.getElementById('edit-time-btn');
            const timeInput = document.getElementById('edit-time');
            
            const currentTime = timeBtn ? timeBtn.textContent.trim() : '09:00';
            
            console.log('âŒ¨ï¸ Ã–ffne Ziffernblock fÃ¼r Bearbeiten:', currentTime);
            
            showTimeKeypad(currentTime, (newTime) => {
                console.log('âœ… Zeit gewÃ¤hlt:', newTime);
                
                if (timeBtn) timeBtn.textContent = newTime;
                if (timeInput) timeInput.value = newTime;
                
                console.log('ğŸ“± Bearbeiten Zeit gesetzt:', newTime);
            });
        }
        
        async function saveEditedRide(rideId) {
            const newPickup = document.getElementById('edit-pickup').value.trim();
            const newDestination = document.getElementById('edit-destination').value.trim();
            const newCustomer = document.getElementById('edit-customer').value.trim();
            
            // ğŸ†• v5.90.123: Getrennte Datum/Zeit Felder!
            const newDate = document.getElementById('edit-date')?.value;
            const newTime = document.getElementById('edit-time')?.value || document.getElementById('edit-time-btn')?.textContent?.trim() || '09:00';
            const newDateTime = newDate ? `${newDate}T${newTime}` : '';
            
            const newPassengers = document.getElementById('edit-passengers').value;
            const newVehicleId = document.getElementById('edit-vehicle').value;
            
            // ğŸ†• v5.75.2: GAST-NAME!
            const newGuestName = document.getElementById('edit-guest-name')?.value?.trim() || '';
            
            // ğŸ†• v5.90.121: PREIS-MODUS mit Krankenfahrt!
            const priceMode = document.querySelector('input[name="edit-price-mode"]:checked')?.value || 'normal';
            const isKrankenfahrt = priceMode === 'medical';
            const shouldCalculatePrice = priceMode === 'normal';
            const durationMode = document.querySelector('input[name="edit-duration-mode"]:checked').value;
            
            console.log('ğŸ’° Preis-Modus:', priceMode);
            console.log('ğŸ¥ Krankenfahrt?', isKrankenfahrt);
            console.log('ğŸ’° Preis berechnen?', shouldCalculatePrice);
            console.log('â±ï¸ Dauer-Modus:', durationMode);
            console.log('ğŸ“ Gast-Name:', newGuestName || '(leer)');
            
            if (!newPickup || !newDestination) {
                alert('ğŸ’¾ Abholort und Zielort mÃ¼ssen ausgefÃ¼llt sein!');
                return;
            }
            
            // ğŸ†• v5.90.276: TIMESTAMP ZUERST BERECHNEN!
            const newTimestamp = new Date(newDateTime).getTime();
            
            // ğŸ†• v5.75.0: GEOCODE WENN PREIS/ZEIT BERECHNET WERDEN SOLL!
            let pickupCoords = null;
            let destCoords = null;
            let distance = 0;
            let duration = 15;
            let price = 0;
            
            if (shouldCalculatePrice || durationMode === 'calculated') {
                console.log('ğŸ—ºï¸ Geocode Adressen fÃ¼r Berechnung...');
                
                try {
                    // Geocode Abholort
                    const pickupResponse = await fetch(
                        `https://nominatim.openstreetmap.org/search?` +
                        `format=json&` +
                        `q=${encodeURIComponent(newPickup)}&` +
                        `countrycodes=de&viewbox=10.6,54.7,14.4,53.1&bounded=1&` +
                        `limit=1`
                    );
                    const pickupData = await pickupResponse.json();
                    if (pickupData.length > 0) {
                        pickupCoords = { lat: parseFloat(pickupData[0].lat), lon: parseFloat(pickupData[0].lon) };
                    }
                    
                    // Geocode Zielort
                    const destResponse = await fetch(
                        `https://nominatim.openstreetmap.org/search?` +
                        `format=json&` +
                        `q=${encodeURIComponent(newDestination)}&` +
                        `countrycodes=de&viewbox=10.6,54.7,14.4,53.1&bounded=1&` +
                        `limit=1`
                    );
                    const destData = await destResponse.json();
                    if (destData.length > 0) {
                        destCoords = { lat: parseFloat(destData[0].lat), lon: parseFloat(destData[0].lon) };
                    }
                    
                    // Route berechnen wenn beides vorhanden
                    if (pickupCoords && destCoords) {
                        const routeData = await calculateRoute(pickupCoords, destCoords);
                        distance = parseFloat(routeData.distance);
                        duration = routeData.duration;
                        
                        // Preis berechnen wenn gewÃ¼nscht
                        if (shouldCalculatePrice) {
                            const pricing = calculatePrice(distance, newTimestamp);
                            price = pricing.total;
                            console.log('âœ… Preis berechnet:', price, 'â‚¬');
                        }
                        
                        // Dauer Ã¼berschreiben wenn feste Zeit
                        if (durationMode === 'fixed') {
                            duration = 15;
                            console.log('â±ï¸ Feste Dauer: 15 Min');
                        } else {
                            console.log('â±ï¸ Berechnete Dauer:', duration, 'Min');
                        }
                        
                        console.log('âœ… Route berechnet: Distanz', distance, 'km, Dauer', duration, 'Min');
                    } else {
                        console.warn('âš ï¸ Koordinaten konnten nicht gefunden werden');
                        // Fallback: Feste Werte
                        duration = durationMode === 'fixed' ? 15 : 20;
                        price = 0;
                    }
                } catch (error) {
                    console.error('ğŸ’¾ Fehler bei Geocoding/Route:', error);
                    // Fallback
                    duration = durationMode === 'fixed' ? 15 : 20;
                    price = 0;
                }
            } else {
                // Keine Berechnung gewÃ¼nscht
                duration = durationMode === 'fixed' ? 15 : 20;
                price = 0;
                console.log('â„¹ï¸ Keine Berechnung - Feste Werte verwendet');
            }
            
            // ğŸ†• v5.90.276: newTimestamp schon oben definiert!
            const now = Date.now();
            const minutesUntilPickup = (newTimestamp - now) / (1000 * 60);
            const newStatus = minutesUntilPickup <= 15 ? 'new' : 'vorbestellt';
            
            const updates = {
                pickup: newPickup,
                destination: newDestination,
                customerName: newCustomer,
                guestName: newGuestName, // ğŸ†• v5.75.2: GAST-NAME!
                pickupTimestamp: newTimestamp,
                pickupTime: new Date(newTimestamp).toLocaleString('de-DE', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                passengers: newPassengers,
                status: newStatus,
                editedAt: Date.now(),
                // ğŸ†• v5.90.121: KRANKENFAHRT!
                isKrankenfahrt: isKrankenfahrt,
                rideType: isKrankenfahrt ? 'krankenfahrt' : 'normal',
                // ğŸ†• v5.75.0: PREIS/DISTANZ/DAUER!
                price: isKrankenfahrt ? 0 : price,
                distance: distance,
                duration: duration
            };
            
            // ğŸ†• v5.75.0: Koordinaten speichern falls vorhanden
            if (pickupCoords && destCoords) {
                updates.pickupCoords = pickupCoords;
                updates.destCoords = destCoords;
            }
            
            // ğŸ†• v5.64.42: VOLLSTÃ„NDIGE FAHRZEUG-ZUWEISUNG!
            if (newVehicleId && newVehicleId !== '') {
                try {
                    // Lade Fahrzeugdaten aus Firebase
                    const vehicleSnapshot = await db.ref('vehicles/' + newVehicleId).once('value');
                    const vehicleData = vehicleSnapshot.val();
                    
                    if (vehicleData) {
                        // Speichere ALLE Fahrzeugdaten
                        updates.vehicleId = newVehicleId;
                        updates.vehicle = vehicleData.name || newVehicleId;
                        updates.vehicleLabel = vehicleData.name || newVehicleId;
                        updates.vehiclePlate = vehicleData.plate || '';
                        updates.status = 'accepted'; // â† Status auf ACCEPTED!
                        updates.acceptedAt = Date.now();
                        updates.assignedBy = 'admin';
                        
                        console.log('âœ… Fahrzeugdaten geladen:', vehicleData.name, vehicleData.plate);
                    } else {
                        console.warn('âš ï¸ Fahrzeug nicht gefunden:', newVehicleId);
                    }
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim Laden der Fahrzeugdaten:', error);
                }
            } else {
                // Fahrzeug entfernen
                updates.vehicleId = null;
                updates.vehicle = null;
                updates.vehicleLabel = null;
                updates.vehiclePlate = null;
            }
            
            // Update Firebase
            let telegramSent = false; // Track Telegram status
            if (isFirebaseReady) {
                try {
                    await db.ref('rides/' + rideId).update(updates);
                    console.log('âœ… Fahrt in Firebase aktualisiert');
                    
                    // ğŸ†• v5.90.335: MAP-NULL-CHECK-FIX-LINK WIEDER AKTIVIERT!
                    // Link wird hier erstellt wenn Fahrzeug zugewiesen!
                    if (newVehicleId && newVehicleId !== '') {
                        console.log('ğŸ”— v5.90.335: Erstelle Tracking-Link (saveEditedRide)...');
                        try {
                            const trackingLink = await createTrackingLinkForRide(rideId, newVehicleId);
                            if (trackingLink) {
                                console.log('âœ… v5.90.335: Tracking-Link erstellt:', trackingLink);
                                
                                // ğŸ“± v5.90.335: SMS AN KUNDEN!
                                const rideSnap = await db.ref('rides/' + rideId).once('value');
                                const rideData = rideSnap.val();
                                if (rideData) {
                                    await sendCustomerNotifications(rideData);
                                    console.log('âœ… v5.90.335: SMS an Kunde versendet!');
                                }
                            }
                        } catch (linkError) {
                            console.error('ğŸ’¾ v5.90.335: Tracking-Link Fehler:', linkError);
                        }
                    } else {
                        console.log('â„¹ï¸ Kein Fahrzeug - Tracking-Link wird bei Fahrer-Accept erstellt');
                    }
                    
                    // ğŸ“± v5.64.43: TELEGRAM RICHTIG SENDEN!
                    if (newVehicleId && updates.vehicle) {
                        console.log('ğŸ“± Suche Fahrer fÃ¼r Fahrzeug:', newVehicleId);
                        
                        // 1ï¸âƒ£ FINDE FAHRER DER DIESES FAHRZEUG NUTZT
                        const driversSnapshot = await db.ref('vehicles').once('value');
                        let driverId = null;
                        
                        driversSnapshot.forEach(child => {
                            const driver = child.val();
                            // PrÃ¼fe ob Fahrer dieses Fahrzeug hat
                            if (child.key === newVehicleId || driver.vehicle === newVehicleId) {
                                driverId = child.key;
                                console.log('âœ… Fahrer gefunden:', driverId, 'fÃ¼r Fahrzeug:', newVehicleId);
                            }
                        });
                        
                        if (driverId) {
                            // Lade komplette Fahrt fÃ¼r Telegram
                            const rideSnapshot = await db.ref('rides/' + rideId).once('value');
                            const ride = rideSnapshot.val();
                            
                            if (ride) {
                                try {
                                    telegramSent = await sendTelegramToDriver(driverId, ride, 0);
                                    if (telegramSent) {
                                        console.log('âœ… Telegram gesendet an Fahrer:', driverId);
                                    } else {
                                        console.warn('âš ï¸ Telegram konnte nicht gesendet werden (keine Chat-ID?)');
                                    }
                                } catch (telegramError) {
                                    console.error('ğŸ’¾ Telegram-Fehler:', telegramError);
                                    telegramSent = false;
                                }
                            }
                        } else {
                            console.warn('âš ï¸ Kein Fahrer gefunden fÃ¼r Fahrzeug:', newVehicleId);
                        }
                    }
                    
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim Aktualisieren:', error);
                    alert('ğŸ’¾ Fehler beim Speichern: ' + error.message);
                    return;
                }
            }
            
            // Update localStorage
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            const ride = history.find(r => r.firebaseId === rideId || r.id === rideId);
            if (ride) {
                Object.assign(ride, updates);
                localStorage.setItem('rideHistory', JSON.stringify(history));
            }
            
            // ğŸ†• v5.64.42: Bessere Erfolgs-Meldung - SOFORT zeigen!
            if (newVehicleId && updates.vehicle) {
                let message = `âœ… Fahrt aktualisiert!\n\nğŸš— Zugewiesen an: ${updates.vehicle}${updates.vehiclePlate ? ' (' + updates.vehiclePlate + ')' : ''}`;
                if (telegramSent) {
                    message += `\nğŸ“± Telegram wurde gesendet!`;
                } else {
                    message += `\nâš ï¸ Telegram konnte nicht gesendet werden\n(Fahrer hat keine Telegram-ID hinterlegt)`;
                }
                // SOFORT zeigen, nicht warten auf async calls!
                setTimeout(() => alert(message), 0);
            } else {
                setTimeout(() => alert('âœ… Fahrt wurde aktualisiert!'), 0);
            }
            
            closeEditModal();
            
            // Aktualisiere Views
            updateHistoryView();
            updateAdminView();
            
            // ğŸ†• v5.64.43: ECHTZEIT-UPDATES! Kalender & alle Views
            if (typeof loadCalendarData === 'function') {
                console.log('ğŸ”„ Lade Kalender neu...');
                await loadCalendarData();
            }
            if (typeof renderCalendar === 'function') {
                console.log('ğŸ”„ Rendere Kalender...');
                await renderCalendar();
            }
            if (typeof updateViews === 'function') {
                console.log('ğŸ”„ Aktualisiere alle Views...');
                updateViews();
            }
            if (typeof updateAdminTabsVisibility === 'function') {
                updateAdminTabsVisibility();
            }
            
            // ğŸ†• v5.64.43: Trigger manuellen Reload der rides
            if (isFirebaseReady) {
                console.log('ğŸ”„ Triggere rides reload...');
                const ridesSnapshot = await db.ref('rides').once('value');
                rides = [];
                ridesSnapshot.forEach(child => {
                    const r = child.val();
                    r.firebaseId = child.key;
                    rides.push(r);
                });
                console.log('âœ… Rides neu geladen:', rides.length);
            }
        }
        
        // ğŸ”„ FAHRT NEU ZUWEISEN (aus rejected zurÃ¼ck zu new)
        async function reassignRide(rideId) {
            try {
                const ride = rides.find(r => (r.firebaseId || r.id) === rideId);
                if (!ride) {
                    alert('ğŸ’¾ Fahrt nicht gefunden!');
                    return;
                }
                
                // âš ï¸ WICHTIG: Verhindere Neu-Zuweisung von angenommenen Fahrten!
                if (ride.status === 'accepted' || ride.status === 'picked_up') {
                    alert('ğŸ’¾ Fehler!\n\nDiese Fahrt wurde bereits angenommen und kann nicht neu zugewiesen werden.\n\nStatus: ' + ride.status);
                    return;
                }
                
                if (!confirm('ğŸ”„ Fahrt neu zuweisen?\n\nDie Fahrt wird wieder als "neu" markiert und kann von Fahrern angenommen werden.')) {
                    return;
                }
                
                // ZurÃ¼ck zu "new" Status
                const updates = {
                    status: 'new',
                    rejectedBy: null,
                    rejectedAt: null,
                    rejectedByDriver: null,
                    vehicleId: null,
                    vehicle: null
                };
                
                if (isFirebaseReady) {
                    await db.ref('rides/' + rideId).update(updates);
                    console.log('ğŸ”„ Fahrt neu zugewiesen:', rideId);
                }
                
                // Update lokal
                Object.assign(ride, updates);
                saveRides();
                
                updateViews();
                alert('âœ… Fahrt neu zugewiesen!\n\nDie Fahrt ist jetzt wieder fÃ¼r alle Fahrer verfÃ¼gbar.');
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Neu-Zuweisen:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // ğŸ—‘ï¸ FAHRT LÃ–SCHEN (Admin)
        async function deleteRide(rideId) {
            const confirmDelete = confirm('ğŸ—‘ï¸ Fahrt wirklich LÃ–SCHEN?\n\nDies kann nicht rÃ¼ckgÃ¤ngig gemacht werden!');
            if (!confirmDelete) return;
            
            // ğŸ†• Lade Fahrt VORHER um Telegram zu senden und zu loggen
            let ride = null;
            if (isFirebaseReady) {
                try {
                    const snapshot = await db.ref('rides/' + rideId).once('value');
                    ride = snapshot.val();
                    
                    // ğŸ“œ LOGGING: Fahrt wird gelÃ¶scht
                    if (ride) {
                        logActivity('status', 'deleted', 
                            `Fahrt gelÃ¶scht: ${ride.customerName} (${ride.pickup} â†’ ${ride.destination})`, {
                            customer: ride.customerName,
                            phone: ride.customerPhone,
                            pickup: ride.pickup,
                            destination: ride.destination,
                            status: ride.status,
                            vehicle: ride.vehicle || 'Nicht zugewiesen',
                            price: ride.price,
                            deletedBy: currentUser ? currentUser.email : 'Admin'
                        });
                    }
                    
                    // ğŸ“± TELEGRAM SENDEN - IMMER wenn Fahrt existiert!
                    if (ride) {
                        await sendTelegramForDeletedRide(ride);
                    }
                    
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim Laden der Fahrt:', error);
                }
            }
            
            // LÃ¶sche aus Firebase
            if (isFirebaseReady) {
                try {
                    await db.ref('rides/' + rideId).remove();
                    console.log('âœ… Fahrt aus Firebase gelÃ¶scht');
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim LÃ¶schen:', error);
                }
            }
            
            // LÃ¶sche aus localStorage
            let history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            history = history.filter(r => r.firebaseId !== rideId && r.id !== rideId);
            localStorage.setItem('rideHistory', JSON.stringify(history));
            
            alert('âœ… Fahrt wurde gelÃ¶scht!');
            updateAdminView();
        }
        
        // ğŸš— v5.31.5: FAHRER MANUELL ZUWEISEN (Admin)
        async function assignVehicleToRide(rideId) {
            try {
                // Lade Fahrt
                const ride = rides.find(r => (r.firebaseId || r.id) === rideId);
                if (!ride) {
                    alert('ğŸ’¾ Fahrt nicht gefunden!');
                    return;
                }
                
                // ğŸ†• v5.52.1: Lade ALLE Fahrzeuge aus Verwaltung + prÃ¼fe Online-Status
                const vehiclesList = [];
                if (isFirebaseReady) {
                    const [vehiclesSnapshot, driversSnapshot] = await Promise.all([
                        db.ref('vehicles').once('value'),
                        db.ref('vehicles').once('value')
                    ]);
                    
                    const onlineVehicleIds = new Set();
                    
                    // Sammle Online-Fahrzeuge von Fahrern
                    driversSnapshot.forEach(child => {
                        const driver = child.val();
                        if (driver.online && driver.vehicle) {
                            onlineVehicleIds.add(driver.vehicle);
                        }
                    });
                    
                    // Lade alle Fahrzeuge aus Verwaltung
                    vehiclesSnapshot.forEach(child => {
                        const v = child.val();
                        v.id = child.key;
                        v.isOnline = onlineVehicleIds.has(v.id);
                        vehiclesList.push(v);
                    });
                    
                    // Sortiere: Online zuerst, dann alphabetisch
                    vehiclesList.sort((a, b) => {
                        if (a.isOnline && !b.isOnline) return -1;
                        if (!a.isOnline && b.isOnline) return 1;
                        return (a.name || '').localeCompare(b.name || '');
                    });
                }
                
                if (vehiclesList.length === 0) {
                    alert('ğŸ’¾ Keine Fahrzeuge verfÃ¼gbar!');
                    return;
                }
                
                // Modal erstellen
                const modal = document.createElement('div');
                modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;';
                
                let vehicleOptions = '';
                vehiclesList.forEach(v => {
                    const statusIcon = v.isOnline ? 'ğŸŸ¢' : 'âšª';
                    const statusText = v.isOnline ? 'ONLINE' : 'OFFLINE';
                    const displayName = `${v.name || v.id}`;
                    const plate = v.plate || 'Kein Kennzeichen';
                    
                    vehicleOptions += `
                        <div onclick="selectVehicleForAssignment('${rideId}', '${v.id}')" 
                             style="padding:15px;background:white;border:2px solid ${v.isOnline ? '#10b981' : '#e5e7eb'};border-radius:10px;cursor:pointer;margin-bottom:10px;transition:all 0.2s;"
                             onmouseover="this.style.borderColor='#667eea';this.style.background='#f3f4f6'"
                             onmouseout="this.style.borderColor='${v.isOnline ? '#10b981' : '#e5e7eb'}';this.style.background='white'">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <div style="font-size:18px;font-weight:700;color:#1f2937;">
                                    ${statusIcon} ${displayName}
                                </div>
                                <div style="font-size:11px;font-weight:600;padding:3px 8px;border-radius:12px;background:${v.isOnline ? '#d1fae5' : '#f3f4f6'};color:${v.isOnline ? '#065f46' : '#6b7280'};">
                                    ${statusText}
                                </div>
                            </div>
                            <div style="font-size:14px;color:#6b7280;">ğŸš— ${plate}</div>
                        </div>
                    `;
                });
                
                modal.innerHTML = `
                    <div style="background:white;border-radius:16px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;">
                        <div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;border-radius:16px 16px 0 0;">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <h3 style="margin:0;font-size:20px;">ğŸš— Fahrzeug zuweisen</h3>
                                <button onclick="this.closest('div').parentElement.parentElement.remove()" 
                                    style="background:rgba(255,255,255,0.2);border:none;color:white;font-size:24px;width:32px;height:32px;border-radius:50%;cursor:pointer;">Ã—</button>
                            </div>
                        </div>
                        <div style="padding:20px;">
                            <div style="background:#f9fafb;padding:15px;border-radius:10px;margin-bottom:20px;">
                                <div style="font-weight:700;margin-bottom:8px;">ğŸ“ ${ride.pickup}</div>
                                <div style="font-weight:700;color:#667eea;">ğŸ¯ ${ride.destination}</div>
                                <div style="margin-top:8px;color:#6b7280;">ğŸ’¾ ${ride.customerName} | ğŸ’° ${ride.price}â‚¬</div>
                            </div>
                            <div style="font-weight:600;margin-bottom:15px;color:#1f2937;">WÃ¤hle ein Fahrzeug:</div>
                            ${vehicleOptions}
                            <button onclick="this.closest('div').parentElement.parentElement.remove()" 
                                style="width:100%;padding:12px;background:#e5e7eb;color:#1f2937;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-top:10px;">
                                Abbrechen
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Zuweisen:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸš— v5.63.6: ZENTRALE FAHRZEUG-ZUWEISUNG
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DIESE Funktion wird von ÃœBERALL genutzt:
        // - Schnellbuchung
        // - Admin offene Fahrten
        // - Admin Kalender
        // - Ãœberall gleiche Logik!
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.90.44: MAP-NULL-CHECK-FIX-LINK SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Generiere eindeutigen Tracking-Code
        function generateTrackingCode() {
            const random = Math.random().toString(36).substr(2, 9);
            const timestamp = Date.now().toString(36);
            return 'track_' + random + timestamp;
        }
        
        // Erstelle Tracking-Link fÃ¼r Fahrt
        async function createTrackingLinkForRide(rideId, vehicleId) {
            try {
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('ğŸ”— MAP-NULL-CHECK-FIX-LINK ERSTELLEN');
                console.log('   Fahrt:', rideId);
                console.log('   Fahrzeug:', vehicleId);
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
                // Hole Fahrt-Daten
                const rideSnap = await db.ref('rides/' + rideId).once('value');
                const ride = rideSnap.val();
                
                if (!ride) {
                    console.error('ğŸ’¾ Fahrt nicht gefunden:', rideId);
                    return null;
                }
                
                // PrÃ¼fe: Schon Tracking-Link vorhanden?
                if (ride.trackingLink) {
                    console.log('â„¹ï¸ Tracking-Link bereits vorhanden:', ride.trackingLink);
                    return ride.trackingLink;
                }
                
                // PrÃ¼fe WANN der Tracking-Link erstellt werden soll
                const now = Date.now();
                const pickupTime = ride.pickupTimestamp || 0;
                const timeDiff = pickupTime - now;
                const minutesUntilPickup = Math.round(timeDiff / 60000);
                
                console.log('â° Abholzeit:', new Date(pickupTime).toLocaleString('de-DE'));
                console.log('â° In', minutesUntilPickup, 'Minuten');
                
                // ğŸ†• v5.90.48: LINK WIRD IMMER SOFORT ERSTELLT!
                // Nicht mehr warten bis 15 Min vorher!
                console.log('âœ… Erstelle Link JETZT (unabhÃ¤ngig von Abholzeit)!');
                
                const trackingCode = generateTrackingCode();
                const trackingLink = `https://patrick061977.github.io/taxi-App/track.html?code=${trackingCode}`;
                
                // Tracking-Daten in Firebase speichern
                await db.ref('tracking/' + trackingCode).set({
                    rideId: rideId,
                    vehicleId: vehicleId,
                    createdAt: now,
                    active: true,
                    expiresAt: pickupTime + (2 * 60 * 60 * 1000) // 2h nach Abholung
                });
                
                // Link in Fahrt speichern
                await db.ref('rides/' + rideId).update({
                    trackingLink: trackingLink,
                    trackingCode: trackingCode,
                    trackingLinkCreated: true,
                    trackingLinkCreatedAt: now
                });
                
                // Activity Log
                await db.ref('rides/' + rideId + '/activityLog').push({
                    type: 'tracking_link_created',
                    trackingLink: trackingLink,
                    timestamp: now,
                    message: 'Tracking-Link erstellt'
                });
                
                console.log('âœ… Tracking-Link erstellt:', trackingLink);
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
                // Google Calendar Update (wenn aktiviert UND Hotel-Event)
                if (ride.hotelCalendarId) {
                    const trackingEnabled = await isTrackingLinkInCalendarEnabled();
                    if (trackingEnabled) {
                        console.log('ğŸ“… Update Google Calendar mit Tracking-Link...');
                        await updateGoogleCalendarWithTracking(ride.hotelCalendarId, trackingLink);
                    }
                }
                
                return trackingLink;
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Erstellen des Tracking-Links:', error);
                return null;
            }
        }
        
        // PrÃ¼fe ob Tracking-Links in Calendar aktiviert sind
        async function isTrackingLinkInCalendarEnabled() {
            try {
                const snapshot = await db.ref('settings/calendarExportTrackingLinks').once('value');
                return snapshot.val() === true;
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Lesen der Tracking-Einstellung:', error);
                return false; // Default: AUS
            }
        }
        
        // Toggle Tracking-Links in Calendar
        async function toggleCalendarTrackingLinks(enabled) {
            try {
                await db.ref('settings/calendarExportTrackingLinks').set(enabled);
                console.log('ğŸ“ Tracking-Links in Calendar:', enabled ? 'AN âœ…' : 'AUS ğŸ’¾');
                alert(enabled ? 'âœ… Tracking-Links werden jetzt zu Google Calendar Events hinzugefÃ¼gt!' : 'ğŸ’¾ Tracking-Links werden nicht mehr zu Google Calendar hinzugefÃ¼gt');
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Speichern:', error);
                alert('ğŸ’¾ Fehler beim Speichern der Einstellung!');
            }
        }
        
        // Update Google Calendar Event mit Tracking-Link
        async function updateGoogleCalendarWithTracking(calendarEventId, trackingLink) {
            try {
                console.log('ğŸ“… Aktualisiere Google Calendar Event:', calendarEventId);
                
                if (!gapi || !gapi.client || !gapi.client.calendar) {
                    console.warn('âš ï¸ Google Calendar API nicht verfÃ¼gbar');
                    return;
                }
                
                // Hole aktuelles Event
                const event = await gapi.client.calendar.events.get({
                    calendarId: 'primary',
                    eventId: calendarEventId
                });
                
                if (!event || !event.result) {
                    console.error('ğŸ’¾ Event nicht gefunden');
                    return;
                }
                
                // FÃ¼ge Tracking-Link zur Beschreibung hinzu
                const currentDescription = event.result.description || '';
                
                // PrÃ¼fe ob schon ein Tracking-Link drin ist
                if (currentDescription.includes('ğŸš• LIVE-MAP-NULL-CHECK-FIX:')) {
                    console.log('â„¹ï¸ Tracking-Link bereits in Event vorhanden');
                    return;
                }
                
                const newDescription = currentDescription + `\n\nğŸš• LIVE-MAP-NULL-CHECK-FIX:\n${trackingLink}\n\nKlicken Sie hier um Ihr Taxi live zu verfolgen!`;
                
                // Update Event
                await gapi.client.calendar.events.patch({
                    calendarId: 'primary',
                    eventId: calendarEventId,
                    resource: {
                        description: newDescription
                    }
                });
                
                console.log('âœ… Google Calendar Event aktualisiert mit Tracking-Link!');
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Update von Google Calendar:', error);
            }
        }
        
        // Automatischer Check fÃ¼r ausstehende Tracking-Links (lÃ¤uft alle 60 Sek)
        async function checkPendingTrackingLinks() {
            try {
                const now = Date.now();
                const in15Min = now + (15 * 60 * 1000);
                const in16Min = now + (16 * 60 * 1000);
                
                // Suche Fahrten die in 15-16 Min starten UND trackingLinkPending haben
                const snapshot = await db.ref('rides')
                    .orderByChild('pickupTimestamp')
                    .startAt(in15Min)
                    .endAt(in16Min)
                    .once('value');
                
                snapshot.forEach(async (child) => {
                    const ride = child.val();
                    const rideId = child.key;
                    
                    // PrÃ¼fungen
                    if (!ride.trackingLinkPending) return;
                    if (ride.trackingLink) return; // Schon erstellt
                    if (!ride.assignedVehicle && !ride.vehicleId) return; // Kein Fahrzeug
                    
                    const vehicleId = ride.assignedVehicle || ride.vehicleId;
                    
                    console.log('â° 15 Min vor Abholung - erstelle Tracking-Link fÃ¼r', rideId);
                    
                    await createTrackingLinkForRide(rideId, vehicleId);
                });
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Check von Pending Tracking-Links:', error);
            }
        }
        
        // Starte automatischen Check (alle 60 Sekunden)
        setInterval(checkPendingTrackingLinks, 60 * 1000);
        console.log('â° Automatischer Tracking-Link Check gestartet (alle 60 Sek)');
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function assignVehicleUnified(rideId, vehicleId, options = {}) {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸš— ZENTRALE FAHRZEUG-ZUWEISUNG');
            console.log('   Fahrt:', rideId);
            console.log('   Fahrzeug:', vehicleId);
            console.log('   Quelle:', options.source || 'unbekannt');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            try {
                // 1ï¸âƒ£ LADE FAHRZEUGDATEN AUS /VEHICLES/
                console.log('ğŸ“¥ Lade Fahrzeugdaten aus /vehicles/' + vehicleId);
                const vehicleSnapshot = await db.ref('vehicles/' + vehicleId).once('value');
                const vehicleData = vehicleSnapshot.val();
                
                if (!vehicleData) {
                    console.error('ğŸ’¾ Fahrzeug nicht gefunden in /vehicles/' + vehicleId);
                    throw new Error('Fahrzeug nicht gefunden!');
                }
                
                console.log('ğŸ“‹ Fahrzeugdaten geladen:', vehicleData);
                
                const vehicleName = vehicleData.name || vehicleId;
                const vehiclePlate = vehicleData.plate || '';
                
                console.log('âœ… Name:', vehicleName);
                console.log('âœ… Kennzeichen:', vehiclePlate);
                
                // 2ï¸âƒ£ ERSTELLE UPDATE-DATEN
                // ğŸ†• v5.90.62: Status ASSIGNED statt accepted - Fahrer muss akzeptieren!
                const updateData = {
                    vehicleId: vehicleId,
                    vehicle: vehicleName,
                    vehicleLabel: vehicleName,
                    vehiclePlate: vehiclePlate,
                    status: 'assigned',  // âœ… Fahrer muss noch akzeptieren!
                    assignedAt: Date.now(),
                    assignedBy: 'admin'
                };
                
                // Optional: assignedVehicle fÃ¼r Kalender-KompatibilitÃ¤t
                if (options.includeAssignedVehicle) {
                    updateData.assignedVehicle = vehicleId;
                }
                
                console.log('ğŸ’¾ Speichere in Firebase:', updateData);
                
                // 3ï¸âƒ£ SPEICHERE IN FIREBASE
                await db.ref('rides/' + rideId).update(updateData);
                
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('â„¹ï¸ MAP-NULL-CHECK-FIX-LINK WIRD ERST BEI FAHRER-ACCEPT ERSTELLT!');
                console.log('   Fahrer muss Fahrt annehmen (status: assigned â†’ accepted)');
                console.log('   Dann wird in acceptRide() der Link erstellt');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
                // ğŸ†• v5.90.62: Link wird NICHT mehr hier erstellt!
                // Wird erst in acceptRide() erstellt wenn Fahrer bestÃ¤tigt
                // const trackingLink = await createTrackingLinkForRide(rideId, vehicleId);
                
                const trackingLink = null; // Link noch nicht vorhanden
                
                // 4ï¸âƒ£ UPDATE LOKAL (wenn Fahrt geladen)
                const ride = rides.find(r => (r.firebaseId || r.id) === rideId);
                if (ride) {
                    Object.assign(ride, updateData);
                    console.log('âœ… Lokale Fahrt aktualisiert');
                }
                
                // 5ï¸âƒ£ ACTIVITY LOG
                await db.ref('rides/' + rideId + '/activityLog').push({
                    type: 'vehicle_assigned',
                    vehicleId: vehicleId,
                    vehicleName: vehicleName,
                    vehiclePlate: vehiclePlate,
                    timestamp: Date.now(),
                    message: `Fahrzeug ${vehicleName}${vehiclePlate ? ' (' + vehiclePlate + ')' : ''} zugewiesen (${options.source || 'Admin'})`
                });
                
                // 6ï¸âƒ£ TELEGRAM SENDEN (optional)
                if (options.sendTelegram !== false && ride) {
                    console.log('ğŸ“± Sende Telegram an Fahrer fÃ¼r Fahrzeug:', vehicleId);
                    
                    // ğŸ†• v5.64.43: FINDE FAHRER FÃœR DIESES FAHRZEUG!
                    const driversSnapshot = await db.ref('vehicles').once('value');
                    let driverId = null;
                    
                    driversSnapshot.forEach(child => {
                        const driver = child.val();
                        // PrÃ¼fe ob Fahrer dieses Fahrzeug hat
                        if (child.key === vehicleId || driver.vehicle === vehicleId) {
                            driverId = child.key;
                            console.log('âœ… Fahrer gefunden:', driverId);
                        }
                    });
                    
                    if (driverId) {
                        await sendTelegramToDriver(driverId, ride, 0);
                        console.log('âœ… Telegram gesendet!');
                    } else {
                        console.warn('âš ï¸ Kein Fahrer fÃ¼r Fahrzeug:', vehicleId);
                    }
                }
                
                // 7ï¸âƒ£ VIEWS AKTUALISIEREN (optional)
                if (options.updateViews !== false) {
                    console.log('ğŸ”„ Aktualisiere Views...');
                    if (typeof updateViews === 'function') updateViews();
                    if (typeof updateAdminTabsVisibility === 'function') updateAdminTabsVisibility();
                    if (typeof renderCalendar === 'function') await renderCalendar();
                    if (typeof loadCalendarData === 'function') await loadCalendarData();
                }
                
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('âœ… FAHRZEUG ERFOLGREICH ZUGEWIESEN!');
                console.log('   Fahrzeug:', vehicleName, vehiclePlate ? '(' + vehiclePlate + ')' : '');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
                return {
                    success: true,
                    vehicleName: vehicleName,
                    vehiclePlate: vehiclePlate
                };
                
            } catch (error) {
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.error('ğŸ’¾ FEHLER BEI FAHRZEUG-ZUWEISUNG!');
                console.error('   Fehler:', error);
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                throw error;
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // ğŸš— v5.63.6: FAHRZEUG AUSWAHL BESTÃ„TIGEN - NUTZT JETZT ZENTRALE FUNKTION!
        async function selectVehicleForAssignment(rideId, vehicleId) {
            try {
                console.log('ğŸš— selectVehicleForAssignment:', vehicleId, 'â†’', rideId);
                
                // Lade Fahrzeug-Vorschau fÃ¼r BestÃ¤tigung
                const vehicleSnapshot = await db.ref('vehicles/' + vehicleId).once('value');
                const vehicleData = vehicleSnapshot.val();
                
                if (!vehicleData) {
                    alert('ğŸ’¾ Fahrzeug nicht gefunden!');
                    return;
                }
                
                const vehicleName = vehicleData.name || vehicleId;
                const vehiclePlate = vehicleData.plate || '';
                
                // BestÃ¤tigung vom Benutzer
                if (!confirm(`ğŸš— Fahrt zuweisen an:\n\n${vehicleName}${vehiclePlate ? ' (' + vehiclePlate + ')' : ''}\n\nFortfahren?`)) {
                    return;
                }
                
                // ğŸ†• v5.63.6: NUTZE ZENTRALE FUNKTION!
                const result = await assignVehicleUnified(rideId, vehicleId, {
                    source: 'Admin offene Fahrten',
                    sendTelegram: true,
                    updateViews: true
                });
                
                // Modal schlieÃŸen
                const modal = document.querySelector('div[style*="position:fixed"]');
                if (modal) modal.remove();
                
                // Log Activity (zusÃ¤tzlich)
                const ride = rides.find(r => (r.firebaseId || r.id) === rideId);
                if (ride) {
                    logActivity('admin', 'assign', `Admin hat Fahrt zugewiesen: ${result.vehicleName}${result.vehiclePlate ? ' (' + result.vehiclePlate + ')' : ''}`, {
                        vehicle: result.vehicleName,
                        vehiclePlate: result.vehiclePlate,
                        customer: ride.customerName,
                        pickup: ride.pickup,
                        destination: ride.destination
                    });
                }
                
                alert(`âœ… Fahrt zugewiesen!\n\nğŸš— ${result.vehicleName}${result.vehiclePlate ? ' (' + result.vehiclePlate + ')' : ''}\nğŸ“± Telegram gesendet!`);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // ğŸ†• v5.90.279: ZUWEISUNG AUFHEBEN (Admin kann Fahrzeug-Zuweisung rÃ¼ckgÃ¤ngig machen!)
        async function unassignVehicleFromRide(rideId) {
            try {
                // BestÃ¤tigung
                if (!confirm('â†©ï¸ Zuweisung aufheben?\n\nDas Fahrzeug wird von der Fahrt entfernt.\nDer Fahrer sieht die Fahrt nicht mehr.\n\nFortfahren?')) {
                    return;
                }
                
                console.log('â†©ï¸ Hebe Zuweisung auf fÃ¼r Fahrt:', rideId);
                
                // Update in Firebase
                await db.ref('rides/' + rideId).update({
                    vehicleId: null,
                    driverId: null,
                    status: 'new', // ZurÃ¼ck auf "new"
                    unassignedAt: Date.now(),
                    unassignedBy: 'admin'
                });
                
                console.log('âœ… Zuweisung aufgehoben!');
                
                // Log Activity
                const ride = rides.find(r => (r.firebaseId || r.id) === rideId);
                if (ride) {
                    logActivity('admin', 'unassign', `Admin hat Zuweisung aufgehoben`, {
                        customer: ride.customerName,
                        pickup: ride.pickup,
                        destination: ride.destination
                    });
                }
                
                alert('âœ… Zuweisung aufgehoben!\n\nFahrt ist wieder verfÃ¼gbar.');
                
                // Refresh Views
                if (typeof loadCalendarRides === 'function') loadCalendarRides();
                if (typeof loadRides === 'function') loadRides();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Aufheben:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // ğŸ”„ ROUTE UMDREHEN (Admin - direkt in Firebase)
        async function reverseRouteAdmin(rideId) {
            const confirmReverse = confirm('ğŸ”„ Route umdrehen?\n\nVon â‡„ Nach werden getauscht.');
            if (!confirmReverse) return;
            
            // Lade Fahrt
            let ride = null;
            if (isFirebaseReady) {
                const snapshot = await db.ref('rides/' + rideId).once('value');
                ride = snapshot.val();
            }
            
            if (!ride) {
                alert('ğŸ’¾ Fahrt nicht gefunden');
                return;
            }
            
            // Tausche Von/Nach
            const updates = {
                pickup: ride.destination,
                destination: ride.pickup,
                editedAt: Date.now()
            };
            
            // Update Firebase
            if (isFirebaseReady) {
                try {
                    await db.ref('rides/' + rideId).update(updates);
                    console.log('âœ… Route in Firebase umgedreht');
                } catch (error) {
                    console.error('ğŸ’¾ Fehler:', error);
                }
            }
            
            // Update localStorage
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            const localRide = history.find(r => r.firebaseId === rideId || r.id === rideId);
            if (localRide) {
                Object.assign(localRide, updates);
                localStorage.setItem('rideHistory', JSON.stringify(history));
            }
            
            alert('âœ… Route wurde umgedreht!\n\n' + 
                  'Neu:\n' +
                  'Von: ' + ride.destination + '\n' +
                  'Nach: ' + ride.pickup);
            
            updateAdminView();
        }
        
        function saveAsFavorite(rideId) {
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            const ride = history.find(r => r.createdAt === rideId || r.id === rideId);
            
            if (!ride) {
                alert('ğŸ’¾ Fahrt nicht gefunden');
                return;
            }
            
            // Lade bestehende Favoriten
            const favorites = JSON.parse(localStorage.getItem('favoritRides') || '[]');
            
            // PrÃ¼fe ob schon vorhanden
            const exists = favorites.some(f => 
                f.pickup === ride.pickup && f.destination === ride.destination
            );
            
            if (exists) {
                alert('â­ Diese Route ist bereits ein Favorit!');
                return;
            }
            
            // FÃ¼ge hinzu
            const favorite = {
                id: Date.now(),
                name: `${ride.pickup} â†’ ${ride.destination}`,
                pickup: ride.pickup,
                destination: ride.destination,
                distance: ride.distance,
                price: ride.price,
                addedAt: Date.now()
            };
            
            favorites.push(favorite);
            localStorage.setItem('favoritRides', JSON.stringify(favorites));
            
            alert('â­ Als Favorit gespeichert!\n\n' +
                  ride.pickup + ' â†’ ' + ride.destination + '\n\n' +
                  'Favoriten findest du im Fahrgast-Tab oben.');
            
            // TODO: Favoriten-Anzeige implementieren
        }

        // ğŸ”” SERVICE WORKER & PUSH NOTIFICATIONS
        async function initServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    serviceWorkerRegistration = await navigator.serviceWorker.register('./service-worker.js');
                    console.log('âœ… Service Worker registriert:', serviceWorkerRegistration);
                    
                    // Warte bis Service Worker aktiv ist
                    await navigator.serviceWorker.ready;
                    console.log('âœ… Service Worker bereit');
                    
                    // Push-Benachrichtigungen aktivieren
                    await initPushNotifications();
                } catch (err) {
                    console.error('ğŸ’¾ Service Worker Fehler:', err);
                }
            } else {
                console.warn('âš ï¸ Service Worker nicht unterstÃ¼tzt');
            }
        }

        async function initPushNotifications() {
            if (!('Notification' in window)) {
                console.warn('âš ï¸ Benachrichtigungen nicht unterstÃ¼tzt');
                return;
            }
            
            notificationPermission = Notification.permission;
            console.log('ğŸ”” Notification Permission:', notificationPermission);
            
            if (notificationPermission === 'granted') {
                console.log('âœ… Benachrichtigungen bereits erlaubt');
            }
        }

        function showNotificationPrompt() {
            // Entferne altes Banner falls vorhanden
            const oldBanner = document.getElementById('notification-banner');
            if (oldBanner) oldBanner.remove();
            
            const banner = document.createElement('div');
            banner.id = 'notification-banner';
            banner.style.cssText = 'position:fixed;top:140px;left:10px;right:10px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;border-radius:12px;text-align:center;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.3);animation:slideDown 0.3s ease;';
            banner.innerHTML = `
                <div style="font-size:48px;margin-bottom:10px;">ğŸ””</div>
                <div style="margin-bottom:15px;">
                    <strong style="font-size:18px;">Benachrichtigungen aktivieren?</strong><br>
                    <span style="font-size:14px;opacity:0.9;margin-top:5px;display:block;">Erhalte sofort Push-Benachrichtigungen bei neuen Buchungen - auch wenn die App geschlossen ist!</span>
                </div>
                <button onclick="requestNotificationPermission()" style="background:white;color:#667eea;border:none;padding:14px 24px;border-radius:8px;font-weight:700;cursor:pointer;margin-right:10px;font-size:15px;box-shadow:0 2px 8px rgba(0,0,0,0.2);">âœ“ Jetzt aktivieren</button>
                <button onclick="document.getElementById('notification-banner').remove()" style="background:rgba(255,255,255,0.2);color:white;border:2px solid white;padding:14px 24px;border-radius:8px;font-weight:600;cursor:pointer;font-size:15px;">SpÃ¤ter</button>
            `;
            
            // CSS Animation
            const style = document.createElement('style');
            style.textContent = '@keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }';
            document.head.appendChild(style);
            
            document.body.appendChild(banner);
            
            console.log('ğŸ”” Benachrichtigungs-Banner angezeigt');
        }

        async function requestNotificationPermission() {
            try {
                // Banner entfernen (beide Varianten)
                const staticBanner = document.getElementById('static-notification-banner');
                if (staticBanner) staticBanner.style.display = 'none';
                
                const banner = document.getElementById('notification-banner');
                if (banner) banner.remove();
                
                notificationPermission = await Notification.requestPermission();
                console.log('ğŸ”” Notification Permission:', notificationPermission);
                
                if (notificationPermission === 'granted') {
                    // Zeige BestÃ¤tigung
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = 'position:fixed;top:140px;left:10px;right:10px;background:#10b981;color:white;padding:20px;border-radius:12px;text-align:center;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.3);';
                    successMsg.innerHTML = `
                        <div style="font-size:48px;margin-bottom:10px;">âœ…</div>
                        <div style="font-size:16px;font-weight:600;">Benachrichtigungen aktiviert!</div>
                        <div style="font-size:14px;margin-top:8px;opacity:0.9;">Du erhÃ¤ltst jetzt Push-Benachrichtigungen fÃ¼r neue Fahrten</div>
                    `;
                    document.body.appendChild(successMsg);
                    
                    // Automatisch nach 3 Sekunden ausblenden
                    setTimeout(() => {
                        successMsg.style.transition = 'opacity 0.5s';
                        successMsg.style.opacity = '0';
                        setTimeout(() => successMsg.remove(), 500);
                    }, 3000);
                    
                } else if (notificationPermission === 'denied') {
                    // Zeige Hilfe-Info
                    alert('âš ï¸ Benachrichtigungen wurden blockiert.\n\nSo kannst du sie aktivieren:\n\n1. Tippe auf das ğŸ”’ Schloss in der Adressleiste\n2. Gehe zu "Berechtigungen"\n3. Stelle "Benachrichtigungen" auf "Zulassen"');
                }
            } catch (err) {
                console.error('ğŸ’¾ Notification Permission Fehler:', err);
                alert('ğŸ’¾ Fehler beim Aktivieren der Benachrichtigungen.\n\nBitte versuche es Ã¼ber die Browser-Einstellungen.');
            }
        }

        // Lokale Benachrichtigung anzeigen
        function sendLocalNotification(title, body, data = {}) {
            if (notificationPermission !== 'granted') {
                console.warn('âš ï¸ Keine Berechtigung fÃ¼r Benachrichtigungen');
                // Fallback: Sound abspielen
                playNotificationSound();
                return;
            }
            
            // Wenn Service Worker verfÃ¼gbar, nutze diesen
            if (serviceWorkerRegistration) {
                serviceWorkerRegistration.showNotification(title, {
                    body: body,
                    icon: '/icon-192.png',
                    badge: '/icon-192.png',
                    vibrate: [200, 100, 200, 100, 200],
                    tag: 'taxi-ride-' + (data.rideId || Date.now()),
                    requireInteraction: true,
                    data: data,
                    actions: [
                        { action: 'view', title: 'ğŸ‘€ Anzeigen' },
                        { action: 'close', title: 'ğŸ’¾ SchlieÃŸen' }
                    ]
                });
            } else {
                // Fallback: Browser Notification API
                const notification = new Notification(title, {
                    body: body,
                    icon: '/icon-192.png',
                    vibrate: [200, 100, 200, 100, 200],
                    tag: 'taxi-ride-' + (data.rideId || Date.now()),
                    requireInteraction: true
                });
                
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            }
            
            // Sound abspielen
            playNotificationSound();
        }

        function playNotificationSound() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+');
                audio.volume = 0.5;
                audio.play().catch(e => console.log('ğŸ”‡ Audio blockiert'));
            } catch (e) {
                console.log('ğŸ”‡ Audio nicht verfÃ¼gbar');
            }
        }
        
        // ğŸ§¹ v5.24.8: CLEANUP fÃ¼r hÃ¤ngende 'assigned' Fahrten
        // ğŸ§¹ v5.24.9: ERWEITERT - auch alte 'new' und 'vorbestellt' Fahrten (Ã¤lter als 24h)
        async function cleanupStuckAssignedRides() {
            if (!db) return;
            
            try {
                const now = Date.now();
                const MAX_ASSIGNED_AGE = 2 * 60 * 1000; // 2 Minuten fÃ¼r assigned
                
                // ğŸ†• v5.90.120: AUTO-LÃ–SCHUNGEN DEAKTIVIERT!
                // Patrick will KEINE automatischen LÃ¶schungen mehr
                // NUR noch 2-Min Timeout fÃ¼r 'assigned' Status (gibt Fahrt frei, lÃ¶scht NICHT!)
                // Alle 24h Cleanups sind deaktiviert!
                console.log('ğŸ›¡ï¸ v5.90.120: Auto-Cleanup nur fÃ¼r assigned (Status-Reset, KEINE LÃ¶schung)');
                
                // 1. Cleanup fÃ¼r 'assigned' Fahrten (Ã¤lter als 2 Min) - NUR STATUS ZURÃœCKSETZEN!
                const assignedSnapshot = await db.ref('rides').orderByChild('status').equalTo('assigned').once('value');
                const assignedRides = assignedSnapshot.val() || {};
                
                for (const rideId in assignedRides) {
                    const ride = assignedRides[rideId];
                    const assignedAge = now - (ride.assignedAt || 0);
                    
                    if (assignedAge > MAX_ASSIGNED_AGE) {
                        console.log(`ğŸ§¹ Cleanup: Fahrt ${rideId} hÃ¤ngt seit ${Math.round(assignedAge/1000)}s im assigned Status`);
                        
                        // ğŸ”§ FIX: Blacklist beibehalten UND aktuellen Fahrer hinzufÃ¼gen!
                        const currentBlacklist = ride.assignmentBlacklist || [];
                        if (ride.assignedTo && !currentBlacklist.includes(ride.assignedTo)) {
                            currentBlacklist.push(ride.assignedTo);
                        }
                        
                        await db.ref('rides/' + rideId).update({
                            status: 'new',
                            assignedTo: null,
                            assignedVehicleName: null,
                            assignmentBlacklist: currentBlacklist, // Blacklist behalten!
                            cleanedUp: true,
                            cleanedUpAt: now,
                            lastAssignmentTimeout: now
                        });
                        
                        console.log(`âœ… Fahrt ${rideId} zurÃ¼ckgesetzt auf 'new' - Blacklist: ${currentBlacklist.join(', ')}`);
                    }
                }
                
                // ğŸ†• v5.90.120: ALLE 24h AUTO-CLEANUPS DEAKTIVIERT!
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // Patrick will KEINE automatischen LÃ¶schungen mehr!
                // Grund: Keine Ãœberraschungen, volle Kontrolle
                //
                // DEAKTIVIERT:
                // - ğŸ’¾ 24h Cleanup fÃ¼r 'new' â†’ status: 'cancelled'
                // - ğŸ’¾ 24h Cleanup fÃ¼r 'vorbestellt' â†’ status: 'cancelled'
                // - ğŸ’¾ 24h Cleanup fÃ¼r 'accepted' â†’ status: 'completed'
                // - ğŸ’¾ 24h Cleanup fÃ¼r 'picked_up' â†’ status: 'completed'
                //
                // ERGEBNIS:
                // â†’ KEINE Fahrten werden automatisch gelÃ¶scht
                // â†’ Fahrten bleiben fÃ¼r immer im System
                // â†’ Patrick lÃ¶scht manuell wenn nÃ¶tig
                // â†’ SpÃ¤ter kann man immer noch aufrÃ¤umen
                //
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                
                console.log('âœ… Cleanup abgeschlossen (nur assigned Timeout aktiv)');
                console.log('ğŸ›¡ï¸ 24h Auto-Cleanup ist DEAKTIVIERT - keine automatischen LÃ¶schungen!');
                
            } catch (error) {
                console.error('ğŸ’¾ Cleanup-Fehler:', error);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.86.14: AUTOMATISCHES BACKUP-SYSTEM (alle 4 Stunden)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let backupDB = null;
        let backupTimer = null;
        const BACKUP_INTERVAL = 4 * 60 * 60 * 1000; // 4 Stunden
        const MAX_BACKUPS = 5; // Behalte letzte 5
        
        // IndexedDB fÃ¼r Backups initialisieren
        function initBackupDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('TaxiAppBackups', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    backupDB = request.result;
                    console.log('âœ… Backup-DB initialisiert');
                    resolve(backupDB);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('backups')) {
                        const store = db.createObjectStore('backups', { keyPath: 'id' });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                        console.log('âœ… Backup-Store erstellt');
                    }
                };
            });
        }
        
        // ğŸ†• v5.87.26: IndexedDB fÃ¼r Logs initialisieren
        window.logDB = null;
        function initLogDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('TaxiAppLogs', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    window.logDB = request.result;
                    console.log('âœ… Log-DB initialisiert - INSTANT LOGGING aktiv!');
                    resolve(window.logDB);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('logs')) {
                        const store = db.createObjectStore('logs', { keyPath: 'id', autoIncrement: true });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                        store.createIndex('date', 'date', { unique: false });
                        console.log('âœ… Log-Store erstellt');
                    }
                };
            });
        }
        
        // ğŸ†• v5.87.26: Logs in IndexedDB speichern
        async function saveLogsToIndexedDB() {
            try {
                if (!window.logDB || !window.debugLogs || window.debugLogs.length === 0) {
                    console.log('â¸ï¸ Keine Logs zum Speichern');
                    return;
                }
                
                const transaction = window.logDB.transaction(['logs'], 'readwrite');
                const store = transaction.objectStore('logs');
                
                // Speichere alle Logs
                for (const log of window.debugLogs) {
                    const logEntry = {
                        ...log,
                        date: new Date(log.timestamp).toISOString().split('T')[0] // YYYY-MM-DD
                    };
                    store.put(logEntry);
                }
                
                console.log(`âœ… ${window.debugLogs.length} Logs gespeichert`);
                
            } catch (error) {
                console.error('ğŸ’¾ Log-Speicher-Fehler:', error);
            }
        }
        
        // ğŸ†• v5.87.26: Alte Logs lÃ¶schen (Ã¤lter als 24h)
        async function cleanOldLogs() {
            return new Promise((resolve, reject) => {
                if (!window.logDB) {
                    resolve();
                    return;
                }
                
                const transaction = window.logDB.transaction(['logs'], 'readwrite');
                const store = transaction.objectStore('logs');
                const index = store.index('timestamp');
                
                const oneDayAgo = new Date();
                oneDayAgo.setDate(oneDayAgo.getDate() - 1);
                const cutoff = oneDayAgo.getTime();
                
                const request = index.openCursor();
                let deletedCount = 0;
                
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        const logTime = new Date(cursor.value.timestamp).getTime();
                        if (logTime < cutoff) {
                            store.delete(cursor.primaryKey);
                            deletedCount++;
                        }
                        cursor.continue();
                    } else {
                        if (deletedCount > 0) {
                            console.log(`ğŸ—‘ï¸ ${deletedCount} alte Logs gelÃ¶scht (Ã¤lter als 24h)`);
                        }
                        resolve();
                    }
                };
                request.onerror = () => reject(request.error);
            });
        }
        
        // ğŸ†• v5.87.26: Logs aus IndexedDB exportieren
        async function exportStoredLogs() {
            try {
                console.log('ğŸ“¥ Export Stored Logs gestartet...');
                
                // ğŸ†• v5.87.80: EXPORT AKTUELLER CONSOLE LOGS!
                if (window.debugLogs && window.debugLogs.length > 0) {
                    console.log('âœ… Exportiere Debug Logs:', window.debugLogs.length);
                    
                    // Erstelle Text aus Debug Logs
                    const text = window.debugLogs.map(log => {
                        return `[${log.timestamp}] [${log.type.toUpperCase()}] ${log.message}`;
                    }).join('\n');
                    
                    // Download
                    const now = new Date();
                    const dateStr = getLocalDateString(now);  // ğŸ”§ v5.90.353: LOKAL!
                    const timeStr = now.toTimeString().slice(0,8).replace(/:/g, '-');
                    const filename = `taxi-console-logs-${dateStr}_${timeStr}.txt`;
                    
                    const blob = new Blob([text], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    alert(`âœ… ${window.debugLogs.length} Console Logs exportiert!`);
                    return;
                }
                
                // Fallback: Versuche IndexedDB
                if (!window.logDB) {
                    alert('ğŸ’¾ Keine Logs verfÃ¼gbar! Bitte Debug-View Ã¶ffnen um Logs zu sammeln.');
                    console.warn('âš ï¸ window.debugLogs leer und window.logDB nicht initialisiert');
                    return;
                }
                
                const transaction = window.logDB.transaction(['logs'], 'readonly');
                const store = transaction.objectStore('logs');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const logs = request.result;
                    
                    if (logs.length === 0) {
                        alert('ğŸ’¾ Keine gespeicherten Logs gefunden!');
                        return;
                    }
                    
                    // Sortiere nach Timestamp
                    logs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    // Erstelle Text
                    const text = logs.map(log => {
                        return `[${log.timestamp}] [${log.type.toUpperCase()}] ${log.message}`;
                    }).join('\n');
                    
                    // Download
                    const now = new Date();
                    const dateStr = getLocalDateString(now);  // ğŸ”§ v5.90.353: LOKAL!
                    const timeStr = now.toTimeString().slice(0,8).replace(/:/g, '-');
                    const filename = `taxi-logs-${dateStr}_${timeStr}.txt`;
                    
                    const blob = new Blob([text], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    alert(`âœ… ${logs.length} Logs exportiert!`);
                };
                
                request.onerror = () => {
                    alert('ğŸ’¾ Fehler beim Laden der Logs!');
                };
                
            } catch (error) {
                console.error('ğŸ’¾ Export-Fehler:', error);
                alert('ğŸ’¾ Fehler beim Exportieren: ' + error.message);
            }
        }
        
        // Automatisches Backup erstellen
        async function createAutoBackup() {
            try {
                console.log('ğŸ”½ Erstelle automatisches Backup...');
                
                if (!isFirebaseReady || !db) {
                    console.warn('âš ï¸ Firebase nicht bereit, Backup Ã¼bersprungen');
                    return;
                }
                
                // Lade komplette Datenbank
                const ridesSnap = await db.ref(window.dbPrefix + 'rides').once('value');
                const customersSnap = await db.ref(window.dbPrefix + 'customers').once('value');
                const driversSnap = await db.ref(window.dbPrefix + 'drivers').once('value');
                const vehiclesSnap = await db.ref(window.dbPrefix + 'vehicles').once('value');
                const usersSnap = await db.ref(window.dbPrefix + 'users').once('value');
                const settingsSnap = await db.ref(window.dbPrefix + 'settings').once('value');
                
                const backup = {
                    id: Date.now(),
                    timestamp: Date.now(),
                    date: new Date().toISOString(),
                    data: {
                        rides: ridesSnap.val() || {},
                        customers: customersSnap.val() || {},
                        drivers: driversSnap.val() || {},
                        vehicles: vehiclesSnap.val() || {},
                        users: usersSnap.val() || {},
                        settings: settingsSnap.val() || {}
                    },
                    dbPrefix: window.dbPrefix || '',
                    version: APP_VERSION
                };
                
                // Speichere in IndexedDB
                await saveBackupToIndexedDB(backup);
                
                // Alte Backups lÃ¶schen (behalte nur letzte 5)
                await cleanOldBackups();
                
                const size = (JSON.stringify(backup).length / 1024 / 1024).toFixed(2);
                console.log(`âœ… Backup erstellt: ${size} MB`);
                
                // Browser-Notification
                if (Notification.permission === 'granted') {
                    new Notification('âœ… Backup erstellt', {
                        body: `Automatisches Backup (${size} MB) gespeichert`,
                        icon: '/icon-192.png'
                    });
                }
                
                // Update UI wenn Admin-Tab offen
                if (typeof updateBackupList === 'function') {
                    updateBackupList();
                }
                
            } catch (error) {
                console.error('ğŸ’¾ Backup-Fehler:', error);
                if (Notification.permission === 'granted') {
                    new Notification('ğŸ’¾ Backup fehlgeschlagen', {
                        body: error.message
                    });
                }
            }
        }
        
        // Backup in IndexedDB speichern
        function saveBackupToIndexedDB(backup) {
            return new Promise((resolve, reject) => {
                const transaction = backupDB.transaction(['backups'], 'readwrite');
                const store = transaction.objectStore('backups');
                const request = store.put(backup);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
        
        // Alte Backups lÃ¶schen (behalte nur letzte 5)
        async function cleanOldBackups() {
            return new Promise((resolve, reject) => {
                const transaction = backupDB.transaction(['backups'], 'readwrite');
                const store = transaction.objectStore('backups');
                const index = store.index('timestamp');
                const request = index.openCursor(null, 'prev'); // Neueste zuerst
                
                let count = 0;
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        count++;
                        if (count > MAX_BACKUPS) {
                            // LÃ¶sche alte Backups
                            store.delete(cursor.primaryKey);
                            console.log('ğŸ—‘ï¸ Altes Backup gelÃ¶scht:', new Date(cursor.value.timestamp).toLocaleString());
                        }
                        cursor.continue();
                    } else {
                        resolve();
                    }
                };
                request.onerror = () => reject(request.error);
            });
        }
        
        // Alle Backups laden
        function loadAllBackups() {
            return new Promise((resolve, reject) => {
                const transaction = backupDB.transaction(['backups'], 'readonly');
                const store = transaction.objectStore('backups');
                const index = store.index('timestamp');
                const request = index.openCursor(null, 'prev'); // Neueste zuerst
                
                const backups = [];
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        backups.push(cursor.value);
                        cursor.continue();
                    } else {
                        resolve(backups);
                    }
                };
                request.onerror = () => reject(request.error);
            });
        }
        
        // Backup downloaden
        async function downloadBackup(backupId) {
            try {
                const backups = await loadAllBackups();
                const backup = backups.find(b => b.id === backupId);
                
                if (!backup) {
                    alert('ğŸ’¾ Backup nicht gefunden!');
                    return;
                }
                
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `taxi-backup-${new Date(backup.timestamp).toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                console.log('âœ… Backup heruntergeladen');
            } catch (error) {
                console.error('ğŸ’¾ Download-Fehler:', error);
                alert('ğŸ’¾ Download fehlgeschlagen: ' + error.message);
            }
        }
        
        // Backup wiederherstellen
        async function restoreBackup(backupId) {
            try {
                const backups = await loadAllBackups();
                const backup = backups.find(b => b.id === backupId);
                
                if (!backup) {
                    alert('ğŸ’¾ Backup nicht gefunden!');
                    return;
                }
                
                const confirmed = confirm(
                    'âš ï¸ ACHTUNG!\n\n' +
                    'Dies Ã¼berschreibt ALLE aktuellen Daten!\n\n' +
                    'Backup vom: ' + new Date(backup.timestamp).toLocaleString() + '\n' +
                    'Version: ' + backup.version + '\n\n' +
                    'Fortfahren?'
                );
                
                if (!confirmed) return;
                
                console.log('ğŸ”¼ Stelle Backup wieder her...');
                
                const prefix = window.dbPrefix || '';
                
                // Restore alle Daten
                await db.ref(prefix + 'rides').set(backup.data.rides);
                await db.ref(prefix + 'customers').set(backup.data.customers);
                await db.ref(prefix + 'drivers').set(backup.data.drivers);
                await db.ref(prefix + 'vehicles').set(backup.data.vehicles);
                await db.ref(prefix + 'users').set(backup.data.users);
                await db.ref(prefix + 'settings').set(backup.data.settings);
                
                console.log('âœ… Backup wiederhergestellt!');
                alert('âœ… Backup erfolgreich wiederhergestellt!\n\nSeite wird neu geladen...');
                
                // Reload
                setTimeout(() => location.reload(), 1000);
                
            } catch (error) {
                console.error('ğŸ’¾ Restore-Fehler:', error);
                alert('ğŸ’¾ Wiederherstellung fehlgeschlagen: ' + error.message);
            }
        }
        
        // Backup lÃ¶schen
        async function deleteBackup(backupId) {
            try {
                if (!confirm('Backup wirklich lÃ¶schen?')) return;
                
                return new Promise((resolve, reject) => {
                    const transaction = backupDB.transaction(['backups'], 'readwrite');
                    const store = transaction.objectStore('backups');
                    const request = store.delete(backupId);
                    
                    request.onsuccess = () => {
                        console.log('âœ… Backup gelÃ¶scht');
                        updateBackupList();
                        resolve();
                    };
                    request.onerror = () => reject(request.error);
                });
            } catch (error) {
                console.error('ğŸ’¾ LÃ¶sch-Fehler:', error);
                alert('ğŸ’¾ LÃ¶schen fehlgeschlagen: ' + error.message);
            }
        }
        
        // Backup-Liste im UI aktualisieren
        async function updateBackupList() {
            const container = document.getElementById('backup-list');
            if (!container) return;
            
            try {
                const backups = await loadAllBackups();
                
                if (backups.length === 0) {
                    container.innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Noch keine Backups vorhanden</div>';
                    return;
                }
                
                container.innerHTML = backups.map(backup => {
                    const date = new Date(backup.timestamp);
                    const size = (JSON.stringify(backup).length / 1024 / 1024).toFixed(2);
                    
                    return `
                        <div style="background:white;border-radius:12px;padding:15px;margin-bottom:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <div>
                                    <div style="font-weight:600;font-size:15px;">ğŸ“¦ ${date.toLocaleDateString('de-DE')} ${date.toLocaleTimeString('de-DE')}</div>
                                    <div style="font-size:13px;color:#666;margin-top:4px;">
                                        ${size} MB â€¢ Version ${backup.version}
                                        ${backup.dbPrefix ? ' â€¢ Test-DB' : ' â€¢ Live-DB'}
                                    </div>
                                </div>
                                <div style="display:flex;gap:8px;">
                                    <button onclick="downloadBackup(${backup.id})" style="background:#10b981;color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;">
                                        â¬‡ï¸ Download
                                    </button>
                                    <button onclick="restoreBackup(${backup.id})" style="background:#3b82f6;color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;">
                                        â†» Restore
                                    </button>
                                    <button onclick="deleteBackup(${backup.id})" style="background:#ef4444;color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;">
                                        ğŸ—‘ï¸
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der Backup-Liste:', error);
                container.innerHTML = '<div style="padding:20px;text-align:center;color:#ef4444;">ğŸ’¾ Fehler beim Laden</div>';
            }
        }
        
        // Backup-Upload (aus Datei)
        function uploadBackupFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const backup = JSON.parse(text);
                    
                    // Validiere Backup
                    if (!backup.data || !backup.timestamp) {
                        throw new Error('UngÃ¼ltiges Backup-Format!');
                    }
                    
                    // Restore
                    await restoreBackup(backup.id);
                    
                } catch (error) {
                    console.error('ğŸ’¾ Upload-Fehler:', error);
                    alert('ğŸ’¾ UngÃ¼ltige Backup-Datei: ' + error.message);
                }
            };
            
            input.click();
        }

        // INIT
        // ğŸ†• v5.90.227: ANRUF-FAVORITEN SYSTEM
        let callFavorites = [];
        
        // Lade Favoriten aus localStorage
        async function loadCallFavorites() {
            console.log('ğŸ’¾ loadCallFavorites() aufgerufen!');
            console.log('   currentUser:', currentUser?.uid || 'NICHT EINGELOGGT');
            console.log('   isFirebaseReady:', isFirebaseReady);
            
            try {
                // ğŸ†• v5.90.532: ASYNC - Warte auf Firebase + CRM!
                if (currentUser && currentUser.uid && isFirebaseReady) {
                    console.log('â˜ï¸ Versuche Firebase zu laden...');
                    const snapshot = await db.ref(`users/${currentUser.uid}/callFavorites`).once('value');
                    
                    if (snapshot.exists()) {
                        callFavorites = snapshot.val();
                        console.log('â˜ï¸ Favoriten aus Firebase geladen:', callFavorites.length, 'âœ…');
                        
                        // Speichere auch in localStorage (Backup)
                        localStorage.setItem('call_favorites', JSON.stringify(callFavorites));
                    } else {
                        console.log('ğŸ“‚ Keine Firebase-Favoriten, lade aus localStorage...');
                        loadFromLocalStorage();
                    }
                    
                    // ğŸ†• v5.90.532: WARTE auf CRM-Favoriten!
                    await loadCRMFavoritesIntoCallList();
                    console.log('âœ… Alle Favoriten geladen (Firebase + CRM)!');
                    
                } else {
                    console.log('âš ï¸ Firebase nicht bereit oder User nicht eingeloggt â†’ Fallback localStorage');
                    console.log('   Grund: currentUser =', !!currentUser, ', isFirebaseReady =', isFirebaseReady);
                    // Fallback: localStorage
                    loadFromLocalStorage();
                }
            } catch (e) {
                console.error('ğŸ’¾ Fehler beim Laden der Favoriten:', e);
                loadFromLocalStorage();
            }
        }
        
        // ğŸ†• v5.90.255: Fallback localStorage
        function loadFromLocalStorage() {
            const saved = localStorage.getItem('call_favorites');
            if (saved) {
                callFavorites = JSON.parse(saved);
                console.log('ğŸ’¾ Favoriten aus localStorage geladen:', callFavorites.length);
            } else {
                // Standard-Favoriten wenn noch keine gespeichert
                callFavorites = [
                    { name: 'Taxi-Zentrale', number: '+49170123482', icon: 'ğŸš•' },
                    { name: 'Notruf', number: '112', icon: 'ğŸš‘' },
                    { name: 'Polizei', number: '110', icon: 'ğŸ‘®' }
                ];
                saveCallFavorites();
            }
            
            // Lade CRM-Favoriten
            loadCRMFavoritesIntoCallList();
            renderCallFavorites();
        }
        
        // ğŸ†• v5.90.257: LADE **ALLE** CRM-KUNDEN MIT KATEGORIEN!
        async function loadCRMFavoritesIntoCallList() {
            if (!isFirebaseReady) return;
            
            try {
                const snapshot = await db.ref('customers').once('value');
                const customers = snapshot.val();
                
                if (!customers) return;
                
                // ğŸ†• v5.90.257: Lade ALLE Kunden mit Telefonnummer (alle Kategorien!)
                const categorizedCustomers = Object.entries(customers)
                    .filter(([id, c]) => c.phone && c.category) // Muss Telefon + Kategorie haben
                    .map(([id, c]) => ({
                        name: c.name,
                        number: c.phone,
                        icon: getCategoryIcon(c.category),
                        category: c.category,
                        source: 'crm',
                        customerId: id
                    }));
                
                console.log('â­ CRM-Kunden mit Kategorien geladen:', categorizedCustomers.length);
                console.log('   Kategorien:', [...new Set(categorizedCustomers.map(c => c.category))].join(', '));
                
                // FÃ¼ge zu callFavorites hinzu (aber nicht doppelt!)
                categorizedCustomers.forEach(fav => {
                    const exists = callFavorites.find(f => f.number === fav.number);
                    if (!exists) {
                        callFavorites.push(fav);
                    }
                });
                
            } catch (e) {
                console.error('ğŸ’¾ Fehler beim Laden CRM-Favoriten:', e);
            }
        }
        
        // Hilfsfunktion: Icon fÃ¼r Kategorie
        function getCategoryIcon(category) {
            const icons = {
                'favorite': 'â­',
                'driver': 'ğŸš—',
                'hotel': 'ğŸ¨',
                'vip': 'ğŸ‘‘',
                'business': 'ğŸ’¼',
                'emergency': 'ğŸš¨',
                'hospital': 'ğŸ¥',
                'restaurant': 'ğŸ½ï¸',
                'station': 'ğŸš‰',
                'airport': 'âœˆï¸',
                'company': 'ğŸ¢'
            };
            return icons[category?.toLowerCase()] || 'ğŸ’¾';
        }
        
        // Speichere Favoriten
        function saveCallFavorites() {
            try {
                // ğŸ†• v5.90.255: Speichern in localStorage UND Firebase!
                localStorage.setItem('call_favorites', JSON.stringify(callFavorites));
                console.log('ğŸ’¾ Favoriten in localStorage gespeichert');
                
                // Speichern in Firebase (persistent!)
                if (currentUser && currentUser.uid) {
                    db.ref(`users/${currentUser.uid}/callFavorites`).set(callFavorites)
                        .then(() => {
                            console.log('â˜ï¸ Favoriten in Firebase gespeichert! âœ…');
                        })
                        .catch(err => {
                            console.error('ğŸ’¾ Firebase Fehler:', err);
                        });
                }
            } catch (e) {
                console.error('ğŸ’¾ Fehler beim Speichern:', e);
            }
        }
        
        // Zeige/Verstecke Modal
        // ğŸ†• v5.90.259: TESLA-STYLE DROPDOWN TOGGLE
        function toggleTeslaCallDropdown() {
            const dropdown = document.getElementById('tesla-call-dropdown');
            const arrow = document.getElementById('tesla-dropdown-arrow');
            
            // ğŸ†• v5.90.542: NULL-CHECK!
            if (!dropdown) {
                console.warn('âš ï¸ Tesla dropdown nicht gefunden');
                return;
            }
            
            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                // Ã–ffnen
                console.log('ğŸš— Tesla-Dropdown wird geÃ¶ffnet â†’ Lade Favoriten...');
                loadCallFavorites();
                
                dropdown.style.display = 'block';
                if (arrow) {  // ğŸ†• v5.90.542: NULL-CHECK!
                    arrow.textContent = 'â–²';
                    arrow.style.transform = 'rotate(180deg)';
                }
                
                renderTeslaCallList();
            } else {
                // SchlieÃŸen
                dropdown.style.display = 'none';
                if (arrow) {  // ğŸ†• v5.90.542: NULL-CHECK!
                    arrow.textContent = 'â–¼';
                    arrow.style.transform = 'rotate(0deg)';
                }
            }
        }
        
        // ğŸ†• v5.90.259: TESLA-STYLE RENDER
        function renderTeslaCallList() {
            const list = document.getElementById('tesla-call-list');
            if (!list) return;
            
            if (callFavorites.length === 0) {
                list.innerHTML = `
                    <div style="text-align:center;padding:40px;color:#6b7280;">
                        <div style="font-size:48px;margin-bottom:15px;">ğŸ’¾</div>
                        <div style="font-size:16px;font-weight:600;">Keine Kontakte</div>
                        <div style="font-size:14px;margin-top:8px;">FÃ¼ge Favoriten im CRM hinzu!</div>
                    </div>
                `;
                return;
            }
            
            // ğŸ†• v5.90.260: EXAKT DIE CRM-KATEGORIEN!
            const categories = {
                favorite: { title: 'â­ Favorit', items: [], color: '#f59e0b' },
                driver: { title: 'ğŸš— Fahrer', items: [], color: '#3b82f6' },
                hotel: { title: 'ğŸ¨ Hotel', items: [], color: '#8b5cf6' },
                restaurant: { title: 'ğŸ½ï¸ Restaurant', items: [], color: '#f59e0b' },
                vip: { title: 'ğŸ‘‘ VIP', items: [], color: '#eab308' },
                business: { title: 'ğŸ’¼ GeschÃ¤ftskunde', items: [], color: '#06b6d4' },
                emergency: { title: 'ğŸš¨ Notfall', items: [], color: '#ef4444' },
                other: { title: 'ğŸ’¾ Andere', items: [], color: '#6b7280' }
            };
            
            // Sortiere in Kategorien
            callFavorites.forEach((fav, index) => {
                fav.index = index;
                
                if (fav.category && categories[fav.category]) {
                    categories[fav.category].items.push(fav);
                } else if (fav.number === '112' || fav.number === '110') {
                    categories.emergency.items.push(fav);
                } else {
                    categories.other.items.push(fav);
                }
            });
            
            // Render Tesla-Style
            let html = '';
            
            Object.values(categories).forEach(cat => {
                if (cat.items.length === 0) return;
                
                html += `
                    <div style="margin-bottom:15px;">
                        <!-- Kategorie-Header (Kompakt!) -->
                        <div style="
                            display:flex;
                            align-items:center;
                            gap:6px;
                            margin-bottom:6px;
                            padding:6px 8px;
                            background:${cat.color}15;
                            border-left:3px solid ${cat.color};
                            border-radius:6px;
                        ">
                            <div style="
                                font-weight:700;
                                font-size:11px;
                                color:${cat.color};
                                letter-spacing:0.5px;
                                flex:1;
                            ">
                                ${cat.title}
                            </div>
                            <div style="
                                background:${cat.color};
                                color:white;
                                padding:2px 6px;
                                border-radius:10px;
                                font-size:9px;
                                font-weight:700;
                            ">
                                ${cat.items.length}
                            </div>
                        </div>
                        
                        <!-- Items (Kompakt!) -->
                        ${cat.items.map(fav => `
                            <div onclick="callNumber('${fav.number}', '${fav.name.replace(/'/g, "\\'")}')" style="
                                display:flex;
                                align-items:center;
                                gap:8px;
                                padding:8px;
                                background:white;
                                border-radius:8px;
                                margin-bottom:6px;
                                border:2px solid #e5e7eb;
                                cursor:pointer;
                                transition:all 0.2s;
                                min-height:45px;
                            " onmouseover="
                                this.style.background='${cat.color}10';
                                this.style.borderColor='${cat.color}';
                                this.style.transform='translateX(3px)';
                            " onmouseout="
                                this.style.background='white';
                                this.style.borderColor='#e5e7eb';
                                this.style.transform='translateX(0)';
                            ">
                                <!-- Icon -->
                                <div style="
                                    font-size:20px;
                                    min-width:24px;
                                    text-align:center;
                                ">${fav.icon || 'ğŸ“'}</div>
                                
                                <!-- Info -->
                                <div style="flex:1;min-width:0;">
                                    <div style="
                                        font-weight:600;
                                        color:#111827;
                                        font-size:12px;
                                        margin-bottom:2px;
                                        white-space:nowrap;
                                        overflow:hidden;
                                        text-overflow:ellipsis;
                                    ">${fav.name}</div>
                                    <div style="
                                        color:#6b7280;
                                        font-size:10px;
                                        font-family:monospace;
                                        letter-spacing:0.5px;
                                    ">${fav.number}</div>
                                </div>
                                
                                <!-- Call Button -->
                                <div style="
                                    background:${cat.color};
                                    color:white;
                                    width:32px;
                                    height:32px;
                                    border-radius:50%;
                                    display:flex;
                                    align-items:center;
                                    justify-content:center;
                                    font-size:16px;
                                    box-shadow:0 2px 6px ${cat.color}40;
                                ">
                                    ğŸ“
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }
        
        function toggleCallFavorites() {
            const modal = document.getElementById('call-favorites-modal');
            const backdrop = document.getElementById('call-favorites-backdrop'); // Kann null sein!
            
            if (modal.style.display === 'none' || modal.style.display === '') {
                // ğŸ†• v5.90.532: ASYNC - Warte auf CRM-Favoriten!
                console.log('ğŸ’¾ Anruf-Zentrale wird geÃ¶ffnet â†’ Lade Favoriten...');
                
                modal.style.display = 'block';
                if (backdrop) backdrop.style.display = 'block';
                
                // Zeige Loading
                const list = document.getElementById('call-favorites-list');
                if (list) {
                    list.innerHTML = `
                        <div style="text-align:center;padding:40px;color:#6b7280;">
                            <div style="font-size:48px;margin-bottom:10px;">â³</div>
                            <div style="font-size:14px;">Lade Kategorien...</div>
                        </div>
                    `;
                }
                
                // ASYNC Laden + Rendern!
                loadCallFavorites().then(() => {
                    console.log('âœ… Favoriten geladen, rendere jetzt...');
                    renderCallFavorites();
                }).catch(err => {
                    console.error('ğŸ’¾ Fehler beim Laden:', err);
                    renderCallFavorites(); // Zeige was da ist
                });
                
            } else {
                modal.style.display = 'none';
                if (backdrop) backdrop.style.display = 'none';
            }
        }
        
        // Rendere Favoriten-Liste
        function renderCallFavorites() {
            const list = document.getElementById('call-favorites-list');
            if (!list) return;
            
            if (callFavorites.length === 0) {
                list.innerHTML = `
                    <div style="text-align:center;padding:40px;color:#6b7280;">
                        <div style="font-size:48px;margin-bottom:10px;">ğŸ’¾</div>
                        <div style="font-size:14px;">Noch keine Nummern</div>
                        <div style="font-size:12px;color:#9ca3af;margin-top:8px;">Klicke unten auf "Nummer hinzufÃ¼gen"</div>
                    </div>
                `;
                return;
            }
            
            // ğŸ†• v5.90.260: EXAKT DIE CRM-KATEGORIEN!
            const categories = {
                favorite: { title: 'â­ Favorit', items: [], color: '#f59e0b' },
                driver: { title: 'ğŸš— Fahrer', items: [], color: '#3b82f6' },
                hotel: { title: 'ğŸ¨ Hotel', items: [], color: '#8b5cf6' },
                restaurant: { title: 'ğŸ½ï¸ Restaurant', items: [], color: '#f59e0b' },
                vip: { title: 'ğŸ‘‘ VIP', items: [], color: '#eab308' },
                business: { title: 'ğŸ’¼ GeschÃ¤ftskunde', items: [], color: '#06b6d4' },
                emergency: { title: 'ğŸš¨ Notfall', items: [], color: '#ef4444' },
                other: { title: 'ğŸ’¾ Andere', items: [], color: '#6b7280' }
            };
            
            // Sortiere Favoriten in Kategorien
            callFavorites.forEach((fav, index) => {
                fav.index = index; // Merke Original-Index
                
                // ğŸ†• v5.90.258: Nutze Kategorie aus CRM!
                if (fav.category && categories[fav.category]) {
                    categories[fav.category].items.push(fav);
                } else if (fav.number === '112' || fav.number === '110' || fav.name.toLowerCase().includes('notruf')) {
                    categories.emergency.items.push(fav);
                } else {
                    categories.other.items.push(fav);
                }
            });
            
            // Render Kategorien
            let html = '';
            
            Object.values(categories).forEach(cat => {
                if (cat.items.length === 0) return; // Skip leere Kategorien
                
                html += `
                    <div style="margin-bottom:20px;">
                        <!-- Kategorie-Header -->
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;padding:8px 12px;background:${cat.color}15;border-left:4px solid ${cat.color};border-radius:6px;">
                            <div style="font-weight:700;font-size:13px;color:${cat.color};letter-spacing:0.5px;">
                                ${cat.title}
                            </div>
                            <div style="background:${cat.color};color:white;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:700;">
                                ${cat.items.length}
                            </div>
                        </div>
                        
                        <!-- Items -->
                        ${cat.items.map(fav => `
                            <div style="display:flex;align-items:center;gap:10px;padding:12px;background:white;border-radius:10px;margin-bottom:8px;border:2px solid #e5e7eb;transition:all 0.2s;" onmouseover="this.style.background='#f9fafb';this.style.borderColor='${cat.color}'" onmouseout="this.style.background='white';this.style.borderColor='#e5e7eb'">
                                <!-- Icon -->
                                <div style="font-size:28px;min-width:36px;text-align:center;">${fav.icon || 'ğŸ’¾'}</div>
                                
                                <!-- Info -->
                                <div style="flex:1;min-width:0;">
                                    <div style="font-weight:600;color:#111827;font-size:14px;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${fav.name}</div>
                                    <div style="color:#6b7280;font-size:12px;font-family:monospace;">${fav.number}</div>
                                </div>
                                
                                <!-- Buttons -->
                                <div style="display:flex;gap:6px;">
                                    <button onclick="callNumber('${fav.number}', '${fav.name.replace(/'/g, "\\'")}')" title="Anrufen" style="padding:10px 14px;background:${cat.color};color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;transition:all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                                        ğŸ’¾
                                    </button>
                                    <button onclick="editCallFavorite(${fav.index})" title="Bearbeiten" style="padding:8px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;transition:all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                                        âœï¸
                                    </button>
                                    <button onclick="deleteCallFavorite(${fav.index})" title="LÃ¶schen" style="padding:8px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;transition:all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                                        ğŸ—‘ï¸
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }
        
        // Rufe Nummer an
        function callNumber(number, name) {
            console.log('ğŸ’¾ Anrufen:', name, number);
            
            // Ã–ffne Tel-Link
            window.location.href = `tel:${number}`;
            
            // Optional: Speichere in Call-History
            if (typeof saveToCallHistory === 'function') {
                saveToCallHistory(number, name);
            }
            
            // SchlieÃŸe Modal
            toggleCallFavorites();
        }
        
        // ğŸ†• v5.90.244: AUS CRM ÃœBERNEHMEN!
        async function addCallFavoriteFromCRM() {
            if (!isFirebaseReady) {
                alert('ğŸ’¾ Firebase nicht bereit!');
                return;
            }
            
            console.log('ğŸ‘¥ Lade CRM-Kunden...');
            
            try {
                // Lade alle Kunden
                const snapshot = await db.ref('customers').once('value');
                const customers = snapshot.val();
                
                if (!customers) {
                    alert('Keine Kunden gefunden!');
                    return;
                }
                
                // Filtere Kunden mit Telefonnummer
                const customersWithPhone = Object.entries(customers)
                    .filter(([id, c]) => c.phone)
                    .map(([id, c]) => ({ id, ...c }))
                    .sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                
                if (customersWithPhone.length === 0) {
                    alert('Keine Kunden mit Telefonnummer gefunden!');
                    return;
                }
                
                console.log('âœ… Gefunden:', customersWithPhone.length, 'Kunden');
                
                // Erstelle Auswahl-Modal
                const modal = document.createElement('div');
                modal.id = 'crm-select-modal';
                modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;padding:20px;';
                
                modal.innerHTML = `
                    <div style="background:white;border-radius:16px;width:100%;max-width:500px;max-height:80vh;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.4);">
                        <!-- Header -->
                        <div style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white;padding:20px;display:flex;justify-content:space-between;align-items:center;">
                            <h3 style="margin:0;font-size:18px;font-weight:700;">ğŸ‘¥ Kunde auswÃ¤hlen</h3>
                            <button onclick="document.getElementById('crm-select-modal').remove()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:20px;font-weight:bold;">Ã—</button>
                        </div>
                        
                        <!-- Suche -->
                        <div style="padding:15px;border-bottom:2px solid #e5e7eb;">
                            <input type="text" id="crm-search-input" placeholder="ğŸ” Suchen..." style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;">
                        </div>
                        
                        <!-- Liste -->
                        <div id="crm-customer-list" style="flex:1;overflow-y:auto;padding:15px;">
                            ${customersWithPhone.map(c => `
                                <div class="crm-customer-item" data-name="${(c.name || '').toLowerCase()}" data-phone="${(c.phone || '').replace(/\s/g, '')}" onclick="selectCustomerForCall('${c.id}', '${(c.name || '').replace(/'/g, "\\'")}', '${c.phone}')" style="padding:15px;background:#f9fafb;border-radius:10px;margin-bottom:10px;cursor:pointer;border:2px solid #e5e7eb;transition:all 0.2s;" onmouseover="this.style.background='#eff6ff';this.style.borderColor='#3b82f6'" onmouseout="this.style.background='#f9fafb';this.style.borderColor='#e5e7eb'">
                                    <div style="font-weight:600;color:#111827;font-size:15px;margin-bottom:4px;">
                                        ${c.name || 'Unbekannt'}
                                        ${c.category === 'favorite' ? ' â­' : ''}
                                        ${c.category === 'driver' ? ' ğŸš—' : ''}
                                    </div>
                                    <div style="color:#6b7280;font-size:13px;font-family:monospace;">
                                        ğŸ’¾ ${c.phone}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- Footer -->
                        <div style="padding:15px;border-top:2px solid #e5e7eb;background:#f9fafb;text-align:center;color:#6b7280;font-size:12px;">
                            ${customersWithPhone.length} Kunden mit Telefonnummer
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Suche
                const searchInput = document.getElementById('crm-search-input');
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase().replace(/\s/g, ''); // Entferne Leerzeichen
                    const items = document.querySelectorAll('.crm-customer-item');
                    
                    console.log('ğŸ” Anruf-Modal Suche:', query);
                    let foundCount = 0;
                    
                    items.forEach(item => {
                        const name = item.dataset.name || '';
                        const phone = item.dataset.phone || '';
                        
                        // Suche in Name ODER Telefonnummer
                        if (name.includes(query) || phone.includes(query)) {
                            item.style.display = 'block';
                            foundCount++;
                        } else {
                            item.style.display = 'none';
                        }
                    });
                    
                    console.log(`âœ… ${foundCount} Kunden gefunden`);
                });
                
                // Focus auf Suche
                setTimeout(() => searchInput.focus(), 100);
                
            } catch (e) {
                console.error('ğŸ’¾ Fehler:', e);
                alert('Fehler beim Laden: ' + e.message);
            }
        }
        
        // Kunde fÃ¼r Anruf auswÃ¤hlen
        function selectCustomerForCall(customerId, name, phone) {
            console.log('âœ… Kunde ausgewÃ¤hlt:', name, phone);
            
            // SchlieÃŸe Modal
            const modal = document.getElementById('crm-select-modal');
            if (modal) modal.remove();
            
            // Frage Kategorie
            const categoryPrompt = `"${name}" hinzufÃ¼gen als:

1 = ğŸš— Fahrer
2 = â­ Wichtig
3 = ğŸš¨ Notfall
4 = ğŸ’¾ Andere

Nummer eingeben (1-4):`;
            
            const categoryInput = prompt(categoryPrompt, '2');
            if (!categoryInput) return;
            
            let category = 'other';
            let icon = 'ğŸ’¾';
            
            switch(categoryInput) {
                case '1':
                    category = 'driver';
                    icon = 'ğŸš—';
                    break;
                case '2':
                    category = 'important';
                    icon = 'â­';
                    break;
                case '3':
                    category = 'emergency';
                    icon = 'ğŸš¨';
                    break;
                default:
                    category = 'other';
                    icon = 'ğŸ’¾';
            }
            
            // PrÃ¼fe ob schon vorhanden
            const exists = callFavorites.find(f => f.number === phone);
            if (exists) {
                alert(`"${name}" ist bereits in der Anruf-Zentrale!`);
                return;
            }
            
            // HinzufÃ¼gen
            callFavorites.push({
                name: name,
                number: phone,
                icon: icon,
                category: category,
                customerId: customerId
            });
            
            saveCallFavorites();
            renderCallFavorites();
            
            console.log('âœ… Zur Anruf-Zentrale hinzugefÃ¼gt:', name);
            alert(`âœ… "${name}" wurde hinzugefÃ¼gt!`);
        }
        
        // Favorit hinzufÃ¼gen
        function addCallFavorite() {
            const name = prompt('Name (z.B. "Fahrer 1"):', '');
            if (!name) return;
            
            const number = prompt('Telefonnummer:', '+49');
            if (!number) return;
            
            // ğŸ†• v5.90.243: KATEGORIE AUSWÃ„HLEN!
            const categoryPrompt = `Kategorie wÃ¤hlen:
1 = ğŸš— Fahrer
2 = â­ Wichtig
3 = ğŸš¨ Notfall
4 = ğŸ’¾ Andere

Nummer eingeben (1-4):`;
            
            const categoryInput = prompt(categoryPrompt, '2');
            
            let category = 'other';
            let icon = 'ğŸ’¾';
            
            switch(categoryInput) {
                case '1':
                    category = 'driver';
                    icon = 'ğŸš—';
                    break;
                case '2':
                    category = 'important';
                    icon = 'â­';
                    break;
                case '3':
                    category = 'emergency';
                    icon = 'ğŸš¨';
                    break;
                default:
                    category = 'other';
                    icon = 'ğŸ’¾';
            }
            
            // Optional: Eigenes Icon
            const customIcon = prompt('Emoji Ã¤ndern? (leer = Standard)', icon);
            if (customIcon && customIcon.trim()) {
                icon = customIcon.trim();
            }
            
            callFavorites.push({
                name: name.trim(),
                number: number.trim(),
                icon: icon,
                category: category
            });
            
            saveCallFavorites();
            renderCallFavorites();
            
            console.log('âœ… Favorit hinzugefÃ¼gt:', name, category);
        }
        
        // Favorit bearbeiten
        function editCallFavorite(index) {
            const fav = callFavorites[index];
            
            const name = prompt('Name:', fav.name);
            if (name === null) return;
            
            const number = prompt('Telefonnummer:', fav.number);
            if (number === null) return;
            
            // ğŸ†• v5.90.243: KATEGORIE Ã„NDERN!
            const currentCat = fav.category || 'other';
            const catMap = { driver: '1', important: '2', emergency: '3', other: '4' };
            const currentNum = catMap[currentCat] || '4';
            
            const categoryPrompt = `Kategorie wÃ¤hlen:
1 = ğŸš— Fahrer
2 = â­ Wichtig
3 = ğŸš¨ Notfall
4 = ğŸ’¾ Andere

Aktuell: ${currentNum}`;
            
            const categoryInput = prompt(categoryPrompt, currentNum);
            
            let category = currentCat;
            let defaultIcon = fav.icon;
            
            if (categoryInput) {
                switch(categoryInput) {
                    case '1':
                        category = 'driver';
                        defaultIcon = 'ğŸš—';
                        break;
                    case '2':
                        category = 'important';
                        defaultIcon = 'â­';
                        break;
                    case '3':
                        category = 'emergency';
                        defaultIcon = 'ğŸš¨';
                        break;
                    default:
                        category = 'other';
                        defaultIcon = 'ğŸ’¾';
                }
            }
            
            const icon = prompt('Emoji:', fav.icon || defaultIcon);
            if (icon === null) return;
            
            callFavorites[index] = {
                name: name.trim() || fav.name,
                number: number.trim() || fav.number,
                icon: icon.trim() || defaultIcon,
                category: category
            };
            
            saveCallFavorites();
            renderCallFavorites();
            
            console.log('âœ… Favorit bearbeitet:', name);
        }
        
        // Favorit lÃ¶schen
        function deleteCallFavorite(index) {
            const fav = callFavorites[index];
            if (!confirm(`"${fav.name}" wirklich lÃ¶schen?`)) return;
            
            callFavorites.splice(index, 1);
            saveCallFavorites();
            renderCallFavorites();
            
            console.log('ğŸ—‘ï¸ Favorit gelÃ¶scht:', fav.name);
        }
        
        // ğŸ†• v5.90.230: TEST - IMMER ANZEIGEN!
        function updateCallFavoritesFAB() {
            const fab = document.getElementById('call-favorites-fab');
            if (!fab) return;
            
            // ğŸ§ª TEST: IMMER ANZEIGEN (auch fÃ¼r nicht-admin)
            if (currentUser) {
                fab.style.display = 'block';
                console.log('ğŸ’¾ Anruf-Favoriten aktiviert (TEST-MODUS: fÃ¼r ALLE!)');
            } else {
                fab.style.display = 'none';
            }
        }
        
        function initApp(hasFirebase) {
            clearTimeout(firebaseLoadTimeout);
            console.log('ğŸ“± App initialisiert');
            
            if (hasFirebase && typeof firebase !== 'undefined') {
                try {
                    // ğŸ†• v5.86.13: TEST MODE - Separate Test-Datenbank!
                    const isTestMode = window.isTestMode || false;
                    
                    let firebaseConfig;
                    
                    if (isTestMode) {
                        // ğŸ§ª TEST-DATENBANK (wenn vorhanden, sonst Live mit Prefix)
                        console.log('ğŸ§ª TEST MODE: Verwende Test-Datenbank');
                        firebaseConfig = {
                            apiKey: "AIzaSyD2eHFuplImxBCijd3MWlKyCwXUZHLmhhE",
                            authDomain: "taxi-heringsdorf.firebaseapp.com",
                            // ğŸ§ª Option 1: Separate Test-DB (wenn eingerichtet)
                            // databaseURL: "https://taxi-heringsdorf-test.europe-west1.firebasedatabase.app",
                            // ğŸ§ª Option 2: Gleiche DB, aber mit Prefix "test_" 
                            databaseURL: "https://taxi-heringsdorf-default-rtdb.europe-west1.firebasedatabase.app",
                            projectId: "taxi-heringsdorf",
                            storageBucket: "taxi-heringsdorf.firebasestorage.app",
                            messagingSenderId: "886448281276",
                            appId: "1:886448281276:web:1b54875801c5d89f8efcf9"
                        };
                        window.dbPrefix = 'test_'; // Prefix fÃ¼r Tabellen: test_rides, test_customers, etc.
                    } else {
                        // ğŸŸ¢ LIVE-DATENBANK
                        firebaseConfig = {
                            apiKey: "AIzaSyD2eHFuplImxBCijd3MWlKyCwXUZHLmhhE",
                            authDomain: "taxi-heringsdorf.firebaseapp.com",
                            databaseURL: "https://taxi-heringsdorf-default-rtdb.europe-west1.firebasedatabase.app",
                            projectId: "taxi-heringsdorf",
                            storageBucket: "taxi-heringsdorf.firebasestorage.app",
                            messagingSenderId: "886448281276",
                            appId: "1:886448281276:web:1b54875801c5d89f8efcf9"
                        };
                        window.dbPrefix = ''; // Kein Prefix
                    }
                    
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.database();
                    const storage = firebase.storage(); // ğŸ†• v5.90.316: Firebase Storage initialisieren!
                    window.firebaseStorage = storage; // FÃ¼r globalen Zugriff
                    isFirebaseReady = true;
                    
                    // ğŸ†• v5.90.525: LADE TELEGRAM TOKEN PARALLEL (nicht warten!)
                    loadTelegramToken().catch(err => console.error('ğŸ’¾ Token-Load-Fehler:', err));
                    
                    if (isTestMode) {
                        console.log('âœ… Firebase TEST-DB verbunden (Prefix: test_)');
                    } else {
                        console.log('âœ… Firebase LIVE-DB verbunden');
                    }
                    
                    // ğŸ†• v5.90.362: AUTO-MIGRATION Vehicle IDs (nur einmal!)
                    const migrationDone = localStorage.getItem('vehicleIdMigration_v361');
                    if (!migrationDone) {
                        console.log('ğŸ”„ PrÃ¼fe ob Vehicle-ID Migration nÃ¶tig ist...');
                        setTimeout(async () => {
                            try {
                                const vehiclesSnap = await db.ref('vehicles').once('value');
                                const vehicles = vehiclesSnap.val() || {};
                                
                                // PrÃ¼fe ob alte IDs existieren
                                const hasOldIds = Object.keys(vehicles).some(id => 
                                    id.startsWith('tesla_model') || id.startsWith('tesla_modely')
                                );
                                
                                if (hasOldIds) {
                                    console.log('âš ï¸ Alte Vehicle-IDs gefunden! Zeige Admin-Banner...');
                                    // Zeige Banner im Admin statt Auto-Migration
                                    const banner = document.getElementById('migration-banner');
                                    if (banner && currentUser && currentUser.role === 'admin') {
                                        banner.style.display = 'flex';
                                    }
                                } else {
                                    console.log('âœ… Alle Vehicle-IDs bereits korrekt (Kennzeichen-basiert)');
                                    localStorage.setItem('vehicleIdMigration_v361', 'done');
                                }
                            } catch (error) {
                                console.error('ğŸ’¾ Auto-Migration Check Fehler:', error);
                            }
                        }, 3000); // Nach 3 Sekunden, damit Firebase stabil ist
                    } else {
                        console.log('âœ… Vehicle-ID Migration bereits durchgefÃ¼hrt (v361)');
                    }
                    
                    // ğŸ“œ PROTOKOLL: App gestartet & Firebase verbunden
                    setTimeout(() => {
                        logActivity('system', 'app_start', 'App gestartet - Firebase verbunden', {});
                    }, 1000);
                    
                    // ğŸ§¹ CLEANUP: HÃ¤ngende 'assigned' Fahrten zurÃ¼cksetzen (Ã¤lter als 2 Minuten)
                    // ğŸ†• v5.87.59: AUTO-CLEANUP DEAKTIVIERT!
                    // âš ï¸ WICHTIG: Fahrten werden NICHT mehr automatisch storniert!
                    // âœ… Admin-Fahrten sind geschÃ¼tzt
                    // âœ… Vorbestellungen sind geschÃ¼tzt
                    // âœ… NUR manuelle Stornierung erlaubt
                    // setTimeout(() => cleanupStuckAssignedRides(), 2000); // ğŸ’¾ DEAKTIVIERT!
                    console.log('ğŸ›¡ï¸ v5.87.59: Auto-Cleanup DEAKTIVIERT - Keine automatischen Stornierungen!');
                    
                    // ğŸ’° Preis-Einstellungen aus Firebase laden
                    setTimeout(() => loadPricingSettings(), 0);
                    
                    // ğŸ†• v5.90.304: SCHEDULER FÃœR VORBESTELLUNGEN!
                    console.log('â° Starte Vorbestell-Scheduler...');
                    startPreorderScheduler();
                    
                    // ğŸ”´ Buchungssystem-Status aus Firebase laden
                    setTimeout(() => loadBookingSystemStatus(), 0);
                    
                    // ğŸ’¾ v5.65.3: FRITZBOX CALL POPUP LISTENER
                    initCallPopupListener();
                    
                    // ğŸ’¾ v5.87.64: ANRUFHISTORIE LISTENER (separat!)
                    initCallHistory();
                    
                    // ğŸš— Fahrzeuge aus Firebase laden
                    setTimeout(() => loadVehiclesFromFirebase(), 0);
                    
                    // â­ v5.87.82: POIs laden (ZURÃœCK zu v5.87.72 Methode!)
                    setTimeout(() => loadPOIs(), 0);
                    
                    // ğŸ†• v5.87.86: EINSTELLUNGEN LADEN
                    setTimeout(() => loadVatRates(), 0);
                    setTimeout(() => loadPaymentMethods(), 0);
                    
                    // ğŸ¨ v5.87.82: Hotel-Kalender laden (ZURÃœCK zu v5.87.72 Methode!)
                    setTimeout(() => initHotelCalendars(), 0);
                    
                    // ğŸ“± v5.78.0: Hotel-Rechnungen laden
                    setTimeout(() => initHotelInvoices(), 0);
                    
                    // ğŸ”„ LADE GESPEICHERTE FAHRT (falls vorhanden)
                    const savedRideId = localStorage.getItem('myCurrentRideId');
                    if (savedRideId) {
                        console.log('ğŸ”„ Lade gespeicherte Fahrt:', savedRideId);
                        listenToMyRide(savedRideId);
                    }
                    
                    // ğŸ” Firebase Auth initialisieren mit LOCAL Persistence
                    auth = firebase.auth();
                    
                    // ğŸ†• v5.21.0: ERST Persistence setzen, DANN Observer!
                    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(() => {
                        console.log('âœ… Auth Persistence: LOCAL');
                        
                        // Jetzt erst den Observer starten!
                        auth.onAuthStateChanged((user) => {
                            console.log('ğŸ” Auth State Changed:', user ? user.email : 'KEIN USER');
                            
                            // ğŸ“œ PROTOKOLL im Live-Log
                            if (user) {
                                logActivity('system', 'auth', `ğŸ” User eingeloggt: ${user.email || user.phoneNumber}`, {
                                    email: user.email,
                                    phone: user.phoneNumber,
                                    uid: user.uid
                                });
                                onUserLoggedIn(user);
                            } else {
                                logActivity('system', 'auth', `ğŸ” User ausgeloggt`, {});
                                onUserLoggedOut();
                            }
                        });
                        
                    }).catch((error) => {
                        console.error('ğŸ’¾ Persistence Fehler:', error);
                        
                        // Fallback: Observer trotzdem starten
                        auth.onAuthStateChanged((user) => {
                            if (user) {
                                onUserLoggedIn(user);
                            } else {
                                onUserLoggedOut();
                            }
                        });
                    });
                    
                    db.ref('.info/connected').on('value', (s) => { 
                        const wasConnected = isConnected;
                        isConnected = s.val(); 
                        updateStatus();
                        
                        // ğŸ“œ PROTOKOLL: Verbindungsstatus geÃ¤ndert
                        if (wasConnected === true && isConnected === false) {
                            logActivity('system', 'connection_lost', 'âš ï¸ Firebase-Verbindung verloren', {});
                        } else if (wasConnected === false && isConnected === true) {
                            logActivity('system', 'connection_restored', 'âœ… Firebase-Verbindung wiederhergestellt', {});
                        }
                    });
                    db.ref('rides').on('value', (s) => {
                        console.log('ğŸ”„ Firebase: rides value event triggered');
                        const previousCount = rides.filter(r => r.status === 'new' || r.status === 'vorbestellt').length;
                        rides = [];
                        let loadedCount = 0;
                        s.forEach(c => {
                            const r = c.val();
                            r.firebaseId = c.key;
                            rides.push(r);
                            loadedCount++;
                            
                            // ğŸ†• v5.20.7: Ignoriere kÃ¼rzlich stornierte Fahrten KOMPLETT!
                            if (recentlyCancelledRideIds && recentlyCancelledRideIds.has(r.firebaseId)) {
                                console.log('ğŸ›¡ï¸ Ignoriere stornierte Fahrt:', r.firebaseId);
                                return; // Ãœberspringen!
                            }
                            
                            // ğŸ†• v5.20.8: PrÃ¼fe ob mir ZUGEWIESENE Fahrt storniert wurde
                            if (currentVehicle && r.assignedTo === currentVehicle && currentView === 'driver') {
                                const cancelledStatuses = ['storniert', 'cancelled', 'cancelled_pending_driver'];
                                if (cancelledStatuses.includes(r.status)) {
                                    // PrÃ¼fe ob wir das schon gemeldet haben (PERSISTENT!)
                                    if (!hasShownCancelAlarm(r.firebaseId)) {
                                        saveShownCancelAlarm(r.firebaseId);
                                        console.log('ğŸš¨ Mir zugewiesene Fahrt wurde storniert:', r.firebaseId);
                                        showCancellationAlarm(r);
                                    } else {
                                        console.log('ğŸ›¡ï¸ Stornierung bereits gezeigt (Skip):', r.firebaseId);
                                    }
                                }
                            }
                            
                            if (myCurrentRide && r.id === myCurrentRide.id) {
                                // ğŸ†• v5.20.4: PrÃ¼fe ALLE Stornierung-Status!
                                const cancelledStatuses = ['storniert', 'cancelled', 'cancelled_pending_driver'];
                                const wasNotCancelled = !cancelledStatuses.includes(myCurrentRide.status);
                                const isNowCancelled = cancelledStatuses.includes(r.status);
                                
                                if (isNowCancelled && wasNotCancelled) {
                                    // Fahrt wurde gerade storniert!
                                    console.log('ğŸš« Fahrt wurde storniert:', r.id, r.status);
                                    
                                    // Stoppe Navigations-Updates
                                    if (window.driverMapUpdateInterval) {
                                        clearInterval(window.driverMapUpdateInterval);
                                        window.driverMapUpdateInterval = null;
                                        console.log('ğŸ›‘ Navigations-Updates gestoppt');
                                    }
                                    
                                    // LÃ¶sche Karte
                                    if (map) {
                                        map.remove();
                                        map = null;
                                        taxiMarker = null;
                                        pickupMarker = null;
                                        console.log('ğŸ—ºï¸ Karte entfernt');
                                    }
                                    
                                    // LÃ¶sche Fahrer-Karte
                                    if (driverMap) {
                                        driverMap.remove();
                                        driverMap = null;
                                        driverMarker = null;
                                        pickupMarker = null;
                                        routeLine = null;
                                        console.log('ğŸ—ºï¸ Fahrer-Karte entfernt');
                                    }
                                    
                                    // LÃ¶sche aus myCurrentRide
                                    localStorage.removeItem('myCurrentRideId');
                                    myCurrentRide = null;
                                    document.getElementById('ride-status-container').innerHTML = '';
                                    document.getElementById('booking-form').style.display = 'block';
                                    
                                    // ğŸ†• v5.20.4: Stoppe auch den einzelnen Listener
                                    db.ref('rides/' + r.firebaseId).off();
                                    
                                    // ğŸ†• v5.20.4: Formular zurÃ¼cksetzen
                                    resetBookingForm();
                                    
                                    // ğŸ†• v5.20.8: Zeige VISUELLEN Stornierung-Alarm fÃ¼r Fahrer!
                                    // âš ï¸ v5.24.7: DEAKTIVIERT - lÃ¶st Spam aus bei App-Start
                                    /*
                                    if (currentView === 'driver') {
                                        // PrÃ¼fe ob wir diesen Alarm schon gezeigt haben
                                        if (!hasShownCancelAlarm(r.firebaseId)) {
                                            saveShownCancelAlarm(r.firebaseId);
                                            showCancellationAlarm(r);
                                        } else {
                                            console.log('ğŸ›¡ï¸ Stornierung bereits gezeigt (Skip):', r.firebaseId);
                                        }
                                        updateDriverView();
                                    }
                                    */
                                    if (currentView === 'driver') {
                                        updateDriverView();
                                    }
                                    
                                    // WICHTIG: Nicht weitermachen!
                                    return;
                                }
                                
                                // ğŸ†• v5.20.4: Wenn Fahrt storniert ist, NICHT anzeigen!
                                if (isNowCancelled) {
                                    return;
                                }
                                
                                myCurrentRide = r;
                                if (r.status === 'accepted' && r.driverLocation) showRideStatus(r);
                                if (r.status === 'picked_up') showRideStatus(r);
                                if (r.status === 'completed') showRideStatus(r);
                            }
                        });
                        
                        const currentCount = rides.filter(r => 
                            (r.status === 'new' || r.status === 'vorbestellt') &&
                            !r.vehicleId && // Ignoriere zurÃ¼ckgesetzte
                            !r.driverAssignedAt // Ignoriere schon mal zugewiesene
                        ).length;
                        console.log(`ğŸ“± Fahrten geladen: ${loadedCount} total, ${currentCount} neue (nicht zurÃ¼ckgesetzte)`);
                        
                        // ğŸš¨ ALARM fÃ¼r Admin bei neuen Fahrten!
                        if (currentCount > previousCount) {
                            if (userRole === 'admin') {
                                triggerAdminAlarm(currentCount);
                            }
                            
                            // FÃ¼r Fahrer: alter Alarm
                            if (currentView === 'driver') {
                                playDriverNotificationSound();
                                showNewRideFullscreen();
                            }
                        }
                        
                        // Badge am Admin-Tab aktualisieren
                        updateAdminBadge(currentCount);
                        
                        updateViewsDebounced(); // ğŸ†• v5.21.7: Debounced um Flackern zu vermeiden
                    });
                    // ğŸ†• v5.90.356: Lade von /vehicles statt /drivers!
                    db.ref('vehicles').on('value', (s) => { 
                        drivers = {}; 
                        s.forEach(c => { drivers[c.key] = c.val(); }); 
                        console.log('ğŸ“± Fahrzeuge geladen:', Object.keys(drivers).length);
                        showAvailableTaxis();
                        checkDriverAvailability(); // ğŸ†• v5.32.5g: SOFORT-Button nur wenn Fahrer verfÃ¼gbar
                        if (currentView === 'admin') updateAdminView(); // â† Update Admin fÃ¼r Online-Fahrer
                    });
                    db.ref('cancellations').on('value', (s) => {
                        cancellations = [];
                        s.forEach(c => {
                            const cancel = c.val();
                            cancel.firebaseId = c.key;
                            cancellations.push(cancel);
                        });
                        if (currentView === 'admin') updateAdminView();
                    });
                    
                    // ğŸ†• v5.31.0: child_changed ENTFERNT - verursachte Race Conditions!
                    // Der 'value' Listener oben updated schon alles automatisch!
                    
                } catch (e) { 
                    console.error('ğŸ’¾ Firebase Fehler:', e); 
                }
            } else {
                console.log('âš ï¸ Firebase nicht verfÃ¼gbar - Lokaler Modus');
            }
            
            updateStatus();
            updateViews(); // WICHTIG: Views auch ohne Firebase laden!
            
            // ğŸ†• v5.42.2: Quick-Login Daten beim Start laden + Avatar zeigen!
            loadQuickLoginData();
            
            // ğŸ”” SERVICE WORKER DEAKTIVIERT - Telegram Ã¼bernimmt Benachrichtigungen!
            // initServiceWorker();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸšŒğŸš‚ FAHRPLAN-FUNKTIONEN (v5.32.6)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let scheduleLoaded = false;
        
        // LÃ¤dt Fahrplan beim ersten Ã–ffnen
        async function loadSchedule() {
            if (scheduleLoaded) return;
            
            console.log('ğŸšŒ Lade Fahrplan-Daten...');
            
            // GPS-Check
            if (!navigator.geolocation) {
                showScheduleError('GPS nicht verfÃ¼gbar in deinem Browser.');
                return;
            }
            
            try {
                // 1. GPS-Standort holen
                console.log('ğŸ“ Hole GPS-Standort...');
                
                const location = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            console.log('âœ… GPS-Standort erhalten:', pos.coords.latitude, pos.coords.longitude);
                            resolve({
                                latitude: pos.coords.latitude,
                                longitude: pos.coords.longitude
                            });
                        },
                        (err) => {
                            console.error('ğŸ’¾ GPS-Fehler:', err);
                            reject(err);
                        },
                        {
                            enableHighAccuracy: true,  // ğŸ”§ v5.32.11: Bessere Genauigkeit
                            timeout: 30000,            // ğŸ”§ v5.32.11: 30 Sekunden statt 10
                            maximumAge: 300000
                        }
                    );
                });
                
                const { latitude, longitude } = location;
                // ğŸ†• v5.49.5: schedule-location Element existiert nicht mehr (mit Dropdown entfernt)
                
                // 2. NÃ¤chste Haltestellen finden (mehrere zur Auswahl!)
                console.log('ğŸ” Suche Haltestellen in der NÃ¤he...');
                const nearbyStops = await fetchNearbyStops(latitude, longitude);
                
                if (!nearbyStops || nearbyStops.length === 0) {
                    showScheduleError('Keine Haltestelle in der NÃ¤he gefunden.');
                    return;
                }
                
                console.log('âœ… Haltestellen gefunden:', nearbyStops.length);
                
                // Zeige alle Haltestellen zur Auswahl
                displayStopSelection(nearbyStops, latitude, longitude);
                
                scheduleLoaded = true;
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden des Fahrplans:', error);
                
                if (error.code === 1) {
                    showScheduleError('GPS-Berechtigung verweigert. Bitte erlaube den Standort-Zugriff in den Browser-Einstellungen.');
                } else if (error.code === 2) {
                    showScheduleError('Standort nicht verfÃ¼gbar. Bitte aktiviere GPS.');
                } else if (error.code === 3) {
                    showScheduleError('GPS-Timeout (30 Sek Ã¼berschritten). Bitte gehe nach drauÃŸen oder ans Fenster und versuche es erneut. Bei schlechtem GPS-Empfang kann es bis zu 30 Sekunden dauern.');
                } else if (error.message && error.message.includes('Deutsche Bahn API')) {
                    showScheduleError('âš ï¸ Die Deutsche Bahn API ist momentan nicht erreichbar.\n\nDies ist ein externes Problem der DB.\n\nBitte versuche es in ein paar Minuten erneut oder nutze direkt: https://reiseauskunft.bahn.de');
                } else {
                    showScheduleError('Fehler beim Laden der Fahrplandaten: ' + (error.message || 'Unbekannter Fehler'));
                }
            }
        }
        
        // Aktualisiert Fahrplan
        async function refreshSchedule() {
            scheduleLoaded = false;
        
        // ğŸ†• v5.88.8: Andere Haltestelle wÃ¤hlen
        function changeStation() {
            console.log('ğŸ”„ Haltestelle wechseln...');
            scheduleLoaded = false;
            
            // Leere die Abfahrten-Anzeige
            const trainList = document.getElementById('schedule-train-list');
            const busList = document.getElementById('schedule-bus-list');
            if (trainList) trainList.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">Lade Haltestellen...</div>';
            if (busList) busList.innerHTML = '';
            
            // Lade Fahrplan neu (zeigt Haltestellenauswahl)
            loadSchedule();
        }
            
            // ğŸ†• v5.49.3: NULL-CHECK!
            const trainsEl = document.getElementById('schedule-trains');
            const busesEl = document.getElementById('schedule-buses');
            
            // Loading states
            if (trainsEl) {
                trainsEl.innerHTML = '<div style="text-align:center;padding:20px;color:#6b7280;">Lade Zugverbindungen...</div>';
            }
            if (busesEl) {
                busesEl.innerHTML = '<div style="text-align:center;padding:20px;color:#6b7280;">Lade Busverbindungen...</div>';
            }
            
            await loadSchedule();
        }
        
        // Holt nahegelegene Haltestellen
        async function fetchNearbyStops(lat, lng) {
            try {
                // ğŸ†• v5.90.227: CACHING! PrÃ¼fe Cache zuerst
                const cacheKey = `transit_stops_${lat.toFixed(3)}_${lng.toFixed(3)}`;
                const cached = localStorage.getItem(cacheKey);
                
                if (cached) {
                    try {
                        const { data, timestamp } = JSON.parse(cached);
                        const age = Date.now() - timestamp;
                        const maxAge = 3600000; // 1 Stunde
                        
                        if (age < maxAge) {
                            const minutes = Math.round(age / 60000);
                            console.log(`ğŸ“¦ Nutze Cache (${minutes} Min alt)`);
                            return data;
                        } else {
                            console.log('ğŸ“¦ Cache zu alt, hole frische Daten...');
                        }
                    } catch (e) {
                        console.warn('âš ï¸ Cache-Fehler:', e);
                    }
                }
                
                const url = `https://v6.db.transport.rest/locations/nearby?latitude=${lat}&longitude=${lng}&results=5&distance=2000`;
                
                console.log('ğŸ” DEBUG: Suche Haltestellen...');
                console.log('ğŸ“ GPS:', lat, lng);
                console.log('ğŸŒ API-URL:', url);
                
                // ğŸ†• v5.90.227: AUTO-RETRY (bis zu 3 Versuche)
                let lastError = null;
                for (let attempt = 1; attempt <= 3; attempt++) {
                    try {
                        console.log(`ğŸ”„ Versuch ${attempt}/3...`);
                        
                        // Timeout nach 5 Sekunden
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000);
                        
                        const response = await fetch(url, { signal: controller.signal });
                        clearTimeout(timeoutId);
                        
                        console.log('ğŸ“¡ Response Status:', response.status, response.statusText);
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('ğŸ’¾ API Error Response:', errorText);
                            throw new Error(`API Error: ${response.status} - ${errorText}`);
                        }
                        
                        const data = await response.json();
                        console.log('ğŸ“¦ Raw API Data:', data);
                        
                        const stops = Array.isArray(data) ? data : (data.stops || []);
                        console.log(`âœ… Haltestellen gefunden: ${stops.length} (Versuch ${attempt})`);
                        
                        if (stops.length > 0) {
                            console.log('ğŸš NÃ¤chste Haltestelle:', stops[0].name, '|', stops[0].distance, 'm');
                            
                            // ğŸ†• v5.90.227: SPEICHERE IM CACHE!
                            try {
                                localStorage.setItem(cacheKey, JSON.stringify({
                                    data: stops,
                                    timestamp: Date.now()
                                }));
                                console.log('ğŸ’¾ Im Cache gespeichert!');
                            } catch (e) {
                                console.warn('âš ï¸ Cache-Speichern fehlgeschlagen:', e);
                            }
                        }
                        
                        return stops;
                        
                    } catch (fetchError) {
                        lastError = fetchError;
                        
                        if (fetchError.name === 'AbortError') {
                            console.error(`ğŸ’¾ Timeout bei Versuch ${attempt}/3`);
                            
                            // Warte 2 Sekunden vor nÃ¤chstem Versuch
                            if (attempt < 3) {
                                console.log('â±ï¸ Warte 2 Sekunden...');
                                await new Promise(resolve => setTimeout(resolve, 2000));
                            }
                        } else {
                            // Anderer Fehler - nicht retryable
                            throw fetchError;
                        }
                    }
                }
                
                // Alle 3 Versuche fehlgeschlagen
                console.error('ğŸ’¾ Alle 3 Versuche fehlgeschlagen!');
                throw new Error('Die Deutsche Bahn API antwortet nicht. Bitte versuche es spÃ¤ter erneut.');
                
            } catch (error) {
                console.error('ğŸ’¾ FEHLER bei Haltestellen-Suche:', error);
                console.error('ğŸ’¡ TIPP: Die DB API (v6.db.transport.rest) ist mÃ¶glicherweise offline oder Ã¼berlastet.');
                throw error;
            }
        }
        
        // Zeigt nÃ¤chste Haltestelle an
        // Zeigt mehrere Haltestellen zur Auswahl
        function displayStopSelection(stops, userLat, userLon) {
            // Sortiere: BahnhÃ¶fe zuerst, dann Bushaltestellen
            const sortedStops = stops.slice(0, 10).sort((a, b) => {
                const aIsStation = isTrainStation(a);
                const bIsStation = isTrainStation(b);
                
                // BahnhÃ¶fe haben PrioritÃ¤t
                if (aIsStation && !bIsStation) return -1;
                if (!aIsStation && bIsStation) return 1;
                
                // Sonst nach Entfernung sortieren
                return (a.distance || 9999) - (b.distance || 9999);
            });
            
            // Gruppiere nach Typ
            const stations = sortedStops.filter(s => isTrainStation(s));
            const busStops = sortedStops.filter(s => !isTrainStation(s));
            
            let stationsHTML = '';
            if (stations.length > 0) {
                stationsHTML = `
                    <div style="font-size:13px;font-weight:700;color:#1f2937;margin:15px 0 8px 0;">
                        ğŸš‚ BAHNHÃ–FE (mit Zugverbindungen):
                    </div>
                `;
                stationsHTML += stations.map(stop => createStopHTML(stop, userLat, userLon, 'ğŸš‚', '#3b82f6')).join('');
            }
            
            let busStopsHTML = '';
            if (busStops.length > 0) {
                busStopsHTML = `
                    <div style="font-size:13px;font-weight:700;color:#1f2937;margin:15px 0 8px 0;">
                        ğŸšŒ BUSHALTESTELLEN:
                    </div>
                `;
                busStopsHTML += busStops.map(stop => createStopHTML(stop, userLat, userLon, 'ğŸšŒ', '#f59e0b')).join('');
            }
            
            document.getElementById('schedule-nearest-stop').innerHTML = `
                <div style="margin-bottom:15px;">
                    <div style="font-size:14px;color:#6b7280;margin-bottom:10px;font-weight:600;">
                        ğŸš Haltestellen in Ihrer NÃ¤he:
                    </div>
                    ${stationsHTML}
                    ${busStopsHTML}
                    <div style="font-size:12px;color:#6b7280;text-align:center;margin-top:10px;">
                        ğŸ’¡ Tipp: BahnhÃ¶fe haben Zug + Bus, Bushaltestellen nur Bus
                    </div>
                </div>
            `;
            
            // Verstecke ZÃ¼ge/Busse Container bis Haltestelle gewÃ¤hlt
            document.getElementById('schedule-trains').innerHTML = '';
            document.getElementById('schedule-buses').innerHTML = '';
        }
        
        // PrÃ¼ft ob Haltestelle ein Bahnhof ist
        function isTrainStation(stop) {
            // Bahnhof wenn name "Bahnhof" oder "Bf" enthÃ¤lt
            if (stop.name && (stop.name.includes('Bahnhof') || stop.name.includes(' Bf') || stop.name.includes('Bhf'))) {
                return true;
            }
            
            // Oder wenn Zug-Produkte verfÃ¼gbar sind
            if (stop.products) {
                return stop.products.nationalExpress || 
                       stop.products.national || 
                       stop.products.regional || 
                       stop.products.regionalExp || 
                       stop.products.suburban;
            }
            
            return false;
        }
        
        // Erstellt HTML fÃ¼r eine Haltestelle
        function createStopHTML(stop, userLat, userLon, icon, color) {
            const distance = stop.distance ? Math.round(stop.distance) : '?';
            const stopId = stop.ibnr || stop.id;
            
            return `
                <div style="background:white;padding:12px;border-radius:10px;margin-bottom:8px;border-left:4px solid ${color};border-right:2px solid #e5e7eb;border-top:2px solid #e5e7eb;border-bottom:2px solid #e5e7eb;cursor:pointer;transition:all 0.2s;" 
                     onclick="selectStop('${stopId}', '${stop.name.replace(/'/g, "\\'")}', ${userLat}, ${userLon})"
                     onmouseover="this.style.borderColor='${color}';this.style.boxShadow='0 2px 8px rgba(59,130,246,0.2)'"
                     onmouseout="this.style.borderLeftColor='${color}';this.style.borderRightColor='#e5e7eb';this.style.borderTopColor='#e5e7eb';this.style.borderBottomColor='#e5e7eb';this.style.boxShadow='none'">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            <div style="font-size:15px;font-weight:700;color:#1f2937;margin-bottom:2px;">
                                ${icon} ${stop.name}
                            </div>
                            <div style="font-size:12px;color:#6b7280;">
                                ğŸ“ ${distance}m entfernt
                            </div>
                        </div>
                        <div style="padding:8px 16px;background:${color};color:white;border-radius:6px;font-size:13px;font-weight:600;">
                            Abfahrten â†’
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ALTE Funktion bleibt fÃ¼r KompatibilitÃ¤t
        
        // Wird aufgerufen wenn User eine Haltestelle wÃ¤hlt
        async function selectStop(stopId, stopName, userLat, userLon) {
            console.log('ğŸš Haltestelle gewÃ¤hlt:', stopName);
            console.log('ğŸ†” Stop-ID:', stopId);
            
            // Zeige gewÃ¤hlte Haltestelle
            document.getElementById('schedule-nearest-stop').innerHTML = `
                <div style="background:white;padding:15px;border-radius:12px;border:2px solid #3b82f6;margin-bottom:15px;">
                    <div style="font-size:14px;color:#3b82f6;margin-bottom:4px;font-weight:600;">âœ… GewÃ¤hlte Haltestelle:</div>
                    <div style="font-size:16px;font-weight:700;color:#1f2937;">${stopName}</div>
                    <button onclick="changeStation()" style="margin-top:8px;padding:6px 12px;background:#f3f4f6;border:none;border-radius:6px;font-size:12px;color:#6b7280;cursor:pointer;">
                        ğŸ”„ Andere Haltestelle wÃ¤hlen
                    </button>
                </div>
            `;
            
            // Lade Abfahrten
            await loadDepartures(stopId, stopName);
        }
        
        function displayNearestStop(stop) {
            const distance = stop.distance ? Math.round(stop.distance) : 'unbekannt';
            
            document.getElementById('schedule-nearest-stop').innerHTML = `
                <div style="background:white;padding:15px;border-radius:12px;border:2px solid #e5e7eb;">
                    <div style="font-size:14px;color:#6b7280;margin-bottom:4px;">ğŸš NÃ¤chste Haltestelle:</div>
                    <div style="font-size:16px;font-weight:700;color:#1f2937;">${stop.name}</div>
                    <div style="font-size:13px;color:#6b7280;margin-top:4px;">
                        ğŸ“ ${distance}m entfernt
                    </div>
                </div>
            `;
        }
        
        // LÃ¤dt Abfahrten von Haltestelle
        async function loadDepartures(stopId, stopName) {
            try {
                const url = `https://v6.db.transport.rest/stops/${encodeURIComponent(stopId)}/departures?duration=120&results=20`;
                
                console.log('ğŸš‚ğŸšŒ DEBUG: Lade Abfahrten...');
                console.log('ğŸš Haltestelle:', stopName);
                console.log('ğŸ†” Stop-ID:', stopId);
                console.log('ğŸŒ API-URL:', url);
                
                const response = await fetch(url);
                
                console.log('ğŸ“¡ Response Status:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('ğŸ’¾ API Error Response:', errorText);
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                console.log('ğŸ“¦ Raw API Data Type:', typeof data, '| Array?', Array.isArray(data));
                console.log('ğŸ“¦ Raw API Data:', data);
                
                const departures = Array.isArray(data) ? data : (data.departures || []);
                
                console.log('âœ… Abfahrten gefunden:', departures.length);
                
                // Trennen in ZÃ¼ge und Busse
                const trains = [];
                const buses = [];
                
                for (const dep of departures) {
                    const product = dep.line?.product || dep.product;
                    
                    if (product === 'suburban' || product === 'regional' || product === 'regionalExp' || product === 'national' || product === 'nationalExpress') {
                        trains.push(dep);
                    } else if (product === 'bus') {
                        buses.push(dep);
                    }
                }
                
                console.log('ğŸš‚ ZÃ¼ge:', trains.length);
                console.log('ğŸšŒ Busse:', buses.length);
                
                // Anzeigen
                displayTrains(trains, stopName);
                displayBuses(buses, stopName);
                
            } catch (error) {
                console.error('ğŸ’¾ FEHLER beim Laden der Abfahrten:', error);
                showScheduleError('Fehler beim Laden der Abfahrten: ' + error.message);
            }
        }
        
        // Zeigt ZÃ¼ge an
        function displayTrains(trains, stopName) {
            const container = document.getElementById('schedule-trains');
            
            // ğŸ†• v5.49.3: NULL-CHECK!
            if (!container) {
                console.error('ğŸ’¾ Element schedule-trains nicht gefunden!');
                return;
            }
            
            if (trains.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;padding:20px;color:#6b7280;">
                        Keine ZÃ¼ge in den nÃ¤chsten 2 Stunden
                    </div>
                `;
                return;
            }
            
            const html = trains.slice(0, 10).map(train => {
                const when = new Date(train.when);
                const plannedWhen = new Date(train.plannedWhen);
                const delay = train.delay ? Math.round(train.delay / 60) : 0;
                const isDelayed = delay > 0;
                
                // Countdown berechnen
                const now = new Date();
                const minutesUntil = Math.round((when - now) / 60000);
                const countdownText = minutesUntil < 1 ? 'Jetzt' : 
                                      minutesUntil === 1 ? 'in 1 Min' : 
                                      `in ${minutesUntil} Min`;
                
                return `
                    <div style="background:white;padding:12px;border-radius:8px;margin-bottom:8px;border-left:4px solid #3b82f6;">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
                            <div style="flex:1;">
                                <div style="font-weight:700;color:#1f2937;font-size:15px;">
                                    ${train.line.name} â†’ Richtung: ${train.direction}
                                </div>
                                <div style="font-size:13px;color:#6b7280;margin-top:4px;">
                                    ğŸ“ Ab: ${stopName}${train.platform ? ' | Gleis ' + train.platform : ''}
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:18px;font-weight:700;color:#1f2937;">
                                    ${when.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}
                                </div>
                                <div style="font-size:12px;color:${isDelayed ? '#dc2626' : '#10b981'};">
                                    ${isDelayed ? 'ğŸ• +' + delay + ' Min' : 'âš¡ PÃ¼nktlich'}
                                </div>
                            </div>
                        </div>
                        <div style="font-size:13px;font-weight:600;color:#3b82f6;">
                            â° ${countdownText}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }
        
        // Zeigt Busse an
        function displayBuses(buses, stopName) {
            const container = document.getElementById('schedule-buses');
            
            // ğŸ†• v5.49.3: NULL-CHECK!
            if (!container) {
                console.error('ğŸ’¾ Element schedule-buses nicht gefunden!');
                return;
            }
            
            if (buses.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;padding:20px;color:#6b7280;">
                        Keine Busse in den nÃ¤chsten 2 Stunden
                    </div>
                `;
                return;
            }
            
            const html = buses.slice(0, 10).map(bus => {
                const when = new Date(bus.when);
                const plannedWhen = new Date(bus.plannedWhen);
                const delay = bus.delay ? Math.round(bus.delay / 60) : 0;
                const isDelayed = delay > 0;
                
                // Countdown berechnen
                const now = new Date();
                const minutesUntil = Math.round((when - now) / 60000);
                const countdownText = minutesUntil < 1 ? 'Jetzt' : 
                                      minutesUntil === 1 ? 'in 1 Min' : 
                                      `in ${minutesUntil} Min`;
                
                return `
                    <div style="background:white;padding:12px;border-radius:8px;margin-bottom:8px;border-left:4px solid #f59e0b;">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
                            <div style="flex:1;">
                                <div style="font-weight:700;color:#1f2937;font-size:15px;">
                                    Bus ${bus.line.name} â†’ Richtung: ${bus.direction}
                                </div>
                                <div style="font-size:13px;color:#6b7280;margin-top:4px;">
                                    ğŸ“ Ab: ${stopName}
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:18px;font-weight:700;color:#1f2937;">
                                    ${when.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}
                                </div>
                                <div style="font-size:12px;color:${isDelayed ? '#dc2626' : '#10b981'};">
                                    ${isDelayed ? 'ğŸ• +' + delay + ' Min' : 'âš¡ PÃ¼nktlich'}
                                </div>
                            </div>
                        </div>
                        <div style="font-size:13px;font-weight:600;color:#f59e0b;">
                            â° ${countdownText}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }
        
        // Zeigt Fehler an
        function showScheduleError(message) {
            // ğŸ†• v5.49.3: NULL-CHECK!
            const trainsEl = document.getElementById('schedule-trains');
            const busesEl = document.getElementById('schedule-buses');
            
            if (trainsEl) {
                trainsEl.innerHTML = `
                    <div style="background:#fef2f2;color:#dc2626;padding:15px;border-radius:8px;text-align:center;">
                        âš ï¸ ${message}
                    </div>
                `;
            } else {
                console.error('ğŸ’¾ Element schedule-trains nicht gefunden!');
            }
            
            if (busesEl) {
                busesEl.innerHTML = '';
            } else {
                console.error('ğŸ’¾ Element schedule-buses nicht gefunden!');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function updateStatus() {
            const dot = document.getElementById('sync-dot');
            const status = document.getElementById('sync-status');
            if (isFirebaseReady && isConnected) {
                dot.classList.add('online');
                status.textContent = 'ğŸŸ¢ Live';
            } else {
                dot.classList.remove('online');
                status.textContent = 'ğŸ’¾ Lokal';
            }
        }
        async function initServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    serviceWorkerRegistration = await navigator.serviceWorker.register('./service-worker.js');
                    console.log('âœ… Service Worker registriert:', serviceWorkerRegistration.scope);
                    
                    // Push-Berechtigung anfragen (nur beim ersten Mal oder wenn abgelehnt)
                    if ('Notification' in window) {
                        notificationPermission = await Notification.requestPermission();
                        console.log('ğŸ”” Notification Permission:', notificationPermission);
                        
                        if (notificationPermission === 'granted') {
                            console.log('âœ… Push-Benachrichtigungen erlaubt!');
                        }
                    }
                } catch (error) {
                    console.error('ğŸ’¾ Service Worker Fehler:', error);
                }
            } else {
                console.warn('âš ï¸ Service Worker nicht unterstÃ¼tzt');
            }
        }

        // Push-Benachrichtigung senden (lokal)
        function sendLocalNotification(title, body, data = {}) {
            if ('Notification' in window && Notification.permission === 'granted') {
                if (serviceWorkerRegistration) {
                    serviceWorkerRegistration.showNotification(title, {
                        body: body,
                        icon: '/icon-192.png',
                        badge: '/badge-72.png',
                        vibrate: [200, 100, 200, 100, 200],
                        tag: 'taxi-' + (data.rideId || 'notification'),
                        requireInteraction: true,
                        data: data,
                        actions: [
                            { action: 'accept', title: 'âœ“ Annehmen' },
                            { action: 'dismiss', title: 'âœ• Ablehnen' }
                        ]
                    });
                    
                    // Sound abspielen
                    playNotificationSound();
                }
            } else {
                console.warn('âš ï¸ Notifications nicht verfÃ¼gbar oder nicht erlaubt');
            }
        }

        // Sound fÃ¼r Benachrichtigungen
        function playNotificationSound() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ==');
                audio.volume = 1.0;
                audio.play().catch(e => console.log('ğŸ”‡ Audio play blocked'));
            } catch (e) {
                console.log('ğŸ”‡ Audio not supported');
            }
        }

        function switchView(view) {
            // ğŸ” v5.90.0: MEGA DEBUG!
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ” DEBUG: switchView() AUFGERUFEN!');
            console.log('ğŸ“‹ Parameter "view":', view);
            console.log('ğŸ“ Typ:', typeof view);
            console.log('ğŸ“ LÃ¤nge:', view ? view.length : 'null');
            console.log('ğŸ”¤ Exakte Bytes:', JSON.stringify(view));
            
            // Stack Trace um zu sehen WO es aufgerufen wurde
            try {
                const stack = new Error().stack;
                console.log('ğŸ’¾ Aufgerufen von:');
                stack.split('\n').slice(1, 4).forEach(line => console.log('   ', line.trim()));
            } catch (e) {
                console.log('ğŸ’¾ Stack nicht verfÃ¼gbar');
            }
            
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            console.log('ğŸ”„ switchView aufgerufen mit:', view);
            debugLog('info', `ğŸ”„ Tab-Wechsel: ${view}`);
            
            // Entferne active von allen Views
            document.querySelectorAll('.view').forEach(v => {
                v.classList.remove('active');
                v.style.display = 'none'; // Extra sicher!
                v.style.visibility = 'hidden'; // ğŸ†• v5.33.4: Auch visibility!
            });
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            // ğŸ†• v5.33.1: Entferne active von Admin-Tab-Buttons
            document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));
            
            // ğŸ†• v5.33.4: EXTRA BRUTAL - Verstecke alle Views einzeln!
            // ğŸ†• v5.90.525: fleet-overview-view hinzugefÃ¼gt!
            // ğŸ†• v5.90.548: express-booking-view hinzugefÃ¼gt!
            const allViews = ['simulator-view', 'express-booking-view', 'passenger-view', 'schedule-view', 'history-view', 'rechnung-view', 'hotel-calendar-view', 'crm-view', 'email-inbox-view', 'driver-view', 'admin-view', 'shift-plan-view', 'debug-view', 'system-diagnostics-view', 'live-monitor-view', 'ai-assistant-view', 'booking-requests-view', 'backup-view', 'poi-management-view', 'fleet-overview-view'];
            allViews.forEach(viewId => {
                const viewEl = document.getElementById(viewId);
                if (viewEl) {
                    viewEl.style.display = 'none';
                    viewEl.style.visibility = 'hidden';
                    viewEl.classList.remove('active');
                    console.log('  ğŸ’¾ Versteckt:', viewId);
                }
            });
            
            // âœ… Zeige nur die aktive View
            const viewElement = document.getElementById(view + '-view');
            if (viewElement) {
                // ğŸ”§ v5.90.102: PRÃœFE ob Admin-View und ob User Admin ist!
                const isAdminView = viewElement.classList.contains('admin-only');
                const isAdmin = document.body.classList.contains('is-admin');
                
                if (isAdminView && !isAdmin) {
                    console.warn('ğŸ”’ v5.90.102: Zugriff verweigert! Admin-View nur fÃ¼r Admin!');
                    console.warn(`   View "${view}" ist admin-only, aber User ist kein Admin!`);
                    console.warn('   â†’ Redirect zu passenger-view');
                    // Redirect zu passenger
                    switchView('passenger');
                    return;
                }
                
                viewElement.style.display = 'block';
                viewElement.style.visibility = 'visible';
                viewElement.classList.add('active');
                console.log('  âœ… Zeige:', view + '-view');
            } else {
                console.error('  âš ï¸ View nicht gefunden:', view + '-view');
            }
            
            // âœ… Setze aktiven Button basierend auf View-Name
            const viewBtnMap = {
                'passenger': '.view-btn[onclick*="passenger"]',
                'schedule': '.view-btn[onclick*="schedule"]',
                'history': '.view-btn[onclick*="history"]',
                'driver': '.view-btn[onclick*="driver"]',
                'admin': '.view-btn[onclick*="admin"]'
            };
            const btnSelector = viewBtnMap[view];
            if (btnSelector) {
                const btn = document.querySelector(btnSelector);
                if (btn) btn.classList.add('active');
            }
            
            // ğŸ†• v5.33.1: Setze aktiven Admin-Tab-Button
            const adminTabBtn = document.querySelector(`.admin-tab-btn[data-view="${view}"]`);
            if (adminTabBtn) {
                adminTabBtn.classList.add('active');
            }
            
            currentView = view;
            
            // ğŸ†• v5.90.578: KARTEN INITIALISIEREN!
            if (view === 'express-booking') {
                setTimeout(() => {
                    console.log('ğŸ—ºï¸ v5.90.578: Initialisiere Express-Booking Karte...');
                    if (typeof initExpressBooking === 'function') {
                        initExpressBooking();
                    } else {
                        console.error('âŒ initExpressBooking() nicht gefunden!');
                    }
                }, 300);
            }
            
            if (view === 'simulator') {
                setTimeout(() => {
                    console.log('ğŸ—ºï¸ v5.90.578: Initialisiere Simulator Karte...');
                    if (typeof initSimulator === 'function') {
                        initSimulator();
                    } else {
                        console.error('âŒ initSimulator() nicht gefunden!');
                    }
                }, 300);
            }
            
            // ğŸ†• v5.90.25: Speichere aktiven Tab!
            localStorage.setItem('lastActiveTab', view);
            console.log('ğŸ’¾ Aktiver Tab gespeichert:', view);
            
            console.log('ğŸ”„ View gewechselt zu:', view);
            
            // ğŸ†• v5.26.0: Telefon-Auth prÃ¼fen bei Fahrgast-Tab
            if (view === 'passenger') {
                setTimeout(() => {
                    checkPassengerAuth();
                    
                    // ğŸ†• v5.90.561: EXPRESS-BOOKING DATEN LADEN!
                    const expressPickup = localStorage.getItem('expressBookingPickup');
                    const expressDest = localStorage.getItem('expressBookingDestination');
                    
                    if (expressPickup) {
                        try {
                            const data = JSON.parse(expressPickup);
                            const pickupInput = document.getElementById('pickup');
                            if (pickupInput && data.address) {
                                pickupInput.value = data.address;
                                // Setze Koordinaten global
                                window.pickupCoords = { lat: data.lat, lon: data.lon };
                                window.pickupConfirmed = true;
                                console.log('âœ… Express-Abholort geladen:', data.address);
                            }
                            localStorage.removeItem('expressBookingPickup');
                        } catch (e) {
                            console.error('âŒ Express-Pickup Parse-Fehler:', e);
                        }
                    }
                    
                    if (expressDest) {
                        try {
                            const data = JSON.parse(expressDest);
                            const destInput = document.getElementById('destination');
                            if (destInput && data.address) {
                                destInput.value = data.address;
                                // Setze Koordinaten global
                                window.destCoords = { lat: data.lat, lon: data.lon };
                                window.destinationConfirmed = true;
                                console.log('âœ… Express-Zielort geladen:', data.address);
                            }
                            localStorage.removeItem('expressBookingDestination');
                        } catch (e) {
                            console.error('âŒ Express-Dest Parse-Fehler:', e);
                        }
                    }
                }, 100);
            } else {
                // Login-Screen verstecken bei anderen Tabs
                const authScreen = document.getElementById('phone-auth-screen');
                if (authScreen) authScreen.style.display = 'none';
            }
            
            // ğŸ†• v5.32.6: Fahrplan laden bei Schedule-Tab
            // ğŸ”§ v5.90.336: FIX - war "calendar", muss "schedule" sein!
            if (view === 'schedule') {
                console.log('ğŸšŒ Schedule-View geÃ¶ffnet - lade Fahrplan...');
                setTimeout(() => {
                    if (typeof loadSchedule === 'function') {
                        loadSchedule();
                    } else {
                        console.error('ğŸ’¾ loadSchedule() Funktion nicht gefunden!');
                    }
                }, 100);
            }
            
            // ğŸ†• v5.90.548: Express-Booking initialisieren!
            if (view === 'express-booking') {
                console.log('âš¡ Express-Booking View geÃ¶ffnet!');
                setTimeout(() => {
                    if (typeof initExpressBooking === 'function') {
                        // ğŸ†• v5.90.552: Warte bis Leaflet geladen ist!
                        if (typeof L === 'undefined') {
                            console.log('â³ Warte auf Leaflet...');
                            const checkLeaflet = setInterval(() => {
                                if (typeof L !== 'undefined') {
                                    clearInterval(checkLeaflet);
                                    initExpressBooking();
                                }
                            }, 100);
                        } else {
                            initExpressBooking();
                        }
                    } else {
                        console.error('ğŸ’¾ initExpressBooking() nicht gefunden!');
                    }
                }, 100);
            }
            
            // ğŸ†• v5.90.553: Simulator initialisieren!
            if (view === 'simulator') {
                console.log('ğŸ® Simulator View geÃ¶ffnet!');
                setTimeout(() => {
                    if (typeof initSimulator === 'function') {
                        if (typeof L === 'undefined') {
                            console.log('â³ Warte auf Leaflet...');
                            const checkLeaflet = setInterval(() => {
                                if (typeof L !== 'undefined') {
                                    clearInterval(checkLeaflet);
                                    initSimulator();
                                }
                            }, 100);
                        } else {
                            initSimulator();
                        }
                    } else {
                        console.error('ğŸ’¾ initSimulator() nicht gefunden!');
                    }
                }, 100);
            }
            
            // Kalender separat behandeln
            if (view === 'calendar') {
                // ğŸ†• v5.90.278: SPRINGE ZUM HEUTIGEN TAG!
                currentCalendarDate = new Date(); // Setze auf heute
                console.log('ğŸ“… Kalender Ã¶ffnet bei:', currentCalendarDate.toLocaleDateString('de-DE'));
                
                setTimeout(() => {
                    renderCalendar(); // ğŸ”§ v5.90.281: RENDER KALENDER (nicht Ã¶ffentliche Verkehrsmittel!)
                    
                    // ğŸ†• v5.90.278: SCROLL ZUM HEUTIGEN TAG!
                    setTimeout(() => {
                        const today = new Date();
                        const todayStr = getLocalDateString(today); // ğŸ”§ v5.90.353: LOKAL!
                        const todayElement = document.querySelector(`[data-date="${todayStr}"]`);
                        
                        if (todayElement) {
                            todayElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            console.log('âœ… Zu heute gescrollt!', todayStr);
                        }
                    }, 500);
                }, 100);
            }
            
            // ğŸ†• v5.39.8: Debug-Logs neu laden bei Debug-View!
            if (view === 'debug') {
                setTimeout(() => {
                    if (typeof window.reloadDebugUI === 'function') {
                        console.log('ğŸ”„ Lade Debug-Logs in UI...');
                        window.reloadDebugUI();
                    }
                }, 100);
            }
            
            // ğŸ†• v5.90.563: Tab-Settings-Panel laden bei Admin-View!
            if (view === 'admin') {
                setTimeout(() => {
                    if (typeof initTabSettingsPanel === 'function') {
                        console.log('âš™ï¸ Lade Tab-Einstellungen Panel...');
                        initTabSettingsPanel();
                    }
                }, 100);
            }
            
            // ğŸ†• v5.90.40: Archiv laden bei Archive-View!
            if (view === 'archive') {
                setTimeout(() => loadArchive(), 100);
            }
            
            // ğŸ†• v5.90.24: Rechnungsliste laden bei Rechnung-View!
            if (view === 'rechnung') {
                setTimeout(() => {
                    if (typeof loadRidesForInvoicing === 'function') {
                        console.log('ğŸš• Lade Fahrten fÃ¼r Rechnungs-Erstellung...');
                        loadRidesForInvoicing();
                        
                        // ğŸ†• v5.90.197: AUCH im rechnung-view aktualisieren!
                        // Warte kurz bis loadRidesForInvoicing fertig ist
                        setTimeout(() => {
                            const list = document.getElementById('rechnung-single-invoices-list');
                            const count = document.getElementById('rechnung-single-invoices-count');
                            const sourceList = document.getElementById('single-invoices-list');
                            const sourceCount = document.getElementById('single-invoices-count');
                            
                            if (list && sourceList) {
                                list.innerHTML = sourceList.innerHTML;
                                console.log('âœ… Fahrten-Liste in rechnung-view aktualisiert!');
                            }
                            if (count && sourceCount) {
                                count.textContent = sourceCount.textContent;
                            }
                        }, 500);
                    }
                }, 100);
            }
            
            // ğŸ†• v5.90.525: FahrzeugÃ¼bersicht mit ADMIN Fleet Map initialisieren!
            if (view === 'fleet-overview') {
                // ğŸ†• v5.90.525: VERSTECKE Anruf-Button!
                const callFab = document.getElementById('call-favorites-fab');
                if (callFab) callFab.style.display = 'none';
                
                setTimeout(() => {
                    console.log('ğŸ—ºï¸ Initialisiere FahrzeugÃ¼bersicht (EIGENE MAP)...');
                    
                    // ğŸ†• v5.90.525: EIGENE Fleet-Map fÃ¼r Overview!
                    if (typeof initFleetMapOverview === 'function') {
                        initFleetMapOverview();
                        
                        // Leaflet Fix: Karte neu rendern
                        setTimeout(() => {
                            if (fleetMapOverview) {
                                fleetMapOverview.invalidateSize();
                                console.log('âœ… Fleet-Map-Overview invalidateSize() aufgerufen');
                            }
                        }, 300);
                    }
                    
                    // Daten sofort laden
                    if (typeof refreshFleetMapOverview === 'function') {
                        refreshFleetMapOverview();
                    }
                    
                    // ğŸ†• v5.90.525: AUTO-REFRESH!
                    if (window.fleetOverviewInterval) {
                        clearInterval(window.fleetOverviewInterval);
                    }
                    window.fleetOverviewInterval = setInterval(() => {
                        if (currentView === 'fleet-overview' && typeof refreshFleetMapOverview === 'function') {
                            console.log('ğŸ”„ Auto-Update FahrzeugÃ¼bersicht...');
                            refreshFleetMapOverview();
                        }
                    }, 5000);
                }, 100);
            } else {
                // ğŸ†• v5.90.525: ZEIGE Anruf-Button wieder!
                const callFab = document.getElementById('call-favorites-fab');
                if (callFab && currentUser?.role === 'admin') {
                    callFab.style.display = 'block';
                }
                
                // ğŸ†• v5.90.525: Stoppe Auto-Updates
                if (window.fleetOverviewInterval) {
                    clearInterval(window.fleetOverviewInterval);
                    window.fleetOverviewInterval = null;
                }
            }
            
            const gpsIndicator = document.getElementById('gps-indicator');
            if (view === 'driver') {
                if (gpsIndicator) gpsIndicator.style.display = 'flex';
                
                // ğŸ†• v5.90.300: VERSTECKE Header + Tabs + Anruf-Button!
                const mainHeader = document.getElementById('main-header');
                if (mainHeader) mainHeader.style.display = 'none';
                
                const tabButtons = document.querySelectorAll('.tab-toggleable');
                tabButtons.forEach(btn => btn.style.display = 'none');
                
                const callButton = document.getElementById('call-favorites-fab');
                if (callButton) callButton.style.display = 'none';
                
                // ğŸ†• v5.90.367: ALTE KARTE DEAKTIVIERT - ISARFUNK hat keine Karte!
                // setTimeout(() => {
                //     initDriverMapV295();
                //     updateDriverViewV295();
                // }, 100);
                
                // ğŸ”‹ Initialisiere Batterie-Spar-System
                if (typeof PowerSaveManager !== 'undefined') {
                    setTimeout(() => PowerSaveManager.init(), 500);
                }
                
                // âš™ï¸ Initialisiere Driver-Settings-Manager (nach PowerSaveManager!)
                if (typeof DriverSettingsManager !== 'undefined' && currentVehicle) {
                    setTimeout(() => DriverSettingsManager.init(currentVehicle), 1000);
                }
                
                // ğŸ¯ AUTO-START GPS beim Ã–ffnen der Fahrer-Ansicht!
                console.log('ğŸš• Fahrer-Ansicht geÃ¶ffnet - starte GPS automatisch...');
                setTimeout(() => {
                    if (!watchId && currentVehicle) {
                        console.log('ğŸ”„ GPS Auto-Start...');
                        startGPSTracking();
                    }
                    // Starte GPS-Monitoring
                    startGPSMonitoring();
                    
                    // ğŸ†• v5.90.367: MAP UPDATE DEAKTIVIERT - ISARFUNK braucht keine Karte!
                    // setInterval(() => {
                    //     if (document.getElementById('driver-view').style.display !== 'none') {
                    //         updateDriverMapV295();
                    //     }
                    // }, 3000);
                }, 500);
            } else {
                if (gpsIndicator) gpsIndicator.style.display = 'none';
                
                // ğŸ†• v5.90.300: ZEIGE Header + Tabs + Anruf-Button wieder!
                const mainHeader = document.getElementById('main-header');
                if (mainHeader) mainHeader.style.display = 'block';
                
                const tabButtons = document.querySelectorAll('.tab-toggleable');
                tabButtons.forEach(btn => btn.style.display = 'inline-block');
                
                const callButton = document.getElementById('call-favorites-fab');
                if (callButton && currentUser && currentUser.role !== 'driver') {
                    callButton.style.display = 'block';
                }
                
                // âœ… Stoppe GPS-Monitoring UND GPS-Tracking wenn Ansicht gewechselt wird
                stopGPSMonitoring();
                stopDriverTracking();  // â† FIX: GPS auch stoppen!
                console.log('ğŸ”„ View gewechselt - GPS gestoppt');
            }
            
            if (view === 'history') loadHistory();
            
            // ğŸ†• v5.86.0: Hotel-Kalender laden
            if (view === 'hotel-calendar') {
                setTimeout(() => {
                    loadHotelCalendarList();
                    
                    // ğŸ†• v5.87.48: ECHTES DROPDOWN mit letzten 12 Monaten!
                    const monthSelect = document.getElementById('invoice-month-select');
                    if (monthSelect) {
                        // Generiere letzte 12 Monate
                        const now = new Date();
                        let html = '';
                        for (let i = 0; i < 12; i++) {
                            const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                            // ğŸ†• v5.87.54: LOKALE ZEIT statt UTC! (toISOString gibt UTC!)
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0'); // Monat 0-11 â†’ 1-12
                            const value = `${year}-${month}`; // z.B. "2025-07"
                            const label = date.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
                            html += `<option value="${value}"${i === 0 ? ' selected' : ''}>${label}</option>`;
                        }
                        monthSelect.innerHTML = html;
                        console.log('ğŸ“… Monat-Dropdown befÃ¼llt: 12 Monate, aktuell:', `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`);
                    }
                    
                    // BefÃ¼lle Hotel-Dropdown
                    const hotelSelect = document.getElementById('invoice-hotel-select');
                    if (hotelSelect) {
                        hotelSelect.innerHTML = '<option value="">Alle Hotels</option>';
                        Object.entries(hotelCalendars).forEach(([id, hotel]) => {
                            const option = document.createElement('option');
                            option.value = id;
                            option.textContent = hotel.name;
                            hotelSelect.appendChild(option);
                        });
                        console.log('ğŸ¨ Hotel-Dropdown befÃ¼llt:', Object.keys(hotelCalendars).length);
                    }
                }, 100);
            }
            
            // ğŸ†• v5.86.14: Backup-Liste laden
            if (view === 'backup') {
                setTimeout(() => updateBackupList(), 100);
            }
            
            // ğŸ†• v5.90.190: CRM View laden
            if (view === 'crm') {
                setTimeout(() => loadCRMView(), 100);
            }
            
            // ğŸ†• v5.86.30: POI-Management laden
            if (view === 'poi-management') {
                setTimeout(() => loadPOIs(), 100);
            }
            
            // ğŸ†• v5.90.246: Driver View - Fahrzeug-Dropdown aktualisieren!
            if (view === 'driver') {
                setTimeout(() => {
                    console.log('ğŸš— Driver-View geladen - Update Fahrzeug-Dropdown...');
                    updateVehicleDropdowns();
                }, 100);
            }
            
            updateViews();
        }

        // ğŸ“± MENÃœ FUNKTIONEN
        function toggleMenu(event) {
            event.stopPropagation();
            const menu = document.getElementById('menu-overlay');
            if (menu.style.display === 'none' || !menu.style.display) {
                debugLog('info', 'ğŸ“± Menu geÃ¶ffnet');
                menu.style.display = 'block';
                document.body.style.overflow = 'hidden'; // Verhindere Scrollen im Hintergrund
            } else {
                closeMenu();
            }
        }

        function closeMenu() {
            debugLog('info', 'ğŸ“± Menu geschlossen');
            const menu = document.getElementById('menu-overlay');
            menu.style.display = 'none';
            document.body.style.overflow = ''; // Erlaube Scrollen wieder
        }

        function openScheduleFromMenu() {
            closeMenu();
            switchView('schedule');
        }

        function openHistoryFromMenu() {
            closeMenu();
            switchView('history');
        }

        function backToBookingFromMenu() {
            closeMenu();
            switchView('passenger');
        }
        
        // ğŸ› v5.46.6: Debug Panel aus Menu Ã¶ffnen
        function openDebugPanelFromMenu() {
            closeMenu();
            toggleDebugPanel();
        }

        // ğŸ†• v5.44.0: Ã–PNV-TAXI BUCHUNG STARTEN
        function startOPNVBooking() {
            console.log('ğŸš Ã–PNV-Taxi Modus aktiviert!');
            
            // Aktiviere Ã–PNV-Modus
            isOPNVMode = true;
            
            // Wechsle zur Passenger-View
            switchView('passenger');
            
            // Zeige Ã–PNV-Hinweis
            showOPNVHint();
            
            // Aktiviere Ã–PNV-Tarif (falls vorhanden)
            const opnvCheckbox = document.getElementById('opnv-checkbox');
            if (opnvCheckbox) {
                opnvCheckbox.checked = true;
            }
            
            console.log('âœ… Ã–PNV-Modus aktiv - Autocomplete zeigt nur Bushaltestellen!');
        }
        
        // Zeige Ã–PNV-Hinweis
        function showOPNVHint() {
            // Entferne alten Hinweis falls vorhanden
            const oldHint = document.getElementById('opnv-mode-hint');
            if (oldHint) oldHint.remove();
            
            // Erstelle Hinweis
            const hint = document.createElement('div');
            hint.id = 'opnv-mode-hint';
            hint.style.cssText = `
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
                padding: 15px;
                border-radius: 12px;
                margin-bottom: 20px;
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            `;
            hint.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="flex: 1;">
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 5px;">ğŸš Ã–PNV-TAXI MODUS</div>
                        <div style="font-size: 13px; opacity: 0.95;">Nur Bushaltestellen werden angezeigt</div>
                        <div style="font-size: 13px; opacity: 0.95;">Busticket-Preis + 2â‚¬ Aufpreis</div>
                    </div>
                    <button onclick="exitOPNVMode()" style="
                        padding: 8px 16px;
                        background: white;
                        color: #059669;
                        border: none;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        font-size: 13px;
                    ">
                        âœ–ï¸ Normal
                    </button>
                </div>
            `;
            
            // FÃ¼ge Hinweis ein (vor booking-form)
            const bookingForm = document.getElementById('booking-form');
            if (bookingForm) {
                bookingForm.parentNode.insertBefore(hint, bookingForm);
            }
        }
        
        // Ã–PNV-Modus beenden
        function exitOPNVMode() {
            isOPNVMode = false;
            const hint = document.getElementById('opnv-mode-hint');
            if (hint) hint.remove();
            
            // Deaktiviere Ã–PNV-Tarif
            const opnvCheckbox = document.getElementById('opnv-checkbox');
            if (opnvCheckbox) {
                opnvCheckbox.checked = false;
            }
            
            console.log('ğŸ”„ Normaler Modus - Alle Adressen verfÃ¼gbar');
        }
        
        // ğŸ†• v5.45.0: ABFAHRTSTAFEL-FUNKTIONEN
        
        // Lade Abfahrten fÃ¼r gewÃ¤hlte Bushaltestelle

        // ğŸ†• v5.33.1: Admin-Tabs anzeigen/verstecken
        function updateAdminTabsVisibility() {
            const adminTabs = document.getElementById('main-tab-bar');
            if (!adminTabs) return;
            
            // ğŸ†• v5.33.6: PrÃ¼fe User-Rolle!
            // Tabs nur fÃ¼r Fahrer & Admin, NICHT fÃ¼r FahrgÃ¤ste!
            
            // 1. PrÃ¼fe ob User eingeloggt ist
            const phoneAuthScreen = document.getElementById('phone-auth-screen');
            const phoneAuthVisible = phoneAuthScreen && phoneAuthScreen.style.display !== 'none';
            
            const accountName = document.getElementById('customer-name-display');
            const hasName = accountName && accountName.textContent && accountName.textContent.trim() !== '';
            
            const bookingForm = document.getElementById('booking-form');
            const bookingVisible = bookingForm && window.getComputedStyle(bookingForm).display !== 'none';
            
            const isLoggedIn = !phoneAuthVisible && (hasName || bookingVisible);
            
            // 2. PrÃ¼fe User-Rolle (global gesetzt durch applyRoleRestrictions)
            // Tabs ONLY fÃ¼r Fahrer & Admin!
            const showTabs = isLoggedIn && (userRole === 'admin' || userRole === 'fahrer');
            
            if (showTabs) {
                adminTabs.style.display = 'block';
                
                // ğŸ†• v5.64.25: FILTER TABS BY ROLE!
                if (userRole === 'fahrer') {
                    // FAHRER: Nur Fahrer-Tab anzeigen!
                    document.querySelectorAll('.admin-tab-btn.admin-only').forEach(btn => {
                        btn.style.display = 'none';
                    });
                    document.querySelectorAll('.admin-tab-btn.driver-visible').forEach(btn => {
                        btn.style.display = 'inline-block';
                    });
                    console.log('âœ… Fahrer-Tabs gefiltert: Nur Fahrer-Tab sichtbar');
                } else if (userRole === 'admin') {
                    // ADMIN: Alle Tabs anzeigen!
                    document.querySelectorAll('.admin-tab-btn').forEach(btn => {
                        btn.style.display = 'inline-block';
                    });
                    console.log('âœ… Admin: Alle Tabs sichtbar');
                }
                
                console.log('âœ… Admin-Tabs angezeigt (User:', userRole, ')');
            } else {
                adminTabs.style.display = 'none';
                if (isLoggedIn) {
                    console.log('ğŸ’¾ Admin-Tabs versteckt (Fahrgast - nutzt MenÃ¼)');
                } else {
                    console.log('ğŸ’¾ Admin-Tabs versteckt (nicht eingeloggt)');
                }
            }
        }
        
        // ğŸ†• v5.90.4: Admin-Tabs NUR beim Login prÃ¼fen - KEIN permanenter Timer mehr!
        // Alte 5-Sekunden Checks entfernt - Tabs bleiben stabil
        // Warte auf Firebase Auth bevor onAuthStateChanged aufgerufen wird
        function initAdminTabsListener() {
            if (!auth) {
                console.log('â³ v5.90.4: Warte auf Firebase Auth...');
                setTimeout(initAdminTabsListener, 500);
                return;
            }
            
            console.log('âœ… v5.90.4: Firebase Auth bereit - registriere Tab-Listener');
            
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // Nach Login: Tab-Leiste anzeigen
                    setTimeout(() => updateAdminTabsVisibility(), 500);
                    setTimeout(() => updateAdminTabsVisibility(), 1500);
                } else {
                    // Beim Logout: Tab-Leiste verstecken
                    const adminTabs = document.getElementById('main-tab-bar');
                    if (adminTabs) adminTabs.style.display = 'none';
                }
            });
        }
        
        // Starte Listener-Initialisierung
        initAdminTabsListener();

        // ğŸ†• v5.89.0: TAB-MANAGER
        
        // Tab-Definitionen (ID, Label, Icon, Required)
        
        // Lade Tab-Einstellungen
        async function loadTabSettings() {
            console.log('ğŸ“‘ Lade Tab-Berechtigungen aus Firebase...');
            
            if (!db) {
                console.log('âš ï¸ Firebase DB nicht bereit');
                return;
            }
            
            try {
                // ğŸ†• v5.90.17: AUTO-FIX fÃ¼r Admin Permissions
                await ensureAdminHasAllTabs();
                
                // Lade GLOBALE Einstellungen (nicht pro User!)
                const settingsRef = db.ref('settings/tabPermissions');
                const snapshot = await settingsRef.once('value');
                
                let permissions = {};
                
                if (snapshot.exists()) {
                    permissions = snapshot.val();
                    console.log('âœ… Tab-Berechtigungen geladen:', permissions);
                } else {
                    // Default: Standard-Berechtigungen
                    permissions = getDefaultPermissions();
                    console.log('â„¹ï¸ Nutze Default-Berechtigungen');
                }
                
                // Wende Berechtigungen fÃ¼r aktuelle Rolle an
                const user = auth.currentUser;
                if (user) {
                    const userRef = db.ref(`users/${user.uid}`);
                    const userSnap = await userRef.once('value');
                    const userData = userSnap.val();
                    const role = userData?.role || 'passenger';
                    
                    console.log(`ğŸ” Wende Tab-Berechtigungen an fÃ¼r Rolle: ${role}`);
                    await applyTabPermissions(permissions, role);
                }
                
                // ğŸ†• v5.90.586: FÃ¼lle USER Tab-Verwaltung (nicht Rollen)!
                fillUserTabManagement();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der Tab-Berechtigungen:', error);
            }
        }
        
        // Standard-Berechtigungen
        function getDefaultPermissions() {
            return {
                admin: ['passenger', 'schedule', 'history', 'calendar', 'hotel-calendar', 'driver', 'admin', 'shift-plan', 'debug', 'ai-assistant', 'booking-requests', 'backup', 'poi-management', 'archive', 'express-booking', 'simulator'],
                driver: ['driver'], // ğŸ†• v5.90.525: NUR Fahrer-Tab!
                passenger: ['passenger', 'history']  // ğŸ”§ v5.90.89: Nur Buchen + Meine Fahrten!
            };
        }
        
        // ğŸ†• v5.90.17: AUTO-FIX fÃ¼r Admin Permissions
        async function ensureAdminHasAllTabs() {
            if (!isFirebaseReady) return;
            
            try {
                const settingsRef = db.ref('settings/tabPermissions');
                const snapshot = await settingsRef.once('value');
                let permissions = snapshot.exists() ? snapshot.val() : null;
                
                const allTabs = ['passenger', 'schedule', 'history', 'calendar', 'hotel-calendar', 'driver', 'admin', 'shift-plan', 'debug', 'ai-assistant', 'booking-requests', 'backup', 'poi-management', 'archive', 'express-booking', 'simulator'];
                
                // Wenn keine Permissions oder Admin hat nicht alle Tabs
                if (!permissions || !permissions.admin || permissions.admin.length < allTabs.length) {
                    console.warn('âš ï¸ Admin Permissions unvollstÃ¤ndig - fixe automatisch!');
                    console.log('ğŸ“± Vorher:', permissions?.admin || 'keine');
                    
                    if (!permissions) {
                        permissions = getDefaultPermissions();
                    } else {
                        permissions.admin = allTabs;
                    }
                    
                    await settingsRef.set(permissions);
                    console.log('âœ… Admin Permissions automatisch gefixt!');
                    console.log('ğŸ“± Nachher:', permissions.admin);
                    
                    return permissions;
                }
                
                return permissions;
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Auto-Fix:', error);
                return getDefaultPermissions();
            }
        }
        
        // Wende Tab-Berechtigungen an
        async function applyTabPermissions(permissions, role) {
            console.log(`ğŸ¨ v5.90.591: Wende Tab-Berechtigungen an fÃ¼r: ${role}`);
            
            const allowedTabs = permissions[role] || [];
            
            // ğŸ†• v5.90.591: LADE USER CUSTOM TABS!
            const user = auth.currentUser;
            let userCustomTabs = {};
            
            if (user) {
                try {
                    const userRef = db.ref(`users/${user.uid}/customTabs`);
                    const snapshot = await userRef.once('value');
                    userCustomTabs = snapshot.val() || {};
                    console.log('ğŸ“‹ v5.90.591: User Custom Tabs geladen:', userCustomTabs);
                } catch (error) {
                    console.error('ğŸ’¾ v5.90.591: Fehler beim Laden Custom Tabs:', error);
                }
            }
            
            const allTabs = document.querySelectorAll('.tab-toggleable[data-tab-id]');
            
            console.log(`ğŸ“± Gefundene Tabs: ${allTabs.length}`);
            console.log(`ğŸ“‹ Erlaubte Tabs (Rolle): ${allowedTabs.join(', ')}`);
            
            allTabs.forEach(tab => {
                const tabId = tab.dataset.tabId;
                
                let isAllowed = allowedTabs.includes(tabId);
                
                // ğŸ†• v5.90.591: User Custom Override!
                if (userCustomTabs.hasOwnProperty(tabId)) {
                    isAllowed = userCustomTabs[tabId] === true;
                    console.log(`  ğŸ¨ v5.90.591: Custom fÃ¼r ${tabId}: ${isAllowed}`);
                }
                
                if (isAllowed) {
                    tab.style.display = '';
                    console.log(`  âœ… Tab erlaubt: ${tabId}`);
                } else {
                    tab.style.display = 'none';
                    console.log(`  ğŸ’¾ Tab verboten: ${tabId}`);
                }
            });
        }
        function fillTabPermissionCheckboxes(permissions) {
            const container = document.getElementById('tab-permissions-container');
            if (!container) return;
            
            const allTabIds = ['passenger', 'schedule', 'history', 'calendar', 'driver', 'admin', 'shift-plan', 'debug', 'ai-assistant', 'booking-requests', 'backup', 'poi-management', 'express-booking', 'simulator'];
            const roles = ['admin', 'driver', 'passenger'];
            
            let html = '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">';
            
            roles.forEach(role => {
                html += `
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                        <h3 style="margin-top: 0;">${role.toUpperCase()}</h3>
                `;
                
                allTabIds.forEach(tabId => {
                    const isChecked = permissions[role]?.includes(tabId) || false;
                    const label = tabId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    
                    html += `
                        <label style="display: block; margin: 8px 0; cursor: pointer;">
                            <input type="checkbox" 
                                   data-role="${role}" 
                                   data-tab="${tabId}"
                                   ${isChecked ? 'checked' : ''}
                                   onchange="updateTabPermission('${role}', '${tabId}', this.checked)">
                            ${label}
                        </label>
                    `;
                });
                
                html += '</div>';
            });
            
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // ğŸ†• v5.90.586: FILL USER TAB MANAGEMENT (PER-USER!)
        async function fillUserTabManagement() {
            const container = document.getElementById('tab-permissions-container');
            if (!container) return;
            
            const allTabIds = ['passenger', 'schedule', 'history', 'calendar', 'hotel-calendar', 'driver', 'admin', 'shift-plan', 'debug', 'ai-assistant', 'booking-requests', 'backup', 'poi-management', 'archive', 'express-booking', 'simulator', 'vehicle-overview'];
            
            // Lade aktuelle User Tabs
            const user = auth.currentUser;
            if (!user) {
                container.innerHTML = '<p style="color:#ef4444;">âš ï¸ Bitte einloggen</p>';
                return;
            }
            
            const userRef = db.ref(`users/${user.uid}/customTabs`);
            const snapshot = await userRef.once('value');
            const customTabs = snapshot.val() || {};
            
            console.log('ğŸ“‹ v5.90.586: Lade User Tabs:', customTabs);
            
            let html = `
                <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0; color: #1e40af;">ğŸ“± Meine Tabs</h3>
                    <p style="margin: 5px 0; color: #64748b; font-size: 13px;">
                        User: <strong>${user.email || user.phoneNumber}</strong><br>
                        âœ… Aktivierte Tabs werden in deiner Tab-Leiste angezeigt
                    </p>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
            `;
            
            allTabIds.forEach(tabId => {
                const isEnabled = customTabs[tabId] !== false; // Default: true
                const label = tabId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                
                const icons = {
                    'passenger': 'ğŸš•', 'schedule': 'ğŸ“…', 'history': 'ğŸ“œ', 'calendar': 'ğŸ“†',
                    'hotel-calendar': 'ğŸ¨', 'driver': 'ğŸš—', 'admin': 'âš™ï¸', 'shift-plan': 'ğŸ—“ï¸',
                    'debug': 'ğŸ›', 'ai-assistant': 'ğŸ¤–', 'booking-requests': 'ğŸ“‹', 'backup': 'ğŸ’¾',
                    'poi-management': 'â­', 'archive': 'ğŸ“¦', 'express-booking': 'âš¡',
                    'simulator': 'ğŸ®', 'vehicle-overview': 'ğŸš™'
                };
                const icon = icons[tabId] || 'ğŸ“Œ';
                
                html += `
                    <label style="display:flex;align-items:center;gap:10px;padding:12px;background:${isEnabled ? '#d1fae5' : '#f3f4f6'};border:2px solid ${isEnabled ? '#10b981' : '#e5e7eb'};border-radius:8px;cursor:pointer;">
                        <input type="checkbox" data-tab="${tabId}" ${isEnabled ? 'checked' : ''} onchange="updateUserTabPermission('${tabId}', this.checked)" style="width:18px;height:18px;">
                        <span style="font-size:18px;">${icon}</span>
                        <span style="font-weight:600;color:#1f2937;">${label}</span>
                    </label>
                `;
            });
            
            html += `</div>
                <div style="margin-top:20px;padding:15px;background:#fef3c7;border-radius:8px;">
                    <p style="margin:0;color:#92400e;font-weight:600;">ğŸ’¡ Nach Ã„nderung: <strong>F5 drÃ¼cken!</strong></p>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // ğŸ†• v5.90.586: UPDATE USER TAB PERMISSION!
        window.updateUserTabPermission = async function(tabId, isEnabled) {
            console.log(`ğŸ”„ v5.90.586: Update User Tab: ${tabId} = ${isEnabled}`);
            
            const user = auth.currentUser;
            if (!user) {
                alert('âš ï¸ Nicht eingeloggt!');
                return;
            }
            
            try {
                const userRef = db.ref(`users/${user.uid}/customTabs/${tabId}`);
                await userRef.set(isEnabled);
                
                console.log('âœ… v5.90.586: Tab-Einstellung gespeichert!');
                
                // Zeige Feedback
                const feedback = document.createElement('div');
                feedback.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: #10b981;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    z-index: 999999;
                    font-weight: 600;
                `;
                feedback.textContent = `âœ… ${tabId} ${isEnabled ? 'aktiviert' : 'deaktiviert'}!`;
                document.body.appendChild(feedback);
                
                setTimeout(() => feedback.remove(), 2000);
                
            } catch (error) {
                console.error('ğŸ’¾ v5.90.586: Fehler:', error);
                alert('âŒ Fehler beim Speichern!');
            }
        }
        
        // Update Tab-Berechtigung
        // Update Tab-Berechtigung (GLOBAL!)
        window.updateTabPermission = async function(role, tabId, isAllowed) {
            console.log(`ğŸ”„ Update: ${role} â†’ ${tabId} = ${isAllowed}`);
            
            try {
                // Lade aktuelle Berechtigungen
                const settingsRef = db.ref('settings/tabPermissions');
                const snapshot = await settingsRef.once('value');
                let permissions = snapshot.exists() ? snapshot.val() : getDefaultPermissions();
                
                // Update
                if (!permissions[role]) {
                    permissions[role] = [];
                }
                
                if (isAllowed) {
                    if (!permissions[role].includes(tabId)) {
                        permissions[role].push(tabId);
                    }
                } else {
                    permissions[role] = permissions[role].filter(t => t !== tabId);
                }
                
                // Speichere
                await settingsRef.set(permissions);
                console.log('âœ… Tab-Berechtigung gespeichert!');
                
                // Wende sofort an wenn es aktuelle Rolle betrifft
                const user = auth.currentUser;
                if (user) {
                    const userRef = db.ref(`users/${user.uid}`);
                    const userSnap = await userRef.once('value');
                    const userData = userSnap.val();
                    const currentRole = userData?.role || 'passenger';
                    
                    if (currentRole === role) {
                        await applyTabPermissions(permissions, currentRole);
                    }
                }
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Speichern:', error);
            }
        }
        
        // Lade Tab-Berechtigungen bei Login
        function initTabSettingsLoader() {
            if (!auth) {
                console.log('â³ Warte auf Firebase Auth...');
                setTimeout(initTabSettingsLoader, 500);
                return;
            }
            
            auth.onAuthStateChanged((user) => {
                if (user) {
                    setTimeout(() => loadTabSettings(), 1000);
                }
            });
            
            console.log('âœ… Tab-Settings Loader initialisiert');
        }
        
        // Starte nach 2 Sekunden (Firebase sollte dann bereit sein)
        setTimeout(initTabSettingsLoader, 2000);


        // ğŸ¯ GPS MONITORING - PrÃ¼ft alle 5 Sekunden ob GPS lÃ¤uft
        let gpsMonitoringInterval = null;
        let lastGPSUpdate = null;
        
        function startGPSMonitoring() {
            console.log('ğŸ‘€ GPS-Monitoring gestartet');
            
            if (gpsMonitoringInterval) {
                clearInterval(gpsMonitoringInterval);
            }
            
            gpsMonitoringInterval = setInterval(() => {
                const now = Date.now();
                const timeSinceLastUpdate = lastGPSUpdate ? (now - lastGPSUpdate) / 1000 : null;
                
                // Update UI
                updateGPSStatus(timeSinceLastUpdate);
                
                // Warnung wenn kein GPS seit 15 Sekunden
                if (timeSinceLastUpdate && timeSinceLastUpdate > 15) {
                    console.warn('âš ï¸ GPS VERLOREN! Keine Updates seit', Math.round(timeSinceLastUpdate), 'Sekunden');
                    
                    // ğŸ†• v5.90.546: Versuche GPS neu zu starten (auch wenn watchId null!)
                    if (currentVehicle && isOnline) {
                        console.log('ğŸ”„ GPS-Neustart (watchId:', watchId, ')');
                        
                        // Stop falls lÃ¤uft
                        if (watchId) {
                            navigator.geolocation.clearWatch(watchId);
                            watchId = null;
                        }
                        
                        // Neu starten nach 1 Sekunde
                        setTimeout(() => {
                            if (!watchId && currentVehicle && isOnline) {
                                console.log('ğŸ”„ Starte GPS neu...');
                                startGPSTracking();
                            }
                        }, 1000);
                    }
                }
            }, 5000); // Alle 5 Sekunden prÃ¼fen
        }
        
        function stopGPSMonitoring() {
            if (gpsMonitoringInterval) {
                clearInterval(gpsMonitoringInterval);
                gpsMonitoringInterval = null;
                console.log('â¹ï¸ GPS-Monitoring gestoppt');
            }
        }
        
        function updateGPSStatus(timeSinceLastUpdate) {
            const statusDiv = document.getElementById('gps-status-compact');
            const iconSpan = document.getElementById('gps-icon-compact');
            const textSpan = document.getElementById('gps-text-compact');
            
            if (!statusDiv) return;
            
            if (!timeSinceLastUpdate || timeSinceLastUpdate > 30) {
                // KEIN GPS oder sehr alt
                statusDiv.style.background = 'rgba(239,68,68,0.1)';
                statusDiv.style.color = '#ef4444';
                iconSpan.textContent = 'ğŸ’¾';
                textSpan.textContent = 'GPS';
            } else if (timeSinceLastUpdate < 5) {
                // GPS GUT (frisch!)
                statusDiv.style.background = 'rgba(16,185,129,0.1)';
                statusDiv.style.color = '#10b981';
                iconSpan.textContent = 'ğŸ“';
                textSpan.textContent = 'GPS';
            } else if (timeSinceLastUpdate < 15) {
                // GPS OK (etwas alt)
                statusDiv.style.background = 'rgba(245,158,11,0.1)';
                statusDiv.style.color = '#f59e0b';
                iconSpan.textContent = 'âš ï¸';
                textSpan.textContent = 'GPS';
            } else {
                // GPS SCHWACH
                statusDiv.style.background = 'rgba(239,68,68,0.1)';
                statusDiv.style.color = '#ef4444';
                iconSpan.textContent = 'âš ï¸';
                textSpan.textContent = 'GPS';
            }
        }
        
        // ğŸ†• v5.90.525: FAHRZEUG-SYNC STATUS PRÃœFEN!
        function updateVehicleSyncStatus() {
            const syncDiv = document.getElementById('vehicle-sync-status');
            const syncIcon = document.getElementById('sync-icon');
            const syncText = document.getElementById('sync-text');
            
            if (!syncDiv || !currentVehicle) return;
            
            // PrÃ¼fe ob Fahrzeug in Firebase existiert und aktuell ist
            db.ref(`drivers/${currentVehicle}`).once('value')
                .then(snapshot => {
                    const driverData = snapshot.val();
                    
                    if (!driverData) {
                        // Fahrzeug nicht in Firebase!
                        syncDiv.style.background = 'rgba(239,68,68,0.1)';
                        syncDiv.style.color = '#ef4444';
                        syncIcon.textContent = 'ğŸ’¾';
                        syncText.textContent = 'KEIN SYNC'; // â† KLARER!
                        syncDiv.title = 'Firebase Sync: Fahrzeug nicht gefunden';
                        console.warn('âš ï¸ Fahrzeug nicht in Firebase gefunden!');
                        return;
                    }
                    
                    const lastUpdate = driverData.lastUpdate || 0;
                    const now = Date.now();
                    const secondsSinceUpdate = Math.floor((now - lastUpdate) / 1000);
                    
                    if (secondsSinceUpdate < 30) {
                        // SYNC GUT!
                        syncDiv.style.background = 'rgba(16,185,129,0.1)';
                        syncDiv.style.color = '#10b981';
                        syncIcon.textContent = 'âœ…';
                        syncText.textContent = 'SYNC OK'; // â† KLARER!
                        syncDiv.title = 'Firebase Sync: Aktiv (vor ' + secondsSinceUpdate + 's)';
                    } else if (secondsSinceUpdate < 120) {
                        // SYNC OK aber alt
                        syncDiv.style.background = 'rgba(245,158,11,0.1)';
                        syncDiv.style.color = '#f59e0b';
                        syncIcon.textContent = 'âš ï¸';
                        syncText.textContent = secondsSinceUpdate + 's'; 
                        syncDiv.title = 'Firebase Sync: Veraltet (vor ' + secondsSinceUpdate + 's)';
                    } else {
                        // SYNC VERLOREN!
                        syncDiv.style.background = 'rgba(239,68,68,0.1)';
                        syncDiv.style.color = '#ef4444';
                        syncIcon.textContent = 'ğŸ’¾';
                        syncText.textContent = 'SYNC ALT'; // â† KLARER!
                        syncDiv.title = 'Firebase Sync: Veraltet (vor ' + secondsSinceUpdate + 's)';
                        console.warn('âš ï¸ Fahrzeug-Sync veraltet:', secondsSinceUpdate, 'Sekunden');
                    }
                })
                .catch(err => {
                    console.error('ğŸ’¾ Fehler bei Sync-Check:', err);
                    syncDiv.style.background = 'rgba(239,68,68,0.1)';
                    syncDiv.style.color = '#ef4444';
                    syncIcon.textContent = 'ğŸ’¾';
                    syncText.textContent = 'SYNC ERR'; // â† KLARER!
                    syncDiv.title = 'Firebase Sync: Fehler';
                });
        }
        
        // ğŸ†• v5.90.525: SYNC-CHECK ALLE 5 SEKUNDEN!
        setInterval(() => {
            if (currentView === 'driver' && currentVehicle) {
                updateVehicleSyncStatus();
            }
        }, 5000);

        // ğŸ†• v5.21.7: Debounce fÃ¼r updateViews (verhindert Flackern)
        let updateViewsTimeout = null;
        function updateViewsDebounced() {
            if (updateViewsTimeout) {
                clearTimeout(updateViewsTimeout);
            }
            updateViewsTimeout = setTimeout(() => {
                updateViews();
            }, 100); // 100ms warten
        }

        function updateViews() {
            // Update Debug Panel
            if (document.getElementById('debug-firebase')) {
                document.getElementById('debug-firebase').textContent = isFirebaseReady ? (isConnected ? 'âœ… Verbunden' : 'âš ï¸ Offline') : 'ğŸ’¾ Fehler';
                document.getElementById('debug-rides').textContent = rides.length;
                document.getElementById('debug-new').textContent = rides.filter(r => r.status === 'new').length;
                document.getElementById('debug-sync').textContent = new Date().toLocaleTimeString('de-DE');
            }
            
            if (currentView === 'driver') updateDriverView();
            else if (currentView === 'admin') updateAdminView();
            else if (currentView === 'history') updateHistoryView();
        }

        // ğŸ†• v5.90.268: NEUE FOKUSSIERTE DRIVER VIEW UPDATE!
        // ğŸ†• v5.90.295: UBER-STYLE UPDATE FUNKTION!
        // ğŸ†• v5.90.300: ISARFUNK-STYLE UPDATE!
        // ğŸ†• v5.90.311: USER-INFO UPDATE!
        // ğŸ†• v5.90.546: DEBOUNCE fÃ¼r updateDriverView (verhindert Endlos-Schleife!)
        let updateDriverViewTimeout = null;
        let lastUpdateDriverViewCall = 0;
        
        function updateDriverViewIsarfunk() {
            try {
                // ğŸ†• v5.90.546: DEBOUNCE - Max 1x pro 2 Sekunden!
                const now = Date.now();
                if (now - lastUpdateDriverViewCall < 2000) {
                    console.log('â­ï¸ Update Driver View GEDROSSELT (zu frÃ¼h)');
                    return;
                }
                lastUpdateDriverViewCall = now;
                
                console.log('ğŸ”§ v5.90.366: Update Driver View - START');
                
                // ğŸ†• v5.90.366: SAFETY FIRST - Check if view is even visible
                const driverView = document.getElementById('driver-view');
                if (!driverView || driverView.style.display === 'none') {
                    console.log('â­ï¸ Driver view not visible, skipping update');
                    return;
                }
                
                // ğŸ†• v5.90.366: UPDATE USER INFO WITH NULL CHECKS!
                try {
                    const userNameEl = document.getElementById('driver-user-name');
                    const userEmailEl = document.getElementById('driver-user-email');
                    const userRoleEl = document.getElementById('driver-user-role');
                    const currentVehicleEl = document.getElementById('driver-current-vehicle');
                    
                    if (currentUser) {
                        if (userNameEl) userNameEl.textContent = currentUser.displayName || currentUser.email || 'Unbekannt';
                        if (userEmailEl) userEmailEl.textContent = currentUser.email || '---';
                        if (userRoleEl) {
                            const role = currentUser.role || 'undefined';
                            userRoleEl.textContent = role;
                            if (role === 'admin') {
                                userRoleEl.style.background = 'rgba(34, 197, 94, 0.3)';
                                userRoleEl.style.color = '#fff';
                            } else if (role === 'driver') {
                                userRoleEl.style.background = 'rgba(59, 130, 246, 0.3)';
                                userRoleEl.style.color = '#fff';
                            } else {
                                userRoleEl.style.background = 'rgba(239, 68, 68, 0.3)';
                                userRoleEl.style.color = '#fff';
                            }
                        }
                    }
                    
                    if (currentVehicleEl) {
                        if (currentVehicle && VEHICLES && VEHICLES[currentVehicle]) {
                            const vehicle = VEHICLES[currentVehicle];
                            const vName = vehicle.name || 'Unbekannt';
                            const vPlate = vehicle.plate || 'N/A';
                            currentVehicleEl.textContent = `${vName} (${vPlate})`;
                        } else {
                            currentVehicleEl.textContent = 'Nicht gewÃ¤hlt';
                        }
                    }
                } catch (e) {
                    console.error('ğŸ’¾ Fehler bei User-Info Update:', e);
                }
                
                // ğŸ†• v5.90.366: Vehicle Selection with safe checks
                try {
                    const vehicleSelectEl = document.getElementById('driver-vehicle-select-isarfunk');
                    const driverMainEl = document.getElementById('driver-main-isarfunk');
                    
                    if (!currentVehicle) {
                        if (vehicleSelectEl) vehicleSelectEl.style.display = 'block';
                        if (driverMainEl) driverMainEl.style.display = 'none';
                        console.log('âœ… Showing vehicle selection');
                        return;
                    } else {
                        if (vehicleSelectEl) vehicleSelectEl.style.display = 'none';
                        if (driverMainEl) driverMainEl.style.display = 'block';
                        console.log('âœ… Showing driver main view');
                    }
                } catch (e) {
                    console.error('ğŸ’¾ Fehler bei Vehicle Selection:', e);
                }
                
                // ğŸ†• v5.90.366: GPS Status with complete safety
                try {
                    const gpsIcon = document.getElementById('driver-gps-icon');
                    const gpsText = document.getElementById('driver-gps-text');
                    
                    if (gpsIcon && gpsText) {
                        const now = Date.now();
                        const lastUpdate = localStorage.getItem('lastGpsUpdate');
                        const lastAccuracy = localStorage.getItem('lastGpsAccuracy');
                        const isStandby = !watchId && standbyIntervalId;
                        
                        if (lastUpdate) {
                            const secondsSinceUpdate = Math.floor((now - parseInt(lastUpdate)) / 1000);
                            const accuracy = lastAccuracy ? parseInt(lastAccuracy) : null;
                            
                            if (secondsSinceUpdate < 30) {
                                gpsIcon.textContent = 'ğŸŸ¢';
                                gpsText.textContent = accuracy ? `GPS ${accuracy}m` : 'GPS aktiv';
                                gpsText.style.color = '#10b981';
                            } else if (secondsSinceUpdate < 120 || isStandby) {
                                gpsIcon.textContent = 'ğŸŸ¡';
                                gpsText.textContent = accuracy ? `Standby ${accuracy}m` : 'GPS Standby';
                                gpsText.style.color = '#f59e0b';
                            } else {
                                gpsIcon.textContent = 'ğŸ”´';
                                gpsText.textContent = 'GPS verloren';
                                gpsText.style.color = '#ef4444';
                            }
                        } else {
                            gpsIcon.textContent = 'âšª';
                            gpsText.textContent = 'GPS aus';
                            gpsText.style.color = '#9ca3af';
                        }
                    }
                } catch (e) {
                    console.error('âŒ Fehler bei GPS Status:', e);
                }
                
                // ğŸ†• v5.90.578: STATUS-BOX - FREI oder BESETZT?
                try {
                    const statusBoxEl = document.getElementById('driver-status-box');
                    if (statusBoxEl) {
                        // PrÃ¼fe ALLE Fahrten (auch alte!) auf blockierende Status
                        const blockingRide = rides.find(r => 
                            r.vehicleId === currentVehicle && 
                            (r.status === 'assigned' || r.status === 'accepted' || 
                             r.status === 'picked_up' || r.status === 'on_way')
                        );
                        
                        if (blockingRide) {
                            // ğŸ”´ BESETZT
                            const pickupDate = blockingRide.pickupTime ? 
                                new Date(blockingRide.pickupTime).toLocaleDateString('de-DE', {day: '2-digit', month: '2-digit'}) : 
                                'Unbekannt';
                            const customerName = blockingRide.customerName || blockingRide.pickup || 'Unbekannt';
                            
                            statusBoxEl.innerHTML = `<div style="background:linear-gradient(135deg,#ef4444,#dc2626);color:white;padding:15px;border-radius:12px;box-shadow:0 4px 12px rgba(239,68,68,0.3);margin-bottom:15px;">
                                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                        <div style="font-size:24px;">ğŸ”´</div>
                                        <div style="font-weight:700;font-size:18px;">BESETZT</div>
                                    </div>
                                    <div style="font-size:14px;opacity:0.9;margin-bottom:12px;">
                                        Aktive Fahrt: <strong>${customerName}</strong> (${pickupDate})
                                    </div>
                                    <button onclick="quickCompleteBlockingRide('${blockingRide.id}')" 
                                            style="width:100%;padding:12px;background:white;color:#ef4444;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:15px;">
                                        ğŸ”„ Fahrt abschlieÃŸen
                                    </button>
                                </div>
                            `;
                        } else {
                            // ğŸŸ¢ FREI - ğŸ”§ FIX v5.90.627: Nur wenn GPS Toggle AN und Sync lÃ¤uft
                            if (isOnline) {
                                statusBoxEl.innerHTML = `<div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:15px;border-radius:12px;box-shadow:0 4px 12px rgba(16,185,129,0.3);margin-bottom:15px;">
                                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:5px;">
                                            <div style="font-size:24px;">ğŸŸ¢</div>
                                            <div style="font-weight:700;font-size:18px;">FREI</div>
                                        </div>
                                        <div style="font-size:14px;opacity:0.9;">
                                            Bereit fÃ¼r neue Buchungen
                                        </div>
                                    </div>
                                `;
                            } else {
                                // âšª OFFLINE - GPS Toggle AUS oder keine Sync
                                statusBoxEl.innerHTML = `<div style="background:linear-gradient(135deg,#6b7280,#4b5563);color:white;padding:15px;border-radius:12px;box-shadow:0 4px 12px rgba(107,114,128,0.3);margin-bottom:15px;">
                                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:5px;">
                                            <div style="font-size:24px;">âšª</div>
                                            <div style="font-weight:700;font-size:18px;">OFFLINE</div>
                                        </div>
                                        <div style="font-size:14px;opacity:0.9;">
                                            GPS Toggle einschalten & Online gehen
                                        </div>
                                    </div>
                                `;
                            }
                        }
                    }
                } catch (e) {
                    console.error('âŒ Fehler bei Status-Box:', e);
                }
                
                // ğŸ†• v5.90.366: Rides filtering with complete safety
                try {
                    if (!rides || !Array.isArray(rides)) {
                        console.warn('âš ï¸ Rides array not available');
                        return;
                    }
                    
                    const now = Date.now();
                    const fifteenMinutes = 15 * 60 * 1000;
                    
                    const myRides = rides.filter(r => {
                        if (!r || !r.vehicleId) return false;
                        if (r.vehicleId !== currentVehicle) return false;
                        
                        const pickupTime = r.pickupTimestamp || r.timestamp || 0;
                        const isInFuture = pickupTime > (now + fifteenMinutes);
                        
                        if (r.status === 'new' && isInFuture) {
                            return false;
                        }
                        
                        return true;
                    });
                    
                    const activeRide = myRides.find(r => 
                        r.status === 'accepted' || 
                        r.status === 'on_way' || 
                        r.status === 'picked_up'
                    );
                    
                    const currentOrderDiv = document.getElementById('driver-current-order-isarfunk');
                    const readyDiv = document.getElementById('driver-ready-isarfunk');
                    
                    if (activeRide && currentOrderDiv && readyDiv) {
                        currentOrderDiv.style.display = 'block';
                        readyDiv.style.display = 'none';
                        try {
                            currentOrderDiv.innerHTML = renderIsarfunkOrder(activeRide);
                        } catch (e) {
                            console.error('ğŸ’¾ Fehler beim Rendern der Order:', e);
                            currentOrderDiv.innerHTML = '<div style="padding:20px;text-align:center;color:#ef4444;">Fehler beim Laden</div>';
                        }
                        
                        try {
                            updateStatusButton(activeRide.status);
                        } catch (e) {
                            console.error('ğŸ’¾ Fehler bei Status Button:', e);
                        }
                    } else if (currentOrderDiv && readyDiv) {
                        currentOrderDiv.style.display = 'none';
                        readyDiv.style.display = 'block';
                        
                        try {
                            updateStatusButton('free');
                        } catch (e) {
                            console.error('ğŸ’¾ Fehler bei Status Button (free):', e);
                        }
                    }
                    
                    // ğŸ†• v5.90.366: Statistics with complete safety
                    try {
                        const today = new Date().toDateString();
                        const todayRides = myRides.filter(r => {
                            try {
                                const rideDate = new Date(r.pickupTimestamp || r.timestamp).toDateString();
                                return rideDate === today && r.status === 'completed';
                            } catch (e) {
                                return false;
                            }
                        });
                        
                        const totalMoney = todayRides.reduce((sum, r) => {
                            try {
                                return sum + (parseFloat(r.finalPrice || r.price) || 0);
                            } catch (e) {
                                return sum;
                            }
                        }, 0);
                        
                        const statsRidesEl = document.getElementById('stats-rides-isarfunk');
                        const statsMoneyEl = document.getElementById('stats-money-isarfunk');
                        
                        if (statsRidesEl) statsRidesEl.textContent = todayRides.length;
                        if (statsMoneyEl) statsMoneyEl.textContent = totalMoney.toFixed(0);
                    } catch (e) {
                        console.error('ğŸ’¾ Fehler bei Statistik:', e);
                    }
                    
                } catch (e) {
                    console.error('ğŸ’¾ Fehler bei Rides Filtering:', e);
                }
                
                console.log('âœ… v5.90.366: Update Driver View - COMPLETE');
                
            } catch (error) {
                console.error('ğŸ’¥ CRITICAL ERROR in updateDriverViewIsarfunk:', error);
                // Show error to user
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fee2e2;border:3px solid #dc2626;border-radius:12px;padding:20px;z-index:9999;max-width:80%;text-align:center;';
                errorDiv.innerHTML = `
                    <div style="font-size:48px;margin-bottom:12px;">âš ï¸</div>
                    <div style="font-size:18px;font-weight:700;color:#991b1b;margin-bottom:8px;">Fehler beim Laden</div>
                    <div style="font-size:14px;color:#7f1d1d;margin-bottom:16px;">Der Fahrer-View konnte nicht geladen werden</div>
                    <button onclick="this.parentElement.remove();switchView('admin')" style="background:#dc2626;color:white;border:none;padding:12px 24px;border-radius:8px;font-weight:700;cursor:pointer;">ZurÃ¼ck zu Admin</button>
                `;
                document.body.appendChild(errorDiv);
            }
        }
        
        // ğŸ†• v5.90.366: Render Auftrag WITH ERROR HANDLING
        function renderIsarfunkOrder(ride) {
            try {
                if (!ride) {
                    console.error('ğŸ’¾ renderIsarfunkOrder: Keine Fahrt Ã¼bergeben!');
                    return '<div style="padding:20px;text-align:center;color:#ef4444;">Keine Fahrtdaten</div>';
                }
                
                const pickup = ride.pickup || 'Unbekannt';
                const destination = ride.destination || 'Unbekannt';
                
                let time = '??:??';
                try {
                    time = new Date(ride.pickupTimestamp || ride.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                } catch (e) {
                    console.error('ğŸ’¾ Fehler bei Zeit-Formatierung:', e);
                }
                
                const price = ride.finalPrice || ride.price || '?';
                const customerName = ride.customerName || ride.guestName || 'Kunde';
                const customerPhone = ride.customerPhone || ride.guestPhone || '';
                const distance = ride.distance || '?';
                
                return `
                    <div style="
                        background: white;
                        border: 3px solid #10b981;
                        border-radius: 12px;
                        padding: 16px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="font-size: 16px; font-weight: 900; color: #10b981;">ğŸš– AKTIVER AUFTRAG</div>
                            <div style="font-size: 14px; font-weight: 700; color: #1f2937;">${time} Uhr</div>
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <div style="font-size: 18px; font-weight: 900; color: #1f2937; margin-bottom: 8px;">${customerName}</div>
                            ${customerPhone ? `
                                <a href="tel:${customerPhone}" style="
                                    display: inline-block;
                                    color: white;
                                    background: #10b981;
                                    text-decoration: none;
                                    font-size: 14px;
                                    font-weight: 700;
                                    padding: 8px 16px;
                                    border-radius: 8px;
                                ">ğŸ’¾ ${customerPhone}</a>
                            ` : ''}
                        </div>
                        
                        <div style="background: #f9fafb; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                            <div style="margin-bottom: 8px;">
                                <div style="font-size: 10px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">ABHOLUNG</div>
                                <div style="font-size: 14px; font-weight: 700; color: #1f2937;">ğŸ“ ${pickup}</div>
                            </div>
                            <div style="text-align: center; margin: 8px 0;">
                                <div style="font-size: 16px; color: #10b981;">â†“</div>
                            </div>
                            <div>
                                <div style="font-size: 10px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">ZIEL</div>
                                <div style="font-size: 14px; font-weight: 700; color: #1f2937;">ğŸ¯ ${destination}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 8px;">
                            <div style="flex: 1; text-align: center; background: #f9fafb; padding: 10px; border-radius: 8px;">
                                <div style="font-size: 18px; font-weight: 900; color: #10b981;">${price}â‚¬</div>
                                <div style="font-size: 9px; color: #6b7280; margin-top: 2px;">PREIS</div>
                            </div>
                            <div style="flex: 1; text-align: center; background: #f9fafb; padding: 10px; border-radius: 8px;">
                                <div style="font-size: 18px; font-weight: 900; color: #3b82f6;">${distance} km</div>
                                <div style="font-size: 9px; color: #6b7280; margin-top: 2px;">DISTANZ</div>
                            </div>
                    </div>
                </div>
            `;
            } catch (error) {
                console.error('ğŸ’¥ CRITICAL ERROR in renderIsarfunkOrder:', error);
                return '<div style="padding:20px;text-align:center;color:#ef4444;"><div style="font-size:48px;">âš ï¸</div><div style="font-weight:700;margin-top:8px;">Fehler beim Laden der Fahrt</div></div>';
            }
        }
        
        // Update Status-Button
        function updateStatusButton(status) {
            const btn = document.getElementById('status-button-isarfunk');
            const txt = document.getElementById('status-text-isarfunk');
            
            if (!btn || !txt) return;
            
            switch(status) {
                case 'free':
                    btn.style.background = '#10b981';
                    txt.textContent = 'FREI';
                    break;
                case 'accepted':
                    btn.style.background = '#f59e0b';
                    txt.textContent = 'LOSFAHREN';
                    break;
                case 'on_way':
                    btn.style.background = '#ef4444';
                    txt.textContent = 'EINGESTIEGEN';
                    break;
                case 'picked_up':
                    btn.style.background = '#3b82f6';
                    txt.textContent = 'ABSCHLIESSEN';
                    break;
            }
        }
        
        // ğŸ†• v5.90.366: Cycle Status WITH ERROR HANDLING
        function cycleStatusIsarfunk() {
            try {
                if (!rides || !Array.isArray(rides)) {
                    alert('âš ï¸ Fehler: Fahrten nicht verfÃ¼gbar');
                    return;
                }
                
                if (!currentVehicle) {
                    alert('âš ï¸ Kein Fahrzeug ausgewÃ¤hlt!');
                    return;
                }
                
                const myRides = rides.filter(r => r && r.vehicleId === currentVehicle);
                const activeRide = myRides.find(r => 
                    r.status === 'accepted' || 
                    r.status === 'on_way' || 
                    r.status === 'picked_up'
                );
                
                if (!activeRide) {
                    alert('â„¹ï¸ Keine aktive Fahrt!');
                    return;
                }
                
                const rideId = activeRide.firebaseId || activeRide.id;
                if (!rideId) {
                    alert('ğŸ’¾ Fehler: Fahrt-ID nicht gefunden!');
                    return;
                }
                
                if (activeRide.status === 'accepted') {
                    startDriving(rideId);
                } else if (activeRide.status === 'on_way') {
                    pickupCustomer(rideId);
                } else if (activeRide.status === 'picked_up') {
                    completeRide(rideId);
                }
            } catch (error) {
                console.error('ğŸ’¥ ERROR in cycleStatusIsarfunk:', error);
                alert('ğŸ’¾ Fehler beim Status-Wechsel!');
            }
        }
        
        function updateDriverViewV295() {
            if (!currentVehicle) {
                // Zeige Fahrzeug-Auswahl Modal
                const modal = document.getElementById('driver-vehicle-selector-new');
                if (modal) modal.style.display = 'flex'; // ğŸ†• v5.90.299: flex statt block!
                document.getElementById('driver-go-button').disabled = true;
                document.getElementById('driver-go-button').style.opacity = '0.5';
                return;
            } else {
                const modal = document.getElementById('driver-vehicle-selector-new');
                if (modal) modal.style.display = 'none';
                document.getElementById('driver-go-button').disabled = false;
                document.getElementById('driver-go-button').style.opacity = '1';
            }
            
            // Meine Fahrten filtern (nur fÃ¼r dieses Fahrzeug)
            const myRides = rides.filter(r => r.vehicleId === currentVehicle);
            
            // ğŸ¯ AKTIVE FAHRT (on_way oder picked_up) - NUR JETZT!
            const activeRide = myRides.find(r => 
                r.status === 'on_way' || r.status === 'picked_up'
            );
            
            // Zeige aktive Fahrt Card
            const activeCard = document.getElementById('driver-active-ride-card-new');
            if (activeRide) {
                activeCard.style.display = 'block';
                activeCard.innerHTML = renderActiveRideCardNew(activeRide);
            } else {
                activeCard.style.display = 'none';
            }
            
            // ğŸ“± STATISTIK
            const today = new Date().toDateString();
            const todayRides = myRides.filter(r => {
                const rideDate = new Date(r.pickupTimestamp || r.timestamp).toDateString();
                return rideDate === today && r.status === 'completed';
            });
            
            const totalMoney = todayRides.reduce((sum, r) => sum + (parseFloat(r.finalPrice || r.price) || 0), 0);
            
            document.getElementById('driver-stats-rides').textContent = todayRides.length;
            document.getElementById('driver-stats-money').textContent = totalMoney.toFixed(0);
            
            // GPS Status
            const gpsIcon = document.getElementById('driver-stats-gps-icon');
            const gpsText = document.getElementById('driver-stats-gps-text');
            if (watchId) {
                gpsIcon.textContent = 'âœ…';
                gpsText.textContent = 'GPS AN';
                gpsText.style.color = '#10b981';
            } else {
                gpsIcon.textContent = 'ğŸ’¾';
                gpsText.textContent = 'GPS AUS';
                gpsText.style.color = '#6b7280';
            }
            
            // ğŸ†• v5.90.578: Update Status-Indikator!
            updateDriverStatusIndicator();
        }
        
        // ğŸ†• v5.90.578: STATUS-INDIKATOR FÃœR FAHRER!
        function updateDriverStatusIndicator() {
            if (!currentVehicle) return;
            
            const indicator = document.getElementById('driver-status-indicator');
            if (!indicator) return;
            
            // Suche ALLE aktiven Fahrten (auch alte!) die das Fahrzeug blockieren
            const blockingRide = rides.find(r => 
                r.vehicleId === currentVehicle && 
                (r.status === 'assigned' || r.status === 'accepted' || r.status === 'on_way' || r.status === 'picked_up')
            );
            
            if (blockingRide) {
                // ğŸ”´ BESETZT!
                const customerName = blockingRide.customerName || blockingRide.guestName || 'Unbekannt';
                const pickupDate = new Date(blockingRide.pickupTimestamp || blockingRide.timestamp);
                const dateStr = pickupDate.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
                const timeStr = pickupDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                
                const isOld = pickupDate.toDateString() !== new Date().toDateString();
                
                indicator.style.display = 'block';
                indicator.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                indicator.style.color = 'white';
                indicator.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <div style="font-size: 32px;">ğŸ”´</div>
                        <div style="flex: 1;">
                            <div style="font-size: 18px; font-weight: 700; margin-bottom: 4px;">
                                BESETZT
                            </div>
                            <div style="font-size: 13px; opacity: 0.9;">
                                Du hast eine aktive Fahrt
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                        <div style="font-size: 15px; font-weight: 600; margin-bottom: 8px;">
                            ğŸ“ ${customerName}
                        </div>
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 4px;">
                            ğŸ“… ${dateStr} â€¢ â° ${timeStr}
                        </div>
                        ${isOld ? `
                            <div style="font-size: 12px; background: rgba(251,191,36,0.3); color: #fbbf24; padding: 6px 10px; border-radius: 6px; margin-top: 8px; font-weight: 600;">
                                âš ï¸ Alte Fahrt (von gestern/frÃ¼her)
                            </div>
                        ` : ''}
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">
                            Status: ${blockingRide.status}
                        </div>
                    </div>
                    
                    <button onclick="completeBlockingRide('${blockingRide.id}')" style="
                        width: 100%;
                        background: white;
                        color: #dc2626;
                        border: none;
                        padding: 14px;
                        border-radius: 8px;
                        font-size: 15px;
                        font-weight: 700;
                        cursor: pointer;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                    ">
                        âœ… Fahrt abschlieÃŸen & freigeben
                    </button>
                `;
                
            } else {
                // ğŸŸ¢ FREI - ğŸ”§ FIX v5.90.627: Nur wenn GPS Toggle AN und Sync lÃ¤uft
                if (isOnline) {
                    indicator.style.display = 'block';
                    indicator.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                    indicator.style.color = 'white';
                    indicator.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 32px;">ğŸŸ¢</div>
                            <div style="flex: 1;">
                                <div style="font-size: 18px; font-weight: 700; margin-bottom: 4px;">
                                    FREI
                                </div>
                                <div style="font-size: 13px; opacity: 0.9;">
                                    Bereit fÃ¼r neue Buchungen
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // âšª OFFLINE
                    indicator.style.display = 'block';
                    indicator.style.background = 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)';
                    indicator.style.color = 'white';
                    indicator.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 32px;">âšª</div>
                            <div style="flex: 1;">
                                <div style="font-size: 18px; font-weight: 700; margin-bottom: 4px;">
                                    OFFLINE
                                </div>
                                <div style="font-size: 13px; opacity: 0.9;">
                                    GPS Toggle einschalten & Online gehen
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        // ğŸ†• v5.90.578: Blockierende Fahrt abschlieÃŸen!
        async function completeBlockingRide(rideId) {
            if (!confirm('MÃ¶chtest du diese Fahrt wirklich abschlieÃŸen?')) return;
            
            try {
                await db.ref(`rides/${rideId}`).update({
                    status: 'completed',
                    completedAt: Date.now(),
                    completedBy: currentUser.email
                });
                
                alert('âœ… Fahrt abgeschlossen! Du bist jetzt frei.');
                
                // Update View
                updateDriverViewV295();
                
            } catch (error) {
                console.error('âŒ Fehler beim AbschlieÃŸen:', error);
                alert('âŒ Fehler: ' + error.message);
            }
        }
        
        // Render Active Ride Card (NEU)
        function renderActiveRideCardNew(ride) {
            const customerName = ride.customerName || ride.guestName || 'Kunde';
            const customerPhone = ride.customerPhone || ride.guestPhone || '';
            const pickup = ride.pickup || 'Unbekannt';
            const destination = ride.destination || 'Unbekannt';
            const time = new Date(ride.pickupTimestamp || ride.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            const price = ride.finalPrice || ride.price || '?';
            const distance = ride.distance || '?';
            
            const navUrl = `https://www.google.com/maps/dir/${encodeURIComponent(pickup)}/${encodeURIComponent(destination)}`;
            
            let actionButton = '';
            if (ride.status === 'on_way') {
                actionButton = `
                    <button onclick="pickupCustomer('${ride.firebaseId || ride.id}')" style="
                        width: 100%;
                        padding: 18px;
                        background: linear-gradient(135deg, #10b981, #059669);
                        color: white;
                        border: none;
                        border-radius: 12px;
                        font-size: 18px;
                        font-weight: 900;
                        cursor: pointer;
                        margin-top: 16px;
                    ">ğŸ’¾ KUNDE ABGEHOLT</button>
                `;
            } else if (ride.status === 'picked_up') {
                actionButton = `
                    <button onclick="completeRide('${ride.firebaseId || ride.id}')" style="
                        width: 100%;
                        padding: 18px;
                        background: linear-gradient(135deg, #3b82f6, #2563eb);
                        color: white;
                        border: none;
                        border-radius: 12px;
                        font-size: 18px;
                        font-weight: 900;
                        cursor: pointer;
                        margin-top: 16px;
                    ">âœ“ FAHRT ABSCHLIESSEN</button>
                `;
            }
            
            return `
                <div style="text-align: center; margin-bottom: 16px;">
                    <div style="font-size: 28px; font-weight: 900; color: #1f2937;">
                        ${customerName}
                    </div>
                    ${customerPhone ? `
                        <a href="tel:${customerPhone}" style="
                            display: inline-block;
                            color: white;
                            background: #10b981;
                            text-decoration: none;
                            font-size: 16px;
                            font-weight: 700;
                            padding: 12px 24px;
                            border-radius: 12px;
                            margin-top: 8px;
                        ">ğŸ’¾ ${customerPhone}</a>
                    ` : ''}
                </div>
                
                <div style="background: #f9fafb; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">ABHOLUNG</div>
                        <div style="font-size: 15px; font-weight: 700; color: #1f2937;">ğŸ“ ${pickup}</div>
                    </div>
                    <div style="text-align: center; margin: 12px 0;">
                        <div style="font-size: 20px;">â†“</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">ZIEL</div>
                        <div style="font-size: 15px; font-weight: 700; color: #1f2937;">ğŸ¯ ${destination}</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <div style="flex: 1; text-align: center; background: #f9fafb; padding: 12px; border-radius: 8px;">
                        <div style="font-size: 20px; font-weight: 900; color: #10b981;">${price}â‚¬</div>
                        <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">PREIS</div>
                    </div>
                    <div style="flex: 1; text-align: center; background: #f9fafb; padding: 12px; border-radius: 8px;">
                        <div style="font-size: 20px; font-weight: 900; color: #3b82f6;">${distance} km</div>
                        <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">DISTANZ</div>
                    </div>
                </div>
                
                <a href="${navUrl}" target="_blank" style="
                    display: block;
                    width: 100%;
                    padding: 18px;
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    color: white;
                    border: none;
                    border-radius: 12px;
                    font-size: 18px;
                    font-weight: 900;
                    text-align: center;
                    text-decoration: none;
                ">ğŸ—ºï¸ NAVIGATION STARTEN</a>
                
                ${actionButton}
            `;
        }
        
        // Toggle Online/Offline (NEU)
        function toggleOnlineNew() {
            const button = document.getElementById('driver-go-button');
            const text = document.getElementById('go-button-text');
            
            if (!watchId) {
                // GO ONLINE
                startGPSTracking();
                button.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                text.textContent = 'â¸ï¸ OFFLINE GEHEN';
            } else {
                // GO OFFLINE
                stopDriverTracking();
                button.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                text.textContent = 'ğŸš— GO';
            }
        }
        
        // Select Vehicle Button (NEU)
        function selectVehicleButtonNew(vehicleId) {
            console.log('ğŸš— Fahrzeug gewÃ¤hlt:', vehicleId);
            
            // Setze hidden select
            const select = document.getElementById('vehicle');
            if (select) {
                select.value = vehicleId;
            }
            
            // Rufe alte setVehicle auf
            setVehicle();
            
            // Update View
            updateDriverViewV295();
        }
        
        
        // ğŸ†• v5.90.491: ZEIGE AKTUELLE FAHRTEN DIREKT AUF BILDSCHIRM!
        function updateCurrentRidesDisplay(rides) {
            const container = document.getElementById('current-rides-display');
            if (!container) return;
            
            // Filter: Nur ASSIGNED Fahrten (die noch nicht angenommen wurden)
            const assignedRides = rides.filter(r => r.status === 'assigned');
            
            if (assignedRides.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            // Zeige Container
            container.style.display = 'block';
            
            // Erstelle HTML fÃ¼r jede Fahrt
            let html = '';
            assignedRides.forEach(ride => {
                const now = Date.now();
                const pickupTime = ride.pickupTimestamp || ride.createdAt;
                const minutesUntil = pickupTime ? Math.round((pickupTime - now) / 60000) : 0;
                const timeStr = pickupTime ? new Date(pickupTime).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) : 'Sofort';
                
                let timeDisplay = '';
                if (minutesUntil > 0) {
                    if (minutesUntil < 60) {
                        timeDisplay = `in ${minutesUntil} Min`;
                    } else {
                        const hours = Math.floor(minutesUntil / 60);
                        const mins = minutesUntil % 60;
                        timeDisplay = `in ${hours}h ${mins}m`;
                    }
                } else if (minutesUntil < 0) {
                    timeDisplay = `âš ï¸ vor ${Math.abs(minutesUntil)} Min!`;
                } else {
                    timeDisplay = 'JETZT!';
                }
                
                html += `
                    <div style="
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        color: white;
                        padding: 20px;
                        border-radius: 12px;
                        margin-bottom: 10px;
                        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
                        animation: slideDown 0.3s ease-out;
                    ">
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">
                            ğŸ†• NEUE FAHRT!
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-size: 20px; font-weight: 700; margin-bottom: 8px;">
                                ğŸ’¾ ${ride.customerName || 'Unbekannt'}
                            </div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px; opacity: 0.95;">
                                â° ${timeStr} ${timeDisplay}
                            </div>
                            <div style="font-size: 14px; line-height: 1.6; opacity: 0.9;">
                                <div style="margin-bottom: 4px;">ğŸ“ <strong>Von:</strong> ${ride.pickup || 'Unbekannt'}</div>
                                <div>ğŸ¯ <strong>Nach:</strong> ${ride.destination || 'Unbekannt'}</div>
                            </div>
                            ${ride.price ? `<div style="font-size: 16px; font-weight: 700; margin-top: 10px;">ğŸ’° ${ride.price}â‚¬</div>` : ''}
                            ${ride.customerPhone ? `<div style="font-size: 14px; margin-top: 8px; opacity: 0.9;">ğŸ’¾ ${ride.customerPhone}</div>` : ''}
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button onclick="acceptRide('${ride.firebaseId || ride.id}')" style="
                                padding: 16px;
                                background: white;
                                color: #10b981;
                                border: none;
                                border-radius: 8px;
                                font-size: 16px;
                                font-weight: 700;
                                cursor: pointer;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                            ">
                                âœ… ANNEHMEN
                            </button>
                            <button onclick="declineRide('${ride.firebaseId || ride.id}')" style="
                                padding: 16px;
                                background: rgba(255,255,255,0.2);
                                color: white;
                                border: 2px solid white;
                                border-radius: 8px;
                                font-size: 16px;
                                font-weight: 700;
                                cursor: pointer;
                            ">
                                ğŸš« ABLEHNEN
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ğŸ†• v5.90.491: Fahrt ablehnen
        function declineRide(rideId) {
            if (!confirm('Fahrt wirklich ablehnen?')) return;
            
            // Setze Status zurÃ¼ck auf 'new' und entferne vehicleId
            updateRide(rideId, {
                status: 'new',
                vehicleId: null,
                vehicle: null,
                vehiclePlate: null
            });
            
            alert('âœ… Fahrt abgelehnt und zurÃ¼ck in den Pool!');
        }
        
        // Animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideDown {
                from {
                    transform: translateY(-20px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
        
        function updateDriverViewV268() {
            if (!currentVehicle) {
                // Kein Fahrzeug gewÃ¤hlt
                document.getElementById('driver-active-ride-section').style.display = 'none';
                document.getElementById('driver-assigned-rides-section').style.display = 'none';
                document.getElementById('driver-accepted-rides-section').style.display = 'none';
                return;
            }
            
            // Meine Fahrten filtern
            const myRides = rides.filter(r => r.vehicleId === currentVehicle);
            
            // Aktive Fahrt (on_way oder picked_up) - NICHT accepted!
            const now = Date.now();
            const activeRide = myRides.find(r => {
                // ğŸ†• v5.90.289: Nur on_way (unterwegs zum Kunden) oder picked_up (Gast an Bord)
                return r.status === 'on_way' || r.status === 'picked_up';
            });
            
            // Zugewiesene Fahrten (assigned) - Nur zeigen wenn noch nicht angenommen UND nicht aktiv!
            const assignedRides = myRides.filter(r => {
                if (r.status !== 'assigned') return false;
                // Nicht zeigen wenn schon als aktive Fahrt angezeigt
                if (activeRide && (activeRide.firebaseId === r.firebaseId || activeRide.id === r.id)) return false;
                return true;
            });
            
            // ğŸ†• v5.90.289: AKZEPTIERTE FAHRTEN (accepted, aber noch nicht losgefahren!)
            const acceptedRides = myRides.filter(r => {
                if (r.status !== 'accepted') return false;
                // Nicht zeigen wenn schon als aktive Fahrt angezeigt
                if (activeRide && (activeRide.firebaseId === r.firebaseId || activeRide.id === r.id)) return false;
                return true;
            }).sort((a, b) => (a.pickupTimestamp || a.timestamp) - (b.pickupTimestamp || b.timestamp));
            
            // Geplante Fahrten (heute, spÃ¤ter) - AUCH accepted Fahrten die weit weg sind!
            const today = new Date().toDateString();
            const oneHourFromNow = now + (60 * 60 * 1000);
            const scheduledRides = myRides.filter(r => {
                if (r.status === 'completed' || r.status === 'cancelled') return false;
                
                // Nicht zeigen wenn gerade als AKTIVE FAHRT angezeigt
                if (activeRide && (activeRide.firebaseId === r.firebaseId || activeRide.id === r.id)) return false;
                
                // Zeige: assigned ODER accepted/picked_up die mehr als 1h in Zukunft sind
                const rideTime = r.pickupTimestamp || r.timestamp || now;
                const rideDate = new Date(rideTime).toDateString();
                
                if (rideDate !== today) return false; // Nur heute
                
                // Zeige wenn: assigned ODER (accepted aber weit weg)
                if (r.status === 'assigned') return true;
                if ((r.status === 'accepted' || r.status === 'picked_up') && rideTime > oneHourFromNow) return true;
                
                return false;
            }).sort((a, b) => (a.pickupTimestamp || a.timestamp) - (b.pickupTimestamp || b.timestamp));
            
            // â”â”â” AKTIVE FAHRT â”â”â”
            const activeSection = document.getElementById('driver-active-ride-section');
            const activeCard = document.getElementById('driver-active-ride-card');
            
            if (activeRide) {
                activeSection.style.display = 'block';
                activeCard.innerHTML = renderActiveRideCard(activeRide);
            } else {
                activeSection.style.display = 'none';
            }
            
            // â”â”â” ZUGEWIESENE FAHRTEN (ASSIGNED) â”â”â”
            const assignedSection = document.getElementById('driver-assigned-rides-section');
            const assignedList = document.getElementById('driver-assigned-rides-list');
            const assignedBadge = document.getElementById('assigned-rides-badge');
            
            if (assignedRides.length > 0) {
                assignedSection.style.display = 'block';
                assignedBadge.textContent = assignedRides.length;
                assignedList.innerHTML = assignedRides.map(r => renderNewRideCard(r)).join('');
            } else {
                assignedSection.style.display = 'none';
            }
            
            // â”â”â” AKZEPTIERTE FAHRTEN â”â”â”
            const acceptedSection = document.getElementById('driver-accepted-rides-section');
            const acceptedList = document.getElementById('driver-accepted-rides-list');
            const acceptedBadge = document.getElementById('accepted-rides-badge');
            
            if (acceptedRides.length > 0) {
                acceptedSection.style.display = 'block';
                acceptedBadge.textContent = acceptedRides.length;
                acceptedList.innerHTML = acceptedRides.map(r => renderAcceptedRideCard(r)).join('');
            } else {
                acceptedSection.style.display = 'none';
            }
            
            // â”â”â” TAGESPROGRAMM â”â”â”
            const scheduleList = document.getElementById('driver-schedule-list');
            const scheduleBadge = document.getElementById('schedule-badge');
            
            scheduleBadge.textContent = scheduledRides.length;
            
            if (scheduledRides.length > 0) {
                scheduleList.innerHTML = scheduledRides.map(r => {
                    const time = new Date(r.pickupTimestamp || r.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    const price = r.finalPrice || r.price || '?';
                    return `
                        <div style="padding: 8px 0; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span style="font-weight: 600; color: #1f2937;">${time}</span>
                                <span style="color: #6b7280; font-size: 13px; margin-left: 8px;">${r.pickup || '?'} â†’ ${r.destination || '?'}</span>
                            </div>
                            <span style="font-weight: 600; color: #10b981;">${price}â‚¬</span>
                        </div>
                    `;
                }).join('');
            } else {
                scheduleList.innerHTML = '<div style="text-align: center; color: #9ca3af; font-size: 13px; padding: 20px;">Keine weiteren Fahrten heute</div>';
            }
        }
        
        // Render Active Ride Card
        function renderActiveRideCard(ride) {
            const customerName = ride.customerName || ride.guestName || 'Kunde';
            const customerPhone = ride.customerPhone || ride.guestPhone || '';
            const pickup = ride.pickup || 'Unbekannt';
            const destination = ride.destination || 'Unbekannt';
            const time = new Date(ride.pickupTimestamp || ride.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            const price = ride.finalPrice || ride.price || '?';
            const distance = ride.distance || '?';
            const duration = ride.duration || '?';
            
            const navUrl = `https://www.google.com/maps/dir/${encodeURIComponent(pickup)}/${encodeURIComponent(destination)}`;
            
            return `
                <div style="text-align: center; margin-bottom: 16px;">
                    <div style="font-size: 24px; font-weight: 700; color: #1f2937; margin-bottom: 4px;">
                        ğŸ’¾ ${customerName}
                    </div>
                    ${customerPhone ? `
                        <a href="tel:${customerPhone}" style="
                            display: inline-block;
                            color: #3b82f6;
                            text-decoration: none;
                            font-size: 14px;
                            font-weight: 600;
                            padding: 6px 12px;
                            background: #eff6ff;
                            border-radius: 8px;
                            margin-top: 4px;
                        ">
                            ğŸ’¾ ${customerPhone}
                        </a>
                    ` : ''}
                </div>
                
                <div style="
                    background: #f9fafb;
                    border-radius: 12px;
                    padding: 16px;
                    margin-bottom: 16px;
                ">
                    <div style="display: flex; align-items: center; margin-bottom: 12px;">
                        <div style="font-size: 20px; margin-right: 12px;">ğŸ“</div>
                        <div style="flex: 1;">
                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 2px;">Von</div>
                            <div style="font-size: 14px; font-weight: 600; color: #1f2937;">${pickup}</div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin: 8px 0;">
                        <div style="display: inline-block; background: #10b981; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                            â†“ ${distance} km â€¢ ${duration} Min
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center;">
                        <div style="font-size: 20px; margin-right: 12px;">ğŸ¯</div>
                        <div style="flex: 1;">
                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 2px;">Nach</div>
                            <div style="font-size: 14px; font-weight: 600; color: #1f2937;">${destination}</div>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: space-between; margin-bottom: 16px; padding: 12px; background: #fffbeb; border-radius: 12px;">
                    <div style="text-align: center; flex: 1;">
                        <div style="font-size: 11px; color: #92400e;">Abholzeit</div>
                        <div style="font-size: 16px; font-weight: 700; color: #78350f;">â° ${time}</div>
                    </div>
                    <div style="text-align: center; flex: 1; border-left: 2px solid #fde68a;">
                        <div style="font-size: 11px; color: #065f46;">Preis</div>
                        <div style="font-size: 16px; font-weight: 700; color: #048257;">ğŸ’° ${price}â‚¬</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <a href="${navUrl}" target="_blank" style="
                        display: block;
                        padding: 16px;
                        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                        color: white;
                        text-align: center;
                        border-radius: 12px;
                        font-weight: 700;
                        font-size: 15px;
                        text-decoration: none;
                        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                    ">
                        ğŸ—ºï¸ Navigation
                    </a>
                    
                    <button onclick="completeRide('${ride.firebaseId || ride.id}')" style="
                        padding: 16px;
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        color: white;
                        border: none;
                        border-radius: 12px;
                        font-weight: 700;
                        font-size: 15px;
                        cursor: pointer;
                        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                    ">
                        âœ… Fertig
                    </button>
                </div>
            `;
        }
        
        // Render New Ride Card
        function renderNewRideCard(ride) {
            const pickup = ride.pickup || 'Unbekannt';
            const destination = ride.destination || 'Unbekannt';
            const time = new Date(ride.pickupTimestamp || ride.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            const price = ride.finalPrice || ride.price || '?';
            const distance = ride.distance || '?';
            const duration = ride.duration || '?';
            
            return `
                <div style="
                    background: white;
                    border: 2px solid #fbbf24;
                    border-radius: 12px;
                    padding: 16px;
                    margin-bottom: 12px;
                    box-shadow: 0 2px 8px rgba(251, 191, 36, 0.2);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div style="
                            background: #fef3c7;
                            color: #92400e;
                            padding: 6px 12px;
                            border-radius: 8px;
                            font-size: 13px;
                            font-weight: 700;
                        ">
                            ğŸŸ¡ ${time}
                        </div>
                        <div style="font-size: 16px; font-weight: 700; color: #10b981;">
                            ${price}â‚¬
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 13px; color: #6b7280; margin-bottom: 4px;">ğŸ“ ${pickup}</div>
                        <div style="text-align: center; color: #9ca3af; margin: 4px 0;">â†“</div>
                        <div style="font-size: 13px; color: #6b7280;">ğŸ¯ ${destination}</div>
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 12px; font-size: 12px; color: #6b7280;">
                        ğŸ“ ${distance} km â€¢ â±ï¸ ${duration} Min
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 8px;">
                        <button onclick="acceptRide('${ride.firebaseId || ride.id}')" style="
                            padding: 12px;
                            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-weight: 700;
                            font-size: 14px;
                            cursor: pointer;
                        ">
                            âœ… ANNEHMEN
                        </button>
                        <button onclick="rejectRide('${ride.firebaseId || ride.id}')" style="
                            padding: 12px;
                            background: #f3f4f6;
                            color: #6b7280;
                            border: none;
                            border-radius: 8px;
                            font-weight: 700;
                            font-size: 14px;
                            cursor: pointer;
                        ">
                            ğŸ’¾
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ğŸ†• v5.90.270: AKZEPTIERTE FAHRTEN (noch nicht aktiv)
        function renderAcceptedRideCard(ride) {
            const pickup = ride.pickup || 'Unbekannt';
            const destination = ride.destination || 'Unbekannt';
            const time = new Date(ride.pickupTimestamp || ride.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            const price = ride.finalPrice || ride.price || '?';
            const distance = ride.distance || '?';
            const duration = ride.duration || '?';
            
            // Zeit bis Abholung
            const timeUntil = ride.pickupTimestamp ? ride.pickupTimestamp - Date.now() : 0;
            const hoursUntil = Math.floor(timeUntil / (1000 * 60 * 60));
            const minutesUntil = Math.floor((timeUntil % (1000 * 60 * 60)) / (1000 * 60));
            const timeUntilStr = hoursUntil > 0 ? `${hoursUntil}h ${minutesUntil}min` : `${minutesUntil}min`;
            
            // Wer hat akzeptiert?
            let acceptedInfo = '';
            if (ride.acceptedBy === 'driver') {
                acceptedInfo = `<div style="font-size: 11px; color: #10b981; margin-top: 4px;">âœ… Von mir angenommen</div>`;
            } else if (ride.acceptedBy === 'admin') {
                const adminName = ride.acceptedByName || 'Admin';
                acceptedInfo = `<div style="font-size: 11px; color: #3b82f6; margin-top: 4px;">ğŸ”§ Admin-Akzeptiert (${adminName})</div>`;
            }
            
            return `
                <div style="
                    background: white;
                    border: 2px solid #10b981;
                    border-radius: 12px;
                    padding: 16px;
                    margin-bottom: 12px;
                    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div style="
                            background: #d1fae5;
                            color: #065f46;
                            padding: 6px 12px;
                            border-radius: 8px;
                            font-size: 13px;
                            font-weight: 700;
                        ">
                            âœ… ${time}
                        </div>
                        <div style="font-size: 16px; font-weight: 700; color: #10b981;">
                            ${price}â‚¬
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 8px;">
                        <div style="font-size: 13px; color: #6b7280; margin-bottom: 4px;">ğŸ“ ${pickup}</div>
                        <div style="text-align: center; color: #9ca3af; margin: 4px 0;">â†“</div>
                        <div style="font-size: 13px; color: #6b7280;">ğŸ¯ ${destination}</div>
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 8px;">
                        <div style="font-size: 12px; color: #6b7280;">ğŸ“ ${distance} km â€¢ â±ï¸ ${duration} Min</div>
                        <div style="
                            display: inline-block;
                            background: #fef3c7;
                            color: #92400e;
                            padding: 4px 12px;
                            border-radius: 8px;
                            font-size: 12px;
                            font-weight: 600;
                            margin-top: 6px;
                        ">
                            â° In ${timeUntilStr}
                        </div>
                    </div>
                    
                    ${acceptedInfo}
                    
                    <div style="display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 12px;">
                        <button onclick="showRideDetails('${ride.firebaseId || ride.id}')" style="
                            padding: 10px;
                            background: #f3f4f6;
                            color: #1f2937;
                            border: none;
                            border-radius: 8px;
                            font-weight: 600;
                            font-size: 13px;
                            cursor: pointer;
                        ">
                            ğŸ“ DETAILS ANZEIGEN
                        </button>
                    </div>
                </div>
            `;
        }

        function updateDriverView() {
            // ğŸ†• v5.90.300: ISARFUNK-STYLE!
            updateDriverViewIsarfunk();
            
            // Alte Logik fÃ¼r KompatibilitÃ¤t
            // updateDriverViewV268();
            
            // Alte Logik fÃ¼r KompatibilitÃ¤t (Benachrichtigungen etc.)
            // ğŸ†• v5.90.107: ZEIGE ALLE ZUGETEILTEN FAHRTEN (TAGESPROGRAMM)!
            // ğŸ†• v5.90.525: ZEIGE EINFACH ALLES WAS ASSIGNED IST!
            // Auto-Assign regelt das Timing im Backend!
            const newRides = rides.filter(r => {
                // NUR mein Fahrzeug
                if (!currentVehicle || r.vehicleId !== currentVehicle) {
                    return false;
                }
                
                // NUR aktuelle Fahrten zeigen (die gerade laufen)
                if (r.status === 'assigned' || 
                    r.status === 'accepted' || 
                    r.status === 'picked_up' || 
                    r.status === 'on_way') {
                    return true; // â† ZEIGE ALLES! Backend entscheidet wann!
                }
                
                // Alles andere NICHT zeigen
                return false;
            });
            
            // ğŸ†• v5.90.247: NUR vehicleId-basiert! Keine Name-Vergleiche mehr!
            const myRides = currentVehicle ? rides.filter(r => r.vehicleId === currentVehicle) : [];
            const current = myRides.find(r => r.status === 'on_way' || r.status === 'picked_up'); // ğŸ†• v5.90.289: NUR on_way oder picked_up!
            const completed = myRides.filter(r => r.status === 'completed');
            
            // ğŸ†• v5.90.249: UPDATE AKTIVE FAHRT BANNER + TAGESPROGRAMM!
            if (typeof updateActiveRideBanner === 'function') {
                updateActiveRideBanner(current);
            }
            if (typeof updateDriverSchedule === 'function') {
                updateDriverSchedule(myRides, current);
            }
            
            // ğŸš¨ CHECK FÃœR STORNIERTE FAHRTEN DIE BESTÃ„TIGUNG BRAUCHEN
            const pendingCancellations = myRides.filter(r => 
                (r.status === 'cancelled_pending_driver' || 
                (r.status === 'cancelled' && r.driverNotified === false))
            );
            
            // Update Badge
            const cancellationBadge = document.getElementById('cancellation-badge');
            const cancellationCount = document.getElementById('cancellation-count');
            if (cancellationBadge && cancellationCount) {
                if (pendingCancellations.length > 0) {
                    cancellationBadge.style.display = 'block';
                    cancellationCount.textContent = pendingCancellations.length;
                } else {
                    cancellationBadge.style.display = 'none';
                }
            }
            
            // Alte Benachrichtigungs-Logik (fÃ¼r KompatibilitÃ¤t)
            // ğŸ†• v5.31.6: Nur NEUE Stornierungen anzeigen (letzte 2 Min statt 10!)
            const twoMinutesAgo = Date.now() - (2 * 60 * 1000); // âœ… GeÃ¤ndert von 10 auf 2 Min!
            const cancelledRides = myRides.filter(r => 
                r.status === 'cancelled' && 
                r.driverNotified === false &&
                r.cancelledAt && r.cancelledAt > twoMinutesAgo // Nur letzte 2 Min!
            );
            if (cancelledRides.length > 0) {
                cancelledRides.forEach(ride => {
                    // ğŸ†• v5.21.7: Nur anzeigen wenn noch nicht gezeigt!
                    const rideKey = ride.firebaseId || ride.id;
                    if (!notifiedCancellations.has(rideKey)) {
                        notifiedCancellations.add(rideKey);
                        notifyDriverOfCancellation(ride);
                    }
                });
            }
            
            // ğŸ†• v5.90.491: UPDATE CURRENT RIDES DISPLAY!
            updateCurrentRidesDisplay(newRides);
            
            // Show/Hide Map vs Ready State
            if (current) {
                // ğŸ†• v5.90.318: NULL-CHECK!
                const routeInfo = document.getElementById('driver-route-info');
                const driverReady = document.getElementById('driver-ready');
                
                if (routeInfo) routeInfo.style.display = 'block';
                if (driverReady) driverReady.style.display = 'none';
                
                // Fahrt Info im Bottom Panel - mit Zeitstempel
                let rideInfo = '';
                
                // Buchungszeit formatieren
                if (current.createdAt || current.timestamp) {
                    const bookingDate = new Date(current.createdAt || current.timestamp);
                    const timeStr = bookingDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    rideInfo += `<span style="font-size:11px;color:#888;">ğŸ“… ${timeStr}</span> â€¢ `;
                }
                
                if (current.customerName) rideInfo += `ğŸ’¾ ${current.customerName} â€¢ `;
                rideInfo += `â†’ ${current.destination}`;
                if (current.price) rideInfo += ` â€¢ ğŸ’° ${current.price}â‚¬`;
                
                // ğŸ†• v5.90.61: Tracking-Link anzeigen
                if (current.trackingLink) {
                    rideInfo += `
                        <div style="margin-top:10px;padding:10px;background:#e0f2fe;border-radius:8px;border:1px solid #0ea5e9;">
                            <div style="font-size:11px;color:#0369a1;font-weight:600;margin-bottom:6px;">
                                ğŸ”— MAP-NULL-CHECK-FIX-LINK FÃœR KUNDE:
                            </div>
                            <input type="text" value="${current.trackingLink}" 
                                readonly 
                                id="tracking-link-input"
                                style="width:100%;padding:8px;border:1px solid #0ea5e9;border-radius:4px;font-size:11px;background:white;"
                                onclick="this.select()">
                            <div style="display:flex;gap:6px;margin-top:6px;">
                                <button onclick="copyTrackingLink('${current.trackingLink}')" style="flex:1;padding:6px;background:#3b82f6;color:white;border:none;border-radius:4px;font-size:11px;font-weight:600;">
                                    ğŸ“‹ Kopieren
                                </button>
                                <button onclick="shareViaWhatsApp('${current.trackingLink}')" style="flex:1;padding:6px;background:#25d366;color:white;border:none;border-radius:4px;font-size:11px;font-weight:600;">
                                    ğŸ’¬ WhatsApp
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                const driverCurrentRide = document.getElementById('driver-current-ride');
                if (driverCurrentRide) {
                    driverCurrentRide.innerHTML = rideInfo;
                }
                
                // Buttons im Bottom Panel
                let buttonsHtml = '';
                if (current.status === 'accepted') {
                    // ğŸ†• v5.90.289: Angenommen aber noch nicht losgefahren
                    buttonsHtml = `
                        <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                            <button onclick="startDrivingToCustomer('${current.firebaseId}')" style="
                                width: 100%;
                                padding: 16px;
                                background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                                color: white;
                                border: none;
                                border-radius: 12px;
                                font-size: 18px;
                                font-weight: bold;
                                cursor: pointer;
                                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
                            ">
                                ğŸš— FAHRT ZUM KUNDEN STARTEN
                            </button>
                            <button onclick="cancelAcceptedRide('${current.firebaseId}')" style="
                                width: 100%;
                                padding: 12px;
                                background: #6b7280;
                                color: white;
                                border: none;
                                border-radius: 10px;
                                font-size: 14px;
                                font-weight: 600;
                                cursor: pointer;
                            ">
                                ğŸ’¾ Stornieren
                            </button>
                        </div>
                    `;
                } else if (current.status === 'on_way') {
                    // ğŸ†• v5.90.289: Unterwegs zum Kunden
                    buttonsHtml = `
                        <button onclick="pickupCustomer('${current.firebaseId}')" style="
                            width: 100%;
                            padding: 14px;
                            background: #10b981;
                            color: white;
                            border: none;
                            border-radius: 12px;
                            font-size: 16px;
                            font-weight: bold;
                            cursor: pointer;
                        ">
                            ğŸ’¾ KUNDE ABGEHOLT
                        </button>
                    `;
                } else if (current.status === 'picked_up') {
                    buttonsHtml = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <button onclick="completeRideSimple('${current.firebaseId}')" style="
                                padding: 12px 8px;
                                background: #10b981;
                                color: white;
                                border: none;
                                border-radius: 10px;
                                font-size: 14px;
                                font-weight: 600;
                                cursor: pointer;
                                line-height: 1.3;
                            ">
                                âœ… Fertig<br>
                                <span style="font-size: 11px; opacity: 0.9;">(Ohne Rechnung)</span>
                            </button>
                            <button onclick="completeRideWithInvoice('${current.firebaseId}')" style="
                                padding: 12px 8px;
                                background: #8b5cf6;
                                color: white;
                                border: none;
                                border-radius: 10px;
                                font-size: 14px;
                                font-weight: 600;
                                cursor: pointer;
                                line-height: 1.3;
                            ">
                                ğŸ“± Mit Rechnung<br>
                                <span style="font-size: 11px; opacity: 0.9;">(Preis eintragen)</span>
                            </button>
                        </div>
                    `;
                }
                
                // Insert buttons into bottom panel (append after driver-current-ride)
                const bottomPanel = document.getElementById('bottom-panel');
                let actionsDiv = bottomPanel.querySelector('#driver-actions');
                if (!actionsDiv) {
                    actionsDiv = document.createElement('div');
                    actionsDiv.id = 'driver-actions';
                    bottomPanel.appendChild(actionsDiv);
                }
                actionsDiv.innerHTML = buttonsHtml;
                actionsDiv.style.display = 'block';
                
            } else {
                // ğŸ†• v5.90.318: NULL-CHECK!
                const routeInfo = document.getElementById('driver-route-info');
                const driverReady = document.getElementById('driver-ready');
                
                if (routeInfo) routeInfo.style.display = 'none';
                if (driverReady) driverReady.style.display = 'block';
                
                // ğŸ†• v5.90.261: Zeige Fahrten-Liste statt "Bereit"
                // ğŸ†• v5.90.632: NUR beim ERSTEN Mal laden! Nicht jede Sekunde!
                if (currentVehicle && typeof loadDriverRides === 'function' && !ridesLoadedOnce) {
                    loadDriverRides();
                    ridesLoadedOnce = true;  // Merke dass wir schon geladen haben
                    console.log('ğŸ”§ v5.90.632: Fahrten EINMALIG geladen beim Start');
                } else {
                    // Fallback: Zeige "Bereit" wenn keine Fahrten-Funktion
                    const noRides = document.getElementById('driver-no-rides');
                    if (noRides) noRides.style.display = 'block';
                }
            }
            
            // New rides
            const newRidesEl = document.getElementById('new-rides');
            if (!newRidesEl) return; // Element fehlt, abbrechen
            
            if (!currentVehicle) {
                newRidesEl.innerHTML = '<div style="padding:20px;text-align:center;color:#999;">âš ï¸ Bitte erst Fahrzeug wÃ¤hlen</div>';
            } else if (newRides.length === 0) {
                newRidesEl.innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Keine neuen AuftrÃ¤ge</div>';
            } else {
                let ridesHtml = newRides
                    // ğŸ†• v5.90.107: Sortiere nach pickupTimestamp (Tagesprogramm!)
                    .sort((a, b) => {
                        const aTime = a.pickupTimestamp || a.timestamp || 0;
                        const bTime = b.pickupTimestamp || b.timestamp || 0;
                        return aTime - bTime;
                    })
                    .map(r => {
                    // ğŸ¯ v5.90.107: Verbesserte Badge-Logik!
                    const isMyVehicle = (currentVehicle && r.vehicleId === currentVehicle);
                    const isAssignedToMe = r.assignedTo === currentVehicle;
                    const timeLeft = r.assignmentExpiresAt ? Math.max(0, Math.ceil((r.assignmentExpiresAt - Date.now()) / 1000)) : null;
                    
                    let assignmentBadge = '';
                    let cardStyle = '';
                    
                    // Fall 1: Zeitlich zugewiesen (mit Timer)
                    if (isAssignedToMe && timeLeft > 0) {
                        assignmentBadge = `<span style="background:#ef4444;color:white;padding:4px 8px;border-radius:12px;font-size:12px;font-weight:bold;animation:pulse 1s infinite;">â° DIR ZUGEWIESEN - ${timeLeft}s</span>`;
                        cardStyle = 'border:3px solid #ef4444;background:#fef2f2;';
                    }
                    // Fall 2: Meinem Fahrzeug fest zugeteilt (z.B. vom Admin)
                    else if (isMyVehicle) {
                        assignmentBadge = `<span style="background:#10b981;color:white;padding:4px 8px;border-radius:12px;font-size:12px;font-weight:bold;">âœ… DEINE FAHRT</span>`;
                        cardStyle = 'border:2px solid #10b981;background:#f0fdf4;';
                    }
                    // Fall 3: Anderem Fahrzeug zugeteilt
                    else if (r.assignedTo && r.assignedTo !== currentVehicle) {
                        assignmentBadge = `<span style="background:#94a3b8;padding:4px 8px;border-radius:12px;font-size:12px;">ğŸ’¾ Zugewiesen: ${r.assignedVehicleName || r.assignedTo}</span>`;
                    }
                    // Fall 4: Anderem Fahrzeug zugeteilt (via vehicleId)
                    else if (r.vehicleId && r.vehicleId !== currentVehicle) {
                        const vehicleName = VEHICLES[r.vehicleId] ? VEHICLES[r.vehicleId].name : r.vehicleId;
                        assignmentBadge = `<span style="background:#94a3b8;padding:4px 8px;border-radius:12px;font-size:12px;">ğŸ’¾ Zugewiesen: ${vehicleName}</span>`;
                    }
                    // Fall 5: Neu (fÃ¼r alle)
                    else {
                        assignmentBadge = '<span style="background:#fef3c7;padding:4px 8px;border-radius:12px;font-size:12px;">ğŸ†• Neu</span>';
                    }
                    
                    return `
                    <div class="ride-card" style="${cardStyle}cursor:pointer;transition:all 0.2s;" 
                         onclick="viewRideDetails('${r.firebaseId || r.id}')"
                         onmouseover="this.style.transform='scale(1.02)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'"
                         onmouseout="this.style.transform='scale(1)';this.style.boxShadow='none'">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <strong>#${r.id}</strong>
                            ${assignmentBadge}
                        </div>
                        ${r.customerName ? `
                        <div style="margin-top:12px;padding:12px;background:#f0f9ff;border-radius:8px;border-left:4px solid #3b82f6;">
                            <div style="font-size:16px;font-weight:600;color:#1e40af;margin-bottom:8px;">
                                ğŸ’¾ ${r.customerName}
                            </div>
                            ${r.customerPhone ? `
                            <div style="margin-bottom:8px;display:flex;align-items:center;gap:8px;">
                                <a href="tel:${r.customerPhone}" style="
                                    flex:1;
                                    display:flex;
                                    align-items:center;
                                    justify-content:center;
                                    gap:6px;
                                    padding:8px 12px;
                                    background:#10b981;
                                    color:white;
                                    text-decoration:none;
                                    border-radius:6px;
                                    font-weight:600;
                                    font-size:14px;
                                    transition:all 0.2s;
                                " onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                                    ğŸ’¾ ${r.customerPhone}
                                </a>
                                <button onclick="event.stopPropagation(); shareRideViaWhatsApp('${r.firebaseId || r.id}')" style="
                                    padding:8px 12px;
                                    background:#25D366;
                                    color:white;
                                    border:none;
                                    border-radius:6px;
                                    font-weight:600;
                                    font-size:14px;
                                    cursor:pointer;
                                    transition:all 0.2s;
                                    white-space:nowrap;
                                " onmouseover="this.style.background='#128C7E'" onmouseout="this.style.background='#25D366'">
                                    ğŸ“¤ WhatsApp
                                </button>
                            </div>
                            ` : ''}
                            <div style="font-size:14px;color:#0369a1;">
                                ğŸ• Abholung: <strong>${r.pickupTime || 'Sofort'}</strong>
                            </div>
                        </div>
                        ` : ''}
                        <div style="margin-top:10px;font-size:14px;">
                            <strong>Von:</strong> ${r.pickup}<br>
                            <strong>Nach:</strong> ${r.destination}<br>
                            <strong>Distanz:</strong> ${r.distance} km â€¢ ${r.duration} Min<br>
                            <strong>Preis:</strong> ${r.price}â‚¬
                            ${r.assignmentDistance ? `<br><strong>ğŸ“ Du bist:</strong> ${r.assignmentDistance.toFixed(1)} km entfernt` : ''}<br>
                            <div style="margin-top:6px;padding:6px 8px;background:#f3f4f6;border-radius:4px;font-size:12px;color:#4b5563;">
                                ğŸ“… Bestellt: <strong>${r.time}</strong>
                                ${r.pickupTime && r.pickupTime !== 'Sofort' ? ` | â° Abholung: <strong>${r.pickupTime}</strong>` : ' | âš¡ Sofort'}
                            </div>
                        </div>
                        ${!current ? `<button class="btn btn-success" onclick="acceptRide('${r.firebaseId}')" style="margin-top:10px;background:#10b981 !important;color:white !important;border:none;padding:12px;border-radius:8px;font-weight:600;cursor:pointer;">${r.status === 'assigned' ? 'âœ… FAHRT STARTEN' : 'âœ“ Annehmen'}</button>` : '<div style="margin-top:10px;padding:8px;background:#fef3c7;border-radius:6px;font-size:13px;text-align:center;">SchlieÃŸe erst aktuelle Fahrt ab</div>'}
                    </div>
                    `;
                }).join('');
                
                if (!isOnline) {
                    ridesHtml = '<div class="alert-info" style="margin-bottom:15px;">âš ï¸ Du bist <strong>Offline</strong>. Schalte auf Online um AuftrÃ¤ge anzunehmen.</div>' + ridesHtml;
                }
                
                document.getElementById('new-rides').innerHTML = ridesHtml;
            }
            
            // Update Counter fÃ¼r neue AuftrÃ¤ge
            const countElement = document.getElementById('new-rides-count');
            if (countElement) {
                countElement.textContent = newRides.length;
                
                // ğŸ†• v5.90.525: SYNC-CHECK DEBUG!
                if (currentVehicle) {
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    console.log('ğŸ” v5.90.525: SYNC-CHECK fÃ¼r Badge vs Timeline');
                    console.log('   Fahrzeug:', currentVehicle);
                    console.log('   Badge zÃ¤hlt:', newRides.length, 'Fahrten');
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    
                    // Zeige Details der Badge-Fahrten
                    newRides.forEach((ride, idx) => {
                        const time = ride.pickupTimestamp ? new Date(ride.pickupTimestamp).toLocaleString('de-DE') : 'Sofort';
                        const minutesUntil = ride.pickupTimestamp ? Math.round((ride.pickupTimestamp - Date.now()) / 60000) : 0;
                        console.log(`   ${idx + 1}. ${ride.status.toUpperCase()} | ${ride.customerName || 'Unbekannt'} | ${time} ${minutesUntil > 0 ? '(in ' + minutesUntil + ' Min)' : ''}`);
                    });
                    
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                }
            }
            
            // Stats
            const revenue = completed.reduce((sum, r) => sum + parseFloat(r.price), 0);
            document.getElementById('d-rides').textContent = completed.length;
            document.getElementById('d-money').textContent = revenue.toFixed(2) + 'â‚¬';
            
            // ğŸ§ª Zeige Test-Buttons wenn Fahrer-View aktiv
            const testButtons = document.getElementById('alert-test-buttons');
            if (testButtons) {
                testButtons.style.display = (currentView === 'driver' && currentVehicle) ? 'flex' : 'none';
            }
            
            // ğŸ“± Update Alert Status
            updateAlertStatus();
        }

        function updateAdminView() {
            // ğŸ“¦ Merge Firebase + localStorage fÃ¼r vollstÃ¤ndige Ansicht
            let allRides = [...rides]; // Kopiere Firebase Fahrten
            
            // Lade auch aus localStorage (fÃ¼r Offline-Buchungen & stornierte Fahrten)
            const localHistory = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            localHistory.forEach(localRide => {
                const existsInFirebase = allRides.some(fbRide => fbRide.id === localRide.id || fbRide.firebaseId === localRide.firebaseId);
                if (!existsInFirebase) {
                    allRides.push(localRide);
                }
            });
            
            // ğŸ§¹ FILTERE ALTE FAHRTEN (Ã¤lter als 3 Tage) AUTOMATISCH RAUS
            const threeDaysAgo = Date.now() - (3 * 24 * 60 * 60 * 1000);
            allRides = allRides.filter(r => {
                const rideTime = r.pickupTimestamp || r.createdAt || 0;
                // Behalte nur: completed (immer), oder Fahrten von letzten 3 Tagen
                return r.status === 'completed' || r.status === 'abgeschlossen' || rideTime > threeDaysAgo;
            });
            
            console.log('ğŸ” ADMIN DEBUG - Gesamt Fahrten (nach Filter):', allRides.length);
            console.log('ğŸ” ADMIN DEBUG - Status:', allRides.map(r => r.status));
            
            const completed = allRides.filter(r => r.status === 'completed' || r.status === 'abgeschlossen');
            const pending = allRides.filter(r => r.status === 'new' || r.status === 'vorbestellt');
            const active = allRides.filter(r => r.status === 'accepted' || r.status === 'akzeptiert' || r.status === 'unterwegs' || r.status === 'picked_up');
            const rejected = allRides.filter(r => r.status === 'rejected'); // ğŸ†• Abgelehnte Fahrten
            const revenue = completed.reduce((sum, r) => sum + parseFloat(r.price), 0);
            
            document.getElementById('a-total').textContent = completed.length;
            document.getElementById('a-revenue').textContent = revenue.toFixed(2) + 'â‚¬';
            document.getElementById('a-pending').textContent = pending.length;
            document.getElementById('a-active').textContent = active.length;
            
            // ğŸ†• v5.31.5: Update Benachrichtigungs-Bar
            updateNotificationBar();
            
            // ğŸ“‹ OFFENE FAHRTEN = vorbestellt, new, akzeptiert, unterwegs, angekommen
            // ğŸ†• v5.49.0: ABER NUR WENN NICHT ABGELAUFEN!
            const now = Date.now();
            const oneHourAgo = now - (60 * 60 * 1000); // 1 Stunde
            
            const openRides = allRides.filter(r => {
                const openStatuses = ['vorbestellt', 'new', 'akzeptiert', 'accepted', 'unterwegs', 'picked_up', 'angekommen'];
                if (!openStatuses.includes(r.status)) return false;
                
                // ğŸ†• v5.49.0: Wenn Fahrt VORBESTELLT oder NEU ist UND Ã¤lter als 1 Stunde â†’ ABGELAUFEN!
                const rideTime = r.pickupTimestamp || r.createdAt || 0;
                if ((r.status === 'vorbestellt' || r.status === 'new') && rideTime < oneHourAgo) {
                    return false; // Nicht in offenen Fahrten!
                }
                
                return true;
            }).sort((a, b) => {
                // Sortiere nach Abholzeit (falls vorhanden) oder Erstellungszeit
                const timeA = a.pickupTimestamp || a.createdAt || 0;
                const timeB = b.pickupTimestamp || b.createdAt || 0;
                return timeA - timeB;
            });
            
            // ğŸ†• v5.49.0: ABGELAUFENE FAHRTEN (vorbestellt/new + Ã¤lter als 1 Stunde)
            const expiredRides = allRides.filter(r => {
                const isExpirableStatus = (r.status === 'vorbestellt' || r.status === 'new');
                const rideTime = r.pickupTimestamp || r.createdAt || 0;
                return isExpirableStatus && rideTime < oneHourAgo;
            }).sort((a, b) => {
                const timeA = a.pickupTimestamp || a.createdAt || 0;
                const timeB = b.pickupTimestamp || b.createdAt || 0;
                return timeB - timeA; // Neueste zuerst
            });
            
            if (openRides.length === 0) {
                document.getElementById('upcoming-rides-admin').innerHTML = '<div style="padding:15px;text-align:center;color:#999;background:white;border-radius:8px;">Keine offenen Fahrten</div>';
            } else {
                // Gruppiere nach Tag
                const groupedByDay = {};
                openRides.forEach(ride => {
                    const rideTime = ride.pickupTimestamp || ride.createdAt;
                    const rideDate = new Date(rideTime);
                    const dayKey = rideDate.toLocaleDateString('de-DE', { 
                        weekday: 'long', 
                        day: '2-digit', 
                        month: '2-digit',
                        year: 'numeric'
                    });
                    
                    if (!groupedByDay[dayKey]) {
                        groupedByDay[dayKey] = [];
                    }
                    groupedByDay[dayKey].push(ride);
                });
                
                // Baue HTML fÃ¼r gruppierte Fahrten
                let html = '';
                Object.keys(groupedByDay).forEach(dayKey => {
                    const ridesForDay = groupedByDay[dayKey];
                    html += `<div style="margin-bottom:20px;">
                        <h4 style="background:#667eea;color:white;padding:10px;border-radius:8px;margin-bottom:10px;">
                            ğŸ“… ${dayKey} (${ridesForDay.length} Fahrt${ridesForDay.length !== 1 ? 'en' : ''})
                        </h4>`;
                    
                    ridesForDay.forEach(r => {
                        const pickupDate = new Date(r.pickupTimestamp || r.createdAt);
                        const formattedTime = pickupDate.toLocaleTimeString('de-DE', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                        
                        // Zeitdifferenz berechnen
                        const hoursUntil = Math.floor((pickupDate.getTime() - now) / (1000 * 60 * 60));
                        const daysUntil = Math.floor(hoursUntil / 24);
                        let countdownText = '';
                        if (daysUntil > 0) {
                            countdownText = `in ${daysUntil} Tag${daysUntil > 1 ? 'en' : ''}`;
                        } else if (hoursUntil > 0) {
                            countdownText = `in ${hoursUntil} Stunde${hoursUntil > 1 ? 'n' : ''}`;
                        } else {
                            const minutesUntil = Math.floor((pickupDate.getTime() - now) / (1000 * 60));
                            if (minutesUntil > 0) {
                                countdownText = `in ${minutesUntil} Min`;
                            } else {
                                countdownText = `JETZT`;
                            }
                        }
                        
                        // Status-Badge
                        let statusBadge = '';
                        let borderColor = '#0ea5e9';
                        let bgColor = '#e0f2fe';
                        
                        if (r.status === 'vorbestellt') {
                            statusBadge = '<span style="background:#f59e0b;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;margin-left:8px;">ğŸ“… Vorbestellt</span>';
                            borderColor = '#f59e0b';
                            bgColor = '#fef3c7';
                        } else if (r.status === 'new') {
                            statusBadge = '<span style="background:#3b82f6;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;margin-left:8px;">ğŸ”” Neu</span>';
                            borderColor = '#3b82f6';
                            bgColor = '#dbeafe';
                        } else if (r.status === 'akzeptiert' || r.status === 'accepted') {
                            statusBadge = '<span style="background:#10b981;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;margin-left:8px;">âœ… Akzeptiert</span>';
                            borderColor = '#10b981';
                            bgColor = '#d1fae5';
                        } else if (r.status === 'unterwegs' || r.status === 'picked_up') {
                            statusBadge = '<span style="background:#0ea5e9;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;margin-left:8px;">ğŸš— Unterwegs</span>';
                            borderColor = '#0ea5e9';
                            bgColor = '#e0f2fe';
                        }
                        
                        // ğŸ†• v5.48.1: Buchungsquellen-Badge
                        let sourceBadge = '';
                        if (r.bookingSource === 'sofort') {
                            sourceBadge = '<span style="background:#10b981;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;margin-left:8px;">âš¡ Sofort</span>';
                        } else if (r.bookingSource === 'vorbestellen') {
                            sourceBadge = '<span style="background:#667eea;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;margin-left:8px;">ğŸ“… Vorbestellt</span>';
                        } else if (r.bookingSource === 'rebooking') {
                            sourceBadge = '<span style="background:#f59e0b;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;margin-left:8px;">ğŸ”„ Nochmal</span>';
                        } else if (r.bookingSource === 'admin-quick') {
                            sourceBadge = '<span style="background:#f59e0b;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;margin-left:8px;">âš¡ Schnell</span>';
                        } else if (r.bookingSource === 'admin-panel') {
                            sourceBadge = '<span style="background:#8b5cf6;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;margin-left:8px;">ğŸ› ï¸ Panel</span>';
                        }
                        
                        // ğŸ”˜ Aktions-Buttons fÃ¼r offene Fahrten
                        let actionButtons = '';
                        if (r.status === 'vorbestellt' || r.status === 'new') {
                            actionButtons = `
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:10px;">
                                    <button onclick="assignVehicleToRide('${r.firebaseId || r.id}')" 
                                        style="padding:10px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:700;">
                                        ğŸš— Fahrer zuweisen
                                    </button>
                                    <button onclick="editRide('${r.firebaseId || r.id}')" 
                                        style="padding:8px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                        âœï¸ Bearbeiten
                                    </button>
                                    <button onclick="reverseRouteAdmin('${r.firebaseId || r.id}')" 
                                        style="padding:8px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                        ğŸ”„ Umdrehen
                                    </button>
                                    <button onclick="deleteRide('${r.firebaseId || r.id}')" 
                                        style="padding:8px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                        ğŸ—‘ï¸ LÃ¶schen
                                    </button>
                                </div>
                            `;
                        } else if (r.status === 'assigned' && r.vehicleId) {
                            // ğŸ†• v5.90.279: ZUWEISUNG AUFHEBEN fÃ¼r zugewiesene Fahrten!
                            actionButtons = `
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:10px;">
                                    <button onclick="unassignVehicleFromRide('${r.firebaseId || r.id}')" 
                                        style="padding:10px;background:#f59e0b;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:700;">
                                        â†©ï¸ Zuweisung aufheben
                                    </button>
                                    <button onclick="editRide('${r.firebaseId || r.id}')" 
                                        style="padding:8px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                        âœï¸ Bearbeiten
                                    </button>
                                    <button onclick="reverseRouteAdmin('${r.firebaseId || r.id}')" 
                                        style="padding:8px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                        ğŸ”„ Umdrehen
                                    </button>
                                    <button onclick="deleteRide('${r.firebaseId || r.id}')" 
                                        style="padding:8px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                        ğŸ—‘ï¸ LÃ¶schen
                                    </button>
                                </div>
                            `;
                        }
                        
                        html += `<div class="ride-card" style="border-left:4px solid ${borderColor};background:${bgColor};">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <strong>${r.customerName || 'Unbekannt'}${r.guestName ? ' â†’ ğŸ§³ ' + r.guestName : ''}${r.guestPhone ? ' ğŸ“±' + r.guestPhone : ''}</strong>
                                <div style="display:flex;gap:6px;align-items:center;">
                                    <span style="background:#0ea5e9;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;">${countdownText}</span>
                                    ${statusBadge}
                                    ${sourceBadge}
                                    ${r.adminConfirmed || acknowledgedRides.has(r.id) ? '<span style="background:#10b981;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;">âœ… BestÃ¤tigt</span>' : ''}
                                    <button onclick="exportSingleRideToICS('${r.firebaseId || r.id}')" 
                                        style="background:#8b5cf6;color:white;padding:4px 8px;border:none;border-radius:12px;font-size:11px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:4px;"
                                        title="Als Kalender-Termin exportieren">
                                        ğŸ“¥ ICS
                                    </button>
                                </div>
                            </div>
                            <div style="margin-top:10px;font-size:14px;color:#0c4a6e;">
                                <strong>ğŸ• ${formattedTime} Uhr</strong><br>
                                <strong>ğŸ“ Von:</strong> ${r.pickup}<br>
                                <strong>ğŸ¯ Nach:</strong> ${r.destination}<br>
                                <strong>ğŸ’° Preis:</strong> ${r.price}â‚¬<br>
                                <strong>ğŸ“ Distanz:</strong> ${r.distance} km
                                ${r.vehicle ? '<br><strong>ğŸš— Fahrzeug:</strong> '+r.vehicle+(r.vehiclePlate ? ' ('+r.vehiclePlate+')' : '') : ''}
                            </div>
                            ${actionButtons}
                        </div>`;
                    });
                    
                    html += '</div>';
                });
                
                document.getElementById('upcoming-rides-admin').innerHTML = html;
            }
            
            // ğŸ†• v5.49.0: â° ABGELAUFENE FAHRTEN anzeigen
            if (expiredRides.length === 0) {
                document.getElementById('expired-rides-admin').innerHTML = '<div style="padding:15px;text-align:center;color:#999;background:white;border-radius:8px;">âœ… Keine abgelaufenen Fahrten</div>';
            } else {
                let expiredHTML = '';
                expiredRides.forEach(r => {
                    const pickupDate = new Date(r.pickupTimestamp || r.createdAt);
                    const formattedTime = pickupDate.toLocaleTimeString('de-DE', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    const formattedDate = pickupDate.toLocaleDateString('de-DE', {
                        weekday: 'short',
                        day: '2-digit',
                        month: '2-digit'
                    });
                    
                    // Berechne wie lange abgelaufen
                    const hoursAgo = Math.floor((now - pickupDate.getTime()) / (1000 * 60 * 60));
                    const daysAgo = Math.floor(hoursAgo / 24);
                    let expiredText = '';
                    if (daysAgo > 0) {
                        expiredText = `vor ${daysAgo} Tag${daysAgo > 1 ? 'en' : ''}`;
                    } else if (hoursAgo > 0) {
                        expiredText = `vor ${hoursAgo} Stunde${hoursAgo > 1 ? 'n' : ''}`;
                    } else {
                        expiredText = 'gerade eben';
                    }
                    
                    // ğŸ†• v5.48.1: Buchungsquellen-Badge
                    let sourceBadge = '';
                    if (r.bookingSource === 'sofort') {
                        sourceBadge = '<span style="background:#10b981;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;margin-left:8px;">âš¡ Sofort</span>';
                    } else if (r.bookingSource === 'vorbestellen') {
                        sourceBadge = '<span style="background:#667eea;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;margin-left:8px;">ğŸ“… Vorbestellt</span>';
                    } else if (r.bookingSource === 'rebooking') {
                        sourceBadge = '<span style="background:#f59e0b;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;margin-left:8px;">ğŸ”„ Nochmal</span>';
                    } else if (r.bookingSource === 'admin-quick') {
                        sourceBadge = '<span style="background:#f59e0b;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;margin-left:8px;">âš¡ Schnell</span>';
                    } else if (r.bookingSource === 'admin-panel') {
                        sourceBadge = '<span style="background:#8b5cf6;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;margin-left:8px;">ğŸ› ï¸ Panel</span>';
                    }
                    
                    expiredHTML += `<div style="background:#f3f4f6;border-left:4px solid #6b7280;border-radius:8px;padding:15px;margin-bottom:10px;opacity:0.7;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <strong>${r.customerName || 'Unbekannt'}</strong>
                            <div style="display:flex;gap:6px;align-items:center;">
                                <span style="background:#6b7280;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;">â° ABGELAUFEN</span>
                                ${sourceBadge}
                            </div>
                        </div>
                        <div style="margin-top:10px;font-size:14px;color:#4b5563;">
                            <strong>ğŸ“… ${formattedDate} ${formattedTime} Uhr</strong> (${expiredText})<br>
                            <strong>ğŸ“ Von:</strong> ${r.pickup}<br>
                            <strong>ğŸ¯ Nach:</strong> ${r.destination}<br>
                            <strong>ğŸ’° Preis:</strong> ${r.price}â‚¬<br>
                            <strong>ğŸ“ Distanz:</strong> ${r.distance} km
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:10px;">
                            <button onclick="deleteRide('${r.firebaseId || r.id}')" 
                                style="padding:8px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                ğŸ—‘ï¸ LÃ¶schen
                            </button>
                            <button onclick="rebookExpiredRide('${r.firebaseId || r.id}')" 
                                style="padding:8px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                ğŸ”„ Neu buchen
                            </button>
                        </div>
                    </div>`;
                });
                
                document.getElementById('expired-rides-admin').innerHTML = expiredHTML;
            }
            
            // ğŸ’¾ ABGELEHNTE FAHRTEN anzeigen
            if (rejected.length === 0) {
                document.getElementById('rejected-rides-admin').innerHTML = '<div style="padding:15px;text-align:center;color:#999;background:white;border-radius:8px;">âœ… Keine abgelehnten Fahrten</div>';
            } else {
                let rejectedHTML = '<div style="background:#fef2f2;border:2px solid #ef4444;border-radius:12px;padding:15px;margin-bottom:10px;">';
                rejectedHTML += `<div style="color:#991b1b;font-weight:bold;margin-bottom:10px;">âš ï¸ ${rejected.length} Fahrt${rejected.length !== 1 ? 'en' : ''} wurde${rejected.length !== 1 ? 'n' : ''} abgelehnt!</div>`;
                
                rejected.forEach(r => {
                    const rejectedTime = new Date(r.rejectedAt || r.createdAt).toLocaleString('de-DE');
                    rejectedHTML += `
                        <div style="background:white;padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid #ef4444;">
                            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px;">
                                <div style="flex:1;">
                                    <div style="font-size:12px;color:#666;margin-bottom:5px;">
                                        ğŸ’¾ Abgelehnt von: <strong>${r.rejectedByDriver || r.rejectedBy || 'Unbekannt'}</strong>
                                    </div>
                                    <div style="font-size:12px;color:#999;">
                                        ${rejectedTime}
                                    </div>
                                </div>
                                <div style="font-size:24px;font-weight:bold;color:#ef4444;">${r.price}â‚¬</div>
                            </div>
                            ${r.customerName ? `<div style="font-weight:600;margin-bottom:8px;">ğŸ’¾ ${r.customerName}</div>` : ''}
                            <div style="font-size:14px;margin-bottom:5px;">
                                <strong>ğŸ“ Von:</strong> ${r.pickup}
                            </div>
                            <div style="font-size:14px;margin-bottom:10px;">
                                <strong>ğŸ¯ Nach:</strong> ${r.destination}
                            </div>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
                                <button onclick="reassignRide('${r.firebaseId || r.id}')" style="
                                    padding:12px;
                                    background:#10b981;
                                    color:white;
                                    border:none;
                                    border-radius:8px;
                                    font-weight:bold;
                                    cursor:pointer;
                                ">
                                    ğŸ”„ Neu zuweisen
                                </button>
                                <button onclick="deleteRide('${r.firebaseId || r.id}')" style="
                                    padding:12px;
                                    background:#ef4444;
                                    color:white;
                                    border:none;
                                    border-radius:8px;
                                    font-weight:bold;
                                    cursor:pointer;
                                ">
                                    ğŸ—‘ï¸ LÃ¶schen
                                </button>
                            </div>
                        </div>`;
                });
                
                rejectedHTML += '</div>';
                document.getElementById('rejected-rides-admin').innerHTML = rejectedHTML;
            }
            
            // Stornierungen anzeigen
            if (cancellations.length === 0) {
                document.getElementById('cancellations-list').innerHTML = '<div style="padding:15px;text-align:center;color:#999;background:white;border-radius:8px;">Keine Stornierungen</div>';
            } else {
                const totalFees = cancellations.reduce((sum, c) => sum + parseFloat(c.cancellationFee || 0), 0);
                document.getElementById('cancellations-list').innerHTML = 
                    `<div style="background:#fef3c7;border:2px solid #f59e0b;padding:12px;border-radius:8px;margin-bottom:15px;text-align:center;">
                        <strong>Gesamt StornogebÃ¼hren: ${totalFees.toFixed(2)}â‚¬</strong> (${cancellations.length} Stornierungen)
                    </div>` +
                    cancellations.slice().reverse().map(c => {
                        const cancelDate = new Date(c.cancelledAt).toLocaleString('de-DE');
                        return `<div class="ride-card" style="border-left:4px solid #f59e0b;">
                            <strong>${c.customerName || 'Unbekannt'}</strong> 
                            <span style="background:#fef3c7;padding:4px 8px;border-radius:12px;font-size:12px;color:#92400e;font-weight:600;">ğŸ’¶ ${c.cancellationFee.toFixed(2)}â‚¬</span>
                            <div style="margin-top:10px;font-size:14px;color:#666;">
                                <strong>Von:</strong> ${c.pickup}<br>
                                <strong>Nach:</strong> ${c.destination}<br>
                                <strong>Original-Preis:</strong> ${c.originalPrice}â‚¬<br>
                                <strong>Storniert:</strong> ${cancelDate}
                            </div>
                        </div>`;
                    }).join('');
            }
            
            // âœ… NUR ABGESCHLOSSENE FAHRTEN zeigen
            const completedRides = allRides.filter(r => r.status === 'completed' || r.status === 'abgeschlossen');
            
            if (completedRides.length === 0) {
                document.getElementById('all-rides').innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Keine abgeschlossenen Fahrten</div>';
            } else {
                document.getElementById('all-rides').innerHTML = completedRides.slice().reverse().map(r => {
                    let statusText = r.status;
                    let statusColor = '#fef3c7';
                    if (r.status === 'completed') { statusText = 'Abgeschlossen'; statusColor = '#d1fae5'; }
                    else if (r.status === 'abgeschlossen') { statusText = 'Abgeschlossen'; statusColor = '#d1fae5'; }
                    else if (r.status === 'accepted') { statusText = 'Unterwegs'; statusColor = '#dbeafe'; }
                    else if (r.status === 'akzeptiert') { statusText = 'Akzeptiert'; statusColor = '#d1fae5'; }
                    else if (r.status === 'unterwegs') { statusText = 'Unterwegs'; statusColor = '#dbeafe'; }
                    else if (r.status === 'picked_up') { statusText = 'Besetzt'; statusColor = '#fef3c7'; }
                    else if (r.status === 'new') { statusText = 'Neu'; statusColor = '#fef3c7'; }
                    else if (r.status === 'vorbestellt') { statusText = 'Vorbestellt'; statusColor = '#fef3c7'; }
                    else if (r.status === 'storniert') { statusText = 'Storniert'; statusColor = '#fee2e2'; }
                    
                    // Abholzeit formatieren
                    let pickupTimeDisplay = r.pickupTime || 'Sofort';
                    if (r.pickupTimestamp) {
                        const pickupDate = new Date(r.pickupTimestamp);
                        const now = Date.now();
                        if (pickupDate.getTime() > now + (30 * 60000)) {
                            // Zukunft
                            pickupTimeDisplay = 'ğŸ“… ' + pickupDate.toLocaleString('de-DE', {
                                day: '2-digit',
                                month: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        }
                    }
                    
                    // Manuelle Zuweisung Button fÃ¼r neue Fahrten
                    let assignButton = '';
                    if (r.status === 'new' && r.firebaseId) {
                        assignButton = `<button onclick="manuallyAssignRide('${r.firebaseId}')" style="width:100%;margin-top:10px;padding:8px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;">
                            ğŸš— Fahrer manuell zuweisen
                        </button>`;
                    }
                    
                    // Buttons fÃ¼r ALLE Fahrten
                    let actionButtons = '';
                    const rideIdForButtons = r.firebaseId || r.id || r.createdAt;
                    
                    if (r.status === 'abgeschlossen' || r.status === 'completed') {
                        // Abgeschlossene: Wiederholen + Umdrehen + Bearbeiten
                        actionButtons = `
                            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-top:10px;">
                                <button onclick="rebookRide(${r.createdAt || r.id})" 
                                    style="padding:8px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                    ğŸ” Nochmal
                                </button>
                                <button onclick="reverseRouteFromHistory(${r.createdAt || r.id})" 
                                    style="padding:8px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                    ğŸ”„ Umdrehen
                                </button>
                                <button onclick="editRide('${rideIdForButtons}')" 
                                    style="padding:8px;background:#f59e0b;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                    âœï¸ Bearbeiten
                                </button>
                            </div>
                        `;
                    } else if (r.status === 'storniert') {
                        // Stornierte: Wiederholen + Umdrehen + Bearbeiten
                        actionButtons = `
                            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-top:10px;">
                                <button onclick="rebookRide(${r.createdAt || r.id})" 
                                    style="padding:8px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                    ğŸ” Nochmal
                                </button>
                                <button onclick="reverseRouteFromHistory(${r.createdAt || r.id})" 
                                    style="padding:8px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                    ğŸ”„ Umdrehen
                                </button>
                                <button onclick="editRide('${rideIdForButtons}')" 
                                    style="padding:8px;background:#f59e0b;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                    âœï¸ Bearbeiten
                                </button>
                            </div>
                        `;
                    } else {
                        // Andere Status: Nur Bearbeiten + Umdrehen (wenn nicht aktiv unterwegs)
                        if (r.status !== 'unterwegs' && r.status !== 'akzeptiert' && r.status !== 'picked_up') {
                            actionButtons = `
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;">
                                    <button onclick="editRide('${rideIdForButtons}')" 
                                        style="padding:8px;background:#f59e0b;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;">
                                        âœï¸ Bearbeiten
                                    </button>
                                    <button onclick="reverseRouteAdmin('${rideIdForButtons}')" 
                                        style="padding:8px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;">
                                        ğŸ”„ Umdrehen
                                    </button>
                                </div>
                            `;
                        }
                    }
                    
                    return `<div class="ride-card">
                        <strong>#${r.id}</strong> <span style="background:${statusColor};padding:4px 8px;border-radius:12px;font-size:12px;">${statusText}</span>
                        ${r.customerName ? '<div style="margin-top:8px;font-weight:600;">ğŸ’¾ '+r.customerName+'</div>' : ''}
                        <div style="margin-top:10px;font-size:14px;">
                            ğŸ• ${pickupTimeDisplay}<br>
                            ğŸ“ Von: ${r.pickup}<br>
                            ğŸ¯ Nach: ${r.destination}<br>
                            ğŸ“ ${r.distance} km<br>
                            ğŸ’° Preis: ${r.price}â‚¬
                            ${r.vehicle ? '<br>ğŸš— Fahrzeug: '+r.vehicle : ''}
                            ${r.vehiclePlate ? ' ('+r.vehiclePlate+')' : ''}
                        </div>
                        ${assignButton}
                        ${actionButtons}
                    </div>`;
                }).join('');
            }
            
            // ğŸš— Update Online-Fahrer Liste
            updateOnlineDriversList();
        }
        
        // ğŸš— ONLINE-FAHRER ANZEIGEN
        function updateOnlineDriversList() {
            const driversList = document.getElementById('online-drivers-list');
            if (!driversList) return;
            
            const now = Date.now();
            const onlineDrivers = [];
            
            // Durchsuche alle Fahrer
            Object.keys(drivers).forEach(vehicleId => {
                const driver = drivers[vehicleId];
                
                // Fahrer ist online wenn: online = true UND letzte Aktualisierung < 2 Min
                if (driver && driver.online) {
                    const lastUpdate = driver.timestamp || 0;
                    const minutesSinceUpdate = (now - lastUpdate) / (1000 * 60);
                    
                    // Nur als online zeigen wenn letzte Meldung < 2 Min
                    if (minutesSinceUpdate < 2) {
                        const vehicle = VEHICLES[vehicleId] || { name: driver.vehicle || vehicleId, plate: '?' };
                        const hasGPS = driver.lat && driver.lng;
                        const gpsAccuracy = driver.accuracy ? Math.round(driver.accuracy) : '?';
                        
                        onlineDrivers.push({
                            vehicleId: vehicleId,
                            vehicle: vehicle,
                            driver: driver,
                            hasGPS: hasGPS,
                            accuracy: gpsAccuracy,
                            lastUpdate: lastUpdate,
                            minutesSinceUpdate: Math.floor(minutesSinceUpdate)
                        });
                    }
                }
            });
            
            if (onlineDrivers.length === 0) {
                driversList.innerHTML = `
                    <div style="background:white;padding:20px;border-radius:8px;text-align:center;color:#999;">
                        ğŸ˜´ Keine Fahrer online
                    </div>
                `;
                return;
            }
            
            // Sortiere nach letztem Update (neueste zuerst)
            onlineDrivers.sort((a, b) => b.lastUpdate - a.lastUpdate);
            
            driversList.innerHTML = onlineDrivers.map(d => {
                const gpsStatus = d.hasGPS ? 'âœ… GPS aktiv' : 'ğŸ’¾ Kein GPS';
                const gpsColor = d.hasGPS ? '#10b981' : '#ef4444';
                const updateText = d.minutesSinceUpdate === 0 ? 'Gerade eben' : `vor ${d.minutesSinceUpdate} Min`;
                
                return `
                    <div style="background:white;padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid ${gpsColor};">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <div style="font-weight:600;font-size:15px;">
                                    ğŸš— ${d.vehicle.name}
                                </div>
                                <div style="font-size:12px;color:#666;margin-top:4px;">
                                    ${d.vehicle.plate}
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div style="color:${gpsColor};font-weight:600;font-size:13px;">
                                    ${gpsStatus}
                                </div>
                                ${d.hasGPS ? `<div style="font-size:11px;color:#999;">Â±${d.accuracy}m</div>` : ''}
                                <div style="font-size:11px;color:#999;margin-top:4px;">
                                    ${updateText}
                                </div>
                            </div>
                        </div>
                        ${d.hasGPS ? `
                            <div style="margin-top:10px;font-size:12px;color:#666;">
                                ğŸ“ ${d.driver.lat.toFixed(5)}, ${d.driver.lng.toFixed(5)}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // ğŸš— MANUELLE FAHRER-ZUWEISUNG
        function manuallyAssignRide(rideId) {
            const ride = rides.find(r => r.firebaseId === rideId);
            if (!ride) {
                alert('ğŸ’¾ Fahrt nicht gefunden!');
                return;
            }
            
            // Fahrzeug-Auswahl
            const vehicleOptions = Object.keys(VEHICLES).map(key => {
                const v = VEHICLES[key];
                return `<option value="${key}">${v.name} (${v.plate})</option>`;
            }).join('');
            
            const html = `
                <div style="background:white;padding:20px;border-radius:12px;">
                    <h3>ğŸš— Fahrer zuweisen</h3>
                    <div style="margin:15px 0;padding:15px;background:#f0f9ff;border-radius:8px;">
                        <strong>Fahrt #${ride.id}</strong><br>
                        ğŸ“ ${ride.pickup}<br>
                        ğŸ¯ ${ride.destination}<br>
                        ğŸ’° ${ride.price}â‚¬
                    </div>
                    <label style="display:block;margin:10px 0;">Fahrzeug wÃ¤hlen:</label>
                    <select id="manual-vehicle-select" style="width:100%;padding:12px;border:2px solid #667eea;border-radius:8px;font-size:14px;">
                        <option value="">-- Fahrzeug wÃ¤hlen --</option>
                        ${vehicleOptions}
                    </select>
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button onclick="confirmManualAssignment('${rideId}')" style="flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;">
                            âœ“ Zuweisen
                        </button>
                        <button onclick="closeManualAssignment()" style="flex:1;padding:12px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;">
                            âœ• Abbrechen
                        </button>
                    </div>
                </div>
            `;
            
            // Modal anzeigen
            const modal = document.createElement('div');
            modal.id = 'manual-assign-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
            modal.innerHTML = html;
            document.body.appendChild(modal);
        }
        
        async function confirmManualAssignment(rideId) {
            const vehicleId = document.getElementById('manual-vehicle-select').value;
            if (!vehicleId) {
                alert('ğŸ’¾ Bitte wÃ¤hle ein Fahrzeug!');
                return;
            }
            
            const vehicle = VEHICLES[vehicleId];
            const ride = rides.find(r => r.firebaseId === rideId);
            
            if (!ride) {
                alert('ğŸ’¾ Fahrt nicht gefunden!');
                return;
            }
            
            // Fahrt zuweisen
            await updateRide(rideId, {
                status: 'accepted',
                vehicleId: vehicleId,
                vehicle: vehicle.name,
                vehiclePlate: vehicle.plate,
                acceptedAt: Date.now(),
                adminConfirmed: true  // ğŸ†• Markiere als bestÃ¤tigt
            });
            
            // Markiere als acknowledged
            acknowledgedRides.add(ride.id);
            saveAcknowledgedRides();
            
            closeManualAssignment();
            alert(`âœ… Fahrt #${ride.id} wurde ${vehicle.name} zugewiesen!`);
        }
        
        function closeManualAssignment() {
            const modal = document.getElementById('manual-assign-modal');
            if (modal) modal.remove();
        }

        // ğŸ†• v5.31.0: EINDEUTIGE RIDE-ID GENERATOR
        function generateRideId() {
            // Format: ride_TIMESTAMP_RANDOM
            // Beispiel: ride_1733048234827_k3n9x2m4p
            const timestamp = Date.now();
            const random = Math.random().toString(36).substr(2, 9);
            const rideId = `ride_${timestamp}_${random}`;
            console.log('ğŸ†” Neue Ride-ID generiert:', rideId);
            return rideId;
        }

        // DATABASE FUNCTIONS
        
        // ğŸ”” TOAST-BENACHRICHTIGUNGEN
        // ğŸ†• v5.88.11: Screenshot-Analyse fÃ¼r WhatsApp (OCR mit Tesseract.js)
        async function analyzeScreenshot(input) {
            const file = input.files[0];
            if (!file) return;
            
            const preview = document.getElementById('ai-screenshot-preview');
            preview.style.display = 'block';
            preview.innerHTML = `
                <div style="background: white; border-radius: 6px; padding: 10px;">
                    <div style="text-align: center; color: #128C7E; font-weight: 600;">
                        â³ Analysiere Screenshot...
                    </div>
                </div>
            `;
            
            try {
                // Lade Tesseract.js falls nicht vorhanden
                if (typeof Tesseract === 'undefined') {
                    console.log('ğŸ“¦ Lade Tesseract.js...');
                    await loadScript('https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js');
                }
                
                // OCR durchfÃ¼hren
                console.log('ğŸ” Starte OCR...');
                const result = await Tesseract.recognize(file, 'deu', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const percent = Math.round(m.progress * 100);
                            preview.innerHTML = `
                                <div style="background: white; border-radius: 6px; padding: 10px;">
                                    <div style="text-align: center; color: #128C7E; font-weight: 600;">
                                        ğŸ” Lese Text... ${percent}%
                                    </div>
                                    <div style="background: #e5e7eb; border-radius: 4px; height: 8px; margin-top: 8px;">
                                        <div style="background: #25D366; height: 100%; border-radius: 4px; width: ${percent}%;"></div>
                                    </div>
                                </div>
                            `;
                        }
                    }
                });
                
                const text = result.data.text;
                console.log('âœ… OCR fertig:', text);
                
                // Text in Textarea einfÃ¼gen
                const textarea = document.getElementById('ai-input-text');
                textarea.value = text;
                
                // Vorschau mit Bild
                const imgUrl = URL.createObjectURL(file);
                preview.innerHTML = `
                    <div style="background: white; border-radius: 6px; padding: 10px;">
                        <div style="color: #10b981; font-weight: 600; margin-bottom: 8px;">âœ… Text erkannt!</div>
                        <img src="${imgUrl}" style="max-width: 100%; max-height: 150px; border-radius: 4px; margin-bottom: 8px;">
                        <div style="font-size: 12px; color: #6b7280;">Klicke jetzt auf "ğŸ” Analysieren"</div>
                    </div>
                `;
                
                showToast('âœ… Screenshot ausgelesen! Klicke auf Analysieren.');
                
            } catch (err) {
                console.error('ğŸ’¾ OCR Fehler:', err);
                preview.innerHTML = `
                    <div style="background: white; border-radius: 6px; padding: 10px; color: #ef4444;">
                        ğŸ’¾ Fehler beim Lesen: ${err.message}
                    </div>
                `;
            }
            
            // Input zurÃ¼cksetzen fÃ¼r erneutes Hochladen
            input.value = '';
        }
        
        // Hilfsfunktion: Script dynamisch laden
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                if (document.querySelector(`script[src="${src}"]`)) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // ğŸ†• v5.88.10: Aus Zwischenablage einfÃ¼gen (fÃ¼r WhatsApp Web etc.)
        async function pasteFromClipboard(targetId) {
            try {
                const text = await navigator.clipboard.readText();
                const target = document.getElementById(targetId);
                if (target && text) {
                    // Bei Textarea/Input: an Cursor-Position einfÃ¼gen oder ersetzen
                    if (target.tagName === 'TEXTAREA' || target.tagName === 'INPUT') {
                        const start = target.selectionStart;
                        const end = target.selectionEnd;
                        const currentValue = target.value;
                        target.value = currentValue.substring(0, start) + text + currentValue.substring(end);
                        target.focus();
                        // Cursor ans Ende des eingefÃ¼gten Texts
                        target.selectionStart = target.selectionEnd = start + text.length;
                    }
                    console.log('ğŸ“‹ Text eingefÃ¼gt:', text.substring(0, 50) + '...');
                    showToast('âœ… Text eingefÃ¼gt!');
                }
            } catch (err) {
                console.error('ğŸ’¾ Zwischenablage-Fehler:', err);
                showToast('ğŸ’¾ Zugriff auf Zwischenablage verweigert. Bitte Strg+V verwenden.');
            }
        }
        
        function showToast(message, type = 'info') {
            // Erstelle Toast-Element
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                font-size: 14px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease;
                max-width: 400px;
            `;
            
            // Farbe je nach Typ
            if (type === 'success') {
                toast.style.background = '#10b981';
            } else if (type === 'error') {
                toast.style.background = '#ef4444';
            } else if (type === 'warning') {
                toast.style.background = '#f59e0b';
            } else {
                toast.style.background = '#667eea';
            }
            
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Nach 3 Sekunden entfernen
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // ğŸ†• v5.86.21: LIVE-SUCHE (Auto-Complete)
        let liveSearchTimeout = null;
        let liveSearchCache = {}; // Cache fÃ¼r bessere Performance
        
        async function liveSearch(searchTerm) {
            // LÃ¶sche vorherigen Timeout
            if (liveSearchTimeout) {
                clearTimeout(liveSearchTimeout);
            }
            
            const dropdown = document.getElementById('live-search-dropdown');
            
            if (!searchTerm || searchTerm.length < 2) {
                if (dropdown) dropdown.style.display = 'none';
                return;
            }
            
            // Debounce: Warte 300ms nach letzter Eingabe
            liveSearchTimeout = setTimeout(async () => {
                console.log('ğŸ” Live-Suche:', searchTerm);
                
                // PrÃ¼fe Cache
                const cacheKey = searchTerm.toLowerCase();
                if (liveSearchCache[cacheKey]) {
                    displayLiveSearchResults(liveSearchCache[cacheKey], searchTerm);
                    return;
                }
                
                if (!isFirebaseReady) {
                    if (dropdown) dropdown.style.display = 'none';
                    return;
                }
                
                try {
                    // Suche in Firebase
                    const snapshot = await db.ref('rides').orderByChild('createdAt').limitToLast(500).once('value');
                    
                    const customerMap = new Map(); // Gruppiere nach Kunde
                    const normalizedSearch = searchTerm.toLowerCase();
                    
                    snapshot.forEach(child => {
                        const ride = child.val();
                        ride.firebaseId = child.key;
                        
                        let isMatch = false;
                        let matchKey = null;
                        
                        // Name-Match
                        if (ride.customerName) {
                            const name = ride.customerName.toLowerCase();
                            if (name.includes(normalizedSearch)) {
                                isMatch = true;
                                matchKey = ride.customerId || ride.customerPhone || ride.customerName;
                            }
                        }
                        
                        // Telefon-Match
                        if (!isMatch && ride.customerPhone) {
                            const phone = ride.customerPhone.replace(/\D/g, '');
                            const searchPhone = normalizedSearch.replace(/\D/g, '');
                            if (phone.includes(searchPhone)) {
                                isMatch = true;
                                matchKey = ride.customerId || ride.customerPhone || ride.customerName;
                            }
                        }
                        
                        if (isMatch && matchKey) {
                            if (!customerMap.has(matchKey)) {
                                customerMap.set(matchKey, {
                                    name: ride.customerName,
                                    phone: ride.customerPhone,
                                    customerId: ride.customerId,
                                    rides: [],
                                    lastRide: null
                                });
                            }
                            
                            const customer = customerMap.get(matchKey);
                            customer.rides.push(ride);
                            
                            // Update letzte Fahrt
                            if (!customer.lastRide || ride.createdAt > customer.lastRide.createdAt) {
                                customer.lastRide = ride;
                            }
                        }
                    });
                    
                    // Konvertiere zu Array und sortiere nach letzter Fahrt
                    const results = Array.from(customerMap.values())
                        .sort((a, b) => (b.lastRide?.createdAt || 0) - (a.lastRide?.createdAt || 0))
                        .slice(0, 5); // Top 5
                    
                    // Cache Ergebnis
                    liveSearchCache[cacheKey] = results;
                    
                    displayLiveSearchResults(results, searchTerm);
                    
                } catch (error) {
                    console.error('ğŸ’¾ Live-Suche Fehler:', error);
                    if (dropdown) dropdown.style.display = 'none';
                }
            }, 300); // 300ms Debounce
        }
        
        function displayLiveSearchResults(results, searchTerm) {
            const dropdown = document.getElementById('live-search-dropdown');
            if (!dropdown) return;
            
            if (results.length === 0) {
                dropdown.innerHTML = `
                    <div style="padding:15px;text-align:center;color:#6b7280;font-size:13px;">
                        ğŸ” Keine Kunden gefunden fÃ¼r "${searchTerm}"
                    </div>
                `;
                dropdown.style.display = 'block';
                return;
            }
            
            dropdown.innerHTML = results.map(customer => {
                const lastRideDate = customer.lastRide ? 
                    new Date(customer.lastRide.createdAt).toLocaleDateString('de-DE', {
                        day: '2-digit',
                        month: '2-digit',
                        year: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '?';
                
                const escapedName = (customer.name || 'Unbekannt').replace(/'/g, "\\'");
                const escapedPhone = (customer.phone || '').replace(/'/g, "\\'");
                const escapedId = (customer.customerId || '').replace(/'/g, "\\'");
                
                return `
                    <div onclick="selectLiveSearchCustomer('${escapedId}', '${escapedPhone}', '${escapedName}')" style="
                        padding:12px 15px;
                        border-bottom:1px solid #e5e7eb;
                        cursor:pointer;
                        transition:background 0.2s;
                    " onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                        <div style="display:flex;align-items:center;gap:10px;">
                            <div style="flex:1;">
                                <div style="font-weight:600;font-size:14px;color:#1f2937;margin-bottom:4px;">
                                    ğŸ’¾ ${customer.name || 'Unbekannt'}
                                </div>
                                ${customer.phone ? `<div style="font-size:12px;color:#6b7280;">ğŸ’¾ ${customer.phone}</div>` : ''}
                                <div style="font-size:11px;color:#9ca3af;margin-top:4px;">
                                    ğŸ• Letzte Fahrt: ${lastRideDate} â€¢ ${customer.rides.length} Fahrten
                                </div>
                            </div>
                            <div style="font-size:20px;color:#667eea;">â†’</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            dropdown.style.display = 'block';
        }
        
        function selectLiveSearchCustomer(customerId, phone, name) {
            // Verstecke Dropdown
            const dropdown = document.getElementById('live-search-dropdown');
            if (dropdown) dropdown.style.display = 'none';
            
            // Setze Suchfeld
            const searchInput = document.getElementById('ride-id-search');
            if (searchInput) {
                if (phone) {
                    searchInput.value = phone;
                } else if (name) {
                    searchInput.value = name;
                }
            }
            
            // FÃ¼hre vollstÃ¤ndige Suche aus
            intelligentSearch();
        }
        
        // Click auÃŸerhalb schlieÃŸt Dropdown - in DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            document.addEventListener('click', (event) => {
                const dropdown = document.getElementById('live-search-dropdown');
                const searchInput = document.getElementById('ride-id-search');
                
                if (dropdown && searchInput && 
                    !dropdown.contains(event.target) && 
                    event.target !== searchInput) {
                    dropdown.style.display = 'none';
                }
            });
            
            // ğŸ†• v5.90.18: WHATSAPP-STYLE ZEIT-AUSWAHL
            // Wenn Stunde geÃ¤ndert wird â†’ Minuten auf :00
            const hourSelect = document.getElementById('custom-hour');
            if (hourSelect) {
                hourSelect.addEventListener('change', () => {
                    const minuteSelect = document.getElementById('custom-minute');
                    if (minuteSelect) {
                        minuteSelect.value = '00';
                        console.log('ğŸ• Stunde geÃ¤ndert â†’ Minuten auf :00');
                        
                        // Trigger Slot-Check
                        if (typeof performLiveSlotCheck === 'function') {
                            performLiveSlotCheck();
                        }
                    }
                });
                console.log('âœ… WhatsApp-Style Zeit-Auswahl aktiviert');
            }
        });
        
        // ğŸ” v5.31.3: RIDE-ID SUCHE
        // ğŸ†• v5.86.0: INTELLIGENTE SUCHE
        async function intelligentSearch() {
            const input = document.getElementById('ride-id-search');
            const searchTerm = input.value.trim();
            
            if (!searchTerm) {
                showToast('ğŸ’¾ Bitte Suchbegriff eingeben!', 'error');
                return;
            }
            
            console.log('ğŸ” Intelligente Suche:', searchTerm);
            
            // ERKENNE SUCHTYP
            let searchType = 'unknown';
            let normalizedSearch = searchTerm;
            
            if (searchTerm.startsWith('ride_')) {
                searchType = 'ride_id';
                console.log('ğŸ¯ Erkannt als: Fahrt-ID');
            } else if (/^\+?\d[\d\s\-\/()]{7,}$/.test(searchTerm)) {
                searchType = 'phone';
                normalizedSearch = searchTerm.replace(/\D/g, '').slice(-10); // Letzte 10 Ziffern
                console.log('ğŸ¯ Erkannt als: Telefonnummer ->', normalizedSearch);
            } else {
                searchType = 'name';
                normalizedSearch = searchTerm.toLowerCase();
                console.log('ğŸ¯ Erkannt als: Kundenname');
            }
            
            // SUCHE DURCHFÃœHREN
            let results = [];
            
            if (searchType === 'ride_id') {
                // FAHRT-ID SUCHE (wie vorher)
                let foundRide = null;
                
                // 1. Suche in rides Array
                foundRide = rides.find(r => 
                    r.id === searchTerm || 
                    r.firebaseId === searchTerm ||
                    (r.id && r.id.toString() === searchTerm) ||
                    (r.firebaseId && r.firebaseId.toString() === searchTerm)
                );
                
                // 2. Suche in Firebase
                if (!foundRide && isFirebaseReady) {
                    try {
                        const snapshot = await db.ref('rides/' + searchTerm).once('value');
                        if (snapshot.exists()) {
                            foundRide = snapshot.val();
                            foundRide.firebaseId = searchTerm;
                            console.log('âœ… Fahrt in Firebase gefunden');
                        }
                    } catch (error) {
                        console.error('ğŸ’¾ Firebase Suche Fehler:', error);
                    }
                }
                
                // 3. Suche in localStorage
                if (!foundRide) {
                    const localHistory = JSON.parse(localStorage.getItem('rideHistory') || '[]');
                    foundRide = localHistory.find(r => 
                        r.id === searchTerm || 
                        r.firebaseId === searchTerm
                    );
                }
                
                if (foundRide) {
                    showRideDetailsModal(foundRide);
                    input.value = '';
                    return;
                } else {
                    showToast(`ğŸ’¾ Keine Fahrt gefunden mit ID: ${searchTerm}`, 'error');
                    return;
                }
                
            } else if (searchType === 'phone' || searchType === 'name') {
                // KUNDEN/TELEFON SUCHE - Suche alle Fahrten
                if (!isFirebaseReady) {
                    showToast('ğŸ’¾ Firebase nicht verbunden!', 'error');
                    return;
                }
                
                showToast('ğŸ” Suche lÃ¤uft...', 'info');
                
                try {
                    // 1ï¸âƒ£ SUCHE IN RIDES
                    const ridesSnapshot = await db.ref('rides').orderByChild('createdAt').once('value');
                    
                    ridesSnapshot.forEach(child => {
                        const ride = child.val();
                        ride.firebaseId = child.key;
                        
                        let isMatch = false;
                        
                        if (searchType === 'phone') {
                            // Telefon-Match
                            if (ride.customerPhone) {
                                const ridePhone = ride.customerPhone.replace(/\D/g, '').slice(-10);
                                if (ridePhone === normalizedSearch || ridePhone.includes(normalizedSearch)) {
                                    isMatch = true;
                                }
                            }
                        } else if (searchType === 'name') {
                            // Namen-Match (FUZZY!)
                            if (ride.customerName) {
                                const rideName = ride.customerName.toLowerCase();
                                // Exakter Match oder Teil-Match
                                if (rideName === normalizedSearch || 
                                    rideName.includes(normalizedSearch) ||
                                    normalizedSearch.includes(rideName)) {
                                    isMatch = true;
                                }
                            }
                        }
                        
                        if (isMatch) {
                            results.push(ride);
                        }
                    });
                    
                    console.log(`ğŸ“± ${results.length} Fahrten gefunden`);
                    
                    // 2ï¸âƒ£ WENN KEINE FAHRTEN: SUCHE IN CUSTOMERS!
                    if (results.length === 0 && searchType === 'name') {
                        console.log('ğŸ” Keine Fahrten gefunden - suche in Kunden-DB...');
                        
                        const customersSnapshot = await db.ref('customers').once('value');
                        const customerMatches = [];
                        
                        customersSnapshot.forEach(child => {
                            const customer = child.val();
                            const customerName = (customer.name || '').toLowerCase();
                            
                            if (customerName.includes(normalizedSearch)) {
                                customerMatches.push({
                                    id: child.key,
                                    ...customer
                                });
                            }
                        });
                        
                        if (customerMatches.length > 0) {
                            console.log(`âœ… ${customerMatches.length} Kunde(n) gefunden in CRM!`);
                            showCustomerMatchModal(customerMatches, searchTerm);
                            input.value = '';
                            return;
                        }
                    }
                    
                    if (results.length === 0) {
                        showToast(`ğŸ’¾ Keine Fahrten gefunden fÃ¼r: ${searchTerm}`, 'error');
                        return;
                    }
                    
                    // Sortiere nach Datum (neueste zuerst)
                    results.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    
                    // ZEIGE ERGEBNISSE
                    showSearchResultsModal(results, searchTerm, searchType);
                    input.value = '';
                    
                } catch (error) {
                    console.error('ğŸ’¾ Suchfehler:', error);
                    showToast('ğŸ’¾ Fehler bei der Suche!', 'error');
                }
            }
        }
        
        // ğŸ†• v5.90.5: DATENBANK BEREINIGEN - FINDE BETROFFENE FAHRTEN
        async function findDirtyRides() {
            console.log('ğŸ§¹ Suche Fahrten mit ", Beliebtes Ziel"...');
            
            const resultsDiv = document.getElementById('cleanup-results');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<div style="text-align:center;padding:20px;color:#666;"><div style="font-size:20px;margin-bottom:10px;">ğŸ”</div>Durchsuche Datenbank...</div>';
            
            try {
                const snapshot = await db.ref('rides').once('value');
                const dirtyRides = [];
                
                snapshot.forEach(child => {
                    const ride = child.val();
                    const hasInPickup = ride.pickup && ride.pickup.includes(', Beliebtes Ziel');
                    const hasInDest = ride.destination && ride.destination.includes(', Beliebtes Ziel');
                    
                    if (hasInPickup || hasInDest) {
                        dirtyRides.push({
                            id: child.key,
                            ...ride,
                            hasDirtyPickup: hasInPickup,
                            hasDirtyDest: hasInDest
                        });
                    }
                });
                
                console.log(`âœ… ${dirtyRides.length} betroffene Fahrten gefunden`);
                
                if (dirtyRides.length === 0) {
                    resultsDiv.innerHTML = `
                        <div style="text-align:center;padding:30px;background:#d1fae5;border-radius:8px;color:#065f46;">
                            <div style="font-size:48px;margin-bottom:10px;">âœ…</div>
                            <div style="font-size:18px;font-weight:700;">Datenbank ist sauber!</div>
                            <div style="margin-top:8px;font-size:14px;">Keine Fahrten mit ", Beliebtes Ziel" gefunden.</div>
                        </div>
                    `;
                    return;
                }
                
                // Sortiere nach Datum (neueste zuerst)
                dirtyRides.sort((a, b) => {
                    const timeA = a.pickupTimestamp || a.createdAt || 0;
                    const timeB = b.pickupTimestamp || b.createdAt || 0;
                    return timeB - timeA;
                });
                
                // Zeige Ergebnisse
                let html = `
                    <div style="background:#fef3c7;padding:15px;border-radius:8px;margin-bottom:15px;border:2px solid #f59e0b;">
                        <div style="font-size:16px;font-weight:700;color:#92400e;margin-bottom:8px;">
                            âš ï¸ ${dirtyRides.length} Fahrten gefunden
                        </div>
                        <div style="font-size:13px;color:#78350f;margin-bottom:12px;">
                            Diese Fahrten haben ", Beliebtes Ziel" im Pickup oder Ziel
                        </div>
                        <button onclick="cleanAllRides()" style="
                            width:100%;
                            padding:12px;
                            background:#dc2626;
                            color:white;
                            border:none;
                            border-radius:8px;
                            font-weight:700;
                            cursor:pointer;
                            font-size:14px;
                        ">
                            ğŸ§¹ ALLE ${dirtyRides.length} FAHRTEN BEREINIGEN
                        </button>
                    </div>
                    
                    <div style="max-height:500px;overflow-y:auto;">
                `;
                
                dirtyRides.forEach((ride, index) => {
                    const date = ride.pickupTimestamp ? new Date(ride.pickupTimestamp).toLocaleDateString('de-DE') : '?';
                    const time = ride.pickupTimestamp ? new Date(ride.pickupTimestamp).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'}) : '?';
                    
                    html += `
                        <div style="background:white;padding:15px;border-radius:8px;margin-bottom:10px;border:2px solid #f59e0b;">
                            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px;">
                                <div>
                                    <div style="font-weight:700;color:#1f2937;">#${index + 1} - ${date} ${time}</div>
                                    <div style="font-size:13px;color:#6b7280;margin-top:2px;">ğŸ’¾ ${ride.customerName || 'Unbekannt'}</div>
                                </div>
                                <span style="background:#fef3c7;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:700;color:#92400e;">
                                    ${ride.hasDirtyPickup && ride.hasDirtyDest ? '2x' : '1x'}
                                </span>
                            </div>
                            
                            ${ride.hasDirtyPickup ? `
                                <div style="margin-bottom:8px;">
                                    <div style="font-size:12px;color:#ef4444;font-weight:600;margin-bottom:4px;">ğŸ“ Von:</div>
                                    <div style="font-size:13px;color:#1f2937;background:#fef2f2;padding:8px;border-radius:4px;">
                                        ${ride.pickup}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${ride.hasDirtyDest ? `
                                <div style="margin-bottom:8px;">
                                    <div style="font-size:12px;color:#ef4444;font-weight:600;margin-bottom:4px;">ğŸ¯ Nach:</div>
                                    <div style="font-size:13px;color:#1f2937;background:#fef2f2;padding:8px;border-radius:4px;">
                                        ${ride.destination}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <button onclick='cleanSingleRide("${ride.id}")' style="
                                width:100%;
                                padding:10px;
                                background:#10b981;
                                color:white;
                                border:none;
                                border-radius:6px;
                                font-weight:600;
                                cursor:pointer;
                                font-size:13px;
                            ">
                                ğŸ§¹ Diese Fahrt bereinigen
                            </button>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                resultsDiv.innerHTML = html;
                
                // Speichere Liste fÃ¼r cleanAllRides
                window.dirtyRidesList = dirtyRides;
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Suchen:', error);
                resultsDiv.innerHTML = `
                    <div style="background:#fee2e2;padding:15px;border-radius:8px;color:#991b1b;text-align:center;">
                        ğŸ’¾ Fehler: ${error.message}
                    </div>
                `;
            }
        }
        
        // ğŸ†• v5.90.5: EINZELNE FAHRT BEREINIGEN
        async function cleanSingleRide(rideId) {
            console.log('ğŸ§¹ Bereinige Fahrt:', rideId);
            
            try {
                const snapshot = await db.ref(`rides/${rideId}`).once('value');
                const ride = snapshot.val();
                
                if (!ride) {
                    alert('ğŸ’¾ Fahrt nicht gefunden!');
                    return;
                }
                
                const updates = {};
                
                if (ride.pickup && ride.pickup.includes(', Beliebtes Ziel')) {
                    updates.pickup = ride.pickup.replace(/, Beliebtes Ziel/g, '');
                    console.log('  âœ… Pickup bereinigt');
                }
                
                if (ride.destination && ride.destination.includes(', Beliebtes Ziel')) {
                    updates.destination = ride.destination.replace(/, Beliebtes Ziel/g, '');
                    console.log('  âœ… Destination bereinigt');
                }
                
                if (Object.keys(updates).length > 0) {
                    await db.ref(`rides/${rideId}`).update(updates);
                    console.log('âœ… Fahrt bereinigt!');
                    showToast('âœ… Fahrt bereinigt!', 'success');
                    
                    // Aktualisiere Liste
                    setTimeout(() => findDirtyRides(), 500);
                } else {
                    showToast('âš ï¸ Nichts zu bereinigen', 'info');
                }
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler beim Bereinigen: ' + error.message);
            }
        }
        
        // ğŸ†• v5.90.5: ALLE FAHRTEN BEREINIGEN
        async function cleanAllRides() {
            if (!window.dirtyRidesList || window.dirtyRidesList.length === 0) {
                alert('ğŸ’¾ Keine Fahrten zum Bereinigen!');
                return;
            }
            
            const count = window.dirtyRidesList.length;
            
            if (!confirm(`ğŸ§¹ WIRKLICH ${count} FAHRTEN BEREINIGEN?\n\nDies entfernt ", Beliebtes Ziel" aus allen betroffenen Fahrten.\n\nâš ï¸ Dies kann nicht rÃ¼ckgÃ¤ngig gemacht werden!`)) {
                return;
            }
            
            console.log(`ğŸ§¹ Starte Massen-Bereinigung: ${count} Fahrten...`);
            
            const resultsDiv = document.getElementById('cleanup-results');
            resultsDiv.innerHTML = `
                <div style="text-align:center;padding:30px;">
                    <div style="font-size:32px;margin-bottom:15px;">ğŸ§¹</div>
                    <div style="font-size:18px;font-weight:700;color:#1f2937;margin-bottom:10px;">
                        Bereinige ${count} Fahrten...
                    </div>
                    <div id="cleanup-progress" style="font-size:14px;color:#6b7280;">
                        0 / ${count}
                    </div>
                </div>
            `;
            
            let cleaned = 0;
            let errors = 0;
            
            try {
                for (const ride of window.dirtyRidesList) {
                    try {
                        const updates = {};
                        
                        if (ride.pickup && ride.pickup.includes(', Beliebtes Ziel')) {
                            updates.pickup = ride.pickup.replace(/, Beliebtes Ziel/g, '');
                        }
                        
                        if (ride.destination && ride.destination.includes(', Beliebtes Ziel')) {
                            updates.destination = ride.destination.replace(/, Beliebtes Ziel/g, '');
                        }
                        
                        if (Object.keys(updates).length > 0) {
                            await db.ref(`rides/${ride.id}`).update(updates);
                            cleaned++;
                        }
                        
                        // Update Progress
                        document.getElementById('cleanup-progress').textContent = `${cleaned} / ${count}`;
                        
                    } catch (error) {
                        console.error('ğŸ’¾ Fehler bei Fahrt:', ride.id, error);
                        errors++;
                    }
                }
                
                console.log(`âœ… Bereinigung abgeschlossen: ${cleaned} bereinigt, ${errors} Fehler`);
                
                resultsDiv.innerHTML = `
                    <div style="text-align:center;padding:30px;background:#d1fae5;border-radius:8px;">
                        <div style="font-size:48px;margin-bottom:15px;">âœ…</div>
                        <div style="font-size:20px;font-weight:700;color:#065f46;margin-bottom:10px;">
                            Bereinigung abgeschlossen!
                        </div>
                        <div style="font-size:14px;color:#059669;">
                            ${cleaned} Fahrten bereinigt
                            ${errors > 0 ? `<br>${errors} Fehler` : ''}
                        </div>
                        <button onclick="findDirtyRides()" style="
                            margin-top:20px;
                            padding:12px 24px;
                            background:#10b981;
                            color:white;
                            border:none;
                            border-radius:8px;
                            font-weight:700;
                            cursor:pointer;
                        ">
                            ğŸ” Erneut prÃ¼fen
                        </button>
                    </div>
                `;
                
                showToast(`âœ… ${cleaned} Fahrten bereinigt!`, 'success');
                
                // LÃ¶sche gespeicherte Liste
                delete window.dirtyRidesList;
                
            } catch (error) {
                console.error('ğŸ’¾ Fataler Fehler:', error);
                alert('ğŸ’¾ Fehler bei der Bereinigung: ' + error.message);
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.90.7: ALTE AKTIVE FAHRTEN FINDEN & ABSCHLIESSEN
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function findOldActiveRides() {
            console.log('ğŸ” Suche alte aktive Fahrten...');
            
            const resultsDiv = document.getElementById('old-rides-results');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                <div style="text-align:center;padding:30px;">
                    <div style="font-size:32px;margin-bottom:15px;">ğŸ”</div>
                    <div style="font-size:16px;color:#6b7280;">Durchsuche Datenbank...</div>
                </div>
            `;
            
            try {
                // Lade alle Fahrten
                const snapshot = await db.ref('rides').once('value');
                const rides = [];
                
                snapshot.forEach(child => {
                    rides.push({
                        id: child.key,
                        ...child.val()
                    });
                });
                
                console.log(`ğŸ“± Gesamt-Fahrten: ${rides.length}`);
                
                // Filtere aktive Fahrten
                const activeRides = rides.filter(r => 
                    r.status === 'accepted' || 
                    r.status === 'in_progress' ||
                    r.status === 'new'
                );
                
                console.log(`ğŸš— Aktive Fahrten: ${activeRides.length}`);
                
                // Finde alte Fahrten (Ã¤lter als 24h)
                const now = Date.now();
                const oneDayAgo = now - (24 * 60 * 60 * 1000);
                
                const oldActiveRides = activeRides.filter(r => {
                    const rideTime = r.pickupTimestamp || r.timestamp || 0;
                    return rideTime < oneDayAgo;
                });
                
                console.log(`â° Alte aktive Fahrten (>24h): ${oldActiveRides.length}`);
                
                // Speichere fÃ¼r spÃ¤tere Nutzung
                window.oldActiveRidesList = oldActiveRides;
                
                if (oldActiveRides.length === 0) {
                    resultsDiv.innerHTML = `
                        <div style="text-align:center;padding:30px;background:#d1fae5;border-radius:8px;">
                            <div style="font-size:48px;margin-bottom:15px;">âœ…</div>
                            <div style="font-size:18px;font-weight:700;color:#065f46;margin-bottom:8px;">
                                Keine alten Fahrten gefunden!
                            </div>
                            <div style="font-size:14px;color:#059669;">
                                Alle aktiven Fahrten sind aktuell (< 24h)
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Zeige Ergebnisse
                let html = `
                    <div style="background:#fef2f2;border:2px solid #ef4444;border-radius:8px;padding:15px;margin-bottom:15px;">
                        <div style="font-size:18px;font-weight:700;color:#991b1b;margin-bottom:10px;">
                            âš ï¸ ${oldActiveRides.length} alte Fahrten gefunden!
                        </div>
                        <div style="font-size:13px;color:#7f1d1d;margin-bottom:10px;">
                            Diese Fahrten sind als "aktiv" markiert, aber Ã¤lter als 24 Stunden.
                            Dies fÃ¼hrt zu erhÃ¶htem Surge Pricing!
                        </div>
                `;
                
                // Zeige erste 5 als Vorschau
                html += `<div style="background:white;border-radius:6px;padding:10px;margin-bottom:10px;max-height:300px;overflow-y:auto;">`;
                oldActiveRides.slice(0, 10).forEach((ride, index) => {
                    const rideDate = new Date(ride.pickupTimestamp || ride.timestamp || 0);
                    const hoursAgo = Math.floor((now - (ride.pickupTimestamp || ride.timestamp || 0)) / (1000 * 60 * 60));
                    
                    html += `
                        <div style="padding:10px;border-bottom:1px solid #f3f4f6;display:flex;justify-content:space-between;align-items:center;">
                            <div style="flex:1;">
                                <div style="font-weight:600;color:#1f2937;margin-bottom:4px;">
                                    ${ride.pickup || '?'} â†’ ${ride.destination || '?'}
                                </div>
                                <div style="font-size:12px;color:#6b7280;">
                                    ğŸ“… ${rideDate.toLocaleDateString('de-DE')} ${rideDate.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})}
                                    Â· â° vor ${hoursAgo}h
                                    Â· ğŸš— ${ride.driverName || 'Keiner'}
                                </div>
                            </div>
                            <button onclick="completeOldRide('${ride.id}')" style="
                                padding:6px 12px;
                                background:#10b981;
                                color:white;
                                border:none;
                                border-radius:6px;
                                font-weight:600;
                                font-size:12px;
                                cursor:pointer;
                                white-space:nowrap;
                            ">
                                âœ… AbschlieÃŸen
                            </button>
                        </div>
                    `;
                });
                html += `</div>`;
                
                if (oldActiveRides.length > 10) {
                    html += `<div style="font-size:13px;color:#6b7280;text-align:center;margin-top:8px;">... und ${oldActiveRides.length - 10} weitere</div>`;
                }
                
                html += `
                        <button onclick="massCompleteOldRides()" style="
                            width:100%;
                            padding:12px;
                            background:#ef4444;
                            color:white;
                            border:none;
                            border-radius:8px;
                            font-weight:700;
                            cursor:pointer;
                            margin-top:10px;
                        ">
                            âœ… ALLE ${oldActiveRides.length} FAHRTEN ABSCHLIESSEN
                        </button>
                    </div>
                `;
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Suchen:', error);
                resultsDiv.innerHTML = `
                    <div style="text-align:center;padding:20px;background:#fef2f2;border-radius:8px;border:2px solid #ef4444;">
                        <div style="font-size:32px;margin-bottom:10px;">ğŸ’¾</div>
                        <div style="font-weight:700;color:#991b1b;">Fehler beim Suchen</div>
                        <div style="font-size:13px;color:#7f1d1d;margin-top:5px;">${error.message}</div>
                    </div>
                `;
            }
        }
        
        async function completeOldRide(rideId) {
            if (!confirm('Diese Fahrt auf "Abgeschlossen" setzen?')) return;
            
            try {
                await db.ref(`rides/${rideId}`).update({
                    status: 'completed',
                    completedAt: Date.now(),
                    completedBy: 'cleanup-tool',
                    completedNote: 'Automatisch abgeschlossen (>24h alt)'
                });
                
                showToast('âœ… Fahrt abgeschlossen!', 'success');
                
                // Aktualisiere Liste
                findOldActiveRides();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        async function massCompleteOldRides() {
            if (!window.oldActiveRidesList || window.oldActiveRidesList.length === 0) {
                alert('ğŸ’¾ Keine Fahrten gefunden!');
                return;
            }
            
            const count = window.oldActiveRidesList.length;
            
            if (!confirm(`ğŸš— WIRKLICH ${count} FAHRTEN ABSCHLIESSEN?\n\nAlle alten "aktiven" Fahrten werden auf "Abgeschlossen" gesetzt.\nDies senkt das Surge Pricing!\n\nâš ï¸ Dies kann nicht rÃ¼ckgÃ¤ngig gemacht werden!`)) {
                return;
            }
            
            console.log(`ğŸ”„ Starte Massen-Abschluss: ${count} Fahrten...`);
            
            const resultsDiv = document.getElementById('old-rides-results');
            resultsDiv.innerHTML = `
                <div style="text-align:center;padding:30px;">
                    <div style="font-size:32px;margin-bottom:15px;">ğŸ”„</div>
                    <div style="font-size:18px;font-weight:700;color:#1f2937;margin-bottom:10px;">
                        SchlieÃŸe ${count} Fahrten ab...
                    </div>
                    <div id="complete-progress" style="font-size:14px;color:#6b7280;">
                        0 / ${count}
                    </div>
                </div>
            `;
            
            let completed = 0;
            let errors = 0;
            
            try {
                for (const ride of window.oldActiveRidesList) {
                    try {
                        await db.ref(`rides/${ride.id}`).update({
                            status: 'completed',
                            completedAt: Date.now(),
                            completedBy: 'cleanup-tool',
                            completedNote: 'Automatisch abgeschlossen (>24h alt)'
                        });
                        completed++;
                        
                        // Update Progress
                        const progressEl = document.getElementById('complete-progress');
                        if (progressEl) {
                            progressEl.textContent = `${completed} / ${count}`;
                        }
                        
                    } catch (error) {
                        console.error('ğŸ’¾ Fehler bei Fahrt:', ride.id, error);
                        errors++;
                    }
                }
                
                console.log(`âœ… Abschluss abgeschlossen: ${completed} abgeschlossen, ${errors} Fehler`);
                
                resultsDiv.innerHTML = `
                    <div style="text-align:center;padding:30px;background:#d1fae5;border-radius:8px;">
                        <div style="font-size:48px;margin-bottom:15px;">âœ…</div>
                        <div style="font-size:20px;font-weight:700;color:#065f46;margin-bottom:10px;">
                            Abschluss erfolgreich!
                        </div>
                        <div style="font-size:14px;color:#059669;margin-bottom:15px;">
                            ${completed} Fahrten abgeschlossen
                            ${errors > 0 ? `<br>${errors} Fehler` : ''}
                        </div>
                        <div style="background:white;padding:12px;border-radius:6px;margin-bottom:15px;">
                            <div style="font-size:13px;color:#065f46;">
                                ğŸ’¡ <strong>Surge Pricing sollte jetzt niedriger sein!</strong><br>
                                Reload die Seite um die Ã„nderungen zu sehen.
                            </div>
                        </div>
                        <button onclick="location.reload()" style="
                            margin-right:10px;
                            padding:12px 24px;
                            background:#10b981;
                            color:white;
                            border:none;
                            border-radius:8px;
                            font-weight:700;
                            cursor:pointer;
                        ">
                            ğŸ”„ Seite neu laden
                        </button>
                        <button onclick="findOldActiveRides()" style="
                            padding:12px 24px;
                            background:#667eea;
                            color:white;
                            border:none;
                            border-radius:8px;
                            font-weight:700;
                            cursor:pointer;
                        ">
                            ğŸ” Erneut prÃ¼fen
                        </button>
                    </div>
                `;
                
                showToast(`âœ… ${completed} Fahrten abgeschlossen!`, 'success');
                
                // LÃ¶sche gespeicherte Liste
                delete window.oldActiveRidesList;
                
            } catch (error) {
                console.error('ğŸ’¾ Fataler Fehler:', error);
                alert('ğŸ’¾ Fehler beim AbschlieÃŸen: ' + error.message);
            }
        }
        
        // ğŸ†• v5.86.0: SUCH-ERGEBNISSE MODAL
        function showSearchResultsModal(results, searchTerm, searchType) {
            // Entferne altes Modal
            const oldModal = document.getElementById('search-results-modal');
            if (oldModal) oldModal.remove();
            
            // Berechne Statistiken
            let totalRevenue = 0;
            let completedCount = 0;
            let cancelledCount = 0;
            
            results.forEach(r => {
                if (r.status === 'completed') {
                    completedCount++;
                    totalRevenue += parseFloat(r.price) || 0;
                } else if (r.status === 'storniert' || r.status === 'cancelled') {
                    cancelledCount++;
                }
            });
            
            const searchTypeLabel = {
                'phone': 'ğŸ’¾ Telefon',
                'name': 'ğŸ’¾ Kunde'
            };
            
            // Speichere Ergebnisse global fÃ¼r Details-Zugriff
            window.searchResults = results;
            
            // Modal HTML
            const modal = document.createElement('div');
            modal.id = 'search-results-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;';
            
            modal.innerHTML = `
                <div style="background:white;border-radius:16px;max-width:700px;width:100%;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                    <!-- Header -->
                    <div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;border-radius:16px 16px 0 0;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                            <h3 style="margin:0;font-size:20px;">ğŸ” Suchergebnisse</h3>
                            <button onclick="document.getElementById('search-results-modal').remove()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;">Ã—</button>
                        </div>
                        <div style="font-size:14px;opacity:0.95;">
                            ${searchTypeLabel[searchType]} â€¢ <strong>${searchTerm}</strong>
                        </div>
                    </div>
                    
                    <!-- Statistiken -->
                    <div style="background:#f0fdf4;padding:15px;border-bottom:1px solid #e5e7eb;">
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;text-align:center;">
                            <div>
                                <div style="font-size:24px;font-weight:bold;color:#16a34a;">${results.length}</div>
                                <div style="font-size:12px;color:#666;">Gesamt</div>
                            </div>
                            <div>
                                <div style="font-size:24px;font-weight:bold;color:#2563eb;">${completedCount}</div>
                                <div style="font-size:12px;color:#666;">Abgeschlossen</div>
                            </div>
                            <div>
                                <div style="font-size:24px;font-weight:bold;color:#16a34a;">${totalRevenue.toFixed(2)}â‚¬</div>
                                <div style="font-size:12px;color:#666;">Umsatz</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fahrten Liste -->
                    <div style="flex:1;overflow-y:auto;padding:15px;">
                        ${results.map((ride, index) => {
                            const date = ride.createdAt ? new Date(ride.createdAt).toLocaleDateString('de-DE', {
                                day: '2-digit', month: '2-digit', year: '2-digit'
                            }) : '?';
                            const time = ride.createdAt ? new Date(ride.createdAt).toLocaleTimeString('de-DE', {
                                hour: '2-digit', minute: '2-digit'
                            }) : '';
                            
                            let statusColor = '#666';
                            let statusIcon = 'â³';
                            if (ride.status === 'completed') {
                                statusColor = '#16a34a';
                                statusIcon = 'âœ…';
                            } else if (ride.status === 'storniert' || ride.status === 'cancelled') {
                                statusColor = '#dc2626';
                                statusIcon = 'ğŸ’¾';
                            } else if (ride.status === 'accepted' || ride.status === 'picked_up') {
                                statusColor = '#2563eb';
                                statusIcon = 'ğŸš—';
                            }
                            
                            return `
                                <div style="background:white;border:1px solid #e5e7eb;border-radius:8px;padding:12px;margin-bottom:10px;">
                                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
                                        <div>
                                            <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
                                                <span style="color:${statusColor};font-weight:600;">${statusIcon}</span>
                                                <span style="font-size:13px;color:#666;">${date} ${time}</span>
                                            </div>
                                            <div style="font-weight:600;font-size:15px;color:#1f2937;">
                                                ${ride.customerName || 'Unbekannt'}
                                            </div>
                                            ${ride.customerPhone ? `<div style="font-size:13px;color:#6b7280;">ğŸ’¾ ${ride.customerPhone}</div>` : ''}
                                        </div>
                                        <div style="text-align:right;">
                                            <div style="font-weight:700;font-size:18px;color:#16a34a;">${ride.price || '?'}â‚¬</div>
                                            <div style="display:flex;gap:6px;margin-top:6px;flex-wrap:wrap;justify-content:flex-end;">
                                                <button onclick="document.getElementById('search-results-modal').remove(); showRideDetailsModal(window.searchResults[${index}])" style="padding:6px 12px;background:#667eea;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;font-weight:600;">
                                                    ğŸ“‹ Details
                                                </button>
                                                <button onclick="document.getElementById('search-results-modal').remove(); editRide(window.searchResults[${index}].firebaseId || window.searchResults[${index}].id)" style="padding:6px 12px;background:#10b981;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;font-weight:600;">
                                                    âœï¸ Bearbeiten
                                                </button>
                                                <button onclick="document.getElementById('search-results-modal').remove(); copyRideFromSearch(${index})" style="padding:6px 12px;background:#f59e0b;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;font-weight:600;">
                                                    ğŸ“‹ Kopieren
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="font-size:13px;color:#333;padding:8px;background:#f9fafb;border-radius:6px;">
                                        ğŸ“ ${ride.pickup || '?'} â†’ ${ride.destination || '?'}
                                    </div>
                                    ${ride.vehicle ? `<div style="font-size:12px;color:#888;margin-top:6px;">ğŸš— ${ride.vehicle}</div>` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log(`âœ… ${results.length} Ergebnisse angezeigt`);
        }
        
        async function searchRideById() {
            const input = document.getElementById('ride-id-search');
            const searchId = input.value.trim();
            
            if (!searchId) {
                alert('ğŸ’¾ Bitte eine Ride-ID eingeben!');
                return;
            }
            
            console.log('ğŸ” Suche nach Ride-ID:', searchId);
            
            // Suche in allen Quellen
            let foundRide = null;
            
            // 1. Suche in Firebase (aktuelle rides)
            foundRide = rides.find(r => 
                r.id === searchId || 
                r.firebaseId === searchId ||
                (r.id && r.id.toString() === searchId) ||
                (r.firebaseId && r.firebaseId.toString() === searchId)
            );
            
            // 2. Falls nicht gefunden, suche in Firebase direkt
            if (!foundRide && isFirebaseReady) {
                try {
                    const snapshot = await db.ref('rides/' + searchId).once('value');
                    if (snapshot.exists()) {
                        foundRide = snapshot.val();
                        foundRide.firebaseId = searchId;
                        console.log('âœ… Fahrt in Firebase gefunden:', searchId);
                    }
                } catch (error) {
                    console.error('ğŸ’¾ Firebase Suche Fehler:', error);
                }
            }
            
            // 3. Falls immer noch nicht gefunden, suche in localStorage
            if (!foundRide) {
                const localHistory = JSON.parse(localStorage.getItem('rideHistory') || '[]');
                foundRide = localHistory.find(r => 
                    r.id === searchId || 
                    r.firebaseId === searchId ||
                    (r.id && r.id.toString() === searchId) ||
                    (r.firebaseId && r.firebaseId.toString() === searchId)
                );
                if (foundRide) {
                    console.log('âœ… Fahrt in localStorage gefunden:', searchId);
                }
            }
            
            // Ergebnis anzeigen
            if (foundRide) {
                console.log('âœ… Fahrt gefunden:', foundRide);
                showRideDetailsModal(foundRide);
                input.value = ''; // Input leeren
            } else {
                alert(`ğŸ’¾ Keine Fahrt gefunden mit ID:\n\n${searchId}\n\nğŸ’¡ PrÃ¼fe ob die ID korrekt ist.`);
            }
        }
        
        // ğŸ†• v5.86.20: HELPER - WARTE BIS ELEMENT EXISTIERT
        async function waitForElement(elementId, maxWaitMs = 3000) {
            const startTime = Date.now();
            
            while (Date.now() - startTime < maxWaitMs) {
                const element = document.getElementById(elementId);
                if (element) {
                    return element; // Element gefunden!
                }
                // Warte 50ms und versuche nochmal
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            
            // Timeout - Element nicht gefunden
            console.error(`â±ï¸ Timeout: Element '${elementId}' nicht gefunden nach ${maxWaitMs}ms`);
            return null;
        }
        
        // ğŸ†• v5.86.17: FAHRT KOPIEREN AUS SUCHERGEBNISSEN
        async function copyRideFromSearch(index) {
            const ride = window.searchResults[index];
            if (!ride) {
                alert('ğŸ’¾ Fahrt nicht gefunden!');
                return;
            }
            
            console.log('ğŸ“‹ Kopiere Fahrt:', ride);
            
            // Setze aktuelle Zeit + 1 Stunde als Standard
            const now = new Date();
            now.setHours(now.getHours() + 1);
            const nowYear = now.getFullYear();
            const nowMonth = String(now.getMonth() + 1).padStart(2, '0');
            const nowDay = String(now.getDate()).padStart(2, '0');
            const nowHours = String(now.getHours()).padStart(2, '0');
            const nowMinutes = String(now.getMinutes()).padStart(2, '0');
            
            // ğŸ†• v5.86.20: ERST Modal Ã¶ffnen
            await openQuickBookingModal();
            
            // ğŸ†• v5.86.20: WARTE bis Felder existieren!
            console.log('â³ Warte auf Quick-Booking Felder...');
            
            const dateField = await waitForElement('quick-booking-date');
            
            if (!dateField) {
                alert('ğŸ’¾ Fehler: Schnellbuchungs-Modal konnte nicht geladen werden! Bitte erneut versuchen.');
                return;
            }
            
            // Jetzt alle Felder fÃ¼llen (Element existiert garantiert!)
            const timeField = document.getElementById('quick-booking-time');
            const pickupField = document.getElementById('quick-booking-pickup');
            const destField = document.getElementById('quick-booking-destination');
            const passengersField = document.getElementById('quick-booking-passengers');
            const notesField = document.getElementById('quick-booking-notes');
            const vehicleField = document.getElementById('quick-booking-vehicle');
            
            if (dateField) dateField.value = `${nowYear}-${nowMonth}-${nowDay}`;
            if (timeField) timeField.value = `${nowHours}:${nowMinutes}`;
            if (pickupField) pickupField.value = ride.pickup || '';
            if (destField) destField.value = ride.destination || '';
            if (passengersField) passengersField.value = ride.passengers || 1;
            if (notesField) notesField.value = ride.notes || '';
            if (vehicleField) vehicleField.value = ''; // Kein Fahrzeug vorgewÃ¤hlt
            
            // Kunde suchen und vorauswÃ¤hlen
            const customerSearch = document.getElementById('quick-booking-customer-search');
            const customerSelect = document.getElementById('quick-booking-customer');
            
            if (ride.customerId && customerSelect) {
                // Suche Kunde in allCustomers
                const customer = allCustomers.find(c => c.id === ride.customerId);
                if (customer) {
                    customerSelect.value = customer.id;
                    if (customerSearch) {
                        customerSearch.value = customer.name;
                    }
                } else if (ride.customerName && customerSearch) {
                    customerSearch.value = ride.customerName;
                }
            } else if (ride.customerName && customerSearch) {
                customerSearch.value = ride.customerName;
            }
            
            // Koordinaten Ã¼bertragen (falls vorhanden)
            if (ride.pickupCoords) {
                window.qbPickupCoords = ride.pickupCoords;
            }
            if (ride.destCoords) {
                window.qbDestCoords = ride.destCoords;
            }
            
            showToast('ğŸ“‹ Fahrt zum Kopieren geladen!', 'success');
            console.log('âœ… Felder gefÃ¼llt!');
        }
        
        // ğŸ†• v5.31.3: FAHRT-DETAILS MODAL
        
        // ğŸ†• v5.86.27: KUNDEN-MATCH MODAL (wenn keine Fahrten aber Kunde gefunden)
        function showCustomerMatchModal(customers, searchTerm) {
            // Entferne altes Modal
            const oldModal = document.getElementById('customer-match-modal');
            if (oldModal) oldModal.remove();
            
            // Modal HTML
            const modal = document.createElement('div');
            modal.id = 'customer-match-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;';
            
            modal.innerHTML = `
                <div style="background:white;border-radius:16px;max-width:600px;width:100%;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                    <!-- Header -->
                    <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:20px;border-radius:16px 16px 0 0;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                            <h3 style="margin:0;font-size:20px;">ğŸ’¾ Kunde gefunden im CRM</h3>
                            <button onclick="document.getElementById('customer-match-modal').remove()" 
                                    style="background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;transition:all 0.3s;">
                                âœ•
                            </button>
                        </div>
                        <div style="font-size:14px;opacity:0.95;">
                            ğŸ” Suche nach: <strong>${searchTerm}</strong>
                        </div>
                        <div style="font-size:13px;opacity:0.9;margin-top:8px;">
                            â„¹ï¸ Keine Fahrten gefunden, aber ${customers.length} Kunde(n) im CRM
                        </div>
                    </div>
                    
                    <!-- Kunden-Liste -->
                    <div style="flex:1;overflow-y:auto;padding:16px;">
                        ${customers.map(c => `
                            <div style="background:#f0fdf4;border:2px solid #10b981;border-radius:12px;padding:16px;margin-bottom:12px;">
                                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
                                    <div style="flex:1;">
                                        <div style="font-size:18px;font-weight:700;color:#065f46;margin-bottom:4px;">${c.name || 'Unbekannt'}</div>
                                        ${c.phone ? `<div style="font-size:14px;color:#048257;margin-bottom:2px;">ğŸ’¾ ${c.phone}</div>` : ''}
                                        ${c.email ? `<div style="font-size:13px;color:#059669;margin-bottom:2px;">ğŸ“§ ${c.email}</div>` : ''}
                                        ${c.address ? `<div style="font-size:13px;color:#059669;">ğŸ“ ${c.address}</div>` : ''}
                                    </div>
                                </div>
                                
                                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;padding:12px;background:white;border-radius:8px;margin-bottom:12px;">
                                    <div style="text-align:center;">
                                        <div style="font-size:20px;font-weight:700;color:#10b981;">${c.totalRides || 0}</div>
                                        <div style="font-size:11px;color:#6b7280;">Fahrten</div>
                                    </div>
                                    <div style="text-align:center;">
                                        <div style="font-size:20px;font-weight:700;color:#10b981;">${(c.totalRevenue || 0).toFixed(0)}â‚¬</div>
                                        <div style="font-size:11px;color:#6b7280;">Umsatz</div>
                                    </div>
                                    <div style="text-align:center;">
                                        <div style="font-size:20px;font-weight:700;color:#10b981;">${c.lastRide ? new Date(c.lastRide).toLocaleDateString('de-DE', {day:'2-digit',month:'2-digit'}) : 'Nie'}</div>
                                        <div style="font-size:11px;color:#6b7280;">Letzte Fahrt</div>
                                    </div>
                                </div>
                                
                                ${c.notes ? `
                                <div style="background:#fef3c7;border-left:3px solid #f59e0b;padding:10px;border-radius:6px;margin-bottom:12px;">
                                    <div style="font-size:11px;color:#92400e;font-weight:600;margin-bottom:4px;">ğŸ“ NOTIZEN:</div>
                                    <div style="font-size:12px;color:#78350f;">${c.notes}</div>
                                </div>
                                ` : ''}
                                
                                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                                    <button onclick="bookForCustomer('${c.id}')" 
                                            style="flex:1;min-width:120px;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px;transition:all 0.3s;"
                                            onmouseover="this.style.background='#059669'"
                                            onmouseout="this.style.background='#10b981'">
                                        ğŸš• Fahrt buchen
                                    </button>
                                    <button onclick="showCustomerHistory('${c.id}', '${(c.name || '').replace(/'/g, "\\'")}', '${(c.phone || '').replace(/'/g, "\\'")}'); document.getElementById('customer-match-modal').remove();" 
                                            style="flex:1;min-width:120px;padding:12px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px;transition:all 0.3s;"
                                            onmouseover="this.style.background='#2563eb'"
                                            onmouseout="this.style.background='#3b82f6'">
                                        ğŸ“‹ Fahrt-Historie
                                    </button>
                                    <button onclick="openInvoiceForCustomer('${c.id}', '${(c.name || '').replace(/'/g, "\\'")}', '${(c.phone || '').replace(/'/g, "\\'")}', '${(c.address || '').replace(/'/g, "\\'")}'); document.getElementById('customer-match-modal').remove();" 
                                            style="flex:1;min-width:120px;padding:12px;background:#f59e0b;color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px;transition:all 0.3s;"
                                            onmouseover="this.style.background='#d97706'"
                                            onmouseout="this.style.background='#f59e0b'">
                                        ğŸ“± Rechnung erstellen
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Footer -->
                    <div style="padding:16px;background:#f9fafb;border-top:1px solid #e5e7eb;border-radius:0 0 16px 16px;">
                        <div style="font-size:12px;color:#6b7280;text-align:center;">
                            ğŸ’¡ Klicke auf "Fahrt buchen" um direkt eine neue Fahrt fÃ¼r den Kunden anzulegen
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        
        // ğŸ†• v5.90.270: WRAPPER fÃ¼r showRideDetailsModal (mit ID)
        function showRideDetails(rideId) {
            const ride = rides.find(r => r.firebaseId === rideId || r.id === rideId);
            if (!ride) {
                alert('ğŸ’¾ Fahrt nicht gefunden!');
                return;
            }
            showRideDetailsModal(ride);
        }
        
        function showRideDetailsModal(ride) {
            // Entferne altes Modal falls vorhanden
            const oldModal = document.getElementById('ride-details-modal');
            if (oldModal) oldModal.remove();
            
            // Formatiere Zeitstempel
            const createdTime = ride.createdAt ? new Date(ride.createdAt).toLocaleString('de-DE') : 'Unbekannt';
            const pickupTime = ride.pickupTimestamp ? new Date(ride.pickupTimestamp).toLocaleString('de-DE') : ride.pickupTime || 'Sofort';
            
            // Status formatieren
            const statusColors = {
                'new': '#3b82f6',
                'vorbestellt': '#f59e0b',
                'accepted': '#10b981',
                'picked_up': '#8b5cf6',
                'completed': '#10b981',
                'storniert': '#ef4444',
                'cancelled': '#ef4444'
            };
            const statusColor = statusColors[ride.status] || '#6b7280';
            
            const statusNames = {
                'new': 'ğŸ†• Neu',
                'vorbestellt': 'ğŸ“… Vorbestellt',
                'accepted': 'âœ… Angenommen',
                'picked_up': 'ğŸš— Unterwegs',
                'completed': 'âœ… Abgeschlossen',
                'storniert': 'ğŸ—‘ï¸ Storniert',
                'cancelled': 'ğŸ—‘ï¸ Storniert'
            };
            const statusName = statusNames[ride.status] || ride.status;
            
            // Modal erstellen - ğŸ†• v5.90.525: MOBIL-OPTIMIERT!
            const modal = document.createElement('div');
            modal.id = 'ride-details-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.85);
                z-index: 999999;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0;
                box-sizing: border-box;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            `;
            
            // ğŸ†• v5.90.525: SCHLIESSEN bei Klick auf Hintergrund
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 20px 20px 0 0;
                    width: 100%;
                    max-width: 100%;
                    max-height: 95vh;
                    overflow-y: auto;
                    box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
                    position: relative;
                    margin-top: auto;
                    animation: slideUp 0.3s ease-out;
                " onclick="event.stopPropagation()">
                    
                    <style>
                        @keyframes slideUp {
                            from { transform: translateY(100%); }
                            to { transform: translateY(0); }
                        }
                    </style>
                    
                    <!-- ğŸ†• v5.90.525: GROSSE SCHLIESSEN-BAR OBEN! -->
                    <div style="
                        padding: 15px;
                        text-align: center;
                        border-bottom: 1px solid #e5e7eb;
                        background: #f9fafb;
                        border-radius: 20px 20px 0 0;
                        position: sticky;
                        top: 0;
                        z-index: 10;
                    ">
                        <div style="
                            width: 40px;
                            height: 5px;
                            background: #d1d5db;
                            border-radius: 10px;
                            margin: 0 auto 10px auto;
                        "></div>
                        <button onclick="this.closest('#ride-details-modal').remove()" style="
                            width: 100%;
                            padding: 12px;
                            background: #ef4444;
                            color: white;
                            border: none;
                            border-radius: 12px;
                            font-weight: 700;
                            font-size: 16px;
                            cursor: pointer;
                        ">
                            âœ• SCHLIEáºEN
                        </button>
                    </div>
                    
                    <!-- Content -->
                    <div style="padding:20px;">
                        <!-- Ride-ID -->
                        <div style="background:#f9fafb;padding:15px;border-radius:12px;margin-bottom:20px;border:2px solid #e5e7eb;">
                            <div style="font-size:12px;font-weight:600;color:#6b7280;margin-bottom:5px;">RIDE-ID</div>
                            <div style="font-family:monospace;font-size:14px;font-weight:600;color:#1f2937;word-break:break-all;">
                                ${ride.firebaseId || ride.id || 'unbekannt'}
                            </div>
                        </div>
                        
                        <!-- Status Badge -->
                        <div style="display:inline-block;background:${statusColor};color:white;padding:8px 16px;border-radius:20px;font-weight:600;font-size:14px;margin-bottom:20px;">
                            ${statusName}
                        </div>
                        
                        <!-- Kunde -->
                        <div style="margin-bottom:15px;">
                            <div style="font-size:12px;font-weight:600;color:#6b7280;margin-bottom:5px;">KUNDE</div>
                            <div style="font-size:16px;font-weight:600;color:#1f2937;">ğŸ’¾ ${ride.customerName || 'Unbekannt'}</div>
                            ${ride.customerPhone ? `
                            <div style="margin-top:8px;">
                                <a href="tel:${ride.customerPhone}" style="display:inline-flex;align-items:center;gap:6px;padding:8px 12px;background:#10b981;color:white;text-decoration:none;border-radius:8px;font-weight:600;font-size:14px;transition:all 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                                    ğŸ’¾ ${ride.customerPhone}
                                </a>
                            </div>
                            ` : '<div style="font-size:14px;color:#6b7280;margin-top:3px;">ğŸ’¾ Keine Nummer</div>'}
                        </div>
                        
                        <!-- Route -->
                        <div style="margin-bottom:15px;">
                            <div style="font-size:12px;font-weight:600;color:#6b7280;margin-bottom:5px;">ROUTE</div>
                            <div style="font-size:14px;color:#1f2937;line-height:1.6;">
                                <div>ğŸ“ <strong>Von:</strong> ${ride.pickup || 'Unbekannt'}</div>
                                <div>ğŸ¯ <strong>Nach:</strong> ${ride.destination || 'Unbekannt'}</div>
                            </div>
                        </div>
                        
                        <!-- Fahrzeug (falls zugewiesen) -->
                        ${ride.vehicle ? `
                        <div style="margin-bottom:15px;">
                            <div style="font-size:12px;font-weight:600;color:#6b7280;margin-bottom:5px;">FAHRZEUG</div>
                            <div style="font-size:14px;color:#1f2937;">
                                ğŸš— ${ride.vehicle}${ride.vehiclePlate ? ` (${ride.vehiclePlate})` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Preis & Details -->
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px;">
                            <div>
                                <div style="font-size:12px;font-weight:600;color:#6b7280;margin-bottom:5px;">PREIS</div>
                                <div style="font-size:18px;font-weight:700;color:${ride.price ? '#10b981' : '#ef4444'};">
                                    ${ride.price ? ride.price + 'â‚¬' : 'ğŸ’¾ Nicht berechnet'}
                                </div>
                                ${!ride.price ? '<div style="font-size:11px;color:#6b7280;margin-top:2px;">Fahrt ohne Preisberechnung erstellt</div>' : ''}
                            </div>
                            <div>
                                <div style="font-size:12px;font-weight:600;color:#6b7280;margin-bottom:5px;">DISTANZ</div>
                                <div style="font-size:14px;font-weight:600;color:#1f2937;">
                                    ${ride.distance ? ride.distance + ' km' : 'N/A'}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Zeiten -->
                        <div style="margin-bottom:15px;">
                            <div style="font-size:12px;font-weight:600;color:#6b7280;margin-bottom:5px;">ZEITEN</div>
                            <div style="font-size:13px;color:#6b7280;line-height:1.8;">
                                <div>ğŸ“… <strong>Erstellt:</strong> ${createdTime}</div>
                                <div>ğŸ• <strong>Abholung:</strong> ${pickupTime}</div>
                                ${ride.completedAt ? `<div>âœ… <strong>Abgeschlossen:</strong> ${new Date(ride.completedAt).toLocaleString('de-DE')}</div>` : ''}
                            </div>
                        </div>
                        
                        <!-- ğŸ†• v5.90.542: ABGESCHLOSSEN VON -->
                        ${(ride.status === 'completed' && ride.completedByName) ? `
                        <div style="margin-bottom:15px;padding:12px;background:#f0fdf4;border-left:4px solid #10b981;border-radius:8px;">
                            <div style="font-size:12px;font-weight:600;color:#059669;margin-bottom:5px;">âœ… ABGESCHLOSSEN VON</div>
                            <div style="font-size:14px;color:#047857;font-weight:600;">
                                ${ride.completedByRole === 'driver' ? 'ğŸš—' : ride.completedByRole === 'admin' ? 'ğŸ‘¨â€ğŸ’¼' : 'ğŸ’¾'} ${ride.completedByName}
                            </div>
                            ${ride.completedByRole ? `<div style="font-size:12px;color:#059669;margin-top:3px;">Rolle: ${ride.completedByRole === 'driver' ? 'Fahrer' : ride.completedByRole === 'admin' ? 'Admin' : ride.completedByRole}</div>` : ''}
                        </div>
                        ` : ''}
                        
                        <!-- Zahlungsmethode -->
                        ${ride.paymentMethod ? `
                        <div style="margin-bottom:15px;">
                            <div style="font-size:12px;font-weight:600;color:#6b7280;margin-bottom:5px;">ZAHLUNG</div>
                            <div style="font-size:14px;color:#1f2937;">
                                ğŸ’³ ${ride.paymentMethod === 'bar' ? 'Bar' : ride.paymentMethod === 'karte' ? 'Karte' : ride.paymentMethod}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Buttons -->
                        ${(() => {
                            let buttonCount = 3; // SchlieÃŸen + ID kopieren + WhatsApp
                            if (ride.status === 'cancelled') buttonCount++; // Wiederherstellen
                            if (ride.status === 'completed') buttonCount++; // Status Ã¤ndern
                            // ğŸ†• v5.90.270: Admin-Accept Button wenn assigned!
                            if (ride.status === 'assigned') buttonCount++;
                            // ğŸ†• v5.87.58: Stornieren NUR wenn KEINE Hotel-Fahrt!
                            if (ride.status !== 'cancelled' && ride.status !== 'completed' && !ride.hotelCalendarId) buttonCount++;
                            // ğŸ†• v5.90.525: ABSCHLIESSEN Button!
                            if (ride.status !== 'cancelled' && ride.status !== 'completed' && ride.firebaseId) buttonCount++;
                            const gridCols = 'repeat(' + buttonCount + ', 1fr)';
                            return `<div style="margin-top:25px;display:grid;grid-template-columns:${gridCols};gap:10px;">`;
                        })()}
                            <button onclick="this.closest('#ride-details-modal').remove()" style="padding:12px;background:#e5e7eb;color:#1f2937;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                                SchlieÃŸen
                            </button>
                            <!-- ğŸ†• WHATSAPP SHARE BUTTON! -->
                            <button onclick="shareRideViaWhatsApp(${JSON.stringify(ride).replace(/"/g, '&quot;')})" style="padding:12px;background:#25D366;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:4px;">
                                ğŸ’¬
                            </button>
                            ${ride.status === 'completed' && ride.firebaseId ? `
                            <button onclick="changeRideStatus('${ride.firebaseId}', '${ride.status}');this.closest('#ride-details-modal').remove();" style="padding:12px;background:#f59e0b;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                                âš™ï¸ Status
                            </button>
                            ` : ''}
                            ${ride.status === 'assigned' && ride.firebaseId ? `
                            <!-- ğŸ”§ v5.90.489: FAHRER ACCEPT BUTTON! -->
                            <button onclick="acceptRide('${ride.firebaseId}');this.closest('#ride-details-modal').remove();" style="padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;gap:6px;">
                                âœ… ANNEHMEN
                            </button>
                            ` : ''}
                            ${ride.status === 'assigned' && ride.firebaseId && currentUser?.role === 'admin' ? `
                            <button onclick="adminAcceptRide('${ride.firebaseId}');this.closest('#ride-details-modal').remove();" style="padding:12px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                                ğŸ’¾ ALS ADMIN
                            </button>
                            ` : ''}
                            ${ride.status === 'accepted' && ride.acceptedBy ? `
                            <button disabled style="padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;opacity:0.7;">
                                âœ… ${ride.acceptedBy === 'driver' ? 'Fahrer' : 'Admin'}-Akzeptiert
                            </button>
                            ` : ''}
                            ${ride.status === 'cancelled' && ride.firebaseId ? `
                            <button onclick="restoreRide('${ride.firebaseId}');this.closest('#ride-details-modal').remove();" style="padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                                ğŸ”„ Wiederherstellen
                            </button>
                            ` : ''}
                            ${ride.status !== 'cancelled' && ride.status !== 'completed' && ride.firebaseId ? `
                            <button onclick="completeRideAsAdmin('${ride.firebaseId}');this.closest('#ride-details-modal').remove();" style="padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                                âœ… ABSCHLIESSEN
                            </button>
                            ` : ''}
                            ${ride.status !== 'cancelled' && ride.status !== 'completed' && ride.firebaseId && !ride.hotelCalendarId ? `
                            <button onclick="cancelRideAsAdmin('${ride.firebaseId}');this.closest('#ride-details-modal').remove();" style="padding:12px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                                ğŸš« Stornieren
                            </button>
                            ` : ''}
                            ${ride.hotelCalendarId ? `
                            <button disabled style="padding:12px;background:#9ca3af;color:white;border:none;border-radius:8px;font-weight:600;cursor:not-allowed;opacity:0.5;" title="Hotel-Fahrten kÃ¶nnen nicht storniert werden">
                                ğŸ”’ GeschÃ¼tzt
                            </button>
                            ` : ''}
                            ${ride.firebaseId ? `
                            <button onclick="navigator.clipboard.writeText('${ride.firebaseId || ride.id}');alert('âœ… ID kopiert!');" style="padding:12px;background:#667eea;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                                ğŸ“‹ ID kopieren
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        async function saveRide(ride) {
            // ğŸ†• v5.31.0: Nutze EINDEUTIGE ID statt push()
            // Wenn noch keine ID â†’ generiere eine
            if (!ride.id) {
                ride.id = generateRideId();
            }
            
            // ğŸ†• v5.90.275: NORMALISIERE TELEFONNUMMER!
            if (ride.customerPhone) {
                ride.customerPhone = normalizePhoneNumber(ride.customerPhone);
                console.log('ğŸ“± customerPhone normalisiert:', ride.customerPhone);
            }
            
            // ğŸ” FÃ¼ge userId hinzu (fÃ¼r Firebase Query)
            // ğŸ†• v5.90.11: Bei Admin-Buchung fÃ¼r Kunden â†’ nutze customerPhone!
            // ğŸ†• v5.90.12: NORMALISIERE PHONE zu International Format!
            if (currentUser) {
                // Wenn Admin fÃ¼r Kunden bucht â†’ nutze Kunden-Telefon als userId
                if (ride.customerPhone && currentUser.role === 'admin' && ride.customerPhone !== currentUser.phoneNumber) {
                    ride.userId = normalizePhoneNumber(ride.customerPhone);
                    console.log('ğŸ’¾ Admin bucht fÃ¼r Kunden - userId = normalized phone:', ride.userId);
                } else {
                    ride.userId = currentUser.uid;
                }
            } else if (ride.customerPhone) {
                // Nicht eingeloggt â†’ nutze Telefon (normalisiert)
                ride.userId = normalizePhoneNumber(ride.customerPhone);
            }
            
            // ğŸ”¥ Speichere in Firebase
            if (isFirebaseReady) {
                try {
                    // ğŸ†• v5.31.0: Nutze set() mit fester ID statt push()!
                    // ride.id und ride.firebaseId sind jetzt IDENTISCH!
                    ride.firebaseId = ride.id;
                    await db.ref('rides/' + ride.id).set(ride);
                    
                    console.log('âœ… Fahrt gespeichert mit ID:', ride.id);
                    
                    // ğŸ“± TELEGRAM wird in book() gesendet, NICHT hier!
                    // (Sonst Duplikate weil book() auch sendet)
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim Speichern:', error);
                    // ğŸ“œ PROTOKOLL: Buchung fehlgeschlagen
                    logActivity('system', 'booking_error', `Buchung fehlgeschlagen: ${error.message}`, {
                        customer: ride.customerName,
                        from: ride.pickup,
                        to: ride.destination
                    });
                    throw error; // Weitergeben damit book() es behandeln kann
                }
            }
            
            // ğŸ’¾ Speichere auch in localStorage (fÃ¼r Offline-Support & schnellen Zugriff)
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            history.push(ride);
            localStorage.setItem('rideHistory', JSON.stringify(history));
            
            return ride;
        }

        async function updateRide(id, updates) {
            if (isFirebaseReady) {
                // Hole KOMPLETTE alte Fahrt-Daten
                const snapshot = await db.ref('rides/' + id).once('value');
                const oldRide = snapshot.val();
                const oldStatus = oldRide ? oldRide.status : null;
                
                // Update Firebase
                await db.ref('rides/' + id).update(updates);
                
                // PrÃ¼fe ob Status geÃ¤ndert wurde
                if (updates.status && updates.status !== oldStatus && oldRide) {
                    // ğŸ¯ WICHTIG: Nutze die ALTEN Daten + neuen Status
                    // So haben wir ALLE Fahrtdaten fÃ¼r Telegram!
                    const rideForTelegram = {
                        ...oldRide,  // Alle alten Daten
                        status: updates.status,  // Neuer Status
                        firebaseId: id
                    };
                    
                    // Sende Telegram-Benachrichtigung mit vollstÃ¤ndigen Daten
                    await sendTelegramStatusUpdate(rideForTelegram, oldStatus, updates.status);
                }
            }
        }

        // ğŸ†• v5.90.12: PHONE NORMALISIERUNG
        // Konvertiert alle Phone-Formate zu International (+49...)
        function normalizePhoneNumber(phone) {
            if (!phone) return '';
            
            // Entferne alle Leerzeichen, -, /, (, )
            let clean = phone.replace(/[\s\-\/\(\)]/g, '');
            
            // Wenn startet mit 00 â†’ ersetze mit +
            if (clean.startsWith('00')) {
                clean = '+' + clean.substring(2);
            }
            
            // Wenn startet mit 0 (Deutschland) â†’ ersetze mit +49
            else if (clean.startsWith('0') && !clean.startsWith('00')) {
                clean = '+49' + clean.substring(1);
            }
            
            // ğŸ†• v5.90.275: Wenn startet mit 49 (ohne +) â†’ fÃ¼ge + hinzu
            else if (clean.startsWith('49') && !clean.startsWith('+')) {
                clean = '+' + clean;
            }
            
            // Wenn nicht startet mit + UND nicht mit 49 â†’ fÃ¼ge +49 hinzu (default Deutschland)
            else if (!clean.startsWith('+') && !clean.startsWith('49')) {
                clean = '+49' + clean;
            }
            
            console.log('ğŸ“± Phone normalisiert:', phone, 'â†’', clean);
            return clean;
        }

        // GEOCODING & ROUTING
        async function geocode(address) {
            // Zuerst in bekannten Orten suchen
            const searchKey = address.toLowerCase().trim();
            if (KNOWN_PLACES[searchKey]) {
                console.log('âœ… Ort aus Cache:', KNOWN_PLACES[searchKey].name);
                return KNOWN_PLACES[searchKey];
            }
            
            // Dann via API suchen
            try {
                // ğŸ†• v5.74.0: Versuche zuerst mit Usedom/SwinemÃ¼nde (DE/PL)
                let response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Usedom, Deutschland')}&limit=1`);
                let data = await response.json();
                
                // Wenn nichts gefunden, versuche SwinemÃ¼nde, Polen
                if (data.length === 0) {
                    response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', SwinemÃ¼nde, Polen')}&limit=1`);
                    data = await response.json();
                }
                
                // Wenn nichts gefunden, versuche ÅšwinoujÅ›cie (polnischer Name)
                if (data.length === 0) {
                    response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', ÅšwinoujÅ›cie, Polska')}&limit=1`);
                    data = await response.json();
                }
                
                // Wenn nichts gefunden, versuche nur mit Deutschland
                if (data.length === 0) {
                    response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Deutschland')}&limit=1`);
                    data = await response.json();
                }
                
                // Wenn nichts gefunden, versuche nur mit Polen
                if (data.length === 0) {
                    response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Polen')}&limit=1`);
                    data = await response.json();
                }
                
                // Wenn immer noch nichts, versuche ohne Zusatz
                if (data.length === 0) {
                    response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
                    data = await response.json();
                }
                
                if (data.length > 0) {
                    console.log('âœ… Ort gefunden:', address, 'â†’', data[0].display_name);
                    return { 
                        lat: parseFloat(data[0].lat), 
                        lon: parseFloat(data[0].lon),
                        display_name: data[0].display_name,
                        address: data[0].address || {}
                    };
                } else {
                    console.warn('âš ï¸ Ort nicht gefunden:', address);
                }
            } catch (e) { 
                console.error('ğŸ’¾ Geocoding Fehler:', e); 
            }
            return null;
        }

        async function calculateRoute(from, to, waypointsArray = []) {
            try {
                // ğŸ†• v5.90.527: MULTI-STOP ROUTE!
                let coordinates = `${from.lon},${from.lat}`;
                
                // FÃ¼ge Waypoints hinzu
                if (waypointsArray && waypointsArray.length > 0) {
                    waypointsArray.forEach(wp => {
                        if (wp.coords) {
                            coordinates += `;${wp.coords.lon},${wp.coords.lat}`;
                        }
                    });
                }
                
                // Endziel
                coordinates += `;${to.lon},${to.lat}`;
                
                console.log('ğŸ—ºï¸ v5.90.527: Route-Berechnung mit', waypointsArray.length, 'Zwischenstopps');
                console.log('   Koordinaten:', coordinates);
                
                // ğŸ†• v5.90.541: TIMEOUT fÃ¼r OSRM (10 Sekunden)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                try {
                    // overview=full gibt die komplette Route-Geometry zurÃ¼ck!
                    const response = await fetch(
                        `https://router.project-osrm.org/route/v1/driving/${coordinates}?overview=full&geometries=geojson`,
                        { signal: controller.signal }
                    );
                    clearTimeout(timeoutId);
                    
                    const data = await response.json();
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    
                    // ğŸ†• v5.90.527: Zeige Distanz pro Segment
                    if (waypointsArray.length > 0 && route.legs) {
                        console.log('ğŸ“± v5.90.527: Route-Segmente:');
                        route.legs.forEach((leg, i) => {
                            const legDist = (leg.distance / 1000).toFixed(1);
                            const legDur = Math.round(leg.duration / 60);
                            if (i === 0) {
                                console.log(`   Start â†’ Stopp ${i+1}: ${legDist} km, ${legDur} Min`);
                            } else if (i < route.legs.length - 1) {
                                console.log(`   Stopp ${i} â†’ Stopp ${i+1}: ${legDist} km, ${legDur} Min`);
                            } else {
                                console.log(`   Stopp ${i} â†’ Ziel: ${legDist} km, ${legDur} Min`);
                            }
                        });
                    }
                    
                    return { 
                        distance: (route.distance / 1000).toFixed(1), 
                        duration: Math.round(route.duration / 60),
                        geometry: route.geometry ? route.geometry.coordinates : null,  // Route-Punkte!
                        legs: route.legs || []  // ğŸ†• v5.90.527: Einzelne Segmente!
                    };
                }
            } catch (e) { 
                console.error('ğŸ’¾ Route-Berechnung Fehler:', e);
                
                // ğŸ†• v5.90.541: FALLBACK - Berechne Luftlinie-Distanz
                if (e.name === 'AbortError') {
                    console.warn('âš ï¸ OSRM Timeout (10s) - nutze Luftlinie-Fallback');
                }
                
                // Berechne Distanz als Luftlinie
                const distKm = calculateGPSDistance(from.lat, from.lon, to.lat, to.lon);
                const estDuration = Math.ceil(distKm * 1.5); // ~40 km/h Durchschnitt
                
                console.log('ğŸ“ Fallback: Luftlinie', distKm.toFixed(1), 'km â†’', estDuration, 'Min');
                
                return { 
                    distance: distKm.toFixed(1), 
                    duration: estDuration,
                    geometry: null,
                    legs: [],
                    fallback: true  // Markiere als Fallback
                };
            }
            return { distance: 0, duration: 0, geometry: null, legs: [] };
        } catch (error) {
            console.error('ğŸ’¾ calculateRoute Fehler:', error);
            return { distance: 0, duration: 0, geometry: null, legs: [] };
        }
        }

        // ğŸ’° SURGE PRICING SETTINGS (Firebase-synchronisiert!)
        let pricingSettings = {
            autoSurgeEnabled: false,   // ğŸ†• v5.90.113: DEFAULT AUS! (Normalpreise)
            surgePerTaxi: 10,          // % pro aktivem Taxi
            manualMultiplier: 0,       // Manueller +/- %
            autoAssignBuffer: 10       // ğŸ†• v5.90.525: Puffer fÃ¼r Auto-Assign in Minuten
        };
        
        // Lade Pricing Settings aus Firebase
        function loadPricingSettings() {
            if (isFirebaseReady) {
                // Einmalig laden
                db.ref('settings/pricing').once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        pricingSettings = { ...pricingSettings, ...snapshot.val() };
                        console.log('ğŸ’° Pricing Settings aus Firebase geladen:', pricingSettings);
                    }
                    updatePricingUI();
                });
                
                // Live-Updates abonnieren
                db.ref('settings/pricing').on('value', snapshot => {
                    if (snapshot.exists()) {
                        pricingSettings = { ...pricingSettings, ...snapshot.val() };
                        console.log('ğŸ’° Pricing Settings aktualisiert:', pricingSettings);
                        updatePricingUI();
                    }
                });
            } else {
                // Fallback: localStorage
                const saved = localStorage.getItem('pricingSettings');
                if (saved) {
                    pricingSettings = JSON.parse(saved);
                }
                updatePricingUI();
            }
        }
        
        // Speichere Pricing Settings in Firebase
        function savePricingSettings() {
            pricingSettings.autoSurgeEnabled = document.getElementById('auto-surge-enabled')?.checked ?? false;  // ğŸ†• v5.90.113: Fallback auf false!
            pricingSettings.surgePerTaxi = parseInt(document.getElementById('surge-per-taxi')?.value ?? 10);
            
            if (isFirebaseReady) {
                db.ref('settings/pricing').update({
                    autoSurgeEnabled: pricingSettings.autoSurgeEnabled,
                    surgePerTaxi: pricingSettings.surgePerTaxi
                });
            }
            localStorage.setItem('pricingSettings', JSON.stringify(pricingSettings));
            updatePricingUI();
            console.log('ğŸ’° Pricing Settings gespeichert:', pricingSettings);
        }
        
        // ğŸ†• v5.90.525: Auto-Assign Puffer speichern!
        function saveAutoAssignBuffer() {
            const bufferSelect = document.getElementById('auto-assign-buffer');
            if (!bufferSelect) return;
            
            const bufferValue = parseInt(bufferSelect.value);
            pricingSettings.autoAssignBuffer = bufferValue;
            
            if (isFirebaseReady) {
                db.ref('settings/pricing').update({
                    autoAssignBuffer: bufferValue
                });
            }
            localStorage.setItem('pricingSettings', JSON.stringify(pricingSettings));
            console.log('â±ï¸ Auto-Assign Puffer gespeichert:', bufferValue, 'Min');
        }
        
        // Manuellen Multiplikator setzen (in Firebase!)
        function setManualMultiplier(value) {
            pricingSettings.manualMultiplier = value;
            
            if (isFirebaseReady) {
                db.ref('settings/pricing').update({
                    manualMultiplier: value
                });
            }
            localStorage.setItem('pricingSettings', JSON.stringify(pricingSettings));
            
            // Button-Styling aktualisieren
            document.querySelectorAll('.multiplier-btn').forEach(btn => {
                const btnValue = parseInt(btn.dataset.value);
                if (btnValue === value) {
                    btn.style.border = '2px solid #667eea';
                    btn.style.background = '#667eea';
                    btn.style.color = 'white';
                } else {
                    btn.style.border = '2px solid #e5e7eb';
                    btn.style.background = 'white';
                    btn.style.color = btnValue < 0 ? '#10b981' : (btnValue > 0 ? '#ef4444' : '#333');
                }
            });
            
            updatePricingUI();
            console.log('ğŸ’° Manueller Multiplikator:', value + '%');
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.38.2: BUCHUNGSSYSTEM ON/OFF
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Lade Buchungssystem-Status aus Firebase
        function loadBookingSystemStatus() {
            if (isFirebaseReady) {
                // Einmalig laden
                db.ref('settings/bookingSystemOnline').once('value').then(snapshot => {
                    bookingSystemOnline = snapshot.exists() ? snapshot.val() : true;
                    console.log('ğŸ”´ Buchungssystem-Status geladen:', bookingSystemOnline ? 'ONLINE' : 'OFFLINE');
                    updateBookingSystemUI();
                    updateBookingButton(); // Update Fahrgast-Button
                });
                
                // Live-Updates abonnieren
                db.ref('settings/bookingSystemOnline').on('value', snapshot => {
                    bookingSystemOnline = snapshot.exists() ? snapshot.val() : true;
                    console.log('ğŸ”´ Buchungssystem-Status aktualisiert:', bookingSystemOnline ? 'ONLINE' : 'OFFLINE');
                    updateBookingSystemUI();
                    updateBookingButton(); // Update Fahrgast-Button
                });
            } else {
                // Fallback: localStorage
                const saved = localStorage.getItem('bookingSystemOnline');
                bookingSystemOnline = saved !== null ? (saved === 'true') : true;
                updateBookingSystemUI();
                updateBookingButton();
            }
        }
        
        // Setze Buchungssystem ON/OFF
        function setBookingSystem(online) {
            bookingSystemOnline = online;
            
            if (isFirebaseReady) {
                db.ref('settings/bookingSystemOnline').set(online);
                console.log('ğŸ”´ Buchungssystem in Firebase gespeichert:', online ? 'ONLINE' : 'OFFLINE');
            }
            localStorage.setItem('bookingSystemOnline', online.toString());
            
            updateBookingSystemUI();
            updateBookingButton();
            
            // Admin-Feedback
            alert(online ? 'âœ… Buchungssystem ist jetzt ONLINE!\n\nFahrgÃ¤ste kÃ¶nnen wieder buchen.' : 'ğŸ”´ Buchungssystem ist jetzt OFFLINE!\n\nFahrgÃ¤ste kÃ¶nnen nur noch anrufen.');
        }
        
        // Update Admin-UI
        function updateBookingSystemUI() {
            const statusBox = document.getElementById('booking-system-status');
            const statusText = document.getElementById('booking-status-text');
            const btnOn = document.getElementById('btn-booking-on');
            const btnOff = document.getElementById('btn-booking-off');
            
            if (bookingSystemOnline) {
                // ONLINE
                if (statusBox) statusBox.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                if (statusText) {
                    statusText.textContent = 'ğŸŸ¢ ONLINE';
                    statusText.parentElement.querySelector('div:last-child').textContent = 'Buchungen werden angenommen';
                }
                if (btnOn) {
                    btnOn.style.border = '3px solid #10b981';
                    btnOn.style.background = '#10b981';
                    btnOn.style.color = 'white';
                }
                if (btnOff) {
                    btnOff.style.border = '3px solid #e5e7eb';
                    btnOff.style.background = 'white';
                    btnOff.style.color = '#666';
                }
            } else {
                // OFFLINE
                if (statusBox) statusBox.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                if (statusText) {
                    statusText.textContent = 'ğŸ”´ OFFLINE';
                    statusText.parentElement.querySelector('div:last-child').textContent = 'Nur Anrufen mÃ¶glich';
                }
                if (btnOff) {
                    btnOff.style.border = '3px solid #ef4444';
                    btnOff.style.background = '#ef4444';
                    btnOff.style.color = 'white';
                }
                if (btnOn) {
                    btnOn.style.border = '3px solid #e5e7eb';
                    btnOn.style.background = 'white';
                    btnOn.style.color = '#666';
                }
            }
        }
        
        // Update Fahrgast-Buchungs-Button
        function updateBookingButton() {
            const bookingForm = document.getElementById('booking-form');
            const offlineMessage = document.getElementById('offline-message');
            
            if (bookingSystemOnline) {
                // ONLINE: Button zeigen
                if (bookingForm) bookingForm.style.display = 'block';
                if (offlineMessage) offlineMessage.style.display = 'none';
            } else {
                // OFFLINE: Button verstecken, Anruf-Info zeigen
                if (bookingForm) bookingForm.style.display = 'none';
                if (offlineMessage) offlineMessage.style.display = 'block';
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.26.14: Ã–PNV-TAXI SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Ã–PNV-Einstellungen laden
        function loadOEPNVSettings() {
            const settings = JSON.parse(localStorage.getItem('oepnvSettings') || '{}');
            
            // Defaults
            const defaults = {
                enabled: false,
                surcharge: 2.00,
                tariffs: {
                    kurz: { km: 3, erw: 2.00, kind: 1.50 },
                    normal: { km: 7, erw: 3.00, kind: 2.00 },
                    lang: { km: 15, erw: 4.50, kind: 3.00 },
                    insel: { erw: 6.00, kind: 4.00 }
                },
                community: {
                    name: 'Gemeinde Heringsdorf',
                    email: ''
                },
                belegOptions: {
                    qr: true,
                    app: true,
                    pdf: true
                },
                // ğŸ†• v5.28.0: Anti-Betrugs-Defaults
                antiFraud: {
                    enabled: false,
                    mode: 'warn'
                }
            };
            
            const merged = { ...defaults, ...settings };
            // Ensure antiFraud object exists
            if (!merged.antiFraud) {
                merged.antiFraud = defaults.antiFraud;
            }
            
            // UI befÃ¼llen
            document.getElementById('oepnv-enabled').checked = merged.enabled;
            document.getElementById('oepnv-surcharge').value = merged.surcharge;
            
            document.getElementById('tarif-kurz-km').value = merged.tariffs.kurz.km;
            document.getElementById('tarif-kurz-erw').value = merged.tariffs.kurz.erw;
            document.getElementById('tarif-kurz-kind').value = merged.tariffs.kurz.kind;
            
            document.getElementById('tarif-normal-km').value = merged.tariffs.normal.km;
            document.getElementById('tarif-normal-erw').value = merged.tariffs.normal.erw;
            document.getElementById('tarif-normal-kind').value = merged.tariffs.normal.kind;
            
            document.getElementById('tarif-lang-km').value = merged.tariffs.lang.km;
            document.getElementById('tarif-lang-erw').value = merged.tariffs.lang.erw;
            document.getElementById('tarif-lang-kind').value = merged.tariffs.lang.kind;
            
            document.getElementById('tarif-insel-erw').value = merged.tariffs.insel.erw;
            document.getElementById('tarif-insel-kind').value = merged.tariffs.insel.kind;
            
            document.getElementById('oepnv-community-name').value = merged.community.name;
            document.getElementById('oepnv-community-email').value = merged.community.email;
            
            document.getElementById('oepnv-beleg-qr').checked = merged.belegOptions.qr;
            document.getElementById('oepnv-beleg-app').checked = merged.belegOptions.app;
            document.getElementById('oepnv-beleg-pdf').checked = merged.belegOptions.pdf;
            
            // ğŸ†• v5.28.0: Anti-Betrugs UI laden
            document.getElementById('oepnv-antifraud-enabled').checked = merged.antiFraud.enabled;
            const modeRadios = document.querySelectorAll('input[name="antifraud-mode"]');
            modeRadios.forEach(radio => {
                if (radio.value === merged.antiFraud.mode) {
                    radio.checked = true;
                }
            });
            
            // Settings anzeigen/verstecken
            document.getElementById('oepnv-settings').style.display = merged.enabled ? 'block' : 'none';
            
            // ğŸ†• v5.28.0: Anti-Betrugs UI anzeigen/verstecken
            document.getElementById('antifraud-mode-section').style.display = merged.antiFraud.enabled ? 'block' : 'none';
            document.getElementById('antifraud-criteria').style.display = merged.antiFraud.enabled ? 'block' : 'none';
            
            // In globale Variable speichern
            window.oepnvSettings = merged;
            
            console.log('ğŸš Ã–PNV-Settings geladen:', merged);
        }
        
        // Ã–PNV-Einstellungen speichern
        function saveOEPNVSettings() {
            const enabled = document.getElementById('oepnv-enabled').checked;
            
            // ğŸ†• v5.28.0: Anti-Betrugs-System
            const antiFraudEnabled = document.getElementById('oepnv-antifraud-enabled').checked;
            const antiFraudMode = document.querySelector('input[name="antifraud-mode"]:checked')?.value || 'warn';
            
            const settings = {
                enabled: enabled,
                surcharge: parseFloat(document.getElementById('oepnv-surcharge').value),
                tariffs: {
                    kurz: {
                        km: parseInt(document.getElementById('tarif-kurz-km').value),
                        erw: parseFloat(document.getElementById('tarif-kurz-erw').value),
                        kind: parseFloat(document.getElementById('tarif-kurz-kind').value)
                    },
                    normal: {
                        km: parseInt(document.getElementById('tarif-normal-km').value),
                        erw: parseFloat(document.getElementById('tarif-normal-erw').value),
                        kind: parseFloat(document.getElementById('tarif-normal-kind').value)
                    },
                    lang: {
                        km: parseInt(document.getElementById('tarif-lang-km').value),
                        erw: parseFloat(document.getElementById('tarif-lang-erw').value),
                        kind: parseFloat(document.getElementById('tarif-lang-kind').value)
                    },
                    insel: {
                        erw: parseFloat(document.getElementById('tarif-insel-erw').value),
                        kind: parseFloat(document.getElementById('tarif-insel-kind').value)
                    }
                },
                community: {
                    name: document.getElementById('oepnv-community-name').value,
                    email: document.getElementById('oepnv-community-email').value
                },
                belegOptions: {
                    qr: document.getElementById('oepnv-beleg-qr').checked,
                    app: document.getElementById('oepnv-beleg-app').checked,
                    pdf: document.getElementById('oepnv-beleg-pdf').checked
                },
                // ğŸ†• v5.28.0: Anti-Betrugs-Settings
                antiFraud: {
                    enabled: antiFraudEnabled,
                    mode: antiFraudMode
                }
            };
            
            // Speichern
            localStorage.setItem('oepnvSettings', JSON.stringify(settings));
            
            // Firebase
            if (isFirebaseReady) {
                db.ref('settings/oepnv').set(settings);
            }
            
            // Settings anzeigen/verstecken
            document.getElementById('oepnv-settings').style.display = enabled ? 'block' : 'none';
            
            // ğŸ†• v5.28.0: Anti-Betrugs UI anzeigen/verstecken
            document.getElementById('antifraud-mode-section').style.display = antiFraudEnabled ? 'block' : 'none';
            document.getElementById('antifraud-criteria').style.display = antiFraudEnabled ? 'block' : 'none';
            
            // Global speichern
            window.oepnvSettings = settings;
            
            console.log('ğŸš Ã–PNV-Settings gespeichert:', settings);
            
            // ğŸ†• v5.28.0: Info Ã¼ber Anti-Betrugs-Status
            if (antiFraudEnabled) {
                console.log('ğŸš¨ Anti-Betrugs-System:', antiFraudMode === 'warn' ? 'NUR WARNEN' : 'BLOCKIEREN');
            }
            
            alert('âœ… Ã–PNV-Einstellungen gespeichert!' + 
                  (antiFraudEnabled ? '\n\nğŸš¨ Anti-Betrugs-System: ' + (antiFraudMode === 'warn' ? 'Nur Warnen' : 'Blockieren') : ''));
        }
        
        // Berechne Busticket-Preis basierend auf km und Personen
        function calculateBusticket(km, adults, children) {
            if (!window.oepnvSettings) {
                loadOEPNVSettings();
            }
            
            const tariffs = window.oepnvSettings.tariffs;
            let tarif, tarifName;
            
            // Bestimme Tarifstufe
            if (km <= tariffs.kurz.km) {
                tarif = tariffs.kurz;
                tarifName = 'Kurzstrecke';
            } else if (km <= tariffs.normal.km) {
                tarif = tariffs.normal;
                tarifName = 'Normalstrecke';
            } else if (km <= tariffs.lang.km) {
                tarif = tariffs.lang;
                tarifName = 'LÃ¤ngere Strecke';
            } else {
                tarif = tariffs.insel;
                tarifName = 'Insel-Ticket';
            }
            
            // Berechne Ticketpreis
            const adultPrice = adults * tarif.erw;
            const childPrice = children * tarif.kind;
            const busticket = adultPrice + childPrice;
            
            return {
                busticket: busticket,
                adultPrice: adultPrice,
                childPrice: childPrice,
                tarif: tarifName,
                tarifDetails: tarif
            };
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.28.0: ANTI-BETRUGS-SYSTEM - DUPLIKATS-ERKENNUNG
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // PrÃ¼fe ob Ã–PNV-Fahrt Duplikat ist (Mehrfach-Abrechnung)
        function checkOEPNVDuplicate(newRide) {
            // Nur wenn Anti-Betrugs-System aktiviert
            if (!window.oepnvSettings?.antiFraud?.enabled) {
                return { isDuplicate: false, duplicates: [] };
            }
            
            console.log('ğŸš¨ PrÃ¼fe auf Duplikate:', newRide);
            
            // Hole alle Ã–PNV-Fahrten der letzten 10 Minuten
            const now = Date.now();
            const tenMinutesAgo = now - (10 * 60 * 1000);
            
            // Suche in rides-Objekt (alle aktiven/letzten Fahrten)
            const recentOepnvRides = Object.values(rides).filter(r => 
                r.isOEPNV && 
                r.timestamp >= tenMinutesAgo &&
                r.id !== newRide.id // Nicht sich selbst
            );
            
            console.log('ğŸ” Gefundene Ã–PNV-Fahrten (10 Min):', recentOepnvRides.length);
            
            // Suche Duplikate
            const duplicates = recentOepnvRides.filter(existingRide => {
                const timeDiff = Math.abs(newRide.timestamp - existingRide.timestamp);
                const fiveMinutes = 5 * 60 * 1000;
                
                const sameDriver = existingRide.driverId === newRide.driverId;
                const samePickup = existingRide.pickup === newRide.pickup;
                const sameDestination = existingRide.destination === newRide.destination;
                const sameTime = timeDiff < fiveMinutes;
                
                console.log('  Vergleiche mit Fahrt:', existingRide.id, {
                    sameDriver,
                    samePickup,
                    sameDestination,
                    sameTime,
                    timeDiff: Math.round(timeDiff / 1000) + 's'
                });
                
                return sameDriver && samePickup && sameDestination && sameTime;
            });
            
            if (duplicates.length > 0) {
                console.log('ğŸš¨ DUPLIKAT ERKANNT!', duplicates);
                
                // Speichere Alarm fÃ¼r Admin-Dashboard
                saveAntiFraudAlert(newRide, duplicates);
            }
            
            return {
                isDuplicate: duplicates.length > 0,
                duplicates: duplicates
            };
        }
        
        // Speichere Anti-Betrugs-Alarm fÃ¼r Admin
        function saveAntiFraudAlert(newRide, duplicates) {
            const alert = {
                id: 'af-' + Date.now(),
                timestamp: Date.now(),
                newRide: {
                    id: newRide.id,
                    pickup: newRide.pickup,
                    destination: newRide.destination,
                    driverId: newRide.driverId,
                    customerName: newRide.customerName
                },
                duplicates: duplicates.map(d => ({
                    id: d.id,
                    pickup: d.pickup,
                    destination: d.destination,
                    timestamp: d.timestamp
                })),
                resolved: false
            };
            
            // In localStorage speichern
            const alerts = JSON.parse(localStorage.getItem('antiFraudAlerts') || '[]');
            alerts.unshift(alert);
            // Nur letzte 50 behalten
            const trimmed = alerts.slice(0, 50);
            localStorage.setItem('antiFraudAlerts', JSON.stringify(trimmed));
            
            // Firebase
            if (isFirebaseReady) {
                db.ref('antiFraudAlerts/' + alert.id).set(alert);
            }
            
            console.log('ğŸš¨ Anti-Betrugs-Alarm gespeichert:', alert);
            
            // Badge-Update im Admin-Dashboard
            updateAntiFraudBadge();
        }
        
        // Update Badge-Anzahl fÃ¼r Anti-Betrugs-Alarme
        function updateAntiFraudBadge() {
            const alerts = JSON.parse(localStorage.getItem('antiFraudAlerts') || '[]');
            const unresolved = alerts.filter(a => !a.resolved);
            
            const badge = document.getElementById('antifraud-alert-count');
            if (badge) {
                badge.textContent = unresolved.length;
                badge.parentElement.style.display = unresolved.length > 0 ? 'flex' : 'none';
            }
        }
        
        // Lade und zeige Anti-Betrugs-Alarme im Admin-Dashboard
        function loadAntiFraudAlerts() {
            const alerts = JSON.parse(localStorage.getItem('antiFraudAlerts') || '[]');
            console.log('ğŸš¨ Lade Anti-Betrugs-Alarme:', alerts.length);
            
            const container = document.getElementById('antifraud-alerts-list');
            
            if (alerts.length === 0) {
                container.innerHTML = '<div style="padding:20px;text-align:center;color:#999;">âœ… Keine Alarme vorhanden</div>';
                return;
            }
            
            // Sortiere nach Timestamp (neueste zuerst)
            alerts.sort((a, b) => b.timestamp - a.timestamp);
            
            let html = '';
            alerts.forEach(alert => {
                const date = new Date(alert.timestamp);
                const timeStr = date.toLocaleString('de-DE');
                
                html += `
                    <div style="padding:15px;border-bottom:1px solid #e5e7eb;${alert.resolved ? 'opacity:0.5;background:#f9fafb;' : ''}">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px;">
                            <div>
                                <div style="font-weight:600;font-size:14px;color:${alert.resolved ? '#6b7280' : '#dc2626'};">
                                    ${alert.resolved ? 'âœ…' : 'ğŸš¨'} ${alert.duplicates.length + 1} Fahrten verdÃ¤chtig
                                </div>
                                <div style="font-size:12px;color:#6b7280;">${timeStr}</div>
                            </div>
                            ${!alert.resolved ? `
                                <button onclick="resolveAlert('${alert.id}')" style="padding:6px 12px;background:#10b981;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;">
                                    âœ… Erledigt
                                </button>
                            ` : ''}
                        </div>
                        
                        <div style="background:#f9fafb;padding:10px;border-radius:6px;margin-bottom:8px;">
                            <div style="font-weight:600;font-size:13px;color:#1f2937;margin-bottom:4px;">ğŸ“ Route:</div>
                            <div style="font-size:12px;color:#4b5563;">
                                ${alert.newRide.pickup} â†’ ${alert.newRide.destination}
                            </div>
                        </div>
                        
                        <div style="font-size:12px;color:#6b7280;">
                            <strong>Fahrt ${alert.newRide.id}</strong> (${alert.newRide.customerName || 'Unbekannt'})<br>
                            ${alert.duplicates.length} Ã¤hnliche Fahrt${alert.duplicates.length > 1 ? 'en' : ''} zur gleichen Zeit erkannt!
                        </div>
                        
                        ${alert.duplicates.length > 0 ? `
                            <details style="margin-top:8px;">
                                <summary style="cursor:pointer;font-size:12px;color:#667eea;">ğŸ” Details anzeigen</summary>
                                <div style="margin-top:8px;padding:8px;background:white;border-radius:4px;font-size:11px;">
                                    ${alert.duplicates.map((d, i) => {
                                        const dupDate = new Date(d.timestamp);
                                        const timeDiff = Math.round((alert.timestamp - d.timestamp) / 1000 / 60);
                                        return `
                                            <div style="padding:6px 0;border-top:1px solid #e5e7eb;">
                                                <strong>Duplikat ${i+1}:</strong> Fahrt ${d.id}<br>
                                                Zeitdifferenz: ${timeDiff} Minuten
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </details>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
            updateAntiFraudBadge();
        }
        
        // Markiere Alarm als erledigt
        function resolveAlert(alertId) {
            const alerts = JSON.parse(localStorage.getItem('antiFraudAlerts') || '[]');
            const alert = alerts.find(a => a.id === alertId);
            
            if (alert) {
                alert.resolved = true;
                alert.resolvedAt = Date.now();
                
                localStorage.setItem('antiFraudAlerts', JSON.stringify(alerts));
                
                // Firebase
                if (isFirebaseReady) {
                    db.ref('antiFraudAlerts/' + alertId + '/resolved').set(true);
                    db.ref('antiFraudAlerts/' + alertId + '/resolvedAt').set(alert.resolvedAt);
                }
                
                console.log('âœ… Alarm erledigt:', alertId);
                loadAntiFraudAlerts();
            }
        }
        
        // LÃ¶sche erledigte Alarme
        function clearResolvedAlerts() {
            const confirmed = confirm('â“ Alle erledigten Alarme lÃ¶schen?');
            if (!confirmed) return;
            
            const alerts = JSON.parse(localStorage.getItem('antiFraudAlerts') || '[]');
            const unresolved = alerts.filter(a => !a.resolved);
            
            localStorage.setItem('antiFraudAlerts', JSON.stringify(unresolved));
            
            // Firebase: LÃ¶sche resolved
            if (isFirebaseReady) {
                alerts.filter(a => a.resolved).forEach(a => {
                    db.ref('antiFraudAlerts/' + a.id).remove();
                });
            }
            
            console.log('ğŸ—‘ï¸ Erledigte Alarme gelÃ¶scht');
            alert('âœ… Erledigte Alarme wurden gelÃ¶scht!');
            loadAntiFraudAlerts();
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.26.14d: RECHNUNG-DOWNLOAD FÃœR FAHRGAST
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function downloadReceipt(rideIdOrTimestamp) {
            try {
                console.log('ğŸ“± downloadReceipt aufgerufen fÃ¼r:', rideIdOrTimestamp);
                
                // ğŸ†• v5.26.14j: Check ob jsPDF geladen ist!
                if (!window.jspdf || !window.jspdf.jsPDF) {
                    alert('ğŸ’¾ PDF-Bibliothek nicht geladen!\n\nBitte Seite neu laden (F5).');
                    console.error('ğŸ’¾ jsPDF nicht verfÃ¼gbar!');
                    return;
                }
                
                // Finde Fahrt
                const localHistory = JSON.parse(localStorage.getItem('rideHistory') || '[]');
                const ride = localHistory.find(r => r.createdAt === rideIdOrTimestamp || r.id === rideIdOrTimestamp);
                
                console.log('ğŸ” Gefundene Fahrt:', ride);
                
                if (!ride) {
                    alert('ğŸ’¾ Fahrt nicht gefunden!');
                    console.error('ğŸ’¾ Fahrt nicht in localStorage gefunden:', rideIdOrTimestamp);
                    return;
                }
                
                console.log('âœ… Erstelle PDF...');
                
                // Erstelle PDF mit jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
        
        // ğŸ†• v5.90.11: DOWNLOAD ECHTE RECHNUNG AUS FIREBASE
        async function downloadInvoicePDF(invoiceNumber, rideId) {
            try {
                console.log('ğŸ“± Lade Rechnung:', invoiceNumber, 'fÃ¼r Fahrt:', rideId);
                
                // Check ob jsPDF geladen ist
                if (!window.jspdf || !window.jspdf.jsPDF) {
                    alert('ğŸ’¾ PDF-Bibliothek nicht geladen!\n\nBitte Seite neu laden (F5).');
                    return;
                }
                
                // Lade Rechnung aus Firebase
                const invoiceSnapshot = await db.ref(`invoices/${invoiceNumber}`).once('value');
                const invoice = invoiceSnapshot.val();
                
                if (!invoice) {
                    alert(`ğŸ’¾ Rechnung ${invoiceNumber} nicht gefunden!`);
                    return;
                }
                
                console.log('âœ… Rechnung geladen:', invoice);
                
                // Regeneriere PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // HEADER - Firmendaten (IMMER)
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text('Taxiunternehmen Patrick Wydra', 20, 20);
                doc.text('Amselring 10', 20, 25);
                doc.text('17424 Ostseebad Heringsdorf', 20, 30);
                doc.text('Tel.: 038378/22022', 20, 35);
                
                // TITEL (IMMER)
                doc.setFontSize(20);
                doc.setTextColor(0);
                doc.setFont(undefined, 'bold');
                doc.text('Rechnung', 20, 50);
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Rechnungsnr.: ${invoiceNumber}`, 20, 58);
                doc.text(`Datum: ${new Date(invoice.createdAt).toLocaleDateString('de-DE')}`, 20, 63);
                
                let yPos = 75;
                
                // KUNDE (falls in displayOptions)
                if (invoice.displayOptions?.showCustomer && invoice.customerName) {
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.text('Kunde:', 20, yPos);
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(10);
                    yPos += 6;
                    doc.text(invoice.customerName, 20, yPos);
                    yPos += 5;
                }
                
                // ADRESSE (falls in displayOptions)
                if (invoice.displayOptions?.showAddress && invoice.address) {
                    const addressLines = doc.splitTextToSize(invoice.address, 80);
                    doc.text(addressLines, 20, yPos);
                    yPos += addressLines.length * 5;
                }
                
                // GASTNAME (falls in displayOptions)
                if (invoice.displayOptions?.showGuest && invoice.guestName) {
                    yPos += 3;
                    doc.setFont(undefined, 'bold');
                    doc.text('Gastname:', 20, yPos);
                    doc.setFont(undefined, 'normal');
                    yPos += 5;
                    doc.text(invoice.guestName, 20, yPos);
                    yPos += 5;
                }
                
                // FAHRTDETAILS
                yPos += 5;
                if (invoice.displayOptions?.showDateTime || invoice.displayOptions?.showRoute || invoice.displayOptions?.showDistance) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Fahrtdetails:', 20, yPos);
                    doc.setFont(undefined, 'normal');
                    yPos += 6;
                }
                
                if (invoice.displayOptions?.showDateTime) {
                    doc.text(`Datum: ${invoice.rideDate}`, 20, yPos);
                    yPos += 5;
                    doc.text(`Uhrzeit: ${invoice.rideTime}`, 20, yPos);
                    yPos += 5;
                }
                
                if (invoice.displayOptions?.showRoute) {
                    doc.text(`Von: ${invoice.pickup}`, 20, yPos);
                    yPos += 5;
                    doc.text(`Nach: ${invoice.destination}`, 20, yPos);
                    yPos += 5;
                }
                
                if (invoice.displayOptions?.showDistance && invoice.distance) {
                    doc.text(`Distanz: ${invoice.distance.toFixed(1)} km`, 20, yPos);
                    yPos += 5;
                }
                
                // POSITIONEN
                yPos += 10;
                doc.setFont(undefined, 'bold');
                doc.text('Pos.', 20, yPos);
                doc.text('Beschreibung', 40, yPos);
                doc.text('Betrag', 160, yPos, { align: 'right' });
                
                doc.setFont(undefined, 'normal');
                doc.line(20, yPos + 2, 190, yPos + 2);
                yPos += 8;
                
                // FÃ¼ge Positionen hinzu
                (invoice.positions || []).forEach((pos, index) => {
                    doc.text(String(index + 1), 20, yPos);
                    doc.text(pos.description || '', 40, yPos);
                    doc.text(`${pos.amount.toFixed(2)}â‚¬`, 160, yPos, { align: 'right' });
                    yPos += 6;
                });
                
                // SUMMEN
                yPos += 5;
                doc.line(20, yPos, 190, yPos);
                yPos += 8;
                
                // MwSt-Ausweis (falls aktiviert)
                if (invoice.displayOptions?.showVat) {
                    doc.setFont(undefined, 'normal');
                    doc.text('Zwischensumme (netto):', 100, yPos);
                    doc.text(`${invoice.netPrice.toFixed(2)}â‚¬`, 160, yPos, { align: 'right' });
                    yPos += 6;
                    
                    doc.text(`Umsatzsteuer ${invoice.vatRate}%:`, 100, yPos);
                    doc.text(`${invoice.vatAmount.toFixed(2)}â‚¬`, 160, yPos, { align: 'right' });
                    yPos += 6;
                }
                
                // Gesamtbetrag
                doc.setFont(undefined, 'bold');
                doc.setFontSize(12);
                doc.text('Gesamtbetrag:', 100, yPos);
                doc.text(`${invoice.totalGross.toFixed(2)}â‚¬`, 160, yPos, { align: 'right' });
                
                // ğŸ†• v5.90.11: ZAHLUNGSART
                yPos += 10;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(100);
                
                const paymentMethodNames = {
                    'bar': 'Bar',
                    'ec': 'EC-Karte',
                    'credit': 'Kreditkarte',
                    'paypal': 'PayPal',
                    'rechnung': 'Rechnung',
                    'uberweisung': 'Ueberweisung'
                };
                
                if (invoice.paymentMethod) {
                    doc.text(`Zahlungsart: ${paymentMethodNames[invoice.paymentMethod] || invoice.paymentMethod}`, 20, yPos);
                }
                
                // FOOTER - Bankdaten (IMMER)
                yPos += 15;
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(80);
                
                if (yPos > 260) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setDrawColor(200);
                doc.line(20, yPos, 190, yPos);
                yPos += 5;
                
                // Linke Spalte: Bankverbindung
                doc.text('Bankverbindung:', 20, yPos);
                doc.text('Volksbank Vorpommern', 20, yPos + 4);
                doc.text('IBAN: DE16 1309 1054 0001 5524 90', 20, yPos + 8);
                doc.text('BIC: GENODEF1HST', 20, yPos + 12);
                
                // Rechte Spalte: Steuerdaten
                doc.text('Steuernummer: 084 289/01178', 120, yPos);
                doc.text('IK: 601318664', 120, yPos + 4);
                
                // PDF herunterladen
                doc.save(`Rechnung_${invoiceNumber}_${new Date().toLocaleDateString('de-DE').replace(/\./g, '_')}.pdf`);
                
                showToast(`âœ… Rechnung ${invoiceNumber} heruntergeladen!`, 'success');
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Download:', error);
                alert('ğŸ’¾ Fehler beim Laden der Rechnung: ' + error.message);
            }
        }
                
            // Schriftart und GrÃ¶ÃŸe
            doc.setFont('helvetica');
            
            // HEADER
            doc.setFontSize(20);
            doc.setTextColor(102, 126, 234); // #667eea
            doc.text('Funk Taxi Heringsdorf', 105, 20, { align: 'center' });
            
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text('RECHNUNG', 105, 30, { align: 'center' });
            
            // Linie
            doc.setDrawColor(200, 200, 200);
            doc.line(20, 35, 190, 35);
            
            // FAHRT-NUMMER & DATUM
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            const fahrtNr = ride.id || String(ride.createdAt).substring(0, 10);
            doc.text('Fahrt-Nr: #' + fahrtNr, 20, 45);
            
            if (ride.createdAt) {
                const datum = new Date(ride.createdAt);
                const datumStr = datum.toLocaleString('de-DE', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                doc.text('Datum: ' + datumStr, 20, 52);
            }
            
            // FAHRT-DETAILS
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            doc.text('Von:', 20, 65);
            doc.setFont('helvetica', 'normal');
            doc.text(ride.pickup || 'Unbekannt', 20, 72);
            
            doc.setFont('helvetica', 'bold');
            doc.text('Nach:', 20, 85);
            doc.setFont('helvetica', 'normal');
            doc.text(ride.destination || 'Unbekannt', 20, 92);
            
            // STRECKE & PREIS
            doc.setFont('helvetica', 'bold');
            doc.text('Strecke:', 20, 105);
            doc.setFont('helvetica', 'normal');
            doc.text((ride.distance || '?') + ' km', 20, 112);
            
            doc.setFont('helvetica', 'bold');
            doc.text('Preis:', 20, 125);
            doc.setFontSize(18);
            doc.setTextColor(102, 126, 234);
            doc.text((ride.price || '?') + ',00 EUR', 20, 135);
            
            // ZAHLUNGSMETHODE (falls vorhanden)
            if (ride.paymentMethod) {
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('Zahlungsmethode:', 20, 148);
                doc.setFont('helvetica', 'normal');
                const paymentText = {
                    'bar': 'Bargeld',
                    'karte': 'EC-Karte/Kreditkarte',
                    'paypal': 'PayPal/Digitale Zahlung',
                    'rechnung': 'Rechnung (Firmenkunden)'
                }[ride.paymentMethod] || ride.paymentMethod;
                doc.text(paymentText, 20, 155);
            }
            
            // FAHRZEUG-INFO (falls vorhanden)
            if (ride.vehicleLabel || ride.vehicle) {
                const vehicleName = ride.vehicleLabel || ride.vehicle;
                const plateInfo = ride.vehiclePlate ? ` (${ride.vehiclePlate})` : '';
                doc.setFont('helvetica', 'bold');
                doc.text('Fahrzeug:', 20, 168);
                doc.setFont('helvetica', 'normal');
                doc.text(vehicleName + plateInfo, 20, 175);
            }
            
            // FOOTER
            doc.setFontSize(9);
            doc.setTextColor(150, 150, 150);
            doc.text('Funk Taxi Heringsdorf', 105, 280, { align: 'center' });
            doc.text('Vielen Dank fÃ¼r Ihre Fahrt!', 105, 285, { align: 'center' });
            
            // DOWNLOAD
            const filename = 'Rechnung_Taxi_' + fahrtNr + '.pdf';
            doc.save(filename);
            
            console.log('âœ… Rechnung erstellt:', filename);
            alert('âœ… Rechnung wird heruntergeladen!\n\n' + filename);
            
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Erstellen der Rechnung:', error);
                alert('ğŸ’¾ Fehler beim Erstellen der Rechnung!\n\n' + error.message + '\n\nBitte Screenshot machen und melden.');
            }
        }
        
        // ğŸ†• v5.26.14j: STORNOBELEG MIT ERROR-HANDLING
        function downloadCancellationReceipt(rideIdOrTimestamp) {
            try {
                console.log('ğŸ“± downloadCancellationReceipt aufgerufen fÃ¼r:', rideIdOrTimestamp);
                
                // ğŸ†• v5.26.14j: Check ob jsPDF geladen ist!
                if (!window.jspdf || !window.jspdf.jsPDF) {
                    alert('ğŸ’¾ PDF-Bibliothek nicht geladen!\n\nBitte Seite neu laden (F5).');
                    console.error('ğŸ’¾ jsPDF nicht verfÃ¼gbar!');
                    return;
                }
                
                // Finde Fahrt
                const localHistory = JSON.parse(localStorage.getItem('rideHistory') || '[]');
                const ride = localHistory.find(r => r.createdAt === rideIdOrTimestamp || r.id === rideIdOrTimestamp);
                
                console.log('ğŸ” Gefundene Fahrt:', ride);
                
                if (!ride) {
                    alert('ğŸ’¾ Fahrt nicht gefunden!');
                    console.error('ğŸ’¾ Fahrt nicht in localStorage gefunden:', rideIdOrTimestamp);
                    return;
                }
                
            // ğŸ†• v5.26.14g: Berechne StornogebÃ¼hr (15% vom Preis)
            const createdAt = ride.createdAt || 0;
            const cancelledAt = ride.cancelledAt || ride.completedAt || Date.now();
            const timeDiff = cancelledAt - createdAt;
            const minutesDiff = Math.floor(timeDiff / (60 * 1000));
            
            if (minutesDiff > 60) {
                alert('â„¹ï¸ Diese Stornierung war kostenfrei (mehr als 60 Min nach Buchung).');
                return;
            }
            
            const cancellationFee = Math.round((ride.price || 0) * 0.15 * 100) / 100;
            
            if (cancellationFee <= 0) {
                alert('ğŸ’¾ Keine StornogebÃ¼hr berechenbar (kein Preis vorhanden)!');
                return;
            }
            
            // Erstelle PDF mit jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Schriftart und GrÃ¶ÃŸe
            doc.setFont('helvetica');
            
            // HEADER
            doc.setFontSize(20);
            doc.setTextColor(239, 68, 68); // #ef4444 (rot)
            doc.text('Funk Taxi Heringsdorf', 105, 20, { align: 'center' });
            
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text('STORNOBELEG', 105, 30, { align: 'center' });
            
            // Linie
            doc.setDrawColor(200, 200, 200);
            doc.line(20, 35, 190, 35);
            
            // FAHRT-NUMMER & DATUM
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            const fahrtNr = ride.id || String(ride.createdAt).substring(0, 10);
            doc.text('Fahrt-Nr: #' + fahrtNr, 20, 45);
            
            if (ride.createdAt) {
                const datum = new Date(ride.createdAt);
                const datumStr = datum.toLocaleString('de-DE', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                doc.text('Buchungsdatum: ' + datumStr, 20, 52);
            }
            
            if (ride.cancelledAt) {
                const cancelDatum = new Date(ride.cancelledAt);
                const cancelStr = cancelDatum.toLocaleString('de-DE', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                doc.text('Storniert am: ' + cancelStr, 20, 59);
            }
            
            // STORNIERUNG HINWEIS
            doc.setFontSize(12);
            doc.setTextColor(239, 68, 68);
            doc.setFont('helvetica', 'bold');
            doc.text('Diese Fahrt wurde storniert', 20, 75);
            
            // FAHRT-DETAILS
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            doc.text('Von:', 20, 90);
            doc.setFont('helvetica', 'normal');
            doc.text(ride.pickup || 'Unbekannt', 20, 97);
            
            doc.setFont('helvetica', 'bold');
            doc.text('Nach:', 20, 110);
            doc.setFont('helvetica', 'normal');
            doc.text(ride.destination || 'Unbekannt', 20, 117);
            
            // STORNIERUNGSGRUND
            if (ride.cancellationReason) {
                doc.setFont('helvetica', 'bold');
                doc.text('Stornierungsgrund:', 20, 130);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                const lines = doc.splitTextToSize(ride.cancellationReason, 170);
                doc.text(lines, 20, 137);
            }
            
            // STORNOGEBÃœHR
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text('Stornogebuehr (15%):', 20, 160);
            doc.setFontSize(18);
            doc.setTextColor(239, 68, 68);
            doc.text(cancellationFee.toFixed(2) + ' EUR', 20, 170);
            
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text('Stornierung innerhalb 60 Min - 15% Stornogebuehr', 20, 180);
            doc.text('(Urspruenglicher Preis: ' + parseFloat(ride.price || 0).toFixed(2) + ' EUR)', 20, 187);
            
            // FOOTER
            doc.setFontSize(9);
            doc.setTextColor(150, 150, 150);
            doc.text('Funk Taxi Heringsdorf', 105, 280, { align: 'center' });
            
            // DOWNLOAD
            const filename = 'Stornobeleg_Taxi_' + fahrtNr + '.pdf';
            doc.save(filename);
            
            console.log('âœ… Stornobeleg erstellt:', filename);
            alert('âœ… Stornobeleg wird heruntergeladen!\n\n' + filename);
            
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Erstellen des Stornobelegs:', error);
                alert('ğŸ’¾ Fehler beim Erstellen des Stornobelegs!\n\n' + error.message + '\n\nBitte Screenshot machen und melden.');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Berechne aktuellen Gesamt-Multiplikator
        function getCurrentMultiplier() {
            let multiplier = 100; // Basis 100%
            let reasons = [];
            
            // Auto-Surge basierend auf aktiven Fahrten
            if (pricingSettings.autoSurgeEnabled) {
                const activeRides = rides.filter(r => r.status === 'accepted' || r.status === 'in_progress').length;
                
                // ğŸ†• v5.90.113: Aufschlag erst ab 2 Autos!
                // 1 Auto = 0%, 2 Autos = +10%, 3 Autos = +20%, etc.
                if (activeRides > 1) {
                    const autoSurge = (activeRides - 1) * pricingSettings.surgePerTaxi;
                    multiplier += autoSurge;
                    reasons.push(`+${autoSurge}% (${activeRides} Taxi${activeRides > 1 ? 's' : ''} unterwegs)`);
                }
            }
            
            // Manueller Aufschlag/Rabatt
            if (pricingSettings.manualMultiplier !== 0) {
                multiplier += pricingSettings.manualMultiplier;
                const sign = pricingSettings.manualMultiplier > 0 ? '+' : '';
                reasons.push(`${sign}${pricingSettings.manualMultiplier}% (Manuell)`);
            }
            
            return {
                multiplier: multiplier,
                factor: multiplier / 100,
                reasons: reasons.length > 0 ? reasons.join(', ') : 'Normalpreis'
            };
        }
        
        // Update Pricing UI im Admin
        function updatePricingUI() {
            const current = getCurrentMultiplier();
            
            const displayEl = document.getElementById('current-multiplier-display');
            const reasonEl = document.getElementById('multiplier-reason');
            const exampleEl = document.getElementById('pricing-example');
            
            if (displayEl) {
                displayEl.textContent = current.multiplier + '%';
                displayEl.style.color = current.multiplier > 100 ? '#fecaca' : (current.multiplier < 100 ? '#bbf7d0' : 'white');
            }
            if (reasonEl) {
                reasonEl.textContent = current.reasons;
            }
            if (exampleEl) {
                const example = (14.60 * current.factor).toFixed(2);
                exampleEl.textContent = `Beispiel: 14.60â‚¬ Ã— ${current.multiplier}% = ${example}â‚¬`;
            }
            
            // ğŸ†• v5.90.525: Auto-Assign Puffer UI aktualisieren!
            const bufferSelect = document.getElementById('auto-assign-buffer');
            if (bufferSelect) {
                bufferSelect.value = pricingSettings.autoAssignBuffer || 10;
            }
        }

        // ğŸš¨ ADMIN ALARM SYSTEM fÃ¼r neue Fahrten
        let adminAlarmInterval = null;
        // ğŸ¯ Welche Fahrten wurden bereits vom Admin bestÃ¤tigt
        // Wird in localStorage gespeichert damit es nach Logout erhalten bleibt!
        function loadAcknowledgedRides() {
            const saved = localStorage.getItem('acknowledgedRides');
            if (saved) {
                try {
                    return new Set(JSON.parse(saved));
                } catch (e) {
                    return new Set();
                }
            }
            return new Set();
        }
        
        function saveAcknowledgedRides() {
            localStorage.setItem('acknowledgedRides', JSON.stringify([...acknowledgedRides]));
        }
        
        let acknowledgedRides = loadAcknowledgedRides();
        
        // ğŸ†• v5.31.5: ALARM EINSTELLUNGEN
        function toggleAdminAlarm() {
            const checkbox = document.getElementById('disable-admin-alarm');
            localStorage.setItem('disableAdminAlarm', checkbox.checked ? 'true' : 'false');
            
            if (checkbox.checked) {
                alert('âœ… Alarm-Modal deaktiviert!\n\nDu siehst jetzt nur noch die dezente Benachrichtigung oben.');
            } else {
                alert('ğŸ”” Alarm-Modal aktiviert!\n\nDu bekommst wieder Pop-ups & Sound bei neuen Fahrten.');
            }
        }
        
        // ğŸ†• v5.31.5: Zu offenen Fahrten scrollen
        function scrollToOpenRides() {
            const openSection = document.getElementById('open-content');
            if (openSection) {
                openSection.style.display = 'block';
                document.getElementById('open-toggle').textContent = 'â–²';
                openSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        // ğŸ†• v5.31.5: Update Benachrichtigungs-Bar
        function updateNotificationBar() {
            const newRides = rides.filter(r => 
                (r.status === 'new' || r.status === 'vorbestellt') && 
                !acknowledgedRides.has(r.id) &&
                !r.vehicleId  // Noch kein Fahrer zugewiesen
            );
            
            const bar = document.getElementById('admin-notification-bar');
            const count = document.getElementById('notification-ride-count');
            
            if (newRides.length > 0) {
                bar.style.display = 'block';
                count.textContent = newRides.length;
            } else {
                bar.style.display = 'none';
            }
        }
        
        // Alarm-Sound (Lauter Beep)
        function playAdminAlarmSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // 3x hintereinander abspielen
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800; // Hoher Ton
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                }, i * 400);
            }
        }
        
        // Hauptfunktion: Alarm auslÃ¶sen
        function triggerAdminAlarm(newRideCount) {
            console.log('ğŸš¨ ADMIN ALARM: Neue Fahrt(en)!', newRideCount);
            
            // ğŸ†• v5.31.5: Dezente Benachrichtigung IMMER updaten
            updateNotificationBar();
            
            // ğŸ†• v5.31.5: PrÃ¼fe ob Alarm deaktiviert ist
            const alarmDisabled = localStorage.getItem('disableAdminAlarm') === 'true';
            
            if (alarmDisabled) {
                console.log('ğŸ”• Alarm-Modal ist deaktiviert - nur dezente Benachrichtigung');
                return; // STOP! Nur dezente Benachrichtigung anzeigen
            }
            
            // 1. Sound abspielen (nur wenn nicht deaktiviert)
            playAdminAlarmSound();
            
            // 2. Browser-Notification (wenn erlaubt)
            if (Notification.permission === 'granted') {
                new Notification('ğŸš• NEUE FAHRT!', {
                    body: `${newRideCount} neue Fahrt${newRideCount > 1 ? 'en' : ''} wartet auf Zuweisung!`,
                    icon: 'ğŸš•',
                    requireInteraction: true
                });
            }
            
            // 3. Modal anzeigen
            showAdminAlarmModal();
            
            // 4. Wiederholungs-Timer starten (alle 3 Min)
            if (adminAlarmInterval) clearInterval(adminAlarmInterval);
            adminAlarmInterval = setInterval(() => {
                const stillNewRides = rides.filter(r => 
                    (r.status === 'new' || r.status === 'vorbestellt') && 
                    !acknowledgedRides.has(r.id) &&
                    !r.vehicleId && // Ignoriere zurÃ¼ckgesetzte
                    !r.driverAssignedAt // Ignoriere schon mal zugewiesene
                ).length;
                if (stillNewRides > 0) {
                    // Nur wenn nicht deaktiviert
                    if (localStorage.getItem('disableAdminAlarm') !== 'true') {
                        playAdminAlarmSound();
                        if (Notification.permission === 'granted') {
                            new Notification('âš ï¸ UNBEARBEITETE FAHRT!', {
                                body: `${stillNewRides} Fahrt${stillNewRides > 1 ? 'en' : ''} noch nicht zugewiesen!`,
                                requireInteraction: true
                            });
                        }
                    }
                } else {
                    clearInterval(adminAlarmInterval);
                    adminAlarmInterval = null;
                }
            }, 3 * 60 * 1000); // 3 Minuten
        }
        
        // Modal anzeigen
        function showAdminAlarmModal() {
            // Entferne altes Modal falls vorhanden
            const oldModal = document.getElementById('admin-alarm-modal');
            if (oldModal) oldModal.remove();
            
            const newRides = rides.filter(r => 
                (r.status === 'new' || r.status === 'vorbestellt') && 
                !acknowledgedRides.has(r.id) &&
                !r.vehicleId && // Ignoriere Fahrten mit vehicleId (zurÃ¼ckgesetzte)
                !r.driverAssignedAt // Ignoriere Fahrten die schon mal zugewiesen waren
            );
            if (newRides.length === 0) return;
            
            const modal = document.createElement('div');
            modal.id = 'admin-alarm-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(220,38,38,0.95);display:flex;align-items:center;justify-content:center;z-index:99999;animation:pulse 1s infinite;';
            
            const ride = newRides[0];
            // ğŸ›¡ï¸ FIX: pickupTimestamp verwenden ODER pickupTime direkt anzeigen
            let pickupTime = 'Sofort';
            if (ride.pickupTimestamp) {
                pickupTime = new Date(ride.pickupTimestamp).toLocaleString('de-DE', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } else if (ride.pickupTime && ride.pickupTime !== 'Sofort') {
                pickupTime = ride.pickupTime; // Bereits formatierter String
            }
            
            const title = newRides.length === 1 ? 'NEUE FAHRT!' : `${newRides.length} NEUE FAHRTEN!`;
            
            modal.innerHTML = `
                <div style="background:white;border-radius:20px;padding:40px;max-width:500px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.5);">
                    <div style="font-size:80px;margin-bottom:20px;animation:bounce 1s infinite;">ğŸš•</div>
                    <h2 style="margin:0 0 10px 0;font-size:32px;color:#dc2626;">${title}</h2>
                    <div style="background:#fef2f2;padding:20px;border-radius:12px;margin:20px 0;text-align:left;">
                        <div style="margin-bottom:10px;"><strong>ğŸ“ Von:</strong> ${ride.pickup}</div>
                        <div style="margin-bottom:10px;"><strong>ğŸ“ Nach:</strong> ${ride.destination}</div>
                        <div style="margin-bottom:10px;"><strong>ğŸ’¾ Name:</strong> ${ride.customerName}</div>
                        <div style="margin-bottom:10px;"><strong>ğŸ’¾ Tel:</strong> ${ride.customerPhone}</div>
                        <div style="margin-bottom:10px;"><strong>ğŸ• Abholung:</strong> ${pickupTime}</div>
                    </div>
                    <button onclick="acknowledgeAdminAlarm()" style="width:100%;padding:18px;background:#dc2626;color:white;border:none;border-radius:12px;font-size:18px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(220,38,38,0.4);">
                        âœ“ BestÃ¤tigt - Fahrer zuweisen!
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Alarm bestÃ¤tigen
        function acknowledgeAdminAlarm() {
            const newRides = rides.filter(r => 
                (r.status === 'new' || r.status === 'vorbestellt') &&
                !r.vehicleId && // Ignoriere zurÃ¼ckgesetzte
                !r.driverAssignedAt // Ignoriere schon mal zugewiesene
            );
            newRides.forEach(r => acknowledgedRides.add(r.id));
            
            // ğŸ’¾ Speichere in localStorage
            saveAcknowledgedRides();
            
            const modal = document.getElementById('admin-alarm-modal');
            if (modal) modal.remove();
            
            // Wechsle zum Admin-Tab
            if (currentView !== 'admin') {
                switchView('admin');
            }
        }
        
        // Badge am Admin-Tab aktualisieren
        function updateAdminBadge(count) {
            const adminBtn = document.getElementById('admin-tab-btn');
            if (!adminBtn) return;
            
            let badge = adminBtn.querySelector('.admin-badge');
            if (!badge) {
                badge = document.createElement('span');
                badge.className = 'admin-badge';
                badge.style.cssText = 'position:absolute;top:-8px;right:-8px;background:#dc2626;color:white;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;box-shadow:0 2px 8px rgba(220,38,38,0.4);';
                adminBtn.style.position = 'relative';
                adminBtn.appendChild(badge);
            }
            
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // ğŸ†• v5.43.0: SCHICHTPLAN-FUNKTIONEN
        
        // Setze heutiges Datum
        function setShiftPlanToday() {
            const today = new Date();
            const dateStr = getLocalDateString(today);  // ğŸ”§ v5.90.353: LOKAL!
            document.getElementById('shift-plan-date').value = dateStr;
            analyzeShiftPlan();
        }
        
        // Analysiere Schichtplan
        function analyzeShiftPlan() {
            const dateInput = document.getElementById('shift-plan-date');
            const resultDiv = document.getElementById('shift-plan-result');
            
            if (!dateInput.value) {
                resultDiv.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“…</div>
                        <div style="font-size: 16px; font-weight: 600;">Bitte Datum wÃ¤hlen</div>
                    </div>
                `;
                return;
            }
            
            const selectedDate = new Date(dateInput.value + 'T00:00:00');
            const dateStr = selectedDate.toLocaleDateString('de-DE', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Filtere Fahrten fÃ¼r das gewÃ¤hlte Datum
            const ridesForDate = rides.filter(ride => {
                if (!ride.pickupTime) return false;
                const rideDate = new Date(ride.pickupTime);
                return rideDate.toDateString() === selectedDate.toDateString();
            });
            
            if (ridesForDate.length === 0) {
                resultDiv.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                        <div style="font-size: 48px; margin-bottom: 15px;">âœ…</div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">${dateStr}</div>
                        <div style="font-size: 16px;">Keine Vorbestellungen</div>
                    </div>
                `;
                return;
            }
            
            // Sortiere nach Zeit
            ridesForDate.sort((a, b) => new Date(a.pickupTime) - new Date(b.pickupTime));
            
            // Berechne Auto-Bedarf pro Stunde
            const hourlyDemand = {};
            
            ridesForDate.forEach(ride => {
                const startTime = new Date(ride.pickupTime);
                // SchÃ¤tze Fahrtdauer: 30 Minuten Standard
                const estimatedDuration = 30;
                const endTime = new Date(startTime.getTime() + estimatedDuration * 60000);
                
                // FÃ¼r jede Stunde der Fahrt
                let currentHour = new Date(startTime);
                currentHour.setMinutes(0, 0, 0);
                
                while (currentHour <= endTime) {
                    const hourKey = currentHour.getHours();
                    if (!hourlyDemand[hourKey]) {
                        hourlyDemand[hourKey] = {
                            count: 0,
                            rides: []
                        };
                    }
                    hourlyDemand[hourKey].count++;
                    if (!hourlyDemand[hourKey].rides.find(r => r.id === ride.id)) {
                        hourlyDemand[hourKey].rides.push(ride);
                    }
                    currentHour = new Date(currentHour.getTime() + 3600000); // +1 Stunde
                }
            });
            
            // Finde Maximum
            let maxCars = 0;
            let maxHour = null;
            Object.keys(hourlyDemand).forEach(hour => {
                if (hourlyDemand[hour].count > maxCars) {
                    maxCars = hourlyDemand[hour].count;
                    maxHour = hour;
                }
            });
            
            // VerfÃ¼gbare Autos
            const availableCars = vehicles ? Object.keys(vehicles).length : 0;
            const isEnough = availableCars >= maxCars;
            
            // Erstelle HTML
            let html = `
                <div style="margin-bottom: 25px;">
                    <h3 style="margin: 0 0 15px 0; font-size: 20px; color: #1f2937;">
                        ğŸ“… ${dateStr}
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: #f3f4f6; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: #667eea;">${ridesForDate.length}</div>
                            <div style="font-size: 14px; color: #6b7280; margin-top: 5px;">Vorbestellungen</div>
                        </div>
                        <div style="background: ${isEnough ? '#d1fae5' : '#fee2e2'}; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: ${isEnough ? '#059669' : '#dc2626'};">${maxCars}</div>
                            <div style="font-size: 14px; color: ${isEnough ? '#065f46' : '#991b1b'}; margin-top: 5px;">Max. benÃ¶tigt</div>
                        </div>
                        <div style="background: #dbeafe; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: #3b82f6;">${availableCars}</div>
                            <div style="font-size: 14px; color: #1e40af; margin-top: 5px;">VerfÃ¼gbar</div>
                        </div>
                    </div>
                    ${isEnough ? 
                        '<div style="background: #d1fae5; border: 2px solid #10b981; color: #065f46; padding: 15px; border-radius: 10px; text-align: center; font-weight: 600;">âœ… Genug Autos verfÃ¼gbar!</div>' : 
                        '<div style="background: #fee2e2; border: 2px solid #dc2626; color: #991b1b; padding: 15px; border-radius: 10px; text-align: center; font-weight: 600;">âš ï¸ WARNUNG: Zu wenig Autos! Fehlende: ' + (maxCars - availableCars) + '</div>'
                    }
                </div>
                
                <h4 style="margin: 25px 0 15px 0; font-size: 18px; color: #1f2937;">ğŸ“± Stunden-Ãœbersicht:</h4>
                <div style="display: grid; gap: 10px;">
            `;
            
            // Sortiere Stunden
            const hours = Object.keys(hourlyDemand).map(h => parseInt(h)).sort((a, b) => a - b);
            
            hours.forEach(hour => {
                const data = hourlyDemand[hour];
                const carIcons = 'ğŸš—'.repeat(data.count);
                const isPeak = data.count === maxCars;
                
                html += `
                    <div style="
                        padding: 15px;
                        background: ${isPeak ? '#fef3c7' : '#f9fafb'};
                        border: 2px solid ${isPeak ? '#f59e0b' : '#e5e7eb'};
                        border-radius: 10px;
                        display: flex;
                        align-items: center;
                        gap: 15px;
                    ">
                        <div style="font-size: 24px; font-weight: 700; color: #667eea; min-width: 100px;">
                            ${hour.toString().padStart(2, '0')}:00-${(hour + 1).toString().padStart(2, '0')}:00
                        </div>
                        <div style="flex: 1; font-size: 24px;">
                            ${carIcons}
                        </div>
                        <div style="font-size: 16px; font-weight: 600; color: ${isPeak ? '#d97706' : '#6b7280'};">
                            ${data.count} Auto${data.count > 1 ? 's' : ''}
                            ${isPeak ? ' ğŸ”¥' : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Fahrten-Liste
            html += `
                <h4 style="margin: 25px 0 15px 0; font-size: 18px; color: #1f2937;">ğŸš• Alle Fahrten:</h4>
                <div style="display: grid; gap: 10px;">
            `;
            
            ridesForDate.forEach(ride => {
                const time = new Date(ride.pickupTime);
                const timeStr = time.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                
                html += `
                    <div style="
                        padding: 12px;
                        background: white;
                        border: 1px solid #e5e7eb;
                        border-radius: 8px;
                        font-size: 14px;
                    ">
                        <div style="font-weight: 700; color: #667eea; margin-bottom: 5px;">
                            â° ${timeStr}
                        </div>
                        <div style="color: #6b7280;">
                            ğŸ“ ${ride.pickup || 'Abholort'} â†’ ğŸ¯ ${ride.destination || 'Zielort'}
                        </div>
                        ${ride.assignedTo ? 
                            `<div style="color: #10b981; margin-top: 5px;">âœ… Zugewiesen: ${vehicles[ride.assignedTo]?.name || ride.assignedTo}</div>` : 
                            `<div style="color: #f59e0b; margin-top: 5px;">âš ï¸ Noch nicht zugewiesen</div>`
                        }
                    </div>
                `;
            });
            
            html += '</div>';
            
            resultDiv.innerHTML = html;
            console.log('ğŸ“± Schichtplan analysiert:', {
                datum: dateStr,
                fahrten: ridesForDate.length,
                maxAutos: maxCars,
                verfÃ¼gbar: availableCars
            });
        }

        // ğŸ“± TELEGRAM BOT INTEGRATION
        // ğŸ†• v5.90.525: TOKEN AUS FIREBASE LADEN (GitHub-Safe!)
        let TELEGRAM_BOT_TOKEN = '8H5659899g:AAgqDjyWmlnd70-xkewBlGunp67jH1jxV1M'; // Fallback
        const TELEGRAM_BOT_USERNAME = 'FunkTaxiHeringsdorfBot';
        
        // Token beim Start laden
        async function loadTelegramToken() {
            if (!isFirebaseReady) return;
            
            try {
                const snapshot = await db.ref('settings/telegram/botToken').once('value');
                const firebaseToken = snapshot.val();
                
                if (firebaseToken) {
                    TELEGRAM_BOT_TOKEN = firebaseToken;
                    console.log('âœ… Telegram Bot Token geladen aus Firebase');
                } else {
                    console.log('â„¹ï¸ Nutze Standard-Token (nicht in Firebase gefunden)');
                    // Speichere Standard-Token in Firebase
                    await db.ref('settings/telegram/botToken').set(TELEGRAM_BOT_TOKEN);
                    console.log('ğŸ’¾ Standard-Token in Firebase gespeichert');
                }
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden des Telegram Tokens:', error);
                console.log('â„¹ï¸ Nutze Fallback-Token');
            }
        }
        
        // Telegram-Nachricht senden
        async function sendTelegramMessage(chatId, text) {
            try {
                // 5 Sekunden Timeout fÃ¼r Telegram API
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: text,
                        parse_mode: 'HTML'
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const data = await response.json();
                if (data.ok) {
                    console.log('âœ… Telegram gesendet an Chat', chatId);
                } else {
                    console.error('ğŸ’¾ Telegram Fehler:', data);
                    // ğŸ“œ PROTOKOLL: Telegram-Fehler
                    logActivity('system', 'telegram_error', `Telegram-Fehler: ${data.description || 'Unbekannt'}`, {
                        chatId: chatId,
                        errorCode: data.error_code
                    });
                }
                return data.ok;
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.error('ğŸ’¾ Telegram Timeout (5s)');
                    logActivity('system', 'telegram_error', 'Telegram Timeout (5 Sekunden)', { chatId: chatId });
                } else {
                    console.error('ğŸ’¾ Telegram Fehler:', error);
                    // ğŸ“œ PROTOKOLL: Telegram-Fehler
                    logActivity('system', 'telegram_error', `Telegram nicht erreichbar: ${error.message}`, {
                        chatId: chatId
                    });
                }
                return false;
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.87.93: SMS BENACHRICHTIGUNGEN VIA SEVEN.IO
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // ğŸ†• v5.87.95: SMS VIA GOOGLE APPS SCRIPT PROXY
        const SMS_PROXY_URL = 'https://script.google.com/macros/s/AKfycbxfpDB-2HgzQfc-LhFIGZ8Szz26kNTl5zVsWxrYOwhLZ978I15pXreEWIWI8w_By7Aa/exec';
        const SMS_SENDER = 'FunkTaxi';
        
        // SMS senden via seven.io
        async function sendSMS(phoneNumber, message) {
            if (!phoneNumber) {
                console.log('âš ï¸ Keine Telefonnummer fÃ¼r SMS');
                return false;
            }
            
            // PrÃ¼fe ob SMS aktiviert ist
            const smsEnabled = localStorage.getItem('smsEnabled') !== 'false';
            if (!smsEnabled) {
                console.log('âš ï¸ SMS ist deaktiviert');
                return false;
            }
            
            // Formatiere Telefonnummer (entferne Leerzeichen, fÃ¼ge 49 hinzu wenn nÃ¶tig)
            let formattedPhone = phoneNumber.replace(/[\s\-\/\(\)]/g, '');
            if (formattedPhone.startsWith('0')) {
                formattedPhone = '49' + formattedPhone.substring(1);
            } else if (formattedPhone.startsWith('+')) {
                formattedPhone = formattedPhone.substring(1);
            }
            
            // PrÃ¼fe ob gÃ¼ltige Mobilnummer (15, 16, 17, 151, 152, etc.)
            if (!formattedPhone.match(/^49(15|16|17|1)/)) {
                console.log('âš ï¸ Keine gÃ¼ltige Mobilnummer:', formattedPhone);
                return false;
            }
            
            console.log('ğŸ“± Sende SMS an:', formattedPhone);
            
            try {
                const response = await fetch(SMS_PROXY_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    body: JSON.stringify({
                        to: formattedPhone,
                        text: message,
                        from: SMS_SENDER
                    })
                });
                
                const text = await response.text();
                let data;
                try { data = JSON.parse(text); } catch(e) { data = { raw: text }; }
                
                if (response.ok) {
                    console.log('âœ… SMS gesendet!', data);
                    logActivity('system', 'sms_sent', `SMS an ${formattedPhone}`, { message: message.substring(0, 50) });
                    return true;
                } else {
                    console.error('ğŸ’¾ SMS Fehler:', data);
                    logActivity('system', 'sms_error', `SMS Fehler: ${JSON.stringify(data)}`, { phone: formattedPhone });
                    return false;
                }
            } catch (error) {
                console.error('ğŸ’¾ SMS Fehler:', error);
                logActivity('system', 'sms_error', `SMS nicht gesendet: ${error.message}`, { phone: formattedPhone });
                return false;
            }
        }
        
        // SMS bei neuer Buchung senden
        async function sendBookingConfirmationSMS(ride) {
            if (!ride.phone) return false;
            
            const dateStr = new Date(ride.pickupTimestamp || ride.pickupTime).toLocaleDateString('de-DE', {
                day: '2-digit', month: '2-digit'
            });
            const timeStr = new Date(ride.pickupTimestamp || ride.pickupTime).toLocaleTimeString('de-DE', {
                hour: '2-digit', minute: '2-digit'
            });
            
            // Kurze Strecke (max 30 Zeichen)
            const fromShort = (ride.pickup || '').split(',')[0].substring(0, 30);
            const toShort = (ride.destination || '').split(',')[0].substring(0, 30);
            
            const message = `âœ… Taxi bestÃ¤tigt!\n${dateStr} ${timeStr}\n${fromShort} â†’ ${toShort}\n${ride.price ? ride.price + 'â‚¬' : ''}\nFunk Taxi Heringsdorf\n038378/22022`;
            
            return await sendSMS(ride.phone, message);
        }
        
        // SMS wenn Fahrer unterwegs ist
        async function sendDriverOnWaySMS(ride) {
            if (!ride.phone) return false;
            
            const message = `ğŸš• Ihr Taxi ist unterwegs!\nFahrer kommt in wenigen Minuten.\nFunk Taxi Heringsdorf`;
            
            return await sendSMS(ride.phone, message);
        }
        
        // Alarm Ã¼ber Telegram senden (VERALTET - wird nicht mehr verwendet)
        // JEDE Fahrt bekommt jetzt ihre eigene Nachricht via sendTelegramForNewRide()
        async function sendTelegramAlarm() {
            // Diese Funktion ist veraltet
            console.log('âš ï¸ sendTelegramAlarm ist veraltet - Fahrten werden einzeln gesendet');
        }
        
        // ğŸ†• v5.25.6: TELEGRAM AN ADMIN bei wichtigen Events
        async function sendTelegramToAdmin(message) {
            if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) {
                console.log('âš ï¸ Telegram nicht konfiguriert');
                return false;
            }
            
            try {
                // Sende an Haupt-Chat-ID (Admin)
                const success = await sendTelegramMessage(TELEGRAM_CHAT_ID, message);
                if (success) {
                    console.log('ğŸ“± Admin-Telegram gesendet');
                }
                return success;
            } catch (error) {
                console.error('ğŸ’¾ Admin-Telegram Fehler:', error);
                return false;
            }
        }
        
        // ğŸ†• v5.18.0: TELEGRAM DIREKT AN ZUGEWIESENEN FAHRER!
        // ğŸ†• v5.19.0: Erweitert mit GPS-Warnung + User-basierte Chat-ID
        async function sendTelegramToDriver(vehicleId, ride, gpsAgeMinutes = 0) {
            if (!isFirebaseReady) return false;
            
            try {
                // Hole Fahrer-Daten aus Firebase
                const driverSnapshot = await db.ref('vehicles/' + vehicleId).once('value');
                const driverData = driverSnapshot.val();
                
                if (!driverData) {
                    console.log('âš ï¸ Keine Fahrer-Daten fÃ¼r:', vehicleId);
                    return false;
                }
                
                const driverName = driverData.vehicle || vehicleId;
                const userId = driverData.userId;
                
                // ğŸ†• v5.19.0: Hole Chat-ID vom USER (nicht vom Fahrzeug!)
                let chatId = null;
                
                if (userId) {
                    const userSnapshot = await db.ref('users/' + userId + '/telegramChatId').once('value');
                    chatId = userSnapshot.val();
                    console.log('ğŸ“± Chat-ID von User', userId, ':', chatId);
                }
                
                // Fallback: Alte Struktur (Chat-ID beim Fahrzeug)
                if (!chatId && driverData.telegramChatId) {
                    chatId = driverData.telegramChatId;
                    console.log('ğŸ“± Chat-ID von Fahrzeug (Fallback):', chatId);
                }
                
                if (!chatId) {
                    console.log('âš ï¸ Fahrer hat keine Telegram-ID hinterlegt:', vehicleId);
                    return false;
                }
                
                // ğŸ†• GPS-Warnung wenn Position Ã¤lter als 3 Minuten
                let gpsWarning = '';
                if (gpsAgeMinutes > 3) {
                    gpsWarning = `\nâš ï¸ <b>ACHTUNG:</b> Dein GPS ist seit ${gpsAgeMinutes} Min offline!\n` +
                                 `ğŸ‘‰ App Ã¶ffnen damit GPS wieder lÃ¤uft!\n`;
                }
                
                // Formatiere Nachricht fÃ¼r Fahrer MIT RIDE-ID
                const rideId = ride.firebaseId || ride.id || 'unbekannt';
                
                // ğŸ†• v5.75.0: Kunde + Gast-Name!
                // ğŸ†• v5.88.21: + Gast-Telefon!
                let customerInfo = `ğŸ’¾ <b>Kunde:</b> ${ride.customerName}`;
                if (ride.guestName) {
                    customerInfo += `\nğŸ§³ <b>Fahrgast:</b> ${ride.guestName}`;
                }
                if (ride.guestPhone) {
                    customerInfo += `\nğŸ“± <b>Fahrgast-Tel:</b> ${ride.guestPhone}`;
                }
                
                const message = `ğŸš¨ <b>NEUER AUFTRAG FÃœR DICH!</b> ğŸš¨\n` +
                    `ğŸ†” <b>ID:</b> <code>${rideId}</code>\n\n` +
                    `â±ï¸ <b>Du hast 60 SEKUNDEN Zeit!</b>\n` +
                    gpsWarning +
                    `\nğŸ“ <b>Abholung:</b> ${ride.pickup}\n` +
                    `ğŸ¯ <b>Ziel:</b> ${ride.destination}\n` +
                    customerInfo + `\n` +
                    `ğŸ’¾ <b>Tel:</b> ${ride.customerPhone}\n` +
                    `ğŸ’° <b>Preis:</b> ${ride.price}â‚¬\n\n` +
                    `ğŸ‘‰ <b>JETZT App Ã¶ffnen und ANNEHMEN!</b>\n` +
                    `<a href="https://patrick061977.github.io/taxi/">ğŸš• App Ã¶ffnen</a>`;
                
                const success = await sendTelegramMessage(chatId, message);
                
                if (success) {
                    console.log('âœ… Telegram an Fahrer gesendet:', driverName, chatId);
                    logActivity('system', 'telegram_driver', `ğŸ“± Telegram an Fahrer: ${driverName}`, {
                        driver: driverName,
                        vehicleId: vehicleId,
                        customer: ride.customerName,
                        gpsAge: gpsAgeMinutes + ' Min'
                    });
                }
                
                return success;
                
            } catch (error) {
                console.error('ğŸ’¾ Telegram an Fahrer Fehler:', error);
                return false;
            }
        }
        
        // ğŸ†• v5.20.4: TELEGRAM AN FAHRER BEI STORNIERUNG
        async function sendTelegramToDriverCancel(vehicleId, message) {
            console.log('ğŸ“± sendTelegramToDriverCancel gestartet fÃ¼r:', vehicleId);
            
            if (!isFirebaseReady) {
                console.log('ğŸ’¾ Firebase nicht bereit!');
                return false;
            }
            
            try {
                // Hole Fahrer-Daten aus Firebase
                const driverSnapshot = await db.ref('vehicles/' + vehicleId).once('value');
                const driverData = driverSnapshot.val();
                
                console.log('ğŸ“± Fahrer-Daten:', driverData ? 'gefunden' : 'NICHT gefunden', driverData);
                
                if (!driverData) {
                    console.log('âš ï¸ Keine Fahrer-Daten fÃ¼r:', vehicleId);
                    return false;
                }
                
                const userId = driverData.userId;
                console.log('ğŸ’¾ userId:', userId);
                
                let chatId = null;
                
                // Chat-ID vom USER holen
                if (userId) {
                    const userSnapshot = await db.ref('users/' + userId + '/telegramChatId').once('value');
                    chatId = userSnapshot.val();
                    console.log('ğŸ“± Chat-ID von User:', chatId);
                }
                
                // Fallback: Chat-ID vom Fahrzeug
                if (!chatId && driverData.telegramChatId) {
                    chatId = driverData.telegramChatId;
                    console.log('ğŸ“± Chat-ID von Fahrzeug (Fallback):', chatId);
                }
                
                if (!chatId) {
                    console.log('âš ï¸ Fahrer hat keine Telegram-ID:', vehicleId);
                    return false;
                }
                
                console.log('ğŸ“¤ Sende Telegram an Chat-ID:', chatId);
                const success = await sendTelegramMessage(chatId, message);
                
                if (success) {
                    console.log('âœ… Stornierung-Telegram an Fahrer gesendet:', vehicleId, chatId);
                    
                    // Protokoll
                    logActivity('system', 'telegram_cancel', `ğŸ“± Stornierung an Fahrer: ${vehicleId}`, {
                        vehicleId: vehicleId,
                        chatId: chatId
                    });
                } else {
                    console.log('ğŸ’¾ Telegram senden fehlgeschlagen!');
                }
                
                return success;
                
            } catch (error) {
                console.error('ğŸ’¾ Telegram Stornierung Fehler:', error);
                return false;
            }
        }
        
        // ğŸ†• v5.32.3: SMS AN KUNDEN SENDEN
        async function sendCustomerSMS(phone, trackingLink, ride) {
            // ğŸ†• v5.87.94: ZWEI SEPARATE SMS-TYPEN
            
            if (!phone) {
                console.log('âš ï¸ Keine Telefonnummer fÃ¼r SMS');
                return false;
            }
            
            // ğŸ†• v5.88.9: PrÃ¼fe ob BUCHUNGS-SMS aktiviert ist (aus FIREBASE!)
            let bookingEnabled = false;
            try {
                const snapshot = await db.ref('settings/sms/bookingEnabled').once('value');
                bookingEnabled = snapshot.val() === true;
            } catch (err) {
                console.log('âš ï¸ Konnte SMS-Einstellung nicht laden:', err);
            }
            
            if (!bookingEnabled) {
                console.log('âš ï¸ Buchungs-SMS ist deaktiviert (Firebase)');
                return false;
            }
            
            // Formatiere Telefonnummer
            let formattedPhone = phone.replace(/[\s\-\/\(\)]/g, '');
            if (formattedPhone.startsWith('0')) {
                formattedPhone = '49' + formattedPhone.substring(1);
            } else if (formattedPhone.startsWith('+')) {
                formattedPhone = formattedPhone.substring(1);
            }
            
            // PrÃ¼fe ob gÃ¼ltige Mobilnummer
            if (!formattedPhone.match(/^49(15|16|17|1)/)) {
                console.log('âš ï¸ Keine gÃ¼ltige Mobilnummer:', formattedPhone);
                return false;
            }
            
            // Formatiere Datum/Zeit
            const pickupTime = new Date(ride.pickupTimestamp || ride.pickupTime || Date.now());
            const dateStr = pickupTime.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
            const timeStr = pickupTime.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            
            // Kurze Adressen
            const fromShort = (ride.pickup || '').split(',')[0].substring(0, 25);
            const toShort = (ride.destination || '').split(',')[0].substring(0, 25);
            const priceStr = ride.price ? '\n' + ride.price + 'â‚¬' : '';
            
            // SMS 1: NUR BuchungsbestÃ¤tigung (OHNE Tracking-Link!)
            const smsText = `âœ… Taxi bestÃ¤tigt!\n${dateStr} ${timeStr}\n${fromShort} â†’ ${toShort}${priceStr}\nFunk Taxi 038378/22022`;
            
            console.log('ğŸ“± Sende BUCHUNGS-SMS an:', formattedPhone);
            
            try {
                const response = await fetch(SMS_PROXY_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    body: JSON.stringify({
                        to: formattedPhone,
                        text: smsText,
                        from: SMS_SENDER
                    })
                });
                
                const text = await response.text();
                let data;
                try { data = JSON.parse(text); } catch(e) { data = { raw: text }; }
                
                if (response.ok) {
                    console.log('âœ… Buchungs-SMS gesendet!', data);
                    logActivity('customer', 'sms_booking_sent', `Buchungs-SMS an ${formattedPhone}`, { phone: formattedPhone });
                    return true;
                } else {
                    console.error('ğŸ’¾ SMS Fehler:', data);
                    logActivity('customer', 'sms_error', `SMS-Fehler: ${JSON.stringify(data)}`, { phone: formattedPhone });
                    return false;
                }
                
            } catch (error) {
                console.error('ğŸ’¾ SMS Fehler:', error);
                logActivity('customer', 'sms_error', `SMS-Fehler: ${error.message}`, { phone: phone });
                return false;
            }
        }
        
        // ğŸ†• v5.87.94: MAP-NULL-CHECK-FIX-SMS (wenn Fahrer annimmt)
        async function sendTrackingSMS(phone, trackingLink) {
            if (!phone) {
                console.log('âš ï¸ Keine Telefonnummer fÃ¼r Tracking-SMS');
                return false;
            }
            
            // ğŸ†• v5.88.9: PrÃ¼fe ob MAP-NULL-CHECK-FIX-SMS aktiviert ist (aus FIREBASE!)
            let trackingEnabled = false;
            try {
                const snapshot = await db.ref('settings/sms/trackingEnabled').once('value');
                trackingEnabled = snapshot.val() === true;
            } catch (err) {
                console.log('âš ï¸ Konnte SMS-Einstellung nicht laden:', err);
            }
            
            if (!trackingEnabled) {
                console.log('âš ï¸ Tracking-SMS ist deaktiviert (Firebase)');
                return false;
            }
            
            // Formatiere Telefonnummer
            let formattedPhone = phone.replace(/[\s\-\/\(\)]/g, '');
            if (formattedPhone.startsWith('0')) {
                formattedPhone = '49' + formattedPhone.substring(1);
            } else if (formattedPhone.startsWith('+')) {
                formattedPhone = formattedPhone.substring(1);
            }
            
            // PrÃ¼fe ob gÃ¼ltige Mobilnummer
            if (!formattedPhone.match(/^49(15|16|17|1)/)) {
                console.log('âš ï¸ Keine gÃ¼ltige Mobilnummer:', formattedPhone);
                return false;
            }
            
            // SMS 2: Fahrer unterwegs + Tracking-Link
            const smsText = `ğŸš• Ihr Taxi ist unterwegs!\nAnkunft in wenigen Min.\nLive verfolgen:\n${trackingLink}`;
            
            console.log('ğŸ“± Sende MAP-NULL-CHECK-FIX-SMS an:', formattedPhone);
            
            try {
                const response = await fetch(SMS_PROXY_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    body: JSON.stringify({
                        to: formattedPhone,
                        text: smsText,
                        from: SMS_SENDER
                    })
                });
                
                const text = await response.text();
                let data;
                try { data = JSON.parse(text); } catch(e) { data = { raw: text }; }
                
                if (response.ok) {
                    console.log('âœ… Tracking-SMS gesendet!', data);
                    logActivity('customer', 'sms_tracking_sent', `Tracking-SMS an ${formattedPhone}`, { phone: formattedPhone, trackingLink });
                    return true;
                } else {
                    console.error('ğŸ’¾ SMS Fehler:', data);
                    return false;
                }
                
            } catch (error) {
                console.error('ğŸ’¾ SMS Fehler:', error);
                return false;
            }
        }
        
        // ğŸ†• v5.32.3: TELEGRAM AN KUNDEN SENDEN
        async function sendCustomerTelegram(phone, trackingLink, ride) {
            if (!isFirebaseReady) return false;
            
            try {
                // Hole Kunden-Chat-ID aus Firebase (wenn vorhanden)
                // Kunden kÃ¶nnen sich mit dem Bot verknÃ¼pfen Ã¼ber /start
                
                // ğŸ“± Suche nach Kunden-Chat-ID via Telefonnummer
                const customersSnapshot = await db.ref('customers').orderByChild('phone').equalTo(phone).once('value');
                const customersData = customersSnapshot.val();
                
                if (!customersData) {
                    console.log('âš ï¸ Kunde nicht in DB gefunden:', phone);
                    return false;
                }
                
                // Finde ersten Kunden mit telegramChatId
                let chatId = null;
                for (const customerId in customersData) {
                    const customer = customersData[customerId];
                    if (customer.telegramChatId) {
                        chatId = customer.telegramChatId;
                        console.log('ğŸ“± Kunden-Chat-ID gefunden:', chatId);
                        break;
                    }
                }
                
                if (!chatId) {
                    console.log('âš ï¸ Kunde hat keine Telegram-VerknÃ¼pfung:', phone);
                    return false;
                }
                
                // Formatiere Telegram-Nachricht fÃ¼r Kunden
                const pickupTimeDisplay = ride.pickupTime || 'Sofort';
                const message = `ğŸš• <b>IHRE FAHRT WURDE BESTELLT!</b> ğŸš•\n\n` +
                    `ğŸ“ <b>Von:</b> ${ride.pickup}\n` +
                    `ğŸ¯ <b>Nach:</b> ${ride.destination}\n` +
                    `ğŸ• <b>Abholung:</b> ${pickupTimeDisplay}\n` +
                    `ğŸ’° <b>Preis:</b> ${ride.price}â‚¬\n\n` +
                    `ğŸ“² <b>Ihre Fahrt live verfolgen:</b>\n` +
                    `<a href="${trackingLink}">ğŸ—ºï¸ Tracking Ã¶ffnen</a>\n\n` +
                    `âœ… Sie erhalten Updates sobald ein Fahrer zugewiesen wurde!\n\n` +
                    `ğŸ’¾ Bei Fragen: ${ride.customerPhone}`;
                
                const success = await sendTelegramMessage(chatId, message);
                
                if (success) {
                    console.log('âœ… Telegram an Kunde gesendet:', phone, chatId);
                    logActivity('customer', 'telegram_sent', `ğŸ“± Telegram an Kunde: ${ride.customerName}`, {
                        customer: ride.customerName,
                        phone: phone,
                        chatId: chatId,
                        trackingLink: trackingLink
                    });
                }
                
                return success;
                
            } catch (error) {
                console.error('ğŸ’¾ Telegram an Kunde Fehler:', error);
                logActivity('customer', 'telegram_error', `Telegram-Fehler fÃ¼r ${phone}: ${error.message}`, {
                    phone: phone,
                    error: error.message
                });
                return false;
            }
        }
        
        // ğŸ†• v5.32.3: KUNDEN-BENACHRICHTIGUNGEN (SMS + Telegram)
        async function sendCustomerNotifications(ride) {
            console.log('ğŸ“² Sende Kunden-Benachrichtigungen...');
            
            // ğŸ”— Erstelle Tracking-Link
            const trackingLink = `${window.location.origin}${window.location.pathname}?ride=${ride.firebaseId}`;
            
            // ğŸ“± SMS senden
            const smsSuccess = await sendCustomerSMS(ride.customerPhone, trackingLink, ride);
            if (smsSuccess) {
                console.log('âœ… SMS an Kunde gesendet');
            } else {
                console.log('âš ï¸ SMS konnte nicht gesendet werden');
            }
            
            // ğŸ’¬ Telegram senden (wenn verknÃ¼pft)
            const telegramSuccess = await sendCustomerTelegram(ride.customerPhone, trackingLink, ride);
            if (telegramSuccess) {
                console.log('âœ… Telegram an Kunde gesendet');
            } else {
                console.log('âš ï¸ Kunde hat kein Telegram verknÃ¼pft');
            }
            
            // ğŸ’¾ Speichere Status in Firebase
            if (isFirebaseReady && ride.firebaseId) {
                try {
                    await db.ref('rides/' + ride.firebaseId).update({
                        notificationsSent: {
                            sms: smsSuccess,
                            telegram: telegramSuccess,
                            timestamp: Date.now()
                        }
                    });
                    console.log('âœ… Benachrichtigungs-Status in Firebase gespeichert');
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim Speichern des Status:', error);
                }
            }
            
            return {
                sms: smsSuccess,
                telegram: telegramSuccess
            };
        }
        
        // Telegram Chat registrieren (automatisch beim /start)
        async function registerTelegramChat(chatId) {
            if (!isFirebaseReady) return;
            
            try {
                const snapshot = await db.ref('settings/telegram/adminChats').once('value');
                let adminChats = snapshot.val() || [];
                
                if (!adminChats.includes(chatId)) {
                    adminChats.push(chatId);
                    await db.ref('settings/telegram/adminChats').set(adminChats);
                    console.log('âœ… Telegram Chat registriert:', chatId);
                    
                    // BestÃ¤tigungs-Nachricht senden
                    await sendTelegramMessage(chatId, 
                        'âœ… <b>Erfolgreich registriert!</b>\n\n' +
                        'Du bekommst ab jetzt alle neuen Fahrten als Telegram-Nachricht.\n\n' +
                        'ğŸš• Funk Taxi Heringsdorf'
                    );
                }
            } catch (error) {
                console.error('ğŸ’¾ Telegram Registrierung Fehler:', error);
            }
        }
        
        // Telegram sofort beim Erstellen senden (nicht warten auf Admin-Alarm)
        async function sendTelegramForNewRide(ride) {
            if (!isFirebaseReady) return;
            
            // ğŸ›¡ï¸ DUPLIKAT-SCHUTZ: PrÃ¼fe ob diese Fahrt schon gesendet wurde
            const rideKey = ride.firebaseId || ride.id || ride.createdAt;
            if (sentTelegramRides.has(rideKey)) {
                console.log('âš ï¸ Telegram DUPLIKAT verhindert fÃ¼r Fahrt:', rideKey);
                return; // STOP! Nicht nochmal senden!
            }
            
            try {
                // Lade Admin Chat IDs aus Firebase
                const snapshot = await db.ref('settings/telegram/adminChats').once('value');
                const adminChats = snapshot.val() || [];
                
                if (adminChats.length === 0) {
                    console.log('âš ï¸ Keine Telegram-Admin-Chats konfiguriert');
                    return;
                }
                
                // Intelligente Zeit-Formatierung
                const now = new Date();
                const pickupDate = ride.pickupTimestamp ? new Date(ride.pickupTimestamp) : now;
                
                // â° ZEITSTEMPEL fÃ¼r Telegram
                const timestamp = now.toLocaleString('de-DE', {
                    day: '2-digit',
                    month: '2-digit',
                    year: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                // Ist es heute?
                const isToday = pickupDate.toDateString() === now.toDateString();
                
                // Ist es sofort? (innerhalb 15 Min)
                const isSofort = ride.status === 'new';
                
                let pickupTimeFormatted;
                let statusEmoji;
                let statusText;
                
                if (isSofort) {
                    // SOFORT-FAHRT
                    pickupTimeFormatted = 'SOFORT';
                    statusEmoji = 'ğŸš•';
                    statusText = 'SOFORT-FAHRT!';
                } else if (isToday) {
                    // VORBESTELLUNG - Heute
                    const time = pickupDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    pickupTimeFormatted = `Heute ${time}`;
                    statusEmoji = 'ğŸ“…';
                    statusText = 'VORBESTELLUNG';
                } else {
                    // VORBESTELLUNG - Morgen oder spÃ¤ter
                    const date = pickupDate.toLocaleDateString('de-DE', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: '2-digit' 
                    });
                    const time = pickupDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    pickupTimeFormatted = `${date} ${time}`;
                    statusEmoji = 'ğŸ“…';
                    statusText = 'VORBESTELLUNG';
                }
                
                // Formatiere Nachricht MIT ZEITSTEMPEL UND RIDE-ID
                const rideId = ride.firebaseId || ride.id || 'unbekannt';
                const message = `${statusEmoji} <b>${statusText}</b>\n` +
                    `ğŸ†” <b>ID:</b> <code>${rideId}</code>\n\n` +
                    `ğŸ“ <b>Von:</b> ${ride.pickup}\n` +
                    `ğŸ“ <b>Nach:</b> ${ride.destination}\n` +
                    `ğŸ’¾ <b>Name:</b> ${ride.customerName}\n` +
                    `ğŸ’¾ <b>Tel:</b> ${ride.customerPhone}\n` +
                    `ğŸ• <b>Abholung:</b> ${pickupTimeFormatted}\n` +
                    `ğŸ’° <b>Preis:</b> ${ride.price || 0}â‚¬\n` +
                    `â° <b>Gesendet:</b> ${timestamp}\n` +
                    `\nğŸ‘‰ <a href="https://patrick061977.github.io/taxi-App/">App Ã¶ffnen</a>`;
                
                // Sende an alle Admin-Chats
                for (const chatId of adminChats) {
                    await sendTelegramMessage(chatId, message);
                }
                
                // ğŸ›¡ï¸ Markiere als gesendet
                sentTelegramRides.add(rideKey);
                console.log('âœ… Telegram-Benachrichtigung gesendet fÃ¼r Fahrt:', ride.id, 'um', timestamp);
                
                // ğŸ“œ PROTOKOLL: Telegram gesendet
                logActivity('system', 'telegram', `ğŸ“± Telegram versendet: Neue ${ride.status === 'vorbestellt' ? 'Vorbestellung' : 'Buchung'}`, {
                    customer: ride.customerName,
                    type: ride.status === 'vorbestellt' ? 'Vorbestellung' : 'Sofort-Fahrt',
                    recipients: adminChats.length
                });
                
            } catch (error) {
                console.error('ğŸ’¾ Telegram Benachrichtigung Fehler:', error);
                
                // ğŸ“œ PROTOKOLL: Telegram Fehler
                logActivity('system', 'error', `âš ï¸ Telegram nicht erreichbar: ${error.message}`, {
                    error: error.message
                });
            }
        }
        
        // ğŸ“± Telegram bei StatusÃ¤nderungen
        async function sendTelegramStatusUpdate(ride, oldStatus, newStatus) {
            if (!isFirebaseReady) return;
            
            try {
                // Lade Admin Chat IDs aus Firebase
                const snapshot = await db.ref('settings/telegram/adminChats').once('value');
                const adminChats = snapshot.val() || [];
                
                if (adminChats.length === 0) {
                    console.log('âš ï¸ Keine Telegram-Admin-Chats konfiguriert');
                    return;
                }
                
                let message = '';
                let statusEmoji = '';
                
                // Formatiere Nachricht je nach Status
                const rideId = ride.firebaseId || ride.id || 'unbekannt';
                
                if (newStatus === 'accepted') {
                    // âœ… Fahrer zugewiesen
                    statusEmoji = 'âœ…';
                    message = `${statusEmoji} <b>FAHRER ZUGEWIESEN!</b>\n` +
                        `ğŸ†” <b>ID:</b> <code>${rideId}</code>\n\n` +
                        `ğŸš— <b>Fahrzeug:</b> ${ride.vehicle || 'Unbekannt'}${ride.vehiclePlate ? ` (${ride.vehiclePlate})` : ''}\n` +
                        `ğŸ’¾ <b>Kunde:</b> ${ride.customerName}\n` +
                        `ğŸ’¾ <b>Tel:</b> ${ride.customerPhone}\n` +
                        `ğŸ“ <b>Von:</b> ${ride.pickup}\n` +
                        `ğŸ“ <b>Nach:</b> ${ride.destination}\n` +
                        `ğŸ’° <b>Preis:</b> ${ride.price}â‚¬\n` +
                        `\nğŸ‘‰ <a href="https://patrick061977.github.io/taxi-App/">App Ã¶ffnen</a>`;
                        
                } else if (newStatus === 'storniert' || newStatus === 'cancelled') {
                    // ğŸ—‘ï¸ Fahrt storniert
                    statusEmoji = 'ğŸ—‘ï¸';
                    message = `${statusEmoji} <b>FAHRT STORNIERT</b>\n` +
                        `ğŸ†” <b>ID:</b> <code>${rideId}</code>\n\n` +
                        `ğŸ’¾ <b>Kunde:</b> ${ride.customerName}\n` +
                        `ğŸ’¾ <b>Tel:</b> ${ride.customerPhone}\n` +
                        `ğŸ“ <b>Von:</b> ${ride.pickup}\n` +
                        `ğŸ“ <b>Nach:</b> ${ride.destination}\n` +
                        `ğŸ’° <b>Preis:</b> ${ride.price}â‚¬\n` +
                        `\nâš ï¸ Status: Storniert`;
                        
                } else if (newStatus === 'picked_up') {
                    // ğŸš— Kunde abgeholt
                    statusEmoji = 'ğŸš—';
                    message = `${statusEmoji} <b>KUNDE ABGEHOLT!</b>\n` +
                        `ğŸ†” <b>ID:</b> <code>${rideId}</code>\n\n` +
                        `ğŸš— <b>Fahrzeug:</b> ${ride.vehicle || 'Unbekannt'}\n` +
                        `ğŸ’¾ <b>Kunde:</b> ${ride.customerName}\n` +
                        `ğŸ“ <b>Von:</b> ${ride.pickup}\n` +
                        `ğŸ“ <b>Nach:</b> ${ride.destination}\n` +
                        `ğŸ’° <b>Preis:</b> ${ride.price}â‚¬\n` +
                        `\nğŸ¯ Fahrt zum Ziel lÃ¤uft...`;
                        
                } else if (newStatus === 'completed') {
                    // âœ… Fahrt abgeschlossen
                    statusEmoji = 'âœ…';
                    message = `${statusEmoji} <b>FAHRT ABGESCHLOSSEN!</b>\n` +
                        `ğŸ†” <b>ID:</b> <code>${rideId}</code>\n\n` +
                        `ğŸš— <b>Fahrzeug:</b> ${ride.vehicle || 'Unbekannt'}\n` +
                        `ğŸ’¾ <b>Kunde:</b> ${ride.customerName}\n` +
                        `ğŸ“ <b>Von:</b> ${ride.pickup}\n` +
                        `ğŸ“ <b>Nach:</b> ${ride.destination}\n` +
                        `ğŸ’° <b>Preis:</b> ${ride.price}â‚¬\n` +
                        `\nâœ… Status: Abgeschlossen`;
                        
                } else {
                    // Anderer Status - keine Nachricht
                    return;
                }
                
                // Sende an alle Admin-Chats
                for (const chatId of adminChats) {
                    await sendTelegramMessage(chatId, message);
                }
                
                console.log(`âœ… Telegram-Status-Update gesendet: ${oldStatus} â†’ ${newStatus}`);
                
                // ğŸ†• v5.90.62: MAP-NULL-CHECK-FIX-SMS NUR BEI ACCEPTED!
                // (Nicht bei assigned - Fahrer muss erst akzeptieren!)
                if (newStatus === 'accepted' && ride.trackingLink) {
                    const customerPhone = ride.customerPhone || ride.phone;
                    if (customerPhone) {
                        console.log('ğŸ“± Sende Tracking-SMS an Kunde:', customerPhone);
                        await sendTrackingSMS(customerPhone, ride.trackingLink);
                    }
                }
                
                // ğŸ“œ PROTOKOLL: Telegram Status-Update
                logActivity('system', 'telegram', `ğŸ“± Telegram versendet: Status ${oldStatus} â†’ ${newStatus}`, {
                    customer: ride.customerName,
                    oldStatus: oldStatus,
                    newStatus: newStatus
                });
                
            } catch (error) {
                console.error('ğŸ’¾ Telegram Status-Update Fehler:', error);
            }
        }
        
        // Telegram-Aktivierung im Admin-Panel
        function showTelegramActivation() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:99999;';
            
            modal.innerHTML = `
                <div style="background:white;border-radius:16px;padding:30px;max-width:450px;text-align:center;">
                    <div style="font-size:60px;margin-bottom:15px;">ğŸ“±</div>
                    <h2 style="margin:0 0 15px 0;">Telegram-Alarme aktivieren</h2>
                    <p style="color:#666;margin-bottom:25px;">Erhalte Push-Benachrichtigungen Ã¼ber neue Fahrten - auch wenn die App geschlossen ist!</p>
                    
                    <div style="background:#f3f4f6;padding:15px;border-radius:10px;margin-bottom:20px;text-align:left;">
                        <div style="font-weight:600;margin-bottom:10px;">ğŸ“‹ Anleitung:</div>
                        <div style="font-size:14px;line-height:1.8;">
                            1ï¸âƒ£ Klicke auf "Bot Ã¶ffnen"<br>
                            2ï¸âƒ£ Schreibe <code>/start</code> im Bot<br>
                            3ï¸âƒ£ Klicke auf "Chat ID anzeigen"<br>
                            4ï¸âƒ£ Kopiere die Zahl (<code>"id":123482789</code>)<br>
                            5ï¸âƒ£ Trage sie hier ein und klicke "Registrieren"
                        </div>
                    </div>
                    
                    <button onclick="window.open('https://t.me/${TELEGRAM_BOT_USERNAME}', '_blank');" style="width:100%;padding:15px;background:#0088cc;color:white;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;margin-bottom:10px;">
                        ğŸ“± Bot Ã¶ffnen
                    </button>
                    
                    <button onclick="window.open('https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getUpdates', '_blank');" style="width:100%;padding:12px;background:#f3f4f6;color:#333;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;margin-bottom:15px;">
                        ğŸ” Chat ID anzeigen
                    </button>
                    
                    <input type="text" id="telegram-chat-id-input" placeholder="Chat ID hier eintragen..." style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;margin-bottom:10px;font-size:14px;box-sizing:border-box;">
                    
                    <button onclick="registerManualChatId()" style="width:100%;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;margin-bottom:10px;">
                        âœ… Chat ID registrieren
                    </button>
                    
                    <button onclick="this.closest('div').parentElement.remove()" style="width:100%;padding:12px;background:#e5e7eb;color:#333;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;">
                        Abbrechen
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Manuelle Chat ID Registrierung
        async function registerManualChatId() {
            const input = document.getElementById('telegram-chat-id-input');
            const chatId = input.value.trim();
            
            if (!chatId || isNaN(chatId)) {
                alert('ğŸ’¾ Bitte gÃ¼ltige Chat ID eingeben!');
                return;
            }
            
            await registerTelegramChat(parseInt(chatId));
            alert('âœ… Chat ID registriert! Teste jetzt mit "Test-Nachricht senden".');
            
            // SchlieÃŸe Modal
            const modal = input.closest('div').parentElement;
            if (modal) modal.remove();
            
            // Update Status
            await updateTelegramStatus();
        }
        
        // ğŸ†• TELEGRAM: Fahrt vom Admin gelÃ¶scht
        async function sendTelegramForDeletedRide(ride) {
            if (!isFirebaseReady) return;
            
            try {
                // Lade Admin Chat IDs aus Firebase
                const snapshot = await db.ref('settings/telegram/adminChats').once('value');
                const adminChats = snapshot.val() || [];
                
                if (adminChats.length === 0) {
                    console.log('âš ï¸ Keine Telegram-Admin-Chats konfiguriert');
                    return;
                }
                
                // â° ZEITSTEMPEL
                const timestamp = new Date().toLocaleString('de-DE', {
                    day: '2-digit',
                    month: '2-digit',
                    year: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                // Formatiere Status
                let statusText = 'Nicht zugewiesen';
                if (ride.status === 'accepted') statusText = 'âœ… Angenommen';
                if (ride.status === 'picked_up') statusText = 'ğŸš— Unterwegs';
                if (ride.status === 'vorbestellt') statusText = 'ğŸ“… Vorbestellt';
                
                // Erstelle Nachricht MIT ZEITSTEMPEL UND RIDE-ID
                const rideId = ride.firebaseId || ride.id || 'unbekannt';
                const message = `ğŸ—‘ï¸ <b>FAHRT GELÃ–SCHT (Admin)</b>\n` +
                    `ğŸ†” <b>ID:</b> <code>${rideId}</code>\n\n` +
                    `âš ï¸ <b>Status war:</b> ${statusText}\n` +
                    (ride.vehicle ? `ğŸš— <b>Fahrzeug:</b> ${ride.vehicle}${ride.vehiclePlate ? ` (${ride.vehiclePlate})` : ''}\n` : '') +
                    `ğŸ’¾ <b>Kunde:</b> ${ride.customerName}\n` +
                    `ğŸ’¾ <b>Tel:</b> ${ride.customerPhone}\n` +
                    `ğŸ“ <b>Von:</b> ${ride.pickup}\n` +
                    `ğŸ“ <b>Nach:</b> ${ride.destination}\n` +
                    (ride.pickupTime && ride.pickupTime !== 'Sofort' ? `â° <b>Abholung:</b> ${ride.pickupTime}\n` : '') +
                    `ğŸ’° <b>Preis:</b> ${ride.price || 0}â‚¬\n` +
                    `â° <b>Gesendet:</b> ${timestamp}\n` +
                    `\nğŸš¨ <b>Diese Fahrt wurde vom Admin gelÃ¶scht!</b>`;
                
                // Sende an alle Admin-Chats
                for (const chatId of adminChats) {
                    await sendTelegramMessage(chatId, message);
                }
                
                console.log('ğŸ“± Telegram: LÃ¶sch-Benachrichtigung gesendet um', timestamp);
                
                // ğŸ“œ PROTOKOLL: Telegram LÃ¶sch-Nachricht
                logActivity('system', 'telegram', `ğŸ“± Telegram versendet: Fahrt gelÃ¶scht`, {
                    customer: ride.customerName,
                    type: 'LÃ¶schung'
                });
                
            } catch (error) {
                console.error('ğŸ’¾ Telegram Fehler:', error);
            }
        }
        
        // ğŸ†• TELEGRAM: Warnung fÃ¼r offene Fahrten (15 Min vor Abholzeit)
        async function sendTelegramOpenRideWarning(ride) {
            if (!isFirebaseReady) return;
            
            const rideKey = ride.firebaseId || ride.id;
            if (warnedOpenRides.has(rideKey)) {
                console.log('âš ï¸ Warnung schon gesendet fÃ¼r Fahrt:', rideKey);
                return;
            }
            
            try {
                const snapshot = await db.ref('settings/telegram/adminChats').once('value');
                const adminChats = snapshot.val() || [];
                
                if (adminChats.length === 0) return;
                
                const timestamp = new Date().toLocaleString('de-DE', {
                    day: '2-digit', month: '2-digit', year: '2-digit',
                    hour: '2-digit', minute: '2-digit'
                });
                
                const pickupTime = ride.pickupTime || 'Unbekannt';
                const rideId = ride.firebaseId || ride.id || 'unbekannt';
                
                const message = `ğŸš¨ğŸš¨ğŸš¨ <b>ACHTUNG: OFFENE FAHRT!</b> ğŸš¨ğŸš¨ğŸš¨\n` +
                    `ğŸ†” <b>ID:</b> <code>${rideId}</code>\n\n` +
                    `â° <b>Abholzeit:</b> ${pickupTime}\n` +
                    `âš ï¸ <b>Noch KEIN Fahrer zugewiesen!</b>\n\n` +
                    `ğŸ’¾ <b>Kunde:</b> ${ride.customerName}\n` +
                    `ğŸ’¾ <b>Tel:</b> ${ride.customerPhone}\n` +
                    `ğŸ“ <b>Von:</b> ${ride.pickup}\n` +
                    `ğŸ“ <b>Nach:</b> ${ride.destination}\n` +
                    `ğŸ’° <b>Preis:</b> ${ride.price}â‚¬\n\n` +
                    `ğŸ”´ <b>Bitte SOFORT einen Fahrer zuweisen!</b>\n` +
                    `â° <b>Warnung gesendet:</b> ${timestamp}`;
                
                for (const chatId of adminChats) {
                    await sendTelegramMessage(chatId, message);
                }
                
                warnedOpenRides.add(rideKey);
                
                console.log('ğŸš¨ Telegram: Offene-Fahrt-Warnung gesendet fÃ¼r', ride.customerName);
                
                logActivity('system', 'telegram', `ğŸš¨ Telegram: OFFENE FAHRT Warnung - ${ride.customerName}`, {
                    customer: ride.customerName,
                    pickupTime: pickupTime,
                    type: 'Warnung'
                });
                
            } catch (error) {
                console.error('ğŸ’¾ Telegram Warnung Fehler:', error);
            }
        }
        
        // ğŸ†• Periodische PrÃ¼fung fÃ¼r offene Vorbestellungen (alle 60 Sek)
        function startOpenRideChecker() {
            console.log('ğŸ” Offene-Fahrten-Checker gestartet (prÃ¼ft alle 60 Sek)');
            
            setInterval(() => {
                if (!isFirebaseReady || !rides || rides.length === 0) return;
                
                const now = Date.now();
                
                rides.forEach(ride => {
                    // Nur Fahrten ohne Fahrer prÃ¼fen
                    if (ride.status !== 'new' && ride.status !== 'vorbestellt') return;
                    if (ride.vehicle || ride.driverId) return; // Hat schon Fahrer
                    
                    // PrÃ¼fe ob Abholzeit in <= 10 Minuten (Zuweisung war bei 15 Min!)
                    const pickupTime = ride.pickupTimestamp || 0;
                    const minutesUntilPickup = (pickupTime - now) / (1000 * 60);
                    
                    if (minutesUntilPickup <= 10 && minutesUntilPickup > 0) {
                        // Noch nicht gewarnt? â†’ Telegram senden!
                        const rideKey = ride.firebaseId || ride.id;
                        if (!warnedOpenRides.has(rideKey)) {
                            console.log('ğŸš¨ Offene Fahrt gefunden! Abholzeit in', Math.round(minutesUntilPickup), 'Min');
                            sendTelegramOpenRideWarning(ride);
                        }
                    }
                });
            }, 60000); // Alle 60 Sekunden prÃ¼fen
        }
        
        // ğŸ†• VORBESTELLUNGS-AKTIVIERER: Aktiviert Vorbestellungen 15 Min vor Abholung
        const activatedPrebookings = new Set(); // Verhindert Doppel-Aktivierung
        
        function startPrebookingActivator() {
            console.log('ğŸ“… Vorbestellungs-Aktivierer gestartet (prÃ¼ft alle 30 Sek)');
            
            setInterval(async () => {
                if (!isFirebaseReady || !rides || rides.length === 0) return;
                
                const now = Date.now();
                let checkedCount = 0;
                let skippedCount = 0;
                
                for (const ride of rides) {
                    // Nur vorbestellte Fahrten prÃ¼fen
                    if (ride.status !== 'vorbestellt') continue;
                    
                    const rideKey = ride.firebaseId || ride.id;
                    if (activatedPrebookings.has(rideKey)) continue; // Schon aktiviert
                    
                    const pickupTime = ride.pickupTimestamp || 0;
                    const minutesUntilPickup = (pickupTime - now) / (1000 * 60);
                    
                    // ğŸ†• v5.90.570: NUR Fahrten < 60 Min prÃ¼fen! (Performance!)
                    if (minutesUntilPickup > 60 || minutesUntilPickup < 0) {
                        skippedCount++;
                        continue;
                    }
                    
                    checkedCount++;
                    
                    // Finde nÃ¤chstes verfÃ¼gbares Taxi
                    const blacklist = ride.assignmentBlacklist || [];
                    const nearestVehicle = findNearestAvailableVehicle(ride.pickupCoords, blacklist);
                    
                    if (!nearestVehicle) {
                        // Kein Taxi verfÃ¼gbar - prÃ¼fe ob Zeit knapp wird
                        if (minutesUntilPickup <= 30 && minutesUntilPickup > 0) {
                            console.log('âš ï¸ WARNUNG: Vorbestellung in', Math.round(minutesUntilPickup), 'Min aber kein Taxi verfÃ¼gbar!');
                            
                            // Telegram an Admin
                            sendTelegramToAdmin(
                                `âš ï¸ <b>VORBESTELLUNG OHNE TAXI!</b>\n\n` +
                                `ğŸ’¾ Kunde: ${ride.customerName || 'Unbekannt'}\n` +
                                `ğŸ“ Abholung: ${ride.pickup}\n` +
                                `ğŸ¯ Ziel: ${ride.destination}\n` +
                                `â° Abholzeit: ${ride.pickupTime}\n` +
                                `â±ï¸ Noch: ${Math.round(minutesUntilPickup)} Minuten\n\n` +
                                `ğŸš« <b>Kein Taxi verfÃ¼gbar!</b>`
                            );
                        }
                        continue; // Warte weiter
                    }
                    
                    // Berechne Anfahrtszeit zum Pickup
                    let drivingTimeMinutes = 0;
                    try {
                        const url = `https://router.project-osrm.org/route/v1/driving/` +
                            `${nearestVehicle.lon},${nearestVehicle.lat};` +
                            `${ride.pickupCoords.lon},${ride.pickupCoords.lat}?overview=false`;
                        
                        const response = await fetch(url);
                        const data = await response.json();
                        
                        if (data.code === 'Ok' && data.routes && data.routes[0]) {
                            drivingTimeMinutes = Math.ceil(data.routes[0].duration / 60);
                        } else {
                            // Fallback: Luftlinie
                            drivingTimeMinutes = Math.ceil(nearestVehicle.distance * 1.5);
                        }
                    } catch (error) {
                        console.error('ğŸ’¾ OSRM Fehler:', error);
                        drivingTimeMinutes = Math.ceil(nearestVehicle.distance * 1.5);
                    }
                    
                    // ğŸ†• v5.90.525: Nutze einstellbaren Puffer aus Settings!
                    const bufferMinutes = pricingSettings.autoAssignBuffer || 10;
                    const requiredLeadTime = drivingTimeMinutes + bufferMinutes;
                    
                    console.log('ğŸ“± Vorbestellungs-Check:', {
                        kunde: ride.customerName,
                        abholzeit: ride.pickupTime,
                        minutenBis: Math.round(minutesUntilPickup),
                        anfahrtszeit: drivingTimeMinutes,
                        puffer: bufferMinutes,
                        benÃ¶tigteVorlaufzeit: requiredLeadTime,
                        taxi: nearestVehicle.name,
                        entfernung: nearestVehicle.distance.toFixed(2) + ' km'
                    });
                    
                    // Aktiviere wenn genug Vorlauf da ist
                    if (minutesUntilPickup <= requiredLeadTime && minutesUntilPickup > -5) {
                        console.log('ğŸ“… AKTIVIERE Vorbestellung:', ride.customerName, 
                            '- Abholzeit in', Math.round(minutesUntilPickup), 'Min',
                            '- Anfahrt:', drivingTimeMinutes, 'Min',
                            '- Vorlauf benÃ¶tigt:', requiredLeadTime, 'Min');
                        
                        // Status auf 'new' setzen
                        try {
                            await db.ref('rides/' + ride.firebaseId).update({
                                status: 'new',
                                activatedAt: Date.now(),
                                activatedFromPrebooking: true,
                                requiredLeadTime: requiredLeadTime,  // ğŸ†• v5.90.525: Speichere Vorlaufzeit
                                drivingTimeToPickup: drivingTimeMinutes  // ğŸ†• v5.90.525: Speichere Anfahrtszeit
                            });
                            
                            activatedPrebookings.add(rideKey);
                            
                            console.log('âœ… Vorbestellung aktiviert:', ride.customerName);
                            
                            // ğŸ¯ AUTO-ZUWEISUNG STARTEN!
                            const updatedRide = { ...ride, status: 'new' };
                            startAutoAssignment(ride.firebaseId, updatedRide);
                            
                            // Telegram Info
                            sendTelegramToAdmin(
                                `âœ… <b>Vorbestellung aktiviert</b>\n\n` +
                                `ğŸ’¾ ${ride.customerName || 'Unbekannt'}\n` +
                                `ğŸ“ ${ride.pickup}\n` +
                                `â° Abholzeit: ${ride.pickupTime}\n` +
                                `ğŸš— NÃ¤chstes Taxi: ${nearestVehicle.name}\n` +
                                `ğŸ“ Entfernung: ${nearestVehicle.distance.toFixed(1)} km\n` +
                                `â±ï¸ Anfahrtszeit: ${drivingTimeMinutes} Min\n` +
                                `â° Aktiviert ${Math.round(minutesUntilPickup)} Min vor Abholung`
                            );
                            
                        } catch (error) {
                            console.error('ğŸ’¾ Fehler beim Aktivieren:', error);
                        }
                    }
                }
            }, 30000); // Alle 30 Sekunden prÃ¼fen
        }
        
        // Telegram Status anzeigen
        async function updateTelegramStatus() {
            const statusEl = document.getElementById('telegram-status');
            if (!statusEl || !isFirebaseReady) return;
            
            try {
                const snapshot = await db.ref('settings/telegram/adminChats').once('value');
                const adminChats = snapshot.val() || [];
                
                if (adminChats.length === 0) {
                    statusEl.innerHTML = 'âš ï¸ Noch keine Admins registriert';
                    statusEl.style.background = '#fef3c7';
                    statusEl.style.color = '#92400e';
                } else {
                    statusEl.innerHTML = `âœ… <b>${adminChats.length}</b> Admin${adminChats.length > 1 ? 's' : ''} registriert<br><small style="opacity:0.7;">Chat IDs: ${adminChats.join(', ')}</small>`;
                    statusEl.style.background = '#d1fae5';
                    statusEl.style.color = '#065f46';
                }
            } catch (error) {
                console.error('ğŸ’¾ Status Update Fehler:', error);
            }
        }
        
        // Test-Nachricht senden
        // ğŸ†• v5.90.525: TELEGRAM BOT TOKEN SPEICHERN IN FIREBASE!
        async function saveTelegramBotToken() {
            if (!isFirebaseReady) {
                alert('ğŸ’¾ Firebase nicht verbunden!');
                return;
            }
            
            const input = document.getElementById('telegram-bot-token-input');
            const statusDiv = document.getElementById('telegram-token-status');
            const token = input.value.trim();
            
            if (!token) {
                statusDiv.innerHTML = '<span style="color:#dc2626;">ğŸ’¾ Bitte Token eingeben!</span>';
                return;
            }
            
            // Token validieren (Format: ZAHLEN:BUCHSTABEN)
            if (!token.match(/^\d+:[A-Za-z0-9_-]+$/)) {
                statusDiv.innerHTML = '<span style="color:#dc2626;">ğŸ’¾ UngÃ¼ltiges Token-Format!</span>';
                return;
            }
            
            try {
                // Speichere in Firebase
                await db.ref('settings/telegram/botToken').set(token);
                
                // Lade Token neu
                TELEGRAM_BOT_TOKEN = token;
                
                statusDiv.innerHTML = '<span style="color:#10b981;">âœ… Token gespeichert! Telegram aktiviert!</span>';
                input.value = '';
                
                console.log('âœ… Telegram Bot Token gespeichert in Firebase');
                
                // Update Status
                setTimeout(() => {
                    updateTelegramStatus();
                }, 1000);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Speichern:', error);
                statusDiv.innerHTML = '<span style="color:#dc2626;">ğŸ’¾ Fehler: ' + error.message + '</span>';
            }
        }
        
        async function sendTelegramTest() {
            if (!isFirebaseReady) {
                alert('ğŸ’¾ Firebase nicht verbunden!');
                return;
            }
            
            try {
                const snapshot = await db.ref('settings/telegram/adminChats').once('value');
                const adminChats = snapshot.val() || [];
                
                if (adminChats.length === 0) {
                    alert('ğŸ’¾ Keine Admins registriert! Bitte erst aktivieren.');
                    return;
                }
                
                const message = 'ğŸ§ª <b>TEST-NACHRICHT</b>\n\n' +
                    'âœ… Telegram-Alarme funktionieren!\n\n' +
                    'ğŸš• Funk Taxi Heringsdorf\n' +
                    `ğŸ“… ${new Date().toLocaleString('de-DE')}`;
                
                let success = 0;
                for (const chatId of adminChats) {
                    const sent = await sendTelegramMessage(chatId, message);
                    if (sent) success++;
                }
                
                alert(`âœ… Test-Nachricht gesendet an ${success}/${adminChats.length} Admin(s)!`);
                
            } catch (error) {
                console.error('ğŸ’¾ Test-Nachricht Fehler:', error);
                alert('ğŸ’¾ Fehler beim Senden!');
            }
        }
        
        // Telegram Updates abrufen (fÃ¼r automatische Registrierung)
        async function checkTelegramUpdates() {
            // Diese Funktion ist jetzt optional - manuelle Registrierung ist bevorzugt
            await updateTelegramStatus();
        }

        // ğŸ“… VORBESTELLUNGEN - ICS Export
        async function exportPrebookingsToICS() {
            const prebookings = rides.filter(r => r.status === 'vorbestellt');
            
            if (prebookings.length === 0) {
                alert('ğŸ“… Keine Vorbestellungen vorhanden!');
                return;
            }
            
            // ğŸ†• v5.64.45: Lade Kalender-Export Settings aus Firebase!
            let settings = defaultCalendarSettings;
            try {
                if (isFirebaseReady) {
                    const snapshot = await db.ref('settings/calendarExport').once('value');
                    settings = snapshot.val() || defaultCalendarSettings;
                    console.log('ğŸ“… Kalender-Settings fÃ¼r Vorbestellungen geladen:', settings);
                }
            } catch (error) {
                console.error('âš ï¸ Settings laden fehlgeschlagen, verwende Defaults:', error);
            }
            
            // ICS Datei erstellen
            let icsContent = 'BEGIN:VCALENDAR\n';
            icsContent += 'VERSION:2.0\n';
            icsContent += 'PRODID:-//Funk Taxi Heringsdorf//DE\n';
            icsContent += 'CALSCALE:GREGORIAN\n';
            icsContent += 'METHOD:PUBLISH\n';
            icsContent += 'X-WR-CALNAME:Funk Taxi Vorbestellungen\n';
            icsContent += 'X-WR-TIMEZONE:Europe/Berlin\n';
            
            prebookings.forEach(ride => {
                const startDate = new Date(ride.pickupTimestamp);
                const endDate = new Date(ride.pickupTimestamp + 60 * 60000); // +1 Stunde
                
                // Formatiere Datum fÃ¼r ICS (YYYYMMDDTHHMMSS)
                const formatDate = (date) => {
                    const pad = (n) => n.toString().padStart(2, '0');
                    return date.getFullYear() + 
                           pad(date.getMonth() + 1) + 
                           pad(date.getDate()) + 'T' +
                           pad(date.getHours()) +
                           pad(date.getMinutes()) + '00';
                };
                
                icsContent += 'BEGIN:VEVENT\n';
                icsContent += `UID:${ride.id}@funktaxi-heringsdorf.de\n`;
                icsContent += `DTSTAMP:${formatDate(new Date())}\n`;
                icsContent += `DTSTART:${formatDate(startDate)}\n`;
                icsContent += `DTEND:${formatDate(endDate)}\n`;
                
                // ğŸ†• v5.64.45: SUMMARY - Basierend auf Settings!
                const customerName = settings.showCustomerName ? ride.customerName : 'Kunde';
                icsContent += `SUMMARY:ğŸš• Taxi ${customerName}\n`;
                
                // ğŸ†• v5.64.45: DESCRIPTION - Basierend auf Settings!
                let descParts = [];
                if (settings.showPickup) descParts.push(`Von: ${ride.pickup}`);
                if (settings.showDestination) descParts.push(`Nach: ${ride.destination}`);
                if (settings.showPhone && ride.customerPhone) descParts.push(`Tel: ${ride.customerPhone}`);
                if (settings.showPrice && ride.price) descParts.push(`Preis: ${ride.price}â‚¬`);
                if (settings.showDistance && ride.distance) descParts.push(`Distanz: ${ride.distance} km`);
                if (settings.showPassengers) descParts.push(`Passagiere: ${ride.passengers || 1}`);
                if (settings.showVehicle && ride.vehicle) descParts.push(`Fahrzeug: ${ride.vehicle}`);
                
                icsContent += `DESCRIPTION:${descParts.join('\\n')}\n`;
                icsContent += `LOCATION:${settings.showPickup ? ride.pickup : 'Abholort'}\n`;
                icsContent += 'STATUS:CONFIRMED\n';
                
                // ğŸ†• v5.64.45: ALARM - Nur wenn aktiviert!
                if (settings.showReminder) {
                    icsContent += 'BEGIN:VALARM\n';
                    icsContent += 'TRIGGER:-PT15M\n';
                    icsContent += 'ACTION:DISPLAY\n';
                    icsContent += `DESCRIPTION:Taxi-Abholung in 15 Minuten: ${customerName}\n`;
                    icsContent += 'END:VALARM\n';
                }
                
                icsContent += 'END:VEVENT\n';
            });
            
            icsContent += 'END:VCALENDAR';
            
            // Download erstellen
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Taxi-Vorbestellungen_${new Date().toISOString().split('T')[0]}.ics`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert(`âœ… ${prebookings.length} Vorbestellung${prebookings.length > 1 ? 'en' : ''} exportiert!\n\nDatei wurde heruntergeladen.`);
        }
        
        // ğŸ“¥ EINZELNE FAHRT als ICS exportieren
        async function exportSingleRideToICS(rideId) {
            // Finde die Fahrt
            const ride = rides.find(r => (r.firebaseId || r.id) === rideId);
            
            if (!ride) {
                alert('ğŸ’¾ Fahrt nicht gefunden!');
                return;
            }
            
            if (!ride.pickupTimestamp) {
                alert('ğŸ’¾ Keine Abholzeit vorhanden!');
                return;
            }
            
            // ğŸ†• v5.64.45: Lade Kalender-Export Settings aus Firebase!
            let settings = defaultCalendarSettings;
            try {
                if (isFirebaseReady) {
                    const snapshot = await db.ref('settings/calendarExport').once('value');
                    settings = snapshot.val() || defaultCalendarSettings;
                    console.log('ğŸ“… Kalender-Settings geladen:', settings);
                }
            } catch (error) {
                console.error('âš ï¸ Settings laden fehlgeschlagen, verwende Defaults:', error);
            }
            
            // ICS Datei erstellen
            let icsContent = 'BEGIN:VCALENDAR\n';
            icsContent += 'VERSION:2.0\n';
            icsContent += 'PRODID:-//Funk Taxi Heringsdorf//DE\n';
            icsContent += 'CALSCALE:GREGORIAN\n';
            icsContent += 'METHOD:PUBLISH\n';
            icsContent += 'X-WR-CALNAME:Funk Taxi Heringsdorf\n';
            icsContent += 'X-WR-TIMEZONE:Europe/Berlin\n';
            
            const startDate = new Date(ride.pickupTimestamp);
            const endDate = new Date(ride.pickupTimestamp + 60 * 60000); // +1 Stunde
            
            // Formatiere Datum fÃ¼r ICS (YYYYMMDDTHHMMSS)
            const formatDate = (date) => {
                const pad = (n) => n.toString().padStart(2, '0');
                return date.getFullYear() + 
                       pad(date.getMonth() + 1) + 
                       pad(date.getDate()) + 'T' +
                       pad(date.getHours()) +
                       pad(date.getMinutes()) + '00';
            };
            
            icsContent += 'BEGIN:VEVENT\n';
            icsContent += `UID:${ride.id}@funktaxi-heringsdorf.de\n`;
            icsContent += `DTSTAMP:${formatDate(new Date())}\n`;
            icsContent += `DTSTART:${formatDate(startDate)}\n`;
            icsContent += `DTEND:${formatDate(endDate)}\n`;
            
            // ğŸ†• v5.88.34: Hilfsfunktion - Ist es eine Mobilnummer?
            function isMobileNumber(phone) {
                if (!phone) return false;
                const cleaned = phone.replace(/[\s\-\/\(\)]/g, '');
                // Deutsche Mobilnummern: 015x, 016x, 017x
                // Oder internationale: +49 15x, +49 16x, +49 17x
                return /^(\+49|0049|0)?1[567]\d/.test(cleaned);
            }
            
            // ğŸ†• v5.64.45: TITLE - Basierend auf Settings!
            const passengerCount = ride.passengers || 1;
            const passengerText = settings.showPassengers ? `${passengerCount} Pers.` : '';
            const nameText = settings.showCustomerName ? ride.customerName : 'Kunde';
            
            // ğŸ†• v5.88.34: Telefon nur im Titel wenn MOBIL!
            const customerPhone = ride.customerPhone || '';
            const customerPhoneIsMobile = isMobileNumber(customerPhone);
            const phoneTextForTitle = (settings.showPhone && customerPhoneIsMobile) ? customerPhone : '';
            
            // ğŸ†• v5.88.34: Gast-Telefon
            const guestPhone = ride.guestPhone || '';
            const guestPhoneIsMobile = isMobileNumber(guestPhone);
            const guestPhoneForTitle = (settings.showGuestPhone && guestPhoneIsMobile) ? guestPhone : '';
            
            let titleParts = [];
            if (settings.showPickup) titleParts.push(ride.pickup);
            if (settings.showDestination) titleParts.push(ride.destination);
            const titleRoute = titleParts.join(' â†’ ');
            
            let titleExtras = [];
            if (passengerText) titleExtras.push(passengerText);
            if (settings.showCustomerName) titleExtras.push(nameText);
            // ğŸ†• v5.88.34: Gastname + Gast-Telefon im Titel
            if (settings.showGuestName && ride.guestName) {
                let guestText = 'ğŸ§³' + ride.guestName;
                if (guestPhoneForTitle) guestText += ' ğŸ“±' + guestPhoneForTitle;
                titleExtras.push(guestText);
            }
            // Nur Mobilnummern im Titel!
            if (phoneTextForTitle) titleExtras.push('ğŸ“±' + phoneTextForTitle);
            
            const titleSummary = titleRoute + (titleExtras.length > 0 ? ' | ' + titleExtras.join(' | ') : '');
            
            // ğŸ†• v5.64.45: DESCRIPTION - Basierend auf Settings!
            let descriptionLines = ['ğŸš• TAXI-FAHRT', ''];
            
            // Fahrzeug (wenn aktiviert und vorhanden)
            if (settings.showVehicle && ride.vehicle) {
                const vehicleInfo = `ğŸš— FAHRZEUG: ${ride.vehicle.toUpperCase()}${ride.vehiclePlate ? ' ('+ride.vehiclePlate+')' : ''}`;
                descriptionLines.push(vehicleInfo, '');
            }
            
            // Kunde
            if (settings.showCustomerName) {
                descriptionLines.push(`Kunde: ${ride.customerName}`);
            }
            // ğŸ†• v5.88.34: Gastname + Gast-Telefon (bei Hotel-Buchungen)
            if (settings.showGuestName && ride.guestName) {
                let guestLine = `ğŸ§³ Gast: ${ride.guestName}`;
                if (settings.showGuestPhone && ride.guestPhone) {
                    guestLine += ` (${ride.guestPhone})`;
                }
                descriptionLines.push(guestLine);
            } else if (settings.showGuestPhone && ride.guestPhone) {
                descriptionLines.push(`ğŸ§³ Gast-Tel: ${ride.guestPhone}`);
            }
            // ğŸ†• v5.88.34: Telefon mit Festnetz/Mobil-Kennzeichnung
            if (settings.showPhone && ride.customerPhone) {
                const phoneIcon = customerPhoneIsMobile ? 'ğŸ“±' : 'â˜ï¸';
                const phoneHint = customerPhoneIsMobile ? '' : ' (Festnetz)';
                descriptionLines.push(`${phoneIcon} Telefon: ${ride.customerPhone}${phoneHint}`);
            }
            if ((settings.showCustomerName || settings.showPhone) && 
                (settings.showPickup || settings.showDestination)) {
                descriptionLines.push('');
            }
            
            // Route
            if (settings.showPickup) {
                descriptionLines.push(`Von: ${ride.pickup}`);
            }
            if (settings.showDestination) {
                descriptionLines.push(`Nach: ${ride.destination}`);
            }
            if ((settings.showPickup || settings.showDestination) && 
                (settings.showPassengers || settings.showPrice || settings.showDistance)) {
                descriptionLines.push('');
            }
            
            // Details
            if (settings.showPassengers) {
                descriptionLines.push(`Passagiere: ${passengerCount}`);
            }
            if (settings.showPrice && ride.price) {
                descriptionLines.push(`Preis: ${ride.price}â‚¬`);
            }
            if (settings.showDistance && ride.distance) {
                descriptionLines.push(`Distanz: ${ride.distance} km`);
            }
            
            // Notizen
            if (settings.showNotes && ride.notes) {
                descriptionLines.push('', `Notizen: ${ride.notes}`);
            }
            
            const description = descriptionLines.join('\\n');
            
            icsContent += `SUMMARY:${titleSummary}\n`;
            icsContent += `DESCRIPTION:${description}\n`;
            icsContent += `LOCATION:${settings.showPickup ? ride.pickup : 'Abholort'}\n`;
            icsContent += 'STATUS:CONFIRMED\n';
            
            // ğŸ†• v5.64.45: ERINNERUNG - Nur wenn aktiviert!
            if (settings.showReminder) {
                let alarmParts = ['ğŸš• Taxi-Abholung in 30 Minuten', ''];
                
                if (settings.showPickup || settings.showDestination) {
                    const alarmRoute = [];
                    if (settings.showPickup) alarmRoute.push(ride.pickup);
                    if (settings.showDestination) alarmRoute.push(ride.destination);
                    alarmParts.push(alarmRoute.join(' â†’ '));
                }
                
                if (settings.showCustomerName) {
                    alarmParts.push(`Kunde: ${ride.customerName}`);
                }
                if (settings.showPhone && ride.customerPhone) {
                    alarmParts.push(`Telefon: ${ride.customerPhone}`);
                }
                if (settings.showPassengers) {
                    alarmParts.push(`Passagiere: ${passengerCount}`);
                }
                if (settings.showVehicle && ride.vehicle) {
                    alarmParts.push(`ğŸš— Fahrzeug: ${ride.vehicle}${ride.vehiclePlate ? ' ('+ride.vehiclePlate+')' : ''}`);
                }
                
                const alarmDescription = alarmParts.join('\\n');
                
                icsContent += 'BEGIN:VALARM\n';
                icsContent += 'TRIGGER:-PT30M\n';
                icsContent += 'ACTION:DISPLAY\n';
                icsContent += `DESCRIPTION:${alarmDescription}\n`;
                icsContent += 'END:VALARM\n';
            }
            
            icsContent += 'END:VEVENT\n';
            icsContent += 'END:VCALENDAR';
            
            // Dateiname mit Datum und Kundenname
            const dateStr = getLocalDateString(startDate);  // ğŸ”§ v5.90.353: LOKAL!
            const timeStr = startDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }).replace(':', '');
            const safeName = ride.customerName.replace(/[^a-zA-Z0-9Ã¤Ã¶Ã¼Ã„Ã–ÃœÃŸ]/g, '_');
            const fileName = `Taxi_${safeName}_${dateStr}_${timeStr}.ics`;
            
            // ğŸ“± MOBILE vs DESKTOP Detection
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            if (isMobile && navigator.share) {
                // ğŸ“± MOBILE: Web Share API
                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const file = new File([blob], fileName, { type: 'text/calendar' });
                
                navigator.share({
                    files: [file],
                    title: titleSummary,
                    text: `Taxi-Fahrt am ${startDate.toLocaleDateString('de-DE')}`
                }).then(() => {
                    console.log('âœ… Erfolgreich geteilt');
                }).catch((error) => {
                    console.error('ğŸ’¾ Share-Fehler:', error);
                    // Fallback zu Download
                    downloadICS(icsContent, fileName, ride, startDate);
                });
            } else {
                // ğŸ’» DESKTOP: Standard Download
                downloadICS(icsContent, fileName, ride, startDate);
            }
        }
        
        // ğŸ“¥ Helper: ICS Download
        function downloadICS(icsContent, fileName, ride, startDate) {
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            // BestÃ¤tigung
            const formattedDate = startDate.toLocaleDateString('de-DE', { 
                weekday: 'short', 
                day: '2-digit', 
                month: '2-digit',
                year: 'numeric'
            });
            const formattedTime = startDate.toLocaleTimeString('de-DE', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            alert(`âœ… Fahrt exportiert!\n\nğŸ“… ${ride.customerName}\nğŸ• ${formattedDate}, ${formattedTime}\n\nâœ… Kalender-Termin wurde heruntergeladen.\n\nğŸ’¡ Tipp: Ã–ffne die .ics-Datei um sie zu deinem Kalender hinzuzufÃ¼gen.`);
        }
        
        // Vorbestellungen-Liste aktualisieren
        function updatePrebookingsList() {
            const listEl = document.getElementById('prebookings-list');
            if (!listEl) return;
            
            const prebookings = rides.filter(r => r.status === 'vorbestellt')
                .sort((a, b) => a.pickupTimestamp - b.pickupTimestamp);
            
            if (prebookings.length === 0) {
                listEl.innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Keine Vorbestellungen</div>';
                return;
            }
            
            listEl.innerHTML = prebookings.map(r => {
                const date = new Date(r.pickupTimestamp);
                const dateStr = date.toLocaleDateString('de-DE', { 
                    day: '2-digit', 
                    month: '2-digit',
                    weekday: 'short'
                });
                const timeStr = date.toLocaleTimeString('de-DE', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                return `
                    <div style="background:#f9fafb;padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid #8b5cf6;">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
                            <div>
                                <div style="font-weight:600;font-size:15px;">${r.customerName}</div>
                                <div style="color:#666;font-size:13px;">ğŸ’¾ ${r.customerPhone}</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-weight:600;color:#8b5cf6;">${dateStr}</div>
                                <div style="font-size:15px;">${timeStr}</div>
                            </div>
                        </div>
                        <div style="font-size:13px;color:#666;line-height:1.6;">
                            ğŸ“ <b>Von:</b> ${r.pickup}<br>
                            ğŸ¯ <b>Nach:</b> ${r.destination}<br>
                            ğŸ’° <b>Preis:</b> ${r.price}â‚¬
                        </div>
                    </div>
                `;
            }).join('');
        }

        function calculatePrice(distance, timestamp = null) {
            // Nutze entweder Ã¼bergebenen timestamp oder jetzt
            const calcTime = timestamp ? new Date(timestamp) : new Date();
            const hour = calcTime.getHours(), day = calcTime.getDay();
            
            // ğŸ†• v5.90.38: PrÃ¼fe Feiertag
            const istFeiertag = isFeiertag(calcTime);
            
            // PrÃ¼fe ob Nachttarif (Mo-Sa 22-6 Uhr, Sonntag ganztÃ¤gig, ODER Feiertag!)
            const isNight = (hour >= 22 || hour < 6) || (day === 0) || istFeiertag;
            
            // WÃ¤hle Tarif
            const grundgebuehr = isNight ? TARIF.nacht_grundgebuehr : TARIF.grundgebuehr;
            const km_1_2 = isNight ? TARIF.nacht_km_1_2 : TARIF.km_1_2;
            const km_3_4 = isNight ? TARIF.nacht_km_3_4 : TARIF.km_3_4;
            const km_ab_5 = isNight ? TARIF.nacht_km_ab_5 : TARIF.km_ab_5;
            
            // Gestaffelte Berechnung
            let kmPreis = 0;
            if (distance <= 2) {
                // 0-2 km: 3,30â‚¬ pro km
                kmPreis = distance * km_1_2;
            } else if (distance <= 4) {
                // 2-4 km: erste 2 km Ã  3,30â‚¬ + Rest Ã  2,80â‚¬
                kmPreis = (2 * km_1_2) + ((distance - 2) * km_3_4);
            } else {
                // >4 km: erste 2 km Ã  3,30â‚¬ + nÃ¤chste 2 km Ã  2,80â‚¬ + Rest Ã  2,20â‚¬
                kmPreis = (2 * km_1_2) + (2 * km_3_4) + ((distance - 4) * km_ab_5);
            }
            
            let base = grundgebuehr + kmPreis;
            let text = [];
            
            // ğŸ†• v5.90.38: Feiertags-Hinweis (hat PrioritÃ¤t vor Nacht/Sonntag)
            if (istFeiertag) {
                text.push('ğŸ‰ Feiertag (Nachttarif)');
            }
            // Nachttarif-Hinweis
            else if (day === 0) {
                text.push('Sonntag (Nachttarif)');
            }
            else if (isNight) {
                text.push('Nachttarif');
            }
            
            // ğŸ’° SURGE PRICING ANWENDEN
            const surge = getCurrentMultiplier();
            let finalPrice = base * surge.factor;
            
            // Surge-Hinweis fÃ¼r Kunde
            if (surge.multiplier > 100) {
                text.push(`ğŸ“ˆ +${surge.multiplier - 100}% Nachfrage`);
            } else if (surge.multiplier < 100) {
                text.push(`ğŸ‰ ${surge.multiplier - 100}% Rabatt`);
            }
            
            const totalRounded = Math.round(finalPrice / 0.1) * 0.1; // Runde auf 10 Cent
            
            return { 
                total: totalRounded.toFixed(2), 
                zuschlagText: text, 
                distance,
                basePrice: base.toFixed(2),
                surgeMultiplier: surge.multiplier
            };
        }

        // ğŸ†• v5.90.85: ROBUSTE 3-STUFEN userId-SUCHE fÃ¼r Admin-Buchungen
        async function findUserIdForCustomer(customerName, customerPhone) {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ” 3-STUFEN userId-SUCHE START');
            console.log('   ğŸ’¾ Name:', customerName || '(nicht vorhanden)');
            console.log('   ğŸ’¾ Phone:', customerPhone || '(nicht vorhanden)');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            let foundUserId = null;
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // STUFE 1: Suche nach PHONE in /users
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (customerPhone) {
                try {
                    const normalized = customerPhone.replace(/\s/g, '');
                    console.log('   ğŸ” STUFE 1: Suche nach phone:', normalized);
                    
                    const snapshot = await db.ref('users')
                        .orderByChild('phone')
                        .equalTo(normalized)
                        .limitToFirst(1)
                        .once('value');
                    
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            foundUserId = child.key;
                            console.log('   âœ… STUFE 1 ERFOLG! userId:', foundUserId);
                        });
                        
                        if (foundUserId) {
                            console.log('ğŸ‰ userId via PHONE gefunden:', foundUserId);
                            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                            return foundUserId;
                        }
                    }
                    console.log('   â­ï¸  STUFE 1: Kein Ergebnis');
                } catch (error) {
                    console.error('   ğŸ’¾ STUFE 1 FEHLER:', error);
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // STUFE 2: Suche nach DISPLAYNAME in /users
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (!foundUserId && customerName) {
                try {
                    console.log('   ğŸ” STUFE 2: Suche nach displayName:', customerName);
                    
                    const snapshot = await db.ref('users')
                        .orderByChild('displayName')
                        .equalTo(customerName)
                        .limitToFirst(1)
                        .once('value');
                    
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            foundUserId = child.key;
                            console.log('   âœ… STUFE 2 ERFOLG! userId:', foundUserId);
                        });
                        
                        if (foundUserId) {
                            console.log('ğŸ‰ userId via NAME gefunden:', foundUserId);
                            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                            return foundUserId;
                        }
                    }
                    console.log('   â­ï¸  STUFE 2: Kein Ergebnis');
                } catch (error) {
                    console.error('   ğŸ’¾ STUFE 2 FEHLER:', error);
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // STUFE 3: ALLE USERS DURCHSUCHEN (Fallback)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (!foundUserId && (customerName || customerPhone)) {
                try {
                    console.log('   ğŸ” STUFE 3: Durchsuche ALLE Users als Fallback...');
                    
                    const allUsers = await db.ref('users').once('value');
                    const normalizedPhone = customerPhone ? customerPhone.replace(/\s/g, '') : '';
                    
                    allUsers.forEach(child => {
                        if (foundUserId) return; // Schon gefunden
                        
                        const userData = child.val();
                        const userPhone = (userData.phone || '').replace(/\s/g, '');
                        const userName = (userData.displayName || '').toLowerCase();
                        const searchName = (customerName || '').toLowerCase();
                        
                        // Phone Match?
                        if (normalizedPhone && userPhone === normalizedPhone) {
                            foundUserId = child.key;
                            console.log('   âœ… STUFE 3 ERFOLG (Phone-Match)! userId:', foundUserId);
                            return;
                        }
                        
                        // Name Match (case-insensitive)?
                        if (searchName && userName === searchName) {
                            foundUserId = child.key;
                            console.log('   âœ… STUFE 3 ERFOLG (Name-Match)! userId:', foundUserId);
                            return;
                        }
                    });
                    
                    if (!foundUserId) {
                        console.log('   â­ï¸  STUFE 3: Kein Ergebnis');
                    }
                } catch (error) {
                    console.error('   ğŸ’¾ STUFE 3 FEHLER:', error);
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // FINAL: ERGEBNIS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (foundUserId) {
                console.log('ğŸ‰ userId GEFUNDEN:', foundUserId);
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                return foundUserId;
            } else {
                console.warn('âš ï¸  userId NICHT GEFUNDEN!');
                console.warn('   â„¹ï¸  Fahrt wird OHNE userId gespeichert');
                console.warn('   â„¹ï¸  Erscheint NICHT in "Meine Fahrten" des Kunden!');
                console.warn('   ğŸ’¡ LÃ–SUNG: Kunde muss sich einmal einloggen damit User-Profil erstellt wird');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                return null;
            }
        }

        // AUTOCOMPLETE
        let autocompleteTimeout = null;
        
        function setupAutocomplete() {
            console.log('ğŸ”§ setupAutocomplete wird initialisiert...');
            
            // ğŸ†• v5.64.34: Auch AI-Buchungsmaske Felder!
            ['pickup', 'destination', 'quick-booking-pickup', 'quick-booking-destination', 'ai-booking-pickup', 'ai-booking-destination'].forEach(id => {
                const input = document.getElementById(id);
                const dropdown = document.getElementById(id + '-dropdown');
                
                if (!input) {
                    console.error('ğŸ’¾ Input-Element nicht gefunden:', id);
                    return;
                }
                
                console.log('âœ… Input Event Listener wird registriert fÃ¼r:', id);
                
                // ğŸ†• v5.86.11: FOCUS EVENT - Zeige Favoriten beim Klick!
                input.addEventListener('focus', () => {
                    const value = input.value.trim();
                    if (!value || value.length < 3) {
                        // Zeige Favoriten sofort!
                        searchAddresses('', id);
                    }
                });
                
                input.addEventListener('input', (e) => {
                    console.log('âŒ¨ï¸ INPUT EVENT!', id, 'Wert:', e.target.value);
                    
                    // Reset coords wenn User manuell tippt
                    if (id === 'pickup') {
                        pickupCoords = null;
                        pickupConfirmed = false;
                        updateConfirmationHint('pickup');
                    } else if (id === 'destination') {
                        destCoords = null;
                        destinationConfirmed = false;
                        updateConfirmationHint('destination');
                    } else if (id === 'qb-panel-pickup') {
                        qbPanelPickupCoords = null; // ğŸ†• v5.50.7: Admin-Panel Coords!
                    } else if (id === 'qb-panel-destination') {
                        qbPanelDestCoords = null; // ğŸ†• v5.50.7: Admin-Panel Coords!
                    } else if (id === 'ai-booking-pickup') {
                        window.aiBookingPickupCoords = null; // ğŸ†• v5.64.34: AI-Maske Coords!
                    } else if (id === 'ai-booking-destination') {
                        window.aiBookingDestCoords = null; // ğŸ†• v5.64.34: AI-Maske Coords!
                    }
                    
                    clearTimeout(autocompleteTimeout);
                    const value = e.target.value.trim();
                    
                    // ğŸ†• v5.86.11: AUCH BEI < 3 ZEICHEN FAVORITEN ZEIGEN!
                    if (value.length === 0) {
                        // Leer? Zeige Favoriten!
                        searchAddresses('', id);
                        return;
                    }
                    
                    if (value.length < 3) {
                        // 1-2 Zeichen? Zeige Favoriten!
                        console.log('âš ï¸ Kurz (<3 Zeichen) - zeige Favoriten:', value.length);
                        const dropdown = document.getElementById(id + '-dropdown');
                        if (dropdown) {
                            dropdown.innerHTML = '<div style="padding:10px;color:#999;">Mindestens 3 Zeichen fÃ¼r Suche...</div>';
                            dropdown.style.display = 'block';
                        }
                        return;
                    }
                    
                    console.log('âœ… Starte Autocomplete-Suche in 300ms fÃ¼r:', value);
                    
                    autocompleteTimeout = setTimeout(() => {
                        console.log('ğŸ” Rufe searchAddresses() auf fÃ¼r:', value, 'Feld:', id);
                        searchAddresses(value, id);
                    }, 300);
                });
                
                console.log('âœ… Event Listener registriert fÃ¼r:', id);
            });
            
            console.log('âœ… setupAutocomplete abgeschlossen!');
        }

        // ğŸ†• v5.88.30: HÃ¤ufige Ziele global cachen (einmalig laden!)
        let cachedFrequentDestinations = null;
        
        async function loadFrequentDestinations() {
            if (cachedFrequentDestinations !== null) {
                return cachedFrequentDestinations;
            }
            
            if (!isFirebaseReady) {
                return [];
            }
            
            try {
                console.log('ğŸ“± Lade hÃ¤ufige Ziele aus Buchungen...');
                const ridesSnap = await db.ref('rides').orderByChild('createdAt').limitToLast(500).once('value');
                const destinationCount = {};
                
                ridesSnap.forEach(child => {
                    const ride = child.val();
                    
                    // ğŸ†• v5.88.36: Koordinaten aus BEIDEN Formaten lesen!
                    // Alt: destinationLat/destinationLon, Neu: destCoords.lat/destCoords.lon
                    const destLat = ride.destinationLat || (ride.destCoords && ride.destCoords.lat);
                    const destLon = ride.destinationLon || (ride.destCoords && ride.destCoords.lon);
                    const pickLat = ride.pickupLat || (ride.pickupCoords && ride.pickupCoords.lat);
                    const pickLon = ride.pickupLon || (ride.pickupCoords && ride.pickupCoords.lon);
                    
                    // ğŸ”§ v5.90.93: Hilfsfunktion - Distanz zwischen 2 Punkten berechnen
                    const getDistance = (lat1, lon1, lat2, lon2) => {
                        const R = 6371e3; // Earth radius in meters
                        const Ï†1 = lat1 * Math.PI / 180;
                        const Ï†2 = lat2 * Math.PI / 180;
                        const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
                        const Î”Î» = (lon2 - lon1) * Math.PI / 180;
                        const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                                Math.cos(Ï†1) * Math.cos(Ï†2) *
                                Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
                        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                        return R * c; // Distance in meters
                    };
                    
                    // ğŸ”§ v5.90.93: Extrahiere StraÃŸe + Hausnummer
                    const extractStreetAndNumber = (address) => {
                        // Match: "Amselring 10" aus "Amselring 10, 17424 Heringsdorf"
                        const match = address.match(/^([^\d,]+\s*\d+[a-z]?)/i);
                        return match ? match[1].toLowerCase().trim() : address.toLowerCase();
                    };
                    
                    // ZÃ¤hle Zielorte
                    if (ride.destination && destLat && destLon) {
                        // ğŸ”§ v5.90.93: Intelligente Duplikat-Erkennung
                        let existingKey = null;
                        const newStreetNumber = extractStreetAndNumber(ride.destination);
                        
                        for (const [key, dest] of Object.entries(destinationCount)) {
                            const distance = getDistance(destLat, destLon, dest.lat, dest.lon);
                            const existingStreetNumber = extractStreetAndNumber(dest.name);
                            
                            // GLEICH wenn:
                            // 1. < 10m UND gleiche StraÃŸe+Hausnummer ODER
                            // 2. < 2m (exakt gleiche Koordinaten mit GPS-Ungenauigkeit)
                            if ((distance < 10 && newStreetNumber === existingStreetNumber) || distance < 2) {
                                existingKey = key;
                                break;
                            }
                        }
                        
                        if (existingKey) {
                            // Ort existiert bereits â†’ Count erhÃ¶hen
                            destinationCount[existingKey].count++;
                            // Wenn neue Adresse lÃ¤nger/vollstÃ¤ndiger â†’ Ãœberschreibe!
                            if (ride.destination.length > destinationCount[existingKey].name.length) {
                                destinationCount[existingKey].name = ride.destination;
                            }
                        } else {
                            // Neuer Ort â†’ HinzufÃ¼gen
                            const key = ride.destination.toLowerCase().trim();
                            destinationCount[key] = {
                                name: ride.destination,
                                lat: destLat,
                                lon: destLon,
                                count: 1
                            };
                        }
                    }
                    
                    // ZÃ¤hle auch Abholorte
                    if (ride.pickup && pickLat && pickLon) {
                        // ğŸ”§ v5.90.93: Intelligente Duplikat-Erkennung
                        let existingKey = null;
                        const newStreetNumber = extractStreetAndNumber(ride.pickup);
                        
                        for (const [key, dest] of Object.entries(destinationCount)) {
                            const distance = getDistance(pickLat, pickLon, dest.lat, dest.lon);
                            const existingStreetNumber = extractStreetAndNumber(dest.name);
                            
                            // GLEICH wenn:
                            // 1. < 10m UND gleiche StraÃŸe+Hausnummer ODER
                            // 2. < 2m (exakt gleiche Koordinaten)
                            if ((distance < 10 && newStreetNumber === existingStreetNumber) || distance < 2) {
                                existingKey = key;
                                break;
                            }
                        }
                        
                        if (existingKey) {
                            // Ort existiert bereits â†’ Count erhÃ¶hen
                            destinationCount[existingKey].count++;
                            // Wenn neue Adresse lÃ¤nger/vollstÃ¤ndiger â†’ Ãœberschreibe!
                            if (ride.pickup.length > destinationCount[existingKey].name.length) {
                                destinationCount[existingKey].name = ride.pickup;
                            }
                        } else {
                            // Neuer Ort â†’ HinzufÃ¼gen
                            const key = ride.pickup.toLowerCase().trim();
                            destinationCount[key] = {
                                name: ride.pickup,
                                lat: pickLat,
                                lon: pickLon,
                                count: 1
                            };
                        }
                    }
                });
                
                // Sortiere nach HÃ¤ufigkeit und nimm Top 20
                cachedFrequentDestinations = Object.values(destinationCount)
                    .filter(dest => {
                        // ğŸ”§ v5.90.97: FILTERE ALT-DATEN - Keine Label-Strings!
                        const isLabelString = dest.name === 'Beliebtes Ziel' || 
                                             dest.name === 'Favorit' ||
                                             dest.name.includes('Beliebtes Ziel') ||
                                             dest.name.includes('Favorit');
                        return !isLabelString;
                    })
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 20);
                    
                console.log('âœ… HÃ¤ufige Ziele geladen:', cachedFrequentDestinations.length);
                cachedFrequentDestinations.forEach((d, i) => {
                    console.log(`   ${i+1}. ${d.name} (${d.count}x)`);
                });
                
                return cachedFrequentDestinations;
            } catch (e) {
                console.log('âš ï¸ Konnte hÃ¤ufige Orte nicht laden:', e.message);
                cachedFrequentDestinations = [];
                return [];
            }
        }
        
        async function searchAddresses(query, inputId) {
            const dropdown = document.getElementById(inputId + '-dropdown');
            
            if (!dropdown) {
                console.error('ğŸ’¾ Dropdown nicht gefunden:', inputId + '-dropdown');
                return;
            }
            
            console.log('ğŸ” searchAddresses fÃ¼r:', query);
            
            // ğŸ†• v5.88.30: HÃ¤ufige Ziele aus Cache laden (schnell!)
            const frequentFromBookings = await loadFrequentDestinations();
            
            // POIs aus Firebase
            const savedPOIs = allPOIs.length > 0 ? allPOIs : [];
            
            // Kombiniere: Gespeicherte POIs + HÃ¤ufige Orte aus Buchungen
            const frequentDestinations = [...savedPOIs];
            
            // FÃ¼ge hÃ¤ufige Buchungsziele hinzu (OHNE Anzahl fÃ¼r FahrgÃ¤ste!)
            for (const freq of frequentFromBookings) {
                const alreadyExists = frequentDestinations.some(poi => 
                    poi.name.toLowerCase() === freq.name.toLowerCase() ||
                    (poi.address && poi.address.toLowerCase() === freq.name.toLowerCase())
                );
                if (!alreadyExists) {
                    frequentDestinations.push({
                        name: freq.name,           // VOLLSTÃ„NDIGE Adresse aus Fahrt!
                        address: freq.name,         // ğŸ”§ v5.90.92: Zeige echte Adresse!
                        label: 'â­ Beliebtes Ziel', // Optional: Info-Tag
                        lat: freq.lat,
                        lon: freq.lon,
                        fromBookings: true
                    });
                }
            }
            
            console.log('ğŸ“± VerfÃ¼gbare VorschlÃ¤ge:', frequentDestinations.length, '(POIs:', savedPOIs.length, '+ Buchungen:', frequentFromBookings.length, ')');
            
            // ğŸ”§ v5.90.94: NUR noch suchbasiert - keine automatischen VorschlÃ¤ge bei leerem Feld!
            if (!query || query.trim() === '') {
                dropdown.style.display = 'none';
                return;
            }
            
            // Mindestens 2 Zeichen fÃ¼r Suche
            if (query.length < 2) {
                dropdown.style.display = 'block';
                dropdown.innerHTML = '<div class="autocomplete-item" style="color:#999;text-align:center;padding:15px;">ğŸ’¡ Bitte mindestens 2 Zeichen eingeben...</div>';
                return;
            }
            
            try {
                // Zeige "Suche..." Nachricht
                dropdown.style.display = 'block';
                dropdown.innerHTML = '<div class="autocomplete-item" style="color:#999;text-align:center;padding:15px;">ğŸ” Suche...</div>';
                console.log('âœ… Dropdown geÃ¶ffnet mit "Suche..."');
                
                // ğŸ”§ v5.90.193: EINFACHE SUCHE - includes wie vorher!
                const lowerQuery = query.toLowerCase();
                const matchingPOIs = frequentDestinations.filter(dest => 
                    dest.name.toLowerCase().includes(lowerQuery) || 
                    (dest.address && dest.address.toLowerCase().includes(lowerQuery))
                );
                console.log('ğŸ” POI-Matching:', matchingPOIs.length, 'Treffer fÃ¼r:', query);
                
                // ğŸ†• v5.88.11: Bekannte Orte (SwinemÃ¼nde, Misdroy, Stettin etc.) prÃ¼fen
                const matchingKnownPlaces = [];
                for (const [key, place] of Object.entries(KNOWN_PLACES)) {
                    if (key.includes(lowerQuery) || place.name.toLowerCase().includes(lowerQuery)) {
                        matchingKnownPlaces.push(place);
                    }
                }
                console.log('ğŸ™ï¸ Bekannte Orte gefunden:', matchingKnownPlaces.length);
                
                // Suche mit Nominatim API
                console.log('ğŸ“¡ Starte API-Request...');
                
                // ğŸ†• v5.88.24: PARALLELE SUCHE - deutsch UND polnisch gleichzeitig!
                // So findet "SwinemÃ¼nde Radisson" sofort das Hotel
                const polishQuery = typeof convertGermanToPolish === 'function' ? convertGermanToPolish(query) : null;
                const queriesAreDifferent = polishQuery && polishQuery.toLowerCase() !== query.toLowerCase();
                
                console.log('ğŸ” Suche deutsch:', query);
                if (queriesAreDifferent) {
                    console.log('ğŸ” Suche polnisch:', polishQuery);
                }
                
                // Starte beide Suchen parallel
                // ğŸ†• v5.90.650: MIT extratags + namedetails fÃ¼r POI-Namen (Hotels, Restaurants)!
                const searchPromises = [
                    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=de&viewbox=10.6,54.7,14.4,53.1&bounded=1&limit=15&addressdetails=1&extratags=1&namedetails=1`)
                ];
                
                if (queriesAreDifferent) {
                    searchPromises.push(
                        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(polishQuery)}&countrycodes=de&viewbox=10.6,54.7,14.4,53.1&bounded=1&limit=15&addressdetails=1&extratags=1&namedetails=1`)
                    );
                }
                
                const responses = await Promise.all(searchPromises);
                const resultsArrays = await Promise.all(responses.map(r => r.json()));
                
                // Kombiniere Ergebnisse und entferne Duplikate (nach place_id)
                const seenIds = new Set();
                const results = [];
                for (const arr of resultsArrays) {
                    for (const item of arr) {
                        if (!seenIds.has(item.place_id)) {
                            seenIds.add(item.place_id);
                            results.push(item);
                        }
                    }
                }
                
                console.log('âœ… Kombinierte Ergebnisse:', results.length);
                
                // ğŸ†• v5.90.200: INTELLIGENTE HAUSNUMMERN-SUCHE!
                // Wenn User "KulmstraÃŸe 22" sucht aber nur "KulmstraÃŸe 24" gefunden wird
                // â†’ Zeige trotzdem "KulmstraÃŸe 22" an (mit Koordinaten von StraÃŸe)!
                const hasHouseNumber = /\d+/.test(query);
                if (hasHouseNumber && results.length > 0) {
                    const extractedNumber = query.match(/\d+/)?.[0];
                    const streetName = query.replace(/\d+/g, '').trim();
                    
                    console.log(`ğŸ  Hausnummern-Suche: "${streetName}" Nr. ${extractedNumber}`);
                    
                    // PrÃ¼fe ob die EXAKTE Hausnummer fehlt
                    const hasExactMatch = results.some(r => 
                        r.address?.house_number === extractedNumber &&
                        r.address?.road?.toLowerCase().includes(streetName.toLowerCase())
                    );
                    
                    if (!hasExactMatch) {
                        // Finde StraÃŸe (ohne Hausnummer oder mit anderer Nummer)
                        const streetResult = results.find(r => 
                            r.address?.road?.toLowerCase().includes(streetName.toLowerCase())
                        );
                        
                        if (streetResult) {
                            console.log(`âœ… StraÃŸe gefunden! FÃ¼ge gewÃ¼nschte Hausnummer hinzu: ${extractedNumber}`);
                            
                            // Erstelle "virtuelle" Adresse mit gewÃ¼nschter Hausnummer
                            const virtualAddress = {
                                ...streetResult,
                                display_name: `${streetResult.address.road} ${extractedNumber}, ${streetResult.address.postcode} ${streetResult.address.town || streetResult.address.city}`,
                                address: {
                                    ...streetResult.address,
                                    house_number: extractedNumber
                                },
                                isVirtual: true,
                                place_id: 'virtual_' + Date.now()
                            };
                            
                            // FÃ¼ge OBEN in Liste ein!
                            results.unshift(virtualAddress);
                            console.log('ğŸ¯ Virtuelle Adresse erstellt:', virtualAddress.display_name);
                        }
                    }
                }
                
                // ğŸ†• v5.64.48: Wenn BEIDE leer â†’ Keine Ergebnisse
                if (matchingPOIs.length === 0 && matchingKnownPlaces.length === 0 && results.length === 0) {
                    dropdown.innerHTML = '<div class="autocomplete-item" style="color:#999;text-align:center;padding:15px;">Keine Ergebnisse</div>';
                    console.log('âš ï¸ Keine Ergebnisse gefunden (POI + Nominatim)');
                    return;
                }
                
                // ğŸ†• v5.88.11: BEKANNTE ORTE (SwinemÃ¼nde etc.) ZUERST!
                let knownPlacesHTML = '';
                if (matchingKnownPlaces.length > 0) {
                    knownPlacesHTML = `
                        <div style="padding:8px;background:#dbeafe;border-bottom:2px solid #3b82f6;font-weight:600;font-size:12px;color:#1e40af;">
                            ğŸ‡µğŸ‡± BEKANNTE ORTE
                        </div>
                    `;
                    knownPlacesHTML += matchingKnownPlaces.map(place => {
                        return `
                            <div class="autocomplete-item" onclick="selectAddress('${inputId}', '${place.fullAddress.replace(/'/g, "\\'")}', ${place.lat}, ${place.lon})" style="background:#eff6ff;">
                                <div style="font-weight:600;color:#3b82f6;">ğŸ™ï¸ ${place.name}</div>
                                <div style="font-size:13px;color:#666;margin-top:2px;padding-left:20px;">${place.fullAddress}</div>
                            </div>
                        `;
                    }).join('');
                }
                
                // ğŸ†• v5.64.48: EIGENE POIs AM ANFANG!
                let poiHTML = '';
                if (matchingPOIs.length > 0) {
                    poiHTML = `
                        <div style="padding:8px;background:#fef3c7;border-bottom:2px solid #f59e0b;font-weight:600;font-size:12px;color:#92400e;">
                            ğŸ¥ BEKANNTE ORTE
                        </div>
                    `;
                    poiHTML += matchingPOIs.map(dest => {
                        // ğŸ”§ v5.90.91: SAUBERE LÃ¶sung - address oder name
                        const addressString = dest.address || dest.name;
                        const displayLabel = dest.label || dest.address || '';
                        
                        return `
                            <div class="autocomplete-item" onclick="selectAddress('${inputId}', '${addressString.replace(/'/g, "\\'")}', ${dest.lat}, ${dest.lon})" style="background:#fffbeb;">
                                <div style="font-weight:600;color:#f59e0b;">ğŸ¥ ${dest.name}</div>
                                <div style="font-size:13px;color:#666;margin-top:2px;padding-left:20px;">${displayLabel}</div>
                            </div>
                        `;
                    }).join('');
                    
                    // Nur Trennlinie wenn auch Nominatim-Ergebnisse kommen
                    if (results.length > 0) {
                        poiHTML += `
                            <div style="padding:8px;background:#f3f4f6;border-bottom:2px solid #9ca3af;font-weight:600;font-size:12px;color:#4b5563;">
                                ğŸ“ WEITERE ERGEBNISSE
                            </div>
                        `;
                    }
                }
                
                // ğŸ†• v5.46.2: KEIN FILTER! Zeige ALLE Ergebnisse!
                const resultsToShow = results;
                console.log('ğŸ“± Zeige ALLE Ergebnisse (kein Filter):', resultsToShow.length);
                
                // ğŸ†• v5.90.242: REIHENFOLGE: Favoriten (POIs) ZUERST, dann Bekannte Orte, dann Nominatim!
                dropdown.innerHTML = poiHTML + knownPlacesHTML + resultsToShow.map(r => {
                    const address = r.address;
                    let displayText = '';
                    let fullAddress = '';
                    
                    // ğŸ¨ HOTEL, RESTAURANT, POI Namen
                    // ğŸ†• v5.90.650: ERWEITERTE POI-Erkennung wie im CRM Map Picker!
                    let poiName = r.name; // PrimÃ¤r: Offizieller Name aus Nominatim!
                    
                    // Falls kein Name: Versuche spezifische POI-Felder
                    if (!poiName || poiName === address.road) {
                        poiName = address.hotel || 
                                  address.restaurant || 
                                  address.cafe || 
                                  address.tourism || 
                                  address.amenity || 
                                  address.shop || 
                                  address.building;
                    }
                    
                    // Baue Haupt-Adresszeile
                    if (address.road) {
                        fullAddress = address.road;
                        if (address.house_number) fullAddress += ' ' + address.house_number;
                    }
                    
                    // Ort
                    let city = '';
                    if (address.village) city = address.village;
                    else if (address.town) city = address.town;
                    else if (address.city) city = address.city;
                    else if (address.municipality) city = address.municipality;
                    
                    // PLZ
                    const zip = address.postcode || '';
                    
                    // ğŸ¨ Baue schÃ¶ne Anzeige
                    if (poiName && poiName !== fullAddress && poiName !== city && poiName !== address.road) {
                        displayText = `<div style="font-weight:600;color:#667eea;">ğŸ¨ ${poiName}</div>`;
                        displayText += `<div style="font-size:13px;color:#666;margin-top:2px;padding-left:20px;">`;
                        if (fullAddress) displayText += fullAddress;
                        if (zip) displayText += ', ' + zip;
                        if (city) displayText += ' ' + city;
                        displayText += '</div>';
                    } else {
                        if (fullAddress) {
                            displayText = fullAddress;
                            if (zip) displayText += ', ' + zip;
                            if (city) displayText += ' ' + city;
                        } else {
                            displayText = r.display_name;
                        }
                    }
                    
                    // VollstÃ¤ndige Adresse als String
                    let addressString = '';
                    if (poiName && poiName !== fullAddress && poiName !== city && poiName !== address.road) {
                        addressString = poiName + ', ';
                    }
                    if (fullAddress) addressString += fullAddress;
                    if (zip) addressString += ', ' + zip;
                    if (city) addressString += ' ' + city;
                    
                    if (!addressString) addressString = r.display_name;
                    
                    return `<div class="autocomplete-item" 
                        onclick="selectAddress('${inputId}', '${addressString.replace(/'/g, "\\'")}', ${r.lat}, ${r.lon})">
                        ${displayText}
                    </div>`;
                }).join('');
                
                console.log('âœ… HTML erstellt und in Dropdown eingefÃ¼gt! Anzahl:', resultsToShow.length);
                
            } catch (e) {
                console.error('ğŸ’¾ Autocomplete Fehler:', e);
                dropdown.innerHTML = '<div class="autocomplete-item" style="color:#ef4444;text-align:center;padding:15px;">ğŸ’¾ Fehler bei der Suche</div>';
            }
        }

        // ğŸ†• v5.90.73: KOMPAKTE BESTÃ„TIGUNG MIT ICONS!
        async function updateConfirmationHint(field) {
            const hintDiv = document.getElementById(field + '-confirmation');
            const hintIcon = document.getElementById(field + '-confirmation-icon');
            const input = document.getElementById(field);
            const value = input.value.trim();
            
            // Kein Text â†’ Kein Hinweis
            if (!value) {
                hintDiv.style.display = 'none';
                if (hintIcon) hintIcon.style.display = 'none';
                return;
            }
            
            const isConfirmed = field === 'pickup' ? pickupConfirmed : destinationConfirmed;
            
            if (isConfirmed) {
                // ğŸ†• v5.90.118: Bei Vorbestellung + Abholort â†’ PrÃ¼fe Slot-VerfÃ¼gbarkeit!
                if (currentRideType === 'vorbestellen' && field === 'pickup') {
                    const dateInput = document.getElementById('custom-date');
                    const hourSelect = document.getElementById('custom-hour');
                    const minuteSelect = document.getElementById('custom-minute');
                    
                    // Wenn Zeit gewÃ¤hlt wurde â†’ PrÃ¼fe Slot
                    if (dateInput && hourSelect && minuteSelect && dateInput.value) {
                        const dateVal = dateInput.value;
                        const hourVal = hourSelect.value;
                        const minuteVal = minuteSelect.value;
                        
                        // Timestamp berechnen
                        const dateParts = dateVal.split('-');
                        const selectedDate = new Date(
                            parseInt(dateParts[0]),
                            parseInt(dateParts[1]) - 1,
                            parseInt(dateParts[2]),
                            parseInt(hourVal),
                            parseInt(minuteVal),
                            0, 0
                        );
                        const timestamp = selectedDate.getTime();
                        
                        // Slot prÃ¼fen
                        try {
                            const availability = await checkTimeSlotAvailability(timestamp, pickupCoords);
                            
                            hintDiv.style.display = 'none';  // Box weg!
                            if (hintIcon) {
                                hintIcon.style.display = 'inline-block';
                                if (availability.available) {
                                    // âœ… GRÃœN: Adresse OK + Slot frei!
                                    hintIcon.innerHTML = 'âœ…';
                                    hintIcon.title = 'Adresse bestÃ¤tigt - Slot verfÃ¼gbar';
                                } else {
                                    // âš ï¸ ORANGE: Adresse OK, aber Slot belegt!
                                    hintIcon.innerHTML = 'âš ï¸';
                                    hintIcon.title = 'Adresse bestÃ¤tigt - Slot belegt!';
                                    hintIcon.style.color = '#f59e0b';
                                }
                            }
                            return;
                        } catch (error) {
                            console.error('ğŸ’¾ Slot-PrÃ¼fung fehlgeschlagen:', error);
                            // Bei Fehler: Zeige einfaches GrÃ¼n
                        }
                    }
                }
                
                // âœ… BESTÃ„TIGT - NUR KLEINES ICON! (v5.90.73)
                hintDiv.style.display = 'none';  // Box weg!
                if (hintIcon) {
                    hintIcon.style.display = 'inline-block';
                    hintIcon.innerHTML = 'âœ…';
                    hintIcon.title = 'Adresse bestÃ¤tigt';
                }
            } else {
                // âš ï¸ NICHT BESTÃ„TIGT - Roter Hinweis (bleibt Box!)
                if (hintIcon) hintIcon.style.display = 'none';
                hintDiv.style.display = 'block';
                hintDiv.style.background = '#fee2e2';
                hintDiv.style.border = '2px solid #ef4444';
                hintDiv.style.color = '#991b1b';
                hintDiv.innerHTML = 'âš ï¸ Bitte Adresse aus der Liste auswÃ¤hlen!';
            }
        }
        
        // ğŸ†• v5.42.8: ADRESSE AUS OVERLAY AUSWÃ„HLEN
        // ğŸ†• v5.46.3: Overlay-Funktionen entfernt - nutzen nur noch Dropdown!
        
        // ğŸ†• v5.50.2: GPS-Button Funktion (fehlte vorher!)
        function showSingleAddressInOverlay(inputId, address, lat, lon, title) {
            console.log('ğŸ“ GPS-Adresse Ã¼bernehmen:', address);
            
            // Setze Adresse ins Feld
            document.getElementById(inputId).value = address;
            
            // Speichere Koordinaten
            if (inputId === 'pickup') {
                pickupCoords = { lat: parseFloat(lat), lon: parseFloat(lon) };
                pickupConfirmed = true;
                updateConfirmationHint('pickup');
                console.log('âœ… GPS-Abholort gespeichert:', address, pickupCoords);
                
                // Bei Vorbestellung â†’ Live-Slot-Check!
                if (currentRideType === 'vorbestellen') {
                    setTimeout(() => performLiveSlotCheck(), 300);
                }
                
                // Bei Sofort â†’ Taxis laden!
                if (currentRideType === 'sofort') {
                    setTimeout(() => showAvailableTaxis(), 1000);
                }
            } else {
                destCoords = { lat: parseFloat(lat), lon: parseFloat(lon) };
                destinationConfirmed = true;
                updateConfirmationHint('destination');
                console.log('âœ… GPS-Zielort gespeichert:', address, destCoords);
            }
        }


        function selectAddress(inputId, address, lat, lon) {
            debugLog('info', `ğŸ“ Adresse ausgewÃ¤hlt: ${inputId} = ${address}`);
            
            // ğŸ”§ v5.90.90: WARN wenn "Beliebtes Ziel" in Adresse!
            if (address && address.includes('Beliebtes Ziel')) {
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.error('ğŸš¨ KRITISCHER FEHLER ERKANNT!');
                console.error('ğŸ’¾ Adresse enthÃ¤lt "Beliebtes Ziel"!');
                console.error('ğŸ“ Adresse:', address);
                console.error('ğŸ’¡ Das sollte NICHT passieren (Bug in v5.90.86)!');
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
                // Entferne "Beliebtes Ziel" automatisch als Notfall-Fix
                address = address.replace(', Beliebtes Ziel', '').replace(',Beliebtes Ziel', '');
                console.log('âœ… Notfall-Fix: Bereinigt zu:', address);
            }
            
            document.getElementById(inputId).value = address;
            document.getElementById(inputId + '-dropdown').style.display = 'none';
            
            // Speichere Koordinaten
            if (inputId === 'pickup') {
                pickupCoords = { lat: parseFloat(lat), lon: parseFloat(lon) };
                pickupConfirmed = true;
                updateConfirmationHint('pickup');
                console.log('âœ… Abholort gespeichert:', address, pickupCoords);
                debugLog('info', `âœ… Abholort gespeichert: ${address} (${lat}, ${lon})`);
                
                // ğŸ†• v5.48.0: Bei Vorbestellung â†’ Triggere Live-Slot-Check!
                if (currentRideType === 'vorbestellen') {
                    console.log('ğŸ” Trigger Live-Slot-Check nach Abholadresse...');
                    setTimeout(() => {
                        performLiveSlotCheck();
                    }, 300);
                }
                
                // ğŸ†• v5.30.0: NUR bei "Sofort" Taxis laden!
                if (currentRideType === 'sofort') {
                    debugLog('info', 'ğŸš• Lade verfÃ¼gbare Taxis...');
                    const display = document.getElementById('available-taxis-display');
                    display.innerHTML = `
                        <div style="padding:20px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:12px;text-align:center;margin-top:10px;">
                            <div style="font-size:20px;margin-bottom:10px;">ğŸ“</div>
                            <div style="font-weight:600;font-size:16px;margin-bottom:5px;">Position wird geladen...</div>
                            <div style="font-size:13px;opacity:0.9;">ğŸ” Suche verfÃ¼gbare Taxis in der NÃ¤he...</div>
                        </div>
                    `;
                    
                    setTimeout(() => {
                        showAvailableTaxis();
                    }, 1000);
                }
            } else if (inputId === 'destination') {
                destCoords = { lat: parseFloat(lat), lon: parseFloat(lon) };
                destinationConfirmed = true;
                updateConfirmationHint('destination');
                console.log('âœ… Zielort gespeichert:', address, destCoords);
                debugLog('info', `âœ… Zielort gespeichert: ${address} (${lat}, ${lon})`);
                
                // ğŸ†• v5.90.77: AUTO-NEUBERECHNUNG wenn Preis schon da war!
                if (priceCalculated && pickupCoords) {
                    console.log('ğŸ”„ Neues Ziel â†’ Auto-Neuberechnung...');
                    setTimeout(() => {
                        calculatePriceAndShow();
                    }, 300);
                }
            } else if (inputId === 'qb-panel-pickup') {
                // ğŸ†• v5.50.7: Admin-Panel Abholort!
                qbPanelPickupCoords = { lat: parseFloat(lat), lon: parseFloat(lon) };
                console.log('âœ… Admin-Panel Abholort gespeichert:', address, qbPanelPickupCoords);
            } else if (inputId === 'qb-panel-destination') {
                // ğŸ†• v5.50.7: Admin-Panel Zielort!
                qbPanelDestCoords = { lat: parseFloat(lat), lon: parseFloat(lon) };
                console.log('âœ… Admin-Panel Zielort gespeichert:', address, qbPanelDestCoords);
            } else if (inputId === 'ai-booking-pickup') {
                // ğŸ†• v5.64.34: AI-Buchungsmaske Abholort!
                window.aiBookingPickupCoords = { lat: parseFloat(lat), lon: parseFloat(lon) };
                console.log('âœ… AI-Maske Abholort gespeichert:', address, window.aiBookingPickupCoords);
            } else if (inputId === 'ai-booking-destination') {
                // ğŸ†• v5.64.34: AI-Buchungsmaske Zielort!
                window.aiBookingDestCoords = { lat: parseFloat(lat), lon: parseFloat(lon) };
                console.log('âœ… AI-Maske Zielort gespeichert:', address, window.aiBookingDestCoords);
            } else if (inputId === 'new-qb-customer-address') {
                // ğŸ†• v5.87.20: Neuer Kunde Adresse!
                newCustomerAddressCoords = { lat: parseFloat(lat), lon: parseFloat(lon) };
                console.log('âœ… Kunden-Adresse gespeichert:', address, newCustomerAddressCoords);
            }
        }

        // LOCATION
        function useMyLocation() {
            if (!navigator.geolocation) {
                alert('ğŸ’¾ GPS nicht verfÃ¼gbar!');
                return;
            }
            
            console.log('ğŸ“ GPS wird abgerufen...');
            
            navigator.geolocation.getCurrentPosition(
                async (pos) => {
                    pickupCoords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                    pickupConfirmed = true;  // ğŸ¯ v5.45.5: DIREKT SETZEN!
                    console.log('âœ… GPS-Position erhalten + confirmed gesetzt:', pickupCoords);
                    
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pickupCoords.lat}&lon=${pickupCoords.lon}`);
                        const data = await response.json();
                        const address = data.address;
                        const street = address.road || address.pedestrian || '';
                        const houseNumber = address.house_number || '';
                        const city = address.town || address.village || address.city || 'Heringsdorf';
                        const addressString = `${street} ${houseNumber}, ${city}`.trim();
                        
                        // ğŸ†• v5.45.1: Schreibe Adresse ins Feld und Ã¶ffne BestÃ¤tigungs-Overlay!
                        document.getElementById('pickup').value = addressString;
                        
                        // Zeige Overlay zur BestÃ¤tigung
                        showSingleAddressInOverlay('pickup', addressString, pickupCoords.lat, pickupCoords.lon, 'ğŸ“ Mein Standort');
                        
                        console.log('âœ… Adresse aufgelÃ¶st:', addressString);
                    } catch (e) {
                        console.error('ğŸ’¾ Reverse Geocoding Fehler:', e);
                        const addressString = `${pickupCoords.lat.toFixed(4)}, ${pickupCoords.lon.toFixed(4)}`;
                        document.getElementById('pickup').value = addressString;
                        
                        // Zeige Overlay auch bei Koordinaten
                        showSingleAddressInOverlay('pickup', addressString, pickupCoords.lat, pickupCoords.lon, 'ğŸ“ Mein Standort');
                    }
                },
                (err) => {
                    console.error('ğŸ’¾ GPS-Fehler:', err);
                    // ğŸ†• NICHT BLOCKIEREND! Nutzer kann manuell eingeben
                    const pickupField = document.getElementById('pickup');
                    if (pickupField) {
                        pickupField.placeholder = 'âš ï¸ GPS nicht verfÃ¼gbar - bitte manuell eingeben';
                        pickupField.focus();
                    }
                    
                    // Zeige Info-Banner statt blockendem Alert
                    const banner = document.createElement('div');
                    banner.style.cssText = 'position:fixed;top:60px;left:10px;right:10px;background:#fef3c7;padding:15px;border-radius:8px;border:2px solid #f59e0b;z-index:9999;text-align:center;';
                    banner.innerHTML = `
                        <div style="font-weight:600;margin-bottom:5px;">âš ï¸ GPS nicht verfÃ¼gbar</div>
                        <div style="font-size:13px;">Bitte gib deinen Abholort manuell eingeben</div>
                        <button onclick="this.parentElement.remove()" style="margin-top:10px;padding:8px 16px;background:#f59e0b;color:white;border:none;border-radius:6px;font-weight:600;">OK</button>
                    `;
                    document.body.appendChild(banner);
                    setTimeout(() => banner.remove(), 5000);
                }
            );
        }

        async function showAvailableTaxis() {
            console.log('ğŸ“ showAvailableTaxis aufgerufen - pickupCoords:', pickupCoords, 'isFirebaseReady:', isFirebaseReady);
            
            // ğŸ†• v5.90.324: ZEIGE FAHRZEUGE AUCH OHNE PICKUP-COORDS!
            // Nur wenn Firebase nicht bereit â†’ warte
            
            // ğŸ†• v5.27.1: WARTE AUF FIREBASE!
            if (!isFirebaseReady) {
                console.log('â³ Warte auf Firebase...');
                document.getElementById('available-taxis-display').innerHTML = `
                    <div style="padding:20px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:12px;text-align:center;margin-top:10px;">
                        <div style="font-size:20px;margin-bottom:10px;">â³</div>
                        <div style="font-weight:600;font-size:16px;margin-bottom:5px;">Verbinde mit Server...</div>
                        <div style="font-size:13px;opacity:0.9;">Einen Moment bitte...</div>
                    </div>
                `;
                
                // Versuche erneut nach 2 Sekunden
                setTimeout(() => {
                    showAvailableTaxis();
                }, 2000);
                return;
            }
            
            const onlineDrivers = Object.values(drivers).filter(d => {
                // ğŸ†• v5.90.576: Normalisiere vehicleId SOFORT!
                if (!d.vehicleId && d.id) {
                    d.vehicleId = d.id;
                }
                
                // Basis-Checks
                if (!d.online || !d.timestamp || (Date.now() - d.timestamp) >= 120000) {
                    return false;
                }
                
                // ğŸ†• v5.90.357: PrÃ¼fe ob Fahrzeug bereits eine Fahrt hat!
                const vehicleId = d.vehicleId;
                const hasActiveRide = rides.some(r => 
                    (r.vehicleId === vehicleId || r.assignedTo === vehicleId) && 
                    (r.status === 'assigned' || r.status === 'accepted' || r.status === 'picked_up')
                );
                
                if (hasActiveRide) {
                    console.log(`ğŸš— ${vehicleId}: Hat aktive Fahrt - wird nicht als verfÃ¼gbar angezeigt`);
                    return false;
                }
                
                return true;
            });
            console.log('ğŸš• Online UND freie Fahrer gefunden:', onlineDrivers.length);
            
            // ğŸ†• v5.26.14i: BESSERE "KEINE TAXIS"-MELDUNG
            if (onlineDrivers.length === 0) {
                document.getElementById('available-taxis-display').innerHTML = `
                    <div style="padding:20px;background:#fef3c7;border:2px solid #f59e0b;border-radius:12px;margin-top:10px;">
                        <div style="text-align:center;margin-bottom:15px;">
                            <div style="font-size:32px;margin-bottom:8px;">âš ï¸</div>
                            <div style="font-weight:700;font-size:16px;color:#92400e;margin-bottom:5px;">
                                Aktuell keine Taxis verfÃ¼gbar
                            </div>
                            <div style="font-size:13px;color:#78350f;">
                                Alle Fahrer sind gerade unterwegs
                            </div>
                        </div>
                        <div style="background:white;padding:15px;border-radius:8px;text-align:center;">
                            <div style="font-weight:600;color:#1e40af;margin-bottom:8px;">ğŸ’¾ Bitte direkt anrufen:</div>
                            <a href="tel:038378" style="display:inline-block;padding:12px 20px;background:#3b82f6;color:white;text-decoration:none;border-radius:8px;font-weight:700;font-size:18px;">
                                038378 / 1234
                            </a>
                            <div style="font-size:12px;color:#666;margin-top:8px;">
                                Wir helfen Ihnen gerne weiter!
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // ğŸ†• v5.90.324: WENN KEINE PICKUP-COORDS â†’ ZEIGE FAHRZEUGE OHNE DISTANZ!
            if (!pickupCoords) {
                const html = `
                    <div class="available-taxis" style="margin-top:10px;">
                        <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:15px;border-radius:12px;text-align:center;margin-bottom:10px;">
                            <div style="font-size:20px;margin-bottom:5px;">ğŸš•</div>
                            <div style="font-weight:700;font-size:18px;margin-bottom:3px;">
                                ${onlineDrivers.length} ${onlineDrivers.length === 1 ? 'Taxi' : 'Taxis'} verfÃ¼gbar!
                            </div>
                            <div style="font-size:14px;opacity:0.9;">
                                Bereit fÃ¼r Sofort-Buchung
                            </div>
                        </div>
                        ${onlineDrivers.slice(0, 3).map(d => {
                            // ğŸ†• v5.90.576: Besserer Fallback!
                            let name = 'Taxi';
                            let plate = '';
                            
                            if (VEHICLES[d.vehicleId]) {
                                name = VEHICLES[d.vehicleId].name || 'Taxi';
                                plate = VEHICLES[d.vehicleId].plate || '';
                            } else if (OFFICIAL_VEHICLES[d.vehicleId]) {
                                name = OFFICIAL_VEHICLES[d.vehicleId].name || 'Taxi';
                                plate = OFFICIAL_VEHICLES[d.vehicleId].plate || '';
                            }
                            
                            return `
                                <div class="taxi-item" style="background:#f0fdfa;border:2px solid #14b8a6;padding:12px;border-radius:8px;margin-bottom:8px;">
                                    <div style="font-weight:600;font-size:15px;color:#0f766e;margin-bottom:4px;">
                                        ${name}
                                    </div>
                                    ${plate ? `<div style="font-size:13px;color:#14b8a6;margin-bottom:6px;">ğŸš— ${plate}</div>` : ''}
                                    <div style="font-size:13px;color:#0f766e;">
                                        âœ… VerfÃ¼gbar
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                document.getElementById('available-taxis-display').innerHTML = html;
                return;
            }
            
            const taxisWithETA = await Promise.all(onlineDrivers.map(async (d) => {
                const route = await calculateRoute(d, pickupCoords);
                return { ...d, ...route };
            }));
            
            taxisWithETA.sort((a, b) => a.distance - b.distance);
            
            // ğŸ†• v5.26.14i: SCHÃ–NERE TAXI-ANZEIGE
            const html = `
                <div class="available-taxis" style="margin-top:10px;">
                    <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:15px;border-radius:12px;text-align:center;margin-bottom:10px;">
                        <div style="font-size:20px;margin-bottom:5px;">ğŸš•</div>
                        <div style="font-weight:700;font-size:18px;margin-bottom:3px;">
                            ${taxisWithETA.length} ${taxisWithETA.length === 1 ? 'Taxi' : 'Taxis'} verfÃ¼gbar!
                        </div>
                        <div style="font-size:14px;opacity:0.9;">
                            NÃ¤chstes Taxi in ca. ${taxisWithETA[0].duration} Minuten
                        </div>
                    </div>
                    ${taxisWithETA.slice(0, 3).map(t => {
                        // ğŸ†• v5.90.576: Besserer Fallback!
                        let name = t.vehicle || 'Taxi';
                        let plate = '';
                        
                        if (VEHICLES[t.vehicleId]) {
                            name = VEHICLES[t.vehicleId].name || name;
                            plate = VEHICLES[t.vehicleId].plate || '';
                        } else if (OFFICIAL_VEHICLES[t.vehicleId]) {
                            name = OFFICIAL_VEHICLES[t.vehicleId].name || name;
                            plate = OFFICIAL_VEHICLES[t.vehicleId].plate || '';
                        }
                        
                        return `
                            <div class="taxi-item" style="background:#f0fdfa;border:2px solid #14b8a6;padding:12px;border-radius:8px;margin-bottom:8px;">
                                <div style="font-weight:600;font-size:15px;color:#0f766e;margin-bottom:4px;">
                                    ${name}
                                </div>
                                ${plate ? `<div style="font-size:13px;color:#14b8a6;margin-bottom:6px;">ğŸš— ${plate}</div>` : ''}
                                <div style="font-size:13px;color:#0f766e;">
                                    ğŸ“ ${t.distance} km entfernt â€¢ â±ï¸ ca. ${t.duration} Min
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            document.getElementById('available-taxis-display').innerHTML = html;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.32.5g: PRÃœFE FAHRER-VERFÃœGBARKEIT â†’ SOFORT-BUTTON ZEIGEN/VERSTECKEN
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function checkDriverAvailability() {
            console.log('ğŸ” PrÃ¼fe Fahrer-VerfÃ¼gbarkeit...');
            
            const sofortBtn = document.getElementById('btn-sofort');
            if (!sofortBtn) {
                console.log('âš ï¸ SOFORT-Button nicht gefunden');
                return;
            }
            
            // PrÃ¼fe ob mindestens 1 Fahrer ONLINE oder BESETZT (busy)
            let hasAvailableDriver = false;
            
            for (const driverId in drivers) {
                const driver = drivers[driverId];
                
                // ğŸ†• v5.90.357: PrÃ¼fe ob Fahrzeug bereits eine Fahrt hat!
                const vehicleId = driver.vehicleId || driver.id || driverId;
                const hasActiveRide = rides.some(r => 
                    (r.vehicleId === vehicleId || r.assignedTo === vehicleId) && 
                    (r.status === 'assigned' || r.status === 'accepted' || r.status === 'picked_up')
                );
                
                // ONLINE = VerfÃ¼gbar UND KEINE AKTIVE FAHRT
                if (driver.online && driver.timestamp && (Date.now() - driver.timestamp) < 120000 && !hasActiveRide) {
                    hasAvailableDriver = true;
                    console.log('âœ… Fahrer verfÃ¼gbar (online + frei):', driver.vehicle || driverId);
                    break;
                }
                
                // BESETZT = Hat Fahrt, aber angemeldet (fÃ¼r Vorbestellung)
                // Status kann sein: 'busy', 'assigned', 'picked_up', 'ongoing'
                if (driver.status && ['busy', 'assigned', 'picked_up', 'ongoing'].includes(driver.status)) {
                    // PrÃ¼fe ob Timestamp aktuell (innerhalb 2 Min)
                    if (driver.timestamp && (Date.now() - driver.timestamp) < 120000) {
                        hasAvailableDriver = true;
                        console.log('âœ… Fahrer verfÃ¼gbar (besetzt aber angemeldet):', driver.vehicle || driverId);
                        break;
                    }
                }
            }
            
            // SOFORT-Button zeigen/verstecken
            const buttonsContainer = document.getElementById('ride-type-buttons-container');
            
            if (hasAvailableDriver) {
                sofortBtn.style.display = 'block';
                if (buttonsContainer) {
                    buttonsContainer.style.gridTemplateColumns = '1fr 1fr'; // 2 Spalten
                }
                console.log('âœ… SOFORT-Button ANGEZEIGT - Fahrer verfÃ¼gbar!');
            } else {
                sofortBtn.style.display = 'none';
                if (buttonsContainer) {
                    buttonsContainer.style.gridTemplateColumns = '1fr'; // 1 Spalte (VORBESTELLEN volle Breite)
                }
                console.log('ğŸ’¾ SOFORT-Button VERSTECKT - Keine Fahrer verfÃ¼gbar!');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // ğŸ†• PREIS-BUTTON HANDLER - wechselt zwischen "Preis berechnen" und "Abbrechen"
        let priceCalculated = false;
        
        function handlePriceButton() {
            if (priceCalculated) {
                // Abbrechen-Modus: Reset
                cancelBooking();
            } else {
                // Preis-berechnen-Modus
                calculatePriceAndShow();
            }
        }
        
        // ğŸ†• v5.90.77: NUR ZIEL Ã„NDERN (Rest bleibt!)
        function clearDestinationOnly() {
            console.log('ğŸ¯ Nur Ziel Ã¤ndern - Rest bleibt!');
            
            // Nur Ziel-Feld leeren
            const destInput = document.getElementById('destination');
            if (destInput) {
                destInput.value = '';
                destInput.focus(); // Cursor ins Feld
            }
            
            // Ziel-Icon verstecken
            const destIcon = document.getElementById('destination-confirmation-icon');
            if (destIcon) {
                destIcon.style.display = 'none';
            }
            
            // Ziel-Coords lÃ¶schen
            destCoords = null;
            destinationConfirmed = false;
            
            // Preis verstecken
            const priceDisplay = document.getElementById('price-display');
            if (priceDisplay) {
                priceDisplay.style.display = 'none';
            }
            
            // Karte verstecken
            const routeMap = document.getElementById('route-map');
            if (routeMap) {
                routeMap.style.display = 'none';
            }
            
            // "Taxi buchen" Button verstecken
            const bookBtn = document.getElementById('book-btn');
            if (bookBtn) {
                bookBtn.style.display = 'none';
            }
            
            // X-Button verstecken
            const clearDestBtn = document.getElementById('clear-destination-btn');
            if (clearDestBtn) {
                clearDestBtn.style.display = 'none';
            }
            
            // "Preis berechnen" Button zurÃ¼ck
            const priceBtn = document.getElementById('price-btn');
            if (priceBtn) {
                priceBtn.innerHTML = 'ğŸ’° Preis berechnen';
                priceBtn.classList.remove('btn-danger');
                priceBtn.classList.add('btn-primary');
            }
            
            // Status zurÃ¼cksetzen
            priceCalculated = false;
            window.currentPrice = null;
            window.currentDistance = null;
            window.currentDuration = null;
            
            console.log('âœ… Nur Ziel gelÃ¶scht - Abholort/Datum/Zeit bleiben!');
        }

        // ğŸ†• BUCHUNG ABBRECHEN - setzt alles zurÃ¼ck
        function cancelBooking() {
            // ğŸ†• BestÃ¤tigungsdialog
            const confirmed = confirm('â†©ï¸ Buchung wirklich abbrechen?\n\nAlle eingegebenen Daten werden gelÃ¶scht.');
            if (!confirmed) return;
            
            // ğŸ†• v5.90.76: Nutze resetBookingForm() fÃ¼r kompletten Reset!
            resetBookingForm();
            
            // Button zurÃ¼ck zu "Preis berechnen"
            const priceBtn = document.getElementById('price-btn');
            if (priceBtn) {
                priceBtn.innerHTML = 'ğŸ’° Preis berechnen';
                priceBtn.classList.remove('btn-danger');
                priceBtn.classList.add('btn-primary');
            }
            
            // Status zurÃ¼cksetzen
            priceCalculated = false;
            
            console.log('â†©ï¸ Buchung abgebrochen - ALLES zurÃ¼ckgesetzt!');
        }

        // BOOKING
        
        // ğŸ†• v5.41.5: LIVE SLOT-CHECK (Patrick's Wunsch!)
        // ğŸ†• v5.41.7: Zeigt VERFÃœGBARE SLOTS wenn belegt! (Patrick's Idee!)
        // PrÃ¼ft Slot-VerfÃ¼gbarkeit wÃ¤hrend User Datum/Zeit eingibt
        let liveCheckTimeout = null;
        
        async function performLiveSlotCheck() {
            const liveDisplay = document.getElementById('live-slot-check');
            
            // ğŸ†• v5.48.0: NUR prÃ¼fen ob Vorbestellung aktiv ist!
            if (currentRideType !== 'vorbestellen') {
                if (liveDisplay) liveDisplay.style.display = 'none';
                return;
            }
            
            const dateVal = document.getElementById('custom-date').value;
            const hourVal = document.getElementById('custom-hour').value;
            const minuteVal = document.getElementById('custom-minute').value;
            
            // ğŸ†• v5.48.0: PrÃ¼fe OHNE pickupCoords - zeige Info wenn Adresse fehlt!
            if (!dateVal) {
                if (liveDisplay) liveDisplay.style.display = 'none';
                return;
            }
            
            // ğŸ†• v5.49.9: Besserer Check - prÃ¼fe auch ob Input gefÃ¼llt ist!
            const pickupInput = document.getElementById('pickup');
            const pickupValue = pickupInput ? pickupInput.value.trim() : '';
            
            if (!pickupCoords && !pickupValue) {
                if (liveDisplay) {
                    liveDisplay.innerHTML = '<span style="color:#f59e0b;">âš ï¸ Bitte zuerst Abholadresse eingeben!</span>';
                    liveDisplay.style.display = 'block';
                    liveDisplay.style.background = '#fef3c7';
                    liveDisplay.style.border = '2px solid #f59e0b';
                }
                return;
            }
            
            // ğŸ†• v5.48.0: Wenn Firebase nicht ready - zeige es!
            if (!isFirebaseReady) {
                if (liveDisplay) {
                    liveDisplay.innerHTML = '<span style="color:#666;">â³ Warte auf Verbindung...</span>';
                    liveDisplay.style.display = 'block';
                    liveDisplay.style.background = '#f3f4f6';
                    liveDisplay.style.border = '2px solid #d1d5db';
                }
                return;
            }
            
            // Zeige "PrÃ¼fe..." Nachricht
            if (liveDisplay) {
                liveDisplay.innerHTML = '<span style="color:#666;">ğŸ” PrÃ¼fe VerfÃ¼gbarkeit...</span>';
                liveDisplay.style.display = 'block';
                liveDisplay.style.background = '#f3f4f6';
                liveDisplay.style.border = '2px solid #d1d5db';
            }
            
            try {
                // Timestamp berechnen
                const dateParts = dateVal.split('-');
                const selectedDate = new Date(
                    parseInt(dateParts[0]),
                    parseInt(dateParts[1]) - 1,
                    parseInt(dateParts[2]),
                    parseInt(hourVal),
                    parseInt(minuteVal),
                    0, 0
                );
                const timestamp = selectedDate.getTime();
                
                // Slot prÃ¼fen
                const availability = await checkTimeSlotAvailability(timestamp, pickupCoords);
                
                if (liveDisplay) {
                    if (availability.available) {
                        // âœ… FREI - v5.90.73: NUR ICON, keine groÃŸe Box!
                        liveDisplay.style.display = 'none';  // Box weg!
                        const slotIcon = document.getElementById('slot-confirmation-icon');
                        if (slotIcon) {
                            slotIcon.style.display = 'inline-block';
                        }
                    } else {
                        // ğŸ’¾ BESETZT â†’ Zeige ALTERNATIVEN! (Patrick's Idee!)
                        // v5.90.73: Icon verstecken!
                        const slotIcon = document.getElementById('slot-confirmation-icon');
                        if (slotIcon) slotIcon.style.display = 'none';
                        
                        console.log('âš ï¸ Live-Check: Slot belegt, berechne Alternativen...');
                        
                        // Berechne alternative Zeiten
                        const alternatives = await calculateAlternativeTimes(
                            availability.conflictingRide,
                            pickupCoords,
                            timestamp
                        );
                        
                        // Formatiere gewÃ¤hlte Zeit
                        const chosenTime = selectedDate.toLocaleString('de-DE', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        // ğŸ†• v5.90.119: PrÃ¼fe ob Fehler (fehlender Zielort)
                        if (alternatives.length > 0 && alternatives[0].error && alternatives[0].message === 'missing_destination') {
                            // FEHLER: Zielort fehlt!
                            const conflictTime = alternatives[0].rideTime;
                            liveDisplay.innerHTML = `
                                <div style="color:#ef4444;font-weight:bold;margin-bottom:10px;">
                                    âš ï¸ ${chosenTime} Uhr ist bereits belegt!
                                </div>
                                <div style="color:#ef4444;font-size:13px;margin-bottom:8px;border-left:3px solid #ef4444;padding-left:10px;">
                                    ğŸš¨ <strong>PROBLEM:</strong> Die Fahrt um ${conflictTime} Uhr hat <strong>keinen Zielort</strong>!<br>
                                    <br>
                                    <strong>Folge:</strong> Alternative Zeiten kÃ¶nnen nicht berechnet werden.<br>
                                    <br>
                                    <strong>LÃ¶sung:</strong><br>
                                    1. Ã–ffne die Fahrt um ${conflictTime} im Kalender<br>
                                    2. Trage den Zielort nach<br>
                                    3. Versuche es erneut
                                </div>
                                <div style="margin-top:12px;padding:10px;background:#fef3c7;border-radius:6px;font-size:12px;color:#92400e;">
                                    ğŸ’¡ <strong>Tipp:</strong> Ohne Zielort kann das System die RÃ¼ckfahrzeit nicht berechnen.
                                </div>
                            `;
                            liveDisplay.style.background = '#fee2e2';
                            liveDisplay.style.border = '2px solid #ef4444';
                            liveDisplay.style.display = 'block';
                            return;
                        }
                        
                        // Erstelle HTML mit Alternativen
                        let html = `<div style="color:#f59e0b;font-weight:bold;margin-bottom:10px;">
                            âŒ Termin nicht verfÃ¼gbar
                        </div>`;
                        
                        if (alternatives.length > 0) {
                            html += `<div style="color:#10b981;font-weight:bold;margin-bottom:8px;font-size:13px;">
                                âœ… NÃ¤chste freie Zeiten:
                            </div>`;
                            
                            // Zeige erste 3 Alternativen mit Buttons
                            alternatives.slice(0, 3).forEach(alt => {
                                const altDate = new Date(alt.timestamp);
                                const altTime = altDate.toLocaleString('de-DE', {
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                                
                                html += `<button 
                                    onclick="applyAlternativeTime(${alt.timestamp})"
                                    style="display:block;width:100%;padding:10px;margin-bottom:6px;
                                    background:white;border:2px solid #10b981;border-radius:6px;
                                    color:#10b981;font-weight:bold;font-size:14px;cursor:pointer;
                                    transition:all 0.2s;"
                                    onmouseover="this.style.background='#10b981';this.style.color='white';"
                                    onmouseout="this.style.background='white';this.style.color='#10b981';">
                                    ${altTime} Uhr
                                </button>`;
                            });
                        } else {
                            html += `<div style="color:#ef4444;font-size:13px;">
                                Keine freien Slots in der NÃ¤he gefunden.
                            </div>`;
                        }
                        
                        liveDisplay.innerHTML = html;
                        liveDisplay.style.background = '#fef3c7';
                        liveDisplay.style.border = '2px solid #f59e0b';
                    }
                    liveDisplay.style.display = 'block';
                }
            } catch (error) {
                console.error('ğŸ’¾ Live-Check Fehler:', error);
                if (liveDisplay) liveDisplay.style.display = 'none';
            }
        }
        
        // ğŸ†• v5.41.7: Ãœbernimmt alternative Zeit in die Felder
        async function applyAlternativeTime(timestamp) {
            const date = new Date(timestamp);
            
            // Setze Datum
            const dateStr = date.getFullYear() + '-' + 
                           String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(date.getDate()).padStart(2, '0');
            document.getElementById('custom-date').value = dateStr;
            
            // Setze Stunde
            const hour = String(date.getHours()).padStart(2, '0');
            document.getElementById('custom-hour').value = hour;
            
            // Setze Minute
            const minute = String(date.getMinutes()).padStart(2, '0');
            document.getElementById('custom-minute').value = minute;
            
            console.log('âœ… Alternative Zeit Ã¼bernommen:', date.toLocaleString('de-DE'));
            
            // ğŸ”§ v5.50.3: KEIN Auto-Preis mehr! (Patrick's Bug-Fix!)
            // User MUSS manuell "Preis berechnen" klicken!
            console.log('ğŸ’¡ Zeit Ã¼bernommen - bitte jetzt "Preis berechnen" klicken!');
            
            // Zeige Hinweis im Live-Display
            const liveDisplay = document.getElementById('live-slot-check');
            if (liveDisplay) {
                liveDisplay.innerHTML = `
                    <div style="color:#10b981;font-weight:bold;margin-bottom:8px;">
                        âœ… Zeit Ã¼bernommen: ${date.toLocaleString('de-DE', {
                            hour: '2-digit',
                            minute: '2-digit'
                        })} Uhr
                    </div>
                    <div style="color:#666;font-size:13px;">
                        ğŸ‘‰ Jetzt "Preis berechnen" klicken!
                    </div>
                `;
                liveDisplay.style.background = '#d1fae5';
                liveDisplay.style.border = '2px solid #10b981';
                liveDisplay.style.display = 'block';
            }
            
            // Trigger neuen Live-Check (nach kurzer VerzÃ¶gerung)
            setTimeout(() => {
                performLiveSlotCheck();
            }, 2000); // 2 Sekunden warten, damit Hinweis sichtbar bleibt
        }
        
        // Event Listeners fÃ¼r Live-Check
        function initializeLiveSlotCheck() {
            const dateField = document.getElementById('custom-date');
            const hourField = document.getElementById('custom-hour');
            const minuteField = document.getElementById('custom-minute');
            
            const triggerLiveCheck = () => {
                // Debounce: Warte 500ms nach letzter Ã„nderung
                clearTimeout(liveCheckTimeout);
                liveCheckTimeout = setTimeout(() => {
                    performLiveSlotCheck();
                }, 500);
            };
            
            if (dateField) dateField.addEventListener('change', triggerLiveCheck);
            if (hourField) hourField.addEventListener('change', triggerLiveCheck);
            if (minuteField) minuteField.addEventListener('change', triggerLiveCheck);
            
            console.log('âœ… Live Slot-Check initialisiert');
        }
        
        // Initialisiere nach DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeLiveSlotCheck);
        } else {
            initializeLiveSlotCheck();
        }
        
        async function calculatePriceAndShow() {
            const pickup = document.getElementById('pickup').value.trim();
            const destination = document.getElementById('destination').value.trim();
            
            debugLog('info', `ğŸ’° Preisberechnung gestartet: ${pickup} â†’ ${destination}`);
            
            if (!pickup || !destination) {
                debugLog('warn', 'âš ï¸ Preis: Abholort oder Zielort fehlt!');
                alert('ğŸ’¾ Bitte Abholort und Zielort eingeben!');
                return;
            }
            
            // ğŸ”§ v5.90.100: PARALLELES GEOCODING - Start + Ziel GLEICHZEITIG! ğŸš€
            const geocodePromises = [];
            
            if (!pickupCoords) {
                debugLog('info', 'ğŸ” Geocode Abholort...');
                geocodePromises.push(
                    geocode(pickup).then(coords => {
                        pickupCoords = coords;
                        if (coords) {
                            debugLog('info', `âœ… Abholort geocoded: ${coords.lat}, ${coords.lon}`);
                        }
                        return { type: 'pickup', coords };
                    })
                );
            }
            
            if (!destCoords) {
                debugLog('info', 'ğŸ” Geocode Zielort...');
                geocodePromises.push(
                    geocode(destination).then(coords => {
                        destCoords = coords;
                        if (coords) {
                            debugLog('info', `âœ… Zielort geocoded: ${coords.lat}, ${coords.lon}`);
                        }
                        return { type: 'dest', coords };
                    })
                );
            }
            
            // FÃœHRE GEOCODING PARALLEL AUS! âš¡
            if (geocodePromises.length > 0) {
                const startTime = Date.now();
                const results = await Promise.all(geocodePromises);
                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                console.log(`âš¡ v5.90.100: ${geocodePromises.length} Geocode-Calls in ${duration} Sek (parallel!)ğŸš€`);
                
                // PrÃ¼fe Ergebnisse
                for (const result of results) {
                    if (!result.coords) {
                        const location = result.type === 'pickup' ? pickup : destination;
                        debugLog('error', `ğŸ’¾ ${result.type === 'pickup' ? 'Abholort' : 'Zielort'} nicht gefunden: ${location}`);
                        alert(`ğŸ’¾ ${result.type === 'pickup' ? 'Abholort' : 'Zielort'} "${location}" nicht gefunden!\n\nTipp: Nutze die Autocomplete-VorschlÃ¤ge`);
                        return;
                    }
                }
            }
            
            debugLog('info', 'ğŸ—ºï¸ Berechne Route...');
            
            // ğŸ†• v5.90.527: MIT WAYPOINTS!
            const validWaypoints = waypoints.filter(wp => wp.coords !== null);
            console.log('ğŸ›‘ v5.90.527: Waypoints:', validWaypoints.length);
            
            const route = await calculateRoute(pickupCoords, destCoords, validWaypoints);
            
            // ğŸ†• v5.50.0: OSRM Fahrtdauer prominent loggen
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ—ºï¸ OSRM ROUTE BERECHNUNG:');
            console.log(`   Von: ${pickup}`);
            console.log(`   Nach: ${destination}`);
            console.log(`   Distanz: ${route.distance} km`);
            console.log(`   Fahrtdauer: ${route.duration} Minuten`);
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            debugLog('info', `ğŸ—ºï¸ Route: ${route.distance} km, ${route.duration} Min`);
            
            // Hole Abholzeit fÃ¼r korrekte Tarifberechnung
            // ğŸ†• v5.90.74: Nutze currentRideType fÃ¼r korrekte Zeitberechnung!
            let pickupTimestamp = Date.now() + 5 * 60000; // Default: SOFORT = +5 Min
            
            if (currentRideType === 'vorbestellen') {
                // ğŸ†• v5.90.74: Lese aus custom-date + hour + minute!
                const dateVal = document.getElementById('custom-date')?.value;
                const hourVal = document.getElementById('custom-hour')?.value;
                const minuteVal = document.getElementById('custom-minute')?.value;
                
                if (dateVal && hourVal && minuteVal) {
                    pickupTimestamp = new Date(`${dateVal}T${hourVal}:${minuteVal}:00`).getTime();
                    console.log(`ğŸ• VORBESTELL-ZEIT: ${dateVal} ${hourVal}:${minuteVal}`);
                } else {
                    console.warn('âš ï¸ Vorbestell-Felder nicht ausgefÃ¼llt, nutze JETZT');
                }
            } else {
                // SOFORT-Buchung = jetzt + 5 Min
                console.log('âš¡ SOFORT-Buchung: Zeit = jetzt + 5 Min');
            }
            
            // Berechne Preis MIT Zeitstempel (fÃ¼r korrekten Tag/Nacht-Tarif)
            const pricing = calculatePrice(parseFloat(route.distance), pickupTimestamp);
            
            // ğŸ†• v5.90.528: BERECHNE GESAMT-DAUER MIT PUFFERN! (validWaypoints bereits oben definiert)
            const durationCalc = calculateTotalDuration(route.duration, validWaypoints.length);
            
            window.currentPrice = pricing.total;
            window.currentDistance = route.distance;
            window.currentDuration = route.duration;
            window.currentTotalDuration = durationCalc.totalDuration; // ğŸ†• v5.90.528: Mit Puffern!
            window.currentPickupTimestamp = pickupTimestamp; // FÃ¼r spÃ¤tere Verwendung
            
            // ğŸ¨ Preis HTML erstellen
            let priceHtml = `<div style="background:white;padding:15px;border-radius:8px;border:2px solid #10b981;">
                <div style="font-size:32px;font-weight:bold;color:#10b981;text-align:center;">${pricing.total}â‚¬</div>
                <div style="text-align:center;margin-top:8px;color:#666;">
                    ${route.distance} km â€¢ ${durationCalc.totalDuration} Min Gesamt
                </div>
                
                <div style="margin-top:12px;padding:10px;background:#f0fdf4;border-radius:6px;border:1px solid #bbf7d0;">
                    <div style="font-size:11px;color:#16a34a;font-weight:600;margin-bottom:4px;">ğŸ—ºï¸ ROUTE</div>
                    <div style="font-size:13px;color:#166534;line-height:1.4;">
                        <strong>${pickup}</strong><br>`;
            
            // ğŸ†• v5.90.527: Zeige Waypoints!
            if (validWaypoints.length > 0) {
                validWaypoints.forEach((wp, i) => {
                    priceHtml += `ğŸ›‘ <strong>${wp.address}</strong><br>`;
                });
            }
            
            priceHtml += `â†’ <strong>${destination}</strong><br>
                    </div>
                </div>
                
                <div style="margin-top:10px;padding:10px;background:#fef3c7;border-radius:6px;border:1px solid #fbbf24;">
                    <div style="font-size:11px;color:#92400e;font-weight:600;margin-bottom:4px;">â±ï¸ ZEITBERECHNUNG</div>
                    <div style="font-size:12px;color:#78350f;line-height:1.6;">
                        ğŸš— Fahrtdauer (OSRM): ${route.duration} Min<br>
                        ğŸšª Einsteigen: +${durationCalc.boardingTime} Min<br>
                        ğŸ Aussteigen: +${durationCalc.alightingTime} Min`;
            
            if (validWaypoints.length > 0) {
                priceHtml += `<br>ğŸ›‘ Zwischenstopps (${validWaypoints.length}Ã—): +${durationCalc.totalWaypointTime} Min`;
            }
            
            priceHtml += `<br>
                        <div style="margin-top:8px;padding:8px;background:white;border-radius:4px;font-weight:bold;color:#92400e;">
                            â±ï¸ GESAMT: ${durationCalc.totalDuration} Minuten
                        </div>
                    </div>
                </div>`;
            
            if (pricing.zuschlagText.length > 0) {
                priceHtml += `<div style="margin-top:10px;padding:8px;background:#fef3c7;border-radius:6px;font-size:13px;text-align:center;">
                    ${pricing.zuschlagText.join(' â€¢ ')}
                </div>`;
            }
            
            priceHtml += '</div>';
            
            // ğŸ†• v5.90.75: SLOT-CHECK beim Preis-Berechnen
            // PrÃ¼fe ob es eine Vorbestellung ist (nur currentRideType!)
            const isAdvanceBooking = currentRideType === 'vorbestellen';
            
            console.log('ğŸ” Slot-Check beim Preis-Berechnen:', {
                currentRideType: currentRideType,
                isAdvanceBooking: isAdvanceBooking,
                autoBookingEnabled: autoBookingEnabled,
                isFirebaseReady: isFirebaseReady
            });
            
            if (autoBookingEnabled && isAdvanceBooking && isFirebaseReady && pickupCoords) {
                console.log('ğŸ¤– Quick-Check: PrÃ¼fe Slot-VerfÃ¼gbarkeit...');
                
                try {
                    const availability = await checkTimeSlotAvailability(pickupTimestamp, pickupCoords);
                    
                    if (!availability.available) {
                        console.log('âš ï¸ Slot vermutlich belegt!');
                        
                        // Zeige DEUTLICHE Warnung unter Preis
                        priceHtml += `<div style="margin-top:15px;padding:15px;background:#fef3c7;border:2px solid #f59e0b;border-radius:8px;">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <span style="font-size:24px;">âš ï¸</span>
                                <div style="font-weight:bold;color:#d97706;font-size:16px;">Zeitslot vermutlich belegt!</div>
                            </div>
                            <div style="font-size:14px;color:#92400e;line-height:1.5;">
                                Diese Zeit ist bereits gebucht.<br>
                                Beim Buchen erhÃ¤ltst du automatisch alternative Zeiten vorgeschlagen.
                            </div>
                        </div>`;
                    } else {
                        console.log('âœ… Slot verfÃ¼gbar!');
                    }
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim Quick-Check:', error);
                }
            }
            
            const priceDisplay = document.getElementById('price-display');
            priceDisplay.innerHTML = priceHtml;
            priceDisplay.style.display = 'block';
            
            // ğŸ†• v5.90.77: ROTES X anzeigen (um nur Ziel zu Ã¤ndern)
            const clearDestBtn = document.getElementById('clear-destination-btn');
            if (clearDestBtn) {
                clearDestBtn.style.display = 'inline-block';
            }
            
            // ğŸ—ºï¸ ROUTE-KARTE ANZEIGEN
            showRouteMap(route, pickupCoords, destCoords);
            
            const bookBtn = document.getElementById('book-btn');
            if (bookBtn) {
                bookBtn.style.display = 'block';
                bookBtn.style.visibility = 'visible';
            }
            
            // ğŸ†• v5.90.526: ZEIGE "FREIE ZEITEN" BUTTON!
            const slotsBtn = document.getElementById('show-slots-btn');
            if (slotsBtn && isAdvanceBooking) {
                // Nur bei Vorbestellung zeigen!
                slotsBtn.style.display = 'block';
                slotsBtn.style.visibility = 'visible';
            }
            
            // ğŸ†• PREIS-BUTTON ZU ABBRECHEN Ã„NDERN
            const priceBtn = document.getElementById('price-btn');
            if (priceBtn) {
                priceBtn.innerHTML = 'â†©ï¸ Abbrechen';
                priceBtn.classList.remove('btn-primary');
                priceBtn.classList.add('btn-danger');
            }
            priceCalculated = true;
        }

        // ğŸ—ºï¸ ROUTE-KARTE ANZEIGEN
        let routeMapInstance = null;
        function showRouteMap(route, pickupCoords, destCoords) {
            // ğŸ› v5.90.542: NULL-CHECK!
            if (!pickupCoords || !destCoords || !pickupCoords.lat || !destCoords.lat) {
                console.warn('âš ï¸ showRouteMap: Koordinaten fehlen!', {pickupCoords, destCoords});
                const mapContainer = document.getElementById('route-map');
                if (mapContainer) mapContainer.style.display = 'none';
                return;
            }
            
            const mapContainer = document.getElementById('route-map');
            mapContainer.style.display = 'block';
            
            // Karte entfernen falls vorhanden
            if (routeMapInstance) {
                routeMapInstance.remove();
            }
            
            // Neue Karte erstellen - 2-Finger-Zoom, 1-Finger scrollt Seite
            routeMapInstance = L.map('route-map', {
                zoomControl: false,
                attributionControl: false,
                dragging: false,           // Kein Drag mit 1 Finger
                tap: false,                // Kein Tap-Drag
                scrollWheelZoom: false,    // Kein Scroll-Zoom
                touchZoom: true            // Pinch-Zoom mit 2 Fingern erlaubt
            });
            
            // OpenStreetMap Tiles laden
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19
            }).addTo(routeMapInstance);
            
            // Start Marker (grÃ¼n)
            L.marker([pickupCoords.lat, pickupCoords.lon], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background:#10b981;width:24px;height:24px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);"></div>',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                })
            }).addTo(routeMapInstance);
            
            // Ziel Marker (rot)
            L.marker([destCoords.lat, destCoords.lon], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background:#ef4444;width:24px;height:24px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);"></div>',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                })
            }).addTo(routeMapInstance);
            
            // ğŸ†• v5.90.527: WAYPOINT MARKERS (gelb)!
            if (waypoints && waypoints.length > 0) {
                waypoints.forEach((wp, index) => {
                    if (wp.coords) {
                        L.marker([wp.coords.lat, wp.coords.lon], {
                            icon: L.divIcon({
                                className: 'custom-marker',
                                html: `<div style="background:#f59e0b;width:28px;height:28px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:12px;">${index+1}</div>`,
                                iconSize: [28, 28],
                                iconAnchor: [14, 14]
                            })
                        }).addTo(routeMapInstance);
                    }
                });
            }
            
            // Route-Linie zeichnen (aus geometry)
            if (route.geometry && route.geometry.length > 0) {
                const routeLine = L.polyline(
                    route.geometry.map(coord => [coord[1], coord[0]]), // [lon, lat] â†’ [lat, lon]
                    {
                        color: '#667eea',
                        weight: 5,
                        opacity: 0.8
                    }
                ).addTo(routeMapInstance);
                
                // Zoom auf Route
                routeMapInstance.fitBounds(routeLine.getBounds(), { padding: [30, 30] });
            } else {
                // Fallback: Zoom auf Start und Ziel
                routeMapInstance.fitBounds([
                    [pickupCoords.lat, pickupCoords.lon],
                    [destCoords.lat, destCoords.lon]
                ], { padding: [30, 30] });
            }
            
            console.log('ğŸ—ºï¸ Route-Karte angezeigt');
        }

        // ğŸ†• v5.90.304: SCHEDULER FÃœR VORBESTELLUNGEN!
        // LÃ¤uft jede Minute und aktiviert Fahrten 30 Min vorher
        let preorderSchedulerInterval = null;
        
        function startPreorderScheduler() {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('â° VORBESTELL-SCHEDULER GESTARTET');
            console.log('   PrÃ¼ft jede Minute ob Vorbestellungen aktiviert werden');
            console.log('   Regel: 30 Minuten vor Abholzeit â†’ Status "new"');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            // Stoppe alten Interval falls vorhanden
            if (preorderSchedulerInterval) {
                clearInterval(preorderSchedulerInterval);
            }
            
            // Erste PrÃ¼fung sofort
            checkPreorders();
            
            // Dann jede Minute
            preorderSchedulerInterval = setInterval(() => {
                checkPreorders();
            }, 60000); // 60 Sekunden
        }
        
        async function checkPreorders() {
            if (!isFirebaseReady) {
                console.log('â¸ï¸ Scheduler: Firebase nicht bereit');
                return;
            }
            
            const now = Date.now();
            
            try {
                // Hole alle Fahrten aus Firebase
                const snapshot = await db.ref('rides').once('value');
                const allRides = [];
                
                snapshot.forEach(child => {
                    const ride = child.val();
                    ride.firebaseId = child.key;
                    allRides.push(ride);
                });
                
                // Filtere Vorbestellungen (NUR HEUTE + ZUKUNFT!)
                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);
                const todayTimestamp = todayStart.getTime();
                
                const preorders = allRides.filter(r => 
                    r.status === 'vorbestellt' && 
                    r.pickupTimestamp &&
                    r.pickupTimestamp >= todayTimestamp // ğŸ†• v5.90.541: Keine alten Fahrten!
                );
                
                if (preorders.length === 0) {
                    console.log('â° Scheduler: Keine Vorbestellungen');
                    return;
                }
                
                console.log(`â° Scheduler: ${preorders.length} Vorbestellung(en) gefunden`);
                
                // ğŸ†• v5.90.525: LADE PUFFER AUS SETTINGS!
                const settingsSnapshot = await db.ref('settings/autoAssign').once('value');
                const autoAssignSettings = settingsSnapshot.val() || {};
                const bufferMinutes = autoAssignSettings.buffer || 5; // Standard: 5 Min
                
                console.log('âš™ï¸ Auto-Assign Puffer:', bufferMinutes, 'Minuten');
                
                for (const ride of preorders) {
                    const pickupTime = ride.pickupTimestamp;
                    const timeUntilPickup = pickupTime - now;
                    const minutesUntilPickup = Math.round(timeUntilPickup / 60000);
                    
                    // ğŸ†• v5.90.525: DYNAMISCHE AKTIVIERUNG!
                    // Finde nÃ¤chstes Fahrzeug und berechne Anfahrtszeit
                    
                    if (!ride.pickupCoords || !ride.pickupCoords.lat) {
                        console.log(`âš ï¸ Vorbestellung ${ride.firebaseId}: Keine Koordinaten!`);
                        continue;
                    }
                    
                    // Finde nÃ¤chstes verfÃ¼gbares Fahrzeug
                    const nearestVehicle = findNearestAvailableVehicle(ride.pickupCoords, []);
                    
                    if (!nearestVehicle) {
                        console.log(`âš ï¸ Vorbestellung ${ride.firebaseId}: Kein Fahrzeug verfÃ¼gbar (${minutesUntilPickup} Min)`);
                        
                        // ğŸš¨ WARNUNG wenn Pickup bald ist!
                        if (minutesUntilPickup <= 15 && minutesUntilPickup > 0) {
                            console.log('ğŸš¨ KRITISCH: Vorbestellung in', minutesUntilPickup, 'Min ohne Taxi!');
                            // TODO: Telegram an Admin
                        }
                        continue;
                    }
                    
                    // ğŸ†• v5.90.525: BERECHNE ANFAHRTSZEIT!
                    const drivingTimeMinutes = await calculateDrivingTimeToPickup(
                        { lat: nearestVehicle.lat, lon: nearestVehicle.lon },
                        { lat: ride.pickupCoords.lat, lon: ride.pickupCoords.lon }
                    );
                    
                    // ğŸ¯ AKTIVIERUNGSZEITPUNKT = Anfahrtszeit + Puffer
                    const requiredLeadTime = drivingTimeMinutes + bufferMinutes;
                    
                    console.log(`ğŸ“± Vorbestellung ${ride.firebaseId}:`, {
                        pickup: new Date(pickupTime).toLocaleTimeString('de-DE'),
                        minutesUntil: minutesUntilPickup,
                        nearestVehicle: nearestVehicle.name,
                        drivingTime: drivingTimeMinutes,
                        buffer: bufferMinutes,
                        requiredLeadTime: requiredLeadTime,
                        shouldActivate: minutesUntilPickup <= requiredLeadTime
                    });
                    
                    // âœ… AKTIVIEREN wenn Zeit erreicht!
                    if (minutesUntilPickup <= requiredLeadTime && minutesUntilPickup > 0) {
                        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                        console.log('ğŸ”” VORBESTELLUNG AKTIVIEREN!');
                        console.log('   Fahrt ID:', ride.firebaseId);
                        console.log('   Kunde:', ride.customerName);
                        console.log('   Abholzeit:', new Date(pickupTime).toLocaleTimeString('de-DE'));
                        console.log('   Minuten bis Abholung:', minutesUntilPickup);
                        console.log('   Anfahrtszeit:', drivingTimeMinutes, 'Min');
                        console.log('   Puffer:', bufferMinutes, 'Min');
                        console.log('   Erforderliche Vorlaufzeit:', requiredLeadTime, 'Min');
                        console.log('   NÃ¤chstes Taxi:', nearestVehicle.name);
                        console.log('   Von:', ride.pickup);
                        console.log('   Nach:', ride.destination);
                        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                        
                        // Status Ã¤ndern: vorbestellt â†’ new
                        await db.ref('rides/' + ride.firebaseId).update({
                            status: 'new',
                            activatedAt: Date.now(),
                            activatedBy: 'scheduler',
                            schedulerInfo: {
                                drivingTime: drivingTimeMinutes,
                                buffer: bufferMinutes,
                                requiredLeadTime: requiredLeadTime,
                                targetVehicle: nearestVehicle.id
                            }
                        });
                        
                        console.log('âœ… Status geÃ¤ndert: vorbestellt â†’ new');
                        
                        // Lade aktualisierte Fahrt
                        const updatedSnapshot = await db.ref('rides/' + ride.firebaseId).once('value');
                        const updatedRide = updatedSnapshot.val();
                        updatedRide.firebaseId = ride.firebaseId;
                        
                        // Auto-Assign starten!
                        console.log('ğŸ¯ Starte Auto-Assignment...');
                        await startAutoAssignment(ride.firebaseId, updatedRide);
                        
                        // Protokoll
                        logActivity('scheduler', 'preorder_activated', `Vorbestellung aktiviert (${minutesUntilPickup} Min vorher, Anfahrt: ${drivingTimeMinutes} Min)`, {
                            customer: ride.customerName,
                            from: ride.pickup,
                            to: ride.destination,
                            pickupTime: new Date(pickupTime).toLocaleString('de-DE'),
                            vehicle: nearestVehicle.name,
                            drivingTime: drivingTimeMinutes,
                            buffer: bufferMinutes
                        });
                        
                    } else if (minutesUntilPickup > requiredLeadTime) {
                        console.log(`â° Vorbestellung ${ride.firebaseId}: Noch ${minutesUntilPickup} Min (aktiviert in ${minutesUntilPickup - requiredLeadTime} Min)`);
                    } else if (minutesUntilPickup <= 0) {
                        console.log(`âš ï¸ Vorbestellung ${ride.firebaseId}: Abholzeit Ã¼berschritten! (${Math.abs(minutesUntilPickup)} Min zu spÃ¤t)`);
                    }
                }
                
            } catch (error) {
                console.error('ğŸ’¾ Scheduler Fehler:', error);
            }
        }
        
        // ğŸ¯ INTELLIGENTE AUTO-ZUWEISUNG MIT 30-SEK-TIMER
        // ğŸ†• v5.90.525: BERECHNE ANFAHRTSZEIT ZUM PICKUP (OSRM)
        async function calculateDrivingTimeToPickup(vehicleLocation, pickupLocation) {
            try {
                const url = `https://router.project-osrm.org/route/v1/driving/` +
                    `${vehicleLocation.lon},${vehicleLocation.lat};` +
                    `${pickupLocation.lon},${pickupLocation.lat}?overview=false`;
                
                // ğŸ†• v5.90.541: TIMEOUT (5 Sekunden)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                if (data.code === 'Ok' && data.routes && data.routes[0]) {
                    const durationSeconds = data.routes[0].duration;
                    const durationMinutes = Math.ceil(durationSeconds / 60);
                    
                    console.log('ğŸš— Anfahrtszeit berechnet:', durationMinutes, 'Min');
                    return durationMinutes;
                } else {
                    console.warn('âš ï¸ OSRM konnte Route nicht berechnen, nutze Luftlinie-SchÃ¤tzung');
                    // Fallback: ~40 km/h Durchschnitt
                    const distanceKm = calculateGPSDistance(
                        vehicleLocation.lat, vehicleLocation.lon,
                        pickupLocation.lat, pickupLocation.lon
                    );
                    return Math.ceil(distanceKm * 1.5); // 1.5 Min pro km
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.warn('âš ï¸ OSRM Timeout bei Anfahrtszeit - nutze Luftlinie-SchÃ¤tzung');
                } else {
                    console.error('ğŸ’¾ Fehler bei Anfahrtszeit-Berechnung:', error);
                }
                // Fallback
                const distanceKm = calculateGPSDistance(
                    vehicleLocation.lat, vehicleLocation.lon,
                    pickupLocation.lat, pickupLocation.lon
                );
                return Math.ceil(distanceKm * 1.5);
            }
        }

        async function startAutoAssignment(rideId, ride) {
            console.log('ğŸ¯ startAutoAssignment aufgerufen fÃ¼r Fahrt:', rideId, 'Status:', ride?.status);
            console.log('ğŸ’¾ Aufruf-Stack:', new Error().stack.split('\n').slice(2, 4).join('\n'));
            
            // ğŸ›¡ï¸ WICHTIG: PrÃ¼fe ob Fahrt noch zuweisbar ist!
            if (isFirebaseReady) {
                try {
                    const currentRide = await db.ref('rides/' + rideId).once('value');
                    const rideData = currentRide.val();
                    
                    if (!rideData) {
                        console.log('â¹ï¸ Auto-Zuweisung abgebrochen - Fahrt existiert nicht mehr');
                        return;
                    }
                    
                    // âš ï¸ KRITISCH: Nur zuweisen wenn Status 'new' ist!
                    // Verhindert Doppel-Zuweisung bei accepted/assigned/cancelled Fahrten
                    if (rideData.status !== 'new') {
                        console.log('â¹ï¸ Auto-Zuweisung abgebrochen - Fahrt hat Status:', rideData.status, '(erwartet: new)');
                        console.log('ğŸ›¡ï¸ Verhindere Doppel-Zuweisung fÃ¼r rideId:', rideId);
                        return;
                    }
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim PrÃ¼fen der Fahrt:', error);
                    return;
                }
            }
            
            // Finde nÃ¤chstes verfÃ¼gbares Taxi
            // ğŸ†• v5.21.8: Blacklist Ã¼bergeben um Endlos-Zuweisung zu verhindern
            const blacklist = ride.assignmentBlacklist || [];
            const nearestVehicle = findNearestAvailableVehicle(ride.pickupCoords, blacklist);
            
            if (!nearestVehicle) {
                console.log('âš ï¸ Kein Taxi verfÃ¼gbar - Fahrt bleibt in Warteschlange');
                
                // ğŸ†• v5.21.8: Unterscheide zwischen "keiner online" und "alle haben abgelehnt"
                if (blacklist.length > 0) {
                    console.log('ğŸ“‹ Blacklist hat', blacklist.length, 'Fahrer - alle haben nicht angenommen');
                    logActivity('assignment', 'all_rejected', `Alle ${blacklist.length} Fahrer haben nicht angenommen`, {
                        customer: ride.customerName,
                        from: ride.pickup,
                        to: ride.destination,
                        blacklist: blacklist.join(', ')
                    });
                } else {
                    // ğŸ“œ PROTOKOLL: Kein Fahrer verfÃ¼gbar
                    logActivity('assignment', 'no_driver', `Kein Fahrer verfÃ¼gbar fÃ¼r Fahrt`, {
                        customer: ride.customerName,
                        from: ride.pickup,
                        to: ride.destination
                    });
                }
                return;
            }
            
            // ğŸ†• v5.90.525: BERECHNE ANFAHRTSZEIT!
            const drivingTimeMinutes = await calculateDrivingTimeToPickup(
                { lat: nearestVehicle.lat, lon: nearestVehicle.lon },
                { lat: ride.pickupCoords.lat, lon: ride.pickupCoords.lon }
            );
            
            console.log('âœ… NÃ¤chstes Taxi gefunden:', nearestVehicle.id, 'Entfernung:', nearestVehicle.distance.toFixed(2), 'km', '| Anfahrtszeit:', drivingTimeMinutes, 'Min');
            
            // Markiere Fahrt als zugewiesen
            await db.ref('rides/' + rideId).update({
                status: 'assigned',  // ğŸš• WICHTIG: Fahrer ist jetzt BESETZT!
                assignedTo: nearestVehicle.id,
                vehicleId: nearestVehicle.id,  // ğŸ†• v5.90.324: vehicleId SETZEN damit Fahrer sieht!
                vehicle: nearestVehicle.name,  // ğŸ”§ v5.90.345: Fahrzeugname wie bei manuell!
                vehicleLabel: nearestVehicle.name,  // ğŸ”§ v5.90.345: Label wie bei manuell!
                assignedVehicleName: nearestVehicle.name,
                assignedAt: Date.now(),
                assignedBy: 'auto-assign',  // ğŸ”§ v5.90.345: Wie bei manuell!
                timestamp: ride.pickupTimestamp || ride.timestamp || Date.now(),  // ğŸ”§ v5.90.351: TIMESTAMP FÃœR FILTER!
                assignmentExpiresAt: Date.now() + 60000, // 60 Sekunden (erhÃ¶ht von 30!)
                assignmentDistance: nearestVehicle.distance,
                drivingTimeToPickup: drivingTimeMinutes,  // ğŸ†• v5.90.525: Anfahrtszeit!
                estimatedArrivalAt: Date.now() + (drivingTimeMinutes * 60000)  // ğŸ†• v5.90.525: ETA!
            });
            
            // ğŸ“œ PROTOKOLL: Fahrt zugewiesen
            logActivity('assignment', 'assigned', `Fahrt zugewiesen an ${nearestVehicle.name}`, {
                customer: ride.customerName,
                driver: nearestVehicle.name,
                vehicle: nearestVehicle.id,
                distance: nearestVehicle.distance.toFixed(2) + ' km',
                from: ride.pickup,
                to: ride.destination,
                price: ride.price
            });
            
            // Push-Benachrichtigung an Fahrer (lokal in der App)
            sendLocalNotification(
                'ğŸš• NEUE FAHRT!',
                `${ride.customerName || 'Fahrgast'} â€¢ ${ride.pickup} â†’ ${ride.destination}\nğŸ’° ${ride.price}â‚¬ â€¢ â±ï¸ 60 Sekunden Zeit!`,
                { rideId: rideId, vehicleId: nearestVehicle.id }
            );
            
            // ğŸ†• v5.18.0: TELEGRAM DIREKT AN FAHRER SENDEN!
            // Das ist der kritische Teil - Fahrer bekommt Telegram auch wenn App im Hintergrund!
            // ğŸ†• v5.19.0: GPS-Alter fÃ¼r Warnung Ã¼bergeben
            sendTelegramToDriver(nearestVehicle.id, ride, nearestVehicle.gpsAge || 0);
            
            // ğŸ†• v5.90.525: AKTUALISIERE FAHRER-VIEW!
            if (currentVehicle === nearestVehicle.id && typeof updateDriverView === 'function') {
                console.log('ğŸ”„ Aktualisiere Fahrer-View nach Auto-Assign...');
                setTimeout(() => {
                    updateDriverView();
                }, 500);
            }
            
            // Starte 60-Sekunden-Timer
            assignmentTimers[rideId] = setTimeout(async () => {
                // PrÃ¼fe ob Fahrt in 60 Sek. angenommen wurde
                const rideCheck = await db.ref('rides/' + rideId).once('value');
                const rideData = rideCheck.val();
                
                // Wenn Status noch 'assigned' ist = Fahrer hat NICHT angenommen!
                if (rideData && rideData.status === 'assigned') {
                    console.log('â° TIMEOUT! Fahrt nicht angenommen - weise nÃ¤chstem Taxi zu');
                    
                    // ğŸ†• v5.25.6: TEMPORÃ„RE SPERRE FÃœR FAHRER (3 Minuten)
                    const blockUntil = Date.now() + (3 * 60 * 1000); // 3 Minuten
                    await db.ref('vehicles/' + nearestVehicle.id + '/temporaryBlock').set({
                        blockedAt: Date.now(),
                        blockedUntil: blockUntil,
                        reason: 'Keine Reaktion auf Fahrt-Zuweisung',
                        rideId: rideId,
                        customerName: rideData.customerName
                    });
                    
                    const untilTime = new Date(blockUntil).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
                    console.log(`ğŸš« Fahrer ${nearestVehicle.name} fÃ¼r 3 Min. gesperrt (bis ${untilTime} Uhr)`);
                    
                    // ğŸ“œ PROTOKOLL: Timeout + Sperre
                    logActivity('assignment', 'driver_blocked', 
                        `âš ï¸ ${nearestVehicle.name} hat nicht reagiert â†’ 3 Min. Sperre`, {
                        customer: rideData.customerName,
                        driver: nearestVehicle.name,
                        vehicle: nearestVehicle.id,
                        blockedUntil: untilTime
                    });
                    
                    // ğŸ“± TELEGRAM AN ADMIN
                    sendTelegramToAdmin(
                        `âš ï¸ <b>FAHRER REAGIERT NICHT!</b>\n\n` +
                        `ğŸš— Fahrer: ${nearestVehicle.name}\n` +
                        `ğŸ’¾ Kunde: ${rideData.customerName || 'Unbekannt'}\n` +
                        `ğŸ“ Fahrt: ${rideData.pickup} â†’ ${rideData.destination}\n\n` +
                        `ğŸš« <b>3 Minuten Sperre aktiv</b>\n` +
                        `â° Bis: ${untilTime} Uhr`
                    );
                    
                    // Zur Blacklist hinzufÃ¼gen (fÃ¼r diese Fahrt)
                    const blacklist = rideData.assignmentBlacklist || [];
                    blacklist.push(nearestVehicle.id);
                    
                    await db.ref('rides/' + rideId).update({
                        status: 'new',  // ğŸ”„ ZurÃ¼ck auf 'new' fÃ¼r nÃ¤chsten Fahrer!
                        assignedTo: null,
                        assignmentBlacklist: blacklist,
                        lastAssignmentTimeout: Date.now()
                    });
                    
                    // NÃ¤chstes Taxi zuweisen
                    startAutoAssignment(rideId, rideData);
                }
            }, 60000); // 60 Sekunden warten (erhÃ¶ht von 30!)
        }

        // Finde nÃ¤chstes verfÃ¼gbares Taxi nach GPS-Entfernung
        // ğŸ†• v5.90.570: Reduziertes Logging (Performance!)
        function findNearestAvailableVehicle(pickupCoords, blacklist = []) {
            // Logging nur bei Bedarf (zu viel Performance-Last!)
            const debugMode = false; // Auf true setzen fÃ¼r Debug
            
            if (debugMode) {
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('ğŸ” findNearestAvailableVehicle aufgerufen');
                console.log('   pickupCoords:', pickupCoords);
                console.log('   blacklist:', blacklist);
                console.log('   drivers Anzahl:', Object.keys(drivers || {}).length);
            }
            
            const availableVehicles = [];
            const now = Date.now();
            const MAX_GPS_AGE = 10 * 60 * 1000; // 10 Minuten
            
            // Durchsuche alle Fahrer (nicht nur online!)
            for (const vehicleId in drivers) {
                const driver = drivers[vehicleId];
                
                // ğŸ†• v5.21.8: Blacklist-Check ZUERST!
                if (blacklist.includes(vehicleId)) {
                    if (debugMode) console.log(`â›” ${vehicleId}: Auf Blacklist`);
                    continue;
                }
                
                // ğŸ†• v5.25.6: TemporÃ¤re Sperre prÃ¼fen
                if (driver.temporaryBlock && driver.temporaryBlock.blockedUntil > now) {
                    if (debugMode) {
                        const remainingMinutes = Math.ceil((driver.temporaryBlock.blockedUntil - now) / 60000);
                        console.log(`ğŸš« ${vehicleId}: TemporÃ¤r gesperrt (${remainingMinutes} Min)`);
                    }
                    continue;
                }
                
                // PrÃ¼fungen:
                // 1. Hat GPS-Position
                // 2. Position ist nicht Ã¤lter als 10 Minuten
                // 3. Hat keine aktive Fahrt
                if (driver && driver.lat && driver.lon && driver.timestamp) {
                    const gpsAge = now - driver.timestamp;
                    const gpsAgeMinutes = Math.round(gpsAge / 60000);
                    
                    // Position zu alt? Ãœberspringen
                    if (gpsAge > MAX_GPS_AGE) {
                        if (debugMode) console.log(`â° ${vehicleId}: GPS zu alt! (${gpsAgeMinutes} Min)`);
                        continue;
                    }
                    
                    // PrÃ¼fe ob Fahrzeug bereits eine Fahrt hat
                    const hasActiveRide = rides.some(r => 
                        (r.vehicleId === vehicleId || r.assignedTo === vehicleId) && 
                        (r.status === 'assigned' || r.status === 'accepted' || r.status === 'picked_up')
                    );
                    
                    if (hasActiveRide) {
                        if (debugMode) console.log(`ğŸš— ${vehicleId}: Hat bereits aktive Fahrt!`);
                        continue;
                    }
                    
                    // Berechne Entfernung (GPS-basiert)
                    // ğŸ†• v5.90.341: Verwende calculateGPSDistance statt calculateDistance
                    const distance = calculateGPSDistance(
                        pickupCoords.lat, pickupCoords.lon,
                        driver.lat, driver.lon
                    );
                    
                    console.log(`âœ… v5.90.329: ${vehicleId} ist verfÃ¼gbar! Entfernung: ${distance.toFixed(2)} km`);
                    
                    availableVehicles.push({
                        id: vehicleId,
                        name: driver.vehicle || VEHICLES[vehicleId]?.name || vehicleId,
                        distance: distance,
                        lat: driver.lat,
                        lon: driver.lon,
                        gpsAge: gpsAgeMinutes,
                        isStandby: driver.mode === 'standby' || !driver.online,
                        telegramChatId: driver.telegramChatId
                    });
                } else {
                    console.log(`ğŸ’¾ v5.90.329: ${vehicleId}: Fehlende Daten! lat=${!!driver.lat} lon=${!!driver.lon} timestamp=${!!driver.timestamp}`);
                }
            }
            
            // Sortiere nach Entfernung (nÃ¤chstes zuerst)
            availableVehicles.sort((a, b) => a.distance - b.distance);
            
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ“ v5.90.329: VerfÃ¼gbare Taxis:', availableVehicles.length);
            if (availableVehicles.length > 0) {
                console.log('ğŸ¯ v5.90.329: NÃ¤chstes Taxi:', availableVehicles[0]);
            } else {
                console.log('ğŸ’¾ v5.90.329: KEINE VERFÃœGBAREN TAXIS!');
                console.log('   GrÃ¼nde:');
                console.log('   - Kein Fahrer online mit GPS');
                console.log('   - GPS Ã¤lter als 10 Min');
                console.log('   - Alle haben aktive Fahrten');
            }
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            return availableVehicles.length > 0 ? availableVehicles[0] : null;
        }

        // Haversine-Formel fÃ¼r Entfernungsberechnung
        // ğŸ†• v5.90.341: UMBENENNUNG um Konflikt mit geocode-Version zu vermeiden!
        function calculateGPSDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Erdradius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ğŸ†• v5.90.123: ZIFFERNBLOCK FÃœR TAXI BUCHEN MIT SLOT-CHECK!
        function openTimeKeypadForBooking() {
            const displayBtn = document.getElementById('time-display-btn');
            const hourInput = document.getElementById('custom-hour');
            const minuteInput = document.getElementById('custom-minute');
            const dateInput = document.getElementById('custom-date');
            
            const currentTime = displayBtn.textContent.trim();
            
            console.log('âŒ¨ï¸ Ã–ffne Ziffernblock fÃ¼r Buchung:', currentTime);
            
            // Ã–ffne Ziffernblock
            showTimeKeypad(currentTime, async (newTime) => {
                console.log('âœ… Zeit gewÃ¤hlt:', newTime);
                
                // Parse Zeit
                const parts = newTime.split(':');
                const hour = parts[0];
                const minute = parts[1];
                
                // Update Hidden Inputs
                hourInput.value = hour;
                minuteInput.value = minute;
                
                // Update Button Display
                displayBtn.textContent = newTime;
                
                console.log('ğŸ“± Zeit gesetzt:', { hour, minute });
                
                // ğŸ†• v5.90.640: PRÃœFE NUR WENN ALLE FELDER AUSGEFÃœLLT!
                triggerSlotCheck();
            });
        }
        
        // ğŸ†• v5.90.640: TRIGGER SLOT-CHECK NUR WENN DATUM + ZEIT DA SIND!
        async function triggerSlotCheck() {
            const pickupInput = document.getElementById('pickup');
            const destinationInput = document.getElementById('destination');
            const dateInput = document.getElementById('custom-date');
            const timeDisplayBtn = document.getElementById('time-display-btn');
            const statusDisplay = document.getElementById('slot-status-display');
            
            const pickup = pickupInput ? pickupInput.value.trim() : '';
            const destination = destinationInput ? destinationInput.value.trim() : '';
            const date = dateInput ? dateInput.value : '';
            const time = timeDisplayBtn ? timeDisplayBtn.textContent.trim() : '';
            
            console.log('ğŸ” v5.90.644: Slot-Check Trigger');
            console.log('   Pickup:', pickup ? 'âœ…' : 'âŒ');
            console.log('   Destination:', destination ? 'âœ…' : 'âŒ');
            console.log('   Datum:', date ? 'âœ…' : 'âŒ');
            console.log('   Zeit:', time ? 'âœ…' : 'âŒ');
            
            // ğŸ†• v5.90.644: PrÃ¼fe NUR Datum + Zeit (Adressen optional!)
            if (date && time) {
                console.log('âœ… Datum + Zeit vorhanden - starte PrÃ¼fung!');
                if (pickup && destination) {
                    console.log('âœ… Pickup + Destination vorhanden - mit Distanz-PrÃ¼fung!');
                } else {
                    console.log('â„¹ï¸ Keine Adressen - ohne Distanz-PrÃ¼fung!');
                }
                await checkSlotAvailability(date, time);
            } else {
                // Zeige Hinweis welche Felder fehlen
                let missing = [];
                if (!date) missing.push('Datum');
                if (!time) missing.push('Uhrzeit');
                
                console.log('âš ï¸ Fehlende Felder:', missing);
                
                if (statusDisplay) {
                    statusDisplay.style.display = 'block';
                    statusDisplay.style.background = '#f3f4f6';
                    statusDisplay.style.border = '2px solid #d1d5db';
                    statusDisplay.style.color = '#6b7280';
                    
                    statusDisplay.innerHTML = `
                        â„¹ï¸ <strong>Bitte ausfÃ¼llen:</strong><br>
                        <small>${missing.join(', ')}</small>
                    `;
                }
            }
        }
        
        // ğŸ†• v5.90.123: PRÃœFE SLOT-VERFÃœGBARKEIT + ZEIGE ALTERNATIVEN
        async function checkSlotAvailability(date, time) {
            const statusDisplay = document.getElementById('slot-status-display');
            
            console.log('ğŸ” PrÃ¼fe Slot:', { date, time });
            
            // ğŸ†• v5.90.639: DISTANZ-PRÃœFUNG fÃ¼r Vorbestellungen!
            try {
                const ridesSnapshot = await db.ref('rides').once('value');
                const ridesData = ridesSnapshot.val() || {};
                
                // Erstelle DateTime fÃ¼r den gewÃ¼nschten Slot
                const slotDateTime = new Date(date + 'T' + time);
                
                // Hole Pickup/Destination fÃ¼r Distanz-PrÃ¼fung
                const pickupInput = document.getElementById('pickup');
                const destinationInput = document.getElementById('destination');
                const pickup = pickupInput ? pickupInput.value.trim() : '';
                const destination = destinationInput ? destinationInput.value.trim() : '';
                
                console.log('ğŸ“Š Kalender-Check:');
                console.log('   Datum/Zeit:', slotDateTime.toLocaleString('de-DE'));
                console.log('   Von:', pickup);
                console.log('   Nach:', destination);
                
                // ğŸ†• v5.90.639: DISTANZ-PRÃœFUNG wenn Adressen vorhanden!
                if (pickup && destination) {
                    const distanceCheck = await checkTravelTimeConflict(slotDateTime, pickup, destination, ridesData);
                    
                    if (distanceCheck.hasConflict) {
                        // âš ï¸ ÃœBERSCHNEIDUNG!
                        statusDisplay.style.display = 'block';
                        statusDisplay.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%)';
                        statusDisplay.style.border = '2px solid #f59e0b';
                        statusDisplay.style.color = '#92400e';
                        
                        // ğŸ†• v5.90.656: ZWEIGETEILTE ANALYSE!
                        let html = '<div style="font-size:13px;line-height:1.6;">';
                        
                        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                        // ğŸ“Š ADMIN-BEREICH (ORANGE)
                        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                        html += '<div style="background:#f59e0b;color:white;padding:12px;border-radius:8px 8px 0 0;text-align:center;font-weight:700;font-size:16px;margin:-1px -1px 0 -1px;">';
                        html += 'âŒ TERMIN NICHT VERFÃœGBAR';
                        html += '</div>';
                        
                        html += '<div style="background:#fef3c7;padding:12px;border:2px solid #f59e0b;border-top:none;margin:-1px -1px 12px -1px;">';
                        html += '<div style="font-weight:700;font-size:14px;margin-bottom:8px;color:#d97706;">ğŸ” SYSTEM-ANALYSE (Admin-Sicht):</div>';
                        html += '<div style="font-size:11px;color:#92400e;margin-bottom:8px;">Warum der Termin nicht mÃ¶glich ist:</div>';
                        
                        // Problem-ErklÃ¤rung
                        html += '<div style="background:white;padding:8px;border-radius:6px;margin-bottom:8px;border:2px solid #f59e0b;">';
                        html += '<div style="font-weight:700;font-size:12px;color:#dc2626;margin-bottom:6px;">âš ï¸ KONFLIKT ERKANNT:</div>';
                        
                        // ğŸ†• v5.90.659: UNTERSCHIEDLICHE KONFLIKT-TYPEN!
                        if (distanceCheck.exactTimeConflict) {
                            html += `<div style="font-size:11px;"><strong>EXAKTE ZEIT-ÃœBERSCHNEIDUNG!</strong></div>`;
                            html += `<div style="font-size:11px;">Um ${time} Uhr ist bereits eine Fahrt gebucht.</div>`;
                        } else if (distanceCheck.duringRideConflict) {
                            html += `<div style="font-size:11px;"><strong>NEUE FAHRT WÃ„HREND BESTEHENDER FAHRT!</strong></div>`;
                            html += `<div style="font-size:11px;">Das Taxi ist um ${time} Uhr noch bei einer anderen Fahrt.</div>`;
                        } else {
                            html += `<div style="font-size:11px;">Taxi braucht <strong>${distanceCheck.travelTime} Min</strong> von letzter Fahrt,</div>`;
                            html += `<div style="font-size:11px;">hat aber nur <strong>${distanceCheck.availableTime} Min</strong> Zeit.</div>`;
                        }
                        
                        html += `<div style="font-size:13px;color:#dc2626;font-weight:700;margin-top:6px;">âŒ ${distanceCheck.exactTimeConflict || distanceCheck.duringRideConflict ? 'NICHT MÃ–GLICH!' : 'Fehlen: ' + Math.abs(distanceCheck.reserveMinutes) + ' Minuten'}</div>`;
                        html += '</div>';
                        
                        // Vorherige Fahrt
                        if (distanceCheck.previousRide) {
                            const prevTime = new Date(distanceCheck.previousRide.pickupTimestamp || distanceCheck.previousRide.pickupTime);
                            const customerName = distanceCheck.previousRide.customerName || distanceCheck.previousRide.name || 'Unbekannt';
                            const rideDuration = distanceCheck.previousRide.duration || 30;
                            
                            html += '<div style="background:white;padding:8px;border-radius:6px;margin-bottom:8px;border:1px solid #fde68a;">';
                            html += '<div style="font-weight:600;font-size:12px;margin-bottom:6px;">ğŸš– Letzte Fahrt (blockiert den Slot):</div>';
                            html += `<div style="font-size:11px;"><strong>Zeit:</strong> ${prevTime.toLocaleTimeString('de-DE', {hour:'2-digit',minute:'2-digit'})} Uhr</div>`;
                            html += `<div style="font-size:11px;"><strong>Kunde:</strong> ${customerName}</div>`;
                            html += `<div style="font-size:11px;"><strong>Von:</strong> ${distanceCheck.previousRide.pickup}</div>`;
                            html += `<div style="font-size:11px;"><strong>Nach:</strong> ${distanceCheck.previousRide.destination}</div>`;
                            
                            // ğŸ†• v5.90.657: AUFSCHLÃœSSELUNG DER DAUER!
                            html += '<div style="background:#fffbeb;padding:6px;border-radius:4px;margin-top:6px;border:1px solid #fde68a;">';
                            html += '<div style="font-size:11px;font-weight:600;margin-bottom:4px;">â±ï¸ Dauer-Berechnung:</div>';
                            html += `<div style="font-size:10px;">Fahrt: ${rideDuration} Min</div>`;
                            html += `<div style="font-size:10px;">+ Einsteigen: 2 Min</div>`;
                            html += `<div style="font-size:10px;">+ Aussteigen: 2 Min</div>`;
                            html += `<div style="font-size:11px;border-top:1px solid #fde68a;padding-top:4px;margin-top:4px;font-weight:600;">= Gesamt: ${rideDuration + 4} Min</div>`;
                            html += '</div>';
                            html += '</div>';
                            
                            // Warum es nicht geht
                            const totalDuration = rideDuration + 4;
                            const rideEnd = new Date(prevTime.getTime() + totalDuration * 60000);
                            const earliestAvailable = new Date(rideEnd.getTime() + distanceCheck.travelTime * 60000);
                            
                            html += '<div style="background:#fffbeb;padding:8px;border-radius:6px;margin-bottom:8px;border:1px solid #fde68a;">';
                            html += '<div style="font-weight:600;font-size:12px;margin-bottom:6px;">â° Zeitproblem:</div>';
                            html += `<div style="font-size:11px;">Letzte Fahrt fertig: <strong>${rideEnd.toLocaleTimeString('de-DE', {hour:'2-digit',minute:'2-digit'})} Uhr</strong></div>`;
                            html += `<div style="font-size:11px;">+ RÃ¼ckfahrt: <strong>${distanceCheck.travelTime} Min</strong></div>`;
                            html += `<div style="font-size:11px;border-top:1px solid #fde68a;padding-top:4px;margin-top:4px;">= FrÃ¼hestens verfÃ¼gbar: <strong>${earliestAvailable.toLocaleTimeString('de-DE', {hour:'2-digit',minute:'2-digit'})} Uhr</strong></div>`;
                            html += `<div style="font-size:11px;margin-top:8px;border-top:1px solid #fde68a;padding-top:8px;">GewÃ¼nschter Termin: <strong>${time} Uhr</strong></div>`;
                            html += `<div style="font-size:13px;color:#dc2626;font-weight:700;margin-top:4px;">âŒ ZU FRÃœH um ${Math.abs(distanceCheck.reserveMinutes)} Min!</div>`;
                            html += '</div>';
                        }
                        
                        html += '</div>';
                        
                        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                        // ğŸ‘¤ KUNDEN-BEREICH (BLAU)
                        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                        html += '<div style="background:#3b82f6;color:white;padding:12px;border-radius:8px 8px 0 0;text-align:center;font-weight:700;font-size:16px;margin-top:16px;">';
                        html += 'ğŸ‘¤ KUNDEN-SICHT';
                        html += '</div>';
                        
                        html += '<div style="background:#eff6ff;padding:12px;border:2px solid #3b82f6;border-top:none;border-radius:0 0 8px 8px;">';
                        html += '<div style="font-weight:700;font-size:14px;margin-bottom:8px;color:#1e40af;">Was der Kunde sieht:</div>';
                        
                        html += '<div style="background:white;padding:12px;border-radius:8px;border:2px solid #f59e0b;text-align:center;margin-bottom:12px;">';
                        html += '<div style="font-size:20px;margin-bottom:8px;">âŒ</div>';
                        html += '<div style="font-size:16px;font-weight:700;color:#f59e0b;margin-bottom:4px;">Termin nicht verfÃ¼gbar</div>';
                        html += `<div style="font-size:13px;color:#6b7280;">${time} Uhr ist bereits belegt</div>`;
                        html += '</div>';
                        
                        // Alternative Zeiten
                        if (distanceCheck.alternatives && distanceCheck.alternatives.length > 0) {
                            html += '<div style="background:white;padding:12px;border-radius:8px;border:1px solid #e5e7eb;">';
                            html += '<div style="font-weight:600;font-size:13px;margin-bottom:8px;color:#374151;">ğŸ’¡ NÃ¤chste freie Zeiten:</div>';
                            html += '<div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">';
                            distanceCheck.alternatives.forEach(alt => {
                                html += `<button onclick="selectAlternativeTime('${alt}')" style="padding:10px 16px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:13px;box-shadow:0 2px 4px rgba(16,185,129,0.3);">${alt} Uhr</button>`;
                            });
                            html += '</div>';
                            html += '</div>';
                        }
                        
                        html += '</div>';
                        
                        html += '</div>';
                        statusDisplay.innerHTML = html;
                        
                        console.log('âš ï¸ ZeitÃ¼berschneidung! VollstÃ¤ndige Analyse angezeigt.');
                        return;
                    } else if (distanceCheck.reserveMinutes !== null || distanceCheck.noPreviousRide) {
                        // âœ… PASST mit Reserve!
                        statusDisplay.style.display = 'block';
                        statusDisplay.style.background = 'linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%)';
                        statusDisplay.style.border = '2px solid #10b981';
                        statusDisplay.style.color = '#065f46';
                        
                        // ğŸ†• v5.90.656: ZWEIGETEILTE ANALYSE!
                        let html = '<div style="font-size:13px;line-height:1.6;">';
                        
                        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                        // ğŸ“Š ADMIN-BEREICH (GRÃœN)
                        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                        html += '<div style="background:#10b981;color:white;padding:12px;border-radius:8px 8px 0 0;text-align:center;font-weight:700;font-size:16px;margin:-1px -1px 0 -1px;">';
                        html += 'âœ… TERMIN VERFÃœGBAR';
                        html += '</div>';
                        
                        html += '<div style="background:#ecfdf5;padding:12px;border:2px solid #10b981;border-top:none;margin:-1px -1px 12px -1px;">';
                        html += '<div style="font-weight:700;font-size:14px;margin-bottom:8px;color:#059669;">ğŸ” SYSTEM-ANALYSE (Admin-Sicht):</div>';
                        html += '<div style="font-size:11px;color:#065f46;margin-bottom:8px;">Komplette Berechnung wie bei Routenplanung:</div>';
                        
                        // Datum Info
                        html += '<div style="background:white;padding:8px;border-radius:6px;margin-bottom:8px;border:1px solid #d1fae5;">';
                        html += `<div style="font-weight:600;font-size:12px;">ğŸ“… GewÃ¤hlter Termin:</div>`;
                        html += `<div style="font-size:11px;margin-top:4px;">${new Date(date).toLocaleDateString('de-DE', {weekday:'short',day:'2-digit',month:'2-digit',year:'numeric'})} um ${time} Uhr</div>`;
                        html += `<div style="font-size:11px;color:#059669;">Von: ${pickup}</div>`;
                        html += `<div style="font-size:11px;color:#059669;">Nach: ${destination}</div>`;
                        html += '</div>';
                        
                        // Bestehende Fahrten
                        if (distanceCheck.allRidesOnDay && distanceCheck.allRidesOnDay.length > 0) {
                            html += '<div style="background:white;padding:8px;border-radius:6px;margin-bottom:8px;border:1px solid #d1fae5;">';
                            html += '<div style="font-weight:600;font-size:12px;margin-bottom:6px;">ğŸ“‹ Bestehende Fahrten am Tag:</div>';
                            distanceCheck.allRidesOnDay.forEach((r, idx) => {
                                const rTime = new Date(r.pickupTimestamp || r.pickupTime);
                                const isRequested = rTime.getTime() === slotDateTime.getTime();
                                const customerName = r.customerName || r.name || 'Unbekannt';
                                html += `<div style="padding:6px;background:${isRequested ? '#d1fae5' : '#f9fafb'};border-radius:4px;margin:4px 0;${isRequested ? 'border:2px solid #10b981;' : 'border:1px solid #e5e7eb;'}font-size:11px;">`;
                                if (isRequested) {
                                    html += `<div style="font-weight:700;color:#10b981;">â†’ NEUE FAHRT (${time} Uhr)</div>`;
                                } else {
                                    html += `<div style="font-weight:600;">Fahrt #${idx + 1}: ${rTime.toLocaleTimeString('de-DE', {hour:'2-digit',minute:'2-digit'})} Uhr</div>`;
                                }
                                html += `<div style="color:#6b7280;">Kunde: ${customerName}</div>`;
                                html += `<div style="color:#6b7280;">Von: ${r.pickup}</div>`;
                                html += `<div style="color:#6b7280;">Nach: ${r.destination}</div>`;
                                if (r.duration) html += `<div style="color:#6b7280;">Dauer: ${r.duration} Min</div>`;
                                html += '</div>';
                            });
                            html += '</div>';
                        }
                        
                        // Vorherige Fahrt Details
                        if (distanceCheck.previousRide) {
                            const prevTime = new Date(distanceCheck.previousRide.pickupTimestamp || distanceCheck.previousRide.pickupTime);
                            const rideDuration = distanceCheck.previousRide.duration || 30;
                            
                            html += '<div style="background:white;padding:8px;border-radius:6px;margin-bottom:8px;border:1px solid #d1fae5;">';
                            html += '<div style="font-weight:600;font-size:12px;margin-bottom:6px;">ğŸš– Letzte Fahrt VOR neuem Termin:</div>';
                            html += `<div style="font-size:11px;"><strong>Zeit:</strong> ${prevTime.toLocaleTimeString('de-DE', {hour:'2-digit',minute:'2-digit'})} Uhr</div>`;
                            html += `<div style="font-size:11px;"><strong>Von:</strong> ${distanceCheck.previousRide.pickup}</div>`;
                            html += `<div style="font-size:11px;"><strong>Nach:</strong> ${distanceCheck.previousRide.destination}</div>`;
                            
                            // ğŸ†• v5.90.657: AUFSCHLÃœSSELUNG DER DAUER!
                            html += '<div style="background:#ecfdf5;padding:6px;border-radius:4px;margin-top:6px;border:1px solid #d1fae5;">';
                            html += '<div style="font-size:11px;font-weight:600;margin-bottom:4px;">â±ï¸ Dauer-Berechnung:</div>';
                            html += `<div style="font-size:10px;">Fahrt: ${rideDuration} Min</div>`;
                            html += `<div style="font-size:10px;">+ Einsteigen: 2 Min</div>`;
                            html += `<div style="font-size:10px;">+ Aussteigen: 2 Min</div>`;
                            html += `<div style="font-size:11px;border-top:1px solid #d1fae5;padding-top:4px;margin-top:4px;font-weight:600;">= Gesamt: ${rideDuration + 4} Min</div>`;
                            html += '</div>';
                            
                            html += `<div style="font-size:11px;color:#059669;margin-top:6px;"><strong>Ende:</strong> ${distanceCheck.previousEndTime ? new Date(distanceCheck.previousEndTime).toLocaleTimeString('de-DE', {hour:'2-digit',minute:'2-digit'}) : '?'} Uhr</div>`;
                            html += '</div>';
                            
                            // Distanz-Berechnung
                            html += '<div style="background:#fffbeb;padding:8px;border-radius:6px;margin-bottom:8px;border:1px solid #fde68a;">';
                            html += '<div style="font-weight:600;font-size:12px;margin-bottom:6px;">ğŸ—ºï¸ RÃ¼ckfahrt-Berechnung:</div>';
                            html += `<div style="font-size:11px;"><strong>Taxi steht:</strong> ${distanceCheck.previousDestination}</div>`;
                            html += `<div style="font-size:11px;"><strong>Muss hin:</strong> ${distanceCheck.newPickup}</div>`;
                            html += `<div style="font-size:11px;color:#d97706;"><strong>ğŸ“ Distanz:</strong> ${distanceCheck.routeDistance} km</div>`;
                            html += `<div style="font-size:11px;color:#d97706;"><strong>â±ï¸ Fahrzeit:</strong> ${distanceCheck.travelTime} Min</div>`;
                            html += '</div>';
                            
                            // Zeit-Berechnung
                            html += '<div style="background:white;padding:8px;border-radius:6px;margin-bottom:8px;border:1px solid #d1fae5;">';
                            html += '<div style="font-weight:600;font-size:12px;margin-bottom:6px;">â° Zeitberechnung:</div>';
                            html += `<div style="font-size:11px;">Letzte Fahrt fertig: <strong>${distanceCheck.previousEndTime ? new Date(distanceCheck.previousEndTime).toLocaleTimeString('de-DE', {hour:'2-digit',minute:'2-digit'}) : '?'} Uhr</strong></div>`;
                            html += `<div style="font-size:11px;">+ RÃ¼ckfahrt: <strong>${distanceCheck.travelTime} Min</strong></div>`;
                            html += `<div style="font-size:11px;border-top:1px solid #d1fae5;padding-top:4px;margin-top:4px;">= Taxi verfÃ¼gbar ab: <strong>${distanceCheck.previousEndTime ? new Date(new Date(distanceCheck.previousEndTime).getTime() + distanceCheck.travelTime * 60000).toLocaleTimeString('de-DE', {hour:'2-digit',minute:'2-digit'}) : '?'} Uhr</strong></div>`;
                            html += `<div style="font-size:11px;margin-top:8px;border-top:1px solid #d1fae5;padding-top:8px;">Neue Fahrt startet: <strong>${time} Uhr</strong></div>`;
                            html += `<div style="font-size:13px;color:#10b981;font-weight:700;margin-top:4px;">â³ Reserve: ${distanceCheck.reserveMinutes} Minuten âœ…</div>`;
                            html += '</div>';
                        } else {
                            html += '<div style="background:white;padding:8px;border-radius:6px;margin-bottom:8px;border:1px solid #d1fae5;">';
                            html += '<div style="font-weight:600;font-size:12px;color:#10b981;">âœ… Erste Fahrt des Tages!</div>';
                            html += '<div style="font-size:11px;margin-top:4px;color:#065f46;">Keine vorherigen Fahrten - Taxi ist verfÃ¼gbar.</div>';
                            html += '</div>';
                        }
                        
                        // NÃ¤chste Fahrt
                        if (distanceCheck.nextRide) {
                            const nextTime = new Date(distanceCheck.nextRide.pickupTimestamp || distanceCheck.nextRide.pickupTime);
                            const timeDiff = Math.floor((nextTime.getTime() - slotDateTime.getTime()) / 60000);
                            html += '<div style="background:white;padding:8px;border-radius:6px;border:1px solid #d1fae5;">';
                            html += '<div style="font-weight:600;font-size:12px;margin-bottom:6px;">ğŸš– NÃ¤chste Fahrt NACH neuem Termin:</div>';
                            html += `<div style="font-size:11px;"><strong>Zeit:</strong> ${nextTime.toLocaleTimeString('de-DE', {hour:'2-digit',minute:'2-digit'})} Uhr</div>`;
                            html += `<div style="font-size:11px;"><strong>Von:</strong> ${distanceCheck.nextRide.pickup}</div>`;
                            html += `<div style="font-size:11px;"><strong>Nach:</strong> ${distanceCheck.nextRide.destination}</div>`;
                            html += `<div style="font-size:11px;color:#10b981;font-weight:600;margin-top:4px;">â³ Zeit bis nÃ¤chste Fahrt: ${timeDiff} Min</div>`;
                            html += '</div>';
                        }
                        
                        html += '</div>';
                        
                        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                        // ğŸ‘¤ KUNDEN-BEREICH (BLAU)
                        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                        html += '<div style="background:#3b82f6;color:white;padding:12px;border-radius:8px 8px 0 0;text-align:center;font-weight:700;font-size:16px;margin-top:16px;">';
                        html += 'ğŸ‘¤ KUNDEN-SICHT';
                        html += '</div>';
                        
                        html += '<div style="background:#eff6ff;padding:12px;border:2px solid #3b82f6;border-top:none;border-radius:0 0 8px 8px;">';
                        html += '<div style="font-weight:700;font-size:14px;margin-bottom:8px;color:#1e40af;">Was der Kunde sieht:</div>';
                        
                        html += '<div style="background:white;padding:12px;border-radius:8px;border:2px solid #10b981;text-align:center;">';
                        html += '<div style="font-size:20px;margin-bottom:8px;">âœ…</div>';
                        html += '<div style="font-size:16px;font-weight:700;color:#10b981;margin-bottom:8px;">Termin verfÃ¼gbar!</div>';
                        html += `<div style="font-size:13px;color:#374151;margin-bottom:12px;">${new Date(date).toLocaleDateString('de-DE', {weekday:'long',day:'numeric',month:'long'})} um ${time} Uhr</div>`;
                        html += '<button style="background:#10b981;color:white;padding:12px 24px;border:none;border-radius:8px;font-weight:700;font-size:14px;cursor:pointer;">Jetzt buchen</button>';
                        html += '</div>';
                        
                        html += '</div>';
                        
                        html += '</div>';
                        statusDisplay.innerHTML = html;
                        
                        console.log('âœ… Slot ist frei! VollstÃ¤ndige Analyse angezeigt.');
                        return;
                    }
                }
                
                // Fallback: Alte Logik wenn keine Adressen
                const activeVehicles = Object.keys(VEHICLES).filter(id => VEHICLES[id].active !== false);
                const isFree = await isTimeSlotAvailable(slotDateTime, ridesData, activeVehicles);
                
                if (isFree) {
                    statusDisplay.style.display = 'block';
                    statusDisplay.style.background = '#d1fae5';
                    statusDisplay.style.border = '2px solid #10b981';
                    statusDisplay.style.color = '#065f46';
                    statusDisplay.innerHTML = `âœ… <strong>Termin verfÃ¼gbar</strong>`;
                    console.log('âœ… Slot ist frei!');
                } else {
                    const alternatives = await findAlternativeSlots(slotDateTime, ridesData, activeVehicles);
                    statusDisplay.style.display = 'block';
                    statusDisplay.style.background = '#fee2e2';
                    statusDisplay.style.border = '2px solid #ef4444';
                    statusDisplay.style.color = '#991b1b';
                    
                    let html = `âŒ <strong>Termin nicht verfÃ¼gbar</strong><br><br>`;
                    if (alternatives.length > 0) {
                        html += `ğŸ’¡ <strong>VerfÃ¼gbare Alternativen:</strong><br>`;
                        html += '<div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">';
                        alternatives.forEach(alt => {
                            html += `<button onclick="selectAlternativeTime('${alt}')" style="padding:8px 12px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;">${alt}</button>`;
                        });
                        html += '</div>';
                    }
                    statusDisplay.innerHTML = html;
                    console.log('ğŸ”´ Slot besetzt! Alternativen:', alternatives);
                }
            } catch (error) {
                console.error('âŒ Fehler beim Kalender-Check:', error);
                statusDisplay.style.display = 'block';
                statusDisplay.style.background = '#fef3c7';
                statusDisplay.style.border = '2px solid #f59e0b';
                statusDisplay.style.color = '#92400e';
                statusDisplay.innerHTML = 'âš ï¸ Kalender konnte nicht geprÃ¼ft werden.';
            }
        }
        
        // ğŸ†• v5.90.639: PRÃœFE DISTANZ/FAHRTZEIT ZWISCHEN TERMINEN!
        async function checkTravelTimeConflict(slotDateTime, pickup, destination, ridesData) {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸš— v5.90.642: DISTANZ-PRÃœFUNG FÃœR VORBESTELLUNG (DEBUG)');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ“¥ EINGABE:');
            console.log('   Datum/Zeit:', slotDateTime.toLocaleString('de-DE'));
            console.log('   Pickup:', pickup);
            console.log('   Destination:', destination);
            console.log('');
            
            // ğŸ†• v5.90.645: NUR Fahrten ab HEUTE prÃ¼fen!
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Mitternacht heute
            
            // Finde vorherige Fahrt (chronologisch vor dem neuen Slot)
            const allRides = Object.values(ridesData).filter(r => {
                // Status-Filter
                if (r.status === 'cancelled' || r.status === 'storniert' || 
                    r.status === 'completed' || r.status === 'abgeschlossen') {
                    return false;
                }
                
                // ğŸ†• v5.90.645: NUR ab heute!
                const rideDate = new Date(r.pickupTimestamp || r.pickupTime);
                if (rideDate < today) {
                    return false; // Vergangenheit ignorieren!
                }
                
                return true;
            });
            
            console.log('ğŸ“Š FIREBASE FAHRTEN:');
            console.log('   Gesamt (alle Status):', Object.keys(ridesData).length);
            console.log('   Nach Filter (aktive ab heute):', allRides.length);
            console.log('   ğŸš€ v5.90.645: Vergangenheit ignoriert!');
            console.log('');
            
            // Sortiere nach Zeit
            allRides.sort((a, b) => {
                const timeA = new Date(a.pickupTimestamp || a.pickupTime).getTime();
                const timeB = new Date(b.pickupTimestamp || b.pickupTime).getTime();
                return timeA - timeB;
            });
            
            // Zeige Fahrten fÃ¼r den gewÃ¤hlten Tag
            const slotDate = slotDateTime.toDateString();
            const ridesOnSameDay = allRides.filter(r => {
                const rideDate = new Date(r.pickupTimestamp || r.pickupTime).toDateString();
                return rideDate === slotDate;
            });
            
            console.log('ğŸ“… FAHRTEN AM GLEICHEN TAG (' + slotDate + '):');
            console.log('   Anzahl:', ridesOnSameDay.length);
            if (ridesOnSameDay.length > 0) {
                ridesOnSameDay.forEach((r, idx) => {
                    const rideTime = new Date(r.pickupTimestamp || r.pickupTime);
                    console.log(`   [${idx + 1}] ${rideTime.toLocaleTimeString('de-DE')} | ${r.pickup} â†’ ${r.destination} | Status: ${r.status}`);
                });
            } else {
                console.log('   âš ï¸ Keine Fahrten am gleichen Tag gefunden!');
            }
            console.log('');
            
            // Finde letzte Fahrt VOR dem neuen Slot (NUR am gleichen Tag!)
            let previousRide = null;
            const slotTime = slotDateTime.getTime();
            
            console.log('ğŸ” SUCHE VORHERIGE FAHRT:');
            console.log('   Slot-Zeit:', slotDateTime.toLocaleString('de-DE'));
            
            for (let i = allRides.length - 1; i >= 0; i--) {
                const ride = allRides[i];
                const rideDateTime = new Date(ride.pickupTimestamp || ride.pickupTime);
                const rideTime = rideDateTime.getTime();
                const rideDate = rideDateTime.toDateString();
                
                console.log(`   PrÃ¼fe: ${rideDateTime.toLocaleString('de-DE')} | Gleicher Tag: ${rideDate === slotDate} | Vor Slot: ${rideTime < slotTime}`);
                
                // ğŸ†• v5.90.642: NUR Fahrten vom GLEICHEN TAG!
                if (rideDate === slotDate && rideTime < slotTime) {
                    previousRide = ride;
                    console.log('   âœ… GEFUNDEN!');
                    break;
                }
            }
            console.log('');
            
            if (!previousRide) {
                console.log('âœ… ERGEBNIS: Keine vorherige Fahrt am gleichen Tag - Slot ist frei!');
                
                // ğŸ†• v5.90.659: PRÃœFE OB ZUR GLEICHEN ZEIT SCHON EINE FAHRT IST!
                let exactTimeConflict = null;
                for (let i = 0; i < allRides.length; i++) {
                    const ride = allRides[i];
                    const rideDateTime = new Date(ride.pickupTimestamp || ride.pickupTime);
                    const rideTime = rideDateTime.getTime();
                    const rideDate = rideDateTime.toDateString();
                    
                    // PrÃ¼fe ob zur EXAKT gleichen Zeit!
                    if (rideDate === slotDate && rideTime === slotTime) {
                        exactTimeConflict = ride;
                        console.log('ğŸš¨ v5.90.659: EXAKTE ZEIT-ÃœBERSCHNEIDUNG!', rideDateTime.toLocaleString('de-DE'));
                        break;
                    }
                }
                
                if (exactTimeConflict) {
                    console.log('âš ï¸ ERGEBNIS: SLOT IST BESETZT - Zur gleichen Zeit!');
                    
                    // Finde bessere Zeiten
                    const alternatives = [];
                    for (let offset = 30; offset <= 120; offset += 30) {
                        const testTime = new Date(slotTime + offset * 60000);
                        const testHour = String(testTime.getHours()).padStart(2, '0');
                        const testMin = String(testTime.getMinutes()).padStart(2, '0');
                        alternatives.push(`${testHour}:${testMin}`);
                        if (alternatives.length >= 4) break;
                    }
                    
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    return {
                        hasConflict: true,
                        exactTimeConflict: true,
                        conflictRide: exactTimeConflict,
                        travelTime: 0,
                        availableTime: 0,
                        reserveMinutes: 0,
                        previousRide: exactTimeConflict,
                        alternatives: alternatives,
                        allRidesOnDay: ridesOnSameDay
                    };
                }
                
                // ğŸ†• v5.90.654: Suche nÃ¤chste Fahrt NACH dem Slot
                let nextRide = null;
                for (let i = 0; i < allRides.length; i++) {
                    const ride = allRides[i];
                    const rideDateTime = new Date(ride.pickupTimestamp || ride.pickupTime);
                    const rideTime = rideDateTime.getTime();
                    const rideDate = rideDateTime.toDateString();
                    
                    if (rideDate === slotDate && rideTime > slotTime) {
                        nextRide = ride;
                        console.log('ğŸ“ NÃ„CHSTE FAHRT GEFUNDEN:', rideDateTime.toLocaleString('de-DE'));
                        break;
                    }
                }
                
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                return {
                    hasConflict: false,
                    reserveMinutes: null,
                    // ğŸ†• v5.90.654: Details fÃ¼r UI
                    noPreviousRide: true,
                    newPickup: pickup,
                    newDestination: destination,
                    nextRide: nextRide,
                    allRidesOnDay: ridesOnSameDay
                };
            }
            
            console.log('ğŸ“ VORHERIGE FAHRT GEFUNDEN:');
            console.log('   Zeit:', new Date(previousRide.pickupTimestamp || previousRide.pickupTime).toLocaleString('de-DE'));
            console.log('   Von:', previousRide.pickup);
            console.log('   Nach:', previousRide.destination);
            console.log('   Status:', previousRide.status);
            console.log('');
            
            // Berechne Ende der vorherigen Fahrt
            const previousStartTime = new Date(previousRide.pickupTimestamp || previousRide.pickupTime);
            const previousDuration = previousRide.duration || 30; // Fallback: 30 Min
            
            // ğŸ†• v5.90.657: EIN-/AUSSTIEGSZEIT EINBERECHNEN!
            const BOARDING_TIME = 2;  // 2 Min Einsteigen
            const ALIGHTING_TIME = 2; // 2 Min Aussteigen
            const totalDuration = previousDuration + BOARDING_TIME + ALIGHTING_TIME;
            
            const previousEndTime = new Date(previousStartTime.getTime() + totalDuration * 60000);
            
            console.log('â±ï¸ ZEITBERECHNUNG:');
            console.log('   Fahrt-Start:', previousStartTime.toLocaleString('de-DE'));
            console.log('   Fahrt-Dauer (rein):', previousDuration, 'Min');
            console.log('   ğŸšª v5.90.657: + Einsteigen:', BOARDING_TIME, 'Min');
            console.log('   ğŸšª v5.90.657: + Aussteigen:', ALIGHTING_TIME, 'Min');
            console.log('   â±ï¸ v5.90.657: GESAMT-DAUER:', totalDuration, 'Min');
            console.log('   Fahrt-Ende:', previousEndTime.toLocaleString('de-DE'));
            
            // ğŸ†• v5.90.659: PRÃœFE OB NEUE FAHRT WÃ„HREND VORHERIGER FAHRT LIEGT!
            if (slotTime >= previousStartTime.getTime() && slotTime < previousEndTime.getTime()) {
                console.log('ğŸš¨ v5.90.659: NEUE FAHRT LIEGT WÃ„HREND VORHERIGER FAHRT!');
                console.log('   Vorherige Fahrt:', previousStartTime.toLocaleTimeString('de-DE'), '-', previousEndTime.toLocaleTimeString('de-DE'));
                console.log('   Neue Fahrt:', slotDateTime.toLocaleTimeString('de-DE'));
                
                // Finde bessere Zeiten (nach Ende der vorherigen Fahrt)
                const alternatives = [];
                const earliestPossible = previousEndTime.getTime();
                for (let offset = 0; offset <= 60; offset += 15) {
                    const testTime = new Date(earliestPossible + offset * 60000);
                    const testHour = String(testTime.getHours()).padStart(2, '0');
                    const testMin = String(testTime.getMinutes()).padStart(2, '0');
                    alternatives.push(`${testHour}:${testMin}`);
                    if (alternatives.length >= 4) break;
                }
                
                console.log('   Bessere Zeiten:', alternatives.join(', '));
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
                return {
                    hasConflict: true,
                    duringRideConflict: true,
                    conflictRide: previousRide,
                    travelTime: 0,
                    availableTime: Math.floor((slotTime - previousEndTime.getTime()) / 60000),
                    reserveMinutes: Math.floor((slotTime - previousEndTime.getTime()) / 60000),
                    previousRide: previousRide,
                    previousEndTime: previousEndTime.getTime(),
                    alternatives: alternatives,
                    allRidesOnDay: ridesOnSameDay
                };
            }
            
            // VerfÃ¼gbare Zeit bis zum neuen Slot
            const availableTime = Math.floor((slotTime - previousEndTime.getTime()) / 60000);
            console.log('   Slot-Start:', slotDateTime.toLocaleString('de-DE'));
            console.log('   VerfÃ¼gbare Zeit:', availableTime, 'Min');
            console.log('');
            
            // Geocode Adressen
            try {
                console.log('ğŸ—ºï¸ GEOCODING:');
                console.log('   Ziel der vorherigen Fahrt:', previousRide.destination);
                const previousDestCoords = await geocodeAddress(previousRide.destination);
                console.log('   â†’ Koordinaten:', previousDestCoords);
                
                console.log('   Start der neuen Fahrt:', pickup);
                const newPickupCoords = await geocodeAddress(pickup);
                console.log('   â†’ Koordinaten:', newPickupCoords);
                console.log('');
                
                if (!previousDestCoords || !newPickupCoords) {
                    console.warn('âš ï¸ GEOCODING FEHLGESCHLAGEN - Fallback');
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    return {
                        hasConflict: false,
                        reserveMinutes: availableTime
                    };
                }
                
                // Berechne Route: Letztes Ziel â†’ Neuer Start
                console.log('ğŸš— ROUTE BERECHNUNG:');
                console.log('   Von:', previousRide.destination);
                console.log('   Nach:', pickup);
                const route = await calculateRoute(previousDestCoords, newPickupCoords);
                const travelTime = route.duration; // in Minuten
                
                console.log('   â†’ Distanz:', route.distance, 'km');
                console.log('   â†’ Fahrtzeit:', travelTime, 'Min');
                console.log('');
                
                const reserveMinutes = availableTime - travelTime;
                
                console.log('ğŸ“Š FINALE BERECHNUNG:');
                console.log('   VerfÃ¼gbare Zeit:', availableTime, 'Min');
                console.log('   - BenÃ¶tigte Fahrtzeit:', travelTime, 'Min');
                console.log('   = Reserve:', reserveMinutes, 'Min');
                console.log('');
                
                if (reserveMinutes < 0) {
                    // âš ï¸ KONFLIKT!
                    console.log('âš ï¸ ERGEBNIS: ZEITÃœBERSCHNEIDUNG!');
                    console.log('   Fahrzeug kommt', Math.abs(reserveMinutes), 'Min zu spÃ¤t!');
                    
                    // Finde bessere Zeiten
                    const alternatives = [];
                    for (let offset = 5; offset <= 60; offset += 5) {
                        const testTime = new Date(slotTime + offset * 60000);
                        const testHour = String(testTime.getHours()).padStart(2, '0');
                        const testMin = String(testTime.getMinutes()).padStart(2, '0');
                        alternatives.push(`${testHour}:${testMin}`);
                        if (alternatives.length >= 5) break;
                    }
                    console.log('   Bessere Zeiten:', alternatives.join(', '));
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    
                    return {
                        hasConflict: true,
                        travelTime: travelTime,
                        availableTime: availableTime,
                        reserveMinutes: reserveMinutes,
                        previousRide: previousRide,
                        alternatives: alternatives
                    };
                } else {
                    // âœ… PASST!
                    console.log('âœ… ERGEBNIS: SLOT IST VERFÃœGBAR!');
                    console.log('   Reserve:', reserveMinutes, 'Min');
                    
                    // ğŸ†• v5.90.654: Suche auch nÃ¤chste Fahrt NACH dem Slot!
                    let nextRide = null;
                    for (let i = 0; i < allRides.length; i++) {
                        const ride = allRides[i];
                        const rideDateTime = new Date(ride.pickupTimestamp || ride.pickupTime);
                        const rideTime = rideDateTime.getTime();
                        const rideDate = rideDateTime.toDateString();
                        
                        if (rideDate === slotDate && rideTime > slotTime) {
                            nextRide = ride;
                            console.log('ğŸ“ NÃ„CHSTE FAHRT GEFUNDEN:', rideDateTime.toLocaleString('de-DE'));
                            break;
                        }
                    }
                    
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    
                    return {
                        hasConflict: false,
                        reserveMinutes: reserveMinutes,
                        travelTime: travelTime,
                        availableTime: availableTime,
                        // ğŸ†• v5.90.654: Details fÃ¼r UI
                        previousRide: previousRide,
                        previousDestination: previousRide.destination,
                        previousEndTime: previousEndTime,
                        newPickup: pickup,
                        routeDistance: route.distance,
                        nextRide: nextRide,  // Kann null sein
                        allRidesOnDay: ridesOnSameDay
                    };
                }
                
            } catch (error) {
                console.error('âŒ FEHLER BEI DISTANZ-BERECHNUNG:', error);
                console.log('   Nutze Fallback: VerfÃ¼gbare Zeit =', availableTime, 'Min');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                return {
                    hasConflict: false,
                    reserveMinutes: availableTime
                };
            }
        }
        
        // ğŸ†• v5.90.638: PRÃœFE OB ZEITSLOT FREI IST (mit Auto-Assign Logik!)
        async function isTimeSlotAvailable(slotDateTime, ridesData, activeVehicles) {
            if (activeVehicles.length === 0) {
                console.log('âš ï¸ Keine aktiven Fahrzeuge definiert!');
                return false;  // Keine Fahrzeuge = nicht buchbar
            }
            
            // Hole ALLE Fahrten aus Firebase fÃ¼r bessere Ãœbersicht
            const allRidesSnapshot = await db.ref('rides').once('value');
            const allRides = allRidesSnapshot.val() || {};
            
            // ğŸ†• v5.90.645: Filter - nur ab heute!
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // FÃ¼r jedes Fahrzeug prÃ¼fen ob es zu dieser Zeit verfÃ¼gbar ist
            const availableVehicles = [];
            
            for (const vehicleId of activeVehicles) {
                // ğŸ¯ GLEICHE LOGIK WIE AUTO-ASSIGN!
                // PrÃ¼fe ob Fahrzeug bereits eine Fahrt hat zu dieser Zeit
                let hasConflict = false;
                
                Object.values(allRides).forEach(ride => {
                    // âœ… Ignoriere stornierte Fahrten
                    if (ride.status === 'cancelled' || ride.status === 'storniert') return;
                    
                    // âœ… NUR Fahrten fÃ¼r DIESES Fahrzeug prÃ¼fen
                    if (ride.vehicleId !== vehicleId && ride.assignedTo !== vehicleId) return;
                    
                    // âœ… Ignoriere Fahrten die bereits erledigt sind
                    if (ride.status === 'completed' || ride.status === 'abgeschlossen') return;
                    
                    const rideTime = new Date(ride.pickupTimestamp || ride.pickupTime);
                    if (isNaN(rideTime.getTime())) return;
                    
                    // ğŸ†• v5.90.645: Ignoriere Vergangenheit!
                    if (rideTime < today) return;
                    
                    // ğŸ¯ KONFLIKT-PRÃœFUNG WIE AUTO-ASSIGN:
                    // Fahrt lÃ¤uft wenn Status: assigned, accepted, oder picked_up
                    const isActiveRide = ['assigned', 'accepted', 'picked_up', 'new'].includes(ride.status);
                    
                    if (isActiveRide) {
                        // Fahrtdauer: 30 Min + 10 Min Puffer zwischen Fahrten
                        const rideDuration = (ride.duration || 30) * 60000;  // in ms
                        const buffer = 10 * 60000;  // 10 Min Puffer
                        const rideEndTime = new Date(rideTime.getTime() + rideDuration + buffer);
                        
                        // PrÃ¼fe ob Slot mit dieser Fahrt kollidiert
                        const slotEndTime = new Date(slotDateTime.getTime() + rideDuration + buffer);
                        
                        // Kollision wenn:
                        // - Neuer Slot startet wÃ¤hrend Fahrt lÃ¤uft
                        // - Neue Fahrt wÃ¼rde wÃ¤hrend Slot laufen
                        if ((slotDateTime >= rideTime && slotDateTime < rideEndTime) ||
                            (rideTime >= slotDateTime && rideTime < slotEndTime)) {
                            hasConflict = true;
                            console.log(`   ğŸ”´ ${vehicleId} besetzt: ${rideTime.toLocaleTimeString('de-DE')} - ${rideEndTime.toLocaleTimeString('de-DE')} (${ride.status})`);
                        }
                    }
                });
                
                if (!hasConflict) {
                    availableVehicles.push(vehicleId);
                    console.log(`   âœ… ${vehicleId} ist frei!`);
                }
            }
            
            console.log(`ğŸ“Š VerfÃ¼gbare Fahrzeuge: ${availableVehicles.length}/${activeVehicles.length}`);
            return availableVehicles.length > 0;
        }
        
        // ğŸ†• v5.90.637: FINDE ALTERNATIVE ZEITSLOTS (mit Firebase)
        async function findAlternativeSlots(originalTime, ridesData, activeVehicles) {
            const alternatives = [];
            
            // Suche Â±60 Minuten in 5-Min-Schritten
            for (let offset = -60; offset <= 60; offset += 5) {
                if (offset === 0) continue; // Original Zeit Ã¼berspringen
                
                const testTime = new Date(originalTime.getTime() + offset * 60000);
                
                // ğŸ†• v5.90.638: await weil isTimeSlotAvailable jetzt async ist
                const isAvailable = await isTimeSlotAvailable(testTime, ridesData, activeVehicles);
                
                if (isAvailable) {
                    const timeStr = `${String(testTime.getHours()).padStart(2, '0')}:${String(testTime.getMinutes()).padStart(2, '0')}`;
                    alternatives.push(timeStr);
                    
                    // Max 5 Alternativen
                    if (alternatives.length >= 5) break;
                }
            }
            
            return alternatives;
        }
        
        // ğŸ†• v5.90.123: WÃ„HLE ALTERNATIVE ZEIT
        function selectAlternativeTime(time) {
            const displayBtn = document.getElementById('time-display-btn');
            const hourInput = document.getElementById('custom-hour');
            const minuteInput = document.getElementById('custom-minute');
            const dateInput = document.getElementById('custom-date');
            
            const parts = time.split(':');
            hourInput.value = parts[0];
            minuteInput.value = parts[1];
            displayBtn.textContent = time;
            
            console.log('âœ… Alternative gewÃ¤hlt:', time);
            
            // Neu prÃ¼fen
            checkSlotAvailability(dateInput.value, time);
        }
        
        // ğŸ†• v5.90.322: PRÃœFE OB FAHRER ONLINE SIND
        async function checkOnlineDrivers() {
            try {
                const driversSnapshot = await db.ref('vehicles').once('value');
                const drivers = driversSnapshot.val() || {};
                
                const onlineDrivers = [];
                const now = Date.now();
                
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('ğŸ” v5.90.375: CHECK ONLINE DRIVERS');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
                Object.entries(drivers).forEach(([vehicleId, driver]) => {
                    const isOnline = driver.online === true;
                    const timestamp = driver.timestamp || driver.lastUpdate || 0;
                    const minutesSinceUpdate = (now - timestamp) / 60000;
                    
                    const vehicleName = VEHICLES[vehicleId]?.name || vehicleId;
                    
                    console.log(`ğŸš— ${vehicleName} (${vehicleId}):`);
                    console.log(`   online: ${isOnline ? 'âœ…' : 'ğŸ’¾'} ${isOnline}`);
                    console.log(`   timestamp: ${timestamp ? 'âœ…' : 'ğŸ’¾'} ${timestamp ? new Date(timestamp).toLocaleString('de-DE') : 'FEHLT'}`);
                    console.log(`   Alter: ${minutesSinceUpdate.toFixed(1)} Min`);
                    
                    // PrÃ¼fe alle 3 Bedingungen einzeln
                    if (!isOnline) {
                        console.log(`   ğŸ’¾ NICHT VERFÃœGBAR: online ist false`);
                    } else if (!timestamp) {
                        console.log(`   ğŸ’¾ NICHT VERFÃœGBAR: kein timestamp`);
                    } else if (minutesSinceUpdate >= 20) {
                        console.log(`   ğŸ’¾ NICHT VERFÃœGBAR: timestamp zu alt (>${20} Min)`);
                    } else {
                        console.log(`   âœ… VERFÃœGBAR!`);
                        onlineDrivers.push({
                            vehicleId,
                            name: vehicleName,
                            lastUpdate: minutesSinceUpdate
                        });
                    }
                    console.log('');
                });
                
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log(`âœ… ${onlineDrivers.length} verfÃ¼gbare Fahrzeuge`);
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
                return onlineDrivers;
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim PrÃ¼fen der Fahrer:', error);
                return [];
            }
        }

        // ğŸ†• v5.90.121: ZIFFERNBLOCK FÃœR TAXI BUCHEN TAB (DEAKTIVIERT in v5.90.122!)
        function openTimeKeypad() {
            const hourInput = document.getElementById('custom-hour');
            const minuteInput = document.getElementById('custom-minute');
            const btnDisplay = document.getElementById('time-keypad-btn');
            
            // Aktuelle Zeit holen
            const currentTime = btnDisplay.textContent.trim();
            
            console.log('âŒ¨ï¸ Ã–ffne Ziffernblock mit:', currentTime);
            
            // Ziffernblock Ã¶ffnen
            showTimeKeypad(currentTime, (newTime) => {
                console.log('âœ… Neue Zeit gewÃ¤hlt:', newTime);
                
                // Parse Zeit
                const parts = newTime.split(':');
                const hour = parts[0];
                const minute = parts[1];
                
                // Update Hidden Inputs
                hourInput.value = hour;
                minuteInput.value = minute;
                
                // Update Button Display
                btnDisplay.textContent = newTime;
                
                // ğŸ†• v5.90.121: Trigger Slot-Check!
                // Simuliere Change Event auf Hour Input
                const event = new Event('change', { bubbles: true });
                hourInput.dispatchEvent(event);
                
                console.log('ğŸ“± Hidden Inputs updated:', { hour, minute });
            });
        }

        // ğŸ†• v5.90.327: CRM UPDATE FUNKTION
        async function updateCustomerCRM(customerName, customerPhone, pickup, price) {
            try {
                console.log('ğŸ“‹ CRM: Update Kunde:', customerName, customerPhone);
                
                if (!customerPhone || !customerName) {
                    console.log('âš ï¸ CRM: Keine Kundendaten zum Speichern');
                    return;
                }
                
                // Normalisiere Telefonnummer
                const normalizedPhone = customerPhone.replace(/\s+/g, '');
                
                // Suche bestehenden Kunden
                const customersSnapshot = await db.ref('customers').once('value');
                const customers = customersSnapshot.val() || {};
                
                let customerId = null;
                let existingCustomer = null;
                
                // Finde Kunde anhand Telefonnummer
                Object.entries(customers).forEach(([id, customer]) => {
                    const customerNormalizedPhone = (customer.phone || '').replace(/\s+/g, '');
                    if (customerNormalizedPhone === normalizedPhone) {
                        customerId = id;
                        existingCustomer = customer;
                    }
                });
                
                if (existingCustomer) {
                    // Update bestehender Kunde
                    const updates = {
                        lastRide: Date.now(),
                        totalRides: (existingCustomer.totalRides || 0) + 1,
                        totalSpent: (existingCustomer.totalSpent || 0) + parseFloat(price || 0),
                        lastPickup: pickup
                    };
                    
                    await db.ref(`customers/${customerId}`).update(updates);
                    console.log('âœ… CRM: Kunde aktualisiert:', customerId);
                    
                } else {
                    // Neuer Kunde anlegen
                    const newCustomerRef = db.ref('customers').push();
                    customerId = newCustomerRef.key;
                    
                    const newCustomer = {
                        name: customerName,
                        phone: normalizedPhone,
                        createdAt: Date.now(),
                        firstRide: Date.now(),
                        lastRide: Date.now(),
                        totalRides: 1,
                        totalSpent: parseFloat(price || 0),
                        lastPickup: pickup,
                        isVIP: false,
                        notes: ''
                    };
                    
                    await newCustomerRef.set(newCustomer);
                    console.log('âœ… CRM: Neuer Kunde angelegt:', customerId);
                }
                
                return customerId;
                
            } catch (error) {
                console.error('ğŸ’¾ CRM: Fehler beim Update:', error);
                // Fehler nicht werfen - Buchung soll trotzdem durchgehen!
                return null;
            }
        }
        
        // ğŸ†• v5.90.526: ZEIGE ALLE FREIEN ZEITSLOTS IN MODAL!
        async function showFreeTimeSlots() {
            console.log('ğŸ“… v5.90.526: Zeige freie Zeitslots...');
            
            if (!pickupCoords || !destCoords) {
                alert('ğŸ’¾ Bitte erst Preis berechnen!');
                return;
            }
            
            // Loading-Anzeige
            const loadingModal = document.createElement('div');
            loadingModal.id = 'slots-loading';
            loadingModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            loadingModal.innerHTML = `
                <div style="background:white;padding:40px;border-radius:16px;text-align:center;">
                    <div style="font-size:48px;margin-bottom:20px;">ğŸ”</div>
                    <div style="font-size:20px;font-weight:600;color:#1f2937;">Suche freie Zeiten...</div>
                    <div style="margin-top:10px;color:#6b7280;">Berechne optimale Zeitfenster</div>
                </div>
            `;
            document.body.appendChild(loadingModal);
            
            // Datum aus Vorbestell-Feldern
            const dateVal = document.getElementById('custom-date')?.value;
            let targetDate = new Date();
            if (dateVal) {
                targetDate = new Date(dateVal);
            }
            
            // Berechne freie Slots
            const result = await findAvailableTimeSlots(pickupCoords, destCoords, targetDate);
            
            // Entferne Loading
            loadingModal.remove();
            
            if (result.freeSlots.length === 0) {
                alert('ğŸ’¾ Keine freien Zeiten gefunden!\n\nVersuche einen anderen Tag.');
                return;
            }
            
            // Zeige Modal mit allen Slots
            showTimeSlotsModal(result, targetDate);
        }
        
        // Modal mit allen Zeitslots
        function showTimeSlotsModal(result, date) {
            // Erstelle Modal
            const modal = document.createElement('div');
            modal.id = 'time-slots-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;
            
            const dateStr = date.toLocaleDateString('de-DE', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
            
            let slotsHtml = '';
            
            // ZEIGE ZEITFENSTER
            if (result.timeWindows.length > 0) {
                slotsHtml += `
                    <div style="background:#f0fdf4;padding:20px;border-radius:12px;margin-bottom:25px;border:2px solid #10b981;">
                        <div style="font-size:20px;font-weight:bold;color:#16a34a;margin-bottom:15px;">
                            âœ… ${result.timeWindows.length} freie Zeitfenster
                        </div>
                        <div style="display:grid;gap:12px;">
                `;
                
                result.timeWindows.forEach((window, idx) => {
                    const startTime = new Date(window.start).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    const endTime = new Date(window.end).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    
                    slotsHtml += `
                        <div style="background:white;padding:15px;border-radius:8px;border:2px solid #10b981;cursor:pointer;transition:all 0.2s;"
                             onmouseover="this.style.background='#d1fae5'"
                             onmouseout="this.style.background='white'"
                             onclick="selectTimeWindow(${window.start})">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <div>
                                    <div style="font-size:18px;font-weight:600;color:#1f2937;">
                                        ${startTime} - ${endTime}
                                    </div>
                                    <div style="font-size:13px;color:#6b7280;margin-top:3px;">
                                        ${window.duration} Minuten frei
                                    </div>
                                </div>
                                <div style="font-size:24px;color:#10b981;">
                                    âœ…
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                slotsHtml += `
                        </div>
                    </div>
                `;
            }
            
            // ZEIGE EINZELNE SLOTS
            const groupedSlots = {};
            result.allSlots.forEach(slot => {
                const hour = new Date(slot.timestamp).getHours();
                if (!groupedSlots[hour]) {
                    groupedSlots[hour] = [];
                }
                groupedSlots[hour].push(slot);
            });
            
            slotsHtml += `<div style="max-height:400px;overflow-y:auto;padding-right:10px;">`;
            
            Object.keys(groupedSlots).sort((a, b) => a - b).forEach(hour => {
                const slots = groupedSlots[hour];
                const freeCount = slots.filter(s => s.available).length;
                const totalCount = slots.length;
                
                if (freeCount > 0) {
                    slotsHtml += `
                        <div style="margin-bottom:20px;">
                            <div style="font-weight:600;color:#1f2937;margin-bottom:10px;font-size:16px;">
                                ${hour}:00 Uhr (${freeCount}/${totalCount} frei)
                            </div>
                            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;">
                    `;
                    
                    slots.forEach(slot => {
                        const time = new Date(slot.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                        
                        if (slot.available) {
                            slotsHtml += `
                                <div style="background:#10b981;color:white;padding:10px;border-radius:6px;text-align:center;cursor:pointer;font-weight:600;transition:all 0.2s;"
                                     onmouseover="this.style.background='#059669'"
                                     onmouseout="this.style.background='#10b981'"
                                     onclick="selectTimeSlot(${slot.timestamp})"
                                     title="Frei">
                                    ${time}
                                </div>
                            `;
                        } else {
                            slotsHtml += `
                                <div style="background:#e5e7eb;color:#9ca3af;padding:10px;border-radius:6px;text-align:center;font-weight:600;cursor:not-allowed;"
                                     title="${slot.reason || 'Belegt'}">
                                    ${time}
                                </div>
                            `;
                        }
                    });
                    
                    slotsHtml += `
                            </div>
                        </div>
                    `;
                }
            });
            
            slotsHtml += `</div>`;
            
            modal.innerHTML = `
                <div style="background:white;border-radius:16px;max-width:800px;width:100%;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;">
                    <div style="padding:25px;border-bottom:2px solid #e5e7eb;background:linear-gradient(135deg,#667eea,#764ba2);color:white;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <div style="font-size:24px;font-weight:bold;">ğŸ“… Freie Zeiten</div>
                                <div style="margin-top:5px;opacity:0.9;">${dateStr}</div>
                            </div>
                            <button onclick="document.getElementById('time-slots-modal').remove()" 
                                    style="background:rgba(255,255,255,0.2);border:none;color:white;font-size:28px;cursor:pointer;width:40px;height:40px;border-radius:50%;line-height:1;">Ã—</button>
                        </div>
                    </div>
                    
                    <div style="padding:25px;overflow-y:auto;flex:1;">
                        <div style="background:#fef3c7;padding:15px;border-radius:8px;margin-bottom:20px;border:1px solid #fbbf24;">
                            <div style="font-size:14px;color:#92400e;">
                                â±ï¸ <strong>Fahrtdauer:</strong> ${result.newRideDuration} Minuten<br>
                                âœ… <strong>Freie Slots:</strong> ${result.freeSlots.length}<br>
                                ğŸ’¾ <strong>Blockiert:</strong> ${result.blockedSlots.length}
                            </div>
                        </div>
                        
                        ${slotsHtml}
                    </div>
                    
                    <div style="padding:20px;border-top:2px solid #e5e7eb;background:#f9fafb;">
                        <button onclick="document.getElementById('time-slots-modal').remove()" 
                                style="width:100%;padding:15px;background:#e5e7eb;border:none;border-radius:8px;font-weight:600;cursor:pointer;color:#1f2937;">
                            SchlieÃŸen
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Zeitfenster gewÃ¤hlt
        function selectTimeWindow(timestamp) {
            selectTimeSlot(timestamp);
        }
        
        // Einzelner Slot gewÃ¤hlt
        function selectTimeSlot(timestamp) {
            const time = new Date(timestamp);
            
            // Setze Datum + Uhrzeit in Feldern
            const dateStr = time.toISOString().split('T')[0];
            const hours = String(time.getHours()).padStart(2, '0');
            const minutes = String(time.getMinutes()).padStart(2, '0');
            
            document.getElementById('custom-date').value = dateStr;
            document.getElementById('custom-hour').value = hours;
            document.getElementById('custom-minute').value = minutes;
            
            // SchlieÃŸe Modal
            document.getElementById('time-slots-modal').remove();
            
            // Zeige BestÃ¤tigung
            const timeStr = time.toLocaleString('de-DE', { 
                weekday: 'short',
                day: '2-digit', 
                month: '2-digit',
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            alert(`âœ… Zeit gewÃ¤hlt!\n\n${timeStr}\n\nJetzt kannst du buchen!`);
        }
        
        // ğŸ†• v5.90.527: WAYPOINTS SYSTEM
        
        // FÃ¼gt einen Zwischenstopp hinzu
        function addWaypoint() {
            const id = ++waypointCounter;
            const autocompleteId = `waypoint-${id}-input`;
            const dropdownId = `waypoint-${id}-dropdown`;
            const containerId = `waypoint-${id}-container`;
            
            const waypoint = {
                id: id,
                address: '',
                coords: null,
                autocompleteId: autocompleteId,
                dropdownId: dropdownId,
                containerId: containerId
            };
            
            waypoints.push(waypoint);
            
            console.log('â• v5.90.527: Zwischenstopp hinzugefÃ¼gt:', id);
            
            renderWaypoints();
            
            // Fokussiere neues Feld
            setTimeout(() => {
                const input = document.getElementById(autocompleteId);
                if (input) input.focus();
            }, 100);
        }
        
        // Entfernt einen Zwischenstopp
        function removeWaypoint(id) {
            console.log('â– v5.90.527: Entferne Zwischenstopp:', id);
            
            waypoints = waypoints.filter(w => w.id !== id);
            renderWaypoints();
            
            // Preis neu berechnen wenn schon berechnet
            if (priceCalculated) {
                calculatePriceAndShow();
            }
        }
        
        // Rendert alle Zwischenstopps
        function renderWaypoints() {
            const container = document.getElementById('waypoints-container');
            if (!container) return;
            
            if (waypoints.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            
            waypoints.forEach((wp, index) => {
                html += `
                    <div id="${wp.containerId}" class="input-group" style="margin-bottom:15px;">
                        <label>ğŸ›‘ Zwischenstopp ${index + 1}</label>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <div style="flex:1;position:relative;">
                                <input 
                                    type="text" 
                                    id="${wp.autocompleteId}" 
                                    placeholder="z.B. Sparkasse SeestraÃŸe"
                                    value="${wp.address}"
                                    oninput="handleWaypointInput(${wp.id}); toggleClearButton('${wp.autocompleteId}')"
                                    style="width:100%;padding:12px;padding-right:40px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;">
                                <button id="clear-${wp.autocompleteId}-btn" onclick="clearField('${wp.autocompleteId}')" style="display:none;position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:#6b7280;font-size:18px;padding:4px;line-height:1;" title="LÃ¶schen">
                                    âœ•
                                </button>
                            </div>
                            <button 
                                onclick="saveLocationPOI('${wp.autocompleteId}')" 
                                style="padding:12px 14px;border:2px solid #f59e0b;background:#fef3c7;color:#92400e;border-radius:8px;font-weight:600;cursor:pointer;font-size:16px;" 
                                title="Ort speichern">
                                â­
                            </button>
                            <button 
                                onclick="removeWaypoint(${wp.id})" 
                                style="padding:12px 14px;border:2px solid #ef4444;background:#fee2e2;color:#991b1b;border-radius:8px;font-weight:600;cursor:pointer;font-size:16px;" 
                                title="Zwischenstopp entfernen">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                        <div class="autocomplete-dropdown" id="${wp.dropdownId}"></div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Initialisiere Autocomplete fÃ¼r alle Waypoints
            waypoints.forEach(wp => {
                initializeAutocomplete(wp.autocompleteId, wp.dropdownId, (address, coords) => {
                    // Update waypoint
                    const waypoint = waypoints.find(w => w.id === wp.id);
                    if (waypoint) {
                        waypoint.address = address;
                        waypoint.coords = coords;
                        console.log(`âœ… Zwischenstopp ${wp.id} aktualisiert:`, address, coords);
                        
                        // Preis neu berechnen wenn schon berechnet
                        if (priceCalculated) {
                            calculatePriceAndShow();
                        }
                    }
                });
            });
        }
        
        // Handle Waypoint Input
        function handleWaypointInput(id) {
            const waypoint = waypoints.find(w => w.id === id);
            if (!waypoint) return;
            
            const input = document.getElementById(waypoint.autocompleteId);
            if (input) {
                waypoint.address = input.value;
            }
        }
        
        // Initialisiert Autocomplete fÃ¼r ein Feld
        function initializeAutocomplete(inputId, dropdownId, onSelect) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            
            if (!input || !dropdown) return;
            
            // Event Listener fÃ¼r Input
            input.addEventListener('input', async () => {
                const query = input.value.trim();
                
                if (query.length < 3) {
                    dropdown.innerHTML = '';
                    dropdown.style.display = 'none';
                    return;
                }
                
                // Nominatim Suche MIT FILTER (wie Hauptbuchung!)
                try {
                    await new Promise(resolve => setTimeout(resolve, 300)); // Debounce
                    
                    // ğŸ†• v5.90.559: GLEICHER FILTER WIE BEI ABHOLUNG/ZIEL!
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=de&viewbox=10.6,54.7,14.4,53.1&bounded=1&limit=10&addressdetails=1`
                    );
                    const results = await response.json();
                    
                    if (results.length === 0) {
                        dropdown.innerHTML = '<div style="padding:10px;color:#666;">Keine Ergebnisse in der Region</div>';
                        dropdown.style.display = 'block';
                        return;
                    }
                    
                    dropdown.innerHTML = results.map(r => `
                        <div class="autocomplete-item" onclick="selectAutocompleteResult('${inputId}', '${dropdownId}', '${r.display_name.replace(/'/g, "\\'")}', ${r.lat}, ${r.lon})">
                            ğŸ“ ${r.display_name}
                        </div>
                    `).join('');
                    dropdown.style.display = 'block';
                    
                } catch (error) {
                    console.error('Autocomplete Fehler:', error);
                }
            });
            
            // SchlieÃŸe Dropdown wenn auÃŸerhalb geklickt
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }
        
        // Autocomplete-Ergebnis auswÃ¤hlen
        function selectAutocompleteResult(inputId, dropdownId, address, lat, lon) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            
            if (input) {
                input.value = address;
            }
            
            if (dropdown) {
                dropdown.style.display = 'none';
            }
            
            // Callback fÃ¼r Waypoint
            const waypoint = waypoints.find(w => w.autocompleteId === inputId);
            if (waypoint) {
                waypoint.address = address;
                waypoint.coords = { lat: parseFloat(lat), lon: parseFloat(lon) };
                console.log(`âœ… Zwischenstopp ${waypoint.id} gewÃ¤hlt:`, address);
                
                // Preis neu berechnen
                if (priceCalculated) {
                    calculatePriceAndShow();
                }
            }
        }
        
        // ğŸ†• v5.90.559: QUICK-BOOKING WAYPOINTS SYSTEM
        
        function addQuickBookingWaypoint() {
            const id = ++qbWaypointCounter;
            const autocompleteId = `qb-waypoint-${id}-input`;
            const dropdownId = `qb-waypoint-${id}-dropdown`;
            const containerId = `qb-waypoint-${id}-container`;
            
            const waypoint = {
                id: id,
                address: '',
                coords: null,
                autocompleteId: autocompleteId,
                dropdownId: dropdownId,
                containerId: containerId
            };
            
            qbWaypoints.push(waypoint);
            console.log('â• Quick-Booking Zwischenstopp hinzugefÃ¼gt:', id);
            
            renderQuickBookingWaypoints();
            
            // Fokussiere neues Feld
            setTimeout(() => {
                const input = document.getElementById(autocompleteId);
                if (input) input.focus();
            }, 100);
        }
        
        function removeQuickBookingWaypoint(id) {
            console.log('â– Entferne Quick-Booking Zwischenstopp:', id);
            qbWaypoints = qbWaypoints.filter(w => w.id !== id);
            renderQuickBookingWaypoints();
        }
        
        function renderQuickBookingWaypoints() {
            const container = document.getElementById('quick-booking-waypoints-container');
            if (!container) return;
            
            if (qbWaypoints.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            
            qbWaypoints.forEach((wp, index) => {
                html += `
                    <div id="${wp.containerId}" style="margin-bottom:12px;position:relative;">
                        <label style="display:block;font-weight:600;margin-bottom:8px;color:#1f2937;font-size:14px;">ğŸ›‘ Zwischenstopp ${index + 1}</label>
                        <div style="display:flex;gap:6px;align-items:center;">
                            <input 
                                type="text" 
                                id="${wp.autocompleteId}" 
                                placeholder="z.B. Sparkasse SeestraÃŸe"
                                value="${wp.address}"
                                style="flex:1;padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:13px;">
                            <button 
                                onclick="removeQuickBookingWaypoint(${wp.id})" 
                                style="padding:10px 12px;border:2px solid #ef4444;background:#fee2e2;color:#991b1b;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;" 
                                title="Zwischenstopp entfernen">
                                âŒ
                            </button>
                        </div>
                        <div class="autocomplete-dropdown" id="${wp.dropdownId}" style="display:none;position:absolute;top:100%;left:0;right:0;background:white;border:2px solid #e5e7eb;border-radius:8px;max-height:200px;overflow-y:auto;z-index:1001;margin-top:4px;box-shadow:0 4px 12px rgba(0,0,0,0.1);"></div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Initialisiere Autocomplete fÃ¼r alle Waypoints
            qbWaypoints.forEach(wp => {
                initializeQuickBookingWaypointAutocomplete(wp);
            });
        }
        
        function initializeQuickBookingWaypointAutocomplete(waypoint) {
            const input = document.getElementById(waypoint.autocompleteId);
            const dropdown = document.getElementById(waypoint.dropdownId);
            
            if (!input || !dropdown) {
                console.error('QB Waypoint Input/Dropdown nicht gefunden:', waypoint.autocompleteId);
                return;
            }
            
            let debounceTimeout = null;
            
            input.addEventListener('input', async () => {
                const query = input.value.trim();
                
                // Update waypoint address
                waypoint.address = query;
                
                if (query.length < 3) {
                    dropdown.innerHTML = '';
                    dropdown.style.display = 'none';
                    return;
                }
                
                // Debounce
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(async () => {
                    try {
                        // ğŸ†• v5.90.559: GLEICHER FILTER WIE HAUPTBUCHUNG!
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=de&viewbox=10.6,54.7,14.4,53.1&bounded=1&limit=10&addressdetails=1`
                        );
                        const results = await response.json();
                        
                        if (results.length === 0) {
                            dropdown.innerHTML = '<div style="padding:10px;color:#666;font-size:12px;">Keine Ergebnisse in der Region</div>';
                            dropdown.style.display = 'block';
                            return;
                        }
                        
                        dropdown.innerHTML = results.map(r => `
                            <div class="autocomplete-item" style="padding:10px;cursor:pointer;border-bottom:1px solid #e5e7eb;font-size:12px;" onclick="selectQuickBookingWaypointResult('${waypoint.autocompleteId}', '${waypoint.dropdownId}', ${waypoint.id}, '${r.display_name.replace(/'/g, "\\'")}', ${r.lat}, ${r.lon})">
                                ğŸ“ ${r.display_name}
                            </div>
                        `).join('');
                        dropdown.style.display = 'block';
                        
                    } catch (error) {
                        console.error('QB Waypoint Autocomplete Fehler:', error);
                    }
                }, 300);
            });
            
            // Focus zeigt leeres Dropdown mit Hint
            input.addEventListener('focus', () => {
                if (!input.value.trim()) {
                    dropdown.innerHTML = '<div style="padding:10px;color:#999;font-size:12px;">Mindestens 3 Zeichen eingeben...</div>';
                    dropdown.style.display = 'block';
                }
            });
            
            // SchlieÃŸe Dropdown beim Klick auÃŸerhalb
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }
        
        function selectQuickBookingWaypointResult(inputId, dropdownId, waypointId, address, lat, lon) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            
            if (input) {
                input.value = address;
            }
            
            if (dropdown) {
                dropdown.style.display = 'none';
            }
            
            // Update waypoint
            const waypoint = qbWaypoints.find(w => w.id === waypointId);
            if (waypoint) {
                waypoint.address = address;
                waypoint.coords = { lat: parseFloat(lat), lon: parseFloat(lon) };
                console.log(`âœ… QB Zwischenstopp ${waypointId} gewÃ¤hlt:`, address);
            }
        }
        
        async function book() {
            // âœ… BUGFIX v5.9.3: Version-Check entfernt!
            // Der alte Check rief nicht-existierende Funktionen auf und blockierte ALLE Buchungen!
            
            // ğŸ†• v5.66.0: Hole Name + Telefon aus localStorage (nach Phone-Auth)
            // ğŸ†• v5.87.97: AUCH aus Eingabefeld holen (fÃ¼r Stammkunden!)
            const customerName = localStorage.getItem('loggedInUserName') || document.getElementById('customer-name')?.value || '';
            const customerPhone = localStorage.getItem('loggedInPhone') || document.getElementById('customer-phone')?.value || '';
            
            console.log('ğŸ“± customerPhone:', customerPhone, '(localStorage:', localStorage.getItem('loggedInPhone'), ', Eingabefeld:', document.getElementById('customer-phone')?.value, ')');
            
            if (!customerName) {
                alert('ğŸ’¾ Bitte erst anmelden!\n\nDu musst dich mit deiner Telefonnummer verifizieren.');
                return;
            }
            
            if (!customerPhone) {
                alert('ğŸ’¾ Bitte erst anmelden!\n\nDu musst dich mit deiner Telefonnummer verifizieren.');
                return;
            }
            
            // ğŸ†• v5.30.0: Nutze currentRideType statt pickup-time Select
            let pickupTime = 'Sofort';
            let pickupTimestamp = Date.now() + 5 * 60000; // +5 Min Vorlauf
            let rideStatus = 'new';
            const now = new Date();
            
            // ğŸ†• v5.90.322: SOFORT-BUCHUNG WIEDER AKTIVIERT!
            if (currentRideType === 'sofort' || !currentRideType) {
                // PrÃ¼fe ob Fahrer online sind
                const onlineDrivers = await checkOnlineDrivers();
                
                if (onlineDrivers.length === 0) {
                    alert(
                        'â° Aktuell kein Taxi verfÃ¼gbar!\n\n' +
                        'Bitte Vorbestellung nutzen oder anrufen:\n' +
                        'ğŸ’¾ 03837822022'
                    );
                    return;
                }
                
                // SOFORT-Buchung OK!
                pickupTime = 'Sofort';
                pickupTimestamp = Date.now() + 5 * 60000; // +5 Min Puffer
                rideStatus = 'new';
            }
            
            if (currentRideType === 'vorbestellen') {
                // ğŸ“… VORBESTELL-Buchung - Datum & Zeit direkt aus Feldern
                const dateVal = document.getElementById('custom-date').value;
                const hourVal = document.getElementById('custom-hour').value;
                const minuteVal = document.getElementById('custom-minute').value;
                
                if (!dateVal) {
                    alert('ğŸ’¾ Bitte Datum auswÃ¤hlen!');
                    return;
                }
                
                // ğŸ”§ BUGFIX v5.39.1: Korrekte lokale Zeit ohne UTC-Parsing!
                // VORHER: new Date(`${dateVal}T${hourVal}:${minuteVal}:00`) -> UTC Problem!
                // NACHHER: Date-Konstruktor mit Einzelwerten -> garantiert lokal!
                const dateParts = dateVal.split('-');
                const selectedDate = new Date(
                    parseInt(dateParts[0]),           // Jahr
                    parseInt(dateParts[1]) - 1,       // Monat (0-11!)
                    parseInt(dateParts[2]),           // Tag
                    parseInt(hourVal),                 // Stunde
                    parseInt(minuteVal),               // Minute
                    0,                                 // Sekunde
                    0                                  // Millisekunde
                );
                
                pickupTimestamp = selectedDate.getTime();
                
                // ğŸ†• v5.90.323: VORBESTELLUNG BRAUCHT MINDESTENS 1 STUNDE VORLAUF!
                const nowTime = Date.now();
                const minTime = nowTime + (60 * 60 * 1000); // +1 Stunde
                
                if (pickupTimestamp < minTime) {
                    const minDate = new Date(minTime);
                    const minTimeStr = minDate.toLocaleString('de-DE', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    alert(
                        'â° Vorbestellung braucht mindestens 1 Stunde Vorlauf!\n\n' +
                        `FrÃ¼heste mÃ¶gliche Zeit: ${minTimeStr}\n\n` +
                        'ğŸ’¡ FÃ¼r sofortige Fahrten nutze "SOFORT"'
                    );
                    return;
                }
                
                // ğŸ› DEBUG: Zeige was gespeichert wird
                console.log('ğŸ“… VORBESTELLUNG - Eingabe:', {
                    datum: dateVal,
                    stunde: hourVal,
                    minute: minuteVal
                });
                console.log('ğŸ“… VORBESTELLUNG - Gespeichert:', {
                    selectedDate: selectedDate.toLocaleString('de-DE'),
                    pickupTimestamp: pickupTimestamp,
                    ISO: selectedDate.toISOString()
                });
                
                // Formatiere als "22.11.2024, 08:00"
                pickupTime = selectedDate.toLocaleString('de-DE', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                // ğŸ†• v5.90.154: PrÃ¼fe ob in der Vergangenheit - ADMINS ERLAUBT!
                if (pickupTimestamp < Date.now()) {
                    // PrÃ¼fe ob User Admin ist
                    const isAdmin = currentUser && (currentUser.email === 'patrick061977@gmail.com' || currentUser.email === 'admin@taxi-heringsdorf.de');
                    
                    if (!isAdmin) {
                        alert('ğŸ’¾ Die Abholzeit liegt in der Vergangenheit!\n\nBitte wÃ¤hle eine Zeit in der Zukunft.');
                        return;
                    } else {
                        console.log('âœ… Admin erstellt Fahrt in Vergangenheit (fÃ¼r Rechnung)');
                    }
                }
                
                // Warnung wenn sehr weit in der Zukunft (mehr als 7 Tage)
                const daysDiff = (pickupTimestamp - Date.now()) / (1000 * 60 * 60 * 24);
                if (daysDiff > 7) {
                    const confirm = window.confirm(
                        `ğŸ“… Buchung fÃ¼r ${Math.floor(daysDiff)} Tage im Voraus\n\n` +
                        `Abholung: ${pickupTime}\n\n` +
                        `MÃ¶chtest du diese Vorausbuchung bestÃ¤tigen?`
                    );
                    if (!confirm) return;
                }
                
                // ğŸ• Berechne Zeitdifferenz fÃ¼r Vorbestellungs-Logik
                const minutesUntilPickup = (pickupTimestamp - Date.now()) / (1000 * 60);
                
                // âš¡ Sofort (â‰¤15 Min) vs ğŸ“… Vorbestellung (>15 Min)
                rideStatus = minutesUntilPickup <= 15 ? 'new' : 'vorbestellt';
            }
            
            // ğŸ• Berechne Zeitdifferenz fÃ¼r Vorbestellungs-Logik
            const minutesUntilPickup = (pickupTimestamp - Date.now()) / (1000 * 60);
            
            // ğŸ†• v5.31.0: Generiere EINDEUTIGE RIDE-ID
            const rideId = generateRideId();
            
            const ride = {
                id: rideId,  // â† EINDEUTIGE UUID!
                customerName,
                customerPhone,
                pickupTime,
                pickupTimestamp,
                pickup: document.getElementById('pickup').value,
                destination: document.getElementById('destination').value,
                passengers: document.getElementById('passengers').value,
                price: window.fiftyFiftyActive ? window.fiftyFiftyPrice : window.currentPrice,
                originalPrice: window.fiftyFiftyActive ? window.currentPrice : null, // ğŸ†• v5.88.0: Originalpreis fÃ¼r 50/50
                distance: window.currentDistance,
                duration: window.currentDuration,
                totalDuration: window.currentTotalDuration || window.currentDuration, // ğŸ†• v5.90.528: Mit Puffern!
                // ğŸ†• v5.41.5: Koordinaten sicher speichern (nur wenn vorhanden)
                pickupCoords: pickupCoords ? { lat: pickupCoords.lat, lon: pickupCoords.lon } : null,
                destCoords: destCoords ? { lat: destCoords.lat, lon: destCoords.lon } : null,
                // ğŸ†• v5.90.527: WAYPOINTS!
                waypoints: waypoints.filter(wp => wp.coords).map(wp => ({
                    address: wp.address,
                    coords: { lat: wp.coords.lat, lon: wp.coords.lon }
                })),
                status: rideStatus,
                time: new Date().toLocaleString('de-DE'),
                createdAt: Date.now(),
                paymentMethod: document.getElementById('payment-method').value, // ğŸ’³ Zahlungsmethode
                bookingSource: currentRideType || 'sofort', // ğŸ†• v5.48.1: 'sofort' oder 'vorbestellen'!
                // ğŸ†• v5.88.0: 50/50 Ticket Daten
                fiftyFifty: window.fiftyFiftyActive ? {
                    enabled: true,
                    birthdate: document.getElementById('fifty-fifty-birthdate')?.value || null,
                    originalPrice: window.currentPrice,
                    discountedPrice: window.fiftyFiftyPrice,
                    landMVAnteil: window.fiftyFiftyPrice // Das was vom Land erstattet wird
                } : null
            };
            
            console.log('ğŸ“ Ride-Objekt erstellt:', {
                id: ride.id,
                customerName: ride.customerName,
                customerPhone: ride.customerPhone,
                status: ride.status,
                pickupTimestamp: ride.pickupTimestamp,
                hasPickupCoords: !!ride.pickupCoords,
                hasDestCoords: !!ride.destCoords
            });
            
            // ğŸ†• v5.41.4: SLOT-CHECK mit VOLLEN Daten! (HIER hat ride ALLE Felder!)
            // PrÃ¼fe Zeitslot bei Vorbestellungen mit ALLEN Buchungsdaten
            if (autoBookingEnabled && ride.status === 'vorbestellt' && isFirebaseReady) {
                console.log('ğŸ¤– Finale Buchung: PrÃ¼fe Zeitslot mit vollen Daten...');
                
                const availability = await checkTimeSlotAvailability(ride.pickupTimestamp, pickupCoords);
                
                if (!availability.available) {
                    console.log('âš ï¸ Zeitslot belegt! Berechne Alternativen...');
                    
                    // Berechne alternative Zeiten
                    const alternatives = await calculateAlternativeTimes(
                        availability.conflictingRide,
                        pickupCoords,
                        ride.pickupTimestamp
                    );
                    
                    // Speichere VOLLSTÃ„NDIGE Buchungsdaten!
                    currentBookingData = ride;
                    
                    // Zeige Modal mit VorschlÃ¤gen
                    showAlternativeTimesModal(ride.pickupTimestamp, alternatives, ride);
                    
                    // Abbruch! User muss Alternative wÃ¤hlen
                    return;
                }
                
                console.log('âœ… Zeitslot verfÃ¼gbar, fahre mit Buchung fort');
            }
            
            const savedRide = await saveRide(ride);
            myCurrentRide = savedRide;
            localStorage.setItem('myCurrentRideId', savedRide.firebaseId);
            
            // ğŸ“œ PROTOKOLL: Fahrt gebucht (mit allen Details!)
            const bookingType = savedRide.status === 'vorbestellt' ? 'Vorbestellung' : 'Sofort-Fahrt';
            const pickupDisplay = pickupTime ? pickupTime : 'Sofort';
            logActivity('booking', 'created', 
                `Neue Buchung: ${bookingType} ğŸ’¾${customerName} ğŸ“${ride.pickup} â†’ ${ride.destination} ğŸ’¾${customerPhone} ğŸ’°${ride.price}â‚¬${pickupTime ? ' ğŸ•' + pickupTime : ''}`, {
                customer: customerName,
                phone: customerPhone,
                from: ride.pickup,
                to: ride.destination,
                price: ride.price,
                pickupTime: pickupDisplay,
                type: bookingType
            });
            
            // ğŸ“‹ CRM: Kunde automatisch anlegen/aktualisieren
            await updateCustomerCRM(customerName, customerPhone, ride.pickup, ride.price);
            
            // ğŸ“‹ CRM: Stammkunden-Daten aktualisieren wenn Checkbox aktiv
            const saveToCrmCheckbox = document.getElementById('save-to-crm');
            if (currentBookingCustomerId && saveToCrmCheckbox && saveToCrmCheckbox.checked) {
                try {
                    await db.ref('customers/' + currentBookingCustomerId).update({
                        phone: customerPhone,
                        address: ride.pickup
                    });
                    console.log('ğŸ“‹ Stammkunden-Daten aktualisiert:', currentBookingCustomerId);
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim Aktualisieren:', error);
                }
            }
            
            // Reset Stammkunden-ID und verstecke Checkbox
            currentBookingCustomerId = null;
            const crmOption = document.getElementById('crm-save-option');
            if (crmOption) crmOption.style.display = 'none';
            
            // ğŸ”„ Aktualisiere Verlauf (damit Vorbestellung sofort sichtbar ist)
            updateHistoryView();
            
            // âœ… BESTÃ„TIGUNG fÃ¼r Nutzer
            if (savedRide.status === 'vorbestellt') {
                // ğŸ“± TELEGRAM fÃ¼r Vorbestellung senden!
                if (isFirebaseReady) {
                    await sendTelegramForNewRide(savedRide);
                    // ğŸ†• v5.32.3: KUNDEN-BENACHRICHTIGUNGEN!
                    await sendCustomerNotifications(savedRide);
                }
                
                // ğŸ†• v5.52.9: Hide CRM-Banner nach Buchung
                const crmBanner = document.getElementById('crm-booking-banner');
                if (crmBanner) crmBanner.style.display = 'none';
                
                // ğŸ†• v5.32.5L: Zeige CARD statt Modal!
                document.getElementById('booking-form').style.display = 'none';
                showRideStatus(savedRide);
            } else {
                // ğŸ“± TELEGRAM fÃ¼r Sofort-Fahrt senden!
                if (isFirebaseReady) {
                    await sendTelegramForNewRide(savedRide);
                    // ğŸ†• v5.32.3: KUNDEN-BENACHRICHTIGUNGEN!
                    await sendCustomerNotifications(savedRide);
                }
                
                alert(
                    'âœ… Buchung erfolgreich!\n\n' +
                    'ğŸ“ Von: ' + ride.pickup + '\n' +
                    'ğŸ¯ Nach: ' + ride.destination + '\n' +
                    'ğŸ’° Preis: ' + ride.price + 'â‚¬\n\n' +
                    'ğŸ“² Sie erhalten SMS + Telegram mit Tracking-Link!\n\n' +
                    'ğŸš• Wir suchen jetzt einen Fahrer fÃ¼r dich!'
                );
            }
            
            // ğŸ¯ AUTO-ZUWEISUNG starten (nur wenn NICHT Vorbestellung)
            if (isFirebaseReady && savedRide.firebaseId && savedRide.status === 'new') {
                startAutoAssignment(savedRide.firebaseId, savedRide);
            }
            
            // ğŸ†• v5.32.5e: VORBESTELLUNGEN â†’ ZurÃ¼ck zu leerem Formular!
            if (savedRide.status === 'vorbestellt') {
                // âœ… Formular zurÃ¼cksetzen
                resetBookingForm();
                
                // âœ… Formular ANZEIGEN (nicht verstecken!)
                document.getElementById('booking-form').style.display = 'block';
                
                // âœ… Sicherstellen dass wir im Fahrgast-Tab sind
                if (typeof showTab === 'function') {
                    showTab('passenger');
                }
                
                console.log('âœ… v5.32.5e: Vorbestellung gespeichert, Formular zurÃ¼ckgesetzt, bereit fÃ¼r nÃ¤chste Buchung!');
                
            } else {
                // ğŸ†• v5.52.9: Hide CRM-Banner nach Buchung
                const crmBanner = document.getElementById('crm-booking-banner');
                if (crmBanner) crmBanner.style.display = 'none';
                
                // âš¡ SOFORT-FAHRTEN: Zeige Status-Ansicht
                document.getElementById('booking-form').style.display = 'none';
                showRideStatus(savedRide);
                
                // Formular trotzdem zurÃ¼cksetzen (fÃ¼r spÃ¤ter)
                resetBookingForm();
                
                if (isFirebaseReady) listenToMyRide(savedRide.firebaseId);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ§¹ v5.32.5: FORMULAR KOMPLETT ZURÃœCKSETZEN
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function resetBookingForm() {
            console.log('ğŸ§¹ Setze Buchungsformular zurÃ¼ck...');
            
            // ğŸ“ ALLE EINGABEFELDER LEEREN
            document.getElementById('customer-name').value = '';
            document.getElementById('customer-phone').value = '';
            document.getElementById('pickup').value = '';
            document.getElementById('destination').value = '';
            document.getElementById('passengers').value = '1';
            
            // ğŸ†• v5.49.6: Confirmation-Felder verstecken!
            const pickupConf = document.getElementById('pickup-confirmation');
            const destConf = document.getElementById('destination-confirmation');
            if (pickupConf) pickupConf.style.display = 'none';
            if (destConf) destConf.style.display = 'none';
            
            // ğŸ†• v5.90.73: Auch Icons verstecken!
            const pickupIcon = document.getElementById('pickup-confirmation-icon');
            const destIcon = document.getElementById('destination-confirmation-icon');
            const slotIcon = document.getElementById('slot-confirmation-icon');
            if (pickupIcon) pickupIcon.style.display = 'none';
            if (destIcon) destIcon.style.display = 'none';
            if (slotIcon) slotIcon.style.display = 'none';
            
            // ğŸ“… Vorbestell-Felder zurÃ¼cksetzen
            const preorderDateTime = document.getElementById('preorder-datetime');
            if (preorderDateTime) {
                preorderDateTime.value = '';
            }
            
            // ğŸ†• v5.90.74: custom-date/hour/minute auch zurÃ¼cksetzen!
            const customDate = document.getElementById('custom-date');
            const customHour = document.getElementById('custom-hour');
            const customMinute = document.getElementById('custom-minute');
            if (customDate) customDate.value = '';
            if (customHour) customHour.value = '00';
            if (customMinute) customMinute.value = '00';
            
            // ğŸ’³ Zahlungsmethode zurÃ¼cksetzen
            const paymentMethod = document.getElementById('payment-method');
            if (paymentMethod) {
                paymentMethod.value = 'bar';
            }
            
            // ğŸ’° PREIS ZURÃœCKSETZEN
            window.currentPrice = 0;
            window.currentDistance = 0;
            window.currentDuration = 0;
            const priceDisplay = document.getElementById('price-display');
            if (priceDisplay) {
                priceDisplay.innerHTML = '';
                priceDisplay.style.display = 'none'; // âœ… Verstecken!
            }
            const priceContainer = document.getElementById('price-container');
            if (priceContainer) {
                priceContainer.style.display = 'none';
            }
            
            // ğŸ—ºï¸ ROUTE-KARTE VERSTECKEN
            const routeMap = document.getElementById('route-map');
            if (routeMap) {
                routeMap.style.display = 'none';
                // Karte entfernen
                if (routeMapInstance) {
                    routeMapInstance.remove();
                    routeMapInstance = null;
                }
            }
            
            // ğŸ†• v5.90.76: LIVE-SLOT-CHECK VERSTECKEN
            const liveSlotCheck = document.getElementById('live-slot-check');
            if (liveSlotCheck) {
                liveSlotCheck.style.display = 'none';
                liveSlotCheck.innerHTML = '';
            }
            
            // ğŸ”˜ "BUCHEN"-BUTTON VERSTECKEN
            const bookBtn = document.getElementById('book-btn');
            if (bookBtn) {
                bookBtn.style.display = 'none';
            }
            
            // ğŸ”˜ "PREIS BERECHNEN"-BUTTON ZURÃœCKSETZEN
            const priceBtn = document.getElementById('price-btn');
            if (priceBtn) {
                priceBtn.innerHTML = 'ğŸ’° Preis berechnen';
                priceBtn.classList.remove('btn-danger');
                priceBtn.classList.add('btn-primary');
            }
            priceCalculated = false;
            
            // ğŸ—ºï¸ KARTE ZURÃœCKSETZEN
            if (window.currentRoutePolyline) {
                window.currentRoutePolyline.remove();
                window.currentRoutePolyline = null;
            }
            if (window.pickupMarker) {
                window.pickupMarker.remove();
                window.pickupMarker = null;
            }
            if (window.destinationMarker) {
                window.destinationMarker.remove();
                window.destinationMarker = null;
            }
            
            // ğŸ“ KOORDINATEN ZURÃœCKSETZEN
            window.pickupCoords = null;
            window.destCoords = null;
            
            // âœ… v5.90.74: Confirmation-Flags zurÃ¼cksetzen!
            pickupConfirmed = false;
            destinationConfirmed = false;
            
            // ğŸ†• v5.90.74: Ride-Type zurÃ¼cksetzen!
            currentRideType = null;
            
            // ğŸ†• v5.90.74: Ride-Type Buttons zurÃ¼cksetzen!
            const btnSofort = document.getElementById('btn-sofort');
            const btnVorbestellen = document.getElementById('btn-vorbestellen');
            const sofortBereich = document.getElementById('sofort-bereich');
            const vorbestellenBereich = document.getElementById('vorbestellen-bereich');
            
            if (btnSofort) {
                btnSofort.style.border = '3px solid #e5e7eb';
                btnSofort.style.background = 'white';
                const divs = btnSofort.querySelectorAll('div');
                if (divs[1]) divs[1].style.color = '#6b7280';
                if (divs[2]) divs[2].style.color = '#666';
            }
            
            if (btnVorbestellen) {
                btnVorbestellen.style.border = '3px solid #e5e7eb';
                btnVorbestellen.style.background = 'white';
                const divs = btnVorbestellen.querySelectorAll('div');
                if (divs[1]) divs[1].style.color = '#6b7280';
                if (divs[2]) divs[2].style.color = '#666';
            }
            
            if (sofortBereich) sofortBereich.style.display = 'none';
            if (vorbestellenBereich) vorbestellenBereich.style.display = 'none';
            
            // ğŸ”˜ BUTTONS ZURÃœCKSETZEN
            const rideTypeContainer = document.getElementById('ride-type-container');
            if (rideTypeContainer) {
                rideTypeContainer.style.display = 'none';
            }
            
            // â° VORBESTELL-CONTAINER VERSTECKEN
            const preorderContainer = document.getElementById('preorder-container');
            if (preorderContainer) {
                preorderContainer.style.display = 'none';
            }
            
            // ğŸ“‹ STAMMKUNDEN-CHECKBOX VERSTECKEN
            const crmOption = document.getElementById('crm-save-option');
            if (crmOption) {
                crmOption.style.display = 'none';
            }
            currentBookingCustomerId = null;
            
            // ğŸ§¹ LOKALSTORAGE FORMULAR-CACHE LEEREN
            localStorage.removeItem('bookingFormData');
            localStorage.removeItem('lastPickup');
            localStorage.removeItem('lastDestination');
            
            console.log('âœ… Formular zurÃ¼ckgesetzt - bereit fÃ¼r nÃ¤chste Buchung!');
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ“… v5.32.5f: VORBESTELL-ÃœBERSICHTS-MODAL
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let lastPreorderRide = null; // Speichert letzte Vorbestellung fÃ¼r Bearbeiten
        
        function showPreorderSummary(ride) {
            console.log('ğŸ“… Zeige Vorbestell-Ãœbersicht:', ride);
            
            lastPreorderRide = ride; // Speichern fÃ¼r Bearbeiten-Funktion
            
            // Formatiere Abholzeit
            const pickupTimeFormatted = ride.pickupTime || 'Sofort';
            
            // ğŸ†• v5.32.5k: ALTES schlichtes Design zurÃ¼ck!
            const summaryHtml = `
                <div style="padding: 20px; font-size: 15px; line-height: 1.8;">
                    <div style="margin-bottom: 15px;">
                        <strong>ğŸ• Abholung:</strong><br>
                        ${pickupTimeFormatted}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>ğŸ’¾ Name:</strong><br>
                        ${ride.customerName}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>ğŸ’¾ Telefon:</strong><br>
                        ${ride.customerPhone}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>ğŸ“ Von:</strong><br>
                        ${ride.pickup}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>ğŸ¯ Nach:</strong><br>
                        ${ride.destination}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>ğŸ’° Preis:</strong><br>
                        ${ride.price}â‚¬
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <strong>ğŸ‘¥ Personen:</strong><br>
                        ${ride.passengers || 1}
                    </div>
                    
                    <div style="padding: 15px; background: #dbeafe; border-radius: 8px; margin-bottom: 20px;">
                        <strong>ğŸ“² Sie erhalten SMS + Telegram mit Tracking-Link!</strong>
                    </div>
                </div>
            `;
            
            // FÃ¼ge HTML ein
            document.getElementById('preorder-summary-content').innerHTML = summaryHtml;
            
            // Zeige Modal
            document.getElementById('preorder-summary-modal').style.display = 'block';
        }
        
        function closePreorderSummary() {
            console.log('âœ… OK - SchlieÃŸe Ãœbersicht, zeige leeres Formular');
            
            // Modal schlieÃŸen
            document.getElementById('preorder-summary-modal').style.display = 'none';
            
            // âœ… Formular zurÃ¼cksetzen
            resetBookingForm();
            
            // âœ… Formular ANZEIGEN
            document.getElementById('booking-form').style.display = 'block';
            
            // âœ… ZurÃ¼ck zu Fahrgast-Tab
            if (typeof showTab === 'function') {
                showTab('passenger');
            }
            
            // ğŸ”„ Verlauf aktualisieren (damit neue Vorbestellung sichtbar)
            updateHistoryView();
        }
        
        function editPreorder() {
            console.log('âœï¸ Bearbeiten - Lade Daten zurÃ¼ck ins Formular');
            
            if (!lastPreorderRide) {
                console.error('ğŸ’¾ Keine Vorbestellung zum Bearbeiten!');
                return;
            }
            
            // Modal schlieÃŸen
            document.getElementById('preorder-summary-modal').style.display = 'none';
            
            // Daten zurÃ¼ck ins Formular laden
            document.getElementById('customer-name').value = lastPreorderRide.customerName || '';
            document.getElementById('customer-phone').value = lastPreorderRide.customerPhone || '';
            document.getElementById('pickup').value = lastPreorderRide.pickup || '';
            document.getElementById('destination').value = lastPreorderRide.destination || '';
            document.getElementById('passengers').value = lastPreorderRide.passengers || 1;
            
            // Koordinaten wiederherstellen
            window.pickupCoords = lastPreorderRide.pickupCoords || null;
            window.destCoords = lastPreorderRide.destCoords || null;
            
            // Zahlungsmethode
            const paymentMethod = document.getElementById('payment-method');
            if (paymentMethod && lastPreorderRide.paymentMethod) {
                paymentMethod.value = lastPreorderRide.paymentMethod;
            }
            
            // Vorbestell-Modus aktivieren
            currentRideType = 'vorbestellen';
            
            // Datum/Zeit zurÃ¼cksetzen wenn vorhanden
            if (lastPreorderRide.pickupTimestamp) {
                const date = new Date(lastPreorderRide.pickupTimestamp);
                
                const dateStr = getLocalDateString(date);  // ğŸ”§ v5.90.353: LOKAL!
                const hourStr = String(date.getHours()).padStart(2, '0');
                const minuteStr = String(date.getMinutes()).padStart(2, '0');
                
                const customDate = document.getElementById('custom-date');
                const customHour = document.getElementById('custom-hour');
                const customMinute = document.getElementById('custom-minute');
                
                if (customDate) customDate.value = dateStr;
                if (customHour) customHour.value = hourStr;
                if (customMinute) customMinute.value = minuteStr;
                
                // Vorbestell-Container zeigen
                const preorderContainer = document.getElementById('preorder-container');
                if (preorderContainer) {
                    preorderContainer.style.display = 'block';
                }
            }
            
            // Formular ANZEIGEN
            document.getElementById('booking-form').style.display = 'block';
            
            // ZurÃ¼ck zu Fahrgast-Tab
            if (typeof showTab === 'function') {
                showTab('passenger');
            }
            
            // Alte Fahrt in Firebase lÃ¶schen (wird neu gespeichert beim Buchen)
            if (isFirebaseReady && lastPreorderRide.firebaseId) {
                db.ref('rides/' + lastPreorderRide.firebaseId).remove();
                console.log('ğŸ—‘ï¸ Alte Vorbestellung gelÃ¶scht, wird neu gespeichert');
            }
            
            // Hinweis fÃ¼r User
            alert('âœï¸ Fahrt wurde ins Formular geladen!\n\nBitte passe die Daten an und klicke dann auf "Preis berechnen" und "Taxi buchen".');
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ¤– v5.32.5h: AUTO-BOOKING SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let autoBookingEnabled = true; // ğŸ”§ v5.33.0: IMMER aktiv fÃ¼r ALLE (Admin & FahrgÃ¤ste!)
        let currentBookingData = null; // Speichert aktuelle Buchungsdaten fÃ¼r Retry
        
        // ğŸ†• v5.33.2: Zeitslot-Einstellungen (aus localStorage geladen)
        let timeslotSettings = {
            rideDuration: 10,          // Minuten (Standard-Fahrtdauer falls OSRM fehlschlÃ¤gt)
            travelTime: 5,             // Minuten (Fahrzeit zwischen Fahrten)
            bufferTime: 3,             // Minuten (Sicherheits-Puffer)
            adminOverride: false,
            // ğŸ†• v5.90.528: ZEITPUFFER FÃœR EIN/AUSSTEIGEN & WAYPOINTS!
            boardingTime: 3,           // Minuten (Einsteigen am Start)
            alightingTime: 2,          // Minuten (Aussteigen am Ziel)
            waypointStopTime: 5        // Minuten (Wartezeit pro Waypoint)
        };
        
        // ğŸ†• v5.90.528: BERECHNE GESAMT-DAUER MIT ZEITPUFFERN!
        function calculateTotalDuration(osrmDuration, waypointCount = 0) {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('â±ï¸ v5.90.528: GESAMT-DAUER BERECHNUNG');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            const boarding = timeslotSettings.boardingTime || 3;
            const alighting = timeslotSettings.alightingTime || 2;
            const waypointStop = timeslotSettings.waypointStopTime || 5;
            
            const totalWaypointTime = waypointCount * waypointStop;
            const total = osrmDuration + boarding + alighting + totalWaypointTime;
            
            console.log('ğŸ“± KALKULATION:');
            console.log(`   OSRM Fahrtdauer:       ${osrmDuration} Min`);
            console.log(`   + Einsteigen (Start):  +${boarding} Min`);
            console.log(`   + Aussteigen (Ziel):   +${alighting} Min`);
            if (waypointCount > 0) {
                console.log(`   + Waypoints (${waypointCount}x):      +${totalWaypointTime} Min (${waypointCount} Ã— ${waypointStop} Min)`);
            }
            console.log(`   = GESAMT:              ${total} Min`);
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            return {
                osrmDuration: osrmDuration,
                boardingTime: boarding,
                alightingTime: alighting,
                waypointStops: waypointCount,
                waypointStopTime: waypointStop,
                totalWaypointTime: totalWaypointTime,
                totalDuration: total,
                breakdown: `${osrmDuration} Min Fahrt + ${boarding} Min Einsteigen + ${alighting} Min Aussteigen${waypointCount > 0 ? ` + ${totalWaypointTime} Min Waypoints (${waypointCount}Ã—${waypointStop})` : ''} = ${total} Min`
            };
        }
        
        // Admin-Schalter
        function toggleAutoBooking() {
            const checkbox = document.getElementById('enable-auto-booking');
            autoBookingEnabled = checkbox.checked;
            
            // In localStorage speichern
            localStorage.setItem('autoBookingEnabled', autoBookingEnabled);
            
            // Status anzeigen
            updateAutoBookingStatus();
            
            console.log('ğŸ¤– Auto-Booking:', autoBookingEnabled ? 'AKTIVIERT' : 'DEAKTIVIERT');
        }
        
        function updateAutoBookingStatus() {
            const statusDiv = document.getElementById('auto-booking-status');
            if (autoBookingEnabled) {
                statusDiv.innerHTML = 'âœ… <span style="color:#059669;font-weight:600;">Aktiviert</span> - System schlÃ¤gt automatisch Alternativen vor';
                statusDiv.style.background = '#d1fae5';
                statusDiv.style.border = '1px solid #10b981';
            } else {
                statusDiv.innerHTML = 'âšª <span style="color:#6b7280;font-weight:600;">Deaktiviert</span> - Keine automatischen VorschlÃ¤ge';
                statusDiv.style.background = '#f3f4f6';
                statusDiv.style.border = '1px solid #d1d5db';
            }
        }
        
        // Beim Laden Auto-Booking Status wiederherstellen
        function loadAutoBookingSettings() {
            // ğŸ”§ v5.33.0: StandardmÃ¤ÃŸig AKTIVIERT fÃ¼r alle!
            const saved = localStorage.getItem('autoBookingEnabled');
            // Nur wenn explizit 'false' gespeichert, dann deaktivieren
            // Sonst: IMMER aktiv!
            autoBookingEnabled = saved === 'false' ? false : true;
            
            const checkbox = document.getElementById('enable-auto-booking');
            if (checkbox) {
                checkbox.checked = autoBookingEnabled;
                updateAutoBookingStatus();
            }
            
            console.log('ğŸ¤– Auto-Booking Status geladen:', autoBookingEnabled, '(Standard: AKTIVIERT fÃ¼r alle!)');
        }
        
        // ğŸ†• v5.33.2: Zeitslot-Einstellungen Management
        function updateTimeslotSettings() {
            // Werte aus Sliders lesen
            const rideDuration = parseInt(document.getElementById('ride-duration-slider').value);
            const travelTime = parseInt(document.getElementById('travel-time-slider').value);
            const bufferTime = parseInt(document.getElementById('buffer-time-slider').value);
            const adminOverride = document.getElementById('admin-override-enabled').checked;
            
            // ğŸ†• v5.90.528: Neue Zeitpuffer!
            const boardingTime = parseInt(document.getElementById('boarding-time-slider')?.value || 3);
            const alightingTime = parseInt(document.getElementById('alighting-time-slider')?.value || 2);
            const waypointStopTime = parseInt(document.getElementById('waypoint-stop-slider')?.value || 5);
            
            // Anzeige aktualisieren
            document.getElementById('ride-duration-value').textContent = rideDuration + ' Min';
            document.getElementById('travel-time-value').textContent = travelTime + ' Min';
            document.getElementById('buffer-time-value').textContent = bufferTime + ' Min';
            
            // ğŸ†• v5.90.528: Neue Anzeigen
            if (document.getElementById('boarding-time-value')) {
                document.getElementById('boarding-time-value').textContent = boardingTime + ' Min';
            }
            if (document.getElementById('alighting-time-value')) {
                document.getElementById('alighting-time-value').textContent = alightingTime + ' Min';
            }
            if (document.getElementById('waypoint-stop-value')) {
                document.getElementById('waypoint-stop-value').textContent = waypointStopTime + ' Min';
            }
            
            // Total Buffer berechnen
            const totalBuffer = rideDuration + travelTime + bufferTime;
            document.getElementById('total-buffer-display').textContent = totalBuffer + ' Min';
            
            console.log('â° v5.90.528: Zeitslot-Einstellungen aktualisiert:', {
                rideDuration, 
                travelTime, 
                bufferTime, 
                boardingTime, 
                alightingTime, 
                waypointStopTime, 
                totalBuffer, 
                adminOverride
            });
        }
        
        function saveTimeslotSettings() {
            // Werte aus Sliders lesen
            timeslotSettings.rideDuration = parseInt(document.getElementById('ride-duration-slider').value);
            timeslotSettings.travelTime = parseInt(document.getElementById('travel-time-slider').value);
            timeslotSettings.bufferTime = parseInt(document.getElementById('buffer-time-slider').value);
            timeslotSettings.adminOverride = document.getElementById('admin-override-enabled').checked;
            
            // ğŸ†• v5.90.528: Neue Zeitpuffer speichern!
            timeslotSettings.boardingTime = parseInt(document.getElementById('boarding-time-slider')?.value || 3);
            timeslotSettings.alightingTime = parseInt(document.getElementById('alighting-time-slider')?.value || 2);
            timeslotSettings.waypointStopTime = parseInt(document.getElementById('waypoint-stop-slider')?.value || 5);
            
            // In localStorage speichern
            localStorage.setItem('timeslotSettings', JSON.stringify(timeslotSettings));
            
            // Status anzeigen
            const statusDiv = document.getElementById('timeslot-save-status');
            statusDiv.innerHTML = '<span style="color:#10b981;font-weight:600;">âœ… Einstellungen gespeichert!</span>';
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
            
            console.log('ğŸ’¾ v5.90.528: Zeitslot-Einstellungen gespeichert:', timeslotSettings);
        }
        
        function loadTimeslotSettings() {
            // Aus localStorage laden
            const saved = localStorage.getItem('timeslotSettings');
            if (saved) {
                timeslotSettings = JSON.parse(saved);
            }
            
            // ğŸ†• v5.90.16: WARNUNG bei Admin-Override!
            if (timeslotSettings.adminOverride) {
                console.warn('âš ï¸âš ï¸âš ï¸ ADMIN-OVERRIDE IST AKTIV! âš ï¸âš ï¸âš ï¸');
                console.warn('âš ï¸ Alle Zeitslots werden als FREI markiert!');
                console.warn('âš ï¸ Deaktiviere dies in den Einstellungen!');
            }
            
            // UI aktualisieren
            const rideDurationSlider = document.getElementById('ride-duration-slider');
            const travelTimeSlider = document.getElementById('travel-time-slider');
            const bufferTimeSlider = document.getElementById('buffer-time-slider');
            const adminOverrideCheckbox = document.getElementById('admin-override-enabled');
            
            if (rideDurationSlider) {
                rideDurationSlider.value = timeslotSettings.rideDuration;
                document.getElementById('ride-duration-value').textContent = timeslotSettings.rideDuration + ' Min';
            }
            
            if (travelTimeSlider) {
                travelTimeSlider.value = timeslotSettings.travelTime;
                document.getElementById('travel-time-value').textContent = timeslotSettings.travelTime + ' Min';
            }
            
            if (bufferTimeSlider) {
                bufferTimeSlider.value = timeslotSettings.bufferTime;
                document.getElementById('buffer-time-value').textContent = timeslotSettings.bufferTime + ' Min';
            }
            
            if (adminOverrideCheckbox) {
                adminOverrideCheckbox.checked = timeslotSettings.adminOverride;
                
                // ğŸ†• v5.90.16: Visueller Hinweis!
                if (timeslotSettings.adminOverride) {
                    adminOverrideCheckbox.parentElement.style.background = '#fee2e2';
                    adminOverrideCheckbox.parentElement.style.border = '2px solid #ef4444';
                }
            }
            
            // ğŸ†• v5.90.528: Neue Zeitpuffer laden!
            const boardingSlider = document.getElementById('boarding-time-slider');
            const alightingSlider = document.getElementById('alighting-time-slider');
            const waypointSlider = document.getElementById('waypoint-stop-slider');
            
            if (boardingSlider) {
                boardingSlider.value = timeslotSettings.boardingTime || 3;
                document.getElementById('boarding-time-value').textContent = (timeslotSettings.boardingTime || 3) + ' Min';
            }
            
            if (alightingSlider) {
                alightingSlider.value = timeslotSettings.alightingTime || 2;
                document.getElementById('alighting-time-value').textContent = (timeslotSettings.alightingTime || 2) + ' Min';
            }
            
            if (waypointSlider) {
                waypointSlider.value = timeslotSettings.waypointStopTime || 5;
                document.getElementById('waypoint-stop-value').textContent = (timeslotSettings.waypointStopTime || 5) + ' Min';
            }
            
            // Total Buffer aktualisieren
            const totalBuffer = timeslotSettings.rideDuration + timeslotSettings.travelTime + timeslotSettings.bufferTime;
            const totalBufferDisplay = document.getElementById('total-buffer-display');
            if (totalBufferDisplay) {
                totalBufferDisplay.textContent = totalBuffer + ' Min';
            }
            
            console.log('â° Zeitslot-Einstellungen geladen:', timeslotSettings);
        }
        
        // Beim Laden Einstellungen laden
        setTimeout(() => loadTimeslotSettings(), 1000);
        
        // ğŸ†• v5.90.132: TELEFONNUMMERN NORMALISIEREN
        async function normalizePhoneNumbers() {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ”§ TELEFONNUMMERN-MIGRATION GESTARTET');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            const statusDiv = document.getElementById('normalize-status');
            const btn = event.target;
            
            if (!confirm('ğŸ”§ Telefonnummern normalisieren?\n\n' +
                'Diese Aktion wird:\n' +
                'â€¢ Alle Mobilnummern auf "+49..." Format umstellen\n' +
                'â€¢ "01732022629" â†’ "+491732022629"\n' +
                'â€¢ "491732022629" â†’ "+491732022629"\n\n' +
                'Fortfahren?')) {
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'â³ LÃ¤uft...';
            statusDiv.innerHTML = '<span style="color:#f59e0b;">â³ Lade Kunden...</span>';
            
            try {
                // Alle Kunden laden
                const snapshot = await db.ref('customers').once('value');
                const customers = snapshot.val();
                
                if (!customers) {
                    statusDiv.innerHTML = '<span style="color:#dc2626;">ğŸ’¾ Keine Kunden gefunden</span>';
                    btn.disabled = false;
                    btn.textContent = 'ğŸ”„ Jetzt normalisieren';
                    return;
                }
                
                console.log(`ğŸ“± Gefunden: ${Object.keys(customers).length} Kunden`);
                statusDiv.innerHTML = '<span style="color:#f59e0b;">â³ Normalisiere Nummern...</span>';
                
                let updated = 0;
                let skipped = 0;
                let errors = 0;
                
                // Durch alle Kunden gehen
                for (const [customerId, customer] of Object.entries(customers)) {
                    try {
                        let needsUpdate = false;
                        const updates = {};
                        
                        // ğŸ”§ MOBILNUMMER NORMALISIEREN (mobilePhone)
                        if (customer.mobilePhone) {
                            const oldMobile = customer.mobilePhone;
                            const normalizedMobile = normalizeMobileNumber(oldMobile);
                            
                            if (normalizedMobile && normalizedMobile !== oldMobile) {
                                updates.mobilePhone = normalizedMobile;
                                needsUpdate = true;
                                console.log(`âœ… ${customer.name}: mobilePhone "${oldMobile}" â†’ "${normalizedMobile}"`);
                            }
                        }
                        
                        // ğŸ”§ TELEFON NORMALISIEREN (phone) - NUR wenn es eine Mobilnummer ist!
                        if (customer.phone) {
                            const oldPhone = customer.phone;
                            // PrÃ¼fe ob es eine Mobilnummer ist (beginnt mit 01... oder +491... oder 491...)
                            if (isMobileNumber(oldPhone)) {
                                const normalizedPhone = normalizeMobileNumber(oldPhone);
                                
                                if (normalizedPhone && normalizedPhone !== oldPhone) {
                                    updates.phone = normalizedPhone;
                                    needsUpdate = true;
                                    console.log(`âœ… ${customer.name}: phone "${oldPhone}" â†’ "${normalizedPhone}"`);
                                }
                            }
                        }
                        
                        // Update in Firebase
                        if (needsUpdate) {
                            await db.ref(`customers/${customerId}`).update(updates);
                            updated++;
                            console.log(`ğŸ’¾ ${customer.name}: Updates gespeichert`);
                        } else {
                            skipped++;
                        }
                        
                    } catch (err) {
                        console.error(`ğŸ’¾ Fehler bei ${customer.name}:`, err);
                        errors++;
                    }
                }
                
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('âœ… MIGRATION ABGESCHLOSSEN');
                console.log(`ğŸ“± Aktualisiert: ${updated}`);
                console.log(`â­ï¸ Ãœbersprungen: ${skipped}`);
                console.log(`ğŸ’¾ Fehler: ${errors}`);
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
                statusDiv.innerHTML = `<span style="color:#10b981;">âœ… Fertig! ${updated} aktualisiert, ${skipped} Ã¼bersprungen, ${errors} Fehler</span>`;
                
                alert(`âœ… Migration abgeschlossen!\n\n` +
                    `ğŸ“± Aktualisiert: ${updated}\n` +
                    `â­ï¸ Ãœbersprungen: ${skipped}\n` +
                    `ğŸ’¾ Fehler: ${errors}`);
                
            } catch (error) {
                console.error('ğŸ’¾ Migration-Fehler:', error);
                statusDiv.innerHTML = '<span style="color:#dc2626;">ğŸ’¾ Fehler bei Migration</span>';
                alert('ğŸ’¾ Fehler bei Migration: ' + error.message);
            }
            
            btn.disabled = false;
            btn.textContent = 'ğŸ”„ Jetzt normalisieren';
        }
        
        // ğŸ”§ Hilfsfunktion: PrÃ¼ft ob Nummer eine Mobilnummer ist
        function isMobileNumber(phone) {
            if (!phone) return false;
            const clean = phone.replace(/\s/g, '');
            // Deutsche Mobilnummern: beginnen mit 01... oder +491... oder 491...
            return clean.startsWith('01') || 
                   clean.startsWith('+491') || 
                   clean.startsWith('491');
        }
        
        // ğŸ”§ Hilfsfunktion: Normalisiert Mobilnummer auf +49... Format
        function normalizeMobileNumber(phone) {
            if (!phone) return null;
            
            // Entferne Leerzeichen
            let clean = phone.replace(/\s/g, '');
            
            // Bereits korrekt formatiert?
            if (clean.startsWith('+491') && clean.length >= 12) {
                return clean;
            }
            
            // Beginnt mit "01..." â†’ "+491..."
            if (clean.startsWith('01')) {
                return '+49' + clean.substring(1);
            }
            
            // Beginnt mit "491..." â†’ "+491..."
            if (clean.startsWith('491')) {
                return '+' + clean;
            }
            
            // Beginnt mit "+490..." â†’ "+491..." (0 entfernen)
            if (clean.startsWith('+490')) {
                return '+49' + clean.substring(4);
            }
            
            // Nicht als Mobilnummer erkannt
            return null;
        }
        
        // PrÃ¼ft ob Zeitslot bereits belegt ist
        async function checkTimeSlotAvailability(requestedTimestamp, pickupCoords) {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ” SLOT-CHECK GESTARTET');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            if (!isFirebaseReady) {
                console.log('ğŸ’¾ Firebase nicht bereit â†’ Slot FREI (Fallback)');
                debugLog('warn', 'âš ï¸ Slot-Check: Firebase nicht bereit');
                return { available: true };
            }
            
            // ğŸ¯ v5.33.2: Admin-Override prÃ¼fen!
            if (timeslotSettings.adminOverride) {
                console.log('ğŸ¯ Admin-Override AKTIV â†’ Slot FREI (Override)');
                console.log('âš ï¸ ACHTUNG: Alle Slots werden freigegeben!');
                debugLog('warn', 'ğŸ¯ Admin-Override: Slot-Check Ã¼bersprungen');
                return { available: true };
            }
            
            const requestedDate = new Date(requestedTimestamp).toLocaleString('de-DE');
            console.log('ğŸ“… GewÃ¼nschte Zeit:', requestedDate);
            console.log('ğŸ“ Pickup Coords:', pickupCoords);
            debugLog('info', `ğŸ” PrÃ¼fe Zeitslot: ${requestedDate}`);
            
            try {
                const snapshot = await db.ref('rides').once('value');
                const rides = [];
                
                snapshot.forEach(child => {
                    const ride = child.val();
                    ride.firebaseId = child.key;
                    rides.push(ride);
                });
                
                // Filtere nur aktive und vorbestellte Fahrten
                // ğŸ†• v5.90.16: ALLE aktiven Status berÃ¼cksichtigen!
                const activeRides = rides.filter(r => 
                    r.status && 
                    ['new', 'assigned', 'vorbestellt', 'picked_up', 'ongoing', 'akzeptiert', 'accepted', 'unterwegs', 'angekommen', 'assigned_to_driver'].includes(r.status) &&
                    r.pickupTimestamp
                );
                
                console.log(`ğŸ” Gefundene aktive Fahrten: ${activeRides.length} von ${rides.length} total`);
                if (activeRides.length > 0) {
                    console.log('ğŸ“‹ Status der aktiven Fahrten:', activeRides.map(r => r.status));
                }
                
                // ğŸ”§ v5.90.99: INTELLIGENTER FILTER fÃ¼r minimale OSRM-Calls!
                // Nur Fahrten vom GLEICHEN TAG + maximal 6h Abstand
                const requestedDay = new Date(requestedTimestamp).toDateString();
                const relevantRides = activeRides.filter(r => {
                    const rideDay = new Date(r.pickupTimestamp).toDateString();
                    
                    // 1. Muss gleicher Tag sein
                    if (rideDay !== requestedDay) return false;
                    
                    // 2. Maximal 6 Stunden Abstand (vor oder nach)
                    const timeDiff = Math.abs(r.pickupTimestamp - requestedTimestamp);
                    const hoursDiff = timeDiff / (1000 * 60 * 60);
                    return hoursDiff <= 6; // Nur Fahrten innerhalb Â±6h relevant
                });
                
                console.log(`âš¡ v5.90.99: Optimierter Filter â†’ ${relevantRides.length} von ${activeRides.length} Fahrten`);
                console.log(`ğŸ“± Eingesparte PrÃ¼fungen: ${activeRides.length - relevantRides.length} (= ${activeRides.length - relevantRides.length} * 2 = ${(activeRides.length - relevantRides.length) * 2} OSRM-Calls gespart!)`);
                
                // ğŸ”§ v5.90.100: PARALLELE OSRM-CALLS! Alle gleichzeitig statt nacheinander!
                console.log('âš¡ v5.90.100: Starte PARALLELE Route-Berechnung...');
                
                // 1. Sammle alle benÃ¶tigten OSRM-Calls
                const routePromises = [];
                const routeMap = new Map(); // FÃ¼r Zuordnung ride â†’ promises
                
                for (const ride of relevantRides) {
                    if (!ride.pickupTimestamp || isNaN(ride.pickupTimestamp) || ride.pickupTimestamp <= 0) {
                        continue;
                    }
                    
                    const pickupDate = new Date(ride.pickupTimestamp);
                    if (pickupDate.toString() === 'Invalid Date') {
                        continue;
                    }
                    
                    const promises = [];
                    
                    // Promise 1: Fahrtdauer (nur wenn nicht gespeichert)
                    if (!ride.duration && ride.pickupCoords && ride.destCoords) {
                        promises.push(calculateRouteDuration(ride.pickupCoords, ride.destCoords));
                    } else {
                        promises.push(Promise.resolve(ride.duration || timeslotSettings.rideDuration));
                    }
                    
                    // Promise 2: Fahrzeit zum neuen Start
                    // ğŸ†• v5.90.525: INTELLIGENTE BERECHNUNG!
                    // Berechne travelTime wenn bestehende Fahrt VOR der neuen endet
                    
                    // Erst mal Fahrtdauer holen (aus Promise 1)
                    const estimatedDuration = ride.duration || timeslotSettings.rideDuration;
                    const estimatedEndTime = ride.pickupTimestamp + (estimatedDuration * 60 * 1000);
                    
                    // Wenn neue Buchung NACH Ende der bestehenden Fahrt:
                    if (requestedTimestamp > estimatedEndTime && ride.destCoords && pickupCoords) {
                        // Berechne Fahrzeit vom ZIEL der alten zum START der neuen!
                        promises.push(calculateRouteDuration(ride.destCoords, pickupCoords));
                        console.log(`   ğŸ”„ v5.90.525: Berechne Fahrzeit: ${ride.destination || 'Ziel'} â†’ ${document.getElementById('pickup')?.value || 'Start'}`);
                    } else {
                        // Fallback: Standard-Fahrzeit
                        promises.push(Promise.resolve(timeslotSettings.travelTime));
                    }
                    
                    routeMap.set(ride.firebaseId || ride.id, promises);
                    routePromises.push(...promises);
                }
                
                // 2. FÃœHRE ALLE PARALLEL AUS! ğŸš€
                const startTime = Date.now();
                await Promise.all(routePromises);
                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                console.log(`âš¡ v5.90.100: ${routePromises.length} OSRM-Calls in ${duration} Sek (parallel!)ğŸš€`);
                
                // 3. Jetzt Konflikte prÃ¼fen mit den gecachten Ergebnissen
                for (const ride of relevantRides) {
                    if (!ride.pickupTimestamp || isNaN(ride.pickupTimestamp) || ride.pickupTimestamp <= 0) {
                        continue;
                    }
                    
                    const pickupDate = new Date(ride.pickupTimestamp);
                    if (pickupDate.toString() === 'Invalid Date') {
                        continue;
                    }
                    
                    console.log('ğŸ” PrÃ¼fe gegen Fahrt:', pickupDate.toLocaleString('de-DE', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric',
                        hour: '2-digit', 
                        minute: '2-digit' 
                    }), '| ID:', ride.firebaseId || ride.id, '| Status:', ride.status);
                    
                    // Hole berechnete Werte (aus Cache oder eben berechnet)
                    const promises = routeMap.get(ride.firebaseId || ride.id);
                    const [rideDuration, travelTime] = await Promise.all(promises);
                    
                    console.log(`   âš¡ v5.90.525: Fahrtdauer: ${rideDuration} Min, Fahrzeit zum neuen Start: ${travelTime} Min`);
                    
                    // ğŸ†• v5.90.530: BERECHNE TOTAL-DURATION mit Puffern!
                    const waypointCount = (ride.waypoints && Array.isArray(ride.waypoints)) ? ride.waypoints.filter(wp => wp.coords).length : 0;
                    const durationCalc = calculateTotalDuration(rideDuration, waypointCount);
                    
                    const rideEndTime = ride.pickupTimestamp + (durationCalc.totalDuration * 60 * 1000);
                    console.log(`   ğŸ v5.90.530: Fahrt endet um ${new Date(rideEndTime).toLocaleTimeString('de-DE')}`);
                    console.log(`      Dauer-Breakdown: ${durationCalc.breakdown}`);
                    
                    // KonfliktprÃ¼fung
                    if (requestedTimestamp > rideEndTime) {
                        // Neue Buchung ist NACH Ende der bestehenden Fahrt
                        const earliestPossible = rideEndTime + (travelTime * 60 * 1000) + (timeslotSettings.bufferTime * 60 * 1000);
                        
                        console.log(`   ğŸ§® v5.90.530: BERECHNUNG:`);
                        console.log(`      Fahrt endet:     ${new Date(rideEndTime).toLocaleTimeString('de-DE')} (${durationCalc.totalDuration} Min Total)`);
                        console.log(`      + Fahrzeit:      ${travelTime} Min (${ride.destination || '?'} â†’ ${document.getElementById('pickup')?.value || '?'})`);
                        console.log(`      + Puffer:        ${timeslotSettings.bufferTime} Min`);
                        console.log(`      = FrÃ¼hestens:    ${new Date(earliestPossible).toLocaleTimeString('de-DE')}`);
                        console.log(`      GewÃ¼nscht:       ${new Date(requestedTimestamp).toLocaleTimeString('de-DE')}`);
                        
                        if (requestedTimestamp < earliestPossible) {
                            const minutesTooEarly = Math.round((earliestPossible - requestedTimestamp) / 60000);
                            console.log(`   âš ï¸ v5.90.530: KONFLIKT! GewÃ¼nschte Zeit ist ${minutesTooEarly} Min zu frÃ¼h!`);
                            debugLog('error', `âš ï¸ KONFLIKT! ${minutesTooEarly} Min zu frÃ¼h! FrÃ¼hestens: ${new Date(earliestPossible).toLocaleTimeString('de-DE')}`);
                            return {
                                available: false,
                                conflictingRide: ride,
                                earliestPossible: earliestPossible,
                                reason: `Taxi braucht ${travelTime} Min von ${ride.destination} zum neuen Start (inkl. ${durationCalc.alightingTime} Min Aussteigen)`
                            };
                        } else {
                            const minutesSpare = Math.round((requestedTimestamp - earliestPossible) / 60000);
                            console.log(`   âœ… v5.90.530: PASST! ${minutesSpare} Min Puffer verfÃ¼gbar.`);
                        }
                    }
                    
                    // PrÃ¼fe ob neue Buchung WÃ„HREND bestehender Fahrt liegt
                    if (requestedTimestamp >= ride.pickupTimestamp && requestedTimestamp <= rideEndTime) {
                        const minutesIntoRide = Math.round((requestedTimestamp - ride.pickupTimestamp) / 60000);
                        console.log(`   âš ï¸ v5.90.530: KONFLIKT! GewÃ¼nschte Zeit liegt WÃ„HREND laufender Fahrt!`);
                        console.log(`      Fahrt: ${new Date(ride.pickupTimestamp).toLocaleTimeString('de-DE')} - ${new Date(rideEndTime).toLocaleTimeString('de-DE')}`);
                        console.log(`      GewÃ¼nscht: ${new Date(requestedTimestamp).toLocaleTimeString('de-DE')} (${minutesIntoRide} Min nach Start)`);
                        debugLog('error', 'âš ï¸ KONFLIKT! Zeit liegt wÃ¤hrend laufender Fahrt!');
                        return {
                            available: false,
                            conflictingRide: ride,
                            earliestPossible: rideEndTime + (travelTime * 60 * 1000) + (timeslotSettings.bufferTime * 60 * 1000),
                            reason: `Taxi ist noch ${durationCalc.totalDuration - minutesIntoRide} Min beschÃ¤ftigt (inkl. Puffer)`
                        };
                    }
                }
                
                console.log('âœ… Zeitslot verfÃ¼gbar!');
                debugLog('info', 'âœ… Zeitslot verfÃ¼gbar!');
                return { available: true };
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler bei Zeitslot-PrÃ¼fung:', error);
                debugLog('error', `ğŸ’¾ Slot-Check Fehler: ${error.message}`);
                return { available: true }; // Im Fehlerfall erlauben
            }
        }
        
        // Berechnet alternative Zeiten
        async function calculateAlternativeTimes(conflictingRide, pickupCoords, requestedTimestamp) {
            console.log('ğŸ’¡ Berechne alternative Zeiten...');
            
            // ğŸ†• v5.90.119: PrÃ¼fe ob Zielort vorhanden!
            if (!conflictingRide.destCoords) {
                console.warn('âš ï¸ WARNUNG: Zielort der blockierenden Fahrt fehlt!');
                console.warn('   Fahrt-ID:', conflictingRide.firebaseId || conflictingRide.id);
                console.warn('   Start:', new Date(conflictingRide.pickupTimestamp).toLocaleString('de-DE'));
                
                // Gebe Warnung zurÃ¼ck statt falsche Zeiten
                return [{
                    error: true,
                    message: 'missing_destination',
                    rideId: conflictingRide.firebaseId || conflictingRide.id,
                    rideTime: new Date(conflictingRide.pickupTimestamp).toLocaleString('de-DE', {
                        hour: '2-digit',
                        minute: '2-digit'
                    })
                }];
            }
            
            try {
                // 1. Berechne Dauer der konfliktierenden Fahrt
                const rideDuration = await calculateRouteDuration(
                    conflictingRide.pickupCoords,
                    conflictingRide.destCoords
                );
                
                console.log('ğŸš— Konflikt-Fahrt Dauer (OSRM):', rideDuration, 'Min');
                
                // ğŸ†• v5.90.530: BERECHNE TOTAL-DURATION mit Puffern!
                const waypointCount = (conflictingRide.waypoints && Array.isArray(conflictingRide.waypoints)) ? conflictingRide.waypoints.filter(wp => wp.coords).length : 0;
                const durationCalc = calculateTotalDuration(rideDuration, waypointCount);
                
                console.log('ğŸš— Konflikt-Fahrt Total-Dauer:', durationCalc.totalDuration, 'Min');
                console.log('   Breakdown:', durationCalc.breakdown);
                
                // 2. Ende der konfliktierenden Fahrt (MIT PUFFERN!)
                const rideEndTime = conflictingRide.pickupTimestamp + (durationCalc.totalDuration * 60 * 1000);
                
                // 3. Berechne Fahrzeit vom Ziel zum neuen Start
                const travelTime = await calculateRouteDuration(
                    conflictingRide.destCoords,
                    pickupCoords
                );
                
                console.log('ğŸš• Fahrzeit zum neuen Start:', travelTime, 'Min');
                
                // 4. FrÃ¼hestmÃ¶gliche Zeit = Ende + Fahrzeit + Puffer
                let earliestTime = rideEndTime + (travelTime * 60 * 1000) + (timeslotSettings.bufferTime * 60 * 1000);
                
                console.log('â° v5.90.530: FrÃ¼hestmÃ¶glich berechnet:');
                console.log(`   Fahrt endet: ${new Date(rideEndTime).toLocaleTimeString('de-DE')} (${durationCalc.totalDuration} Min inkl. Puffer)`);
                console.log(`   + Fahrzeit: ${travelTime} Min`);
                console.log(`   + Puffer: ${timeslotSettings.bufferTime} Min`);
                console.log(`   = ${new Date(earliestTime).toLocaleTimeString('de-DE')}`);
                
                // 5. Auf 5 Min runden (IMMER AUFRUNDEN!)
                earliestTime = roundToNext5Minutes(earliestTime);
                
                console.log('â° FrÃ¼hestmÃ¶glich (gerundet):', new Date(earliestTime).toLocaleTimeString('de-DE'));
                
                // ğŸ†• v5.41.8: PRÃœFE ALTERNATIVEN ob sie WIRKLICH FREI sind!
                const alternatives = [];
                let candidateTime = earliestTime;
                const maxAttempts = 20; // Max 20 Slots prÃ¼fen
                let attempts = 0;
                
                console.log('ğŸ” Suche verfÃ¼gbare Slots ab:', new Date(candidateTime).toLocaleString('de-DE'));
                
                while (alternatives.length < 3 && attempts < maxAttempts) {
                    attempts++;
                    
                    // PrÃ¼fe ob dieser Slot frei ist
                    const availability = await checkTimeSlotAvailability(candidateTime, pickupCoords);
                    
                    if (availability.available) {
                        console.log('âœ… Slot verfÃ¼gbar:', new Date(candidateTime).toLocaleString('de-DE'));
                        alternatives.push({
                            timestamp: candidateTime,
                            formatted: formatTimeForDisplay(candidateTime)
                        });
                    } else {
                        console.log('âš ï¸ Slot belegt:', new Date(candidateTime).toLocaleString('de-DE'));
                    }
                    
                    // NÃ¤chster Kandidat: +15 Min
                    candidateTime += (15 * 60 * 1000);
                }
                
                console.log(`ğŸ’¡ ${alternatives.length} verfÃ¼gbare Slots gefunden (${attempts} geprÃ¼ft)`);
                
                return alternatives;
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler bei Alternativ-Berechnung:', error);
                // Fallback: Einfach +15, +30, +45 Min zur gewÃ¼nschten Zeit
                return [15, 30, 45].map(offset => {
                    const ts = requestedTimestamp + (offset * 60 * 1000);
                    return {
                        timestamp: ts,
                        formatted: formatTimeForDisplay(ts)
                    };
                });
            }
        }
        
        // ğŸ†• v5.90.20: API FÃœR EMAIL-BOT / TELEGRAM-BOT
        // PrÃ¼ft Slot-VerfÃ¼gbarkeit und gibt Alternativen zurÃ¼ck
        window.checkSlotForBot = async function(dateTimeStr, pickupAddress, emailReceivedDate = null) {
            console.log('ğŸ¤– BOT Slot-Check:', dateTimeStr, pickupAddress);
            
            // ğŸ†• v5.90.230: DATUM-CHECK! Lehne alte Emails ab!
            if (emailReceivedDate) {
                const emailDate = new Date(emailReceivedDate);
                const now = new Date();
                const daysDiff = (now - emailDate) / (1000 * 60 * 60 * 24);
                
                console.log('ğŸ“§ Email Datum:', emailDate.toLocaleString('de-DE'));
                console.log('ğŸ“† Tage alt:', daysDiff.toFixed(1));
                
                // Lehne Emails ab die Ã¤lter als 7 Tage sind
                if (daysDiff > 7) {
                    console.error('ğŸ’¾ EMAIL ZU ALT! (', daysDiff.toFixed(1), 'Tage)');
                    return {
                        available: false,
                        error: 'EMAIL_TOO_OLD',
                        errorMessage: `Diese Email ist ${Math.round(daysDiff)} Tage alt und wird nicht bearbeitet. Bitte senden Sie eine neue Anfrage.`,
                        requestedTime: dateTimeStr,
                        alternatives: []
                    };
                }
                
                console.log('âœ… Email ist aktuell (', daysDiff.toFixed(1), 'Tage alt)');
            }
            
            try {
                // 1. Parse DateTime String (z.B. "2026-01-02 14:00")
                const [datePart, timePart] = dateTimeStr.split(' ');
                const [year, month, day] = datePart.split('-').map(n => parseInt(n));
                const [hour, minute] = timePart.split(':').map(n => parseInt(n));
                
                const requestedTime = new Date(year, month - 1, day, hour, minute, 0, 0);
                const timestamp = requestedTime.getTime();
                
                console.log('ğŸ“… GewÃ¼nschte Zeit:', requestedTime.toLocaleString('de-DE'));
                
                // 2. Geocode Pickup Address
                let pickupCoords = null;
                if (pickupAddress) {
                    pickupCoords = await geocode(pickupAddress);
                    console.log('ğŸ“ Pickup Coords:', pickupCoords);
                }
                
                // 3. Check Slot
                const availability = await checkTimeSlotAvailability(timestamp, pickupCoords);
                
                // 4. Wenn belegt, finde Alternativen
                if (!availability.available && availability.conflictingRide) {
                    console.log('âš ï¸ Slot belegt, berechne Alternativen...');
                    
                    const alternatives = await calculateAlternativeTimes(
                        availability.conflictingRide,
                        pickupCoords,
                        timestamp
                    );
                    
                    // Formatiere Alternativen
                    const formattedAlternatives = alternatives.slice(0, 3).map(alt => {
                        const altDate = new Date(alt.timestamp);
                        return {
                            time: altDate.toLocaleString('de-DE', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            }),
                            timestamp: alt.timestamp,
                            reason: alt.reason
                        };
                    });
                    
                    return {
                        available: false,
                        requestedTime: dateTimeStr,
                        alternatives: formattedAlternatives
                    };
                }
                
                // 5. Slot ist frei!
                return {
                    available: true,
                    requestedTime: dateTimeStr,
                    alternatives: []
                };
                
            } catch (error) {
                console.error('ğŸ’¾ BOT Slot-Check Fehler:', error);
                return {
                    available: true, // Im Fehlerfall erlauben
                    requestedTime: dateTimeStr,
                    error: error.message,
                    alternatives: []
                };
            }
        };
        
        // ğŸ†• v5.90.20: EINFACHE API - Nur JA/NEIN
        window.isSlotAvailable = async function(dateTimeStr, pickupAddress, emailReceivedDate = null) {
            const result = await window.checkSlotForBot(dateTimeStr, pickupAddress, emailReceivedDate);
            
            // ğŸ†• v5.90.230: Bei zu alter Email â†’ false
            if (result.error === 'EMAIL_TOO_OLD') {
                return false;
            }
            
            return result.available;
        };
        
        // ğŸ†• v5.90.20: API MIT ALTERNATIVEN ALS TEXT
        window.checkSlotWithText = async function(dateTimeStr, pickupAddress, emailReceivedDate = null) {
            const result = await window.checkSlotForBot(dateTimeStr, pickupAddress, emailReceivedDate);
            
            // ğŸ†• v5.90.230: Bei zu alter Email â†’ Fehlermeldung
            if (result.error === 'EMAIL_TOO_OLD') {
                return `ğŸ’¾ FEHLER: ${result.errorMessage}`;
            }
            
            if (result.available) {
                return `âœ… ${dateTimeStr} ist verfÃ¼gbar!`;
            } else {
                let text = `ğŸ’¾ ${dateTimeStr} ist leider belegt.\n\n`;
                
                if (result.alternatives && result.alternatives.length > 0) {
                    text += 'ğŸ“… Alternative Zeiten:\n';
                    result.alternatives.forEach((alt, i) => {
                        text += `${i + 1}. ${alt.time}\n`;
                    });
                } else {
                    text += 'Keine Alternativen gefunden.';
                }
                
                return text;
            }
        };
        
        // Berechnet Route-Dauer via Google Maps
        // ğŸ”§ v5.90.98: ROUTE CACHE - Vermeide doppelte OSRM-Calls!
        const routeCache = new Map();
        const CACHE_DURATION = 60 * 60 * 1000; // 1 Stunde
        
        function getRouteCacheKey(fromCoords, toCoords) {
            // Runde auf 3 Dezimalstellen (~111m Genauigkeit)
            const fromLat = Math.round(fromCoords.lat * 1000) / 1000;
            const fromLon = Math.round((fromCoords.lon || fromCoords.lng) * 1000) / 1000;
            const toLat = Math.round(toCoords.lat * 1000) / 1000;
            const toLon = Math.round((toCoords.lon || toCoords.lng) * 1000) / 1000;
            return `${fromLat},${fromLon}â†’${toLat},${toLon}`;
        }
        
        // ğŸ†• v5.90.526: FINDE ALLE FREIEN ZEITSLOTS!
        // Berechnet alle verfÃ¼gbaren Zeitfenster fÃ¼r eine Strecke
        async function findAvailableTimeSlots(pickupCoords, destCoords, date = null) {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ” v5.90.526: SUCHE FREIE ZEITSLOTS');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            if (!isFirebaseReady) {
                console.log('ğŸ’¾ Firebase nicht bereit');
                return { allSlots: [], freeSlots: [], blockedSlots: [], timeWindows: [], newRideDuration: 0 };
            }
            
            // Verwende heutigen Tag wenn kein Datum angegeben
            const targetDate = date || new Date();
            const startOfDay = new Date(targetDate);
            startOfDay.setHours(0, 0, 0, 0);
            const endOfDay = new Date(targetDate);
            endOfDay.setHours(23, 59, 59, 999);
            
            console.log('ğŸ“… Suche Slots fÃ¼r:', targetDate.toLocaleDateString('de-DE'));
            console.log('ğŸ“ Strecke:', pickupCoords, 'â†’', destCoords);
            
            try {
                // 1. HOLE ALLE AKTIVEN FAHRTEN DES TAGES
                const snapshot = await db.ref('rides').once('value');
                const rides = [];
                
                snapshot.forEach(child => {
                    const ride = child.val();
                    ride.firebaseId = child.key;
                    
                    // Nur Fahrten vom gewÃ¤hlten Tag
                    const rideDate = new Date(ride.pickupTimestamp);
                    if (rideDate >= startOfDay && rideDate <= endOfDay) {
                        // Nur aktive/vorbestellte Fahrten
                        if (ride.status && ['new', 'assigned', 'vorbestellt', 'picked_up', 'ongoing', 'accepted'].includes(ride.status)) {
                            rides.push(ride);
                        }
                    }
                });
                
                console.log(`ğŸ“‹ Gefundene Fahrten am ${targetDate.toLocaleDateString('de-DE')}: ${rides.length}`);
                
                // 2. SORTIERE FAHRTEN NACH ZEIT
                rides.sort((a, b) => a.pickupTimestamp - b.pickupTimestamp);
                
                // 3. BERECHNE FAHRTDAUER FÃœR NEUE STRECKE
                const newRideDuration = await calculateRouteDuration(pickupCoords, destCoords);
                console.log(`â±ï¸ Neue Fahrt wÃ¼rde dauern: ${newRideDuration} Min`);
                
                // 4. ERSTELLE ZEITSLOTS (alle 15 Minuten von 6:00 - 22:00)
                const allSlots = [];
                const dayStart = new Date(targetDate);
                dayStart.setHours(6, 0, 0, 0);  // Start um 6:00
                const dayEnd = new Date(targetDate);
                dayEnd.setHours(22, 0, 0, 0);    // Ende um 22:00
                
                for (let time = dayStart.getTime(); time <= dayEnd.getTime(); time += 15 * 60 * 1000) {
                    allSlots.push({
                        timestamp: time,
                        available: true,  // Erstmal alle als frei markieren
                        reason: null
                    });
                }
                
                console.log(`ğŸ• Erstellt ${allSlots.length} mÃ¶gliche Zeitslots (6:00 - 22:00, alle 15 Min)`);
                
                // 5. BERECHNE BLOCKIERTE ZEITEN FÃœR JEDE BESTEHENDE FAHRT
                for (const ride of rides) {
                    console.log(`\nğŸš• PrÃ¼fe bestehende Fahrt: ${new Date(ride.pickupTimestamp).toLocaleTimeString('de-DE')}`);
                    console.log(`   Von: ${ride.pickup || '?'} â†’ ${ride.destination || '?'}`);
                    
                    // Fahrtdauer der bestehenden Fahrt
                    const rideDuration = ride.duration || timeslotSettings.rideDuration;
                    const rideEnd = ride.pickupTimestamp + (rideDuration * 60 * 1000);
                    
                    console.log(`   Dauer: ${rideDuration} Min, endet: ${new Date(rideEnd).toLocaleTimeString('de-DE')}`);
                    
                    // Berechne Fahrzeit vom Ziel der bestehenden zum neuen Start
                    let travelTimeToNew = timeslotSettings.travelTime;
                    if (ride.destCoords && pickupCoords) {
                        travelTimeToNew = await calculateRouteDuration(ride.destCoords, pickupCoords);
                        console.log(`   Fahrzeit zum neuen Start: ${travelTimeToNew} Min`);
                    }
                    
                    // Berechne Fahrzeit vom neuen Ziel zum bestehenden Start
                    let travelTimeFromNew = timeslotSettings.travelTime;
                    if (destCoords && ride.pickupCoords) {
                        travelTimeFromNew = await calculateRouteDuration(destCoords, ride.pickupCoords);
                        console.log(`   Fahrzeit vom neuen Ende: ${travelTimeFromNew} Min`);
                    }
                    
                    // BLOCKIERE SLOTS
                    for (const slot of allSlots) {
                        if (!slot.available) continue; // Schon blockiert
                        
                        const slotEnd = slot.timestamp + (newRideDuration * 60 * 1000);
                        
                        // FALL 1: Neuer Slot wÃ¼rde WÃ„HREND bestehender Fahrt liegen
                        if (slot.timestamp < rideEnd && slotEnd > ride.pickupTimestamp) {
                            slot.available = false;
                            slot.reason = `Taxi beschÃ¤ftigt (${ride.pickup} â†’ ${ride.destination})`;
                            continue;
                        }
                        
                        // FALL 2: Neuer Slot NACH bestehender Fahrt (zu wenig Zeit)
                        if (slot.timestamp > ride.pickupTimestamp && slot.timestamp < rideEnd) {
                            slot.available = false;
                            slot.reason = `Taxi noch beschÃ¤ftigt bis ${new Date(rideEnd).toLocaleTimeString('de-DE')}`;
                            continue;
                        }
                        
                        // FALL 3: Neuer Slot kurz NACH bestehender Fahrt (Fahrzeit zu kurz)
                        const earliestAfter = rideEnd + (travelTimeToNew * 60 * 1000) + (timeslotSettings.bufferTime * 60 * 1000);
                        if (slot.timestamp >= rideEnd && slot.timestamp < earliestAfter) {
                            const minutesNeeded = Math.round((earliestAfter - slot.timestamp) / 60000);
                            slot.available = false;
                            slot.reason = `Taxi braucht noch ${minutesNeeded} Min von ${ride.destination}`;
                            continue;
                        }
                        
                        // FALL 4: Neuer Slot VOR bestehender Fahrt (wÃ¼rde kollidieren)
                        const latestBefore = ride.pickupTimestamp - (travelTimeFromNew * 60 * 1000) - (timeslotSettings.bufferTime * 60 * 1000);
                        if (slotEnd > latestBefore && slot.timestamp < ride.pickupTimestamp) {
                            const minutesNeeded = Math.round((ride.pickupTimestamp - slotEnd) / 60000);
                            slot.available = false;
                            slot.reason = `Zu wenig Zeit vor nÃ¤chster Fahrt (braucht ${minutesNeeded} Min)`;
                            continue;
                        }
                    }
                }
                
                // 6. ZÃ„HLE FREIE SLOTS
                const freeSlots = allSlots.filter(s => s.available);
                const blockedSlots = allSlots.filter(s => !s.available);
                
                console.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log(`âœ… FREIE SLOTS: ${freeSlots.length}`);
                console.log(`ğŸ’¾ BLOCKIERT: ${blockedSlots.length}`);
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
                // 7. GRUPPIERE IN ZEITFENSTER
                const timeWindows = [];
                let currentWindow = null;
                
                for (const slot of allSlots) {
                    if (slot.available) {
                        if (!currentWindow) {
                            // Neues Zeitfenster starten
                            currentWindow = {
                                start: slot.timestamp,
                                end: slot.timestamp + (15 * 60 * 1000),
                                duration: 15
                            };
                        } else {
                            // Zeitfenster erweitern
                            currentWindow.end = slot.timestamp + (15 * 60 * 1000);
                            currentWindow.duration += 15;
                        }
                    } else {
                        if (currentWindow) {
                            // Zeitfenster abschlieÃŸen
                            timeWindows.push(currentWindow);
                            currentWindow = null;
                        }
                    }
                }
                
                // Letztes Fenster
                if (currentWindow) {
                    timeWindows.push(currentWindow);
                }
                
                console.log(`\nğŸ“± FREIE ZEITFENSTER: ${timeWindows.length}`);
                timeWindows.forEach((w, i) => {
                    console.log(`   ${i+1}. ${new Date(w.start).toLocaleTimeString('de-DE')} - ${new Date(w.end).toLocaleTimeString('de-DE')} (${w.duration} Min)`);
                });
                
                return {
                    allSlots: allSlots,
                    freeSlots: freeSlots,
                    blockedSlots: blockedSlots,
                    timeWindows: timeWindows,
                    newRideDuration: newRideDuration
                };
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler bei Slot-Suche:', error);
                return {
                    allSlots: [],
                    freeSlots: [],
                    blockedSlots: [],
                    timeWindows: [],
                    newRideDuration: 0
                };
            }
        }
        
        async function calculateRouteDuration(fromCoords, toCoords) {
            if (!fromCoords || !toCoords) return 15; // Fallback
            
            // ğŸ”§ v5.90.98: PRÃœFE CACHE ZUERST!
            const cacheKey = getRouteCacheKey(fromCoords, toCoords);
            const cached = routeCache.get(cacheKey);
            
            if (cached && (Date.now() - cached.timestamp < CACHE_DURATION)) {
                console.log(`âš¡ Route aus Cache: ${cached.duration} Min (Key: ${cacheKey.substring(0, 20)}...)`);
                return cached.duration;
            }
            
            try {
                // ğŸ”§ v5.49.7: OSRM statt Google! (kostenlos, kein API Key!)
                const fromLon = fromCoords.lon || fromCoords.lng;
                const toLon = toCoords.lon || toCoords.lng;
                
                if (!fromCoords.lat || !fromLon || !toCoords.lat || !toLon) {
                    console.warn('âš ï¸ UnvollstÃ¤ndige Koordinaten:', { fromCoords, toCoords });
                    return 15; // Fallback
                }
                
                // ğŸ†• v5.49.7: OSRM Route API (Open Source, kostenlos!)
                const response = await fetch(
                    `https://router.project-osrm.org/route/v1/driving/` +
                    `${fromLon},${fromCoords.lat};${toLon},${toCoords.lat}?overview=false`
                );
                
                const data = await response.json();
                
                if (data.code === 'Ok' && data.routes && data.routes[0]) {
                    const duration = data.routes[0].duration; // Sekunden
                    const minutes = Math.ceil(duration / 60); // Minuten, aufgerundet
                    
                    // ğŸ”§ v5.90.98: SPEICHERE IM CACHE!
                    routeCache.set(cacheKey, { 
                        duration: minutes, 
                        timestamp: Date.now() 
                    });
                    
                    console.log(`âœ… Route berechnet (OSRM): ${minutes} Min â†’ Cache gespeichert`);
                    return minutes;
                } else {
                    console.warn('âš ï¸ OSRM konnte Route nicht berechnen:', data.code || 'Unknown');
                }
            } catch (error) {
                console.error('ğŸ’¾ Fehler bei Route-Berechnung:', error);
            }
            
            return 15; // Fallback
        }
        
        // Rundet auf nÃ¤chste 5 Minuten AUF
        function roundToNext5Minutes(timestamp) {
            const date = new Date(timestamp);
            const minutes = date.getMinutes();
            const remainder = minutes % 5;
            
            if (remainder === 0) {
                return timestamp; // Schon auf 5 Min
            }
            
            // Aufrunden auf nÃ¤chste 5
            const minutesToAdd = 5 - remainder;
            return timestamp + (minutesToAdd * 60 * 1000);
        }
        
        // Formatiert Zeit fÃ¼r Anzeige
        function formatTimeForDisplay(timestamp) {
            const date = new Date(timestamp);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}.${month}.${date.getFullYear()}, ${hours}:${minutes} Uhr`;
        }
        
        // Zeigt Modal mit Alternativen
        function showAlternativeTimesModal(requestedTime, alternatives, bookingData) {
            console.log('ğŸ“‹ Zeige Alternative-Zeiten-Modal');
            
            // Speichere Buchungsdaten fÃ¼r spÃ¤ter
            currentBookingData = bookingData;
            
            // Zeige gewÃ¼nschte Zeit
            document.getElementById('requested-time-display').textContent = 
                formatTimeForDisplay(requestedTime);
            
            // Erstelle Buttons fÃ¼r Alternativen
            const container = document.getElementById('alternative-times-container');
            container.innerHTML = alternatives.map((alt, idx) => `
                <button onclick="selectAlternativeTime(${alt.timestamp})" 
                    style="padding: 15px; background: white; border: 2px solid #10b981; border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                    onmouseover="this.style.background='#d1fae5'" 
                    onmouseout="this.style.background='white'">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <div style="font-weight: 600; font-size: 15px; color: #1f2937;">
                                â° ${alt.formatted}
                            </div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 3px;">
                                ${idx === 0 ? 'FrÃ¼hestmÃ¶glich' : idx === 1 ? 'Komfortabel' : 'Sicherer Puffer'}
                            </div>
                        </div>
                        <div style="font-size: 20px; color: #10b981;">
                            âœ…
                        </div>
                    </div>
                </button>
            `).join('');
            
            // Zeige Modal
            document.getElementById('auto-booking-modal').style.display = 'block';
        }
        
        // User wÃ¤hlt alternative Zeit
        async function selectAlternativeTime(timestamp) {
            const selectedTime = new Date(timestamp).toLocaleString('de-DE');
            console.log('âœ… Alternative Zeit gewÃ¤hlt:', selectedTime);
            
            if (!currentBookingData) {
                alert('ğŸ’¾ Fehler: Buchungsdaten verloren!');
                closeAutoBookingModal();
                return;
            }
            
            // ğŸ†• v5.41.5: BESTÃ„TIGUNG vor Buchung (Patrick's Wunsch!)
            const confirmBooking = confirm(
                'ğŸ“… Alternative Zeit bestÃ¤tigen?\n\n' +
                'â° Neue Abholzeit:\n' + selectedTime + '\n\n' +
                'ğŸ“ Von: ' + currentBookingData.pickup + '\n' +
                'ğŸ¯ Nach: ' + currentBookingData.destination + '\n' +
                (currentBookingData.price ? 'ğŸ’° Preis: ' + currentBookingData.price + 'â‚¬\n' : '') +
                '\nâœ… Jetzt buchen?'
            );
            
            if (!confirmBooking) {
                console.log('ğŸ’¾ Buchung abgebrochen');
                return; // User hat abgebrochen
            }
            
            // Aktualisiere Zeitstempel
            currentBookingData.pickupTimestamp = timestamp;
            currentBookingData.pickupTime = formatTimeForDisplay(timestamp);
            
            console.log('ğŸ“ Buchungsdaten aktualisiert:', {
                pickupTime: currentBookingData.pickupTime,
                pickup: currentBookingData.pickup,
                destination: currentBookingData.destination,
                status: currentBookingData.status,
                customerName: currentBookingData.customerName || 'unbekannt',
                customerPhone: currentBookingData.customerPhone || 'unbekannt'
            });
            
            // Modal schlieÃŸen (ohne Daten zu lÃ¶schen!)
            document.getElementById('auto-booking-modal').style.display = 'none';
            
            // ğŸ†• v5.41.2: TRY-CATCH fÃ¼r besseres Error-Handling!
            try {
                // Buche mit neuer Zeit
                await executeBooking(currentBookingData);
                
                console.log('âœ… Alternative Zeitslot-Buchung erfolgreich!');
                
                // ğŸ”§ v5.39.8: Daten NACH Buchung lÃ¶schen!
                currentBookingData = null;
                
            } catch (error) {
                console.error('ğŸ’¾ FEHLER bei Alternative-Buchung:', error);
                
                // ğŸ†• v5.41.5: Bessere Fehler-Meldung
                const errorMsg = error.message || error.toString();
                alert('ğŸ’¾ Fehler beim Buchen:\n\n' + errorMsg + '\n\nBitte versuche es erneut oder wÃ¤hle eine andere Zeit!');
                
                // Formular wieder anzeigen bei Fehler
                document.getElementById('booking-form').style.display = 'block';
                currentBookingData = null;
            }
        }
        
        // ğŸ†• v5.39.9: Buche mit ORIGINAL-Zeit trotz Konflikt!
        async function bookOriginalTimeAnyway() {
            console.log('âš¡ Trotzdem buchen - Original-Zeit wird verwendet!');
            
            if (!currentBookingData) {
                alert('ğŸ’¾ Fehler: Buchungsdaten verloren!');
                closeAutoBookingModal();
                return;
            }
            
            // Warnung anzeigen
            if (!confirm('âš ï¸ ACHTUNG: Die gewÃ¼nschte Zeit Ã¼berschneidet sich mit einer anderen Fahrt!\n\nWirklich trotzdem buchen?')) {
                return;
            }
            
            // Modal schlieÃŸen
            document.getElementById('auto-booking-modal').style.display = 'none';
            
            // Buche mit ORIGINAL-Zeit (keine Ã„nderung!)
            console.log('ğŸ“… Buche Original-Zeit:', currentBookingData.pickupTime);
            await executeBooking(currentBookingData);
            
            // Daten lÃ¶schen
            currentBookingData = null;
        }
        
        // SchlieÃŸt Modal (ohne Daten zu lÃ¶schen wenn Alternative gewÃ¤hlt!)
        function closeAutoBookingModal() {
            document.getElementById('auto-booking-modal').style.display = 'none';
            // ğŸ”§ v5.39.8: Daten nur lÃ¶schen wenn abgebrochen!
            currentBookingData = null;
        }
        
        // Zeigt Zeitauswahl-Formular
        function showCustomTimeSelection() {
            closeAutoBookingModal();
            
            // ZurÃ¼ck zum Vorbestellen-Bereich
            currentRideType = 'vorbestellen';
            document.getElementById('btn-vorbestellen').style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
            document.getElementById('btn-vorbestellen').style.color = 'white';
            document.getElementById('btn-sofort').style.background = 'white';
            document.getElementById('btn-sofort').style.color = '#059669';
            
            // Zeige Vorbestellen-Container
            document.getElementById('vorbestellen-bereich').style.display = 'block';
            document.getElementById('sofort-bereich').style.display = 'none';
            
            alert('ğŸ’¡ Bitte wÃ¤hle eine andere Zeit und klicke dann auf "Taxi buchen".');
        }
        
        // FÃ¼hrt Buchung aus (ohne erneute PrÃ¼fung)
        // ğŸ†• v5.42.3: SchÃ¶ne BestÃ¤tigungskarte nach Buchung!
        function showBookingSuccessCard(bookingData) {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ‰ ZEIGE BESTÃ„TIGUNGSKARTE!');
            console.log('bookingData:', bookingData);
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            // ğŸ†• v5.42.4: Flag setzen - Karte wird angezeigt!
            showingBookingSuccessCard = true;
            console.log('ğŸš© Flag gesetzt: showingBookingSuccessCard = true');
            
            // PrÃ¼fe ob schon eine Karte existiert
            const existing = document.getElementById('booking-success-modal');
            if (existing) {
                console.log('âš ï¸ Alte Karte gefunden - entferne sie!');
                existing.remove();
            }
            
            // Modal erstellen
            const modal = document.createElement('div');
            modal.id = 'booking-success-modal';
            console.log('ğŸ“¦ Modal erstellt:', modal);
            
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
                backdrop-filter: blur(4px);
            `;
            
            // Pickup-Zeit formatieren
            let pickupTimeDisplay = 'Sofort';
            if (bookingData.pickupTime) {
                try {
                    const dt = new Date(bookingData.pickupTimestamp || bookingData.pickupTime);
                    pickupTimeDisplay = dt.toLocaleString('de-DE', {
                        weekday: 'short',
                        day: '2-digit',
                        month: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    pickupTimeDisplay = bookingData.pickupTime;
                }
            }
            
            // Status-Badge
            const isPreorder = bookingData.status === 'vorbestellt';
            const statusBadge = isPreorder ? 
                '<div style="display:inline-block;background:#10b981;color:white;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600;margin-left:10px;">â° Vorbestellung</div>' :
                '<div style="display:inline-block;background:#667eea;color:white;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600;margin-left:10px;">ğŸš• Sofort</div>';
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 16px;
                    padding: 0;
                    width: 100%;
                    max-width: 500px;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    overflow: hidden;
                    animation: slideUp 0.3s ease-out;
                ">
                    <!-- Header -->
                    <div style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        padding: 30px 20px;
                        text-align: center;
                        color: white;
                    ">
                        <div style="font-size: 60px; margin-bottom: 10px;">âœ…</div>
                        <h2 style="margin: 0 0 5px 0; font-size: 24px; font-weight: 700;">
                            Fahrt erfolgreich gebucht!
                        </h2>
                        ${statusBadge}
                    </div>
                    
                    <!-- Details -->
                    <div style="padding: 25px 20px;">
                        <!-- Abholzeit -->
                        <div style="
                            background: ${isPreorder ? '#f0fdf4' : '#eef2ff'};
                            border-left: 4px solid ${isPreorder ? '#10b981' : '#667eea'};
                            padding: 15px;
                            border-radius: 8px;
                            margin-bottom: 20px;
                        ">
                            <div style="font-size: 12px; color: #666; margin-bottom: 4px; font-weight: 600;">
                                ${isPreorder ? 'â° ABHOLZEIT' : 'ğŸš€ ABHOLUNG'}
                            </div>
                            <div style="font-size: 18px; font-weight: 700; color: ${isPreorder ? '#059669' : '#4c51bf'};">
                                ${pickupTimeDisplay}
                            </div>
                        </div>
                        
                        <!-- Route -->
                        <div style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px;">
                            <!-- Von -->
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <div style="
                                    width: 40px;
                                    height: 40px;
                                    background: #10b981;
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-size: 20px;
                                    flex-shrink: 0;
                                ">ğŸ“</div>
                                <div style="flex: 1; padding-top: 8px;">
                                    <div style="font-size: 11px; color: #999; font-weight: 600; margin-bottom: 2px;">VON</div>
                                    <div style="font-size: 15px; font-weight: 600; color: #333; line-height: 1.4;">
                                        ${bookingData.pickup}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Linie -->
                            <div style="
                                width: 3px;
                                height: 20px;
                                background: linear-gradient(to bottom, #10b981, #667eea);
                                margin-left: 18px;
                                border-radius: 2px;
                            "></div>
                            
                            <!-- Nach -->
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <div style="
                                    width: 40px;
                                    height: 40px;
                                    background: #667eea;
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-size: 20px;
                                    flex-shrink: 0;
                                ">ğŸ¯</div>
                                <div style="flex: 1; padding-top: 8px;">
                                    <div style="font-size: 11px; color: #999; font-weight: 600; margin-bottom: 2px;">NACH</div>
                                    <div style="font-size: 15px; font-weight: 600; color: #333; line-height: 1.4;">
                                        ${bookingData.destination}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Info-Boxen -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                            <!-- Preis -->
                            ${bookingData.price ? `
                            <div style="
                                background: #fef3c7;
                                padding: 12px;
                                border-radius: 8px;
                                text-align: center;
                            ">
                                <div style="font-size: 11px; color: #92400e; font-weight: 600; margin-bottom: 4px;">ğŸ’° PREIS</div>
                                <div style="font-size: 20px; font-weight: 700; color: #b48209;">
                                    ${bookingData.price}â‚¬
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- Passagiere -->
                            <div style="
                                background: #dbeafe;
                                padding: 12px;
                                border-radius: 8px;
                                text-align: center;
                            ">
                                <div style="font-size: 11px; color: #1e40af; font-weight: 600; margin-bottom: 4px;">ğŸ‘¥ PERSONEN</div>
                                <div style="font-size: 20px; font-weight: 700; color: #2563eb;">
                                    ${bookingData.passengers || 1}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hinweis -->
                        <div style="
                            background: #f0f9ff;
                            border: 1px solid #bae6fd;
                            padding: 12px;
                            border-radius: 8px;
                            font-size: 13px;
                            color: #0369a1;
                            line-height: 1.5;
                            margin-bottom: 20px;
                        ">
                            ${isPreorder ? 
                                'â° <strong>Vorbestellung:</strong> Du erhÃ¤ltst eine Benachrichtigung vor der Abholzeit!' :
                                'ğŸ“² <strong>Tracking:</strong> Du erhÃ¤ltst SMS + Telegram mit Live-Tracking!'
                            }
                        </div>
                        
                        <!-- Buttons -->
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button onclick="closeBookingSuccessCard()" style="
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                border: none;
                                padding: 16px;
                                border-radius: 12px;
                                font-size: 16px;
                                font-weight: 700;
                                cursor: pointer;
                                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
                                transition: transform 0.2s;
                            " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                ğŸ‘ OK, verstanden!
                            </button>
                            
                            <div style="text-align: center; font-size: 12px; color: #999; margin-top: 5px;">
                                ğŸ“‹ Deine Buchung findest du im <strong>MenÃ¼ â†’ Mein Verlauf</strong>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Animation CSS
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideUp {
                    from {
                        opacity: 0;
                        transform: translateY(30px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
            `;
            document.head.appendChild(style);
            
            console.log('â• FÃ¼ge Modal zum body hinzu...');
            document.body.appendChild(modal);
            console.log('âœ… Modal hinzugefÃ¼gt!');
            console.log('ğŸ“ Modal im DOM:', document.getElementById('booking-success-modal'));
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        }
        
        // ğŸ†• v5.42.3: SchlieÃŸt BestÃ¤tigungskarte und zeigt Formular
        function closeBookingSuccessCard() {
            console.log('ğŸšª SchlieÃŸe BestÃ¤tigungskarte...');
            
            // ğŸ†• v5.42.4: Flag zurÃ¼cksetzen!
            showingBookingSuccessCard = false;
            console.log('ğŸš© Flag zurÃ¼ckgesetzt: showingBookingSuccessCard = false');
            
            const modal = document.getElementById('booking-success-modal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
            
            // ZurÃ¼ck zur Startseite (Buchungsformular)
            document.getElementById('booking-form').style.display = 'block';
            document.getElementById('ride-status-container').innerHTML = '';
            
            // Formular zurÃ¼cksetzen fÃ¼r neue Buchung
            resetBookingForm();
            
            // Scroll zum Formular
            document.getElementById('booking-form').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
            
            console.log('âœ… ZurÃ¼ck zur Startseite');
        }
        
        async function executeBooking(bookingData) {
            console.log('ğŸ“ FÃ¼hre Buchung aus:', bookingData);
            
            // Firebase speichern
            if (isFirebaseReady) {
                const firebaseRide = { ...bookingData };
                delete firebaseRide.firebaseId;
                
                const newRideRef = await db.ref('rides').push(firebaseRide);
                bookingData.firebaseId = newRideRef.key;
                
                console.log('âœ… In Firebase gespeichert:', bookingData.firebaseId);
            }
            
            // localStorage speichern
            rides.push(bookingData);
            localStorage.setItem('rides', JSON.stringify(rides));
            
            // ğŸ†• v5.41.2: Vorbestellungen AUCH in rideHistory speichern!
            if (bookingData.status === 'vorbestellt') {
                const rideHistory = JSON.parse(localStorage.getItem('rideHistory') || '[]');
                rideHistory.push(bookingData);
                localStorage.setItem('rideHistory', JSON.stringify(rideHistory));
                console.log('ğŸ’¾ Vorbestellung auch in rideHistory gespeichert!');
            }
            
            // ğŸ†• v5.50.5: ERWEITERTER DEBUG fÃ¼r Alternative Zeitslot Telegram!
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ“± TELEGRAM DEBUG - Alternative Zeitslot:');
            console.log('   isFirebaseReady:', isFirebaseReady);
            console.log('   bookingData.firebaseId:', bookingData.firebaseId);
            console.log('   bookingData.id:', bookingData.id);
            console.log('   bookingData.customerName:', bookingData.customerName);
            console.log('   bookingData.customerPhone:', bookingData.customerPhone);
            console.log('   bookingData.pickup:', bookingData.pickup);
            console.log('   bookingData.destination:', bookingData.destination);
            console.log('   bookingData.price:', bookingData.price);
            console.log('   bookingData.status:', bookingData.status);
            console.log('   bookingData.pickupTime:', bookingData.pickupTime);
            console.log('   bookingData.pickupTimestamp:', bookingData.pickupTimestamp);
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            // Telegram senden - MIT ALLEN DATEN!
            if (isFirebaseReady) {
                console.log('âœ… Firebase bereit - sende Telegram...');
                console.log('ğŸ’¾ Rufe sendTelegramForNewRide() auf mit:', {
                    firebaseId: bookingData.firebaseId,
                    customerName: bookingData.customerName,
                    pickup: bookingData.pickup,
                    destination: bookingData.destination,
                    status: bookingData.status
                });
                
                try {
                    await sendTelegramForNewRide(bookingData);
                    console.log('âœ… Telegram gesendet!');
                } catch (error) {
                    console.error('ğŸ’¾ TELEGRAM-FEHLER:', error);
                    console.error('   Error Message:', error.message);
                    console.error('   Error Stack:', error.stack);
                }
                
                try {
                    await sendCustomerNotifications(bookingData);
                    console.log('âœ… Kunden-Benachrichtigungen gesendet!');
                } catch (error) {
                    console.error('ğŸ’¾ KUNDEN-NOTIFICATION-FEHLER:', error);
                }
            } else {
                console.error('ğŸ’¾ Firebase NICHT bereit - KEIN Telegram!');
                console.error('   isFirebaseReady:', isFirebaseReady);
                console.error('   db:', typeof db);
            }
            
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ’¾ RUFE showBookingSuccessCard() auf...');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            // ğŸ†• v5.42.3: BestÃ¤tigung zeigen - SCHÃ–NE KARTE statt Alert!
            showBookingSuccessCard(bookingData);
            
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('âœ… showBookingSuccessCard() fertig!');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            // Formular verstecken (wird von Card wieder angezeigt beim OK-Klick)
            document.getElementById('booking-form').style.display = 'none';
            
            // Bei Sofort-Fahrten: Fahrt-Status vorbereiten
            if (bookingData.status !== 'vorbestellt') {
                if (isFirebaseReady) listenToMyRide(bookingData.firebaseId);
            }
            
            // Auto-Assignment fÃ¼r Sofort-Fahrten
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ” AUTO-ASSIGN DEBUG:');
            console.log('   isFirebaseReady:', isFirebaseReady);
            console.log('   bookingData.firebaseId:', bookingData.firebaseId);
            console.log('   bookingData.status:', bookingData.status);
            console.log('   BEDINGUNG erfÃ¼llt?', isFirebaseReady && bookingData.firebaseId && bookingData.status === 'new');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            if (isFirebaseReady && bookingData.firebaseId && bookingData.status === 'new') {
                console.log('âœ… RUFE startAutoAssignment AUF!');
                startAutoAssignment(bookingData.firebaseId, bookingData);
            } else {
                console.log('ğŸ’¾ AUTO-ASSIGN WIRD NICHT AUFGERUFEN!');
                if (!isFirebaseReady) console.log('   â†’ Firebase nicht bereit!');
                if (!bookingData.firebaseId) console.log('   â†’ Keine Firebase ID!');
                if (bookingData.status !== 'new') console.log('   â†’ Status ist:', bookingData.status, '(erwartet: new)');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // ğŸ†• v5.42.4: Flag um BestÃ¤tigungskarte zu schÃ¼tzen
        let showingBookingSuccessCard = false;

        // ğŸ†• v5.31.1: Track letzten Status um unnÃ¶tige UI-Updates zu vermeiden
        let lastRideStatus = null;
        let lastRideDriverLocation = null;
        
        function listenToMyRide(rideId) {
            if (!isFirebaseReady) return;
            
            // ğŸ†• v5.20.7: Nicht zuhÃ¶ren wenn kÃ¼rzlich storniert!
            if (recentlyCancelledRideIds && recentlyCancelledRideIds.has(rideId)) {
                console.log('ğŸ›¡ï¸ HÃ¶re NICHT auf stornierte Fahrt:', rideId);
                return;
            }
            
            console.log('ğŸ‘‚ HÃ¶re auf Ã„nderungen fÃ¼r Fahrt:', rideId);
            
            db.ref('rides/' + rideId).on('value', (s) => {
                // ğŸ†• v5.20.7: Nochmal prÃ¼fen bei jedem Update!
                if (recentlyCancelledRideIds && recentlyCancelledRideIds.has(rideId)) {
                    console.log('ğŸ›¡ï¸ Ignoriere Update fÃ¼r stornierte Fahrt:', rideId);
                    db.ref('rides/' + rideId).off();
                    return;
                }
                
                const ride = s.val();
                if (ride) {
                    ride.firebaseId = rideId;
                    
                    // ğŸ¯ FIX: PrÃ¼fe ob Fahrt schon abgeschlossen/storniert ist!
                    // ğŸ†• Auch 'cancelled' und 'cancelled_pending_driver' prÃ¼fen
                    const endedStatuses = ['storniert', 'completed', 'cancelled', 'cancelled_pending_driver'];
                    if (endedStatuses.includes(ride.status)) {
                        console.log('âœ… Fahrt ist beendet:', ride.status);
                        
                        // ğŸ†• v5.26.14f: REALTIME FIX - Speichere beendete Fahrt in Verlauf!
                        console.log('ğŸ’¾ Speichere Fahrt in Verlauf...');
                        const rideHistory = JSON.parse(localStorage.getItem('rideHistory') || '[]');
                        
                        // PrÃ¼fe ob schon vorhanden (dedupliziere)
                        const existingIndex = rideHistory.findIndex(r => r.id === ride.id || r.firebaseId === rideId);
                        if (existingIndex >= 0) {
                            // Aktualisiere bestehende Fahrt
                            rideHistory[existingIndex] = ride;
                            console.log('âœ… Fahrt aktualisiert in Verlauf');
                        } else {
                            // FÃ¼ge neue Fahrt hinzu
                            rideHistory.push(ride);
                            console.log('âœ… Fahrt hinzugefÃ¼gt zu Verlauf');
                        }
                        
                        localStorage.setItem('rideHistory', JSON.stringify(rideHistory));
                        
                        // ğŸ”„ Update History-View sofort!
                        if (currentView === 'history') {
                            updateHistoryView();
                        }
                        
                        localStorage.removeItem('myCurrentRideId');
                        myCurrentRide = null;
                        lastRideStatus = null;  // Reset!
                        lastRideDriverLocation = null;
                        document.getElementById('booking-form').style.display = 'block';
                        document.getElementById('ride-status-container').innerHTML = '';
                        // ğŸ†• Formular zurÃ¼cksetzen
                        resetBookingForm();
                        // Stoppe Listener
                        db.ref('rides/' + rideId).off();
                        return;
                    }
                    
                    myCurrentRide = ride;
                    
                    // ğŸ†• v5.31.1: SMART UPDATE - nur bei RELEVANTEN Ã„nderungen!
                    const statusChanged = lastRideStatus !== ride.status;
                    const driverLocationChanged = JSON.stringify(lastRideDriverLocation) !== JSON.stringify(ride.driverLocation);
                    
                    if (statusChanged) {
                        console.log('ğŸ”„ Status geÃ¤ndert:', lastRideStatus, 'â†’', ride.status);
                        lastRideStatus = ride.status;
                        
                        // ğŸ†• v5.42.4: NICHT Ã¼berschreiben wenn BestÃ¤tigungskarte angezeigt wird!
                        if (showingBookingSuccessCard) {
                            console.log('ğŸ›¡ï¸ BestÃ¤tigungskarte wird angezeigt - KEIN showRideStatus()!');
                            return;
                        }
                        
                        // ğŸ¯ Status-Ã„nderung â†’ VOLLSTÃ„NDIGES UI-Update
                        document.getElementById('booking-form').style.display = 'none';
                        showRideStatus(ride);
                    } else if (driverLocationChanged && ride.status === 'accepted') {
                        console.log('ğŸ“ GPS-Update (kein Status-Change)');
                        lastRideDriverLocation = ride.driverLocation;
                        
                        // ğŸ—ºï¸ NUR Karte updaten, NICHT ganzes UI!
                        if (map && taxiMarker && ride.driverLocation) {
                            taxiMarker.setLatLng([ride.driverLocation.lat, ride.driverLocation.lon]);
                            
                            // Update ETA
                            if (ride.estimatedArrival) {
                                const etaEl = document.getElementById('eta-display');
                                if (etaEl) {
                                    const now = Date.now();
                                    const eta = ride.estimatedArrival;
                                    const minutesLeft = Math.max(0, Math.round((eta - now) / 60000));
                                    etaEl.innerHTML = `<strong>â±ï¸ Ankunft in ca. ${minutesLeft} Min</strong>`;
                                }
                            }
                        }
                    } else {
                        console.log('â­ï¸ Keine relevante Ã„nderung - kein UI-Update');
                    }
                } else {
                    // Fahrt existiert nicht mehr (wurde gelÃ¶scht)
                    console.log('âš ï¸ Fahrt existiert nicht mehr:', rideId);
                    localStorage.removeItem('myCurrentRideId');
                    myCurrentRide = null;
                    lastRideStatus = null;
                    lastRideDriverLocation = null;
                    document.getElementById('booking-form').style.display = 'block';
                    document.getElementById('ride-status-container').innerHTML = '';
                }
            });
        }

        // ğŸ›¡ï¸ Schutz gegen Doppelklick
        let cancelInProgress = false;
        
        // ğŸ†• v5.20.7: Set fÃ¼r kÃ¼rzlich stornierte Fahrten (verhindert Wieder-Anzeige)
        const recentlyCancelledRideIds = new Set();
        
        // ğŸ†• v5.21.9: PERSISTENT Set fÃ¼r bereits angezeigte Stornierung-Alarme
        function loadShownCancelAlarms() {
            try {
                const stored = localStorage.getItem('shownCancelAlarmIds');
                if (stored) {
                    const data = JSON.parse(stored);
                    // LÃ¶sche EintrÃ¤ge Ã¤lter als 7 Tage
                    const now = Date.now();
                    const sevenDays = 7 * 24 * 60 * 60 * 1000;
                    Object.keys(data).forEach(key => {
                        if (now - data[key] > sevenDays) {
                            delete data[key];
                        }
                    });
                    localStorage.setItem('shownCancelAlarmIds', JSON.stringify(data));
                    return data;
                }
            } catch (e) {
                console.error('ğŸ’¾ Fehler beim Laden von shownCancelAlarmIds:', e);
            }
            return {};
        }
        
        function saveShownCancelAlarm(rideId) {
            try {
                const data = loadShownCancelAlarms();
                data[rideId] = Date.now();
                localStorage.setItem('shownCancelAlarmIds', JSON.stringify(data));
                console.log('âœ… Stornierung-Alarm gespeichert:', rideId);
            } catch (e) {
                console.error('ğŸ’¾ Fehler beim Speichern von shownCancelAlarmIds:', e);
            }
        }
        
        function hasShownCancelAlarm(rideId) {
            const data = loadShownCancelAlarms();
            return !!data[rideId];
        }
        
        // Initialisiere beim App-Start
        console.log('ğŸ“¦ Lade gespeicherte Stornierung-Alarme...');
        loadShownCancelAlarms();
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ”‹ BATTERIE-SPAR-SYSTEM - VERSION 5.23.0
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const PowerSaveManager = {
            mode: 'NORMAL', // NORMAL, ECO, POWER_SAVE
            autoTimer: null,
            warningTimer: null,
            lastActivity: Date.now(),
            batteryLevel: 100,
            isMobile: /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent),
            isNativeApp: window.Capacitor && window.Capacitor.isNativePlatform(),
            
            // Modi-Konfiguration
            modes: {
                NORMAL: {
                    name: 'Normal',
                    screenBrightness: 1.0,
                    gpsInterval: 10, // Meter
                    icon: 'â˜€ï¸',
                    color: '#10b981'
                },
                ECO: {
                    name: 'Eco',
                    screenBrightness: 0.6,
                    gpsInterval: 30,
                    icon: 'ğŸŒ¤ï¸',
                    color: '#f59e0b'
                },
                POWER_SAVE: {
                    name: 'Power Save',
                    screenBrightness: 0.1,
                    gpsInterval: 50,
                    icon: 'ğŸ’¤',
                    color: '#6366f1'
                }
            },
            
            init: function() {
                console.log('ğŸ”‹ Initialisiere Batterie-Spar-System...');
                console.log(`ğŸ“± Platform: ${this.isMobile ? 'Mobile' : 'Desktop'} | Native App: ${this.isNativeApp ? 'Ja' : 'Nein'}`);
                
                // Hinweis bei Desktop
                if (!this.isMobile) {
                    console.log('ğŸ’» Desktop erkannt - Dark Mode & Screen Dimming deaktiviert (nur GPS-Intervall aktiv)');
                }
                
                // Batterie-Level abfragen (wenn verfÃ¼gbar)
                if ('getBattery' in navigator) {
                    navigator.getBattery().then(battery => {
                        this.batteryLevel = Math.round(battery.level * 100);
                        battery.addEventListener('levelchange', () => {
                            this.batteryLevel = Math.round(battery.level * 100);
                            this.updateBatteryDisplay();
                        });
                        this.updateBatteryDisplay();
                    });
                }
                
                // UI erstellen
                this.createUI();
                
                // Auto-Timer starten wenn Fahrer online geht
                this.startAutoTimer();
                
                console.log('âœ… Batterie-Spar-System bereit');
            },
            
            createUI: function() {
                // Power-Save Button in driver-top-bar einfÃ¼gen
                const topBar = document.getElementById('driver-top-bar');
                if (!topBar) return;
                
                // âš ï¸ DUPLIKAT-CHECK: Nicht nochmal erstellen wenn schon da!
                if (document.getElementById('battery-display')) {
                    console.log('âš ï¸ UI bereits erstellt - Ã¼berspringe');
                    return;
                }
                
                // Batterie-Anzeige
                const batteryDisplay = document.createElement('div');
                batteryDisplay.id = 'battery-display';
                batteryDisplay.style.cssText = `
                    display: flex;
                    align-items: center;
                    gap: 4px;
                    padding: 4px 8px;
                    background: rgba(16,185,129,0.1);
                    border-radius: 12px;
                    font-size: 11px;
                    color: #10b981;
                    font-weight: bold;
                    margin-left: auto;
                `;
                batteryDisplay.innerHTML = 'ğŸ”‹ 100%';
                topBar.appendChild(batteryDisplay);
                
                // Power-Save Button
                const powerButton = document.createElement('button');
                powerButton.id = 'power-save-btn';
                powerButton.style.cssText = `
                    background: #10b981;
                    color: white;
                    border: none;
                    padding: 6px 12px;
                    border-radius: 20px;
                    font-weight: bold;
                    cursor: pointer;
                    font-size: 13px;
                    display: flex;
                    align-items: center;
                    gap: 4px;
                `;
                powerButton.innerHTML = 'â˜€ï¸ Normal';
                powerButton.onclick = () => this.cyclePowerMode();
                topBar.appendChild(powerButton);
                
                // Settings-Button
                const settingsBtn = document.createElement('button');
                settingsBtn.id = 'settings-btn';
                settingsBtn.style.cssText = `
                    background: #6b7280;
                    color: white;
                    border: none;
                    padding: 6px 12px;
                    border-radius: 20px;
                    font-weight: bold;
                    cursor: pointer;
                    font-size: 13px;
                    display: flex;
                    align-items: center;
                    gap: 4px;
                `;
                settingsBtn.innerHTML = 'âš™ï¸';
                settingsBtn.onclick = () => DriverSettingsManager.showSettingsDialog();
                topBar.appendChild(settingsBtn);
                
                // Warnung-Overlay (versteckt)
                const warning = document.createElement('div');
                warning.id = 'power-save-warning';
                warning.style.cssText = `
                    display: none;
                    position: fixed;
                    top: 60px;
                    left: 50%;
                    transform: translateX(-50%);
                    z-index: 9999;
                    background: #fef3c7;
                    border: 2px solid #f59e0b;
                    border-radius: 12px;
                    padding: 16px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    max-width: 300px;
                    text-align: center;
                `;
                warning.innerHTML = `
                    <div style="font-size: 24px; margin-bottom: 8px;">âš¡</div>
                    <div style="font-weight: bold; margin-bottom: 8px;">Power-Save in <span id="countdown">30</span> Sek</div>
                    <div style="font-size: 12px; color: #92400e; margin-bottom: 12px;">Screen wird gedimmt, GPS verlangsamt</div>
                    <button onclick="PowerSaveManager.cancelAuto()" style="
                        background: white;
                        border: 2px solid #f59e0b;
                        color: #f59e0b;
                        padding: 8px 16px;
                        border-radius: 8px;
                        font-weight: bold;
                        cursor: pointer;
                    ">Abbrechen</button>
                `;
                document.body.appendChild(warning);
            },
            
            cyclePowerMode: function() {
                // Modus wechseln: NORMAL â†’ ECO â†’ POWER_SAVE â†’ NORMAL
                const modes = ['NORMAL', 'ECO', 'POWER_SAVE'];
                const currentIndex = modes.indexOf(this.mode);
                const nextMode = modes[(currentIndex + 1) % modes.length];
                
                this.setMode(nextMode, 'manual');
            },
            
            setMode: function(mode, trigger = 'manual') {
                if (!this.modes[mode]) return;
                
                this.mode = mode;
                const config = this.modes[mode];
                
                console.log(`ğŸ”‹ Power-Save Modus: ${config.name} (${trigger}) | Platform: ${this.isMobile ? 'Mobile' : 'Desktop'}`);
                
                // Screen Brightness anpassen (nur auf Mobile!)
                if (this.isMobile) {
                    this.setScreenBrightness(config.screenBrightness);
                } else {
                    console.log('ğŸ’» Desktop erkannt - Screen Brightness Ã¼bersprungen');
                }
                
                // GPS-Intervall anpassen (wird beim nÃ¤chsten GPS-Update angewendet)
                window.currentGPSInterval = config.gpsInterval;
                
                // UI updaten
                const btn = document.getElementById('power-save-btn');
                if (btn) {
                    btn.innerHTML = `${config.icon} ${config.name}`;
                    btn.style.background = config.color;
                }
                
                // Dark Mode bei POWER_SAVE (nur auf Mobile!)
                if (mode === 'POWER_SAVE' && this.isMobile) {
                    this.enableDarkMode();
                } else {
                    this.disableDarkMode();
                }
                
                // Log Activity
                logActivity('system', 'power_mode', `Power-Modus: ${config.name}`, {
                    mode: mode,
                    trigger: trigger,
                    brightness: config.screenBrightness,
                    gpsInterval: config.gpsInterval,
                    platform: this.isMobile ? 'mobile' : 'desktop'
                });
            },
            
            setScreenBrightness: function(level) {
                // Nur auf Mobile!
                if (!this.isMobile) {
                    return; // Ãœberspringe auf Desktop
                }
                
                // CSS Filter fÃ¼r Helligkeit
                const driverView = document.getElementById('driver-view');
                if (driverView) {
                    driverView.style.filter = `brightness(${level})`;
                    console.log(`ğŸ’¡ Screen Brightness: ${Math.round(level * 100)}% (Mobile)`);
                }
                
                // Native Screen Brightness (wenn verfÃ¼gbar)
                if (window.ScreenBrightness) {
                    window.ScreenBrightness.setBrightness(level);
                }
            },
            
            enableDarkMode: function() {
                // Nur auf Mobile aktivieren!
                if (!this.isMobile) {
                    console.log('ğŸ’» Dark Mode Ã¼bersprungen (Desktop)');
                    return;
                }
                
                const style = document.getElementById('dark-mode-style');
                if (style) return; // Bereits aktiv
                
                const darkStyle = document.createElement('style');
                darkStyle.id = 'dark-mode-style';
                darkStyle.textContent = `
                    /* ğŸŒ™ v5.31.4: SCHÃ–NER DARK MODE (nicht mehr komplett schwarz!) */
                    
                    #driver-view {
                        background: linear-gradient(135deg, #1a1d29 0%, #0f1419 100%) !important;
                        color: #e5e7eb !important;
                        transition: background 0.5s ease, color 0.3s ease;
                    }
                    
                    #driver-view .view {
                        background: transparent !important;
                    }
                    
                    #driver-top-bar {
                        background: rgba(15, 20, 25, 0.95) !important;
                        color: #e5e7eb !important;
                        backdrop-filter: blur(10px);
                        border-bottom: 1px solid rgba(102, 126, 234, 0.3);
                    }
                    
                    /* Buttons schÃ¶ner */
                    #driver-view button:not(#power-save-btn):not([style*="background:#10b981"]) {
                        background: linear-gradient(135deg, #374151 0%, #1f2937 100%) !important;
                        color: #e5e7eb !important;
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                    }
                    
                    /* GrÃ¼ne Buttons bleiben grÃ¼n! */
                    #driver-view button[style*="background:#10b981"],
                    #driver-view button[style*="background: #10b981"] {
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
                        color: white !important;
                        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                    }
                    
                    /* Texte besser lesbar */
                    #driver-view h3,
                    #driver-view h4 {
                        color: #f3f4f6 !important;
                    }
                    
                    #driver-view .status-text {
                        color: #d1d5db !important;
                    }
                    
                    /* Karten-Overlays dunkler */
                    #driver-view .leaflet-container {
                        filter: brightness(0.8) saturate(0.9);
                    }
                    
                    /* Smooth Transitions fÃ¼r alles */
                    #driver-view * {
                        transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
                    }
                `;
                document.head.appendChild(darkStyle);
                console.log('ğŸŒ™ Dark Mode aktiviert (SCHÃ–N!)');
            },
            
            disableDarkMode: function() {
                const style = document.getElementById('dark-mode-style');
                if (style) {
                    style.remove();
                    console.log('â˜€ï¸ Dark Mode deaktiviert');
                }
            },
            
            startAutoTimer: function() {
                // Stoppe bestehende Timer
                this.cancelAuto();
                
                // PrÃ¼fe alle 10 Sekunden
                this.autoTimer = setInterval(() => {
                    // Nur wenn Fahrer FREI ist (online, kein aktueller Auftrag)
                    if (!isOnline || !currentVehicle || myCurrentRide) {
                        return;
                    }
                    
                    // Nur wenn NICHT bereits in Power-Save
                    if (this.mode === 'POWER_SAVE') return;
                    
                    // PrÃ¼fe InaktivitÃ¤t
                    const inactiveMinutes = (Date.now() - this.lastActivity) / 60000;
                    
                    // Nach 4.5 Min: Zeige Warnung (30 Sek Countdown)
                    if (inactiveMinutes >= 4.5 && !this.warningTimer) {
                        this.showAutoWarning();
                    }
                }, 10000);
            },
            
            showAutoWarning: function() {
                console.log('âš ï¸ Auto Power-Save Warnung');
                
                const warning = document.getElementById('power-save-warning');
                if (!warning) return;
                
                warning.style.display = 'block';
                let countdown = 30;
                
                this.warningTimer = setInterval(() => {
                    countdown--;
                    const countdownEl = document.getElementById('countdown');
                    if (countdownEl) countdownEl.textContent = countdown;
                    
                    if (countdown <= 0) {
                        this.activateAutoPowerSave();
                    }
                }, 1000);
            },
            
            activateAutoPowerSave: function() {
                this.cancelAuto();
                const warning = document.getElementById('power-save-warning');
                if (warning) warning.style.display = 'none';
                
                console.log('ğŸ”‹ Auto Power-Save aktiviert');
                this.setMode('POWER_SAVE', 'auto');
            },
            
            cancelAuto: function() {
                if (this.warningTimer) {
                    clearInterval(this.warningTimer);
                    this.warningTimer = null;
                }
                
                const warning = document.getElementById('power-save-warning');
                if (warning) warning.style.display = 'none';
                
                // Reset Activity
                this.resetActivity();
            },
            
            resetActivity: function() {
                this.lastActivity = Date.now();
                
                // Wenn in Power-Save und User ist aktiv â†’ zurÃ¼ck zu Normal
                if (this.mode === 'POWER_SAVE') {
                    this.setMode('NORMAL', 'user_activity');
                }
            },
            
            updateBatteryDisplay: function() {
                const display = document.getElementById('battery-display');
                if (!display) return;
                
                const level = this.batteryLevel;
                let color = '#10b981'; // GrÃ¼n
                let icon = 'ğŸ”‹';
                
                if (level <= 20) {
                    color = '#ef4444';
                    icon = 'ğŸª«';
                } else if (level <= 50) {
                    color = '#f59e0b';
                    icon = 'ğŸ”‹';
                }
                
                display.style.color = color;
                display.style.background = `rgba(${color === '#ef4444' ? '239,68,68' : color === '#f59e0b' ? '245,158,11' : '16,185,129'},0.1)`;
                display.innerHTML = `${icon} ${level}%`;
            },
            
            // Bei neuem Auftrag: ZurÃ¼ck zu NORMAL
            onNewRide: function() {
                if (this.mode !== 'NORMAL') {
                    console.log('ğŸ“± Neuer Auftrag â†’ Normal Modus');
                    this.setMode('NORMAL', 'new_ride');
                }
                this.resetActivity();
            }
        };
        
        // Initialisiere Batterie-System beim App-Start
        setTimeout(() => {
            if (currentView === 'driver') {
                PowerSaveManager.init();
            }
        }, 1000);
        
        // AktivitÃ¤t-Tracking (bei jedem Touch)
        document.addEventListener('touchstart', () => {
            if (currentView === 'driver') {
                PowerSaveManager.resetActivity();
            }
        });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function cancelRideConfirm(rideId) {
            // ğŸ›¡ï¸ Verhindere Doppelklick
            if (cancelInProgress) {
                console.log('â³ Stornierung lÃ¤uft bereits...');
                return;
            }
            cancelInProgress = true;
            
            const ride = myCurrentRide;
            
            // ğŸ†• v5.87.58: STORNO-SCHUTZ fÃ¼r Hotel-Fahrten! ğŸ”’
            if (ride && ride.hotelCalendarId) {
                const hotelName = ride.hotelName || 'Hotel';
                alert(
                    `ğŸ”’ HOTEL-FAHRT GESCHÃœTZT!\n\n` +
                    `ğŸ¨ Diese Fahrt wurde vom ${hotelName} gebucht.\n\n` +
                    `âš ï¸ Hotel-Fahrten kÃ¶nnen NICHT Ã¼ber die App\n` +
                    `storniert werden!\n\n` +
                    `ğŸ’¡ Bitte kontaktiere das Hotel direkt:\n` +
                    `ğŸ’¾ ${ride.customerPhone || '(Telefonnummer nicht verfÃ¼gbar)'}`
                );
                console.log('ğŸ”’ Hotel-Fahrt Stornierung BLOCKIERT!');
                cancelInProgress = false;
                return;
            }
            
            let confirmMessage = 'ğŸ—‘ï¸ Fahrt wirklich stornieren?\n\nDie Buchung wird gelÃ¶scht.';
            let hasCancellationFee = false;
            
            // ğŸ†• v5.26.13: PROZENTUALE StornogebÃ¼hr (15% vom Fahrpreis)
            const cancellationPercentage = 15; // 15% StornogebÃ¼hr
            const cancellationFee = ride ? (parseFloat(ride.price) * cancellationPercentage / 100) : 0;
            
            // ğŸ†• NEUE REGEL: 60 Minuten vor Abholzeit = kostenpflichtig
            if (ride) {
                const now = Date.now();
                // Abholzeit: pickupTimestamp oder bei Sofort-Fahrten: createdAt
                const pickupTime = ride.pickupTimestamp || ride.createdAt || now;
                const minutesUntilPickup = (pickupTime - now) / 60000;
                
                console.log('â° Minuten bis Abholung:', Math.round(minutesUntilPickup));
                console.log('ğŸ’° Fahrpreis:', ride.price + 'â‚¬');
                console.log('ğŸ“± StornogebÃ¼hr (15%):', cancellationFee.toFixed(2) + 'â‚¬');
                
                if (minutesUntilPickup <= 60) {
                    // WENIGER ALS 60 MINUTEN - KOSTENPFLICHTIG!
                    hasCancellationFee = true;
                    
                    if (minutesUntilPickup <= 0) {
                        // Sofort-Fahrt oder Abholzeit schon vorbei
                        confirmMessage = 'âš ï¸ KOSTENPFLICHTIGE STORNIERUNG!\n\n' +
                            'ğŸ’¶ StornogebÃ¼hr: ' + cancellationFee.toFixed(2) + 'â‚¬ (' + cancellationPercentage + '% vom Fahrpreis)\n' +
                            '(Wird bei nÃ¤chster Fahrt berechnet)\n\n' +
                            'Trotzdem stornieren?\n\n' +
                            '(Kostenlos stornieren: 038378 / 1234)';
                    } else {
                        confirmMessage = 'âš ï¸ KOSTENPFLICHTIGE STORNIERUNG!\n\n' +
                            'Abholung in ' + Math.round(minutesUntilPickup) + ' Minuten.\n' +
                            '(Kostenlos bis 60 Min. vorher)\n\n' +
                            'ğŸ’¶ StornogebÃ¼hr: ' + cancellationFee.toFixed(2) + 'â‚¬ (' + cancellationPercentage + '% vom Fahrpreis)\n' +
                            '(Wird bei nÃ¤chster Fahrt berechnet)\n\n' +
                            'Trotzdem stornieren?\n\n' +
                            '(Kostenlos stornieren: 038378 / 1234)';
                    }
                } else {
                    // MEHR ALS 60 MINUTEN - KOSTENLOS
                    confirmMessage = 'ğŸ—‘ï¸ Fahrt stornieren?\n\n' +
                        'Abholung in ' + Math.round(minutesUntilPickup) + ' Minuten.\n\n' +
                        'âœ… Stornierung ist kostenlos.\n' +
                        '(Bis 60 Min. vor Abholung)';
                }
            }
            
            const confirmed = confirm(confirmMessage);
            
            if (!confirmed) {
                cancelInProgress = false; // Reset bei Abbruch
                return;
            }
            
            // StornogebÃ¼hr speichern
            if (hasCancellationFee) {
                const cancellation = {
                    rideId: ride.id,
                    customerName: ride.customerName,
                    pickup: ride.pickup,
                    destination: ride.destination,
                    originalPrice: ride.price,
                    cancellationFee: cancellationFee,
                    cancelledAt: Date.now(),
                    reason: 'less_than_60min_before_pickup'
                };
                
                // Speichere Stornierung in Firebase
                if (isFirebaseReady) {
                    await db.ref('cancellations').push(cancellation);
                    console.log('ğŸ’¶ StornogebÃ¼hr gespeichert:', cancellationFee + 'â‚¬');
                }
            }
            
            // ğŸ†• VEREINFACHT: Direkt auf 'cancelled' setzen - Fahrer wird nur benachrichtigt, muss nicht bestÃ¤tigen
            if (isFirebaseReady && rideId) {
                // ğŸ†• v5.20.7: SOFORT zur cancelled-Liste hinzufÃ¼gen BEVOR alles andere!
                recentlyCancelledRideIds.add(rideId);
                console.log('ğŸ›¡ï¸ Ride-ID zu cancelled-Set hinzugefÃ¼gt:', rideId);
                
                // ğŸ†• v5.20.4: ZUERST alle Listener stoppen!
                db.ref('rides/' + rideId).off();
                console.log('ğŸ›‘ Listener fÃ¼r Fahrt gestoppt:', rideId);
                
                // ğŸ†• v5.20.4: TELEGRAM AN FAHRER BEI STORNIERUNG!
                if (ride && ride.assignedTo) {
                    console.log('ğŸ“± Versuche Stornierung-Telegram zu senden an:', ride.assignedTo);
                    
                    const cancelMessage = `ğŸš« <b>FAHRT STORNIERT!</b>\n\n` +
                        `ğŸ’¾ Kunde: ${ride.customerName}\n` +
                        `ğŸ“ Von: ${ride.pickup}\n` +
                        `ğŸ¯ Nach: ${ride.destination}\n` +
                        `ğŸ’° Preis: ${ride.price}â‚¬\n\n` +
                        `ğŸ’¾ Der Kunde hat die Fahrt storniert.` +
                        (hasCancellationFee ? `\nğŸ’¶ StornogebÃ¼hr: ${cancellationFee}â‚¬` : '');
                    
                    // ğŸ†• v5.20.9: Mit await und besserem Error-Handling!
                    try {
                        const telegramSuccess = await sendTelegramToDriverCancel(ride.assignedTo, cancelMessage);
                        if (telegramSuccess) {
                            console.log('âœ… Stornierung-Telegram erfolgreich gesendet!');
                        } else {
                            console.log('âš ï¸ Stornierung-Telegram konnte nicht gesendet werden');
                        }
                    } catch (telegramError) {
                        console.error('ğŸ’¾ Telegram Fehler:', telegramError);
                    }
                } else {
                    console.log('â„¹ï¸ Keine assignedTo fÃ¼r Telegram - Fahrt war nicht zugewiesen');
                }
                
                await updateRide(rideId, {
                    status: 'cancelled',  // ğŸ†• Immer direkt cancelled!
                    cancelledAt: Date.now(),
                    cancelledBy: 'passenger',
                    cancellationFee: cancellationFee,
                    cancellationReason: hasCancellationFee ? 'Fahrer bereits unterwegs - StornogebÃ¼hr' : 'Kunde storniert'
                });
                console.log('ğŸ’¾ Fahrt storniert in Firebase:', rideId);
                
                // ğŸ†• v5.20.0: Stoppe auch den Assignment-Timer falls aktiv!
                if (assignmentTimers && assignmentTimers[rideId]) {
                    clearTimeout(assignmentTimers[rideId]);
                    delete assignmentTimers[rideId];
                    console.log('ğŸ›‘ Assignment-Timer gestoppt fÃ¼r:', rideId);
                }
                
                // ğŸ“œ PROTOKOLL: Stornierung
                logActivity('status', 'cancelled', `Fahrt storniert${hasCancellationFee ? ' (GebÃ¼hr: ' + cancellationFee + 'â‚¬)' : ''}`, {
                    customer: ride?.customerName,
                    from: ride?.pickup,
                    to: ride?.destination,
                    price: ride?.price,
                    fee: hasCancellationFee ? cancellationFee : 0,
                    driver: ride?.assignedTo
                });
            }
            
            // ğŸ†• v5.20.4: Globale rides-Listener kurz pausieren und neu starten
            // um sicherzustellen dass die stornierte Fahrt nicht wieder angezeigt wird
            
            // âœ… Update auch localStorage!
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            const localRide = history.find(r => r.firebaseId === rideId || r.id === rideId);
            if (localRide) {
                localRide.status = 'cancelled';  // ğŸ†• Immer direkt cancelled
                localRide.cancelledAt = Date.now();
                localRide.cancellationFee = cancellationFee;
                localStorage.setItem('rideHistory', JSON.stringify(history));
                console.log('âœ… Fahrt in localStorage storniert');
            }
            
            // Lokalen Status zurÃ¼cksetzen
            localStorage.removeItem('myCurrentRideId');
            myCurrentRide = null;
            document.getElementById('ride-status-container').innerHTML = '';
            document.getElementById('booking-form').style.display = 'block';
            
            // ğŸ†• FORMULAR ZURÃœCKSETZEN nach Stornierung
            resetBookingForm();
            
            if (hasCancellationFee) {
                alert('âœ… Fahrt storniert!\n\nğŸ’¶ StornogebÃ¼hr: ' + cancellationFee.toFixed(2) + 'â‚¬\n\nWird bei deiner nÃ¤chsten Fahrt berechnet.');
            } else {
                alert('âœ… Fahrt storniert!');
            }
            
            // ğŸ›¡ï¸ Reset Doppelklick-Schutz
            cancelInProgress = false;
        }

        // ğŸ†• v5.90.187: WHATSAPP SHARE FÃœR FAHRTEN! ğŸ’¬
        function shareRideViaWhatsApp(ride) {
            console.log('ğŸ’¬ Teile Fahrt via WhatsApp:', ride);
            
            // Formatiere Zeitstempel
            const pickupTime = ride.pickupTimestamp 
                ? new Date(ride.pickupTimestamp).toLocaleString('de-DE', {
                    weekday: 'short',
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })
                : 'Sofort';
            
            // Erstelle schÃ¶ne WhatsApp Nachricht
            const message = `ğŸš• *TAXI-FAHRT*

ğŸ“… *Datum:* ${pickupTime}

ğŸ’¾ *Kunde:*
${ride.customerName || 'Unbekannt'}
ğŸ’¾ ${ride.customerPhone || 'Keine Nummer'}

ğŸ“ *Route:*
Von: ${ride.pickup || 'Unbekannt'}
Nach: ${ride.destination || 'Unbekannt'}

${ride.price ? `ğŸ’° *Preis:* ${ride.price}â‚¬` : ''}
${ride.distance ? `ğŸ“ *Distanz:* ${ride.distance} km` : ''}

${ride.vehicle ? `ğŸš— *Fahrzeug:* ${ride.vehicle}` : ''}

ğŸ“‹ *Status:* ${getStatusName(ride.status)}

ğŸ”— *Ride-ID:* ${ride.firebaseId || ride.id || 'unbekannt'}

---
_Gesendet von Funk Taxi Heringsdorf App_`;
            
            // Encode fÃ¼r WhatsApp URL
            const encodedMessage = encodeURIComponent(message);
            
            // Ã–ffne WhatsApp (funktioniert auf Mobile & Desktop!)
            const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
            
            console.log('ğŸ“± Ã–ffne WhatsApp...');
            window.open(whatsappUrl, '_blank');
        }
        
        // ğŸ†• v5.90.193: INTELLIGENTE HAUSNUMMERN-ERKENNUNG!
        function extractStreetAndNumber(query) {
            // Erkenne Muster wie:
            // "KulmstraÃŸe 22" â†’ {street: "KulmstraÃŸe", number: "22"}
            // "Goethestr. 15" â†’ {street: "Goethestr.", number: "15"}
            // "Am Markt 3a" â†’ {street: "Am Markt", number: "3a"}
            
            // Regex: Alles bis zur letzten Zahl
            const match = query.match(/^(.+?)\s+(\d+[a-zA-Z]?)$/);
            
            if (match) {
                return {
                    street: match[1].trim(),
                    number: match[2].trim(),
                    hasNumber: true
                };
            }
            
            return {
                street: query.trim(),
                number: null,
                hasNumber: false
            };
        }
        
        function enhanceNominatimResults(results, originalQuery) {
            // Wenn User eine Hausnummer eingegeben hat, aber Nominatim nur StraÃŸe findet:
            // FÃ¼ge die Hausnummer hinzu!
            
            const parsed = extractStreetAndNumber(originalQuery);
            
            if (!parsed.hasNumber) {
                // Keine Hausnummer eingegeben â†’ keine Anpassung nÃ¶tig
                return results;
            }
            
            console.log('ğŸ  Hausnummer erkannt:', parsed.number, 'fÃ¼r StraÃŸe:', parsed.street);
            
            const enhanced = results.map(r => {
                const address = r.address || {};
                
                // Wenn Result keine Hausnummer hat, fÃ¼ge die eingegebene hinzu
                if (!address.house_number && address.road) {
                    // PrÃ¼fe ob die StraÃŸe passt
                    const roadLower = address.road.toLowerCase();
                    const streetLower = parsed.street.toLowerCase();
                    
                    if (roadLower.includes(streetLower) || streetLower.includes(roadLower)) {
                        // Match! FÃ¼ge Hausnummer hinzu
                        return {
                            ...r,
                            display_name: `${address.road} ${parsed.number}, ${address.postcode || ''} ${address.town || address.village || address.city || ''}`.trim(),
                            address: {
                                ...address,
                                house_number: parsed.number
                            },
                            isEnhanced: true // Markierung fÃ¼r Display
                        };
                    }
                }
                
                return r;
            });
            
            return enhanced;
        }
        
        // ğŸ†• v5.90.191: FUZZY SEARCH - LEVENSHTEIN DISTANCE!
        function levenshteinDistance(str1, str2) {
            // Konvertiere zu Lowercase fÃ¼r case-insensitive Vergleich
            const s1 = str1.toLowerCase();
            const s2 = str2.toLowerCase();
            
            const matrix = [];
            
            // Initialisiere erste Spalte
            for (let i = 0; i <= s2.length; i++) {
                matrix[i] = [i];
            }
            
            // Initialisiere erste Zeile
            for (let j = 0; j <= s1.length; j++) {
                matrix[0][j] = j;
            }
            
            // FÃ¼lle Matrix
            for (let i = 1; i <= s2.length; i++) {
                for (let j = 1; j <= s1.length; j++) {
                    if (s2.charAt(i - 1) === s1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1, // Ersetzung
                            matrix[i][j - 1] + 1,     // EinfÃ¼gung
                            matrix[i - 1][j] + 1      // LÃ¶schung
                        );
                    }
                }
            }
            
            return matrix[s2.length][s1.length];
        }
        
        function calculateSimilarity(str1, str2) {
            const distance = levenshteinDistance(str1, str2);
            const maxLength = Math.max(str1.length, str2.length);
            if (maxLength === 0) return 100;
            return Math.round(((maxLength - distance) / maxLength) * 100);
        }
        
        function fuzzyMatch(query, targets, minSimilarity = 60) {
            // targets = Array von {name, address, ...}
            // Gibt Array zurÃ¼ck sortiert nach Ã„hnlichkeit
            
            const results = [];
            
            for (const target of targets) {
                // PrÃ¼fe Name
                const nameSimilarity = calculateSimilarity(query, target.name || '');
                
                // PrÃ¼fe Adresse
                const addressSimilarity = target.address 
                    ? calculateSimilarity(query, target.address)
                    : 0;
                
                // Beste Ã„hnlichkeit nehmen
                const bestSimilarity = Math.max(nameSimilarity, addressSimilarity);
                
                // Auch Teilstring-Match prÃ¼fen (wichtig fÃ¼r "Goethestr" â†’ "GoethestraÃŸe")
                const nameContains = (target.name || '').toLowerCase().includes(query.toLowerCase());
                const addressContains = (target.address || '').toLowerCase().includes(query.toLowerCase());
                
                if (bestSimilarity >= minSimilarity || nameContains || addressContains) {
                    results.push({
                        ...target,
                        similarity: bestSimilarity,
                        isSubstring: nameContains || addressContains
                    });
                }
            }
            
            // Sortiere: Substring-Matches zuerst, dann nach Ã„hnlichkeit
            results.sort((a, b) => {
                if (a.isSubstring && !b.isSubstring) return -1;
                if (!a.isSubstring && b.isSubstring) return 1;
                return b.similarity - a.similarity;
            });
            
            return results;
        }
        
        // Helper: Status Namen
        function getStatusName(status) {
            const statusNames = {
                'new': 'ğŸ†• Neu',
                'vorbestellt': 'ğŸ“… Vorbestellt',
                'accepted': 'âœ… Angenommen',
                'picked_up': 'ğŸš— Unterwegs',
                'completed': 'âœ… Abgeschlossen',
                'storniert': 'ğŸ—‘ï¸ Storniert',
                'cancelled': 'ğŸ—‘ï¸ Storniert'
            };
            return statusNames[status] || status;
        }
        
        // ğŸ†• v5.90.190: CRM VIEW LADEN
        function loadCRMView() {
            console.log('ğŸ“‹ Lade CRM View...');
            
            if (!isFirebaseReady) {
                console.warn('âš ï¸ Firebase nicht bereit!');
                return;
            }
            
            // Lade Kunden aus Firebase
            db.ref('customers').once('value', (snapshot) => {
                const customers = [];
                snapshot.forEach((childSnapshot) => {
                    const customer = childSnapshot.val();
                    customer.id = childSnapshot.key;
                    customers.push(customer);
                });
                
                console.log('âœ… Kunden geladen:', customers.length);
                
                // Update Statistiken
                document.getElementById('crm-total-customers').textContent = customers.length;
                
                const thisMonth = new Date().getMonth();
                const thisMonthCustomers = customers.filter(c => {
                    if (c.createdAt) {
                        const created = new Date(c.createdAt);
                        return created.getMonth() === thisMonth;
                    }
                    return false;
                });
                document.getElementById('crm-this-month').textContent = thisMonthCustomers.length;
                
                const favorites = customers.filter(c => c.category === 'vip').length;
                document.getElementById('crm-favorites').textContent = favorites;
                
                // Render Kunden-Liste
                renderCRMCustomers(customers);
            });
        }
        
        function renderCRMCustomers(customers) {
            const container = document.getElementById('crm-customers-list');
            if (!container) return;
            
            if (customers.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;padding:40px;color:#6b7280;">
                        <div style="font-size:48px;margin-bottom:12px;">ğŸ‘¥</div>
                        <div style="font-size:16px;font-weight:600;margin-bottom:8px;">Noch keine Kunden</div>
                        <div style="font-size:14px;">Kunden werden automatisch bei Buchungen angelegt</div>
                    </div>
                `;
                return;
            }
            
            // Sortiere nach letztem Kontakt
            customers.sort((a, b) => {
                const dateA = a.lastContactAt ? new Date(a.lastContactAt) : new Date(0);
                const dateB = b.lastContactAt ? new Date(b.lastContactAt) : new Date(0);
                return dateB - dateA;
            });
            
            container.innerHTML = customers.map(customer => {
                const categoryIcons = {
                    'vip': 'â­',
                    'regular': 'âœ…',
                    'business': 'ğŸ’¼',
                    'hotel': 'ğŸ¨'
                };
                const categoryIcon = categoryIcons[customer.category] || 'ğŸ’¾';
                
                const lastContact = customer.lastContactAt 
                    ? new Date(customer.lastContactAt).toLocaleDateString('de-DE')
                    : 'Nie';
                
                return `
                    <div style="background:white;border:2px solid #e5e7eb;border-radius:8px;padding:15px;">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px;">
                            <div style="flex:1;">
                                <div style="font-weight:700;font-size:16px;color:#111827;margin-bottom:4px;">
                                    ${categoryIcon} ${customer.name || 'Unbekannt'}
                                </div>
                                <div style="font-size:13px;color:#6b7280;">
                                    ğŸ’¾ ${customer.phone || 'Keine Nummer'}<br>
                                    ${customer.email ? `âœ‰ï¸ ${customer.email}<br>` : ''}
                                    ğŸ“… Letzter Kontakt: ${lastContact}
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:20px;font-weight:700;color:#10b981;">
                                    ${customer.totalRides || 0}
                                </div>
                                <div style="font-size:11px;color:#6b7280;">Fahrten</div>
                            </div>
                        </div>
                        
                        ${customer.favoriteRoutes && customer.favoriteRoutes.length > 0 ? `
                            <div style="background:#f0fdf4;border-radius:6px;padding:8px;margin-bottom:10px;font-size:12px;">
                                <div style="font-weight:600;color:#065f46;margin-bottom:4px;">â­ Top Route:</div>
                                <div style="color:#048257;">
                                    ${customer.favoriteRoutes[0].pickup} â†’ ${customer.favoriteRoutes[0].destination}
                                    <span style="opacity:0.7;">(${customer.favoriteRoutes[0].count}x)</span>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="display:flex;gap:6px;">
                            <button onclick="openFloatingQuickBooking('${customer.id}', '${customer.name}', '${customer.phone}')" style="flex:1;padding:8px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:6px;font-weight:600;font-size:12px;cursor:pointer;">
                                ğŸš• Buchen
                            </button>
                            <button onclick="viewCustomerDetails('${customer.id}')" style="flex:1;padding:8px;background:#3b82f6;color:white;border:none;border-radius:6px;font-weight:600;font-size:12px;cursor:pointer;">
                                ğŸ‘ï¸ Details
                            </button>
                            <button onclick="editCustomer('${customer.id}')" style="flex:1;padding:8px;background:#10b981;color:white;border:none;border-radius:6px;font-weight:600;font-size:12px;cursor:pointer;">
                                âœï¸ Bearbeiten
                            </button>
                            <button onclick="callCustomer('${customer.phone}')" style="padding:8px 12px;background:#f59e0b;color:white;border:none;border-radius:6px;font-weight:600;font-size:12px;cursor:pointer;">
                                ğŸ’¾
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ğŸ†• v5.90.245: CUSTOM DROPDOWN FUNKTIONEN FÃœR EDIT CUSTOMER KATEGORIE
        function toggleEditCustomerCategoryDropdown() {
            const dropdown = document.getElementById('edit-customer-category-dropdown');
            if (!dropdown) return;
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }
        
        function selectEditCustomerCategory(value, label) {
            document.getElementById('edit-customer-category').value = value;
            document.getElementById('edit-customer-category-label').textContent = label;
            document.getElementById('edit-customer-category-dropdown').style.display = 'none';
        }
        
        // ğŸ†• v5.90.245: CUSTOM DROPDOWN FUNKTIONEN FÃœR TESLA!
        let crmFilterCategoryValue = '';
        
        function toggleCRMFilterDropdown() {
            const dropdown = document.getElementById('crm-filter-category-dropdown');
            if (dropdown.style.display === 'none') {
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }
        
        function selectCRMFilterCategory(value, label) {
            crmFilterCategoryValue = value;
            document.getElementById('crm-filter-category').value = value;
            document.getElementById('crm-filter-category-label').textContent = label;
            document.getElementById('crm-filter-category-dropdown').style.display = 'none';
            filterCRMCustomers();
        }
        
        // SchlieÃŸe Dropdown bei Klick auÃŸerhalb
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#crm-filter-category-btn') && !e.target.closest('#crm-filter-category-dropdown')) {
                const dropdown = document.getElementById('crm-filter-category-dropdown');
                if (dropdown) dropdown.style.display = 'none';
            }
        });
        
        function filterCRMCustomers() {
            const searchInput = document.getElementById('crm-search-input');
            if (!searchInput) {
                console.error('ğŸ’¾ CRM Search Input nicht gefunden!');
                return;
            }
            
            const searchTerm = searchInput.value.toLowerCase();
            console.log('ğŸ” CRM Suche:', searchTerm);
            
            const categoryDropdownBtn = document.getElementById('crm-filter-category-btn');
            const category = categoryDropdownBtn ? categoryDropdownBtn.dataset.value : '';
            console.log('ğŸ“‚ Kategorie-Filter:', category || 'Alle');
            
            db.ref('customers').once('value', (snapshot) => {
                const customers = [];
                let totalCount = 0;
                
                snapshot.forEach((childSnapshot) => {
                    totalCount++;
                    const customer = childSnapshot.val();
                    customer.id = childSnapshot.key;
                    
                    // Filter nach Suchbegriff
                    const matchesSearch = !searchTerm || 
                        (customer.name && customer.name.toLowerCase().includes(searchTerm)) ||
                        (customer.phone && customer.phone.includes(searchTerm)) ||
                        (customer.email && customer.email.toLowerCase().includes(searchTerm));
                    
                    // ğŸ†• v5.90.194: Filter nach Kategorie ODER Favoriten!
                    let matchesCategory = true;
                    if (category === 'favorites') {
                        // Nur Favoriten anzeigen
                        matchesCategory = customer.isFavorite === true;
                    } else if (category) {
                        // Normale Kategorie-Filter
                        matchesCategory = customer.category === category;
                    }
                    
                    if (matchesSearch && matchesCategory) {
                        customers.push(customer);
                    }
                });
                
                console.log(`âœ… CRM Suche: ${customers.length} von ${totalCount} Kunden gefunden`);
                if (searchTerm) {
                    console.log(`   Suchbegriff: "${searchTerm}"`);
                }
                if (category) {
                    console.log(`   Kategorie: "${category}"`);
                }
                
                renderCRMCustomers(customers);
            });
        }
        
        function callCustomer(phone) {
            if (!phone) {
                alert('ğŸ’¾ Keine Telefonnummer hinterlegt!');
                return;
            }
            window.location.href = `tel:${phone}`;
        }
        
        function viewCustomerDetails(customerId) {
            alert('ğŸš§ Kunde-Details kommen bald!');
            // TODO: Modal mit vollstÃ¤ndigen Details
        }
        
        function editCustomer(customerId) {
            alert('ğŸš§ Kunde bearbeiten kommt bald!');
            // TODO: Edit-Modal
        }
        
        function showAddCustomerModal() {
            alert('ğŸš§ Neuer Kunde kommt bald!');
            // TODO: Add-Modal
        }

        // ğŸ†• v5.64.40: STORNIERTE FAHRT WIEDERHERSTELLEN
        async function restoreRide(rideId) {
            if (!confirm('ğŸ”„ Fahrt wirklich wiederherstellen?\n\nStatus wird von "storniert" auf "vorbestellt" geÃ¤ndert.')) {
                return;
            }
            
            try {
                if (isFirebaseReady) {
                    // Lade aktuelle Fahrt
                    const snapshot = await db.ref(`rides/${rideId}`).once('value');
                    const ride = snapshot.val();
                    
                    if (!ride) {
                        alert('ğŸ’¾ Fahrt nicht gefunden!');
                        return;
                    }
                    
                    if (ride.status !== 'cancelled') {
                        alert('âš ï¸ Nur stornierte Fahrten kÃ¶nnen wiederhergestellt werden!');
                        return;
                    }
                    
                    // Berechne neuen Status
                    const now = Date.now();
                    const pickupTime = ride.pickupTimestamp || now;
                    const minutesUntilPickup = (pickupTime - now) / 60000;
                    const newStatus = minutesUntilPickup <= 15 ? 'new' : 'vorbestellt';
                    
                    // Wiederherstellen
                    await db.ref(`rides/${rideId}`).update({
                        status: newStatus,
                        restoredAt: Date.now(),
                        restoredBy: 'admin',
                        cancelledAt: null,
                        cancelledBy: null,
                        cancellationFee: null,
                        cancellationReason: null
                    });
                    
                    console.log('âœ… Fahrt wiederhergestellt:', rideId);
                    alert('âœ… Fahrt wurde wiederhergestellt!\n\nStatus: ' + newStatus);
                    
                    // Logs
                    logActivity('status', newStatus, 'Fahrt wiederhergestellt (war storniert)', {
                        customer: ride.customerName,
                        from: ride.pickup,
                        to: ride.destination
                    });
                    
                    // ğŸ“± TELEGRAM AN FAHRER SENDEN (wenn Fahrzeug zugewiesen)
                    if (ride.vehicleId) {
                        console.log('ğŸ“± Sende Telegram an Fahrer fÃ¼r wiederhergestellte Fahrt...');
                        try {
                            const telegramSent = await sendTelegramToDriver(ride.vehicleId, ride, 0);
                            if (telegramSent) {
                                console.log('âœ… Telegram an Fahrer gesendet');
                            } else {
                                console.warn('âš ï¸ Telegram konnte nicht gesendet werden');
                            }
                        } catch (telegramError) {
                            console.error('ğŸ’¾ Telegram-Fehler:', telegramError);
                        }
                    }
                    
                    // Views aktualisieren
                    updateAdminView();
                    
                    // ğŸ“… KALENDER AKTUALISIEREN
                    if (typeof renderCalendar === 'function') {
                        await renderCalendar();
                        console.log('ğŸ“… Kalender aktualisiert nach Wiederherstellung');
                    }
                }
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Wiederherstellen:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }

        // ğŸ†• FORMULAR ZURÃœCKSETZEN (nach Stornierung oder abgeschlossener Fahrt)
        function resetBookingForm() {
            // Felder LEEREN
            document.getElementById('pickup').value = '';
            document.getElementById('destination').value = '';
            
            // ğŸ†• v5.49.6: Confirmation-Felder verstecken!
            const pickupConf = document.getElementById('pickup-confirmation');
            const destConf = document.getElementById('destination-confirmation');
            if (pickupConf) pickupConf.style.display = 'none';
            if (destConf) destConf.style.display = 'none';
            
            // ğŸ†• v5.90.73: Auch Icons verstecken!
            const pickupIcon = document.getElementById('pickup-confirmation-icon');
            const destIcon = document.getElementById('destination-confirmation-icon');
            const slotIcon = document.getElementById('slot-confirmation-icon');
            if (pickupIcon) pickupIcon.style.display = 'none';
            if (destIcon) destIcon.style.display = 'none';
            if (slotIcon) slotIcon.style.display = 'none';
            
            // ZurÃ¼cksetzen auf Default-Werte
            const oldPickupTime = document.getElementById('pickup-time');
            if (oldPickupTime) oldPickupTime.value = 'jetzt';
            document.getElementById('passengers').value = '1';
            
            // ğŸ› v5.47.3: Null-Checks fÃ¼r datetime Felder (manche existieren nicht mehr!)
            const customDatetime = document.getElementById('custom-datetime');
            if (customDatetime) customDatetime.style.display = 'none';
            
            const customDatetimeContainer = document.getElementById('custom-datetime-container');
            if (customDatetimeContainer) customDatetimeContainer.style.display = 'none';
            
            const datetimeHelp = document.getElementById('datetime-help');
            if (datetimeHelp) datetimeHelp.style.display = 'none';
            
            // Preis-Anzeige ausblenden
            const priceDisplay = document.getElementById('price-display');
            if (priceDisplay) {
                priceDisplay.innerHTML = '';
                priceDisplay.style.display = 'none';
            }
            
            // ğŸ—ºï¸ Route-Karte ausblenden
            const routeMapEl = document.getElementById('route-map');
            if (routeMapEl) {
                routeMapEl.style.display = 'none';
            }
            if (routeMapInstance) {
                routeMapInstance.remove();
                routeMapInstance = null;
            }
            
            // "Taxi buchen" Button verstecken (WICHTIG!)
            const bookBtn = document.getElementById('book-btn');
            if (bookBtn) {
                bookBtn.style.display = 'none';
                bookBtn.style.visibility = 'hidden'; // Doppelt sicher!
            }
            
            // ğŸ†• PREIS-BUTTON ZURÃœCKSETZEN
            const priceBtn = document.getElementById('price-btn');
            if (priceBtn) {
                priceBtn.innerHTML = 'ğŸ’° Preis berechnen';
                priceBtn.classList.remove('btn-danger');
                priceBtn.classList.add('btn-primary');
            }
            priceCalculated = false;
            
            // VerfÃ¼gbare Taxis ausblenden
            document.getElementById('available-taxis-display').innerHTML = '';
            
            // Global Variablen zurÃ¼cksetzen
            window.currentPrice = null;
            window.currentDistance = null;
            window.currentDuration = null;
            pickupCoords = null;  // âœ… Ohne "window."!
            destCoords = null;    // âœ… Ohne "window."!
            
            // Booking-Kunde zurÃ¼cksetzen
            currentBookingCustomerId = null;
            const crmOption = document.getElementById('crm-save-option');
            if (crmOption) crmOption.style.display = 'none';
            
            console.log('âœ… Formular zurÃ¼ckgesetzt');
        }

        async function cancelRide() {
            // Statt zu lÃ¶schen, als "storniert" markieren!
            if (myCurrentRide) {
                const rideId = myCurrentRide.firebaseId || myCurrentRide.id;
                
                // Update Firebase mit updateRide() fÃ¼r Telegram-Benachrichtigung
                if (isFirebaseReady && rideId) {
                    try {
                        await updateRide(rideId, { 
                            status: 'storniert',
                            cancelledAt: Date.now()
                        });
                        console.log('âœ… Sofort-Fahrt in Firebase storniert');
                    } catch (error) {
                        console.error('ğŸ’¾ Fehler beim Stornieren in Firebase:', error);
                    }
                }
                
                // Update localStorage
                const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
                const ride = history.find(r => r.firebaseId === rideId || r.id === rideId);
                if (ride) {
                    ride.status = 'storniert';
                    ride.cancelledAt = Date.now();
                    localStorage.setItem('rideHistory', JSON.stringify(history));
                    console.log('âœ… Sofort-Fahrt in localStorage storniert');
                }
            }
            
            // UI aufrÃ¤umen
            localStorage.removeItem('myCurrentRideId');
            myCurrentRide = null;
            document.getElementById('ride-status-container').innerHTML = '';
            document.getElementById('booking-form').style.display = 'block';
            
            // ğŸ†• FORMULAR ZURÃœCKSETZEN nach Stornierung
            resetBookingForm();
        }

        // DRIVER FUNCTIONS
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    // Wenn bereits aktiv, nicht neu anfordern
                    if (wakeLock !== null && !wakeLock.released) {
                        console.log('âœ… Wake Lock bereits aktiv');
                        return;
                    }
                    
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('âœ… Screen Wake Lock aktiviert');
                    
                    wakeLock.addEventListener('release', () => {
                        console.log('âš ï¸ Wake Lock freigegeben - versuche sofortige Reaktivierung');
                        wakeLock = null;
                        
                        // SOFORT neu aktivieren wenn noch online
                        if (isOnline) {
                            requestWakeLock();
                        }
                    });
                } else {
                    console.warn('âš ï¸ Wake Lock API nicht verfÃ¼gbar');
                }
            } catch (err) {
                // ğŸ†• v5.90.546: DETAILLIERTE Fehler-Info statt leerem Objekt!
                console.error('ğŸ’¾ Wake Lock Fehler:', {
                    name: err.name || 'Unknown',
                    message: err.message || 'No message',
                    code: err.code || 'No code',
                    stack: err.stack ? err.stack.substring(0, 200) : 'No stack'
                });
                wakeLock = null;
                
                // Bei Fehler sofort nochmal versuchen wenn online
                if (isOnline) {
                    setTimeout(() => {
                        if (wakeLock === null && isOnline) {
                            requestWakeLock();
                        }
                    }, 1000);
                }
            }
        }
        
        // ğŸ”„ v5.90.317: Wake Lock alle 5 Sekunden checken & reaktivieren (vorher 30!)
        setInterval(() => {
            if (isOnline && currentView === 'driver') {
                if (wakeLock === null || wakeLock.released) {
                    console.log('ğŸ”„ Wake Lock Check: Reaktiviere...');
                    requestWakeLock();
                }
            }
        }, 5000); // ğŸ†• v5.90.317: Alle 5 Sekunden statt 30!

        function releaseWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release();
                wakeLock = null;
            }
        }

        // ğŸš¨ FAHRER-BENACHRICHTIGUNG BEI STORNIERUNG
        async function notifyDriverOfCancellation(ride) {
            console.log('ğŸš¨ STORNIERUNG ERKANNT:', ride);
            
            // Spiele Sound ab (falls Browser erlaubt)
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ==');
                audio.play().catch(e => console.log('Audio play blocked'));
            } catch (e) {
                console.log('Audio not supported');
            }
            
            // SchlieÃŸe Karte falls offen
            closeDriverMap();
            
            // GroÃŸe Alert-Box
            const feeText = ride.cancellationFee ? `\n\nğŸ’¶ StornogebÃ¼hr: ${ride.cancellationFee.toFixed(2)}â‚¬\n(Wird dem Kunden berechnet)` : '';
            
            alert(
                `ğŸš¨ FAHRT STORNIERT!\n\n` +
                `#${ride.id} - ${ride.customerName || 'Fahrgast'}\n` +
                `Von: ${ride.pickup}\n` +
                `Nach: ${ride.destination}\n\n` +
                `ğŸ’¾ Kunde hat gerade storniert!${feeText}\n\n` +
                `Fahrt wird archiviert.`
            );
            
            // Markiere als benachrichtigt in Firebase
            if (isFirebaseReady && ride.firebaseId) {
                await db.ref('rides/' + ride.firebaseId).update({
                    driverNotified: true,
                    driverNotifiedAt: Date.now()
                });
                console.log('âœ… Fahrer als benachrichtigt markiert');
            }
            
            // ğŸ”§ WICHTIG: GPS und Wake Lock neu aktivieren!
            console.log('ğŸ”„ Reaktiviere GPS und Wake Lock...');
            if (isOnline && currentVehicle) {
                requestWakeLock();
                // GPS lÃ¤uft schon, nur sicherstellen dass es aktiv ist
                if (!watchId) {
                    startDriverTracking(null);
                }
            }
            
            // Nach 5 Sekunden automatisch zu "completed" verschieben fÃ¼r Archivierung
            setTimeout(async () => {
                if (isFirebaseReady && ride.firebaseId) {
                    await db.ref('rides/' + ride.firebaseId).update({
                        status: 'completed',
                        archivedAsCancel: true
                    });
                    updateViews();
                }
            }, 5000);
        }
        
        // ğŸ’¾ KUNDE ANRUFEN
        function callCustomer() {
            const ride = rides.find(r => 
                r.vehicleId === currentVehicle && 
                (r.status === 'accepted' || r.status === 'picked_up')
            );
            
            if (!ride) {
                alert('ğŸ’¾ Keine aktive Fahrt gefunden!');
                return;
            }
            
            if (!ride.customerPhone) {
                alert('ğŸ’¾ Keine Telefonnummer hinterlegt!\n\nKunde hat keine Nummer angegeben.');
                return;
            }
            
            // Ã–ffne Telefon-App
            window.open('tel:' + ride.customerPhone);
        }
        
        // ğŸ“‹ UPDATE DRIVER INFO TOP
        // ğŸ“‹ UPDATE DRIVER CARDS (A3/B3 Design)
        function updateDriverInfoTop(ride) {
            if (!ride) {
                console.error('ğŸ’¾ updateDriverInfoTop: Kein ride!');
                return;
            }
            
            console.log('ğŸ“‹ updateDriverInfoTop called with ride:');
            console.log('   - id:', ride.id || ride.firebaseId);
            console.log('   - customerName:', ride.customerName);
            console.log('   - pickup:', ride.pickup);
            console.log('   - destination:', ride.destination);
            console.log('   - status:', ride.status);
            console.log('   - VOLLES OBJEKT:', JSON.stringify(ride));
            
            const rideId = ride.firebaseId || ride.id;
            
            // Customer Name
            const customerName = document.getElementById('driver-customer-name');
            if (customerName) {
                let nameText = 'ğŸ’¾ ' + (ride.customerName || 'Kunde');
                // ğŸ†• v5.75.0: Gast-Name anzeigen wenn vorhanden!
                if (ride.guestName) {
                    nameText += '\nğŸ“ Gast: ' + ride.guestName;
                }
                customerName.textContent = nameText;
            }
            
            // Call Button
            const callButton = document.getElementById('driver-call-button');
            if (callButton) {
                // Nur zeigen wenn: Telefon DA + noch unterwegs zum Kunden
                if (ride.customerPhone && ride.status === 'accepted') {
                    callButton.style.display = 'block';
                } else {
                    callButton.style.display = 'none';  // Verstecken wenn Kunde an Bord
                }
            }
            
            // Cards Container
            const customerCard = document.getElementById('driver-customer-card');
            const priceCard = document.getElementById('driver-price-card');
            const pickupCard = document.getElementById('driver-pickup-card');
            const destCard = document.getElementById('driver-dest-card');
            
            if (ride.status === 'accepted') {
                // A3 Design: Zum Kunden
                // Zeige: Kunde, Pickup, Destination
                // Verstecke: Preis
                
                if (customerCard) customerCard.style.gridColumn = '1 / -1';
                if (priceCard) priceCard.style.display = 'none';
                if (pickupCard) {
                    pickupCard.style.display = 'block';
                    const pickupValue = document.getElementById('driver-pickup-value');
                    if (pickupValue) pickupValue.textContent = ride.pickup || '-';
                }
                if (destCard) {
                    const destValue = document.getElementById('driver-dest-value');
                    if (destValue) destValue.textContent = ride.destination || '-';
                }
                
            } else if (ride.status === 'picked_up') {
                // B3 Design: Kunde an Bord
                // Zeige: Kunde, Preis, Destination
                // Verstecke: Pickup
                
                const cardsContainer = document.getElementById('driver-cards-container');
                if (cardsContainer) {
                    cardsContainer.style.gridTemplateColumns = '2fr 1fr';
                }
                
                if (customerCard) customerCard.style.gridColumn = '';
                if (priceCard) {
                    priceCard.style.display = 'block';
                    const priceValue = document.getElementById('driver-price-value');
                    if (priceValue) priceValue.textContent = 'ğŸ’° ' + (ride.price || '-') + 'â‚¬';
                }
                if (pickupCard) pickupCard.style.display = 'none';
                if (destCard) {
                    destCard.style.gridColumn = '1 / -1';
                    const destValue = document.getElementById('driver-dest-value');
                    if (destValue) destValue.textContent = ride.destination || '-';
                }
            }
            
            // Action Button
            const actionButton = document.getElementById('driver-action-button');
            if (actionButton) {
                if (ride.status === 'accepted') {
                    actionButton.textContent = 'ğŸš— Beim Kunden angekommen';
                    actionButton.onclick = () => pickupCustomer(rideId);
                    actionButton.style.background = '#667eea';
                } else if (ride.status === 'picked_up') {
                    actionButton.textContent = 'âœ… Ziel erreicht';
                    actionButton.onclick = () => completeRide(rideId);
                    actionButton.style.background = '#10b981';
                }
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.42.6: CONSOLE CONTROL FUNKTIONEN
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function pauseConsole() {
            window.consolePaused = true;
            document.getElementById('console-pause-btn').style.display = 'none';
            document.getElementById('console-play-btn').style.display = 'block';
            document.getElementById('console-status').innerHTML = 'â¸ï¸ Console PAUSIERT';
            document.getElementById('console-status').style.color = '#f59e0b';
            console.log('â¸ï¸ Console PAUSIERT!');
        }
        
        function playConsole() {
            window.consolePaused = false;
            document.getElementById('console-pause-btn').style.display = 'block';
            document.getElementById('console-play-btn').style.display = 'none';
            document.getElementById('console-status').innerHTML = 'â–¶ï¸ Console lÃ¤uft';
            document.getElementById('console-status').style.color = '#10b981';
            console.log('â–¶ï¸ Console lÃ¤uft wieder!');
        }
        
        function copyConsole() {
            const logs = window.consoleLogHistory.join('\n');
            
            // Versuche in Zwischenablage zu kopieren
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(logs).then(() => {
                    alert('âœ… Console in Zwischenablage kopiert!\n\n' + 
                          logs.split('\n').length + ' Zeilen kopiert.');
                }).catch(err => {
                    // Fallback: Zeige in Alert
                    prompt('ğŸ“‹ Kopiere diese Logs:\n\n' + 
                           '(Strg+C / Cmd+C zum kopieren)', logs);
                });
            } else {
                // Fallback fÃ¼r Ã¤ltere Browser
                prompt('ğŸ“‹ Kopiere diese Logs:\n\n' + 
                       '(Strg+C / Cmd+C zum kopieren)', logs);
            }
        }
        
        function exportConsole() {
            const logs = window.consoleLogHistory.join('\n');
            const timestamp = new Date().toISOString().replace(/:/g, '-').split('.')[0];
            const filename = `console-log-${timestamp}.txt`;
            
            // Erstelle Download-Link
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('ğŸ’¾ Console exportiert!\n\n' + 
                  'Datei: ' + filename + '\n' +
                  'Zeilen: ' + logs.split('\n').length);
        }
        
        function clearConsoleLog() {
            if (confirm('ğŸ—‘ï¸ Console wirklich leeren?\n\nAlle Logs gehen verloren!')) {
                window.consoleLogHistory = [];
                console.clear();
                console.log('ğŸ—‘ï¸ Console geleert!');
                alert('âœ… Console geleert!');
            }
        }

        // ğŸ†• v5.18.0: FAHRER TELEGRAM-ID SPEICHERN
        // ğŸ†• v5.20.0: Speichert jetzt pro USER (nicht mehr pro Fahrzeug!)
        async function saveDriverTelegramId() {
            // ğŸ†• v5.20.0: PrÃ¼fe ob User eingeloggt ist (Fahrzeug nicht mehr nÃ¶tig!)
            if (!currentUser || !currentUser.uid) {
                alert('ğŸ’¾ Bitte erst einloggen!');
                return;
            }
            
            const chatId = document.getElementById('driver-telegram-id').value.trim();
            if (!chatId) {
                alert('ğŸ’¾ Bitte Chat-ID eingeben!');
                return;
            }
            
            // Validiere dass es eine Zahl ist
            if (!/^-?\d+$/.test(chatId)) {
                alert('ğŸ’¾ UngÃ¼ltige Chat-ID!\n\nDie Chat-ID besteht nur aus Zahlen (z.B. 123482789)');
                return;
            }
            
            if (!isFirebaseReady) {
                alert('ğŸ’¾ Firebase nicht verbunden!');
                return;
            }
            
            // ğŸ†• v5.19.0: PrÃ¼fe ob User eingeloggt ist
            if (!currentUser || !currentUser.uid) {
                alert('ğŸ’¾ Bitte erst einloggen!');
                return;
            }
            
            try {
                // ğŸ†• v5.19.0: Speichere Telegram-ID beim USER (nicht Fahrzeug!)
                const userContact = currentUser.email || currentUser.phoneNumber || 'Unbekannt';
                await db.ref('users/' + currentUser.uid + '/telegramChatId').set(chatId);
                
                // Update Status-Anzeige
                document.getElementById('driver-telegram-status').innerHTML = 
                    'âœ… <span style="color:#10b981">Telegram aktiv fÃ¼r ' + userContact + '</span>';
                
                // Speichere auch lokal
                localStorage.setItem('driverTelegramId_' + currentUser.uid, chatId);
                
                console.log('âœ… Telegram-ID gespeichert fÃ¼r User', userContact, ':', chatId);
                alert('âœ… Telegram-ID gespeichert!\n\nDu bekommst jetzt Fahrt-Alarme direkt aufs Handy - egal welches Fahrzeug du fÃ¤hrst!');
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Speichern:', error);
                alert('ğŸ’¾ Fehler beim Speichern: ' + error.message);
            }
        }
        
        // ğŸ†• v5.18.0: TEST TELEGRAM AN FAHRER
        async function testDriverTelegram() {
            // ğŸ†• v5.19.0: PrÃ¼fe User statt Fahrzeug
            if (!currentUser || !currentUser.uid) {
                alert('ğŸ’¾ Bitte erst einloggen!');
                return;
            }
            
            const chatId = document.getElementById('driver-telegram-id').value.trim();
            if (!chatId) {
                alert('ğŸ’¾ Bitte erst Chat-ID eingeben und speichern!');
                return;
            }
            
            const userContact = currentUser.email || currentUser.phoneNumber || 'Unbekannt';
            const testMessage = `âœ… <b>Test erfolgreich!</b>\n\n` +
                `Du erhÃ¤ltst jetzt Fahrt-Alarme fÃ¼r: ${userContact}\n\n` +
                `ğŸš• Funk Taxi Heringsdorf`;
            
            const success = await sendTelegramMessage(chatId, testMessage);
            
            if (success) {
                alert('âœ… Test-Nachricht gesendet!\n\nPrÃ¼fe dein Telegram!');
            } else {
                alert('ğŸ’¾ Fehler beim Senden!\n\nIst die Chat-ID korrekt?');
            }
        }
        
        // ğŸ†• v5.19.0: TELEGRAM-ID VOM USER LADEN (nicht mehr vom Fahrzeug!)
        async function loadDriverTelegramId() {
            if (!currentUser || !currentUser.uid || !isFirebaseReady) return;
            
            try {
                const snapshot = await db.ref('users/' + currentUser.uid + '/telegramChatId').once('value');
                const chatId = snapshot.val();
                
                const input = document.getElementById('driver-telegram-id');
                const status = document.getElementById('driver-telegram-status');
                const userContact = currentUser.email || currentUser.phoneNumber || 'Unbekannt';
                
                if (chatId && input && status) {
                    input.value = chatId;
                    status.innerHTML = 'âœ… <span style="color:#10b981">Telegram aktiv fÃ¼r ' + userContact + '</span>';
                } else if (input && status) {
                    input.value = '';
                    status.innerHTML = 'â“ Noch nicht eingerichtet';
                }
            } catch (error) {
                console.error('Fehler beim Laden der Telegram-ID:', error);
            }
        }

        function toggleOnline() {
            isOnline = document.getElementById('online-toggle').checked;
            
            // ğŸ†• v5.20.2: Online-Status speichern fÃ¼r Auto-Restore
            if (currentUser && currentUser.uid) {
                localStorage.setItem('lastOnlineStatus_' + currentUser.uid, isOnline ? 'true' : 'false');
                console.log('ğŸ’¾ Online-Status gespeichert:', isOnline);
            }
            
            // ğŸ“œ PROTOKOLL: Fahrer Online/Offline (mit Grund + Email!)
            const vehicleName = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle;
            const userContact = currentUser ? (currentUser.email || currentUser.phoneNumber || 'Unbekannt') : 'Unbekannt';
            const reason = isOnline ? '' : ' (Toggle)';
            logActivity('driver', isOnline ? 'online' : 'offline', 
                `Fahrer ${userContact} (${vehicleName}) ist jetzt ${isOnline ? 'ONLINE' : 'OFFLINE'}${reason}`, {
                vehicle: currentVehicle,
                driver: vehicleName,
                email: userContact,
                reason: isOnline ? 'toggle_on' : 'toggle_off'
            });
            
            // âœ… Sichere Zugriffe auf optionale Elemente
            const statusText = document.getElementById('online-status-text');
            if (statusText) {
                statusText.textContent = isOnline ? 'Online' : 'Offline';
                statusText.style.color = isOnline ? '#10b981' : '#666';
            }
            
            const gpsIndicator = document.getElementById('gps-indicator');
            const gpsDot = document.getElementById('gps-dot');
            const gpsStatus = document.getElementById('gps-status');
            
            // ğŸ†• v5.90.319: ISARFUNK GPS-STATUS!
            const gpsIcon = document.getElementById('driver-gps-icon');
            const gpsText = document.getElementById('driver-gps-text');
            const toggleLabel = document.getElementById('toggle-label');
            const gpsHint = document.getElementById('gps-hint');
            
            if (isOnline) {
                if (gpsIndicator) gpsIndicator.style.display = 'flex';
                if (gpsDot) {
                    gpsDot.style.background = '#10b981';
                    gpsDot.classList.add('online');
                }
                if (gpsStatus) gpsStatus.textContent = 'ğŸ“ GPS On';
                
                // ğŸ†• v5.90.319: ISARFUNK Status = GPS AN!
                if (gpsIcon) gpsIcon.textContent = 'ğŸŸ¢';
                if (gpsText) gpsText.textContent = 'GPS an';
                if (toggleLabel) toggleLabel.textContent = 'AN';
                if (gpsHint) gpsHint.style.display = 'none'; // Hinweis verstecken
                
                requestWakeLock();
            } else {
                if (gpsDot) {
                    gpsDot.style.background = '#6b7280';
                    gpsDot.classList.remove('online');
                }
                if (gpsStatus) gpsStatus.textContent = 'ğŸ“ GPS Off';
                
                // ğŸ†• v5.90.319: ISARFUNK Status = GPS AUS!
                if (gpsIcon) gpsIcon.textContent = 'ğŸ”´';
                if (gpsText) gpsText.textContent = 'GPS aus';
                if (toggleLabel) toggleLabel.textContent = 'AUS';
                if (gpsHint) gpsHint.style.display = 'block'; // Hinweis zeigen!
                
                releaseWakeLock();
            }
            
            if (isOnline && currentVehicle) {
                // ğŸ†• v5.19.0: Starte STANDBY-Modus (nicht aktives GPS!)
                startStandbyTracking();
            }
            else {
                stopDriverTracking(); // ğŸ†• v5.90.602: Entfernt Fahrzeug komplett aus /vehicles!
                // Stoppe auch Standby
                if (standbyIntervalId) {
                    clearInterval(standbyIntervalId);
                    standbyIntervalId = null;
                }
                gpsMode = 'off';
                // ğŸ†• v5.90.602: KEIN Firebase Update mehr nÃ¶tig - stopDriverTracking() lÃ¶scht bereits!
            }
            
            // ğŸ†• v5.90.267: Update Header-Anzeige!
            updateDriverHeader();
        }

        function setVehicle() {
            const previousVehicle = currentVehicle;
            const vehicleId = document.getElementById('vehicle').value;
            
            console.log('ğŸ”¥ v5.90.371: setVehicle() aufgerufen!');
            console.log('   vehicleId:', vehicleId);
            console.log('   previousVehicle:', previousVehicle);
            
            // ğŸ”¥ v5.90.371: Track Vehicle Selection!
            if (typeof trackFunctionCall !== 'undefined') {
                trackFunctionCall('setVehicle', { vehicleId: vehicleId, previousVehicle: previousVehicle });
                trackButtonClick('Fahrzeug wÃ¤hlen', { vehicleId: vehicleId });
            }
            
            // âœ… Stoppe GPS wenn Fahrzeug wechselt
            if (previousVehicle && previousVehicle !== vehicleId) {
                console.log('ğŸ”„ Fahrzeugwechsel erkannt - stoppe GPS');
                stopDriverTracking(); // ğŸ†• v5.90.602: Entfernt previousVehicle komplett!
                if (typeof stopGPSMonitoring !== 'undefined') {
                    stopGPSMonitoring();
                }
                
                // ğŸ†• v5.90.602: KEIN Firebase Update mehr - stopDriverTracking() lÃ¶scht bereits!
                
                // Log-Eintrag
                const prevName = VEHICLES[previousVehicle] ? VEHICLES[previousVehicle].name : previousVehicle;
                const userContact = currentUser ? (currentUser.email || currentUser.phoneNumber || 'Unbekannt') : 'Unbekannt';
                logActivity('driver', 'offline', 
                    `Fahrer ${userContact} (${prevName}) ist jetzt OFFLINE (Fahrzeugwechsel)`, {
                    vehicle: previousVehicle,
                    driver: prevName,
                    email: userContact
                });
            }
            
            currentVehicle = vehicleId;
            console.log('ğŸš— Fahrzeug gewÃ¤hlt:', currentVehicle);
            
            // ğŸ”¥ v5.90.371: Check ob Fahrzeug in VEHICLES existiert
            const vehicle = findVehicle(currentVehicle);
            if (vehicle) {
                console.log('âœ… Fahrzeug gefunden in VEHICLES:', vehicle);
            } else {
                console.error('ğŸ’¾ Fahrzeug NICHT in VEHICLES gefunden!');
                console.log('ğŸ“‹ VerfÃ¼gbare Fahrzeuge:', Object.keys(VEHICLES));
            }
            
            // ğŸ†• v5.20.1: Fahrzeug in localStorage speichern (fÃ¼r Wiederherstellung)
            if (currentVehicle && currentUser) {
                localStorage.setItem('lastVehicle_' + currentUser.uid, currentVehicle);
                console.log('ğŸ’¾ Fahrzeug gespeichert fÃ¼r User:', currentUser.uid);
            }
            
            // ğŸ”’ NEUE LOGIK: Toggle nur aktivieren wenn Fahrzeug gewÃ¤hlt!
            const toggle = document.getElementById('online-toggle');
            if (toggle) {
                if (currentVehicle) {
                    toggle.disabled = false;
                    toggle.style.opacity = '1';
                    toggle.style.cursor = 'pointer';
                    console.log('âœ… Online-Toggle aktiviert');
                } else {
                    toggle.disabled = true;
                    toggle.checked = false;
                    toggle.style.opacity = '0.5';
                    toggle.style.cursor = 'not-allowed';
                    isOnline = false;
                    console.log('ğŸ”’ Online-Toggle gesperrt - kein Fahrzeug');
                    
                    // GPS stoppen wenn kein Fahrzeug
                    if (watchId) {
                        stopDriverTracking();
                    }
                }
            }
            
            if (currentVehicle && isOnline) startDriverTracking(null);
            
            // ğŸ†• v5.18.0: Telegram-ID fÃ¼r dieses Fahrzeug laden
            if (currentVehicle) {
                loadDriverTelegramId();
                
                // âš™ï¸ v5.24.0: Driver-Settings laden
                if (typeof DriverSettingsManager !== 'undefined') {
                    DriverSettingsManager.init(currentVehicle);
                }
            }
            
            updateViews();
            
            // ğŸ†• v5.90.267: Update Header-Anzeige!
            updateDriverHeader();
            
            // ğŸ†• v5.90.261: Lade Fahrten fÃ¼r diesen Fahrer
            // ğŸ†• v5.90.632: Setze Flag zurÃ¼ck wenn Fahrzeug gewechselt wird
            ridesLoadedOnce = false;  // Erlaube neu laden bei Fahrzeugwechsel
            loadDriverRides();
        }
        
        // ğŸ†• v5.90.267: UPDATE DRIVER HEADER (Fahrzeug-Anzeige)
        function updateDriverHeader() {
            const plateEl = document.getElementById('driver-current-plate');
            const nameEl = document.getElementById('driver-current-name');
            const statusEl = document.getElementById('driver-status-text');
            
            // ğŸ†• v5.90.295: Auch neue Elemente updaten!
            const plateElNew = document.getElementById('driver-current-plate-new');
            const nameElNew = document.getElementById('driver-current-name-new');
            
            if (currentVehicle && VEHICLES[currentVehicle]) {
                const vehicle = VEHICLES[currentVehicle];
                const plate = vehicle.plate || '---';
                const name = vehicle.name || 'Unbekannt';
                const status = isOnline ? 'ğŸŸ¢ Online & GPS aktiv' : 'âšª Offline';
                
                if (plateEl) plateEl.textContent = plate;
                if (nameEl) nameEl.textContent = name;
                if (statusEl) statusEl.textContent = status;
                
                if (plateElNew) plateElNew.textContent = plate;
                if (nameElNew) nameElNew.textContent = name;
            } else {
                if (plateEl) plateEl.textContent = '---';
                if (nameEl) nameEl.textContent = 'Kein Fahrzeug gewÃ¤hlt';
                if (statusEl) statusEl.textContent = 'Offline';
                
                if (plateElNew) plateElNew.textContent = '---';
                if (nameElNew) nameElNew.textContent = 'Kein Fahrzeug';
            }
        }

        // ğŸ†• v5.90.261: LADE FAHRTEN FÃœR AKTUELLEN FAHRER
        let loadDriverRidesTimeout = null;
        async function loadDriverRides() {
            // ğŸ†• v5.90.332: DEBOUNCE! Verhindere Spam-Calls!
            if (loadDriverRidesTimeout) {
                clearTimeout(loadDriverRidesTimeout);
            }
            
            loadDriverRidesTimeout = setTimeout(async () => {
                if (!currentVehicle) {
                    console.log('âš ï¸ Kein Fahrzeug gewÃ¤hlt');
                    const noRidesEl = document.getElementById('driver-no-rides');
                    const ridesListEl = document.getElementById('driver-rides-list');
                    if (noRidesEl) noRidesEl.style.display = 'block';
                    if (ridesListEl) ridesListEl.innerHTML = '';
                    return;
                }
                
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('ğŸ”¥ v5.90.374: LADE NUR RELEVANTE FAHRTEN!');
                console.log('   Fahrzeug:', currentVehicle);
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
                try {
                    // ğŸ”¥ v5.90.374: Lade NUR Fahrten fÃ¼r MEIN Fahrzeug von Firebase!
                    const snapshot = await db.ref('rides')
                        .orderByChild('vehicleId')
                        .equalTo(currentVehicle)
                        .once('value');
                    
                    const myRides = snapshot.val();
                    
                    if (!myRides) {
                        console.log('âœ… Keine Fahrten fÃ¼r dieses Fahrzeug');
                        const noRidesEl = document.getElementById('driver-no-rides');
                        const ridesListEl = document.getElementById('driver-rides-list');
                        if (noRidesEl) noRidesEl.style.display = 'block';
                        if (ridesListEl) ridesListEl.innerHTML = '';
                        return;
                    }
                    
                    console.log(`ğŸ“‹ Firebase lieferte: ${Object.keys(myRides).length} Fahrten`);
                    
                    // ğŸ†• v5.90.535: DATUM-FILTER + Status + Zeit!
                    const now = Date.now();
                    const heute = new Date();
                    heute.setHours(0, 0, 0, 0); // Heute 00:00 Uhr
                    const validStatuses = ['new', 'assigned', 'accepted', 'picked_up', 'on_way'];
                    
                    const relevantRides = Object.entries(myRides)
                        .map(([id, ride]) => ({ id, ...ride }))
                        .filter(ride => {
                            // ğŸ”¥ v5.90.535: NUR FAHRTEN AB HEUTE!
                            const rideTime = ride.pickupTimestamp || ride.timestamp || 0;
                            if (rideTime < heute.getTime()) {
                                console.log(`ğŸ“… v5.90.535: Alte Fahrt ausgeblendet (von gestern/frÃ¼her): ${ride.customerName || 'Unbekannt'}`);
                                return false;
                            }
                            
                            // Status Check
                            if (!validStatuses.includes(ride.status)) {
                                return false;
                            }
                            
                            // ğŸ†• v5.90.525: Zeige Vorbestellungen bis 2 Stunden im Voraus!
                            if (ride.status === 'new' || ride.status === 'assigned') {
                                const pickupTime = ride.pickupTimestamp || ride.timestamp;
                                if (!pickupTime) return true; // Sofort-Fahrten immer zeigen
                                
                                const minutesUntil = (pickupTime - now) / 60000;
                                
                                // Blende Fahrten aus die mehr als 120 Min (2h) in der Zukunft sind
                                if (minutesUntil > 120) {
                                    console.log(`â° Vorbestellung ausgeblendet: ${ride.customerName || 'Unbekannt'} - noch ${Math.round(minutesUntil)} Min`);
                                    return false;
                                }
                            }
                            
                            return true;
                        })
                        .sort((a, b) => {
                            const timeA = a.pickupTimestamp || a.timestamp || 0;
                            const timeB = b.pickupTimestamp || b.timestamp || 0;
                            return timeA - timeB;
                        });
                    
                    console.log(`âœ… Nach Filter: ${relevantRides.length} relevante Fahrten`);
                    
                    if (relevantRides.length > 0) {
                        relevantRides.forEach(ride => {
                            const time = new Date(ride.pickupTimestamp || ride.timestamp).toLocaleString('de-DE');
                            console.log(`   ğŸ“ ${ride.pickup} â†’ ${ride.dropoff} (${time})`);
                        });
                    }
                    
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    
                    renderDriverRides(relevantRides);
                    
                } catch (error) {
                    console.error('ğŸ’¾ v5.90.374: Fehler beim Laden der Fahrten:', error);
                    console.error('ğŸ’¾ Error Details:', {
                        message: error.message,
                        stack: error.stack,
                        name: error.name
                    });
                }
            }, 300); // 300ms Debounce!
        }
        
        // ğŸ†• v5.90.525: RENDERE FAHRER-FAHRTEN (NUR ERSTE!)
        function renderDriverRides(rides) {
            const container = document.getElementById('current-rides-display');
            
            if (!container) {
                console.error('ğŸ’¾ v5.90.525: current-rides-display nicht gefunden!');
                return;
            }
            
            console.log(`ğŸ¨ v5.90.525: Rendere ${rides.length} Fahrten (zeige erste)`);
            
            if (rides.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            // Zeige Container
            container.style.display = 'block';
            
            // ğŸ†• v5.90.525: NUR ERSTE FAHRT!
            const ride = rides[0];
            const timeValue = ride.timestamp || ride.pickupTimestamp || ride.createdAt;
            const time = timeValue ? new Date(timeValue).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) : '??:??';
            const statusColor = getStatusColor(ride.status);
            const statusText = getStatusText(ride.status);
            
            container.innerHTML = `
                <div style="background:white;border:3px solid ${statusColor};border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.1);">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                        <div style="font-weight:700;font-size:20px;color:#111827;">ğŸ• ${time}</div>
                        <div style="background:${statusColor};color:white;padding:6px 12px;border-radius:20px;font-size:12px;font-weight:700;">${statusText}</div>
                    </div>
                    ${rides.length > 1 ? `
                        <div style="background:#fef3c7;padding:8px 12px;border-radius:8px;margin-bottom:15px;font-size:13px;color:#92400e;">
                            â„¹ï¸ + ${rides.length - 1} weitere Fahrt${rides.length > 2 ? 'en' : ''}
                        </div>
                    ` : ''}
                    <div style="margin-bottom:15px;">
                        <div style="display:flex;align-items:start;gap:10px;margin-bottom:8px;">
                            <div style="font-size:20px;">ğŸ“</div>
                            <div style="flex:1;">
                                <div style="font-size:12px;color:#6b7280;margin-bottom:2px;">VON</div>
                                <div style="font-weight:600;font-size:15px;color:#111827;">${ride.pickup || 'Unbekannt'}</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:start;gap:10px;">
                            <div style="font-size:20px;">ğŸ¯</div>
                            <div style="flex:1;">
                                <div style="font-size:12px;color:#6b7280;margin-bottom:2px;">NACH</div>
                                <div style="font-weight:600;font-size:15px;color:#111827;">${ride.dropoff || ride.destination || 'Unbekannt'}</div>
                            </div>
                        </div>
                    </div>
                    ${ride.customerName ? `
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;padding:10px;background:#f9fafb;border-radius:8px;">
                            <span style="font-size:16px;">ğŸ’¾</span>
                            <span style="font-weight:600;color:#111827;">${ride.customerName}</span>
                            ${ride.customerPhone ? `
                                <button onclick="window.open('tel:${ride.customerPhone}')" style="margin-left:auto;padding:8px 12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;">
                                    ğŸ’¾ Anrufen
                                </button>
                            ` : ''}
                        </div>
                    ` : ''}
                    ${ride.estimatedPrice ? `
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:15px;padding:12px;background:linear-gradient(135deg,#f59e0b15,#f59e0b10);border-left:4px solid #f59e0b;border-radius:8px;">
                            <span style="font-size:20px;">ğŸ’°</span>
                            <span style="font-weight:700;font-size:20px;color:#f59e0b;">${ride.estimatedPrice.toFixed(2)} â‚¬</span>
                        </div>
                    ` : ''}
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        ${ride.status === 'assigned' ? `
                            <button onclick="acceptRide('${ride.firebaseId || ride.id}')" style="flex:1;min-width:150px;padding:14px;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-size:15px;">
                                âœ… Annehmen
                            </button>
                            <button onclick="declineRide('${ride.firebaseId || ride.id}')" style="flex:1;min-width:150px;padding:14px;background:linear-gradient(135deg,#ef4444,#dc2626);color:white;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-size:15px;">
                                ğŸ’¾ Ablehnen
                            </button>
                        ` : ''}
                        ${ride.status === 'accepted' ? `
                            <button onclick="updateRideStatus('${ride.firebaseId || ride.id}', 'on_way')" style="flex:1;min-width:150px;padding:14px;background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-size:15px;">
                                ğŸš— Fahre zum Kunden
                            </button>
                        ` : ''}
                        ${ride.status === 'on_way' ? `
                            <button onclick="updateRideStatus('${ride.firebaseId || ride.id}', 'picked_up')" style="flex:1;min-width:150px;padding:14px;background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-size:15px;">
                                ğŸš• Kunde an Bord
                            </button>
                        ` : ''}
                        ${ride.status === 'picked_up' ? `
                            <button onclick="completeRide('${ride.firebaseId || ride.id}')" style="flex:1;min-width:150px;padding:14px;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-size:15px;">
                                âœ… Fahrt abschlieÃŸen
                            </button>
                        ` : ''}
                        ${ride.pickupCoords ? `
                            <button onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${ride.pickupCoords.lat},${ride.pickupCoords.lon}','_blank')" style="padding:14px 20px;background:#6b7280;color:white;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-size:15px;">
                                ğŸ—ºï¸ Navigation
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        function getStatusColor(status) {
            return { 
                'pending': '#f59e0b',      // Neu/Wartet (Orange)
                'assigned': '#eab308',     // ğŸŸ¡ Zugewiesen (Gelb)
                'accepted': '#10b981',     // ğŸŸ¢ Angenommen (GrÃ¼n)
                'picked_up': '#3b82f6',    // ğŸ”µ Kunde drin (Blau)
                'started': '#10b981',      // Unterwegs (GrÃ¼n)
                'completed': '#6b7280',    // Erledigt (Grau)
                'cancelled': '#ef4444'     // Storniert (Rot)
            }[status] || '#6b7280';
        }
        
        function getStatusText(status) {
            return { 
                'new': 'ğŸ†• Neu',
                'vorbestellt': 'ğŸ“… Vorbestellt',
                'pending': 'Neu',
                'assigned': 'ğŸŸ¡ Zugewiesen',
                'accepted': 'ğŸŸ¢ Angenommen',
                'on_way': 'ğŸš— Fahre zum Kunden',  // ğŸ†• v5.90.525!
                'picked_up': 'ğŸ”µ Kunde drin',
                'started': 'Unterwegs',
                'completed': 'Erledigt',
                'cancelled': 'Storniert'
            }[status] || status;
        }
        
        function openNavigation(pickup, destination, type) {
            window.open(`https://www.google.com/maps/dir/${encodeURIComponent(pickup)}/${encodeURIComponent(destination)}`, '_blank');
        }

        // ğŸ†• v5.20.2: GESPEICHERTES FAHRZEUG + STATUS LADEN (aus localStorage)
        async function loadSavedVehicle() {
            if (!currentUser || !currentUser.uid) {
                console.log('â³ Warte auf Login fÃ¼r Fahrzeug-Wiederherstellung...');
                return;
            }
            
            const savedVehicle = localStorage.getItem('lastVehicle_' + currentUser.uid);
            const savedOnlineStatus = localStorage.getItem('lastOnlineStatus_' + currentUser.uid);
            
            if (!savedVehicle) {
                console.log('â„¹ï¸ Kein gespeichertes Fahrzeug gefunden');
                return;
            }
            
            console.log('ğŸ”„ Gespeichertes Fahrzeug gefunden:', savedVehicle, 'Online:', savedOnlineStatus);
            
            // PrÃ¼fe ob Fahrzeug von jemand anderem benutzt wird
            if (isFirebaseReady) {
                try {
                    const driverSnapshot = await db.ref('vehicles/' + savedVehicle).once('value');
                    const driverData = driverSnapshot.val();
                    
                    // ğŸ†• v5.90.551: ADMIN SOLLTE KEIN FAHRZEUG VORAUSWÃ„HLEN!
                    const isAdmin = currentUser.role === 'admin';
                    
                    if (isAdmin) {
                        console.log('â„¹ï¸ Admin: Keine automatische Fahrzeug-Vorauswahl');
                        // Admin nutzt Schnellbuchung - kein Fahrzeug nÃ¶tig!
                        return;
                    }
                    
                    if (driverData && driverData.online && driverData.userId && driverData.userId !== currentUser.uid) {
                        // Fahrzeug wird von jemand anderem benutzt!
                        console.log('âš ï¸ Fahrzeug wird von anderem User benutzt:', driverData.userId);
                        
                        // ğŸ†• v5.90.550: Zeige wer das Fahrzeug nutzt!
                        let userName = 'einem anderen Fahrer';
                        if (driverData.userName) {
                            userName = driverData.userName;
                        } else if (driverData.email) {
                            userName = driverData.email;
                        }
                        
                        alert(
                            'âš ï¸ Dein letztes Fahrzeug (' + (VEHICLES[savedVehicle]?.name || savedVehicle) + ') wird gerade benutzt!\n\n' +
                            'ğŸ‘¤ Fahrer: ' + userName + '\n\n' +
                            'Bitte wÃ¤hle ein anderes Fahrzeug oder warte bis das Fahrzeug wieder frei ist.'
                        );
                        return;
                    }
                    
                    // Fahrzeug ist frei - automatisch auswÃ¤hlen
                    const dropdown = document.getElementById('vehicle');
                    if (dropdown) {
                        dropdown.value = savedVehicle;
                        currentVehicle = savedVehicle;
                        console.log('âœ… Fahrzeug automatisch wiederhergestellt:', savedVehicle);
                        
                        // Toggle aktivieren
                        const toggle = document.getElementById('online-toggle');
                        if (toggle) {
                            toggle.disabled = false;
                            toggle.style.opacity = '1';
                            toggle.style.cursor = 'pointer';
                            
                            // ğŸ†• v5.20.2: War der Fahrer vorher online? Dann automatisch wieder online!
                            if (savedOnlineStatus === 'true') {
                                console.log('ğŸŸ¢ Fahrer war online - stelle Status wieder her...');
                                toggle.checked = true;
                                isOnline = true;
                                
                                // GPS starten
                                startDriverTracking(null);
                                
                                // In Firebase als online markieren
                                const userContact = currentUser.email || currentUser.phoneNumber || 'Unbekannt';
                                db.ref('vehicles/' + savedVehicle).update({
                                    online: true,
                                    userId: currentUser.uid,
                                    userEmail: userContact,
                                    lastOnline: Date.now()
                                });
                                
                                console.log('âœ… Fahrer automatisch wieder ONLINE!');
                                
                                // Protokoll
                                const vehicleName = VEHICLES[savedVehicle]?.name || savedVehicle;
                                logActivity('driver', 'online', 
                                    `Fahrer ${userContact} (${vehicleName}) ist jetzt ONLINE (Auto-Restore)`, {
                                    vehicle: savedVehicle,
                                    driver: vehicleName,
                                    email: userContact
                                });
                            }
                        }
                        
                        // Telegram-ID laden
                        loadDriverTelegramId();
                        
                        updateViews();
                    }
                    
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim PrÃ¼fen des Fahrzeugs:', error);
                }
            }
        }

        // ğŸ”„ TOGGLE STATE SYNCHRONISIEREN
        function syncToggleState() {
            const toggle = document.getElementById('online-toggle');
            if (!toggle) return;
            
            console.log('ğŸ”„ Synchronisiere Toggle-State...');
            console.log('  - watchId:', watchId);
            console.log('  - isOnline:', isOnline);
            console.log('  - currentVehicle:', currentVehicle);
            
            // PrÃ¼fe ob GPS wirklich lÃ¤uft
            if (watchId && currentVehicle) {
                // GPS lÃ¤uft - soll online sein
                if (!isOnline || !toggle.checked) {
                    console.log('âœ… GPS lÃ¤uft, aber Toggle off â†’ Korrigiere auf ON');
                    isOnline = true;
                    toggle.checked = true;
                    
                    // Update UI
                    const statusText = document.getElementById('online-status-text');
                    if (statusText) {
                        statusText.textContent = 'Online';
                        statusText.style.color = '#10b981';
                    }
                }
            } else {
                // Kein GPS - soll offline sein
                if (isOnline || toggle.checked) {
                    console.log('âš ï¸ Kein GPS, aber Toggle on â†’ Korrigiere auf OFF');
                    isOnline = false;
                    toggle.checked = false;
                    
                    // Update UI
                    const statusText = document.getElementById('online-status-text');
                    if (statusText) {
                        statusText.textContent = 'Offline';
                        statusText.style.color = '#666';
                    }
                }
            }
            
            console.log('âœ… Toggle-State synchronisiert:', isOnline ? 'ON' : 'OFF');
        }

        // ğŸ†• v5.19.0: STANDBY-MODUS (LTE/WiFi - grobe Position)
        // LÃ¤uft im Hintergrund, geringer Akku, reicht fÃ¼r Auftragsvermittlung!
        function startStandbyTracking() {
            if (!currentVehicle) {
                console.error('ğŸ’¾ Kein Fahrzeug ausgewÃ¤hlt!');
                return;
            }
            
            // Stoppe evtl. laufendes aktives GPS
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            // Stoppe evtl. laufendes Standby-Interval
            if (standbyIntervalId) {
                clearInterval(standbyIntervalId);
                standbyIntervalId = null;
            }
            
            gpsMode = 'standby';
            console.log('ğŸ“¡ STANDBY-MODUS gestartet (LTE/WiFi, alle 2 Min)');
            
            // Update UI
            const statusDiv = document.getElementById('gps-status-compact');
            const iconSpan = document.getElementById('gps-icon-compact');
            const textSpan = document.getElementById('gps-text-compact');
            if (statusDiv && iconSpan && textSpan) {
                statusDiv.style.background = 'rgba(59,130,246,0.1)';
                statusDiv.style.color = '#3b82f6';
                iconSpan.textContent = 'ğŸ“¡';
                textSpan.textContent = 'Standby';
            }
            
            // ğŸ†• v5.90.319: ISARFUNK GPS-Status bleibt "GPS an" (kein Standby!)
            const gpsIcon = document.getElementById('driver-gps-icon');
            const gpsText = document.getElementById('driver-gps-text');
            if (gpsIcon) gpsIcon.textContent = 'ğŸŸ¢';
            if (gpsText) gpsText.textContent = 'GPS an';
            
            // ğŸ“œ PROTOKOLL
            const vehicleName = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle;
            logActivity('gps', 'standby', `ğŸ“¡ Standby-Modus: ${vehicleName}`, {
                vehicle: currentVehicle,
                driver: vehicleName,
                mode: 'standby'
            });
            
            // SOFORT erste Position holen (grob)
            getStandbyPosition();
            
            // ğŸ†• v5.20.6: Alle 2 Minuten (statt 5) fÃ¼r bessere ZuverlÃ¤ssigkeit
            standbyIntervalId = setInterval(() => {
                if (isOnline && currentVehicle && gpsMode === 'standby') {
                    getStandbyPosition();
                }
            }, 2 * 60 * 1000); // 2 Minuten
            
            console.log('âœ… Standby-Interval gestartet (alle 2 Min)');
        }
        
        // ğŸ†• Grobe Position holen (Mobilfunk/WiFi)
        function getStandbyPosition() {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const location = { 
                        lat: pos.coords.latitude, 
                        lon: pos.coords.longitude, 
                        timestamp: Date.now(), 
                        vehicleId: currentVehicle,
                        vehicle: VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle,
                        online: isOnline,
                        accuracy: pos.coords.accuracy,
                        mode: 'standby', // ğŸ†• Markiere als Standby-Position
                        userEmail: currentUser ? (currentUser.email || currentUser.phoneNumber || '') : '',
                        userId: currentUser ? currentUser.uid : ''
                    };
                    
                    console.log('ğŸ“¡ Standby-Position:', location.lat.toFixed(4), location.lon.toFixed(4), 
                                'Genauigkeit:', Math.round(location.accuracy), 'm');
                    
                    // ğŸ†• v5.90.310: Speichere fÃ¼r GPS-Status Anzeige!
                    localStorage.setItem('lastGpsUpdate', Date.now().toString());
                    localStorage.setItem('lastGpsAccuracy', Math.round(location.accuracy).toString());
                    
                    // Update UI
                    const statusDiv = document.getElementById('gps-status-compact');
                    const iconSpan = document.getElementById('gps-icon-compact');
                    const textSpan = document.getElementById('gps-text-compact');
                    if (statusDiv && iconSpan && textSpan) {
                        statusDiv.style.background = 'rgba(16,185,129,0.1)';
                        statusDiv.style.color = '#10b981';
                        iconSpan.textContent = 'ğŸ“¡';
                        textSpan.textContent = Math.round(location.accuracy) + 'm';
                    }
                    
                    // In Firebase speichern
                    if (isFirebaseReady) {
                        db.ref('vehicles/' + currentVehicle).set(location).then(() => {
                            console.log('âœ… Standby-Position â†’ Firebase');
                        }).catch(err => {
                            console.error('ğŸ’¾ Standby-Upload Fehler:', err);
                        });
                    }
                    
                    // Update lastGPSUpdate
                    lastGPSUpdate = Date.now();
                },
                (err) => {
                    console.warn('âš ï¸ Standby-Position Fehler:', err.message);
                    
                    // Update UI
                    const statusDiv = document.getElementById('gps-status-compact');
                    const iconSpan = document.getElementById('gps-icon-compact');
                    const textSpan = document.getElementById('gps-text-compact');
                    if (statusDiv && iconSpan && textSpan) {
                        statusDiv.style.background = 'rgba(239,68,68,0.1)';
                        statusDiv.style.color = '#ef4444';
                        iconSpan.textContent = 'ğŸ’¾';
                        textSpan.textContent = 'Fehler';
                    }
                },
                { 
                    enableHighAccuracy: false,  // ğŸ”‘ WICHTIG: Nutzt LTE/WiFi statt GPS!
                    maximumAge: 5 * 60 * 1000,  // Akzeptiere 5 Min alte Position
                    timeout: 30000               // 30 Sek Timeout
                }
            );
        }
        
        // ğŸ†• v5.19.0: AKTIV-MODUS (GPS prÃ¤zise - fÃ¼r laufende Fahrt)
        function startActiveTracking(rideId) {
            if (!currentVehicle) {
                console.error('ğŸ’¾ Kein Fahrzeug ausgewÃ¤hlt!');
                return;
            }
            
            // Stoppe Standby-Modus
            if (standbyIntervalId) {
                clearInterval(standbyIntervalId);
                standbyIntervalId = null;
            }
            
            gpsMode = 'active';
            currentTrackingRideId = rideId || null;
            console.log('ğŸ¯ AKTIV-MODUS gestartet (GPS prÃ¤zise)' + (rideId ? ' fÃ¼r Fahrt: ' + rideId : ''));
            
            // Update UI
            const statusDiv = document.getElementById('gps-status-compact');
            const iconSpan = document.getElementById('gps-icon-compact');
            const textSpan = document.getElementById('gps-text-compact');
            if (statusDiv && iconSpan && textSpan) {
                statusDiv.style.background = 'rgba(102,126,234,0.1)';
                statusDiv.style.color = '#667eea';
                iconSpan.textContent = 'ğŸ”„';
                textSpan.textContent = 'GPS...';
            }
            
            // Rufe die bestehende GPS-Funktion auf
            startDriverTracking(rideId);
        }
        
        // ğŸ†• v5.19.0: ZurÃ¼ck zu Standby nach Fahrt
        function switchToStandby() {
            if (!isOnline || !currentVehicle) return;
            
            console.log('ğŸ”„ Wechsle zurÃ¼ck zu Standby-Modus...');
            
            // Stoppe aktives GPS
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            // Stoppe Intervalle
            if (window.gpsRegularInterval) {
                clearInterval(window.gpsRegularInterval);
                window.gpsRegularInterval = null;
            }
            
            currentTrackingRideId = null;
            
            // Starte Standby
            startStandbyTracking();
        }

        function startDriverTracking(rideId) {
            // ğŸ”¥ v5.90.370: Track GPS Start
            trackFunctionCall('startDriverTracking', { rideId: rideId });
            trackGPSStatus('starting', null);
            
            if (!currentVehicle) {
                console.error('ğŸ’¾ Kein Fahrzeug ausgewÃ¤hlt!');
                return;
            }
            
            // ğŸ†• Speichere aktuelle Fahrt-ID fÃ¼r GPS-Tracking
            currentTrackingRideId = rideId || null;
            
            // âœ… WICHTIG: Alte watchId IMMER cleanen BEVOR neu gestartet wird!
            if (watchId) {
                console.log('âš ï¸ GPS lÃ¤uft bereits - watchId:', watchId, '- STOPPE ERST!');
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                console.log('âœ… Alte watchId cleared');
            }
            
            console.log('ğŸš€ Starte GPS-Tracking' + (rideId ? ' fÃ¼r Fahrt: ' + rideId : ''));
            
            // ğŸ†• SOFORT: Status auf "Suche..." setzen
            const gpsIndicator = document.getElementById('gps-indicator');
            const gpsDot = document.getElementById('gps-dot');
            const gpsStatus = document.getElementById('gps-status');
            if (gpsIndicator && gpsDot && gpsStatus) {
                gpsIndicator.style.display = 'flex';
                gpsDot.classList.remove('online');
                gpsStatus.textContent = 'ğŸ“ GPS Suche...';
            }
            const statusDiv = document.getElementById('gps-status-compact');
            const iconSpan = document.getElementById('gps-icon-compact');
            const textSpan = document.getElementById('gps-text-compact');
            if (statusDiv && iconSpan && textSpan) {
                statusDiv.style.background = 'rgba(59,130,246,0.1)';
                statusDiv.style.color = '#3b82f6';
                iconSpan.textContent = 'ğŸ”„';
                textSpan.textContent = 'Suche';
            }
            
            // ğŸ“œ PROTOKOLL: GPS gestartet
            const vehicleName = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle;
            logActivity('gps', 'active', `GPS aktiviert: ${vehicleName}`, {
                vehicle: currentVehicle,
                driver: vehicleName,
                forRide: rideId || 'Standby'
            });
            
            // ğŸ†• ERST: Schnelle erste Position holen (mit niedrigerer Genauigkeit)
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    console.log('âš¡ SCHNELLE erste GPS-Position erhalten!');
                    handleGPSPosition(pos, rideId);
                },
                (err) => {
                    console.warn('âš ï¸ Schnelle Position fehlgeschlagen:', err.message);
                    // Nicht schlimm - watchPosition wird es holen
                },
                { 
                    enableHighAccuracy: false,  // Schneller!
                    maximumAge: 60000,          // Akzeptiere 1 Min alte Position
                    timeout: 5000               // Nur 5 Sek warten
                }
            );
            
            // DANN: watchPosition mit HIGH ACCURACY fÃ¼r kontinuierliche Updates
            watchId = navigator.geolocation.watchPosition(
                (pos) => {
                    handleGPSPosition(pos, rideId);
                },
                (err) => {
                    console.error('ğŸ’¾ GPS Fehler:', err.message, err.code);
                    
                    // ğŸ“œ PROTOKOLL: GPS-Fehler
                    let errorReason = 'Unbekannter Fehler';
                    if (err.code === 1) errorReason = 'Berechtigung verweigert';
                    else if (err.code === 2) errorReason = 'Position nicht verfÃ¼gbar';
                    else if (err.code === 3) errorReason = 'Timeout';
                    
                    const vehicleName = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle;
                    logActivity('gps', 'error', `GPS-Fehler: ${errorReason}`, {
                        vehicle: currentVehicle,
                        driver: vehicleName,
                        errorCode: err.code,
                        errorMessage: err.message
                    });
                    
                    // Update GPS-Indicator
                    const gpsIndicator = document.getElementById('gps-indicator');
                    const gpsDot = document.getElementById('gps-dot');
                    const gpsStatus = document.getElementById('gps-status');
                    if (gpsIndicator && gpsDot && gpsStatus) {
                        gpsIndicator.style.display = 'flex';
                        gpsDot.classList.remove('online');
                        gpsStatus.textContent = 'ğŸ“ GPS: Fehler';
                    }
                    
                    // Bei Timeout (Code 3) -> Automatisch neu versuchen
                    if (err.code === 3 && isOnline) {
                        console.log('â±ï¸ GPS Timeout - versuche erneut in 5 Sekunden...');
                        setTimeout(() => {
                            if (isOnline && !watchId) {
                                console.log('ğŸ”„ GPS-Tracking neu starten...');
                                startDriverTracking(rideId);
                            }
                        }, 5000);
                    } else if (err.code === 1) {
                        // Berechtigung verweigert
                        alert('ğŸ’¾ GPS-Berechtigung verweigert!\n\nBitte in den Einstellungen die Standort-Berechtigung fÃ¼r diese App aktivieren.');
                    }
                },
                { 
                    enableHighAccuracy: true, 
                    maximumAge: 30000,   // ğŸ†• v5.90.578: 30 Sekunden Cache (Akku schonen!)
                    timeout: 15000       // ğŸ†• v5.90.578: 15 Sek Timeout
                }
            );
            
            console.log('ğŸ¯ GPS watchId:', watchId);
            
            // ğŸ†• v5.90.578: GPS Backup-Check - Alle 60 Sekunden (Akku schonen!)
            window.gpsRegularInterval = setInterval(() => {
                if (!isOnline || !currentVehicle) {
                    return;
                }
                
                // ğŸ†• v5.90.578: Backup wenn watchPosition hÃ¤ngt
                console.log('ğŸ“ GPS (60s Backup): Hole Position...');
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        handleGPSPosition(pos, currentTrackingRideId);
                        console.log('ğŸ“ GPS (60s Backup): Position erhalten');
                    },
                    (err) => {
                        console.warn('âš ï¸ GPS 60s Backup-Fehler:', err.message);
                    },
                    { enableHighAccuracy: true, maximumAge: 30000, timeout: 15000 }
                );
            }, 60000); // ğŸ†• v5.90.578: Alle 60 Sekunden (Akku schonen!)
            
            console.log('âœ… GPS 60s Backup-Intervall gestartet');
            
            // ğŸ†• v5.61.0: GPS-HEALTH-MONITOR - Warnt Fahrer bei GPS-Problemen!
            startGPSHealthMonitor();
        }
        
        // ğŸ†• v5.61.0: GPS HEALTH MONITOR
        function startGPSHealthMonitor() {
            // Stoppe alte Intervalle falls vorhanden
            if (window.gpsHealthMonitor) {
                clearInterval(window.gpsHealthMonitor);
            }
            
            console.log('ğŸ¥ GPS Health Monitor gestartet');
            
            window.gpsHealthMonitor = setInterval(() => {
                // Nur wenn Fahrer online und Fahrzeug gewÃ¤hlt
                if (!isOnline || !currentVehicle) {
                    return;
                }
                
                const warningBanner = document.getElementById('gps-warning-banner');
                const warningText = document.getElementById('gps-warning-text');
                
                if (!warningBanner || !warningText) {
                    return;
                }
                
                // PrÃ¼fe wie lange letztes GPS-Update her ist
                const timeSinceLastUpdate = Date.now() - (lastGPSUpdate || 0);
                
                // KRITISCH: LÃ¤nger als 30 Sekunden kein Update!
                if (timeSinceLastUpdate > 30000) {
                    // Zeige Warnung!
                    warningBanner.style.display = 'block';
                    
                    // Berechne wie lange her
                    const secondsAgo = Math.floor(timeSinceLastUpdate / 1000);
                    const minutesAgo = Math.floor(secondsAgo / 60);
                    
                    let timeText = '';
                    if (minutesAgo > 0) {
                        timeText = `vor ${minutesAgo} Min ${secondsAgo % 60} Sek`;
                    } else {
                        timeText = `vor ${secondsAgo} Sek`;
                    }
                    
                    warningText.innerHTML = `ğŸ“ Letzte GPS-Position: ${timeText}<br>âš ï¸ GPS sendet keine Updates mehr!`;
                    
                    console.warn(`ğŸš¨ GPS-WARNUNG: Letztes Update ${timeText}`);
                } else {
                    // GPS funktioniert - Warnung ausblenden
                    warningBanner.style.display = 'none';
                }
            }, 10000); // Alle 10 Sekunden prÃ¼fen
        }
        
// ğŸ†• v5.90.592: DIAGNOSE-SYSTEM

// Globale Metriken
window.diagnostics = {
    gps: {
        updates: 0,
        errors: 0,
        lastUpdate: null,
        accuracy: [],
        updateTimes: []
    },
    firebase: {
        writes: 0,
        reads: 0,
        errors: 0,
        latencies: []
    },
    system: {
        memoryUsage: [],
        activeIntervals: 0,
        activeListeners: 0,
        cpuHigh: false
    },
    events: {
        ridesAccepted: 0,
        statusChanges: 0,
        errors: []
    },
    startTime: Date.now()
};

// Sammle GPS-Metriken
function trackGPSUpdate(position) {
    const now = Date.now();
    const metrics = window.diagnostics.gps;
    
    metrics.updates++;
    metrics.lastUpdate = now;
    
    if (position.coords.accuracy) {
        metrics.accuracy.push(position.coords.accuracy);
        if (metrics.accuracy.length > 20) metrics.accuracy.shift();
    }
    
    if (metrics.updateTimes.length > 0) {
        const timeSinceLast = now - metrics.updateTimes[metrics.updateTimes.length - 1];
        // Log wenn Updates zu hÃ¤ufig (< 5s) oder zu selten (> 60s)
        if (timeSinceLast < 5000 || timeSinceLast > 60000) {
            console.warn(`âš ï¸ GPS Update Timing: ${timeSinceLast}ms`);
        }
    }
    
    metrics.updateTimes.push(now);
    if (metrics.updateTimes.length > 20) metrics.updateTimes.shift();
}

// Sammle Firebase-Metriken
function trackFirebaseWrite(path, duration) {
    const metrics = window.diagnostics.firebase;
    metrics.writes++;
    if (duration) {
        metrics.latencies.push(duration);
        if (metrics.latencies.length > 20) metrics.latencies.shift();
    }
    
    // Warnung bei zu vielen Writes
    if (metrics.writes > 100) {
        console.warn(`âš ï¸ Viele Firebase Writes: ${metrics.writes}`);
    }
}

function trackFirebaseRead(path, duration) {
    const metrics = window.diagnostics.firebase;
    metrics.reads++;
    if (duration) {
        metrics.latencies.push(duration);
        if (metrics.latencies.length > 20) metrics.latencies.shift();
    }
}

// Memory Tracking
function trackMemoryUsage() {
    if (performance.memory) {
        const usage = Math.round(performance.memory.usedJSHeapSize / 1048576); // MB
        window.diagnostics.system.memoryUsage.push(usage);
        if (window.diagnostics.system.memoryUsage.length > 20) {
            window.diagnostics.system.memoryUsage.shift();
        }
        
        // Warnung bei > 100 MB
        if (usage > 100) {
            console.warn(`âš ï¸ Hoher Memory-Verbrauch: ${usage} MB`);
        }
    }
}

// Zeige Dashboard
function showDiagnosticDashboard() {
    const metrics = window.diagnostics;
    const runtime = Math.floor((Date.now() - metrics.startTime) / 60000); // Minuten
    
    // GPS Stats
    const avgAccuracy = metrics.gps.accuracy.length > 0 
        ? Math.round(metrics.gps.accuracy.reduce((a,b) => a+b, 0) / metrics.gps.accuracy.length)
        : 0;
    const gpsPerMin = runtime > 0 ? Math.round(metrics.gps.updates / runtime) : 0;
    
    // Firebase Stats
    const writesPerMin = runtime > 0 ? Math.round(metrics.firebase.writes / runtime) : 0;
    const readsPerMin = runtime > 0 ? Math.round(metrics.firebase.reads / runtime) : 0;
    const avgLatency = metrics.firebase.latencies.length > 0
        ? Math.round(metrics.firebase.latencies.reduce((a,b) => a+b, 0) / metrics.firebase.latencies.length)
        : 0;
    
    // Memory Stats
    const currentMemory = metrics.system.memoryUsage.length > 0
        ? metrics.system.memoryUsage[metrics.system.memoryUsage.length - 1]
        : 0;
    
    // ğŸ†• v5.90.594: Battery Stats
    const batteryLevel = metrics.battery ? metrics.battery.level : null;
    const batteryCharging = metrics.battery ? metrics.battery.charging : false;
    const batteryDrain = calculateTotalDrain();
    const remainingTime = calculateRemainingTime();
    
    // Status Icons
    const gpsStatus = gpsPerMin >= 3 && gpsPerMin <= 10 ? 'âœ…' : 'âš ï¸';
    const firebaseStatus = writesPerMin < 20 ? 'âœ…' : 'âš ï¸';
    const memoryStatus = currentMemory < 100 ? 'âœ…' : 'âš ï¸';
    const batteryStatus = batteryLevel === null ? 'â¸ï¸' : (batteryLevel > 20 ? 'âœ…' : 'âš ï¸');
    
    // ğŸ†• Battery HTML
    let batteryHTML = '';
    if (batteryLevel !== null) {
        const drainText = batteryDrain !== null && batteryDrain > 0 
            ? `${Math.round(batteryDrain)}%/Std` 
            : 'Berechne...';
        const remainingText = remainingTime !== null && remainingTime > 0
            ? `~${Math.round(remainingTime)} Std`
            : 'Berechne...';
        
        batteryHTML = `
            <div style="margin-bottom:15px;">
                <div style="color:#10b981;font-weight:700;margin-bottom:8px;">ğŸ”‹ AKKU-STATUS</div>
                <div style="padding-left:10px;line-height:1.6;">
                    ${batteryStatus} Level: ${batteryLevel}%<br>
                    ${batteryCharging ? 'ğŸ”Œ' : 'ğŸ”‹'} Status: ${batteryCharging ? 'LÃ¤dt' : 'EntlÃ¤dt'}<br>
                    ${batteryDrain < 20 ? 'âœ…' : 'âš ï¸'} Verbrauch: ${drainText}<br>
                    ${remainingTime > 4 ? 'âœ…' : 'âš ï¸'} Verbleibend: ${remainingText}
                </div>
            </div>
        `;
    }
    
    const html = `
        <div style="position:fixed;top:10px;right:10px;z-index:999999;background:rgba(0,0,0,0.95);color:white;padding:20px;border-radius:12px;font-family:monospace;font-size:12px;max-width:400px;box-shadow:0 8px 32px rgba(0,0,0,0.5);max-height:90vh;overflow-y:auto;">
            <div style="font-size:16px;font-weight:700;margin-bottom:15px;border-bottom:2px solid #3b82f6;padding-bottom:10px;">
                ğŸ” FAHRER-APP DIAGNOSE
                <button onclick="document.getElementById('diagnostic-dashboard').remove()" style="float:right;background:none;border:none;color:white;font-size:20px;cursor:pointer;padding:0;margin:0;">Ã—</button>
            </div>
            
            ${batteryHTML}
            
            <div style="margin-bottom:15px;">
                <div style="color:#3b82f6;font-weight:700;margin-bottom:8px;">ğŸ“ GPS STATUS</div>
                <div style="padding-left:10px;line-height:1.6;">
                    ${gpsStatus} Updates: ${gpsPerMin}/Min (${metrics.gps.updates} total)<br>
                    ${avgAccuracy > 0 && avgAccuracy < 50 ? 'âœ…' : 'âš ï¸'} Genauigkeit: ${avgAccuracy}m<br>
                    ${metrics.gps.lastUpdate ? 'âœ…' : 'âŒ'} Letztes Update: ${metrics.gps.lastUpdate ? 'vor ' + Math.round((Date.now() - metrics.gps.lastUpdate)/1000) + 's' : 'nie'}<br>
                    ${metrics.gps.errors === 0 ? 'âœ…' : 'âŒ'} Fehler: ${metrics.gps.errors}
                </div>
            </div>
            
            <div style="margin-bottom:15px;">
                <div style="color:#f59e0b;font-weight:700;margin-bottom:8px;">ğŸ”¥ FIREBASE STATUS</div>
                <div style="padding-left:10px;line-height:1.6;">
                    ${firebaseStatus} Writes: ${writesPerMin}/Min (${metrics.firebase.writes} total)<br>
                    âœ… Reads: ${readsPerMin}/Min (${metrics.firebase.reads} total)<br>
                    ${avgLatency < 500 ? 'âœ…' : 'âš ï¸'} Latenz: ${avgLatency}ms<br>
                    ${metrics.firebase.errors === 0 ? 'âœ…' : 'âŒ'} Fehler: ${metrics.firebase.errors}
                </div>
            </div>
            
            <div style="margin-bottom:15px;">
                <div style="color:#8b5cf6;font-weight:700;margin-bottom:8px;">ğŸ’» SYSTEM RESSOURCEN</div>
                <div style="padding-left:10px;line-height:1.6;">
                    ${memoryStatus} Memory: ${currentMemory} MB<br>
                    âœ… Laufzeit: ${runtime} Min<br>
                    ${metrics.events.ridesAccepted > 0 ? 'âœ…' : 'â¸ï¸'} Fahrten: ${metrics.events.ridesAccepted}<br>
                    ${metrics.events.errors.length === 0 ? 'âœ…' : 'âŒ'} App-Fehler: ${metrics.events.errors.length}
                </div>
            </div>
            
            <div style="margin-top:15px;padding-top:15px;border-top:1px solid #374151;display:flex;gap:10px;">
                <button onclick="exportDiagnosticLog()" style="flex:1;padding:8px;background:#3b82f6;border:none;border-radius:6px;color:white;font-weight:600;cursor:pointer;">
                    ğŸ“‹ Log Export
                </button>
                <button onclick="resetDiagnostics()" style="flex:1;padding:8px;background:#ef4444;border:none;border-radius:6px;color:white;font-weight:600;cursor:pointer;">
                    ğŸ”„ Reset
                </button>
            </div>
            
            <div style="margin-top:15px;text-align:center;font-size:11px;color:#9ca3af;">
                ${gpsStatus === 'âœ…' && firebaseStatus === 'âœ…' && memoryStatus === 'âœ…' ? 'ğŸŸ¢ ALLES OK' : ''}
                ${gpsStatus === 'âš ï¸' || firebaseStatus === 'âš ï¸' || memoryStatus === 'âš ï¸' ? 'âš ï¸ WARNUNGEN' : ''}
                ${metrics.gps.errors > 0 || metrics.firebase.errors > 0 ? 'âŒ FEHLER' : ''}
            </div>
        </div>
    `;
    
    // Entferne altes Dashboard
    const old = document.getElementById('diagnostic-dashboard');
    if (old) old.remove();
    
    // FÃ¼ge neues hinzu
    const div = document.createElement('div');
    div.id = 'diagnostic-dashboard';
    div.innerHTML = html;
    document.body.appendChild(div);
}


// Export Log
function exportDiagnosticLog() {
    const metrics = window.diagnostics;
    const log = {
        timestamp: new Date().toISOString(),
        runtime: Math.floor((Date.now() - metrics.startTime) / 60000),
        gps: metrics.gps,
        firebase: metrics.firebase,
        system: metrics.system,
        events: metrics.events
    };
    
    const blob = new Blob([JSON.stringify(log, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `fahrer-diagnose-${Date.now()}.json`;
    a.click();
    
    alert('âœ… Diagnose-Log exportiert!');
}

// Reset
function resetDiagnostics() {
    if (confirm('ğŸ”„ Statistiken zurÃ¼cksetzen?')) {
        window.diagnostics = {
            gps: { updates: 0, errors: 0, lastUpdate: null, accuracy: [], updateTimes: [] },
            firebase: { writes: 0, reads: 0, errors: 0, latencies: [] },
            system: { memoryUsage: [], activeIntervals: 0, activeListeners: 0, cpuHigh: false },
            events: { ridesAccepted: 0, statusChanges: 0, errors: [] },
            startTime: Date.now()
        };
        showDiagnosticDashboard();
        alert('âœ… Statistiken zurÃ¼ckgesetzt!');
    }
}

// Auto-Update Dashboard alle 5 Sekunden
setInterval(() => {
    if (document.getElementById('diagnostic-dashboard')) {
        showDiagnosticDashboard();
    }
}, 5000);

// Memory Tracking alle 10 Sekunden
setInterval(trackMemoryUsage, 10000);

console.log('âœ… v5.90.592: Diagnose-System aktiviert!');
console.log('ğŸ’¡ Nutze showDiagnosticDashboard() zum Ã–ffnen');

// ğŸ†• v5.90.593: FIREBASE-TRACKING WRAPPER

// Originale Firebase-Funktionen sichern
const originalUpdate = firebase.database.Reference.prototype.update;
const originalSet = firebase.database.Reference.prototype.set;
const originalOnce = firebase.database.Reference.prototype.once;
const originalOn = firebase.database.Reference.prototype.on;

// WRAPPER: update()
firebase.database.Reference.prototype.update = function(data) {
    const start = Date.now();
    const path = this.toString().split('.com/')[1] || 'unknown';
    
    return originalUpdate.call(this, data).then(result => {
        const duration = Date.now() - start;
        trackFirebaseWrite(path, duration);
        return result;
    }).catch(err => {
        window.diagnostics.firebase.errors++;
        console.error('ğŸ”¥ Firebase Write Error:', err);
        throw err;
    });
};

// WRAPPER: set()
firebase.database.Reference.prototype.set = function(data) {
    const start = Date.now();
    const path = this.toString().split('.com/')[1] || 'unknown';
    
    return originalSet.call(this, data).then(result => {
        const duration = Date.now() - start;
        trackFirebaseWrite(path, duration);
        return result;
    }).catch(err => {
        window.diagnostics.firebase.errors++;
        console.error('ğŸ”¥ Firebase Write Error:', err);
        throw err;
    });
};

// WRAPPER: once() - Read
firebase.database.Reference.prototype.once = function(...args) {
    const start = Date.now();
    const path = this.toString().split('.com/')[1] || 'unknown';
    
    return originalOnce.apply(this, args).then(result => {
        const duration = Date.now() - start;
        trackFirebaseRead(path, duration);
        return result;
    }).catch(err => {
        window.diagnostics.firebase.errors++;
        console.error('ğŸ”¥ Firebase Read Error:', err);
        throw err;
    });
};

console.log('âœ… v5.90.593: Firebase-Tracking aktiviert!');
console.log('ğŸ“Š Alle Writes/Reads werden jetzt gezÃ¤hlt!');

// ğŸ†• v5.90.593: GPS-DEBOUNCING

// Letzte gesendete Position speichern
let lastSentGPSPosition = null;
let lastGPSWrite = 0;

// Berechne Distanz zwischen 2 Punkten (Haversine)
function calculateGPSDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // Erdradius in Metern
    const Ï†1 = lat1 * Math.PI / 180;
    const Ï†2 = lat2 * Math.PI / 180;
    const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
    const Î”Î» = (lon2 - lon1) * Math.PI / 180;

    const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
              Math.cos(Ï†1) * Math.cos(Ï†2) *
              Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c; // Distanz in Metern
}

// PrÃ¼fe ob GPS-Update geschrieben werden soll
function shouldWriteGPSUpdate(lat, lon) {
    const now = Date.now();
    
    // REGEL 1: Erste Position IMMER schreiben
    if (!lastSentGPSPosition) {
        console.log('ğŸ“ v5.90.593: Erste GPS-Position â†’ SCHREIBEN');
        return true;
    }
    
    // REGEL 2: Mindestens alle 2 Minuten schreiben (Lebenszeichen!)
    const timeSinceLastWrite = now - lastGPSWrite;
    if (timeSinceLastWrite > 120000) {
        console.log('ğŸ“ v5.90.593: >2 Min seit letztem Write â†’ SCHREIBEN');
        return true;
    }
    
    // REGEL 3: Nur bei signifikanter Bewegung (>50m) schreiben
    const distance = calculateGPSDistance(
        lastSentGPSPosition.lat,
        lastSentGPSPosition.lon,
        lat,
        lon
    );
    
    if (distance > 50) {
        console.log(`ğŸ“ v5.90.593: Bewegung ${Math.round(distance)}m â†’ SCHREIBEN`);
        return true;
    }
    
    console.log(`ğŸ“ v5.90.593: Bewegung nur ${Math.round(distance)}m â†’ SKIP (Akku schonen!)`);
    return false;
}

// Markiere Position als geschrieben
function markGPSPositionWritten(lat, lon) {
    lastSentGPSPosition = { lat, lon };
    lastGPSWrite = Date.now();
}

console.log('âœ… v5.90.593: GPS-Debouncing aktiviert!');
console.log('ğŸ“ Schreibt nur bei >50m Bewegung oder >2 Min');

// ğŸ†• v5.90.594: BATTERY MONITOR

// Battery-Metriken
window.diagnostics.battery = {
    level: 100,
    charging: false,
    history: [], // Letzte 10 Werte
    startLevel: 100,
    startTime: Date.now()
};

// Battery API starten
async function initBatteryMonitor() {
    if (!('getBattery' in navigator)) {
        console.warn('âš ï¸ Battery API nicht verfÃ¼gbar');
        return;
    }
    
    try {
        const battery = await navigator.getBattery();
        
        console.log('ğŸ“ v5.90.599: Battery Monitor aktiviert!');
        console.log('   Akku:', Math.round(battery.level * 100) + '%');
        console.log('   LÃ¤dt:', battery.charging ? 'Ja' : 'Nein');
        
        // Initial-Werte
        window.diagnostics.battery.level = Math.round(battery.level * 100);
        window.diagnostics.battery.charging = battery.charging;
        window.diagnostics.battery.startLevel = Math.round(battery.level * 100);
        window.diagnostics.battery.startTime = Date.now();
        
        // Event Listeners
        battery.addEventListener('levelchange', () => {
            const level = Math.round(battery.level * 100);
            window.diagnostics.battery.level = level;
            window.diagnostics.battery.history.push({
                level: level,
                time: Date.now()
            });
            
            // Nur letzte 10 Werte behalten
            if (window.diagnostics.battery.history.length > 10) {
                window.diagnostics.battery.history.shift();
            }
            
            console.log('ğŸ”‹ Akku-Level geÃ¤ndert:', level + '%');
        });
        
        battery.addEventListener('chargingchange', () => {
            window.diagnostics.battery.charging = battery.charging;
            console.log('ğŸ”Œ Ladestatus:', battery.charging ? 'LÃ¤dt' : 'EntlÃ¤dt');
        });
        
    } catch (err) {
        console.error('âŒ Battery Monitor Fehler:', err);
    }
}

// Berechne Verbrauch pro Stunde
function calculateBatteryDrain() {
    const battery = window.diagnostics.battery;
    
    if (battery.history.length < 2) {
        return null; // Noch nicht genug Daten
    }
    
    const first = battery.history[0];
    const last = battery.history[battery.history.length - 1];
    
    const levelDiff = first.level - last.level;
    const timeDiff = (last.time - first.time) / 1000 / 60 / 60; // Stunden
    
    if (timeDiff === 0) return null;
    
    return levelDiff / timeDiff; // %/Stunde
}

// Berechne verbleibende Zeit
function calculateRemainingTime() {
    const battery = window.diagnostics.battery;
    const drain = calculateBatteryDrain();
    
    if (!drain || drain <= 0) return null;
    
    const remainingHours = battery.level / drain;
    return remainingHours;
}

// Berechne Gesamt-Verbrauch seit Start
function calculateTotalDrain() {
    const battery = window.diagnostics.battery;
    const runtime = (Date.now() - battery.startTime) / 1000 / 60 / 60; // Stunden
    const totalDrain = battery.startLevel - battery.level;
    
    if (runtime === 0) return 0;
    
    return totalDrain / runtime; // %/Stunde
}

// Starte Battery Monitor
initBatteryMonitor();

// Update Battery alle 30 Sekunden
setInterval(async () => {
    if ('getBattery' in navigator) {
        const battery = await navigator.getBattery();
        window.diagnostics.battery.level = Math.round(battery.level * 100);
        window.diagnostics.battery.charging = battery.charging;
    }
}, 30000);

console.log('âœ… v5.90.594: Battery Monitor lÃ¤uft!');



        // ğŸ”§ FIX v5.90.626: Deklariere lastSentPosition Variable
        let lastSentPosition = null;
        
        // ğŸ†• v5.90.630: EINSTEIGER-MODUS Variablen (Route-Tracking)
        let isTrackingRoute = false;
        let routePoints = [];
        let routeStartTime = null;
        let totalDistance = 0;
        // currentTrackingRideId bereits in Zeile 7703 deklariert
        
        // ğŸ†• Separate Funktion fÃ¼r GPS-Position-Handling
        // ğŸ†• v5.90.593: GPS-Debouncing (siehe oben)
        
        function handleGPSPosition(pos, rideId) {
            // ğŸ†• v5.90.592: DIAGNOSE-TRACKING!
            trackGPSUpdate(pos);
            
            // ğŸ”¥ v5.90.375: UMFANGREICHES GPS DEBUG LOGGING!
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ“ v5.90.578: GPS POSITION ERHALTEN');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('   Fahrzeug:', currentVehicle);
            console.log('   Fahrzeug-Name:', VEHICLES[currentVehicle]?.name || 'Unbekannt');
            console.log('   Online:', isOnline ? 'âœ…' : 'âŒ', isOnline);
            console.log('   Position:', pos.coords.latitude.toFixed(6), pos.coords.longitude.toFixed(6));
            console.log('   Genauigkeit:', Math.round(pos.coords.accuracy), 'm');
            console.log('   Timestamp:', new Date().toLocaleString('de-DE'));
            console.log('   Firebase Ready:', isFirebaseReady ? 'âœ…' : 'âŒ');
            console.log('   rideId:', rideId || 'Standby');
            
            // ğŸ†• v5.90.636: BATTERY-SAVER - Standby-Modus!
            // Bei aktiver Fahrt: HÃ¤ufiger senden (10m / 10s)
            // Im Standby: Seltener senden (50m / 60s)
            const hasActiveRide = rideId && rideId !== 'Standby';
            const minDistance = hasActiveRide ? 0.01 : 0.05;  // 10m vs 50m (in km)
            const minTime = hasActiveRide ? 10000 : 60000;     // 10s vs 60s
            
            if (lastSentPosition) {
                const distance = calculateDistance(
                    lastSentPosition.lat, lastSentPosition.lon,
                    pos.coords.latitude, pos.coords.longitude
                );
                const timeSince = Date.now() - lastSentPosition.timestamp;
                
                console.log('   Distanz seit letztem Send:', Math.round(distance * 1000), 'm');
                console.log('   Zeit seit letztem Send:', Math.round(timeSince / 1000), 's');
                console.log('   ğŸ”‹ Modus:', hasActiveRide ? 'AKTIVE FAHRT (10m/10s)' : 'STANDBY (50m/60s)');
                
                // ğŸ†• v5.90.636: Dynamischer Filter je nach Fahrt-Status
                if (distance < minDistance && timeSince < minTime) {
                    console.log('â­ï¸ v5.90.636: Position nicht signifikant - NICHT senden (Akku schonen!)');
                    console.log(`   Filter: ${hasActiveRide ? '10m/10s' : '50m/60s'}`);
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    
                    // Update nur UI, NICHT Firebase!
                    const gpsIndicator = document.getElementById('gps-indicator');
                    const gpsDot = document.getElementById('gps-dot');
                    const gpsStatus = document.getElementById('gps-status');
                    if (gpsIndicator && gpsDot && gpsStatus) {
                        gpsIndicator.style.display = 'flex';
                        gpsDot.classList.add('online');
                        gpsStatus.textContent = 'ğŸ“ GPS: ' + Math.round(pos.coords.accuracy) + 'm';
                    }
                    return; // â† NICHT zu Firebase senden!
                }
                
                console.log('âœ… v5.90.578: Position signifikant geÃ¤ndert - SENDE zu Firebase!');
            }
            
            // ğŸ”¥ v5.90.370: Track GPS Success
            trackGPSStatus('active', pos);
            
            const location = { 
                lat: pos.coords.latitude, 
                lon: pos.coords.longitude, 
                timestamp: Date.now(), 
                vehicleId: currentVehicle,
                vehicle: VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle,
                online: isOnline,
                accuracy: pos.coords.accuracy,
                userEmail: currentUser ? (currentUser.email || currentUser.phoneNumber || '') : '',
                userId: currentUser ? currentUser.uid : ''
            };
            
            // ğŸ¯ Update lastGPSUpdate fÃ¼r Monitoring
            lastGPSUpdate = Date.now();
            
            // ğŸ†• v5.90.310: Speichere fÃ¼r GPS-Status Anzeige!
            localStorage.setItem('lastGpsUpdate', Date.now().toString());
            localStorage.setItem('lastGpsAccuracy', Math.round(pos.coords.accuracy).toString());
            
            // Update GPS-Indicator
            const gpsIndicator = document.getElementById('gps-indicator');
            const gpsDot = document.getElementById('gps-dot');
            const gpsStatus = document.getElementById('gps-status');
            if (gpsIndicator && gpsDot && gpsStatus) {
                gpsIndicator.style.display = 'flex';
                gpsDot.classList.add('online');
                gpsStatus.textContent = 'ğŸ“ GPS: ' + Math.round(location.accuracy) + 'm';
            }
            
            // ğŸ†• Update AUCH Compact-GPS-Status in der Toolbar!
            const statusDiv = document.getElementById('gps-status-compact');
            const iconSpan = document.getElementById('gps-icon-compact');
            const textSpan = document.getElementById('gps-text-compact');
            if (statusDiv && iconSpan && textSpan) {
                statusDiv.style.background = 'rgba(16,185,129,0.1)';
                statusDiv.style.color = '#10b981';
                iconSpan.textContent = 'ğŸ“';
                textSpan.textContent = Math.round(location.accuracy) + 'm';
            }
            
            // ğŸ†• v5.61.0: GPS-WARNUNG AUSBLENDEN wenn GPS wieder funktioniert!
            const warningBanner = document.getElementById('gps-warning-banner');
            if (warningBanner) {
                warningBanner.style.display = 'none';
            }
            
            if (!isFirebaseReady) {
                console.error('ğŸ’¾ v5.90.375: Firebase nicht bereit - GPS wird NICHT gesendet!');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                return;
            }
            
            // ğŸ†• v5.90.593: DEBOUNCING - Nur bei Bewegung >50m schreiben!
            if (!shouldWriteGPSUpdate(location.lat, location.lon)) {
                console.log('â­ï¸ v5.90.593: GPS-Update ÃœBERSPRUNGEN (Akku schonen!)');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                return; // SKIP Firebase Write!
            }
            
            console.log('ğŸ“¤ Sende GPS zu Firebase...');
            
            // ğŸ†• v5.90.525: Erstelle Fahrzeug in Firebase wenn nicht vorhanden!
            const vehicleData = {
                id: currentVehicle,
                name: VEHICLES[currentVehicle]?.name || 'Unbekannt',
                plate: VEHICLES[currentVehicle]?.plate || currentVehicle,
                lat: location.lat,
                lon: location.lon,
                timestamp: location.timestamp,
                lastUpdate: location.timestamp, // FÃ¼r Sync-Check!
                accuracy: location.accuracy,
                online: location.online,
                userId: location.userId,
                userEmail: location.userEmail
            };
            
            // ğŸ”¥ v5.90.525: Schreibe in vehicles/ (fÃ¼r Position)
            db.ref('vehicles/' + currentVehicle).set(vehicleData).then(() => {
                console.log('âœ… GPS â†’ vehicles/' + currentVehicle + ' ERFOLGREICH!');
                
                // ğŸ†• v5.90.593: Markiere als geschrieben fÃ¼r Debouncing
                markGPSPositionWritten(location.lat, location.lon);
            }).catch(err => {
                console.error('ğŸ’¾ Fehler beim GPS-Upload (vehicles):', err);
                console.error('   Fehler-Details:', err.message);
                console.error('   Path:', 'vehicles/' + currentVehicle);
            });
            
            // ğŸ”¥ v5.90.525: AUCH in drivers/ schreiben (fÃ¼r Sync-Check!)
            db.ref('drivers/' + currentVehicle).set(vehicleData).then(() => {
                console.log('âœ… GPS â†’ drivers/' + currentVehicle + ' ERFOLGREICH!');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            }).catch(err => {
                console.error('ğŸ’¾ Fehler beim GPS-Upload (drivers):', err);
                console.error('   Fehler-Details:', err.message);
                console.error('   Path:', 'drivers/' + currentVehicle);
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            });
            
            // Wenn rideId vorhanden, auch in Fahrt speichern
            if (rideId) {
                db.ref('rides/' + rideId + '/driverLocation').set(location).then(() => {
                    console.log('âœ… GPS â†’ rides/' + rideId + '/driverLocation ERFOLGREICH!');
                }).catch(err => {
                    console.error('âŒ Fehler beim GPS-Upload zur Fahrt:', err);
                });
            }
            
            // ğŸ†• v5.90.578: Speichere letzte gesendete Position
            lastSentPosition = {
                lat: location.lat,
                lon: location.lon,
                timestamp: Date.now()
            };
            console.log('ğŸ’¾ v5.90.578: Letzte Position gespeichert fÃ¼r Filter');
        }
        
        // ğŸ†• v5.90.630: EINSTEIGER-MODUS - Einfache Tracking-Funktionen
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Erdradius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function stopDriverTracking() {
            if (watchId) { 
                navigator.geolocation.clearWatch(watchId); 
                watchId = null; 
                console.log('ğŸ›‘ GPS gestoppt');
                
                // ğŸ“œ PROTOKOLL: GPS deaktiviert
                const vehicleName = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle;
                logActivity('gps', 'inactive', `GPS deaktiviert: ${vehicleName || 'Unbekannt'}`, {
                    vehicle: currentVehicle,
                    driver: vehicleName
                });
            }
            
            // Stoppe auch Fallback-Intervall
            if (window.gpsIntervalId) {
                clearInterval(window.gpsIntervalId);
                window.gpsIntervalId = null;
                console.log('ğŸ›‘ GPS Fallback-Intervall gestoppt');
            }
            
            // ğŸ†• Stoppe 30s Intervall
            if (window.gpsRegularInterval) {
                clearInterval(window.gpsRegularInterval);
                window.gpsRegularInterval = null;
                console.log('ğŸ›‘ GPS 30s Intervall gestoppt');
            }
            
            // ğŸ†• v5.61.0: Stoppe GPS Health Monitor
            if (window.gpsHealthMonitor) {
                clearInterval(window.gpsHealthMonitor);
                window.gpsHealthMonitor = null;
                console.log('ğŸ›‘ GPS Health Monitor gestoppt');
            }
            
            // ğŸ†• v5.61.0: Verstecke GPS-Warnung
            const warningBanner = document.getElementById('gps-warning-banner');
            if (warningBanner) {
                warningBanner.style.display = 'none';
            }
            
            // ğŸ†• v5.90.602: FAHRZEUG KOMPLETT AUS /vehicles LÃ–SCHEN!
            if (isFirebaseReady && currentVehicle) {
                db.ref('vehicles/' + currentVehicle).remove()
                    .then(() => {
                        console.log('ğŸ—‘ï¸ Fahrzeug KOMPLETT aus /vehicles entfernt!');
                    })
                    .catch(err => {
                        console.error('âŒ Fehler beim Entfernen:', err);
                    });
            }
            
            // ğŸ†• v5.90.633: FAHRZEUG ZURÃœCKSETZEN + DROPDOWN LEEREN!
            currentVehicle = null;
            const vehicleSelect = document.getElementById('vehicle');
            if (vehicleSelect) {
                vehicleSelect.value = '';  // ZurÃ¼ck zu "Fahrzeug wÃ¤hlen"
                console.log('ğŸ”§ v5.90.633: Fahrzeug abgewÃ¤hlt - Dropdown auf "Fahrzeug wÃ¤hlen"');
            }
            
            // ğŸ†• v5.90.633: TOGGLE SPERREN bis neues Fahrzeug gewÃ¤hlt!
            const toggle = document.getElementById('online-toggle');
            if (toggle) {
                toggle.disabled = true;
                toggle.checked = false;
                toggle.style.opacity = '0.5';
                toggle.style.cursor = 'not-allowed';
                isOnline = false;
                console.log('ğŸ”’ v5.90.633: Toggle gesperrt - erst Fahrzeug wÃ¤hlen!');
            }
        }

        // ğŸ†• v5.90.361: MIGRATION - Alte Vehicle IDs â†’ Neue Vehicle IDs (Kennzeichen-basiert)
        async function migrateVehicleIds() {
            console.log('ğŸ”„ Starte Vehicle-ID Migration...');
            
            // Mapping: Alte ID â†’ Neue ID (Kennzeichen) + Daten aus DEFAULT_VEHICLES
            const ID_MAPPING = {
                'tesla_model3_1': 'pw-my-222-e',
                'tesla_model3_2': 'pw-ik-222',
                'tesla_model3_3': 'vg-lk-111',
                'tesla_modely_1': 'pw-sk-222',
                'tesla_modely_2': 'pw-ki-222'
            };
            
            try {
                // 1. Migriere /vehicles
                console.log('ğŸ“¦ Migriere /vehicles...');
                const vehiclesSnap = await db.ref('vehicles').once('value');
                const vehicles = vehiclesSnap.val() || {};
                
                for (const [oldId, newId] of Object.entries(ID_MAPPING)) {
                    if (vehicles[oldId]) {
                        console.log(`  âœ… ${oldId} â†’ ${newId}`);
                        
                        // ğŸ†• v5.90.361: NEHME DATEN AUS DEFAULT_VEHICLES (korrekte Namen!)
                        const correctData = DEFAULT_VEHICLES[newId] || vehicles[oldId];
                        
                        // Behalte GPS-Daten wenn vorhanden
                        const gpsData = {};
                        if (vehicles[oldId].lat) gpsData.lat = vehicles[oldId].lat;
                        if (vehicles[oldId].lon) gpsData.lon = vehicles[oldId].lon;
                        if (vehicles[oldId].timestamp) gpsData.timestamp = vehicles[oldId].timestamp;
                        if (vehicles[oldId].online) gpsData.online = vehicles[oldId].online;
                        if (vehicles[oldId].accuracy) gpsData.accuracy = vehicles[oldId].accuracy;
                        if (vehicles[oldId].userId) gpsData.userId = vehicles[oldId].userId;
                        
                        // Merge: Korrekte Stammdaten + GPS-Daten
                        const mergedData = { ...correctData, ...gpsData };
                        
                        // Kopiere zur neuen ID
                        await db.ref('vehicles/' + newId).set(mergedData);
                        console.log(`     ğŸ“ Daten: ${mergedData.name} (${mergedData.plate})`);
                        
                        // LÃ¶sche alte ID
                        await db.ref('vehicles/' + oldId).remove();
                    }
                }
                
                // 2. Migriere rides (vehicleId + assignedTo)
                console.log('ğŸš— Migriere /rides...');
                const ridesSnap = await db.ref('rides').once('value');
                const rides = ridesSnap.val() || {};
                let ridesMigrated = 0;
                
                for (const [rideId, ride] of Object.entries(rides)) {
                    let updated = false;
                    const updates = {};
                    
                    if (ride.vehicleId && ID_MAPPING[ride.vehicleId]) {
                        updates.vehicleId = ID_MAPPING[ride.vehicleId];
                        updated = true;
                    }
                    
                    if (ride.assignedTo && ID_MAPPING[ride.assignedTo]) {
                        updates.assignedTo = ID_MAPPING[ride.assignedTo];
                        updated = true;
                    }
                    
                    if (updated) {
                        await db.ref('rides/' + rideId).update(updates);
                        ridesMigrated++;
                    }
                }
                
                console.log(`  âœ… ${ridesMigrated} Fahrten aktualisiert`);
                
                // 3. Migriere localStorage (lastVehicle)
                console.log('ğŸ’¾ Migriere localStorage...');
                for (const key of Object.keys(localStorage)) {
                    if (key.startsWith('lastVehicle_')) {
                        const oldVehicleId = localStorage.getItem(key);
                        if (oldVehicleId && ID_MAPPING[oldVehicleId]) {
                            localStorage.setItem(key, ID_MAPPING[oldVehicleId]);
                            console.log(`  âœ… ${oldVehicleId} â†’ ${ID_MAPPING[oldVehicleId]}`);
                        }
                    }
                }
                
                console.log('âœ… Migration abgeschlossen!');
                alert('âœ… Vehicle-ID Migration erfolgreich!\n\nAlle Fahrzeuge nutzen jetzt Kennzeichen-basierte IDs.\n\nBitte Seite neu laden!');
                
                // Reload nach 2 Sekunden
                setTimeout(() => location.reload(), 2000);
                
            } catch (error) {
                console.error('ğŸ’¾ Migration-Fehler:', error);
                alert('ğŸ’¾ Fehler bei Migration: ' + error.message);
            }
        }

        // ğŸ”¥ v5.90.369: ULTIMATE SYSTEM DIAGNOSTICS - DER MEGA DEBUG LOGGER!
        let diagnosticsAutoRefresh = null;
        
        function toggleDiagnosticsAutoRefresh() {
            const btn = document.getElementById('diagnostics-auto-refresh-btn');
            
            if (diagnosticsAutoRefresh) {
                // Stop
                clearInterval(diagnosticsAutoRefresh);
                diagnosticsAutoRefresh = null;
                btn.textContent = 'ğŸ”„ START AUTO-REFRESH (1s)';
                btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            } else {
                // Start
                runFullSystemDiagnostics(); // Sofort ausfÃ¼hren
                diagnosticsAutoRefresh = setInterval(runFullSystemDiagnostics, 1000);
                btn.textContent = 'â¹ï¸ STOP AUTO-REFRESH';
                btn.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            }
        }
        
        async function runFullSystemDiagnostics() {
            const container = document.getElementById('diagnostics-container');
            if (!container) return;
            
            const timestamp = new Date().toLocaleString('de-DE');
            
            let html = '';
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // 1ï¸âƒ£ FIREBASE CONNECTION STATUS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            html += createDiagnosticCard('ğŸ”¥ FIREBASE STATUS', `
                <div class="diag-row">
                    <span class="diag-label">Verbindung:</span>
                    <span class="diag-value ${isFirebaseReady ? 'success' : 'error'}">
                        ${isFirebaseReady ? 'âœ… CONNECTED' : 'ğŸ’¾ NOT READY'}
                    </span>
                </div>
                <div class="diag-row">
                    <span class="diag-label">Auth:</span>
                    <span class="diag-value ${currentUser ? 'success' : 'error'}">
                        ${currentUser ? 'âœ… LOGGED IN' : 'ğŸ’¾ NOT LOGGED IN'}
                    </span>
                </div>
                <div class="diag-row">
                    <span class="diag-label">Database URL:</span>
                    <span class="diag-value info">${typeof db !== 'undefined' ? 'funk-taxi-app-default-rtdb.europe-west1.firebasedatabase.app' : 'N/A'}</span>
                </div>
                <div class="diag-row">
                    <span class="diag-label">Timestamp:</span>
                    <span class="diag-value info">${timestamp}</span>
                </div>
            `);
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // 2ï¸âƒ£ CURRENT USER DATA
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            html += createDiagnosticCard('ğŸ’¾ CURRENT USER', `
                <div class="diag-row">
                    <span class="diag-label">User Object:</span>
                    <span class="diag-value ${currentUser ? 'success' : 'error'}">
                        ${currentUser ? 'âœ… EXISTS' : 'ğŸ’¾ NULL'}
                    </span>
                </div>
                ${currentUser ? `
                <div class="diag-row">
                    <span class="diag-label">Email:</span>
                    <span class="diag-value info">${currentUser.email || 'N/A'}</span>
                </div>
                <div class="diag-row">
                    <span class="diag-label">Role:</span>
                    <span class="diag-value ${currentUser.role === 'admin' ? 'success' : currentUser.role === 'driver' ? 'warning' : 'info'}">
                        ${currentUser.role || 'N/A'}
                    </span>
                </div>
                <div class="diag-row">
                    <span class="diag-label">Phone:</span>
                    <span class="diag-value info">${currentUser.phoneNumber || currentUser.phone || 'N/A'}</span>
                </div>
                <div class="diag-row">
                    <span class="diag-label">Name:</span>
                    <span class="diag-value info">${currentUser.displayName || currentUser.name || 'N/A'}</span>
                </div>
                ` : '<div class="diag-row"><span class="diag-value error">ğŸ’¾ Kein User eingeloggt!</span></div>'}
            `);
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // 3ï¸âƒ£ CURRENT VEHICLE STATE
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            html += createDiagnosticCard('ğŸš— CURRENT VEHICLE STATE', `
                <div class="diag-row">
                    <span class="diag-label">currentVehicle:</span>
                    <span class="diag-value ${currentVehicle ? 'success' : 'error'}">
                        ${currentVehicle || 'ğŸ’¾ NULL'}
                    </span>
                </div>
                ${currentVehicle ? `
                <div class="diag-row">
                    <span class="diag-label">Vehicle in VEHICLES[]:</span>
                    <span class="diag-value ${VEHICLES[currentVehicle] ? 'success' : 'error'}">
                        ${VEHICLES[currentVehicle] ? 'âœ… FOUND' : 'ğŸ’¾ NOT FOUND'}
                    </span>
                </div>
                ${VEHICLES[currentVehicle] ? `
                <div class="diag-row">
                    <span class="diag-label">Name:</span>
                    <span class="diag-value info">${VEHICLES[currentVehicle].name || 'N/A'}</span>
                </div>
                <div class="diag-row">
                    <span class="diag-label">Plate:</span>
                    <span class="diag-value info">${VEHICLES[currentVehicle].plate || 'N/A'}</span>
                </div>
                <div class="diag-row">
                    <span class="diag-label">Legacy ID:</span>
                    <span class="diag-value info">${VEHICLES[currentVehicle].legacyId || 'None'}</span>
                </div>
                ` : ''}
                ` : '<div class="diag-row"><span class="diag-value warning">âš ï¸ Kein Fahrzeug ausgewÃ¤hlt</span></div>'}
            `);
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // 4ï¸âƒ£ GPS MAP-NULL-CHECK-FIX STATUS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            html += createDiagnosticCard('ğŸ“ GPS MAP-NULL-CHECK-FIX', `
                <div class="diag-row">
                    <span class="diag-label">watchId:</span>
                    <span class="diag-value ${watchId ? 'success' : 'error'}">
                        ${watchId || 'ğŸ’¾ NULL (GPS AUS)'}
                    </span>
                </div>
                <div class="diag-row">
                    <span class="diag-label">GPS Status:</span>
                    <span class="diag-value ${watchId ? 'success' : 'error'}">
                        ${watchId ? 'âœ… MAP-NULL-CHECK-FIX AKTIV' : 'ğŸ’¾ NICHT AKTIV'}
                    </span>
                </div>
                <div class="diag-row">
                    <span class="diag-label">lastGPSUpdate:</span>
                    <span class="diag-value info">${typeof lastGPSUpdate !== 'undefined' && lastGPSUpdate ? new Date(lastGPSUpdate).toLocaleString('de-DE') : 'N/A'}</span>
                </div>
                <div class="diag-row">
                    <span class="diag-label">gpsMode:</span>
                    <span class="diag-value info">${typeof gpsMode !== 'undefined' ? gpsMode : 'N/A'}</span>
                </div>
            `);
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // 5ï¸âƒ£ FIREBASE VEHICLES (LIVE DATA)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            let vehiclesHtml = '<div class="diag-loading">ğŸ”„ Lade...</div>';
            try {
                const vehiclesSnap = await db.ref('vehicles').once('value');
                const vehicles = vehiclesSnap.val() || {};
                const vehicleIds = Object.keys(vehicles);
                
                vehiclesHtml = `
                    <div class="diag-row">
                        <span class="diag-label">Anzahl:</span>
                        <span class="diag-value info">${vehicleIds.length} Fahrzeuge</span>
                    </div>
                `;
                
                vehicleIds.forEach(id => {
                    const v = vehicles[id];
                    const hasGPS = v.lat && v.lon;
                    const isOldId = id.startsWith('tesla_') || id.startsWith('mercedes_');
                    const gpsAge = v.timestamp ? Math.round((Date.now() - v.timestamp) / 1000) : null;
                    
                    vehiclesHtml += `
                        <div style="background: ${isOldId ? '#fef3c7' : '#f0fdf4'}; border-left: 4px solid ${isOldId ? '#f59e0b' : '#10b981'}; padding: 12px; margin: 8px 0; border-radius: 6px;">
                            <div class="diag-row">
                                <span class="diag-label">${isOldId ? 'âš ï¸' : 'âœ…'} ID:</span>
                                <span class="diag-value" style="font-weight: 700; color: ${isOldId ? '#d97706' : '#059669'};">${id}</span>
                            </div>
                            <div class="diag-row">
                                <span class="diag-label">Name:</span>
                                <span class="diag-value info">${v.name || 'ğŸ’¾ FEHLT'}</span>
                            </div>
                            <div class="diag-row">
                                <span class="diag-label">Kennzeichen:</span>
                                <span class="diag-value info">${v.plate || 'ğŸ’¾ FEHLT'}</span>
                            </div>
                            <div class="diag-row">
                                <span class="diag-label">GPS:</span>
                                <span class="diag-value ${hasGPS ? 'success' : 'error'}">
                                    ${hasGPS ? `âœ… ${v.lat.toFixed(4)}, ${v.lon.toFixed(4)}` : 'ğŸ’¾ KEINE DATEN'}
                                </span>
                            </div>
                            ${gpsAge !== null ? `
                            <div class="diag-row">
                                <span class="diag-label">GPS Alter:</span>
                                <span class="diag-value ${gpsAge < 30 ? 'success' : gpsAge < 120 ? 'warning' : 'error'}">
                                    ${gpsAge < 60 ? `${gpsAge}s` : `${Math.round(gpsAge/60)}min`}
                                    ${gpsAge < 30 ? 'âœ… FRISCH' : gpsAge < 120 ? 'âš ï¸ ALT' : 'ğŸ’¾ ZU ALT'}
                                </span>
                            </div>
                            ` : ''}
                            ${v.online !== undefined ? `
                            <div class="diag-row">
                                <span class="diag-label">Status:</span>
                                <span class="diag-value ${v.online ? 'success' : 'error'}">
                                    ${v.online ? 'âœ… ONLINE' : 'ğŸ’¾ OFFLINE'}
                                </span>
                            </div>
                            ` : ''}
                        </div>
                    `;
                });
            } catch (error) {
                vehiclesHtml = `<div class="diag-error">ğŸ’¾ Fehler: ${error.message}</div>`;
            }
            
            html += createDiagnosticCard('ğŸš— FIREBASE /vehicles', vehiclesHtml);
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // 6ï¸âƒ£ GLOBAL VARIABLES STATE
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            html += createDiagnosticCard('ğŸ’¾ GLOBAL STATE', `
                <div class="diag-row">
                    <span class="diag-label">isOnline:</span>
                    <span class="diag-value ${typeof isOnline !== 'undefined' && isOnline ? 'success' : 'error'}">
                        ${typeof isOnline !== 'undefined' ? (isOnline ? 'âœ… true' : 'ğŸ’¾ false') : 'undefined'}
                    </span>
                </div>
                <div class="diag-row">
                    <span class="diag-label">rides[]:</span>
                    <span class="diag-value info">${typeof rides !== 'undefined' ? rides.length + ' Fahrten' : 'undefined'}</span>
                </div>
                <div class="diag-row">
                    <span class="diag-label">VEHICLES Keys:</span>
                    <span class="diag-value info">${Object.keys(VEHICLES).join(', ')}</span>
                </div>
                <div class="diag-row">
                    <span class="diag-label">bookingSystemOnline:</span>
                    <span class="diag-value ${typeof bookingSystemOnline !== 'undefined' && bookingSystemOnline ? 'success' : 'error'}">
                        ${typeof bookingSystemOnline !== 'undefined' ? (bookingSystemOnline ? 'âœ… true' : 'ğŸ’¾ false') : 'undefined'}
                    </span>
                </div>
            `);
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // 7ï¸âƒ£ FUNCTION CALL TRACKER
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const recentCalls = window.functionCallTracker || [];
            let callsHtml = recentCalls.length === 0 ? 
                '<div class="diag-info">â„¹ï¸ Noch keine Funktionen aufgerufen</div>' : '';
            
            recentCalls.slice(-10).reverse().forEach(call => {
                callsHtml += `
                    <div class="diag-row" style="font-size: 11px; padding: 4px 0; border-bottom: 1px solid #e5e7eb;">
                        <span class="diag-label" style="color: #6b7280;">${call.time}</span>
                        <span class="diag-value info">${call.func}</span>
                    </div>
                `;
            });
            
            html += createDiagnosticCard('ğŸ’¾ FUNCTION CALLS (Last 10)', callsHtml);
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // 8ï¸âƒ£ RECENT ERRORS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const recentErrors = window.errorLog || [];
            let errorsHtml = recentErrors.length === 0 ? 
                '<div class="diag-success">âœ… Keine Fehler!</div>' : '';
            
            recentErrors.slice(-5).reverse().forEach(err => {
                errorsHtml += `
                    <div style="background: #fef2f2; border-left: 4px solid #ef4444; padding: 8px; margin: 8px 0; border-radius: 4px; font-size: 12px;">
                        <div style="color: #dc2626; font-weight: 700; margin-bottom: 4px;">
                            ${err.time}: ${err.message}
                        </div>
                        ${err.stack ? `<pre style="font-size: 10px; color: #6b7280; margin: 0; overflow-x: auto;">${err.stack.slice(0, 200)}...</pre>` : ''}
                    </div>
                `;
            });
            
            html += createDiagnosticCard('ğŸš¨ ERRORS (Last 5)', errorsHtml);
            
            container.innerHTML = html + `
                <style>
                    .diag-row {
                        display: flex;
                        justify-content: space-between;
                        padding: 8px 0;
                        border-bottom: 1px solid #f3f4f6;
                        font-size: 14px;
                    }
                    .diag-label {
                        font-weight: 600;
                        color: #6b7280;
                    }
                    .diag-value {
                        font-family: 'Courier New', monospace;
                        font-weight: 600;
                    }
                    .diag-value.success {
                        color: #10b981;
                    }
                    .diag-value.error {
                        color: #ef4444;
                    }
                    .diag-value.warning {
                        color: #f59e0b;
                    }
                    .diag-value.info {
                        color: #3b82f6;
                    }
                    .diag-loading {
                        text-align: center;
                        padding: 20px;
                        color: #6b7280;
                        font-style: italic;
                    }
                    .diag-success {
                        background: #f0fdf4;
                        color: #166534;
                        padding: 12px;
                        border-radius: 6px;
                        text-align: center;
                        font-weight: 600;
                    }
                    .diag-info {
                        background: #f0f9ff;
                        color: #1e40af;
                        padding: 12px;
                        border-radius: 6px;
                        text-align: center;
                        font-weight: 600;
                    }
                    .diag-error {
                        background: #fef2f2;
                        color: #dc2626;
                        padding: 12px;
                        border-radius: 6px;
                        text-align: center;
                        font-weight: 600;
                    }
                </style>
            `;
        }
        
        function createDiagnosticCard(title, content) {
            return `
                <div style="background: white; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); overflow: hidden;">
                    <div style="background: linear-gradient(135deg, #1f2937 0%, #111827 100%); color: white; padding: 15px; font-size: 16px; font-weight: 700;">
                        ${title}
                    </div>
                    <div style="padding: 15px;">
                        ${content}
                    </div>
                </div>
            `;
        }
        
        // ğŸ”¥ v5.90.369: FUNCTION CALL TRACKER
        window.functionCallTracker = [];
        window.errorLog = [];
        
        // Ãœberschreibe console.error um Fehler zu tracken
        const originalError = console.error;
        console.error = function(...args) {
            window.errorLog.push({
                time: new Date().toLocaleTimeString('de-DE'),
                message: args.join(' '),
                stack: new Error().stack
            });
            if (window.errorLog.length > 50) window.errorLog.shift();
            originalError.apply(console, args);
        };

        // ğŸ”¥ v5.90.370: LIVE DRIVER MONITORING SYSTEM - GOD MODE!
        let monitorAutoRefresh = null;
        
        // ğŸ“¡ Sende Monitoring-Daten nach Firebase
        async function sendMonitoringData(type, data) {
            if (!currentVehicle || !isFirebaseReady) return;
            
            try {
                const monitoringData = {
                    timestamp: Date.now(),
                    vehicleId: currentVehicle,
                    userId: currentUser ? currentUser.uid : 'unknown',
                    userName: currentUser ? (currentUser.displayName || currentUser.email || 'Unbekannt') : 'Unbekannt',
                    type: type,
                    data: data
                };
                
                // Schreibe in /monitoring/drivers/[vehicleId]/
                await db.ref(`monitoring/drivers/${currentVehicle}/${type}`).set(monitoringData);
                
                // Update lastActivity
                await db.ref(`monitoring/drivers/${currentVehicle}/lastActivity`).set({
                    timestamp: Date.now(),
                    action: type
                });
                
            } catch (error) {
                console.error('ğŸ’¾ Monitoring Error:', error);
            }
        }
        
        // ğŸ¯ Track Function Calls
        function trackFunctionCall(funcName, params = {}) {
            const callData = {
                function: funcName,
                params: params,
                time: new Date().toLocaleTimeString('de-DE')
            };
            
            // Lokaler Log
            if (!window.driverFunctionLog) window.driverFunctionLog = [];
            window.driverFunctionLog.push(callData);
            if (window.driverFunctionLog.length > 50) window.driverFunctionLog.shift();
            
            // Send to Firebase
            sendMonitoringData('functionCall', callData);
        }
        
        // ğŸš¨ Track Errors
        const originalDriverError = console.error;
        console.error = function(...args) {
            const errorData = {
                message: args.join(' '),
                time: new Date().toLocaleTimeString('de-DE'),
                stack: new Error().stack
            };
            
            // Lokaler Log
            window.errorLog.push(errorData);
            if (window.errorLog.length > 50) window.errorLog.shift();
            
            // Send to Firebase
            sendMonitoringData('error', errorData);
            
            originalDriverError.apply(console, args);
        };
        
        // ğŸ‘† Track Button Clicks
        function trackButtonClick(buttonName, context = {}) {
            trackFunctionCall('buttonClick', { button: buttonName, ...context });
        }
        
        // ğŸ“ Track GPS Status
        function trackGPSStatus(status, position = null) {
            const gpsData = {
                status: status,
                watchId: watchId || null,
                hasPosition: !!position,
                time: new Date().toLocaleTimeString('de-DE')
            };
            
            if (position) {
                gpsData.lat = position.coords.latitude;
                gpsData.lon = position.coords.longitude;
                gpsData.accuracy = position.coords.accuracy;
            }
            
            sendMonitoringData('gpsStatus', gpsData);
        }
        
        // ğŸ”„ Toggle Monitor Auto-Refresh
        function toggleMonitorAutoRefresh() {
            const btn = document.getElementById('monitor-auto-refresh-btn');
            
            if (monitorAutoRefresh) {
                clearInterval(monitorAutoRefresh);
                monitorAutoRefresh = null;
                btn.textContent = 'ğŸ”„ START LIVE MONITORING';
                btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            } else {
                loadLiveMonitorData(); // Sofort laden
                monitorAutoRefresh = setInterval(loadLiveMonitorData, 2000); // Alle 2 Sekunden
                btn.textContent = 'â¹ï¸ STOP MONITORING';
                btn.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            }
        }
        
        // ğŸ“± Lade Live Monitor Daten
        async function loadLiveMonitorData() {
            const container = document.getElementById('live-monitor-container');
            if (!container || !isFirebaseReady) return;
            
            try {
                // Lade alle Monitoring-Daten
                const monitoringSnap = await db.ref('monitoring/drivers').once('value');
                const monitoring = monitoringSnap.val() || {};
                
                // Lade Fahrzeug-Daten
                const vehiclesSnap = await db.ref('vehicles').once('value');
                const vehicles = vehiclesSnap.val() || {};
                
                const vehicleIds = Object.keys(monitoring);
                
                if (vehicleIds.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; background: white; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
                            <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.5;">ğŸ˜´</div>
                            <div style="font-size: 24px; font-weight: 700; color: #6b7280; margin-bottom: 10px;">
                                Keine aktiven Fahrer
                            </div>
                            <div style="font-size: 16px; color: #9ca3af;">
                                Sobald ein Fahrer die App Ã¶ffnet, erscheint er hier!
                            </div>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                vehicleIds.forEach(vehicleId => {
                    const mon = monitoring[vehicleId];
                    const vehicle = vehicles[vehicleId] || {};
                    
                    // Bestimme Status-Farbe
                    const lastActivity = mon.lastActivity?.timestamp || 0;
                    const ageSeconds = Math.floor((Date.now() - lastActivity) / 1000);
                    const isActive = ageSeconds < 30;
                    const statusColor = isActive ? '#10b981' : ageSeconds < 120 ? '#f59e0b' : '#ef4444';
                    const statusText = isActive ? 'ğŸŸ¢ AKTIV' : ageSeconds < 120 ? 'ğŸŸ¡ IDLE' : 'ğŸ”´ OFFLINE';
                    
                    // GPS Status
                    const gpsStatus = mon.gpsStatus || {};
                    const hasGPS = gpsStatus.hasPosition;
                    const gpsAge = gpsStatus.timestamp ? Math.floor((Date.now() - gpsStatus.timestamp) / 1000) : 999;
                    
                    // Letzter Fehler
                    const lastError = mon.error || {};
                    const hasError = lastError.timestamp && (Date.now() - lastError.timestamp) < 300000; // 5 Min
                    
                    // Function Calls
                    const lastFunc = mon.functionCall || {};
                    
                    html += `
                        <div style="background: white; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); overflow: hidden; border: 3px solid ${statusColor};">
                            <!-- Header -->
                            <div style="background: linear-gradient(135deg, ${statusColor} 0%, ${statusColor}dd 100%); color: white; padding: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-size: 24px; font-weight: 900; margin-bottom: 5px;">
                                            ğŸš— ${vehicle.name || vehicleId}
                                        </div>
                                        <div style="font-size: 14px; opacity: 0.9;">
                                            ${vehicle.plate || 'Kein Kennzeichen'} â€¢ ${mon.userName || 'Unbekannt'}
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 18px; font-weight: 700;">
                                            ${statusText}
                                        </div>
                                        <div style="font-size: 12px; opacity: 0.9;">
                                            vor ${ageSeconds < 60 ? ageSeconds + 's' : Math.floor(ageSeconds/60) + 'min'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Content -->
                            <div style="padding: 20px;">
                                <!-- Vehicle ID -->
                                <div style="background: #f9fafb; border-left: 4px solid #3b82f6; padding: 12px; margin-bottom: 15px; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">VEHICLE ID</div>
                                    <div style="font-size: 16px; font-weight: 700; color: #1f2937; font-family: monospace;">${vehicleId}</div>
                                </div>
                                
                                <!-- GPS Status -->
                                <div style="background: ${hasGPS ? '#f0fdf4' : '#fef2f2'}; border-left: 4px solid ${hasGPS ? '#10b981' : '#ef4444'}; padding: 12px; margin-bottom: 15px; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">ğŸ“ GPS STATUS</div>
                                    <div style="font-size: 14px; font-weight: 700; color: ${hasGPS ? '#059669' : '#dc2626'};">
                                        ${hasGPS ? `âœ… AKTIV (${gpsAge}s alt)` : 'ğŸ’¾ NICHT AKTIV'}
                                    </div>
                                    ${hasGPS && gpsStatus.lat ? `
                                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px; font-family: monospace;">
                                        ${gpsStatus.lat.toFixed(6)}, ${gpsStatus.lon.toFixed(6)}
                                        ${gpsStatus.accuracy ? `â€¢ Â±${Math.round(gpsStatus.accuracy)}m` : ''}
                                    </div>
                                    ` : ''}
                                </div>
                                
                                <!-- Letzte Aktion -->
                                <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; margin-bottom: 15px; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">ğŸ‘† LETZTE AKTION</div>
                                    <div style="font-size: 14px; font-weight: 700; color: #d97706;">
                                        ${lastFunc.data?.function || mon.lastActivity?.action || 'Keine Daten'}
                                    </div>
                                    ${lastFunc.data?.time ? `
                                    <div style="font-size: 11px; color: #92400e; margin-top: 4px;">
                                        ${lastFunc.data.time}
                                        ${lastFunc.data.params?.button ? ` â€¢ Button: ${lastFunc.data.params.button}` : ''}
                                    </div>
                                    ` : ''}
                                </div>
                                
                                <!-- Fehler -->
                                ${hasError ? `
                                <div style="background: #fef2f2; border-left: 4px solid #ef4444; padding: 12px; margin-bottom: 15px; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">ğŸš¨ LETZTER FEHLER</div>
                                    <div style="font-size: 13px; font-weight: 700; color: #dc2626; word-break: break-word;">
                                        ${lastError.data?.message || 'Unbekannter Fehler'}
                                    </div>
                                    <div style="font-size: 11px; color: #991b1b; margin-top: 4px;">
                                        ${lastError.data?.time || ''}
                                    </div>
                                </div>
                                ` : `
                                <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 12px; margin-bottom: 15px; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">âœ… STATUS</div>
                                    <div style="font-size: 14px; font-weight: 700; color: #059669;">
                                        Keine Fehler!
                                    </div>
                                </div>
                                `}
                                
                                <!-- Firebase Verbindung -->
                                <div style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 12px; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">ğŸ”¥ FIREBASE</div>
                                    <div style="font-size: 14px; font-weight: 700; color: #1d4ed8;">
                                        âœ… Verbunden
                                    </div>
                                    <div style="font-size: 11px; color: #1e40af; margin-top: 4px;">
                                        Last Update: ${new Date(lastActivity).toLocaleTimeString('de-DE')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('ğŸ’¾ Monitor Load Error:', error);
                container.innerHTML = `
                    <div style="grid-column: 1/-1; background: #fef2f2; border: 2px solid #ef4444; border-radius: 12px; padding: 20px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ’¾</div>
                        <div style="font-size: 18px; font-weight: 700; color: #dc2626;">
                            Fehler beim Laden: ${error.message}
                        </div>
                    </div>
                `;
            }
        }

        // ğŸ†• v5.90.363: VEHICLE DIAGNOSTICS
        async function runVehicleDiagnostics() {
            const output = document.getElementById('vehicle-diagnostics-output');
            const migrationBtn = document.getElementById('migration-action-btn');
            
            output.innerHTML = 'ğŸ”„ Lade Fahrzeug-Daten aus Firebase...\n\n';
            
            try {
                const vehiclesSnap = await db.ref('vehicles').once('value');
                const vehicles = vehiclesSnap.val() || {};
                
                let report = '';
                report += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
                report += 'ğŸš— VEHICLE ID DIAGNOSTICS REPORT\n';
                report += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
                
                const vehicleIds = Object.keys(vehicles);
                report += `ğŸ“± Anzahl Fahrzeuge: ${vehicleIds.length}\n\n`;
                
                // Check fÃ¼r alte IDs
                const oldIds = vehicleIds.filter(id => id.startsWith('tesla_model') || id.startsWith('tesla_modely'));
                const newIds = vehicleIds.filter(id => id.includes('-'));
                
                if (oldIds.length > 0) {
                    report += 'âš ï¸ ALTE IDs GEFUNDEN:\n';
                    oldIds.forEach(id => {
                        const v = vehicles[id];
                        report += `  ğŸ’¾ ${id}\n`;
                        report += `     Name: ${v.name || 'N/A'}\n`;
                        report += `     Plate: ${v.plate || 'N/A'}\n`;
                        report += `     GPS: ${v.lat && v.lon ? 'âœ… Vorhanden' : 'ğŸ’¾ Fehlt'}\n`;
                        if (v.lat && v.lon) {
                            report += `     Position: ${v.lat.toFixed(4)}, ${v.lon.toFixed(4)}\n`;
                            if (v.timestamp) {
                                const age = Math.round((Date.now() - v.timestamp) / 60000);
                                report += `     Alter: ${age} Min\n`;
                            }
                        }
                        report += '\n';
                    });
                    report += '\n';
                }
                
                if (newIds.length > 0) {
                    report += 'âœ… NEUE IDs (Kennzeichen):\n';
                    newIds.forEach(id => {
                        const v = vehicles[id];
                        report += `  âœ… ${id}\n`;
                        report += `     Name: ${v.name || 'N/A'}\n`;
                        report += `     Plate: ${v.plate || 'N/A'}\n`;
                        report += `     GPS: ${v.lat && v.lon ? 'âœ… Vorhanden' : 'ğŸ’¾ Fehlt'}\n`;
                        if (v.lat && v.lon) {
                            report += `     Position: ${v.lat.toFixed(4)}, ${v.lon.toFixed(4)}\n`;
                            if (v.timestamp) {
                                const age = Math.round((Date.now() - v.timestamp) / 60000);
                                report += `     Alter: ${age} Min\n`;
                            }
                        }
                        report += '\n';
                    });
                    report += '\n';
                }
                
                // Fazit
                report += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
                report += 'ğŸ“‹ FAZIT:\n';
                report += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
                
                if (oldIds.length > 0) {
                    report += 'ğŸ’¾ PROBLEM: Alte IDs gefunden!\n\n';
                    report += 'GRUND WARUM AUTO-ASSIGN NICHT FUNKTIONIERT:\n';
                    report += '1. Fahrer schreiben GPS in alte IDs (tesla_model3_1)\n';
                    report += '2. Auto-Assign sucht in neuen IDs (pw-my-222-e)\n';
                    report += '3. Findet kein GPS â†’ Keine Zuweisung!\n\n';
                    report += 'âœ… LÃ–SUNG: Migration ausfÃ¼hren!\n';
                    report += 'Klicke auf den roten Button unten!\n';
                    
                    // Zeige Migrations-Button
                    migrationBtn.style.display = 'block';
                    migrationBtn.textContent = 'ğŸ”„ MIGRATION JETZT AUSFÃœHREN!';
                    migrationBtn.onclick = runMigrationFromDebug;
                } else {
                    // PrÃ¼fe ob Fahrzeuge fehlende Namen haben
                    const missingData = newIds.filter(id => {
                        const v = vehicles[id];
                        return !v.name || v.name === 'N/A' || !v.plate || v.plate === 'N/A';
                    });
                    
                    if (missingData.length > 0) {
                        report += 'âš ï¸ PROBLEM: Fahrzeugdaten unvollstÃ¤ndig!\n\n';
                        report += 'FOLGENDE FAHRZEUGE HABEN FEHLENDE DATEN:\n';
                        missingData.forEach(id => {
                            const v = vehicles[id];
                            report += `  âš ï¸ ${id}\n`;
                            report += `     Name: ${v.name || 'N/A'}\n`;
                            report += `     Plate: ${v.plate || 'N/A'}\n`;
                        });
                        report += '\n';
                        report += 'GRUND: Migration hat alte Daten kopiert\n';
                        report += 'die keine Namen hatten!\n\n';
                        report += 'âœ… LÃ–SUNG: Fahrzeugdaten reparieren!\n';
                        report += 'Klicke auf den blauen Button unten!\n';
                        
                        // Zeige Repair-Button
                        migrationBtn.style.display = 'block';
                        migrationBtn.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
                        migrationBtn.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.3)';
                        migrationBtn.textContent = 'ğŸ”§ FAHRZEUGDATEN REPARIEREN!';
                        migrationBtn.onclick = repairVehicleData;
                    } else {
                        report += 'âœ… ALLES OK!\n\n';
                        report += 'Alle Fahrzeuge nutzen Kennzeichen-basierte IDs!\n';
                        report += 'Auto-Assign sollte funktionieren.\n';
                        
                        // Verstecke Migrations-Button
                        migrationBtn.style.display = 'none';
                    }
                }
                
                output.textContent = report;
                
            } catch (error) {
                output.textContent = 'ğŸ’¾ Fehler beim Laden:\n\n' + error.message;
                console.error('Diagnostics Fehler:', error);
            }
        }

        // ğŸ†• v5.90.364: REPAIR VEHICLE DATA
        async function repairVehicleData() {
            const confirmed = confirm('ğŸ”§ FAHRZEUGDATEN REPARIEREN\n\n' +
                'Diese Reparatur wird:\n' +
                'âœ… Fehlende Namen aus DEFAULT_VEHICLES holen\n' +
                'âœ… Fehlende Kennzeichen ergÃ¤nzen\n' +
                'âœ… GPS-Daten BEIBEHALTEN\n' +
                'âœ… Priority setzen\n\n' +
                'Fortfahren?');
            
            if (!confirmed) return;
            
            const output = document.getElementById('vehicle-diagnostics-output');
            output.textContent = 'ğŸ”§ Repariere Fahrzeugdaten...\n\nBitte warten...';
            
            try {
                const vehiclesSnap = await db.ref('vehicles').once('value');
                const vehicles = vehiclesSnap.val() || {};
                
                let fixed = 0;
                
                for (const [id, vehicle] of Object.entries(vehicles)) {
                    // PrÃ¼fe ob DEFAULT_VEHICLES Daten hat
                    const defaultData = DEFAULT_VEHICLES[id];
                    
                    if (defaultData) {
                        const needsUpdate = !vehicle.name || vehicle.name === 'N/A' || 
                                          !vehicle.plate || vehicle.plate === 'N/A';
                        
                        if (needsUpdate) {
                            console.log(`ğŸ”§ Repariere ${id}...`);
                            
                            // Merge: DEFAULT_VEHICLES + alte GPS-Daten
                            const updates = {
                                ...defaultData,
                                // Behalte GPS wenn vorhanden
                                ...(vehicle.lat && { lat: vehicle.lat }),
                                ...(vehicle.lon && { lon: vehicle.lon }),
                                ...(vehicle.timestamp && { timestamp: vehicle.timestamp }),
                                ...(vehicle.online && { online: vehicle.online }),
                                ...(vehicle.accuracy && { accuracy: vehicle.accuracy }),
                                ...(vehicle.userId && { userId: vehicle.userId })
                            };
                            
                            await db.ref('vehicles/' + id).set(updates);
                            console.log(`  âœ… ${id}: ${updates.name} (${updates.plate})`);
                            fixed++;
                        }
                    }
                }
                
                output.textContent = `âœ… REPARATUR ERFOLGREICH!\n\n` +
                    `${fixed} Fahrzeug(e) repariert!\n\n` +
                    `Seite lÃ¤dt neu in 2 Sekunden...`;
                
                setTimeout(() => location.reload(), 2000);
                
            } catch (error) {
                output.textContent = 'ğŸ’¾ REPARATUR FEHLER:\n\n' + error.message;
                console.error('Repair Fehler:', error);
            }
        }

        // ğŸ†• v5.90.363: Migration vom Debug-View
        async function runMigrationFromDebug() {
            const confirmed = confirm('ğŸ”„ VEHICLE-ID MIGRATION\n\n' +
                'Diese Migration wird:\n' +
                'âœ… Alte IDs (tesla_model3_1) â†’ Neue IDs (pw-my-222-e)\n' +
                'âœ… Alle Fahrten aktualisieren\n' +
                'âœ… GPS-Daten beibehalten\n' +
                'âœ… Korrekte Fahrzeugnamen verwenden\n\n' +
                'Fortfahren?');
            
            if (!confirmed) return;
            
            const output = document.getElementById('vehicle-diagnostics-output');
            output.textContent = 'ğŸ”„ Migration lÃ¤uft...\n\nBitte warten...';
            
            try {
                await migrateVehicleIds();
                localStorage.setItem('vehicleIdMigration_v361', 'done');
                
                // Zeige Erfolg
                output.textContent = 'âœ… MIGRATION ERFOLGREICH!\n\n' +
                    'Alle Fahrzeuge nutzen jetzt Kennzeichen-basierte IDs!\n\n' +
                    'Seite lÃ¤dt neu in 2 Sekunden...';
                
                // Verstecke Button
                document.getElementById('migration-action-btn').style.display = 'none';
                
            } catch (error) {
                output.textContent = 'ğŸ’¾ MIGRATION FEHLER:\n\n' + error.message;
                console.error('Migration Fehler:', error);
            }
        }

        // ğŸ†• v5.90.362: BUTTON HANDLER fÃ¼r Admin-Banner
        async function runMigrationFromButton() {
            const confirmed = confirm('ğŸ”„ VEHICLE-ID MIGRATION\n\n' +
                'Diese Migration wird:\n' +
                'âœ… Alte IDs (tesla_model3_1) â†’ Neue IDs (pw-my-222-e)\n' +
                'âœ… Alle Fahrten aktualisieren\n' +
                'âœ… GPS-Daten beibehalten\n' +
                'âœ… Korrekte Fahrzeugnamen verwenden\n\n' +
                'Fortfahren?');
            
            if (!confirmed) return;
            
            try {
                await migrateVehicleIds();
                // Banner verstecken
                const banner = document.getElementById('migration-banner');
                if (banner) banner.style.display = 'none';
                // Flag setzen
                localStorage.setItem('vehicleIdMigration_v361', 'done');
            } catch (error) {
                console.error('ğŸ’¾ Migration Fehler:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }


        // ğŸ¯ ALIAS-FUNKTIONEN fÃ¼r bessere Lesbarkeit
        function startGPSTracking() {
            startDriverTracking();
        }
        
        function stopGPSTracking() {
            stopDriverTracking();
        }

        // ğŸ†• v5.90.542: DRIVER STATE MANAGEMENT - Status Persistenz!
        function saveDriverState(rideId, status) {
            if (!currentUser || !currentVehicle) return;
            
            const state = {
                rideId: rideId,
                status: status,
                vehicleId: currentVehicle,
                timestamp: Date.now(),
                userId: currentUser.uid
            };
            
            localStorage.setItem('driverState_' + currentUser.uid, JSON.stringify(state));
            console.log('ğŸ—ºï¸ v5.90.542: Fahrer-Status gespeichert:', status, 'fÃ¼r Fahrt:', rideId);
        }
        
        function loadDriverState() {
            if (!currentUser) return null;
            
            const saved = localStorage.getItem('driverState_' + currentUser.uid);
            if (!saved) return null;
            
            try {
                const state = JSON.parse(saved);
                console.log('ğŸ“‚ v5.90.542: Fahrer-Status geladen:', state);
                return state;
            } catch (e) {
                console.error('ğŸ—ºï¸ v5.90.542: Fehler beim Laden:', e);
                return null;
            }
        }
        
        function clearDriverState() {
            if (!currentUser) return;
            
            localStorage.removeItem('driverState_' + currentUser.uid);
            console.log('ğŸ—‘ï¸ v5.90.542: Fahrer-Status gelÃ¶scht');
        }
        
        async function restoreDriverState() {
            const state = loadDriverState();
            if (!state) {
                console.log('â„¹ï¸ v5.90.542: Kein gespeicherter Status');
                return;
            }
            
            // PrÃ¼fe ob Status noch aktuell (max 24h alt)
            const ageHours = (Date.now() - state.timestamp) / (1000 * 60 * 60);
            if (ageHours > 24) {
                console.log('âš ï¸ v5.90.542: Status zu alt (' + ageHours.toFixed(1) + 'h) â†’ LÃ¶sche');
                clearDriverState();
                return;
            }
            
            // Lade Fahrt aus Firebase
            try {
                const snapshot = await db.ref('rides/' + state.rideId).once('value');
                const ride = snapshot.val();
                
                if (!ride) {
                    console.log('âš ï¸ v5.90.542: Fahrt nicht mehr in Firebase â†’ LÃ¶sche State');
                    clearDriverState();
                    return;
                }
                
                // PrÃ¼fe ob Fahrt schon abgeschlossen
                if (ride.status === 'completed' || ride.status === 'cancelled') {
                    console.log('âœ… v5.90.542: Fahrt bereits abgeschlossen â†’ LÃ¶sche State');
                    clearDriverState();
                    return;
                }
                
                // PrÃ¼fe ob anderer Fahrer
                if (ride.vehicleId && ride.vehicleId !== currentVehicle) {
                    console.log('âš ï¸ v5.90.542: Fahrt von anderem Fahrer â†’ LÃ¶sche State');
                    clearDriverState();
                    return;
                }
                
                console.log('âœ… v5.90.542: Status wiederhergestellt! Status:', ride.status);
                
                // Rendere Fahrt
                renderDriverRides([{ ...ride, firebaseId: state.rideId }]);
                
            } catch (e) {
                console.error('ğŸ—ºï¸ v5.90.542: Fehler beim Wiederherstellen:', e);
                clearDriverState();
            }
        }

        async function acceptRide(rideId) {
            // ğŸ”¥ v5.90.370: Track function call
            trackFunctionCall('acceptRide', { rideId: rideId });
            trackButtonClick('Fahrt annehmen', { rideId: rideId });
            
            if (!currentVehicle) {
                alert('ğŸ’¾ Bitte Fahrzeug wÃ¤hlen!');
                return;
            }
            
            // âœ… SCHLIESSE FULLSCREEN wenn offen
            closeNewRideFullscreen();
            stopRepeatingVibration();
            
            // ğŸ”‹ Aktiviere Normal-Modus bei neuem Auftrag
            if (typeof PowerSaveManager !== 'undefined') {
                PowerSaveManager.onNewRide();
            }
            
            const ride = rides.find(r => r.firebaseId === rideId);
            if (!ride) {
                alert('ğŸ’¾ Fahrt nicht gefunden!');
                return;
            }
            
            // âœ… CHECK: Wurde Fahrt storniert?
            if (ride.status === 'storniert' || ride.cancelledBy || ride.cancelledAt) {
                alert('ğŸš¨ STORNIERT!\n\n' +
                      'Diese Fahrt wurde bereits storniert.\n\n' +
                      (ride.cancellationReason ? `Grund: ${ride.cancellationReason}\n\n` : '') +
                      'Du kannst diese Fahrt nicht mehr annehmen.');
                closeNewRideFullscreen();
                return;
            }
            
            // Zeitwarnung
            if (ride.pickupTimestamp && ride.pickupTimestamp > Date.now()) {
                const minutesUntilPickup = Math.round((ride.pickupTimestamp - Date.now()) / 60000);
                const pickupTimeStr = ride.pickupTime || 'spÃ¤ter';
                
                const confirm = window.confirm(
                    `âš ï¸ ACHTUNG!\n\n` +
                    `Abholung erst um ${pickupTimeStr}\n` +
                    `Das ist in ${minutesUntilPickup} Minuten!\n\n` +
                    `Trotzdem jetzt annehmen und losfahren?`
                );
                
                if (!confirm) return;
            }
            
            // Auto-Online wenn offline
            if (!isOnline) {
                document.getElementById('online-toggle').checked = true;
                toggleOnline();
            }
            
            // ğŸ†• v5.19.0: Wechsle zu AKTIV-MODUS (prÃ¤zises GPS fÃ¼r Kunde!)
            if (gpsMode !== 'active') {
                console.log('ğŸ¯ Fahrt angenommen â†’ Wechsle zu Aktiv-GPS');
                startActiveTracking(rideId);
            }
            
            const vehicleName = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle;
            const vehiclePlate = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].plate : '';
            
            console.log('ğŸ“ Akzeptiere Fahrt:', rideId);
            
            // ğŸš¨ Admin-Alarm: Fahrt wurde zugewiesen
            if (typeof acknowledgedRides !== 'undefined') {
                acknowledgedRides.add(ride.id);
            }
            
            // ğŸ›‘ KRITISCH: Stoppe Assignment-Timer um Timeout zu verhindern!
            if (assignmentTimers[rideId]) {
                clearTimeout(assignmentTimers[rideId]);
                delete assignmentTimers[rideId];
                console.log('â° âœ… Assignment-Timer erfolgreich gestoppt fÃ¼r rideId:', rideId);
            } else {
                console.log('â° â„¹ï¸ Kein Assignment-Timer gefunden fÃ¼r rideId:', rideId, '(evtl. manuell zugewiesen)');
            }
            
            // Update Fahrt in Firebase
            await updateRide(rideId, { 
                status: 'accepted', 
                vehicleId: currentVehicle,
                vehicle: vehicleName,
                vehiclePlate: vehiclePlate,
                driver: vehicleName,
                acceptedAt: Date.now(),
                acceptedBy: 'driver', // ğŸ†• v5.90.270: Fahrer hat angenommen!
                acceptedByName: currentUser ? (currentUser.email || currentUser.phoneNumber || vehicleName) : vehicleName,
                assignedTo: null, // ZurÃ¼cksetzen
                assignmentExpiresAt: null
            });
            
            // ğŸ†• v5.90.542: SPEICHERE STATUS!
            saveDriverState(rideId, 'accepted');
            
            // ğŸ†• v5.90.334: MAP-NULL-CHECK-FIX-LINK SOFORT ERSTELLEN!
            // Nicht mehr warten bis "Fahrt zum Kunden"!
            console.log('ğŸ”— v5.90.334: Erstelle Tracking-Link JETZT...');
            try {
                const trackingLink = await createTrackingLinkForRide(rideId, currentVehicle);
                if (trackingLink) {
                    console.log('âœ… v5.90.334: Tracking-Link erstellt:', trackingLink);
                    
                    // ğŸ“± v5.90.334: SENDE SMS AN KUNDEN!
                    console.log('ğŸ“± v5.90.334: Sende SMS an Kunde...');
                    try {
                        // Lade aktualisierte Fahrt mit trackingLink
                        const updatedRideSnap = await db.ref('rides/' + rideId).once('value');
                        const updatedRide = updatedRideSnap.val();
                        if (updatedRide) {
                            await sendCustomerNotifications(updatedRide);
                            console.log('âœ… v5.90.334: SMS an Kunde versendet!');
                        }
                    } catch (smsError) {
                        console.error('ğŸ’¾ v5.90.334: SMS-Fehler:', smsError);
                    }
                } else {
                    console.warn('âš ï¸ v5.90.334: Tracking-Link konnte nicht erstellt werden');
                }
            } catch (linkError) {
                console.error('ğŸ’¾ v5.90.334: Fehler beim Erstellen des Tracking-Links:', linkError);
                // Fahrt lÃ¤uft trotzdem weiter
            }
            
            // ğŸ“œ PROTOKOLL: Fahrt angenommen
            logActivity('status', 'accepted', `Fahrt angenommen von ${vehicleName}`, {
                customer: ride.customerName,
                driver: vehicleName,
                vehicle: currentVehicle,
                from: ride.pickup,
                to: ride.destination,
                price: ride.price
            });
            
            // GPS erstmal NICHT starten! Erst bei "Fahrt zum Kunden"!
            // Fahrer bereitet sich vor, ist aber noch nicht unterwegs
            
            alert('âœ… Auftrag angenommen!\n\nğŸ“± Tracking-Link wurde erstellt\nğŸ—ºï¸ Klicke auf "ğŸš— FAHRT ZUM KUNDEN" wenn du losfÃ¤hrst!');
            
            // ğŸ†• v5.90.525: AKTUALISIERE SOFORT DIE FAHRER-VIEW!
            setTimeout(() => {
                updateDriverView();
            }, 500);
        }

        
        // ğŸ†• v5.90.289: FAHRT ZUM KUNDEN STARTEN (JETZT AKTIV!)
        async function startDrivingToCustomer(rideId) {
            if (!currentVehicle) {
                alert('ğŸ’¾ Kein Fahrzeug ausgewÃ¤hlt!');
                return;
            }
            
            const ride = rides.find(r => r.firebaseId === rideId);
            if (!ride) {
                alert('ğŸ’¾ Fahrt nicht gefunden!');
                return;
            }
            
            if (ride.status !== 'accepted') {
                alert('ğŸ’¾ Fahrt muss erst angenommen werden!');
                return;
            }
            
            const confirm = window.confirm(
                `ğŸš— LOSFAHREN?\n\n` +
                `Ziel: ${ride.pickup}\n` +
                `Kunde: ${ride.customerName || 'Unbekannt'}\n\n` +
                `âœ… GPS-Tracking wird aktiviert\n` +
                `ğŸ“± Kunde bekommt SMS mit Tracking-Link\n\n` +
                `Jetzt losfahren?`
            );
            
            if (!confirm) return;
            
            // Status auf "on_way" setzen (Fahrt zum Kunden)
            await updateRide(rideId, {
                status: 'on_way',
                startedDrivingAt: Date.now()
            });
            
            // ğŸ”— JETZT Tracking-Link erstellen und SMS senden!
            console.log('ğŸ”— Erstelle Tracking-Link und sende SMS...');
            await createTrackingLinkForRide(rideId, currentVehicle);
            
            // ğŸ“œ PROTOKOLL
            const vehicleName = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle;
            logActivity('status', 'on_way', `Fahrt zum Kunden gestartet von ${vehicleName}`, {
                customer: ride.customerName,
                driver: vehicleName,
                from: ride.pickup,
                to: ride.destination
            });
            
            // ğŸ†• GPS-Tracking starten mit prÃ¤zisem Modus
            if (gpsMode !== 'active') {
                console.log('ğŸ¯ Fahrt gestartet â†’ Wechsle zu Aktiv-GPS');
                startActiveTracking(rideId);
            }
            
            // GPS komplett neu starten mit rideId
            if (watchId) {
                console.log('ğŸ›‘ Stoppe altes GPS');
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            setTimeout(() => {
                startDriverTracking(rideId);
                initDriverMap(rideId);
            }, 100);
            
            alert('âœ… Losgefahren!\n\nğŸ“± Kunde wurde per SMS benachrichtigt\nğŸ—ºï¸ GPS-Tracking lÃ¤uft');
        }
        
        // ğŸ†• v5.90.289: ANGENOMMENE FAHRT STORNIEREN
        async function cancelAcceptedRide(rideId) {
            const ride = rides.find(r => r.firebaseId === rideId);
            if (!ride) {
                alert('ğŸ’¾ Fahrt nicht gefunden!');
                return;
            }
            
            const confirm = window.confirm(
                `âš ï¸ FAHRT STORNIEREN?\n\n` +
                `Ziel: ${ride.pickup}\n` +
                `Kunde: ${ride.customerName || 'Unbekannt'}\n\n` +
                `Die Fahrt wird wieder freigegeben.\n` +
                `Stornieren?`
            );
            
            if (!confirm) return;
            
            // Status zurÃ¼ck auf new, Fahrzeug freigeben
            await updateRide(rideId, {
                status: 'new',
                vehicleId: null,
                assignedVehicle: null,
                vehicle: null,
                vehiclePlate: null,
                vehicleDriver: null,
                acceptedAt: null,
                acceptedBy: null,
                acceptedByName: null
            });
            
            console.log('ğŸ”„ Fahrt storniert und freigegeben:', rideId);
            alert('âœ… Fahrt wurde storniert und freigegeben');
        }

        
        // ğŸ†• v5.90.270: ADMIN KANN FAHRT FÃœR FAHRER AKZEPTIEREN!
        async function adminAcceptRide(rideId) {
            if (currentUser?.role !== 'admin') {
                alert('ğŸ’¾ Nur Admins kÃ¶nnen Fahrten akzeptieren!');
                return;
            }
            
            const ride = rides.find(r => r.firebaseId === rideId);
            if (!ride) {
                alert('ğŸ’¾ Fahrt nicht gefunden!');
                return;
            }
            
            if (ride.status === 'accepted') {
                alert('âœ… Fahrt wurde bereits akzeptiert!');
                return;
            }
            
            const vehicleName = ride.vehicle || 'Unbekannt';
            const confirm = window.confirm(
                `ğŸ”§ ADMIN-AKZEPTIEREN\n\n` +
                `Fahrt: ${ride.pickup} â†’ ${ride.destination}\n` +
                `Fahrzeug: ${vehicleName}\n` +
                `Zeit: ${ride.pickupTime || '?'}\n\n` +
                `Als Admin akzeptieren?\n` +
                `(Fahrer sieht: "Admin-Akzeptiert")`
            );
            
            if (!confirm) return;
            
            const adminName = currentUser.email || currentUser.phoneNumber || 'Admin';
            
            await updateRide(rideId, {
                status: 'accepted',
                acceptedAt: Date.now(),
                acceptedBy: 'admin', // ğŸ†• Admin hat akzeptiert!
                acceptedByName: adminName
            });
            
            // ğŸ“œ PROTOKOLL
            logActivity('status', 'accepted', `Fahrt akzeptiert von Admin ${adminName}`, {
                customer: ride.customerName,
                vehicle: vehicleName,
                from: ride.pickup,
                to: ride.destination,
                price: ride.price,
                acceptedBy: 'admin'
            });
            
            alert('âœ… Fahrt als Admin akzeptiert!');
            
            // Reload views
            if (typeof loadCalendar === 'function') loadCalendar();
            if (typeof updateDriverViewV268 === 'function') updateDriverViewV268();
        }

        async function pickupCustomer(rideId) {
            await updateRide(rideId, { 
                status: 'picked_up',
                pickedUpAt: Date.now() 
            });
            
            // Lade ride NEU aus Firebase und update Display
            const snapshot = await db.ref('rides/' + rideId).once('value');
            const ride = snapshot.val();
            if (ride) {
                ride.firebaseId = rideId;
                updateDriverInfoTop(ride);
                
                // ğŸ“œ PROTOKOLL: Kunde eingestiegen
                const vehicleName = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle;
                logActivity('status', 'picked_up', `Kunde eingestiegen`, {
                    customer: ride.customerName,
                    driver: vehicleName,
                    from: ride.pickup,
                    to: ride.destination,
                    price: ride.price
                });
            }
            
            alert('âœ… Kunde eingestiegen! Navigation zum Ziel lÃ¤uft.');
            updateDriverView();
        }
        
        // ğŸ†• v5.90.300: LOSFAHREN ZUM KUNDEN (Isarfunk-Style!)
        async function startDriving(rideId) {
            console.log('ğŸš— Fahre los zum Kunden:', rideId);
            
            await updateRide(rideId, { 
                status: 'on_way',
                startedDrivingAt: Date.now() 
            });
            
            // Lade ride NEU
            const snapshot = await db.ref('rides/' + rideId).once('value');
            const ride = snapshot.val();
            if (ride) {
                ride.firebaseId = rideId;
                
                // ğŸ“œ PROTOKOLL
                const vehicleName = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle;
                logActivity('status', 'on_way', `Fahre zum Kunden`, {
                    customer: ride.customerName,
                    driver: vehicleName,
                    pickup: ride.pickup
                });
            }
            
            alert('âœ… Fahre zum Kunden!');
            updateDriverView();
        }

        // ğŸ†• v5.90.248: FAHRT VON KARTE ABSCHLIESSEN!
        async function completeRideFromMap(rideId) {
            if (!confirm('Fahrt als abgeschlossen markieren?')) return;
            
            try {
                await completeRide(rideId);
                alert('âœ… Fahrt abgeschlossen!');
                
                // Aktualisiere Karte
                if (typeof refreshFleetMapStandalone === 'function') {
                    await refreshFleetMapStandalone();
                }
            } catch (e) {
                console.error('ğŸ’¾ Fehler:', e);
                alert('Fehler beim AbschlieÃŸen: ' + e.message);
            }
        }
        
        // ğŸ†• v5.90.578: Schnell-AbschlieÃŸen fÃ¼r blockierende Fahrten
        async function quickCompleteBlockingRide(rideId) {
            if (!confirm('ğŸ”„ Fahrt jetzt abschlieÃŸen?\n\nDas Fahrzeug wird danach wieder als FREI angezeigt.')) {
                return;
            }
            
            try {
                console.log('ğŸ”„ v5.90.578: SchlieÃŸe blockierende Fahrt ab:', rideId);
                
                // Lade Fahrt-Daten
                const rideSnapshot = await db.ref('rides/' + rideId).once('value');
                const ride = rideSnapshot.val();
                
                if (!ride) {
                    alert('âŒ Fahrt nicht gefunden!');
                    return;
                }
                
                // Setze Status auf completed
                await db.ref('rides/' + rideId).update({
                    status: 'completed',
                    completedTimestamp: Date.now(),
                    completedBy: currentUser ? (currentUser.email || currentUser.phoneNumber || currentUser.uid) : 'Fahrer',
                    actualPrice: ride.estimatedPrice || ride.price || 0,
                    paymentMethod: 'Unbekannt'
                });
                
                console.log('âœ… v5.90.578: Fahrt abgeschlossen!');
                alert('âœ… Fahrt abgeschlossen!\n\nFahrzeug ist jetzt FREI.');
                
                // Update View
                if (typeof updateDriverView === 'function') {
                    updateDriverView();
                }
                
            } catch (error) {
                console.error('âŒ v5.90.578: Fehler beim AbschlieÃŸen:', error);
                alert('âŒ Fehler beim AbschlieÃŸen: ' + error.message);
            }
        }
        
        async function completeRide(rideId) {
            // ğŸ†• v5.90.525: MODAL mit Preis-Eingabe!
            const rideSnapshot = await db.ref('rides/' + rideId).once('value');
            const rideData = rideSnapshot.val();
            
            if (!rideData) {
                alert('ğŸ’¾ Fahrt nicht gefunden!');
                return;
            }
            
            // Erstelle Modal
            const modal = document.createElement('div');
            modal.id = 'complete-ride-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:100000;display:flex;align-items:center;justify-content:center;padding:20px;';
            
            const estimatedPrice = rideData.estimatedPrice || rideData.price || 0;
            
            modal.innerHTML = `
                <div style="background:white;border-radius:16px;max-width:400px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.4);">
                    <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:20px;border-radius:16px 16px 0 0;">
                        <h3 style="margin:0;font-size:20px;font-weight:700;">âœ… Fahrt abschlieÃŸen</h3>
                        <div style="font-size:13px;opacity:0.9;margin-top:5px;">
                            ${rideData.customerName || 'Kunde'}
                        </div>
                    </div>
                    
                    <div style="padding:20px;">
                        <div style="margin-bottom:15px;">
                            <label style="display:block;font-size:13px;color:#6b7280;margin-bottom:5px;font-weight:600;">
                                ğŸ’° TatsÃ¤chlicher Preis (Taxameter):
                            </label>
                            <input 
                                type="number" 
                                id="actual-price-input" 
                                step="0.01" 
                                value="${estimatedPrice.toFixed(2)}"
                                style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:16px;font-weight:600;"
                                placeholder="0.00"
                            />
                            <div style="font-size:12px;color:#9ca3af;margin-top:5px;">
                                GeschÃ¤tzt: ${estimatedPrice.toFixed(2)} â‚¬
                            </div>
                        </div>
                        
                        <div style="margin-bottom:20px;padding:12px;background:#f3f4f6;border-radius:8px;">
                            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                                <input 
                                    type="checkbox" 
                                    id="needs-invoice-checkbox"
                                    style="width:20px;height:20px;cursor:pointer;"
                                />
                                <span style="font-size:14px;font-weight:600;color:#111827;">
                                    ğŸ“± Rechnung benÃ¶tigt
                                </span>
                            </label>
                        </div>
                        
                        <div style="display:flex;gap:10px;">
                            <button 
                                onclick="document.getElementById('complete-ride-modal').remove()" 
                                style="flex:1;padding:14px;background:#e5e7eb;color:#374151;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-size:15px;"
                            >
                                ğŸ’¾ Abbrechen
                            </button>
                            <button 
                                onclick="confirmCompleteRide('${rideId}')" 
                                style="flex:1;padding:14px;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-size:15px;"
                            >
                                âœ… AbschlieÃŸen
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Focus auf Preis-Input
            setTimeout(() => {
                document.getElementById('actual-price-input')?.focus();
            }, 100);
        }
        
        // ğŸ†• v5.90.525: BESTÃ„TIGE ABSCHLUSS MIT PREIS!
        async function confirmCompleteRide(rideId) {
            const priceInput = document.getElementById('actual-price-input');
            const invoiceCheckbox = document.getElementById('needs-invoice-checkbox');
            
            const actualPrice = parseFloat(priceInput?.value || 0);
            const needsInvoice = invoiceCheckbox?.checked || false;
            
            if (actualPrice <= 0) {
                alert('ğŸ’¾ Bitte gÃ¼ltigen Preis eingeben!');
                return;
            }
            
            // SchlieÃŸe Modal
            document.getElementById('complete-ride-modal')?.remove();
            
            // Hole Fahrt-Daten
            const rideSnapshot = await db.ref('rides/' + rideId).once('value');
            const rideData = rideSnapshot.val();
            
            // Update mit Preis & Rechnung-Flag
            await updateRide(rideId, { 
                status: 'completed', 
                driverLocation: null,
                completedAt: Date.now(),
                actualPrice: actualPrice,  // ğŸ†• Taxameter-Preis!
                needsInvoice: needsInvoice,  // ğŸ†• Rechnung benÃ¶tigt?
                // ğŸ†• v5.90.542: TRACKING - WER HAT ABGESCHLOSSEN?
                completedBy: currentUser?.uid || 'unknown',
                completedByName: currentUser?.displayName || currentUser?.phoneNumber || 'Unbekannt',
                completedByRole: currentUser?.role || 'unknown'
            });
            
            // ğŸ†• v5.90.542: LÃ–SCHE FAHRER-STATUS!
            clearDriverState();
            
            console.log('âœ… Fahrt abgeschlossen - Preis:', actualPrice, 'â‚¬');
            
            // ğŸ†• v5.90.525: WENN RECHNUNG BENÃ–TIGT â†’ FRAGE OB JETZT SENDEN!
            if (needsInvoice) {
                showInvoiceOptionsModal(rideId, rideData, actualPrice);
            } else {
                // Kein Rechnung â†’ Normal weitermachen
                finalizeRideCompletion(rideId, rideData);
            }
        }
        
        // ğŸ†• v5.90.525: ZEIGE RECHNUNG-OPTIONEN!
        async function showInvoiceOptionsModal(rideId, rideData, actualPrice) {
            const modal = document.createElement('div');
            modal.id = 'invoice-options-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:100001;display:flex;align-items:center;justify-content:center;padding:20px;';
            
            const customerPhone = rideData.customerPhone || '';
            const customerEmail = rideData.customerEmail || '';
            const customerName = rideData.customerName || 'Kunde';
            
            modal.innerHTML = `
                <div style="background:white;border-radius:16px;max-width:400px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.4);">
                    <div style="background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;padding:20px;border-radius:16px 16px 0 0;">
                        <div style="text-align:center;">
                            <div style="font-size:48px;margin-bottom:10px;">âœ…</div>
                            <h3 style="margin:0;font-size:20px;font-weight:700;">Fahrt abgeschlossen!</h3>
                            <div style="font-size:14px;opacity:0.9;margin-top:5px;">
                                Preis: ${actualPrice.toFixed(2)} â‚¬
                            </div>
                        </div>
                    </div>
                    
                    <div style="padding:20px;">
                        <div style="background:#eff6ff;padding:15px;border-radius:12px;margin-bottom:20px;border:2px solid #3b82f6;">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                <span style="font-size:24px;">ğŸ“±</span>
                                <span style="font-weight:700;color:#111827;font-size:16px;">Rechnung benÃ¶tigt</span>
                            </div>
                            <div style="font-size:13px;color:#6b7280;">
                                MÃ¶chten Sie die Rechnung jetzt an den Kunden senden?
                            </div>
                        </div>
                        
                        <div style="display:flex;flex-direction:column;gap:10px;">
                            ${customerPhone ? `
                                <button 
                                    onclick="sendInvoiceViaWhatsApp('${rideId}', '${customerPhone}')" 
                                    style="width:100%;padding:14px;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:center;gap:8px;"
                                >
                                    <span style="font-size:20px;">ğŸ’¬</span>
                                    Per WhatsApp senden
                                </button>
                            ` : ''}
                            ${customerEmail ? `
                                <button 
                                    onclick="sendInvoiceViaEmail('${rideId}')" 
                                    style="width:100%;padding:14px;background:linear-gradient(135deg,#6366f1,#4f46e5);color:white;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:center;gap:8px;"
                                >
                                    <span style="font-size:20px;">ğŸ“§</span>
                                    Per Email senden
                                </button>
                            ` : ''}
                            <button 
                                onclick="skipInvoiceNow('${rideId}')" 
                                style="width:100%;padding:14px;background:#e5e7eb;color:#374151;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-size:15px;"
                            >
                                â­ï¸ SpÃ¤ter im Admin-Bereich
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // ğŸ†• v5.90.525: SENDE RECHNUNG PER WHATSAPP!
        async function sendInvoiceViaWhatsApp(rideId, customerPhone) {
            // SchlieÃŸe Modal
            document.getElementById('invoice-options-modal')?.remove();
            
            // Zeige Loading
            const loadingModal = document.createElement('div');
            loadingModal.id = 'loading-modal';
            loadingModal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:100002;display:flex;align-items:center;justify-content:center;';
            loadingModal.innerHTML = `
                <div style="text-align:center;color:white;">
                    <div style="font-size:64px;margin-bottom:20px;">ğŸ“±</div>
                    <div style="font-size:20px;font-weight:700;margin-bottom:10px;" id="loading-text">Erstelle PDF...</div>
                    <div style="font-size:14px;opacity:0.8;">Bitte warten</div>
                </div>
            `;
            document.body.appendChild(loadingModal);
            
            try {
                // Hole Fahrt-Daten
                const rideSnapshot = await db.ref('rides/' + rideId).once('value');
                const rideData = rideSnapshot.val();
                
                if (!rideData) {
                    throw new Error('Fahrt nicht gefunden!');
                }
                
                console.log('ğŸ“± v5.90.525: Erstelle Rechnung-PDF fÃ¼r:', rideData.customerName);
                
                // ğŸ†• v5.90.525: ERSTELLE PDF MIT jsPDF!
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Rechnung-Nummer generieren
                const now = new Date();
                const invoiceNumber = `RE-${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}-${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
                
                // Firmen-Header
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('FUNK TAXI', 20, 20);
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('MusterstraÃŸe 123', 20, 28);
                doc.text('12345 Musterstadt', 20, 33);
                doc.text('Tel: 0123 456789', 20, 38);
                
                // Rechnung-Nummer + Datum
                doc.setFontSize(10);
                doc.text(`Rechnung Nr.: ${invoiceNumber}`, 20, 55);
                doc.text(`Datum: ${now.toLocaleDateString('de-DE')}`, 20, 60);
                
                // Kunde
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Kunde:', 20, 75);
                doc.setFont(undefined, 'normal');
                doc.text(rideData.customerName || 'Unbekannt', 20, 82);
                if (rideData.customerPhone) {
                    doc.text(rideData.customerPhone, 20, 87);
                }
                
                // Fahrt-Details
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Fahrt-Details:', 20, 105);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                doc.text(`Von: ${rideData.pickup || '?'}`, 20, 112);
                doc.text(`Nach: ${rideData.destination || rideData.dropoff || '?'}`, 20, 117);
                doc.text(`Datum: ${new Date(rideData.pickupTimestamp || rideData.timestamp).toLocaleDateString('de-DE')}`, 20, 122);
                doc.text(`Uhrzeit: ${rideData.pickupTime || '?'}`, 20, 127);
                
                // Positionen
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Positionen:', 20, 145);
                
                const price = rideData.actualPrice || rideData.estimatedPrice || rideData.price || 0;
                // ğŸ”§ FIX v5.90.625: Verwende eingestellten MwSt-Satz (19% Default statt 7%)
                const taxRate = (rideData.vatRate || 19) / 100;
                const netPrice = price / (1 + taxRate);
                const taxAmount = price - netPrice;
                
                // Tabelle
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('Beschreibung', 20, 155);
                doc.text('Betrag', 150, 155);
                doc.line(20, 157, 190, 157);
                
                doc.text('Taxifahrt', 20, 165);
                doc.text(`${price.toFixed(2)} â‚¬`, 150, 165);
                
                // Summen
                doc.line(20, 175, 190, 175);
                doc.text('Netto:', 130, 183);
                doc.text(`${netPrice.toFixed(2)} â‚¬`, 150, 183);
                doc.text(`MwSt. (${(taxRate * 100).toFixed(0)}%):`, 130, 188); // ğŸ”§ FIX v5.90.625
                doc.text(`${taxAmount.toFixed(2)} â‚¬`, 150, 188);
                
                doc.setFont(undefined, 'bold');
                doc.text('Gesamt:', 130, 198);
                doc.text(`${price.toFixed(2)} â‚¬`, 150, 198);
                
                // Footer
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.text('Vielen Dank fÃ¼r Ihre Fahrt mit Funk Taxi!', 20, 270);
                
                console.log('âœ… v5.90.525: PDF erstellt!');
                
                // ğŸ†• v5.90.525: UPLOAD ZU FIREBASE STORAGE!
                document.getElementById('loading-text').textContent = 'Lade PDF hoch...';
                
                const pdfBlob = doc.output('blob');
                const fileName = `${invoiceNumber}.pdf`;
                const storageRef = window.firebaseStorage.ref(`invoices/${fileName}`);
                
                console.log('ğŸ“¤ v5.90.525: Uploade PDF zu Firebase Storage...');
                const uploadTask = await storageRef.put(pdfBlob);
                console.log('âœ… v5.90.525: PDF hochgeladen!');
                
                // Download-URL generieren
                const downloadURL = await storageRef.getDownloadURL();
                console.log('ğŸ”— v5.90.525: Download-URL:', downloadURL);
                
                // Speichere in Firebase DB
                await db.ref(`rides/${rideId}`).update({
                    invoiceNumber: invoiceNumber,
                    invoicePdfUrl: downloadURL,
                    invoiceCreatedAt: Date.now()
                });
                
                // SchlieÃŸe Loading
                loadingModal.remove();
                
                // WhatsApp Nachricht
                const message = `Hallo ${rideData.customerName || ''},

Vielen Dank fÃ¼r Ihre Fahrt mit Funk Taxi!

ğŸ“± Ihre Rechnung (${invoiceNumber}):
${downloadURL}

ğŸš• Fahrt-Details:
Von: ${rideData.pickup || '?'}
Nach: ${rideData.destination || rideData.dropoff || '?'}
ğŸ’° Preis: ${price.toFixed(2)} â‚¬

Mit freundlichen GrÃ¼ÃŸen
Funk Taxi Team`;
                
                // Ã–ffne WhatsApp
                const whatsappUrl = `https://wa.me/${customerPhone.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                
                // Markiere als gesendet
                await db.ref(`rides/${rideId}`).update({
                    invoiceSent: true,
                    invoiceSentAt: Date.now(),
                    invoiceSentVia: 'whatsapp'
                });
                
                alert('âœ… Rechnung erstellt & WhatsApp geÃ¶ffnet!\n\nPDF: ' + invoiceNumber);
                
                // Normal weitermachen
                finalizeRideCompletion(rideId, rideData);
                
            } catch (error) {
                console.error('ğŸ’¾ v5.90.525: Fehler beim PDF-Upload:', error);
                loadingModal?.remove();
                alert('ğŸ’¾ Fehler beim Erstellen der Rechnung:\n\n' + error.message);
                skipInvoiceNow(rideId);
            }
        }
        
        // ğŸ†• v5.90.525: SENDE RECHNUNG PER EMAIL!
        async function sendInvoiceViaEmail(rideId) {
            // SchlieÃŸe Modal
            document.getElementById('invoice-options-modal')?.remove();
            
            // Zeige Loading
            const loadingModal = document.createElement('div');
            loadingModal.id = 'loading-modal';
            loadingModal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:100002;display:flex;align-items:center;justify-content:center;';
            loadingModal.innerHTML = `
                <div style="text-align:center;color:white;">
                    <div style="font-size:64px;margin-bottom:20px;">ğŸ“±</div>
                    <div style="font-size:20px;font-weight:700;margin-bottom:10px;" id="loading-text">Erstelle PDF...</div>
                    <div style="font-size:14px;opacity:0.8;">Bitte warten</div>
                </div>
            `;
            document.body.appendChild(loadingModal);
            
            try {
                // Hole Fahrt-Daten
                const rideSnapshot = await db.ref('rides/' + rideId).once('value');
                const rideData = rideSnapshot.val();
                
                if (!rideData) {
                    throw new Error('Fahrt nicht gefunden!');
                }
                
                console.log('ğŸ“± v5.90.525: Erstelle Rechnung-PDF fÃ¼r Email:', rideData.customerName);
                
                // ğŸ†• v5.90.525: ERSTELLE PDF MIT jsPDF!
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Rechnung-Nummer generieren
                const now = new Date();
                const invoiceNumber = `RE-${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}-${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
                
                // PDF erstellen (gleicher Code wie WhatsApp)
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('FUNK TAXI', 20, 20);
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('MusterstraÃŸe 123', 20, 28);
                doc.text('12345 Musterstadt', 20, 33);
                doc.text('Tel: 0123 456789', 20, 38);
                
                doc.setFontSize(10);
                doc.text(`Rechnung Nr.: ${invoiceNumber}`, 20, 55);
                doc.text(`Datum: ${now.toLocaleDateString('de-DE')}`, 20, 60);
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Kunde:', 20, 75);
                doc.setFont(undefined, 'normal');
                doc.text(rideData.customerName || 'Unbekannt', 20, 82);
                if (rideData.customerPhone) {
                    doc.text(rideData.customerPhone, 20, 87);
                }
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Fahrt-Details:', 20, 105);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                doc.text(`Von: ${rideData.pickup || '?'}`, 20, 112);
                doc.text(`Nach: ${rideData.destination || rideData.dropoff || '?'}`, 20, 117);
                doc.text(`Datum: ${new Date(rideData.pickupTimestamp || rideData.timestamp).toLocaleDateString('de-DE')}`, 20, 122);
                doc.text(`Uhrzeit: ${rideData.pickupTime || '?'}`, 20, 127);
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Positionen:', 20, 145);
                
                const price = rideData.actualPrice || rideData.estimatedPrice || rideData.price || 0;
                const taxRate = (rideData.vatRate || 19) / 100; // ğŸ”§ FIX v5.90.625
                const netPrice = price / (1 + taxRate);
                const taxAmount = price - netPrice;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('Beschreibung', 20, 155);
                doc.text('Betrag', 150, 155);
                doc.line(20, 157, 190, 157);
                
                doc.text('Taxifahrt', 20, 165);
                doc.text(`${price.toFixed(2)} â‚¬`, 150, 165);
                
                doc.line(20, 175, 190, 175);
                doc.text('Netto:', 130, 183);
                doc.text(`${netPrice.toFixed(2)} â‚¬`, 150, 183);
                doc.text(`MwSt. (${(taxRate * 100).toFixed(0)}%):`, 130, 188); // ğŸ”§ FIX v5.90.625
                doc.text(`${taxAmount.toFixed(2)} â‚¬`, 150, 188);
                
                doc.setFont(undefined, 'bold');
                doc.text('Gesamt:', 130, 198);
                doc.text(`${price.toFixed(2)} â‚¬`, 150, 198);
                
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.text('Vielen Dank fÃ¼r Ihre Fahrt mit Funk Taxi!', 20, 270);
                
                console.log('âœ… v5.90.525: PDF erstellt!');
                
                // ğŸ†• v5.90.525: UPLOAD ZU FIREBASE STORAGE!
                document.getElementById('loading-text').textContent = 'Lade PDF hoch...';
                
                const pdfBlob = doc.output('blob');
                const fileName = `${invoiceNumber}.pdf`;
                const storageRef = window.firebaseStorage.ref(`invoices/${fileName}`);
                
                console.log('ğŸ“¤ v5.90.525: Uploade PDF zu Firebase Storage...');
                await storageRef.put(pdfBlob);
                console.log('âœ… v5.90.525: PDF hochgeladen!');
                
                const downloadURL = await storageRef.getDownloadURL();
                console.log('ğŸ”— v5.90.525: Download-URL:', downloadURL);
                
                await db.ref(`rides/${rideId}`).update({
                    invoiceNumber: invoiceNumber,
                    invoicePdfUrl: downloadURL,
                    invoiceCreatedAt: Date.now()
                });
                
                loadingModal.remove();
                
                // ğŸ†• v5.90.525: EMAIL-CLIENT Ã–FFNEN (mailto)
                const subject = `Rechnung ${invoiceNumber} - Funk Taxi`;
                const body = `Hallo ${rideData.customerName || ''},

Vielen Dank fÃ¼r Ihre Fahrt mit Funk Taxi!

Hier ist Ihre Rechnung:
${downloadURL}

Fahrt-Details:
Von: ${rideData.pickup || '?'}
Nach: ${rideData.destination || rideData.dropoff || '?'}
Datum: ${new Date(rideData.pickupTimestamp || rideData.timestamp).toLocaleDateString('de-DE')}
Preis: ${price.toFixed(2)} â‚¬

Mit freundlichen GrÃ¼ÃŸen
Funk Taxi Team`;
                
                const mailtoUrl = `mailto:${rideData.customerEmail || ''}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.location.href = mailtoUrl;
                
                await db.ref(`rides/${rideId}`).update({
                    invoiceSent: true,
                    invoiceSentAt: Date.now(),
                    invoiceSentVia: 'email'
                });
                
                alert('âœ… Rechnung erstellt & Email-Client geÃ¶ffnet!\n\nPDF: ' + invoiceNumber);
                
                finalizeRideCompletion(rideId, rideData);
                
            } catch (error) {
                console.error('ğŸ’¾ v5.90.525: Fehler beim Email-Versand:', error);
                loadingModal?.remove();
                alert('ğŸ’¾ Fehler beim Erstellen der Rechnung:\n\n' + error.message);
                skipInvoiceNow(rideId);
            }
        }
        
        // ğŸ†• v5.90.525: ÃœBERSPRINGEN - SPÃ„TER!
        async function skipInvoiceNow(rideId) {
            // SchlieÃŸe Modal
            document.getElementById('invoice-options-modal')?.remove();
            
            // Hole Fahrt
            const rideSnapshot = await db.ref('rides/' + rideId).once('value');
            const rideData = rideSnapshot.val();
            
            // Normal weitermachen
            finalizeRideCompletion(rideId, rideData);
        }
        
        // ğŸ†• v5.90.525: FINALISIERE FAHRT-ABSCHLUSS!
        async function finalizeRideCompletion(rideId, rideData) {
            // ğŸ†• v5.26.14f: REALTIME FIX - Speichere abgeschlossene Fahrt in localStorage!
            if (rideData) {
                console.log('ğŸ’¾ Speichere Fahrt in Verlauf...');
                const rideHistory = JSON.parse(localStorage.getItem('rideHistory') || '[]');
                
                // PrÃ¼fe ob schon vorhanden (dedupliziere)
                const existingIndex = rideHistory.findIndex(r => r.id === rideData.id || r.firebaseId === rideId);
                if (existingIndex >= 0) {
                    // Aktualisiere bestehende Fahrt
                    rideHistory[existingIndex] = {
                        ...rideData,
                        firebaseId: rideId,
                        status: 'completed',
                        completedAt: Date.now(),
                        // ğŸ†• v5.90.542: MAP-NULL-CHECK-FIX
                        completedBy: currentUser?.uid || 'unknown',
                        completedByName: currentUser?.displayName || currentUser?.phoneNumber || 'Unbekannt',
                        completedByRole: currentUser?.role || 'unknown'
                    };
                    console.log('âœ… Fahrt aktualisiert in Verlauf');
                } else {
                    // FÃ¼ge neue Fahrt hinzu
                    rideHistory.push({
                        ...rideData,
                        firebaseId: rideId,
                        status: 'completed',
                        completedAt: Date.now(),
                        // ğŸ†• v5.90.542: MAP-NULL-CHECK-FIX
                        completedBy: currentUser?.uid || 'unknown',
                        completedByName: currentUser?.displayName || currentUser?.phoneNumber || 'Unbekannt',
                        completedByRole: currentUser?.role || 'unknown'
                    });
                    console.log('âœ… Fahrt hinzugefÃ¼gt zu Verlauf');
                }
                
                localStorage.setItem('rideHistory', JSON.stringify(rideHistory));
                
                // ğŸ”„ Update History-View sofort!
                if (currentView === 'history') {
                    updateHistoryView();
                }
            }
            
            // ğŸ“œ PROTOKOLL: Fahrt abgeschlossen
            logActivity('status', 'completed', `Fahrt abgeschlossen`, {
                customer: rideData?.customerName,
                driver: rideData?.vehicle || currentVehicle,
                from: rideData?.pickup,
                to: rideData?.destination,
                price: rideData?.price
            });
            
            // SchlieÃŸe Karte
            closeDriverMap();
            
            if (etaUpdateInterval) { 
                clearInterval(etaUpdateInterval); 
                etaUpdateInterval = null; 
            }
            
            console.log('âœ… Fahrt abgeschlossen');
            
            // WICHTIG: Erst komplett stoppen
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                console.log('ğŸ›‘ GPS gestoppt');
            }
            
            // ğŸ†• v5.19.0: ZurÃ¼ck zu Standby-Modus!
            if (isOnline && currentVehicle) {
                console.log('ğŸ”„ Wechsle zurÃ¼ck zu Standby-Modus');
                setTimeout(() => {
                    switchToStandby();
                }, 100);
            }
            
            alert('âœ… Fahrt abgeschlossen! Sie sind wieder verfÃ¼gbar.');
        }
        
        // ğŸ†• v5.90.23: EINFACH ABSCHLIESSEN (Ohne Rechnung)
        async function completeRideSimple(rideId) {
            await completeRide(rideId);
        }
        
        // ğŸ†• v5.90.23: MIT RECHNUNG ABSCHLIESSEN (Preis eintragen)
        async function completeRideWithInvoice(rideId) {
            try {
                const rideSnapshot = await db.ref('rides/' + rideId).once('value');
                const rideData = rideSnapshot.val();
                
                if (!rideData) {
                    alert('ğŸ’¾ Fahrt nicht gefunden!');
                    return;
                }
                
                // Modal fÃ¼r Preis-Eingabe
                const currentPrice = rideData.price || rideData.calculatedPrice || 0;
                
                const modalHtml = `
                    <div id="driver-price-modal" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0,0,0,0.7);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 99999;
                        padding: 20px;
                    ">
                        <div style="
                            background: white;
                            border-radius: 16px;
                            max-width: 400px;
                            width: 100%;
                            padding: 25px;
                            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                        ">
                            <h3 style="margin: 0 0 20px 0; color: #1f2937; font-size: 20px; text-align: center;">
                                ğŸ’° Taxameter-Preis
                            </h3>
                            
                            <div style="background: #f3f4f6; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Kunde:</div>
                                <div style="font-weight: 600; color: #1f2937; margin-bottom: 10px;">${rideData.customerName || 'Unbekannt'}</div>
                                
                                <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Route:</div>
                                <div style="font-size: 13px; color: #1f2937; line-height: 1.4;">
                                    ğŸ“ ${rideData.pickup || 'Start'}<br>
                                    ğŸ¯ ${rideData.destination || 'Ziel'}
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #1f2937; font-size: 15px;">
                                    ğŸ’µ Taxameter zeigt:
                                </label>
                                <div style="position: relative;">
                                    <input 
                                        type="number" 
                                        id="driver-taxameter-price" 
                                        value="${currentPrice.toFixed(2)}" 
                                        step="0.10" 
                                        min="0"
                                        style="
                                            width: 100%;
                                            padding: 16px 50px 16px 16px;
                                            border: 3px solid #10b981;
                                            border-radius: 12px;
                                            font-size: 24px;
                                            font-weight: 700;
                                            text-align: center;
                                            color: #1f2937;
                                        "
                                        autofocus
                                        onchange="this.value = parseFloat(this.value || 0).toFixed(2)">
                                    <span style="
                                        position: absolute;
                                        right: 20px;
                                        top: 50%;
                                        transform: translateY(-50%);
                                        color: #6b7280;
                                        font-weight: 700;
                                        font-size: 20px;
                                    ">â‚¬</span>
                                </div>
                                <div style="font-size: 11px; color: #6b7280; margin-top: 8px; text-align: center;">
                                    Berechnet: ${currentPrice.toFixed(2)} â‚¬
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <button onclick="closeDriverPriceModal()" 
                                        style="
                                            padding: 14px;
                                            background: #e5e7eb;
                                            color: #374151;
                                            border: none;
                                            border-radius: 10px;
                                            font-weight: 600;
                                            cursor: pointer;
                                            font-size: 15px;
                                        ">
                                    ğŸ’¾ Abbrechen
                                </button>
                                <button onclick="saveDriverPrice('${rideId}')" 
                                        style="
                                            padding: 14px;
                                            background: #10b981;
                                            color: white;
                                            border: none;
                                            border-radius: 10px;
                                            font-weight: 600;
                                            cursor: pointer;
                                            font-size: 15px;
                                        ">
                                    âœ… AbschlieÃŸen
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Focus auf Input
                setTimeout(() => {
                    const input = document.getElementById('driver-taxameter-price');
                    if (input) {
                        input.focus();
                        input.select();
                    }
                }, 100);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // ğŸ†• v5.90.23: MODAL SCHLIESSEN
        function closeDriverPriceModal() {
            const modal = document.getElementById('driver-price-modal');
            if (modal) modal.remove();
        }
        
        // ğŸ†• v5.90.23: PREIS SPEICHERN UND ABSCHLIESSEN
        async function saveDriverPrice(rideId) {
            try {
                const priceInput = document.getElementById('driver-taxameter-price');
                const finalPrice = parseFloat(priceInput.value);
                
                if (isNaN(finalPrice) || finalPrice < 0) {
                    alert('ğŸ’¾ Bitte gÃ¼ltigen Preis eingeben!');
                    return;
                }
                
                // SchlieÃŸe Modal
                closeDriverPriceModal();
                
                // Update Preis in Firebase
                await db.ref(`rides/${rideId}`).update({
                    price: finalPrice
                });
                
                console.log('ğŸ’° Preis aktualisiert:', finalPrice);
                
                // Jetzt Fahrt abschlieÃŸen
                await completeRide(rideId);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler beim Speichern: ' + error.message);
            }
        }

        async function resetDatabase() {
            if (!confirm('âš ï¸ WIRKLICH alle Fahrten lÃ¶schen?\n\nLÃ¶scht ALLES:\n- Alle Firebase Fahrten\n- localStorage Verlauf\n- Komplett leere Datenbank')) return;
            if (!confirm('âš ï¸ LETZTE WARNUNG!\n\nDies kann nicht rÃ¼ckgÃ¤ngig gemacht werden!')) return;
            
            if (isFirebaseReady) {
                try {
                    console.log('ğŸ—‘ï¸ LÃ¶sche ALLE Fahrten...');
                    
                    // 1. Firebase komplett leeren
                    await db.ref('rides').remove();
                    console.log('âœ… Firebase rides/ gelÃ¶scht');
                    
                    // 2. Lokales Array leeren
                    rides = [];
                    
                    // 3. localStorage leeren
                    localStorage.removeItem('rideHistory');
                    localStorage.removeItem('myCurrentRideId');
                    console.log('âœ… localStorage geleert');
                    
                    // 4. Current Ride zurÃ¼cksetzen
                    myCurrentRide = null;
                    
                    alert(
                        'âœ… Datenbank komplett gelÃ¶scht!\n\n' +
                        'ğŸ”¥ Alle Fahrten entfernt\n' +
                        'ğŸ”¥ localStorage geleert\n' +
                        'ğŸ”¥ Komplett sauber!\n\n' +
                        'Seite lÃ¤dt neu...'
                    );
                    
                    // Auto-Reload nach 1 Sekunde
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                    
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim LÃ¶schen:', error);
                    alert('ğŸ’¾ Fehler beim LÃ¶schen: ' + error.message);
                }
            } else {
                alert('ğŸ’¾ Firebase nicht bereit!');
            }
        }
        
        // ğŸ“‚ ADMIN SECTION TOGGLE
        function toggleAdminSection(section) {
            const content = document.getElementById(section + '-content');
            const toggle = document.getElementById(section + '-toggle');
            
            // ğŸ†• v5.90.542: NULL-CHECK!
            if (!content) {
                console.warn('âš ï¸ Admin-Section nicht gefunden:', section);
                return;
            }
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                if (toggle) toggle.textContent = 'â–²'; // ğŸ†• v5.90.542: NULL-CHECK!
                
                // Spezielle Aktionen beim Ã–ffnen
                if (section === 'telegram') {
                    updateTelegramStatus();
                } else if (section === 'calendar-settings') {
                    // ğŸ†• v5.64.45: Kalender-Export Einstellungen laden
                    loadCalendarExportSettings();
                } else if (section === 'prebookings') {
                    updatePrebookingsList();
                } else if (section === 'activitylog') {
                    loadActivityLog();
                } else if (section === 'deleted') {
                    loadDeletedRides();
                } else if (section === 'fleetmap') {
                    setTimeout(() => initFleetMap(), 100); // Kleine VerzÃ¶gerung fÃ¼r DOM
                } else if (section === 'vehicles') {
                    renderVehicles();
                } else if (section === 'activerides') {
                    loadActiveRides();
                } else if (section === 'booking-system') {
                    // ğŸ†• v5.38.2: Buchungssystem-UI updaten
                    updateBookingSystemUI();
                } else if (section === 'oepnv') {
                    loadOEPNVSettings();
                } else if (section === 'settings') {
                    // ğŸ†• v5.83.0: Einstellungen UI updaten
                    updateFritzBoxSettingsUI();
                } else if (section === 'calendar') {
                    // ğŸ†• v5.27.1: Kalender rendern
                    setTimeout(() => renderCalendar(), 100);
                } else if (section === 'antifraud') {
                    // ğŸ†• v5.28.0: Anti-Betrugs-Alarme laden
                    loadAntiFraudAlerts();
                } else if (section === 'single-invoices') {
                    // ğŸ†• v5.87.90: Einzel-Rechnungen laden
                    loadInvoicesList();
                }
            } else {
                content.style.display = 'none';
                if (toggle) toggle.textContent = 'â–¼'; // ğŸ†• v5.90.542: NULL-CHECK!
                
                // Stoppe Live-Log wenn geschlossen
                if (section === 'livelog' && liveLogActive) {
                    stopLiveLog();
                }
                
                // Stoppe Fleet-Auto-Update wenn geschlossen
                if (section === 'fleetmap' && fleetAutoRefresh) {
                    clearInterval(fleetAutoRefresh);
                    fleetAutoRefresh = null;
                    const btn = document.getElementById('fleet-auto-btn');
                    if (btn) {
                        btn.textContent = 'â–¶ï¸ Auto-Update';
                        btn.style.background = '#10b981';
                    }
                }
            }
        }
        
        // ğŸ†• v5.64.45: KALENDER-EXPORT EINSTELLUNGEN
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Default Settings (ALLES AN!)
        const defaultCalendarSettings = {
            showCustomerName: true,
            showGuestName: true,
            showGuestPhone: true,
            showPhone: true,
            showPickup: true,
            showDestination: true,
            showPassengers: true,
            showPrice: true,
            showDistance: true,
            showVehicle: true,
            showNotes: true,
            showReminder: true
        };
        
        // Lade Einstellungen aus Firebase
        async function loadCalendarExportSettings() {
            if (!isFirebaseReady) {
                console.error('ğŸ’¾ Firebase nicht verbunden!');
                return;
            }
            
            console.log('ğŸ“¥ Lade Kalender-Export Einstellungen...');
            
            try {
                const snapshot = await db.ref('settings/calendarExport').once('value');
                const settings = snapshot.val() || defaultCalendarSettings;
                
                console.log('âœ… Settings geladen:', settings);
                
                // Checkboxen aktualisieren
                document.getElementById('cal-setting-customer-name').checked = settings.showCustomerName !== false;
                document.getElementById('cal-setting-guest-name').checked = settings.showGuestName !== false;
                document.getElementById('cal-setting-guest-phone').checked = settings.showGuestPhone !== false;
                document.getElementById('cal-setting-phone').checked = settings.showPhone !== false;
                document.getElementById('cal-setting-pickup').checked = settings.showPickup !== false;
                document.getElementById('cal-setting-destination').checked = settings.showDestination !== false;
                document.getElementById('cal-setting-passengers').checked = settings.showPassengers !== false;
                document.getElementById('cal-setting-price').checked = settings.showPrice !== false;
                document.getElementById('cal-setting-distance').checked = settings.showDistance !== false;
                document.getElementById('cal-setting-vehicle').checked = settings.showVehicle !== false;
                document.getElementById('cal-setting-notes').checked = settings.showNotes !== false;
                document.getElementById('cal-setting-reminder').checked = settings.showReminder !== false;
                
                // ğŸ†• v5.90.44: Tracking-Links Einstellung laden
                const trackingSnapshot = await db.ref('settings/calendarExportTrackingLinks').once('value');
                const trackingEnabled = trackingSnapshot.val() === true;
                const trackingCheckbox = document.getElementById('cal-setting-tracking-links');
                if (trackingCheckbox) {
                    trackingCheckbox.checked = trackingEnabled;
                }
                console.log('ğŸ“ Tracking-Links:', trackingEnabled ? 'AN' : 'AUS');
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden:', error);
                alert('ğŸ’¾ Fehler beim Laden der Einstellungen!');
            }
        }
        
        // Speichere Einstellungen in Firebase
        async function saveCalendarExportSettings() {
            if (!isFirebaseReady) {
                alert('ğŸ’¾ Firebase nicht verbunden!');
                return;
            }
            
            try {
                // Lese Checkbox-Werte mit Fallback
                const getCheckboxValue = (id) => {
                    const el = document.getElementById(id);
                    return el ? el.checked : false;
                };
                
                const settings = {
                    showCustomerName: getCheckboxValue('cal-setting-customer-name'),
                    showGuestName: getCheckboxValue('cal-setting-guest-name'),
                    showGuestPhone: getCheckboxValue('cal-setting-guest-phone'),
                    showPhone: getCheckboxValue('cal-setting-phone'),
                    showPickup: getCheckboxValue('cal-setting-pickup'),
                    showDestination: getCheckboxValue('cal-setting-destination'),
                    showPassengers: getCheckboxValue('cal-setting-passengers'),
                    showPrice: getCheckboxValue('cal-setting-price'),
                    showDistance: getCheckboxValue('cal-setting-distance'),
                    showVehicle: getCheckboxValue('cal-setting-vehicle'),
                    showNotes: getCheckboxValue('cal-setting-notes'),
                    showReminder: getCheckboxValue('cal-setting-reminder')
                };
                
                console.log('ğŸ’¾ Speichere Settings:', settings);
                
                await db.ref('settings/calendarExport').set(settings);
                
                // Erfolgs-Meldung
                alert('âœ… Einstellungen gespeichert!');
                console.log('âœ… Settings gespeichert!');
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Speichern:', error);
                alert('ğŸ’¾ Fehler beim Speichern der Einstellungen!');
            }
        }
        
        // ğŸ—ºï¸ FAHRZEUG-KARTE SYSTEM
        let fleetMap = null;
        let fleetMarkers = {};
        let fleetRoutes = {};
        let tempPinMarker = null; // ğŸ†• v5.90.234: TemporÃ¤rer Pin auf Karte
        
        // ğŸš¨ AKTIVE FAHRTEN SYSTEM
        async function loadActiveRides() {
            const container = document.getElementById('active-rides-list');
            const countBadge = document.getElementById('active-rides-count');
            
            if (!db) {
                container.innerHTML = '<div style="padding:20px;text-align:center;color:#ef4444;">ğŸ’¾ Firebase nicht verbunden</div>';
                return;
            }
            
            container.innerHTML = '<div style="padding:20px;text-align:center;color:#999;">â³ Lade...</div>';
            
            try {
                const snapshot = await db.ref('rides').once('value');
                const allRides = snapshot.val() || {};
                
                // Aktive Status definieren
                const activeStatuses = ['new', 'assigned', 'accepted', 'picked_up', 'vorbestellt'];
                const finishedStatuses = ['completed', 'cancelled', 'storniert', 'abgeschlossen'];
                
                // Fahrten sortieren
                const activeRides = [];
                const recentFinished = [];
                const now = Date.now();
                const oneHourAgo = now - (60 * 60 * 1000);
                
                for (const rideId in allRides) {
                    const ride = allRides[rideId];
                    ride.firebaseId = rideId;
                    
                    if (activeStatuses.includes(ride.status)) {
                        activeRides.push(ride);
                    } else if (finishedStatuses.includes(ride.status) && (ride.completedAt || ride.cancelledAt || ride.createdAt) > oneHourAgo) {
                        recentFinished.push(ride);
                    }
                }
                
                // Sortieren nach Zeit
                activeRides.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                recentFinished.sort((a, b) => (b.completedAt || b.cancelledAt || b.createdAt || 0) - (a.completedAt || a.cancelledAt || a.createdAt || 0));
                
                countBadge.textContent = activeRides.length;
                
                let html = '';
                
                // AKTIVE FAHRTEN
                if (activeRides.length > 0) {
                    html += '<div style="background:#fef3c7;padding:10px;font-weight:bold;border-bottom:1px solid #e5e7eb;">ğŸš¨ AKTIVE FAHRTEN (' + activeRides.length + ')</div>';
                    activeRides.forEach(ride => {
                        html += renderActiveRideRow(ride, true);
                    });
                } else {
                    html += '<div style="background:#d1fae5;padding:15px;text-align:center;color:#059669;">âœ… Keine aktiven Fahrten - alles abgearbeitet!</div>';
                }
                
                // KÃœRZLICH ABGESCHLOSSEN (letzte Stunde)
                if (recentFinished.length > 0) {
                    html += '<div style="background:#e0e7ff;padding:10px;font-weight:bold;border-bottom:1px solid #e5e7eb;margin-top:10px;">ğŸ“‹ KÃœRZLICH ABGESCHLOSSEN (' + recentFinished.length + ')</div>';
                    recentFinished.forEach(ride => {
                        html += renderActiveRideRow(ride, false);
                    });
                }
                
                container.innerHTML = html || '<div style="padding:20px;text-align:center;color:#999;">Keine Fahrten gefunden</div>';
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden aktiver Fahrten:', error);
                container.innerHTML = '<div style="padding:20px;text-align:center;color:#ef4444;">ğŸ’¾ Fehler: ' + error.message + '</div>';
            }
        }
        
        function renderActiveRideRow(ride, isActive) {
            const createdTime = ride.createdAt ? formatDateTime(ride.createdAt) : 'Unbekannt';
            const pickupTime = ride.pickupTimestamp ? formatDateTime(ride.pickupTimestamp) : createdTime;
            
            // Status-Farbe und Text
            let statusColor, statusText, statusEmoji;
            switch(ride.status) {
                case 'new':
                    statusColor = '#3b82f6'; statusText = 'Neu'; statusEmoji = 'ğŸ†•';
                    break;
                case 'assigned':
                    statusColor = '#f59e0b'; statusText = 'Zugewiesen'; statusEmoji = 'â³';
                    break;
                case 'accepted':
                    statusColor = '#10b981'; statusText = 'Angenommen'; statusEmoji = 'âœ…';
                    break;
                case 'picked_up':
                    statusColor = '#8b5cf6'; statusText = 'Unterwegs'; statusEmoji = 'ğŸš—';
                    break;
                case 'vorbestellt':
                    statusColor = '#ec4899'; statusText = 'Vorbestellt'; statusEmoji = 'ğŸ“…';
                    break;
                case 'completed':
                    statusColor = '#059669'; statusText = 'Abgeschlossen'; statusEmoji = 'âœ”ï¸';
                    break;
                case 'cancelled':
                case 'storniert':
                    statusColor = '#dc2626'; statusText = 'Storniert'; statusEmoji = 'ğŸ’¾';
                    break;
                default:
                    statusColor = '#6b7280'; statusText = ride.status; statusEmoji = 'â“';
            }
            
            // Zeit seit Erstellung
            const ageMinutes = ride.createdAt ? Math.round((Date.now() - ride.createdAt) / 60000) : 0;
            const ageText = !ride.createdAt ? 'Neu' : (ageMinutes < 60 ? ageMinutes + ' Min' : Math.round(ageMinutes / 60) + ' Std');
            
            return `
                <div style="padding:12px;border-bottom:1px solid #e5e7eb;${isActive ? 'background:#fffbeb;' : ''}">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
                        <div>
                            <span style="background:${statusColor};color:white;padding:3px 8px;border-radius:4px;font-size:12px;font-weight:bold;">
                                ${statusEmoji} ${statusText}
                            </span>
                            <span style="margin-left:8px;font-size:11px;color:#6b7280;">vor ${ageText}</span>
                        </div>
                        ${isActive ? `
                            <div style="display:flex;gap:8px;">
                                <button onclick="completeRide('${ride.firebaseId}')" style="background:#10b981;color:white;border:none;padding:5px 10px;border-radius:4px;font-size:11px;cursor:pointer;font-weight:600;">
                                    âœ… AbschlieÃŸen
                                </button>
                                <button onclick="forceCompleteRide('${ride.firebaseId}')" style="background:#ef4444;color:white;border:none;padding:5px 10px;border-radius:4px;font-size:11px;cursor:pointer;">
                                    ğŸ—‘ï¸ Stornieren
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    <div style="font-size:13px;">
                        <div><strong>ğŸ’¾ ${ride.customerName || 'Unbekannt'}</strong> ${ride.customerPhone ? 'ğŸ’¾ ' + ride.customerPhone : ''}</div>
                        <div style="color:#6b7280;margin-top:4px;">
                            ğŸ“ ${ride.pickup || '?'} â†’ ${ride.destination || '?'}
                        </div>
                        <div style="color:#6b7280;margin-top:4px;font-size:11px;">
                            ğŸ• ${ride.pickupTimestamp && ride.pickupTimestamp > Date.now() ? 'Abholung: ' + pickupTime : 'Erstellt: ' + createdTime}
                            ${ride.assignedTo ? ' | ğŸš— ' + (ride.assignedVehicleName || ride.assignedTo) : ''}
                            ${ride.price ? ' | ğŸ’° ' + ride.price + 'â‚¬' : ''}
                        </div>
                        ${ride.invoiceNumber ? `
                            <div style="margin-top:8px;padding:8px;background:#d1fae5;border-left:3px solid #10b981;border-radius:4px;">
                                <span style="font-size:12px;color:#048257;font-weight:600;">
                                    ğŸ“± Rechnung: ${ride.invoiceNumber}${ride.invoiceAmount ? ' Â· ' + ride.invoiceAmount.toFixed(2) + 'â‚¬' : ''}
                                </span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        function formatDateTime(timestamp) {
            if (!timestamp) return 'Unbekannt';
            const date = new Date(timestamp);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}.${month}. ${hours}:${minutes}`;
        }
        
        // ğŸ†• v5.38.6: Format mit Wochentag
        function formatDateWithWeekday(timestamp) {
            if (!timestamp) return 'Unbekannt';
            const date = new Date(timestamp);
            
            const weekdays = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
            const weekday = weekdays[date.getDay()];
            
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${weekday}, ${day}.${month}.${year} ${hours}:${minutes}`;
        }
        
        async function forceCompleteRide(rideId) {
            if (!confirm('Fahrt wirklich STORNIEREN?\n\nHinweis: Zum AbschlieÃŸen nutze den grÃ¼nen "âœ… AbschlieÃŸen" Button!')) return;
            
            try {
                await db.ref('rides/' + rideId).update({
                    status: 'cancelled',
                    cancelledAt: Date.now(),
                    cancelReason: 'Admin: Manuell storniert',
                    forceClosed: true
                });
                
                console.log('âœ… Fahrt ' + rideId + ' storniert');
                loadActiveRides(); // Neu laden
                
                logActivity('admin', 'force_cancel', 'Admin hat Fahrt manuell storniert', {
                    rideId: rideId
                });
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('Fehler beim Stornieren: ' + error.message);
            }
        }
        
        async function cleanupAllStuckRides() {
            if (!confirm('Alle hÃ¤ngenden "assigned" Fahrten zurÃ¼cksetzen?')) return;
            
            try {
                const snapshot = await db.ref('rides').orderByChild('status').equalTo('assigned').once('value');
                const stuckRides = snapshot.val();
                
                if (!stuckRides) {
                    alert('Keine hÃ¤ngenden Fahrten gefunden!');
                    return;
                }
                
                let count = 0;
                for (const rideId in stuckRides) {
                    await db.ref('rides/' + rideId).update({
                        status: 'new',
                        assignedTo: null,
                        assignedVehicleName: null,
                        cleanedUp: true,
                        cleanedUpAt: Date.now()
                    });
                    count++;
                }
                
                alert(`âœ… ${count} Fahrt(en) zurÃ¼ckgesetzt!`);
                loadActiveRides();
                
                logActivity('admin', 'bulk_cleanup', `Admin hat ${count} hÃ¤ngende Fahrten zurÃ¼ckgesetzt`, {});
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('Fehler: ' + error.message);
            }
        }
        let fleetAutoRefresh = null;
        let fleetMapInitialized = false;
        let fleetSearchMarker = null; // ğŸ†• Marker fÃ¼r gesuchte Adresse
        let fleetSearchCoords = null; // ğŸ†• Koordinaten der gesuchten Adresse
        let fleetSearchName = null;   // ğŸ†• Name der gesuchten Adresse
        
        // ğŸ†• v5.90.68: GLEICHES SYSTEM WIE ABHOLORT!
        function initFleetAddressSearch() {
            const input = document.getElementById('fleet-address-search');
            const dropdown = document.getElementById('fleet-address-dropdown');
            if (!input || !dropdown) return;
            
            let searchTimeout = null;
            
            input.addEventListener('input', function() {
                const query = this.value.trim();
                
                if (searchTimeout) clearTimeout(searchTimeout);
                
                if (query.length < 6) {
                    dropdown.style.display = 'none';
                    return;
                }
                
                dropdown.innerHTML = '<div style="padding:12px;color:#999;text-align:center;">ğŸ” Suche...</div>';
                dropdown.style.display = 'block';
                
                searchTimeout = setTimeout(async () => {
                    try {
                        // 1. Erst POIs durchsuchen
                        const lowerQuery = query.toLowerCase();
                        const matchingPOIs = allPOIs.filter(poi => 
                            poi.name.toLowerCase().includes(lowerQuery) || 
                            poi.address.toLowerCase().includes(lowerQuery)
                        );
                        
                        let html = '';
                        
                        // POI Treffer zuerst (GELB)
                        matchingPOIs.forEach(poi => {
                            html += `
                                <div onclick="selectFleetAddress('${poi.name}', ${poi.lat}, ${poi.lon}, '${poi.address}')" style="padding:12px;cursor:pointer;border-bottom:1px solid #e5e7eb;background:#fef9e7;">
                                    <div style="font-weight:600;color:#f59e0b;">â­ ${poi.name}</div>
                                    <div style="font-size:12px;color:#666;margin-top:2px;">${poi.address}</div>
                                </div>
                            `;
                        });
                        
                        // 2. GLEICHE geocode() Funktion wie Abholort!
                        const result = await geocode(query);
                        
                        if (result) {
                            // ğŸ†• v5.90.71: Formatiere Adresse MIT PLZ (wie Schnellbuchung!)
                            let displayText = '';
                            if (result.address) {
                                if (result.address.road) displayText += result.address.road + ' ';
                                if (result.address.house_number) displayText += result.address.house_number + ', ';
                                if (result.address.postcode) displayText += result.address.postcode + ' ';
                                if (result.address.village || result.address.town || result.address.city) {
                                    displayText += (result.address.village || result.address.town || result.address.city);
                                }
                            }
                            
                            // Fallback wenn keine formatierte Adresse
                            if (!displayText.trim()) {
                                displayText = query;
                            }
                            
                            // Adresse anzeigen
                            html += `
                                <div onclick="selectFleetAddress('${displayText.replace(/'/g, "\\'")}', ${result.lat}, ${result.lon}, '${displayText.replace(/'/g, "\\'")}' )" style="padding:12px;cursor:pointer;border-bottom:1px solid #e5e7eb;">
                                    <div style="font-weight:500;">ğŸ“ ${displayText}</div>
                                    <div style="font-size:11px;color:#999;margin-top:2px;">${result.display_name}</div>
                                </div>
                            `;
                        }
                        
                        if (!html) {
                            html = '<div style="padding:12px;color:#999;text-align:center;">Keine Ergebnisse</div>';
                        }
                        
                        dropdown.innerHTML = html;
                        console.log(`ğŸ” Fleet-Suche: ${matchingPOIs.length} POIs, ${result ? '1' : '0'} Geocode`);
                        
                    } catch (e) {
                        console.error('ğŸ’¾ Fleet-Suche Fehler:', e);
                        dropdown.innerHTML = '<div style="padding:12px;color:#ef4444;">Fehler bei der Suche</div>';
                    }
                }, 800); // Debounce: 800ms
            });
            
            // Dropdown schlieÃŸen bei Klick auÃŸerhalb
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
            
            console.log('ğŸ” Fleet-Adresssuche initialisiert (GLEICHES SYSTEM WIE ABHOLORT)');
        }
        
        function selectFleetAddress(name, lat, lon, fullAddress, addressDetails) {
            const input = document.getElementById('fleet-address-search');
            const dropdown = document.getElementById('fleet-address-dropdown');
            const shareBtn = document.getElementById('fleet-share-btn');
            
            input.value = fullAddress || name;
            dropdown.style.display = 'none';
            
            // Koordinaten speichern fÃ¼r Teilen-Funktion
            fleetSearchCoords = { lat, lon };
            fleetSearchName = fullAddress || name;
            
            // Teilen-Button anzeigen
            if (shareBtn) shareBtn.style.display = 'block';
            
            // Marker auf Karte setzen
            if (fleetMap) {
                // Alten Marker entfernen
                if (fleetSearchMarker) {
                    fleetMap.removeLayer(fleetSearchMarker);
                }
                
                // ğŸ†• v5.90.70: GRÃ–SSERER PIN fÃ¼r bessere Sichtbarkeit!
                fleetSearchMarker = L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: `
                            <div style="position:relative;">
                                <div style="width:40px;height:40px;background:#ef4444;border:4px solid white;border-radius:50%;box-shadow:0 4px 12px rgba(0,0,0,0.4);"></div>
                                <div style="position:absolute;top:40px;left:20px;width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-top:16px solid #ef4444;transform:translateX(-50%);"></div>
                            </div>
                        `,
                        iconSize: [40, 56],
                        iconAnchor: [20, 56]
                    }),
                    draggable: true  // â† VERSCHIEBBAR!
                }).addTo(fleetMap);
                
                // ğŸ†• v5.90.43: Event wenn Marker verschoben wird
                fleetSearchMarker.on('dragend', function(e) {
                    const newPos = e.target.getLatLng();
                    
                    console.log('ğŸ“ Marker verschoben zu:', newPos);
                    
                    // Aktualisiere Koordinaten
                    fleetSearchCoords = { lat: newPos.lat, lon: newPos.lng };
                    
                    // Zeige BestÃ¤tigung
                    showMarkerConfirmation(newPos.lat, newPos.lng);
                });
                
                // Tooltip hinzufÃ¼gen
                fleetSearchMarker.bindTooltip('ğŸ–ï¸ Ziehen um Position anzupassen', {
                    permanent: false,
                    direction: 'top',
                    offset: [0, -30]
                });
                
                // Zur Position zoomen
                fleetMap.setView([lat, lon], 17); // HÃ¶herer Zoom fÃ¼r Genauigkeit!
                
                console.log('ğŸ“ Adresse auf Karte markiert (verschiebbar):', fullAddress || name);
                console.log('ğŸ“± Koordinaten:', { lat, lon });
                
                // Zeige Hinweis
                if (!addressDetails || !addressDetails.house_number) {
                    showToast('âš ï¸ Hausnummer nicht eindeutig - bitte Marker verschieben!', 'warning');
                }
            }
        }
        
        // ğŸ†• v5.90.43: BestÃ¤tigung nach Marker-Verschiebung
        function showMarkerConfirmation(lat, lon) {
            // Entferne alte BestÃ¤tigung
            const oldConfirm = document.getElementById('marker-confirm-box');
            if (oldConfirm) oldConfirm.remove();
            
            // Erstelle BestÃ¤tigungs-Box
            const confirmBox = document.createElement('div');
            confirmBox.id = 'marker-confirm-box';
            confirmBox.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: white;
                padding: 12px 16px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 95%;
                width: auto;
                border: 3px solid #10b981;
            `;
            
            confirmBox.innerHTML = `
                <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                    <div style="display:flex;align-items:center;gap:8px;">
                        <div style="font-size:20px;">ğŸ“</div>
                        <div>
                            <div style="font-weight:600;font-size:14px;color:#1f2937;">Position OK?</div>
                            <div style="font-size:11px;color:#6b7280;">
                                ${lat.toFixed(6)}, ${lon.toFixed(6)}
                            </div>
                        </div>
                    </div>
                    <div style="display:flex;gap:6px;margin-left:auto;">
                        <button onclick="confirmMarkerPosition()" style="padding:8px 12px;background:#10b981;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;white-space:nowrap;">
                            âœ“ Ja
                        </button>
                        <button onclick="closeMarkerConfirmation()" style="padding:8px 12px;background:#6b7280;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;white-space:nowrap;">
                            ğŸ”„ Neu
                        </button>
                        <button onclick="saveFleetAddressAsPOI()" style="padding:8px 12px;background:#f59e0b;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;white-space:nowrap;">
                            â­ POI
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmBox);
        }
        
        function confirmMarkerPosition() {
            closeMarkerConfirmation();
            showToast('âœ… Position gespeichert!', 'success');
            console.log('âœ… Marker-Position bestÃ¤tigt:', fleetSearchCoords);
        }
        
        function closeMarkerConfirmation() {
            const confirmBox = document.getElementById('marker-confirm-box');
            if (confirmBox) confirmBox.remove();
        }
        
        // ğŸ†• v5.90.69: Als POI speichern!
        async function saveFleetAddressAsPOI() {
            const input = document.getElementById('fleet-address-search');
            const currentName = input.value || fleetSearchName;
            
            // Dialog fÃ¼r POI-Namen
            const poiName = prompt('ğŸ“ POI Name eingeben:', currentName);
            if (!poiName || !poiName.trim()) {
                return;
            }
            
            if (!fleetSearchCoords) {
                alert('ğŸ’¾ Keine Position ausgewÃ¤hlt!');
                return;
            }
            
            try {
                // Speichere in Firebase unter /pois/
                const poiData = {
                    name: poiName.trim(),
                    address: currentName,
                    lat: fleetSearchCoords.lat,
                    lon: fleetSearchCoords.lon,
                    addedBy: currentUser?.email || 'unknown',
                    addedAt: new Date().toISOString(),
                    category: 'custom' // FÃ¼r spÃ¤tere Filterung
                };
                
                // Erstelle POI ID aus Name (lowercase, keine Leerzeichen)
                const poiId = poiName.toLowerCase().replace(/[^a-z0-9]/g, '_');
                
                await db.ref('pois/' + poiId).set(poiData);
                
                console.log('âœ… POI gespeichert:', poiData);
                
                // FÃ¼ge zum lokalen POI-Array hinzu
                if (!allPOIs.some(p => p.name === poiName)) {
                    allPOIs.push({
                        name: poiName.trim(),
                        address: currentName,
                        lat: fleetSearchCoords.lat,
                        lon: fleetSearchCoords.lon
                    });
                }
                
                // ğŸ†• v5.90.69: POIs neu laden damit es Ã¼berall verfÃ¼gbar ist!
                if (typeof loadPOIs === 'function') {
                    await loadPOIs();
                }
                
                // SchlieÃŸe BestÃ¤tigung
                closeMarkerConfirmation();
                
                // Zeige Erfolg
                showToast(`â­ POI "${poiName}" gespeichert und ab sofort verfÃ¼gbar!`, 'success');
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Speichern:', error);
                alert('ğŸ’¾ Fehler beim Speichern des POI!');
            }
        }
        
        // Toast-Funktion fÃ¼r Hinweise
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${type === 'warning' ? '#f59e0b' : type === 'success' ? '#10b981' : '#3b82f6'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10001;
                max-width: 300px;
                font-size: 14px;
                animation: slideIn 0.3s ease-out;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // ğŸ†• v5.88.32: Adresse als Google Maps Link teilen
        function shareFleetAddress() {
            if (!fleetSearchCoords || !fleetSearchName) {
                alert('Bitte erst eine Adresse suchen!');
                return;
            }
            
            const { lat, lon } = fleetSearchCoords;
            const googleMapsUrl = `https://www.google.com/maps?q=${lat},${lon}`;
            const shortName = fleetSearchName.split(',')[0];
            
            // Text zum Teilen
            const shareText = `ğŸ“ ${shortName}\n${googleMapsUrl}`;
            
            // Native Share API (Mobile) oder Clipboard
            if (navigator.share) {
                navigator.share({
                    title: shortName,
                    text: `ğŸ“ ${shortName}`,
                    url: googleMapsUrl
                }).then(() => {
                    console.log('âœ… Adresse geteilt');
                }).catch(err => {
                    // Fallback: In Zwischenablage kopieren
                    copyToClipboard(shareText);
                });
            } else {
                // Desktop: In Zwischenablage kopieren
                copyToClipboard(shareText);
            }
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Kurze BestÃ¤tigung
                const shareBtn = document.getElementById('fleet-share-btn');
                if (shareBtn) {
                    const original = shareBtn.innerHTML;
                    shareBtn.innerHTML = 'âœ…';
                    shareBtn.style.background = '#10b981';
                    setTimeout(() => {
                        shareBtn.innerHTML = original;
                    }, 1500);
                }
                console.log('ğŸ“‹ Link kopiert:', text);
            }).catch(err => {
                alert('Link: ' + text);
            });
        }
        
        function clearFleetSearch() {
            const input = document.getElementById('fleet-address-search');
            const dropdown = document.getElementById('fleet-address-dropdown');
            const shareBtn = document.getElementById('fleet-share-btn');
            
            if (input) input.value = '';
            if (dropdown) dropdown.style.display = 'none';
            if (shareBtn) shareBtn.style.display = 'none';
            
            // Koordinaten lÃ¶schen
            fleetSearchCoords = null;
            fleetSearchName = null;
            
            // Marker entfernen
            if (fleetSearchMarker && fleetMap) {
                fleetMap.removeLayer(fleetSearchMarker);
                fleetSearchMarker = null;
            }
            
            // ZurÃ¼ck zur Ãœbersicht
            if (fleetMap) {
                fleetMap.setView([53.95, 14.05], 11);
            }
        }
        
        function initFleetMap() {
            // ğŸ”§ v5.90.489: ZERSTÃ–RE alte Karte falls sie existiert!
            if (fleetMap) {
                console.log('ğŸ—‘ï¸ Entferne alte Fleet-Map...');
                fleetMap.remove();
                fleetMap = null;
                fleetMapInitialized = false; // ğŸ”§ v5.90.525: RESET!
            }
            
            const mapContainer = document.getElementById('fleet-map');
            if (!mapContainer) {
                console.error('ğŸ’¾ fleet-map Container nicht gefunden!');
                return;
            }
            
            console.log('ğŸ—ºï¸ Initialisiere Fleet-Map...');
            
            // Karte initialisieren (Usedom-Zentrum)
            try {
                fleetMap = L.map('fleet-map').setView([53.95, 14.05], 11);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap'
                }).addTo(fleetMap);
                
                console.log('âœ… Fleet-Map erfolgreich initialisiert!');
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Initialisieren der Fleet-Map:', error);
                return;
            }
            
            // ğŸ†• v5.90.201: KLICK AUF KARTE â†’ POI ERSTELLEN!
            
            fleetMap.on('click', async function(e) {
                const lat = e.latlng.lat;
                const lon = e.latlng.lng;
                
                console.log('ğŸ“ Karte geklickt:', lat, lon);
                
                // ğŸ†• v5.90.211: MODAL AUTOMATISCH Ã–FFNEN!
                const modal = document.getElementById('floating-quick-booking');
                if (modal.style.display !== 'block') {
                    console.log('ğŸ’³ Ã–ffne Modal automatisch...');
                    // Ã–ffne Modal (aber ohne Kunde - nur leeres Modal)
                    modal.style.display = 'block';
                    
                    // Datum + Zeit setzen
                    const today = new Date();
                    const yyyy = today.getFullYear();
                    const mm = String(today.getMonth() + 1).padStart(2, '0');
                    const dd = String(today.getDate()).padStart(2, '0');
                    const todayStr = `${yyyy}-${mm}-${dd}`;
                    document.getElementById('fqb-date').value = todayStr;
                    
                    // Zeit setzen (mit VerzÃ¶gerung)
                    setTimeout(() => {
                        setFQBTimeNow();
                        console.log('â° Zeit-Felder initialisiert (Karten-Klick)');
                    }, 100);
                    
                    // Draggable aktivieren
                    makeModalDraggable();
                }
                
                // Entferne alten temporÃ¤ren Pin
                if (tempPinMarker) {
                    fleetMap.removeLayer(tempPinMarker);
                }
                
                // Erstelle GRÃœNEN Pin (temporÃ¤r)
                tempPinMarker = L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'temp-pin-marker',
                        html: `<div style="
                            background:#10b981;
                            color:white;
                            width:40px;
                            height:40px;
                            border-radius:50% 50% 50% 0;
                            transform:rotate(-45deg);
                            display:flex;
                            align-items:center;
                            justify-content:center;
                            border:3px solid white;
                            box-shadow:0 4px 12px rgba(16,185,129,0.5);
                            font-size:20px;
                        ">
                            <span style="transform:rotate(45deg);">ğŸ“</span>
                        </div>`,
                        iconSize: [40, 40],
                        iconAnchor: [20, 40]
                    }),
                    draggable: true
                }).addTo(fleetMap);
                
                // Mache Pin verschiebbar
                tempPinMarker.on('dragend', async function(event) {
                    const newPos = event.target.getLatLng();
                    console.log('ğŸ“ Pin verschoben:', newPos.lat, newPos.lng);
                    // Adresse neu laden
                    await loadAddressForPin(newPos.lat, newPos.lng, tempPinMarker);
                });
                
                // Lade Adresse fÃ¼r Position
                await loadAddressForPin(lat, lon, tempPinMarker);
            });
            
            console.log('âœ… Fleet-Map vollstÃ¤ndig initialisiert');
            console.log('ğŸ“ Klick auf Karte aktiviert!');
            
            // ğŸ”§ v5.90.525: WICHTIG! Markiere als initialisiert!
            fleetMapInitialized = true;
            
            // ğŸ†• Adresssuche initialisieren
            initFleetAddressSearch();
            
            // Erste Daten laden
            refreshFleetMap();
        }
        
        // ğŸ†• v5.90.201: ADRESSE FÃœR PIN LADEN UND POPUP ZEIGEN!
        async function loadAddressForPin(lat, lon, marker) {
            console.log('ğŸ”„ Lade Adresse fÃ¼r:', lat, lon);
            
            // Zeige "Lade..." Popup
            marker.bindPopup(`
                <div style="padding:12px;min-width:250px;">
                    <div style="text-align:center;color:#6b7280;">
                        <div style="font-size:24px;margin-bottom:8px;">ğŸ”„</div>
                        <div style="font-weight:600;">Lade Adresse...</div>
                    </div>
                </div>
            `).openPopup();
            
            try {
                // Reverse Geocoding mit Nominatim
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`
                );
                const data = await response.json();
                
                console.log('âœ… Adresse geladen:', data);
                
                // Baue schÃ¶ne Adresse
                const address = data.address || {};
                let displayAddress = '';
                
                if (address.road) {
                    displayAddress = address.road;
                    if (address.house_number) displayAddress += ' ' + address.house_number;
                }
                if (address.postcode) displayAddress += ', ' + address.postcode;
                if (address.town || address.city || address.village) {
                    displayAddress += ' ' + (address.town || address.city || address.village);
                }
                
                if (!displayAddress) displayAddress = data.display_name;
                
                // Popup mit Optionen
                const popupContent = `
                    <div style="padding:10px;min-width:220px;max-width:280px;">
                        <div style="font-weight:700;font-size:14px;margin-bottom:10px;color:#1f2937;">
                            ğŸ“ Neue Position
                        </div>
                        
                        <div style="background:#f3f4f6;padding:8px;border-radius:4px;margin-bottom:10px;font-size:12px;line-height:1.4;">
                            ${displayAddress}
                        </div>
                        
                        <div style="font-size:11px;color:#6b7280;margin-bottom:10px;">
                            ğŸ“ ${lat.toFixed(5)}, ${lon.toFixed(5)}
                        </div>
                        
                        <div style="display:flex;flex-direction:column;gap:6px;">
                            <button onclick="createPOIFromPin('${displayAddress.replace(/'/g, "\\'")}', ${lat}, ${lon})" 
                                style="width:100%;padding:8px;background:linear-gradient(135deg,#f59e0b,#d97706);color:white;border:none;border-radius:4px;font-weight:600;cursor:pointer;font-size:12px;">
                                â­ Als POI speichern
                            </button>
                            
                            <button onclick="quickBookingFromPin('${displayAddress.replace(/'/g, "\\'")}', ${lat}, ${lon})" 
                                style="width:100%;padding:8px;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:4px;font-weight:600;cursor:pointer;font-size:12px;">
                                âš¡ Schnellbuchung
                            </button>
                            
                            <button onclick="copyPinAddress('${displayAddress.replace(/'/g, "\\'")}', ${lat}, ${lon})" 
                                style="width:100%;padding:8px;background:#6b7280;color:white;border:none;border-radius:4px;font-weight:600;cursor:pointer;font-size:12px;">
                                ğŸ“‹ Kopieren
                            </button>
                            
                            <button onclick="deleteTempPin()" 
                                style="width:100%;padding:8px;background:#ef4444;color:white;border:none;border-radius:4px;font-weight:600;cursor:pointer;font-size:12px;">
                                ğŸ—‘ï¸ Pin lÃ¶schen
                            </button>
                        </div>
                    </div>
                `;
                
                marker.setPopupContent(popupContent);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der Adresse:', error);
                marker.setPopupContent(`
                    <div style="padding:12px;">
                        <div style="color:#ef4444;font-weight:600;">ğŸ’¾ Fehler</div>
                        <div style="font-size:13px;margin-top:6px;">Adresse konnte nicht geladen werden</div>
                    </div>
                `);
            }
        }
        
        // ğŸ†• v5.90.201: POI ERSTELLEN AUS PIN!
        function createPOIFromPin(address, lat, lon) {
            console.log('â­ Erstelle POI:', address, lat, lon);
            
            // Ã–ffne POI-Dialog mit vorausgefÃ¼llten Daten
            const name = prompt('POI-Name:', address);
            if (!name) return;
            
            const category = prompt('Kategorie (optional):\n\nVorschlÃ¤ge:\n- Krankenhaus\n- Hotel\n- Bahnhof\n- Restaurant\n- SehenswÃ¼rdigkeit', '');
            
            // Speichere POI
            const poiId = 'poi_' + Date.now();
            const poi = {
                name: name,
                address: address,
                lat: lat,
                lon: lon,
                category: category || '',
                createdAt: Date.now(),
                createdBy: currentUser.uid
            };
            
            db.ref(`pois/${poiId}`).set(poi).then(() => {
                alert('âœ… POI gespeichert: ' + name);
                console.log('âœ… POI in Firebase gespeichert:', poiId);
                
                // POI zur Liste hinzufÃ¼gen
                allPOIs.push({
                    id: poiId,
                    ...poi
                });
                
                // Lade POI-Verwaltung neu (falls offen)
                if (typeof loadPOIs === 'function') {
                    loadPOIs();
                }
            }).catch(error => {
                alert('ğŸ’¾ Fehler: ' + error.message);
                console.error('ğŸ’¾ POI speichern fehlgeschlagen:', error);
            });
        }
        
        // ğŸ†• v5.90.201: SCHNELLBUCHUNG AUS PIN!
        function quickBookingFromPin(address, lat, lon) {
            console.log('âš¡ Schnellbuchung von:', address);
            
            // Wechsle zur Schnellbuchung
            switchView('passenger');
            
            // Warte kurz und fÃ¼lle dann Ziel aus
            setTimeout(() => {
                const destinationField = document.getElementById('destination');
                if (destinationField) {
                    destinationField.value = address;
                    destinationField.dataset.lat = lat;
                    destinationField.dataset.lon = lon;
                    
                    // Trigger change event um Preis zu berechnen
                    destinationField.dispatchEvent(new Event('change'));
                    
                    console.log('âœ… Ziel gesetzt:', address);
                }
            }, 300);
        }
        
        // ğŸ†• v5.90.201: ADRESSE KOPIEREN!
        function copyPinAddress(address, lat, lon) {
            const text = `${address}\n${lat}, ${lon}`;
            
            navigator.clipboard.writeText(text).then(() => {
                alert('âœ… Kopiert:\n' + text);
            }).catch(err => {
                // Fallback
                prompt('Kopiere diese Adresse:', text);
            });
        }
        
        // ğŸ†• v5.90.234: PIN LÃ–SCHEN!
        function deleteTempPin() {
            if (tempPinMarker && fleetMap) {
                console.log('ğŸ—‘ï¸ LÃ¶sche temporÃ¤ren Pin...');
                fleetMap.removeLayer(tempPinMarker);
                tempPinMarker = null;
                console.log('âœ… Pin gelÃ¶scht!');
            } else {
                console.warn('âš ï¸ Kein Pin zum LÃ¶schen gefunden');
            }
        }
        
        async function refreshFleetMap() {
            if (!isFirebaseReady) {
                console.log('ğŸ’¾ Firebase nicht bereit');
                return;
            }
            
            if (!fleetMapInitialized) {
                initFleetMap();
                return;
            }
            
            try {
                // Lade alle Fahrer-Positionen
                const driversSnapshot = await db.ref('vehicles').once('value');
                const driversData = driversSnapshot.val() || {};
                
                // Lade alle aktiven Fahrten
                const ridesSnapshot = await db.ref('rides').once('value');
                const ridesData = ridesSnapshot.val() || {};
                
                // ğŸ†• v5.90.525: Speichere global fÃ¼r updateFleetTimeline!
                window.fleetMapRidesData = ridesData;
                window.fleetMapDriversData = driversData;
                
                // Finde aktive Fahrten pro Fahrzeug
                const vehicleRides = {};
                for (const rideId in ridesData) {
                    const ride = ridesData[rideId];
                    // ğŸ†• v5.90.252: Nur Fahrten die HEUTE sind!
                    if (isRideActiveToday(ride)) {
                        vehicleRides[ride.vehicleId] = {
                            ...ride,
                            firebaseId: rideId
                        };
                        console.log(`ğŸš— Fahrzeug ${ride.vehicleId} hat aktive Fahrt HEUTE:`, ride.customerName);
                    }
                }
                
                // Alte Marker und Routen entfernen
                for (const id in fleetMarkers) {
                    fleetMap.removeLayer(fleetMarkers[id]);
                }
                for (const id in fleetRoutes) {
                    fleetMap.removeLayer(fleetRoutes[id]);
                }
                fleetMarkers = {};
                fleetRoutes = {};
                
                let onlineCount = 0;
                let busyCount = 0;
                let vehicleListHtml = '';
                
                // Marker fÃ¼r jedes Fahrzeug erstellen
                for (const vehicleId in driversData) {
                    const driver = driversData[vehicleId];
                    // PrÃ¼fe ob Fahrer WIRKLICH online ist (nicht nur Position vorhanden)
                    if (!driver || !driver.lat || !driver.lon || driver.online === false) continue;
                    
                    onlineCount++;
                    
                    const vehicleName = driver.vehicle || VEHICLES[vehicleId]?.name || vehicleId;
                    const activeRide = vehicleRides[vehicleId];
                    
                    // Status bestimmen
                    let status = 'frei';
                    let color = '#22c55e'; // GrÃ¼n
                    let statusText = 'ğŸŸ¢ Frei';
                    
                    if (activeRide) {
                        busyCount++;
                        if (activeRide.status === 'assigned') {
                            status = 'zugewiesen';
                            color = '#f59e0b'; // Orange
                            statusText = 'ğŸŸ  Zugewiesen';
                        } else {
                            status = 'besetzt';
                            color = '#ef4444'; // Rot
                            statusText = 'ğŸ”´ Besetzt';
                        }
                    }
                    
                    // Custom Icon erstellen
                    const icon = L.divIcon({
                        className: 'fleet-marker',
                        html: `
                            <div style="
                                background: ${color};
                                width: 36px;
                                height: 36px;
                                border-radius: 50%;
                                border: 3px solid white;
                                box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 18px;
                            ">ğŸš•</div>
                        `,
                        iconSize: [36, 36],
                        iconAnchor: [18, 18]
                    });
                    
                    // Popup-Inhalt
                    let popupContent = `
                        <div style="min-width:220px;">
                            <div style="font-weight:bold;font-size:14px;margin-bottom:5px;">
                                ğŸš— ${vehicleName}
                            </div>
                            <div style="color:${color};font-weight:600;margin-bottom:8px;">
                                ${statusText}
                            </div>
                    `;
                    
                    if (activeRide) {
                        popupContent += `
                            <div style="background:#f3f4f6;padding:10px;border-radius:6px;font-size:11px;line-height:1.6;margin-bottom:8px;">
                                <div style="margin-bottom:6px;"><strong>ğŸ’¾ ${activeRide.customerName || 'Kunde'}</strong></div>
                                <div style="margin-bottom:4px;">
                                    ğŸ“… ${new Date(activeRide.timestamp).toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit', year:'numeric'})} 
                                    ğŸ• ${new Date(activeRide.timestamp).toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'})} Uhr
                                </div>
                                <div style="margin-bottom:4px;">ğŸ“ Von: ${activeRide.pickup || '?'}</div>
                                <div style="background:#3b82f6;color:white;padding:6px;border-radius:4px;font-weight:600;margin-bottom:4px;">
                                    ğŸ§­ FÃ¤hrt nach: ${activeRide.destination || '?'}
                                </div>
                                <div style="margin-top:4px;">ğŸ’° ${activeRide.price || '?'}â‚¬</div>
                            </div>
                        `;
                        
                        // ğŸ†• v5.90.525: ROUTEN IMMER ZEICHNEN!
                        if (activeRide.status === 'picked_up' && activeRide.destCoords) {
                            // ğŸŸ¢ GRÃœN: FÃ¤hrt zum Ziel!
                            drawRouteToDestination(vehicleId, driver, activeRide, '#10b981');
                        } else if (activeRide.pickupCoords && (activeRide.status === 'assigned' || activeRide.status === 'accepted' || activeRide.status === 'on_way')) {
                            // ğŸ”´ ROT: FÃ¤hrt zum Kunden!
                            drawRouteToPickup(vehicleId, driver, activeRide, '#ef4444');
                        }
                    }
                    
                    popupContent += `
                        <div style="font-size:10px;color:#888;margin-top:5px;">
                            ğŸ“ ${driver.lat.toFixed(4)}, ${driver.lon.toFixed(4)}
                        </div>
                    </div>`;
                    
                    // Marker erstellen
                    const marker = L.marker([driver.lat, driver.lon], { icon })
                        .bindPopup(popupContent)
                        .addTo(fleetMap);
                    
                    fleetMarkers[vehicleId] = marker;
                    
                    // Fahrzeug-Liste erstellen
                    const lastUpdate = driver.timestamp ? new Date(driver.timestamp).toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit', second:'2-digit'}) : '?';
                    
                    // ğŸ†• v5.20.5: GPS-Alter berechnen und farbig anzeigen
                    let gpsAgeMinutes = 0;
                    let gpsAgeColor = '#10b981'; // GrÃ¼n = frisch
                    let gpsAgeIcon = 'ğŸŸ¢';
                    let isStale = false;
                    
                    if (driver.timestamp) {
                        gpsAgeMinutes = Math.floor((Date.now() - driver.timestamp) / 60000);
                        
                        if (gpsAgeMinutes < 6) {
                            gpsAgeColor = '#10b981'; // GrÃ¼n
                            gpsAgeIcon = 'ğŸŸ¢';
                        } else if (gpsAgeMinutes < 11) {
                            gpsAgeColor = '#f59e0b'; // Gelb/Orange
                            gpsAgeIcon = 'ğŸŸ¡';
                        } else {
                            gpsAgeColor = '#ef4444'; // Rot
                            gpsAgeIcon = 'ğŸ”´';
                            isStale = true;
                        }
                    }
                    
                    // ğŸ†• Status-Farbe und Text anpassen wenn GPS veraltet
                    let displayStatus = status;
                    let displayColor = color;
                    if (isStale && status === 'frei') {
                        displayStatus = 'stale';
                        displayColor = '#9ca3af'; // Grau
                    }
                    
                    vehicleListHtml += `
                        <div onclick="focusVehicle('${vehicleId}')" style="
                            display:flex;
                            justify-content:space-between;
                            align-items:center;
                            padding:10px;
                            background:white;
                            border:1px solid #e0e0e0;
                            border-left:4px solid ${displayColor};
                            border-radius:6px;
                            margin-bottom:6px;
                            cursor:pointer;
                        ">
                            <div>
                                <div style="font-weight:600;">ğŸš— ${vehicleName}</div>
                                ${activeRide ? `
                                    <div style="font-size:11px;color:#666;line-height:1.4;">
                                        <div style="margin-bottom:2px;">
                                            ğŸ’¾ <strong>${activeRide.customerName || 'Kunde'}</strong>
                                        </div>
                                        <div style="margin-bottom:2px;">
                                            ğŸ“… ${new Date(activeRide.timestamp).toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit', year:'numeric'})} 
                                            ğŸ• ${new Date(activeRide.timestamp).toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'})} Uhr
                                        </div>
                                        <div style="margin-bottom:2px;">
                                            ğŸ“ ${activeRide.pickup || 'Start unbekannt'}
                                        </div>
                                        <div style="margin-bottom:4px;">
                                            ğŸ¯ ${activeRide.destination || 'Ziel unbekannt'}
                                        </div>
                                        ${(() => {
                                            // ğŸ†• v5.90.525: FAHRTDAUER + FREI AB!
                                            let durationMin = 30;
                                            if (activeRide.duration) {
                                                durationMin = parseInt(activeRide.duration);
                                            } else if (activeRide.distance) {
                                                durationMin = Math.ceil(parseFloat(activeRide.distance) * 1.5);
                                            } else if (activeRide.price) {
                                                durationMin = Math.max(10, Math.round(parseFloat(activeRide.price) * 0.75));
                                            }
                                            
                                            const pickupTime = new Date(activeRide.pickupTimestamp || activeRide.timestamp || Date.now());
                                            const freeTime = new Date(pickupTime.getTime() + durationMin * 60000);
                                            const freeTimeStr = freeTime.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                                            
                                            return `<div style="margin-bottom:4px;color:#10b981;font-weight:600;">
                                                â±ï¸ ~${durationMin} Min â†’ ğŸŸ¢ Frei ab ${freeTimeStr}
                                            </div>`;
                                        })()}
                                        <div style="display:flex;align-items:center;gap:8px;margin-top:6px;">
                                            <span style="
                                                background:${activeRide.status === 'completed' ? '#10b981' : activeRide.status === 'picked_up' ? '#8b5cf6' : activeRide.status === 'accepted' ? '#3b82f6' : '#f59e0b'};
                                                color:white;
                                                padding:3px 8px;
                                                border-radius:12px;
                                                font-size:10px;
                                                font-weight:600;
                                            ">
                                                ${activeRide.status === 'completed' ? 'âœ… Abgeschlossen' : 
                                                  activeRide.status === 'picked_up' ? 'ğŸš— Unterwegs' : 
                                                  activeRide.status === 'accepted' ? 'âœ… Angenommen' : 
                                                  activeRide.status === 'assigned' ? 'ğŸ“‹ Zugewiesen' :
                                                  'ğŸ“… Vorbestellt'}
                                            </span>
                                            ${activeRide.firebaseId ? `
                                                <button onclick="event.stopPropagation();changeRideStatus('${activeRide.firebaseId}', '${activeRide.status}')" style="
                                                    background:#f59e0b;
                                                    color:white;
                                                    border:none;
                                                    padding:3px 8px;
                                                    border-radius:12px;
                                                    font-size:10px;
                                                    font-weight:600;
                                                    cursor:pointer;
                                                " title="Status Ã¤ndern">
                                                    âš™ï¸
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                ` : `
                                    <div style="font-size:11px;color:${gpsAgeColor};">
                                        ${gpsAgeIcon} GPS: ${lastUpdate}
                                        ${gpsAgeMinutes > 0 ? `<span style="color:#888;font-size:10px;">(${gpsAgeMinutes} Min)</span>` : ''}
                                    </div>
                                `}
                            </div>
                            <div style="
                                background:${displayColor};
                                color:white;
                                padding:4px 10px;
                                border-radius:15px;
                                font-size:11px;
                                font-weight:600;
                            ">${displayStatus === 'frei' ? 'FREI' : displayStatus === 'zugewiesen' ? 'ZUGEWIESEN' : displayStatus === 'stale' ? 'GPS ALT!' : 'BESETZT'}</div>
                        </div>
                    `;
                }
                
                // Offline-Fahrzeuge aus VEHICLES hinzufÃ¼gen
                for (const vehicleId in VEHICLES) {
                    // Zeige als OFFLINE wenn: nicht in driversData ODER online === false
                    const driver = driversData[vehicleId];
                    const isOffline = !driver || !driver.lat || !driver.lon || driver.online === false;
                    
                    if (isOffline) {
                        // Letzter bekannter Zeitstempel
                        let lastSeenText = '';
                        if (driver) {
                            const lastTime = driver.lastOffline || driver.timestamp;
                            if (lastTime) {
                                const lastDate = new Date(lastTime);
                                const now = new Date();
                                const diffMs = now - lastDate;
                                const diffMins = Math.floor(diffMs / 60000);
                                const diffHours = Math.floor(diffMs / 3600000);
                                const diffDays = Math.floor(diffMs / 86400000);
                                
                                if (diffMins < 60) {
                                    lastSeenText = `vor ${diffMins} Min`;
                                } else if (diffHours < 24) {
                                    lastSeenText = `vor ${diffHours} Std`;
                                } else {
                                    lastSeenText = `vor ${diffDays} Tag${diffDays > 1 ? 'en' : ''}`;
                                }
                            }
                        }
                        
                        vehicleListHtml += `
                            <div style="
                                display:flex;
                                justify-content:space-between;
                                align-items:center;
                                padding:10px;
                                background:#f9fafb;
                                border:1px solid #e0e0e0;
                                border-left:4px solid #6b7280;
                                border-radius:6px;
                                margin-bottom:6px;
                                opacity:0.6;
                            ">
                                <div>
                                    <div style="font-weight:600;">ğŸš— ${VEHICLES[vehicleId].name}</div>
                                    <div style="font-size:11px;color:#888;">${VEHICLES[vehicleId].plate}${lastSeenText ? ` Â· ğŸ• ${lastSeenText}` : ''}</div>
                                </div>
                                <div style="
                                    background:#6b7280;
                                    color:white;
                                    padding:4px 10px;
                                    border-radius:15px;
                                    font-size:11px;
                                    font-weight:600;
                                ">OFFLINE</div>
                            </div>
                        `;
                    }
                }
                
                // Update UI
                document.getElementById('fleet-vehicle-list').innerHTML = vehicleListHtml || 
                    '<div style="text-align:center;color:#888;padding:20px;">Keine Fahrzeuge online</div>';
                
                // ğŸ†• v5.90.525: NÃ„CHSTER TERMIN BERECHNEN!
                let nextAppointmentHtml = '';
                
                // Hole ALLE zukÃ¼nftigen Fahrten (nicht nur heute)
                const allFutureRides = [];
                for (const rideId in ridesData) {
                    const ride = ridesData[rideId];
                    const pickupTime = ride.pickupTimestamp || ride.createdAt || 0;
                    const now = Date.now();
                    
                    // Nur zukÃ¼nftige Fahrten mit aktivem Status
                    // ğŸ†• v5.90.547: AUCH on_way und picked_up zeigen!
                    const activeStatuses = ['new', 'vorbestellt', 'assigned', 'accepted', 'on_way', 'picked_up'];
                    if (pickupTime > now && activeStatuses.includes(ride.status)) {
                        allFutureRides.push({
                            ...ride,
                            firebaseId: rideId,
                            pickupTime: pickupTime
                        });
                    }
                }
                
                // Sortiere nach Zeit (nÃ¤chste zuerst)
                allFutureRides.sort((a, b) => a.pickupTime - b.pickupTime);
                
                if (allFutureRides.length > 0) {
                    const nextRide = allFutureRides[0];
                    const now = Date.now();
                    const minutesUntil = Math.round((nextRide.pickupTime - now) / 60000);
                    const timeStr = new Date(nextRide.pickupTime).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    
                    // Fahrzeug-Name
                    let vehicleName = 'Nicht zugewiesen';
                    if (nextRide.vehicleId) {
                        const driver = driversData[nextRide.vehicleId];
                        vehicleName = driver?.vehicle || VEHICLES[nextRide.vehicleId]?.name || nextRide.vehicleId;
                    }
                    
                    // Farbe basierend auf Zeit
                    let bgColor = '#dbeafe';
                    let borderColor = '#3b82f6';
                    let textColor = '#1e40af';
                    
                    if (minutesUntil <= 15) {
                        bgColor = '#fef2f2';
                        borderColor = '#ef4444';
                        textColor = '#991b1b';
                    } else if (minutesUntil <= 30) {
                        bgColor = '#fef3c7';
                        borderColor = '#f59e0b';
                        textColor = '#92400e';
                    }
                    
                    // ğŸ†• v5.90.547: STATUS-BADGE!
                    let statusBadge = '';
                    let statusText = '';
                    if (nextRide.status === 'on_way') {
                        statusText = 'ğŸš— UNTERWEGS';
                        statusBadge = `<span style="background:#10b981;color:white;padding:3px 8px;border-radius:6px;font-size:10px;font-weight:700;">${statusText}</span>`;
                    } else if (nextRide.status === 'picked_up') {
                        statusText = 'ğŸ‘¤ KUNDE DRIN';
                        statusBadge = `<span style="background:#8b5cf6;color:white;padding:3px 8px;border-radius:6px;font-size:10px;font-weight:700;">${statusText}</span>`;
                    } else if (nextRide.status === 'accepted') {
                        statusText = 'âœ… ANGENOMMEN';
                        statusBadge = `<span style="background:#3b82f6;color:white;padding:3px 8px;border-radius:6px;font-size:10px;font-weight:700;">${statusText}</span>`;
                    } else if (nextRide.status === 'assigned') {
                        statusText = 'â³ ZUGETEILT';
                        statusBadge = `<span style="background:#f59e0b;color:white;padding:3px 8px;border-radius:6px;font-size:10px;font-weight:700;">${statusText}</span>`;
                    } else if (nextRide.status === 'vorbestellt' || nextRide.pickupTime > Date.now()) {
                        statusText = 'ğŸ“… VORBESTELLT';
                        statusBadge = `<span style="background:#6b7280;color:white;padding:3px 8px;border-radius:6px;font-size:10px;font-weight:700;">${statusText}</span>`;
                    } else {
                        statusText = 'ğŸ†• NEU';
                        statusBadge = `<span style="background:#06b6d4;color:white;padding:3px 8px;border-radius:6px;font-size:10px;font-weight:700;">${statusText}</span>`;
                    }
                    
                    nextAppointmentHtml = `
                        <div style="
                            background:${bgColor};
                            border:2px solid ${borderColor};
                            padding:14px;
                            border-radius:10px;
                            margin-bottom:12px;
                        ">
                            <div style="font-weight:700;font-size:14px;color:${textColor};margin-bottom:8px;display:flex;align-items:center;gap:8px;justify-content:space-between;">
                                <span>ğŸ”” NÃ„CHSTER TERMIN</span>
                                ${statusBadge}
                            </div>
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                                <div style="font-size:20px;font-weight:700;color:${textColor};">
                                    â° In ${minutesUntil} Min
                                </div>
                                <div style="font-size:14px;color:${textColor};opacity:0.8;">
                                    ${timeStr} Uhr
                                </div>
                            </div>
                            <div style="font-size:12px;color:${textColor};line-height:1.5;">
                                <div style="margin-bottom:3px;">ğŸ’¾ ${nextRide.customerName || 'Unbekannt'}</div>
                                <div style="margin-bottom:3px;">ğŸ“ ${nextRide.pickup || 'Unbekannt'}</div>
                                <div style="margin-bottom:3px;">ğŸ¯ ${nextRide.destination || 'Unbekannt'}</div>
                                <div style="font-weight:600;">ğŸš— ${vehicleName}</div>
                            </div>
                        </div>
                    `;
                }
                
                // FÃ¼ge Stats und NÃ¤chster Termin zusammen
                const statsHtml = nextAppointmentHtml + 
                    `<div style="font-size:13px;color:#6b7280;text-align:center;padding:8px;">
                        ${onlineCount} online, ${busyCount} besetzt
                    </div>`;
                
                document.getElementById('fleet-status').innerHTML = statsHtml;
                
                // Karte auf alle Marker zentrieren
                if (Object.keys(fleetMarkers).length > 0) {
                    const group = L.featureGroup(Object.values(fleetMarkers));
                    fleetMap.fitBounds(group.getBounds().pad(0.1));
                }
                
                console.log('ğŸ—ºï¸ Fahrzeug-Karte aktualisiert:', onlineCount, 'online,', busyCount, 'besetzt');
                
                // ğŸ†• v5.90.488: UPDATE TIMELINE BOXEN!
                updateFleetTimeline(ridesData, driversData);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der Fahrzeug-Daten:', error);
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.90.525: FLEET-OVERVIEW WRAPPER-FUNKTIONEN!
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Globale Variablen fÃ¼r Overview-Map
        let fleetMapOverview = null;
        let fleetMapOverviewInitialized = false;
        
        // Init-Funktion (1:1 Kopie von initFleetMap aber mit fleet-map-overview!)
        function initFleetMapOverview() {
            // ğŸ”§ ZerstÃ¶re alte Karte
            if (fleetMapOverview) {
                console.log('ğŸ—‘ï¸ Entferne alte Fleet-Map-Overview...');
                fleetMapOverview.remove();
                fleetMapOverview = null;
                fleetMapOverviewInitialized = false;
            }
            
            const mapContainer = document.getElementById('fleet-map-overview');
            if (!mapContainer) {
                console.error('ğŸ’¾ fleet-map-overview Container nicht gefunden!');
                return;
            }
            
            console.log('ğŸ—ºï¸ Initialisiere Fleet-Map-Overview...');
            
            try {
                fleetMapOverview = L.map('fleet-map-overview').setView([53.95, 14.05], 11);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap'
                }).addTo(fleetMapOverview);
                
                fleetMapOverviewInitialized = true;
                console.log('âœ… Fleet-Map-Overview erfolgreich initialisiert!');
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Initialisieren der Fleet-Map-Overview:', error);
                return;
            }
        }
        
        // Refresh-Funktion (ruft ADMIN-Funktion auf + kopiert zu Overview-IDs!)
        async function refreshFleetMapOverview() {
            if (!isFirebaseReady) {
                console.log('ğŸ’¾ Firebase nicht bereit');
                return;
            }
            
            if (!fleetMapOverviewInitialized) {
                initFleetMapOverview();
                return;
            }
            
            // ğŸ†• v5.90.525: TEMPORÃ„R Admin-Map nutzen!
            const tempFleetMap = fleetMap;
            const tempFleetMapInit = fleetMapInitialized;
            
            // Ersetze mit Overview-Map
            fleetMap = fleetMapOverview;
            fleetMapInitialized = fleetMapOverviewInitialized;
            
            // Rufe ADMIN-Funktion auf!
            await refreshFleetMap();
            
            // ğŸ†• v5.90.525: KOPIERE Fahrzeug-Liste zu Overview-Container!
            const adminList = document.getElementById('fleet-vehicle-list');
            const overviewList = document.getElementById('fleet-vehicle-list-overview');
            if (adminList && overviewList) {
                overviewList.innerHTML = adminList.innerHTML;
            }
            
            // Stelle Admin-Map wieder her
            fleetMap = tempFleetMap;
            fleetMapInitialized = tempFleetMapInit;
            
            // ğŸ†• v5.90.525: UPDATE TIMELINE NOCHMAL (mit aktuellen Daten!)
            console.log('ğŸ”„ Aktualisiere Timeline fÃ¼r Overview...');
            if (window.fleetMapRidesData && window.fleetMapDriversData) {
                updateFleetTimeline(window.fleetMapRidesData, window.fleetMapDriversData);
            } else {
                console.warn('âš ï¸ fleetMapRidesData oder fleetMapDriversData nicht verfÃ¼gbar!');
            }
        }
        
        // Toggle Auto-Refresh
        function toggleFleetAutoRefreshOverview() {
            const btn = document.getElementById('fleet-auto-btn-overview');
            if (!btn) return;
            
            if (window.fleetOverviewInterval) {
                clearInterval(window.fleetOverviewInterval);
                window.fleetOverviewInterval = null;
                btn.textContent = 'â–¶ï¸ Auto-Update';
                btn.style.background = '#10b981';
            } else {
                window.fleetOverviewInterval = setInterval(() => {
                    if (currentView === 'fleet-overview') {
                        console.log('ğŸ”„ Auto-Update FahrzeugÃ¼bersicht...');
                        refreshFleetMapOverview();
                    }
                }, 5000);
                btn.textContent = 'â¸ï¸ Stop';
                btn.style.background = '#ef4444';
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // ğŸ†• v5.90.488: TIMELINE UPDATE FUNKTION
        function updateFleetTimeline(ridesData, driversData) {
            const now = Date.now();
            const oneHourLater = now + (60 * 60 * 1000);
            
            // ğŸ†• v5.90.525: DEBUG!
            console.log('ğŸ” updateFleetTimeline aufgerufen!');
            console.log('ğŸ“± ridesData:', Object.keys(ridesData || {}).length, 'Fahrten');
            console.log('ğŸš— driversData:', driversData ? Object.keys(driversData).length + ' Fahrzeuge' : 'NULL!');
            if (driversData) {
                Object.keys(driversData).forEach(id => {
                    const d = driversData[id];
                    console.log(`  - ${id}:`, {
                        hasGPS: !!(d?.lat && d?.lon),
                        lat: d?.lat,
                        lon: d?.lon,
                        timestamp: d?.timestamp ? new Date(d.timestamp).toLocaleTimeString() : 'FEHLT',
                        isOnline: d?.isOnline
                    });
                });
            }
            
            // Sammle ALLE zukÃ¼nftigen Fahrten
            const futureRides = [];
            for (const rideId in ridesData) {
                const ride = ridesData[rideId];
                const pickupTime = ride.pickupTimestamp || ride.createdAt || 0;
                
                // Nur zukÃ¼nftige + nicht abgeschlossen
                const activeStatuses = ['new', 'vorbestellt', 'assigned', 'accepted', 'picked_up'];
                if (pickupTime > now && activeStatuses.includes(ride.status)) {
                    futureRides.push({
                        ...ride,
                        firebaseId: rideId,
                        pickupTime: pickupTime
                    });
                }
            }
            
            // Sortiere nach Zeit
            futureRides.sort((a, b) => a.pickupTime - b.pickupTime);
            
            // ===== LINKS: NÃ„CHSTER TERMIN =====
            const nextBox = document.getElementById('fleet-next-appointment');
            if (nextBox) {
                if (futureRides.length === 0) {
                    nextBox.innerHTML = `
                        <div style="font-size:14px;opacity:0.9;margin-bottom:8px;font-weight:600;">â° NÃ„CHSTER TERMIN</div>
                        <div style="font-size:18px;font-weight:700;opacity:0.8;">Keine Termine</div>
                        <div style="font-size:13px;opacity:0.8;margin-top:4px;">Alle Fahrten sind abgeschlossen</div>
                    `;
                } else {
                    const next = futureRides[0];
                    const minutesUntil = Math.round((next.pickupTime - now) / 60000);
                    const timeStr = new Date(next.pickupTime).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    
                    // ğŸ†• v5.90.525: FAHRZEUG-VERFÃœGBARKEIT MIT ANFAHRTSZEIT!
                    let bgColor, borderColor, statusText, statusIcon;
                    let vehiclesNearby = [];
                    
                    // Berechne fÃ¼r jedes Fahrzeug ob es rechtzeitig da sein kann
                    if (next.pickupCoords && driversData) {
                        const pickupLat = next.pickupCoords.lat;
                        const pickupLon = next.pickupCoords.lon;
                        
                        Object.keys(driversData).forEach(vehicleId => {
                            const driver = driversData[vehicleId];
                            if (!driver || !driver.lat || !driver.lon) return;
                            
                            // ğŸ†• v5.90.525: GPS-Alter berechnen
                            // ğŸ†• v5.90.635: IGNORIERE String-Timestamps (altes Format)!
                            const timestampIsValid = driver.timestamp && typeof driver.timestamp === 'number';
                            const gpsAge = timestampIsValid ? (Date.now() - driver.timestamp) / 60000 : 999;
                            const hasRecentGPS = gpsAge <= 10;
                            
                            // ğŸ†• v5.90.525: NUR Fahrzeuge mit GPS < 10 Min anzeigen!
                            if (!hasRecentGPS) return;
                            
                            // Distanz berechnen (Haversine)
                            const R = 6371; // km
                            const dLat = (driver.lat - pickupLat) * Math.PI / 180;
                            const dLon = (driver.lon - pickupLon) * Math.PI / 180;
                            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                                     Math.cos(pickupLat * Math.PI / 180) * Math.cos(driver.lat * Math.PI / 180) *
                                     Math.sin(dLon/2) * Math.sin(dLon/2);
                            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                            const distance = R * c;
                            
                            // Anfahrtszeit schÃ¤tzen (Durchschnitt 50 km/h + 5 Min Puffer)
                            const drivingTimeMinutes = Math.round((distance / 50) * 60) + 5;
                            
                            // ğŸ†• v5.90.525: isOnline - wenn undefined, dann TRUE wenn GPS aktuell!
                            const isOnline = driver.isOnline !== false && hasRecentGPS;
                            
                            // Kann Fahrzeug rechtzeitig da sein?
                            // NUR wenn GPS aktuell & online!
                            const canMakeIt = hasRecentGPS && isOnline && drivingTimeMinutes < minutesUntil;
                            
                            // ğŸ†• v5.90.634: Fallback wenn Name null/undefined/leer!
                            const vehicleName = driver.vehicle || VEHICLES[vehicleId]?.name || vehicleId;
                            const displayName = vehicleName && vehicleName !== 'null' ? vehicleName : vehicleId;
                            
                            vehiclesNearby.push({
                                id: vehicleId,
                                name: displayName,
                                distance: distance,
                                drivingTime: drivingTimeMinutes,
                                canMakeIt: canMakeIt,
                                gpsAge: gpsAge,
                                hasRecentGPS: hasRecentGPS,
                                isOnline: isOnline
                            });
                        });
                        
                        // Sortiere nach Distanz
                        vehiclesNearby.sort((a, b) => a.distance - b.distance);
                    }
                    
                    // ZÃ¤hle Fahrzeuge die es schaffen
                    const availableCount = vehiclesNearby.filter(v => v.canMakeIt).length;
                    
                    // AMPEL-LOGIK basierend auf verfÃ¼gbaren Fahrzeugen
                    if (next.vehicleId) {
                        // Fahrzeug zugeteilt
                        bgColor = 'linear-gradient(135deg,#10b981,#059669)';
                        borderColor = '#10b981';
                        statusIcon = 'âœ…';
                        statusText = 'Fahrzeug zugeteilt';
                    } else if (availableCount === 0) {
                        // ğŸ”´ ROT: KEIN Fahrzeug kann es schaffen!
                        bgColor = 'linear-gradient(135deg,#ef4444,#dc2626)';
                        borderColor = '#ef4444';
                        statusIcon = 'ğŸš¨';
                        statusText = 'KEINE Fahrzeuge verfÃ¼gbar!';
                    } else if (availableCount <= 2) {
                        // ğŸŸ¡ GELB: Nur 1-2 Fahrzeuge
                        bgColor = 'linear-gradient(135deg,#f59e0b,#d97706)';
                        borderColor = '#f59e0b';
                        statusIcon = 'âš ï¸';
                        statusText = `${availableCount} Fahrzeug${availableCount > 1 ? 'e' : ''} verfÃ¼gbar`;
                    } else {
                        // ğŸŸ¢ GRÃœN: 3+ Fahrzeuge
                        bgColor = 'linear-gradient(135deg,#10b981,#059669)';
                        borderColor = '#10b981';
                        statusIcon = 'âœ…';
                        statusText = `${availableCount} Fahrzeuge verfÃ¼gbar`;
                    }
                    
                    // Fahrzeug-Info
                    let vehicleText = '';
                    if (next.vehicleId) {
                        const driver = driversData[next.vehicleId];
                        const vehicleName = driver?.vehicle || VEHICLES[next.vehicleId]?.name || next.vehicleId;
                        
                        let statusEmoji = 'â³';
                        if (next.status === 'accepted') statusEmoji = 'âœ…';
                        else if (next.status === 'picked_up') statusEmoji = 'ğŸš—';
                        else if (next.status === 'assigned') statusEmoji = 'â³';
                        
                        vehicleText = `ğŸš— ${vehicleName} ${statusEmoji}`;
                    } else {
                        vehicleText = 'ğŸš— â“ Noch nicht zugeteilt';
                    }
                    
                    // Zeit-Info
                    let timeInfo = `in ${minutesUntil} Min`;
                    if (minutesUntil > 60) {
                        const hours = Math.floor(minutesUntil / 60);
                        const mins = minutesUntil % 60;
                        timeInfo = `in ${hours}h ${mins}m`;
                    }
                    
                    // ğŸ†• v5.90.525: Box mit Ampel-Farbe!
                    nextBox.style.background = bgColor;
                    nextBox.style.boxShadow = `0 4px 12px ${borderColor}40`;
                    
                    // ğŸ†• v5.90.525: FAHRZEUG-LISTE MIT GPS-ALTER & STATUS!
                    let vehiclesListHTML = '';
                    if (vehiclesNearby.length > 0) {
                        vehiclesListHTML = `
                            <div style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.2);">
                                <div style="font-size:13px;font-weight:600;margin-bottom:8px;opacity:0.9;">
                                    ğŸš— Fahrzeuge in der NÃ¤he:
                                </div>
                                ${vehiclesNearby.slice(0, 5).map(v => {
                                    let statusIcon = 'ğŸ’¾';
                                    let warningText = '';
                                    
                                    if (v.canMakeIt) {
                                        statusIcon = 'âœ…';
                                    } else if (!v.hasRecentGPS) {
                                        statusIcon = 'âš ï¸';
                                        const gpsMinutes = Math.round(v.gpsAge);
                                        const gpsHours = Math.floor(gpsMinutes / 60);
                                        warningText = gpsHours > 0 ? ` (GPS: vor ${gpsHours}h)` : ` (GPS: vor ${gpsMinutes}m)`;
                                    } else if (!v.isOnline) {
                                        statusIcon = 'ğŸ’¤';
                                        warningText = ' (offline)';
                                    }
                                    
                                    return `
                                        <div style="font-size:12px;opacity:0.9;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;">
                                            <span>${statusIcon} ${v.name}${warningText}</span>
                                            <span style="opacity:0.8;">${v.distance.toFixed(1)} km â€¢ ${v.drivingTime} Min</span>
                                        </div>
                                    `;
                                }).join('')}
                                ${vehiclesNearby.length > 5 ? `<div style="font-size:11px;opacity:0.7;margin-top:4px;">+ ${vehiclesNearby.length - 5} weitere</div>` : ''}
                            </div>
                        `;
                    }
                    
                    nextBox.innerHTML = `
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <div style="font-size:14px;opacity:0.9;font-weight:600;">â° NÃ„CHSTER TERMIN</div>
                            <div style="font-size:24px;">${statusIcon}</div>
                        </div>
                        <div style="font-size:28px;font-weight:700;margin-bottom:6px;">${timeStr} (${timeInfo})</div>
                        <div style="font-size:16px;font-weight:600;margin-bottom:4px;">ğŸ’¾ ${next.customerName || 'Unbekannt'}</div>
                        <div style="font-size:14px;opacity:0.9;margin-bottom:2px;">ğŸ“ ${next.pickup || 'Unbekannt'}</div>
                        <div style="font-size:14px;opacity:0.9;margin-bottom:8px;">ğŸ¯ ${next.destination || 'Unbekannt'}</div>
                        <div style="font-size:13px;opacity:0.9;margin-bottom:4px;">${vehicleText}</div>
                        <div style="font-size:12px;opacity:0.8;background:rgba(255,255,255,0.2);padding:6px 10px;border-radius:6px;margin-top:8px;">
                            ${statusText}
                        </div>
                        ${vehiclesListHTML}
                    `;
                }
            }
            
            // ===== RECHTS: NÃ„CHSTE STUNDE =====
            const listBox = document.getElementById('fleet-upcoming-list');
            if (listBox) {
                const upcomingRides = futureRides.filter(r => r.pickupTime <= oneHourLater);
                
                if (upcomingRides.length === 0) {
                    listBox.innerHTML = `
                        <div style="text-align:center;padding:20px;color:#9ca3af;">
                            <div style="font-size:32px;margin-bottom:8px;">â°</div>
                            <div style="font-size:13px;">Keine Fahrten in der nÃ¤chsten Stunde</div>
                        </div>
                    `;
                } else {
                    let html = '';
                    upcomingRides.forEach(ride => {
                        const minutesUntil = Math.round((ride.pickupTime - now) / 60000);
                        const timeStr = new Date(ride.pickupTime).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                        
                        // Fahrzeug mit Status
                        let vehicleIcon = 'â“ Nicht zugeteilt';
                        if (ride.vehicleId) {
                            const driver = driversData[ride.vehicleId];
                            const vehicleName = driver?.vehicle || VEHICLES[ride.vehicleId]?.name || ride.vehicleId;
                            
                            // ğŸ”§ v5.90.489: Status-Icon
                            let statusIcon = 'â³';
                            if (ride.status === 'accepted') statusIcon = 'âœ…';
                            else if (ride.status === 'picked_up') statusIcon = 'ğŸš—';
                            else if (ride.status === 'assigned') statusIcon = 'â³';
                            
                            vehicleIcon = `${vehicleName} ${statusIcon}`;
                        }
                        
                        html += `
                            <div style="padding:8px;border-bottom:1px solid #e5e7eb;line-height:1.4;">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                                    <span style="font-weight:700;color:#0ea5e9;">${timeStr}</span>
                                    <span style="font-size:11px;background:#f0f9ff;color:#0ea5e9;padding:2px 6px;border-radius:4px;">in ${minutesUntil} Min</span>
                                </div>
                                <div style="font-weight:600;color:#1f2937;margin-bottom:2px;">ğŸ’¾ ${ride.customerName || 'Unbekannt'}</div>
                                <div style="font-size:11px;color:#6b7280;">ğŸ“ ${ride.pickup || '?'} â†’ ${ride.destination || '?'}</div>
                                <div style="font-size:11px;color:#6b7280;margin-top:2px;">ğŸš— ${vehicleIcon}</div>
                            </div>
                        `;
                    });
                    listBox.innerHTML = html;
                }
            }
        }
        
        // ğŸ†• v5.90.202: STANDALONE FAHRZEUGÃœBERSICHT (EIGENES TAB!)
        let fleetMapStandalone = null;
        let fleetMapStandaloneInitialized = false;
        let fleetMarkersStandalone = {};
        let fleetRoutesStandalone = {};
        let tempPinMarkerStandalone = null;
        
        // ğŸ†• v5.90.204: 2-PIN WORKFLOW!
        let pickupPinStandalone = null;      // ğŸ“ Abholort (GRÃœN)
        let destinationPinStandalone = null; // ğŸ¯ Zielort (BLAU)
        let routeLineStandalone = null;      // ~~ Route
        let pickupData = null;               // { address, lat, lon }
        let destinationData = null;          // { address, lat, lon }
        
        function initFleetMapStandalone() {
            if (fleetMapStandaloneInitialized) {
                console.log('ğŸ—ºï¸ FahrzeugÃ¼bersicht bereits initialisiert - aktualisiere...');
                refreshFleetMapStandalone();
                return;
            }
            
            const mapContainer = document.getElementById('fleet-map-standalone');
            if (!mapContainer) {
                console.error('ğŸ’¾ fleet-map-standalone Container nicht gefunden!');
                return;
            }
            
            // Karte initialisieren
            fleetMapStandalone = L.map('fleet-map-standalone').setView([53.95, 14.05], 11);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap'
            }).addTo(fleetMapStandalone);
            
            // ğŸ†• v5.90.228: INTELLIGENTE PIN-LOGIK!
            fleetMapStandalone.on('click', async function(e) {
                const lat = e.latlng.lat;
                const lon = e.latlng.lng;
                
                console.log('ğŸ“ Karte geklickt:', lat, lon);
                
                // ğŸ†• v5.90.228: PrÃ¼fe pickupData (nicht nur Pin!)
                // Falls Kunde gewÃ¤hlt wurde â†’ pickupData ist aus CRM!
                
                // WENN noch kein Abholort (weder Pin noch Data) â†’ Setze Abholort
                if (!pickupPinStandalone && !pickupData) {
                    console.log('ğŸ“ Setze ABHOLORT (grÃ¼n) - noch keiner vorhanden');
                    await setPickupPin(lat, lon);
                }
                // WENN Abholort VORHANDEN (Pin ODER Data) + kein Zielort â†’ Setze Zielort
                else if ((pickupPinStandalone || pickupData) && !destinationPinStandalone && !destinationData) {
                    console.log('ğŸ¯ Setze ZIELORT (blau) - Abholort bereits da');
                    await setDestinationPin(lat, lon);
                }
                // WENN beide vorhanden â†’ Frage was geÃ¤ndert werden soll
                else {
                    console.log('âš ï¸ Beide Pins vorhanden - frage Nutzer');
                    
                    const choice = confirm('Abholort (OK) oder Zielort (Abbrechen) Ã¤ndern?');
                    
                    if (choice) {
                        console.log('ğŸ“ Ã„ndere ABHOLORT');
                        await setPickupPin(lat, lon);
                    } else {
                        console.log('ğŸ¯ Ã„ndere ZIELORT');
                        await setDestinationPin(lat, lon);
                    }
                }
            });
            
            fleetMapStandaloneInitialized = true;
            console.log('ğŸ—ºï¸ Standalone FahrzeugÃ¼bersicht initialisiert!');
            console.log('ğŸ“ 2-PIN Workflow aktiv: Erst Abholort, dann Zielort!');
            
            // ğŸ†• v5.90.203: Autocomplete initialisieren!
            initFleetSearchStandalone();
            
            // Erste Daten laden
            refreshFleetMapStandalone();
        }
        
        // ğŸ†• v5.90.204: ABHOLORT SETZEN (GRÃœNER PIN)
        async function setPickupPin(lat, lon) {
            console.log('ğŸ“ Setze Abholort:', lat, lon);
            
            // Entferne alten Abholort
            if (pickupPinStandalone) {
                fleetMapStandalone.removeLayer(pickupPinStandalone);
            }
            
            // Erstelle GRÃœNEN PIN
            pickupPinStandalone = L.marker([lat, lon], {
                icon: L.divIcon({
                    className: 'pickup-pin-marker',
                    html: `<div style="
                        background:#10b981;
                        color:white;
                        width:40px;
                        height:40px;
                        border-radius:50% 50% 50% 0;
                        transform:rotate(-45deg);
                        display:flex;
                        align-items:center;
                        justify-content:center;
                        border:3px solid white;
                        box-shadow:0 4px 12px rgba(16,185,129,0.5);
                        font-size:20px;
                    ">
                        <span style="transform:rotate(45deg);">ğŸ“</span>
                    </div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 40]
                }),
                draggable: true
            }).addTo(fleetMapStandalone);
            
            // Verschiebbar
            pickupPinStandalone.on('dragend', async function(event) {
                const newPos = event.target.getLatLng();
                await setPickupPin(newPos.lat, newPos.lng);
            });
            
            // Lade Adresse
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`
                );
                const data = await response.json();
                
                const address = data.address || {};
                let displayAddress = '';
                
                if (address.road) {
                    displayAddress = address.road;
                    if (address.house_number) displayAddress += ' ' + address.house_number;
                }
                if (address.postcode) displayAddress += ', ' + address.postcode;
                if (address.town || address.city) displayAddress += ' ' + (address.town || address.city);
                
                if (!displayAddress) displayAddress = data.display_name;
                
                // Speichere Daten
                pickupData = {
                    address: displayAddress,
                    lat: lat,
                    lon: lon
                };
                
                console.log('âœ… Abholort gesetzt:', displayAddress);
                
                // ğŸ†• v5.90.206: UPDATE FLOATING MODAL!
                updateFloatingBookingFromPins();
                
                // Popup
                pickupPinStandalone.bindPopup(`
                    <div style="padding:10px;min-width:200px;">
                        <div style="font-weight:700;font-size:14px;margin-bottom:8px;color:#10b981;">
                            ğŸ“ ABHOLORT
                        </div>
                        <div style="background:#f0fdf4;padding:8px;border-radius:4px;margin-bottom:10px;font-size:12px;border:2px solid #10b981;">
                            ${displayAddress}
                        </div>
                        <div style="font-size:11px;color:#6b7280;margin-bottom:10px;">
                            ğŸ“ ${lat.toFixed(5)}, ${lon.toFixed(5)}
                        </div>
                        <div style="font-size:12px;color:#059669;font-weight:600;text-align:center;padding:8px;background:#d1fae5;border-radius:4px;">
                            âœ… Jetzt Zielort auf Karte wÃ¤hlen!
                        </div>
                    </div>
                `).openPopup();
                
                // ğŸ†• v5.90.211: KLICK AUF PIN â†’ MODAL Ã–FFNEN!
                pickupPinStandalone.on('click', function() {
                    openFloatingQuickBookingFromPins();
                });
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der Adresse:', error);
                pickupData = {
                    address: `Position ${lat.toFixed(4)}, ${lon.toFixed(4)}`,
                    lat: lat,
                    lon: lon
                };
            }
        }
        
        // ğŸ†• v5.90.204: ZIELORT SETZEN (BLAUER PIN)
        async function setDestinationPin(lat, lon) {
            console.log('ğŸ¯ Setze Zielort:', lat, lon);
            
            // Entferne alten Zielort
            if (destinationPinStandalone) {
                fleetMapStandalone.removeLayer(destinationPinStandalone);
            }
            
            // Entferne alte Route
            if (routeLineStandalone) {
                fleetMapStandalone.removeLayer(routeLineStandalone);
            }
            
            // Erstelle BLAUEN PIN
            destinationPinStandalone = L.marker([lat, lon], {
                icon: L.divIcon({
                    className: 'destination-pin-marker',
                    html: `<div style="
                        background:#3b82f6;
                        color:white;
                        width:40px;
                        height:40px;
                        border-radius:50% 50% 50% 0;
                        transform:rotate(-45deg);
                        display:flex;
                        align-items:center;
                        justify-content:center;
                        border:3px solid white;
                        box-shadow:0 4px 12px rgba(59,130,246,0.5);
                        font-size:20px;
                    ">
                        <span style="transform:rotate(45deg);">ğŸ¯</span>
                    </div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 40]
                }),
                draggable: true
            }).addTo(fleetMapStandalone);
            
            // Verschiebbar
            destinationPinStandalone.on('dragend', async function(event) {
                const newPos = event.target.getLatLng();
                await setDestinationPin(newPos.lat, newPos.lng);
            });
            
            // Lade Adresse
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`
                );
                const data = await response.json();
                
                const address = data.address || {};
                let displayAddress = '';
                
                if (address.road) {
                    displayAddress = address.road;
                    if (address.house_number) displayAddress += ' ' + address.house_number;
                }
                if (address.postcode) displayAddress += ', ' + address.postcode;
                if (address.town || address.city) displayAddress += ' ' + (address.town || address.city);
                
                if (!displayAddress) displayAddress = data.display_name;
                
                // Speichere Daten
                destinationData = {
                    address: displayAddress,
                    lat: lat,
                    lon: lon
                };
                
                console.log('âœ… Zielort gesetzt:', displayAddress);
                
                // Zeichne Route
                if (pickupData) {
                    await drawRouteStandalone();
                }
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der Adresse:', error);
                destinationData = {
                    address: `Position ${lat.toFixed(4)}, ${lon.toFixed(4)}`,
                    lat: lat,
                    lon: lon
                };
            }
        }
        
        // ğŸ†• v5.90.204: ROUTE ZEICHNEN!
        async function drawRouteStandalone() {
            if (!pickupData || !destinationData) return;
            
            console.log('ğŸ—ºï¸ Zeichne Route...');
            
            try {
                const response = await fetch(
                    `https://router.project-osrm.org/route/v1/driving/${pickupData.lon},${pickupData.lat};${destinationData.lon},${destinationData.lat}?overview=full&geometries=geojson`
                );
                const data = await response.json();
                
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);
                    
                    // Zeichne Linie
                    routeLineStandalone = L.polyline(coords, {
                        color: '#3b82f6',
                        weight: 4,
                        opacity: 0.7
                    }).addTo(fleetMapStandalone);
                    
                    const distance = (route.distance / 1000).toFixed(1);
                    const duration = Math.round(route.duration / 60);
                    
                    console.log('âœ… Route gezeichnet:', distance, 'km,', duration, 'Min');
                    
                    // ğŸ†• v5.90.213: KORREKTE GESTAFFELTE PREISBERECHNUNG!
                    const distanceNum = parseFloat(distance);
                    const now = Date.now();
                    const calcTime = new Date(now);
                    const hour = calcTime.getHours();
                    const day = calcTime.getDay();
                    
                    // PrÃ¼fe Feiertag
                    const istFeiertag = isFeiertag(calcTime);
                    
                    // PrÃ¼fe ob Nachttarif (Mo-Sa 22-6 Uhr, Sonntag ganztÃ¤gig, ODER Feiertag!)
                    const isNight = (hour >= 22 || hour < 6) || (day === 0) || istFeiertag;
                    
                    // WÃ¤hle Tarif
                    const grundgebuehr = isNight ? TARIF.nacht_grundgebuehr : TARIF.grundgebuehr;
                    const km_1_2 = isNight ? TARIF.nacht_km_1_2 : TARIF.km_1_2;
                    const km_3_4 = isNight ? TARIF.nacht_km_3_4 : TARIF.km_3_4;
                    const km_ab_5 = isNight ? TARIF.nacht_km_ab_5 : TARIF.km_ab_5;
                    
                    // Gestaffelte Berechnung
                    let kmPreis = 0;
                    if (distanceNum <= 2) {
                        // 0-2 km: 3,30â‚¬ pro km
                        kmPreis = distanceNum * km_1_2;
                    } else if (distanceNum <= 4) {
                        // 2-4 km: erste 2 km Ã  3,30â‚¬ + Rest Ã  2,80â‚¬
                        kmPreis = (2 * km_1_2) + ((distanceNum - 2) * km_3_4);
                    } else {
                        // >4 km: erste 2 km Ã  3,30â‚¬ + nÃ¤chste 2 km Ã  2,80â‚¬ + Rest Ã  2,20â‚¬
                        kmPreis = (2 * km_1_2) + (2 * km_3_4) + ((distanceNum - 4) * km_ab_5);
                    }
                    
                    let price = grundgebuehr + kmPreis;
                    
                    // Tarif-Text fÃ¼r Anzeige
                    let surchargeText = '';
                    if (istFeiertag) {
                        surchargeText = ' ğŸ‰ Feiertag (Nachttarif)';
                    } else if (day === 0) {
                        surchargeText = ' (Sonntag - Nachttarif)';
                    } else if (isNight) {
                        surchargeText = ' (Nachttarif 22-6 Uhr)';
                    }
                    
                    // ğŸ’° SURGE PRICING ANWENDEN
                    const surge = getCurrentMultiplier();
                    let finalPrice = price * surge.factor;
                    
                    // Surge-Hinweis
                    if (surge.multiplier > 100) {
                        surchargeText += ` ğŸ“ˆ +${surge.multiplier - 100}% Nachfrage`;
                    } else if (surge.multiplier < 100) {
                        surchargeText += ` ğŸ‰ ${100 - surge.multiplier}% Rabatt`;
                    }
                    
                    // Runde auf 10 Cent
                    price = Math.round(finalPrice / 0.1) * 0.1;
                    
                    console.log('ğŸ’° KORREKTE Preisberechnung:');
                    console.log('   Distanz:', distanceNum, 'km');
                    console.log('   GrundgebÃ¼hr:', grundgebuehr, 'â‚¬');
                    console.log('   KM-Preis:', kmPreis.toFixed(2), 'â‚¬');
                    console.log('   Basis:', (grundgebuehr + kmPreis).toFixed(2), 'â‚¬');
                    console.log('   Surge:', surge.multiplier + '%');
                    console.log('   FINAL:', price.toFixed(2), 'â‚¬', surchargeText);
                    
                    // ğŸ†• v5.90.206: GLOBALE VARIABLEN FÃœR MODAL!
                    window.calculatedPrice = price;
                    window.calculatedTariffText = surchargeText;
                    
                    // ğŸ†• v5.90.206: SPEICHERE IN floatingBookingData!
                    floatingBookingData.distance = distance;
                    floatingBookingData.duration = duration;
                    floatingBookingData.price = price;
                    
                    // ğŸ†• v5.90.206: UPDATE FLOATING MODAL!
                    updateFloatingBookingFromPins();
                    
                    // Popup am Zielort
                    destinationPinStandalone.bindPopup(`
                        <div style="padding:10px;min-width:240px;">
                            <div style="font-weight:700;font-size:14px;margin-bottom:10px;color:#3b82f6;">
                                ğŸ¯ ZIELORT
                            </div>
                            
                            <div style="background:#eff6ff;padding:8px;border-radius:4px;margin-bottom:8px;font-size:12px;border:2px solid #3b82f6;">
                                ${destinationData.address}
                            </div>
                            
                            <div style="background:#f0fdf4;padding:8px;border-radius:4px;margin-bottom:8px;font-size:11px;border:1px solid #10b981;">
                                <strong>ğŸ“ Von:</strong> ${pickupData.address}
                            </div>
                            
                            <div style="display:flex;gap:8px;margin-bottom:10px;font-size:11px;">
                                <div style="flex:1;background:#f3f4f6;padding:6px;border-radius:4px;text-align:center;">
                                    ğŸ“ <strong>${distance} km</strong>
                                </div>
                                <div style="flex:1;background:#f3f4f6;padding:6px;border-radius:4px;text-align:center;">
                                    â±ï¸ <strong>${duration} Min</strong>
                                </div>
                            </div>
                            
                            <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:10px;border-radius:6px;text-align:center;margin-bottom:10px;font-weight:700;font-size:16px;box-shadow:0 2px 8px rgba(16,185,129,0.3);">
                                ğŸ’° ${price.toFixed(2)} â‚¬${surchargeText}
                            </div>
                            
                            <div style="display:flex;flex-direction:column;gap:6px;">
                                <button onclick="openFloatingQuickBookingFromPins()" 
                                    style="width:100%;padding:10px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:6px;font-weight:700;cursor:pointer;font-size:14px;box-shadow:0 4px 12px rgba(102,126,234,0.4);">
                                    ğŸš• JETZT BUCHEN
                                </button>
                                <button onclick="resetPinsStandalone()" 
                                    style="width:100%;padding:8px;background:#6b7280;color:white;border:none;border-radius:4px;font-weight:600;cursor:pointer;font-size:12px;">
                                    ğŸ”„ Neu starten
                                </button>
                            </div>
                        </div>
                    `).openPopup();
                    
                    // ğŸ†• v5.90.211: KLICK AUF PIN â†’ MODAL Ã–FFNEN!
                    destinationPinStandalone.on('click', function() {
                        openFloatingQuickBookingFromPins();
                    });
                    
                    // Zoom auf Route
                    fleetMapStandalone.fitBounds(routeLineStandalone.getBounds(), { padding: [50, 50] });
                }
                
            } catch (error) {
                console.error('ğŸ’¾ Route konnte nicht berechnet werden:', error);
            }
        }
        
        // ğŸ†• v5.90.204: PINS ZURÃœCKSETZEN!
        function resetPinsStandalone() {
            console.log('ğŸ”„ Setze Pins zurÃ¼ck');
            
            if (pickupPinStandalone) {
                fleetMapStandalone.removeLayer(pickupPinStandalone);
                pickupPinStandalone = null;
            }
            
            if (destinationPinStandalone) {
                fleetMapStandalone.removeLayer(destinationPinStandalone);
                destinationPinStandalone = null;
            }
            
            if (routeLineStandalone) {
                fleetMapStandalone.removeLayer(routeLineStandalone);
                routeLineStandalone = null;
            }
            
            pickupData = null;
            destinationData = null;
            
            console.log('âœ… Pins zurÃ¼ckgesetzt - bereit fÃ¼r neue Eingabe!');
        }
        
        // ğŸ†• v5.90.206: FLOATING QUICK BOOKING FUNKTIONEN!
        let floatingBookingData = {
            customerId: null,
            customerName: null,
            customerPhone: null,
            pickup: null,
            pickupCoords: null,
            destination: null,
            destCoords: null,
            price: null,
            distance: null,
            duration: null
        };
        
        // Modal Ã¶ffnen (z.B. aus CRM)
        function openFloatingQuickBooking(customerId, customerName, customerPhone) {
            console.log('ğŸ’³ Ã–ffne Floating Quick Booking:', customerName);
            
            const modal = document.getElementById('floating-quick-booking');
            modal.style.display = 'block';
            
            // Kunde vorausfÃ¼llen
            if (customerName && customerPhone) {
                document.getElementById('fqb-customer-search').value = customerName + ' (' + customerPhone + ')';
                document.getElementById('fqb-customer-info').innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:start;">
                        <div>
                            <strong style="color:#065f46;">âœ… ${customerName}</strong><br>
                            ğŸ“± ${customerPhone}
                        </div>
                        <button onclick="clearSelectedCustomer()" style="background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;font-size:11px;cursor:pointer;">ğŸ’¾</button>
                    </div>
                `;
                document.getElementById('fqb-customer-info').style.display = 'block';
                
                floatingBookingData.customerId = customerId;
                floatingBookingData.customerName = customerName;
                floatingBookingData.customerPhone = customerPhone;
                
                // ğŸ†• v5.90.216: LADE ABHOLORT AUS CRM (address ODER defaultPickup!)
                if (customerId) {
                    db.ref(`customers/${customerId}`).once('value', (snapshot) => {
                        const customer = snapshot.val();
                        if (customer) {
                            // PrÃ¼fe BEIDE Felder: defaultPickup (neu) ODER address (alt)
                            const pickupAddress = customer.defaultPickup || customer.address;
                            const pickupCoords = customer.defaultPickupCoords || customer.addressCoords || null;
                            
                            if (pickupAddress) {
                                // Abholort vorhanden!
                                document.getElementById('fqb-pickup-display').innerHTML = `
                                    <div style="display:flex;justify-content:space-between;align-items:start;">
                                        <strong>âœ… ${pickupAddress}</strong>
                                        <button onclick="clearPickupAddress()" style="background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;font-size:11px;cursor:pointer;">ğŸ’¾</button>
                                    </div>
                                `;
                                document.getElementById('fqb-pickup-display').style.background = '#f0fdf4';
                                document.getElementById('fqb-pickup-display').style.borderColor = '#10b981';
                                document.getElementById('fqb-pickup-display').style.color = '#065f46';
                                document.getElementById('fqb-pickup-clear').style.display = 'block';
                                
                                floatingBookingData.pickup = pickupAddress;
                                floatingBookingData.pickupCoords = pickupCoords;
                                
                                console.log('âœ… Abholort aus CRM geladen:', pickupAddress);
                                console.log('   Quelle:', customer.defaultPickup ? 'defaultPickup' : 'address');
                            } else {
                                console.log('â„¹ï¸ Kein Abholort im CRM gefunden (weder address noch defaultPickup)');
                            }
                        }
                    });
                }
            }
            
            // Datum auf heute
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const todayStr = `${yyyy}-${mm}-${dd}`;
            document.getElementById('fqb-date').value = todayStr;
            
            // Zeit auf jetzt (mit kleiner VerzÃ¶gerung fÃ¼r DOM)
            setTimeout(() => {
                setFQBTimeNow();
                console.log('â° Zeit-Felder initialisiert beim Ã–ffnen');
            }, 100);
            
            // Draggable initialisieren
            makeModalDraggable();
        }
        
        // ğŸ†• v5.90.211: MODAL Ã–FFNEN VON PINS (ohne Kunde)!
        async function openFloatingQuickBookingFromPins() {
            console.log('ğŸ’³ Ã–ffne Schnellbuchung von Pins...');
            
            // ğŸ†• v5.90.225: NUTZE NORMALES SCHNELLBUCHUNGS-MODAL!
            // Speichere Pin-Daten fÃ¼r Auto-Fill
            if (pickupData && destinationData) {
                // Setze globale Variablen fÃ¼r Autocomplete
                window.quickBookingPickupCoords = { lat: pickupData.lat, lon: pickupData.lon };
                window.quickBookingDestCoords = { lat: destinationData.lat, lon: destinationData.lon };
                
                console.log('ğŸ“ Pin-Daten gespeichert fÃ¼r Schnellbuchung');
                console.log('   Abholort:', pickupData.address);
                console.log('   Zielort:', destinationData.address);
            }
            
            // Ã–ffne normales Schnellbuchungs-Modal (OHNE prefilled customer)
            await openQuickBookingModal(null);
            
            // Nach Modal-Erstellung: FÃ¼lle Adressen ein!
            setTimeout(() => {
                if (pickupData) {
                    const pickupField = document.getElementById('quick-booking-pickup');
                    if (pickupField) {
                        pickupField.value = pickupData.address;
                        console.log('âœ… Abholort eingefÃ¼llt:', pickupData.address);
                    }
                }
                
                if (destinationData) {
                    const destField = document.getElementById('quick-booking-destination');
                    if (destField) {
                        destField.value = destinationData.address;
                        console.log('âœ… Zielort eingefÃ¼llt:', destinationData.address);
                    }
                }
                
                // Triggere Route-Berechnung wenn beide Felder gefÃ¼llt
                if (pickupData && destinationData) {
                    console.log('ğŸ—ºï¸ Berechne Route automatisch...');
                    // Auto-Berechnung triggern
                    const destField = document.getElementById('quick-booking-destination');
                    if (destField) {
                        // Triggere blur event um Route-Berechnung zu starten
                        const event = new Event('blur');
                        destField.dispatchEvent(event);
                    }
                }
            }, 100);
            
            console.log('âœ… Schnellbuchungs-Modal geÃ¶ffnet mit Pin-Daten!');
        }
        
        // ğŸ†• v5.90.222: FAHRZEUGE LADEN FÃœR FLOATING MODAL!
        async function loadFloatingBookingVehicles() {
            const select = document.getElementById('fqb-vehicle');
            if (!select) return;
            
            try {
                const snapshot = await db.ref('vehicles').once('value');
                select.innerHTML = '<option value="">Automatisch zuweisen</option>';
                
                snapshot.forEach(child => {
                    const vehicle = child.val();
                    const option = document.createElement('option');
                    option.value = child.key;
                    option.textContent = `${vehicle.kennzeichen || vehicle.name || child.key}`;
                    select.appendChild(option);
                });
                
                console.log('âœ… Fahrzeuge geladen fÃ¼r Floating Modal');
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der Fahrzeuge:', error);
            }
        }
        
        // Modal schlieÃŸen
        function closeFloatingQuickBooking() {
            document.getElementById('floating-quick-booking').style.display = 'none';
            console.log('ğŸ’¾ Floating Quick Booking geschlossen');
        }
        
        // Draggable machen
        function makeModalDraggable() {
            const modal = document.getElementById('floating-quick-booking');
            const header = document.getElementById('fqb-header');
            
            let isDragging = false;
            let startX, startY, startLeft, startTop;
            
            header.onmousedown = function(e) {
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                startLeft = modal.offsetLeft;
                startTop = modal.offsetTop;
                header.style.cursor = 'grabbing';
                e.preventDefault();
            };
            
            document.onmousemove = function(e) {
                if (!isDragging) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                modal.style.left = (startLeft + dx) + 'px';
                modal.style.top = (startTop + dy) + 'px';
                modal.style.right = 'auto'; // Remove right positioning
            };
            
            document.onmouseup = function() {
                isDragging = false;
                header.style.cursor = 'move';
            };
            
            console.log('âœ… Modal ist jetzt verschiebbar!');
        }
        
        // ğŸ†• v5.90.206: PINS â†’ AUTO-FILL INS MODAL!
        function updateFloatingBookingFromPins() {
            const modal = document.getElementById('floating-quick-booking');
            if (modal.style.display !== 'block') return; // Nur wenn Modal offen!
            
            console.log('ğŸ”„ Update Modal von Pins...');
            
            // Abholort
            if (pickupData) {
                document.getElementById('fqb-pickup-display').innerHTML = `
                    <strong>âœ… ${pickupData.address}</strong>
                `;
                document.getElementById('fqb-pickup-display').style.background = '#f0fdf4';
                document.getElementById('fqb-pickup-display').style.borderColor = '#10b981';
                document.getElementById('fqb-pickup-display').style.color = '#065f46';
                document.getElementById('fqb-pickup-clear').style.display = 'block'; // ğŸ’¾ Button zeigen!
                
                floatingBookingData.pickup = pickupData.address;
                floatingBookingData.pickupCoords = { lat: pickupData.lat, lon: pickupData.lon };
            }
            
            // Zielort
            if (destinationData) {
                document.getElementById('fqb-destination-display').innerHTML = `
                    <strong>âœ… ${destinationData.address}</strong>
                `;
                document.getElementById('fqb-destination-display').style.background = '#eff6ff';
                document.getElementById('fqb-destination-display').style.borderColor = '#3b82f6';
                document.getElementById('fqb-destination-display').style.color = '#1e40af';
                document.getElementById('fqb-destination-clear').style.display = 'block'; // ğŸ’¾ Button zeigen!
                
                floatingBookingData.destination = destinationData.address;
                floatingBookingData.destCoords = { lat: destinationData.lat, lon: destinationData.lon };
            }
            
            // Distanz + Zeit + Preis (wenn beide Pins gesetzt)
            if (pickupData && destinationData && calculatedPrice) {
                // Distanz + Zeit
                document.getElementById('fqb-route-info').style.display = 'flex';
                document.getElementById('fqb-distance').textContent = floatingBookingData.distance || '-';
                document.getElementById('fqb-duration').textContent = floatingBookingData.duration || '-';
                
                // Preis
                const tariffText = calculatedTariffText || '';
                document.getElementById('fqb-price-display').innerHTML = `
                    ${calculatedPrice.toFixed(2)} â‚¬ ${tariffText}
                `;
                
                floatingBookingData.price = calculatedPrice;
            }
            
            console.log('âœ… Modal aktualisiert!', floatingBookingData);
        }
        
        // Zeit: JETZT
        function setTimeNow() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('fqb-time').value = `${hours}:${minutes}`;
        }
        
        // Zeit: +30 Minuten
        function setTimePlus30() {
            const now = new Date();
            now.setMinutes(now.getMinutes() + 30);
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('fqb-time').value = `${hours}:${minutes}`;
        }
        
        // ğŸ†• v5.90.208: LIVE-SUCHE FÃœR KUNDEN!
        let customerSearchTimeout = null;
        async function liveSearchCustomers() {
            const searchTerm = document.getElementById('fqb-customer-search').value.trim().toLowerCase();
            const dropdown = document.getElementById('fqb-customer-dropdown');
            
            // Timeout fÃ¼r Performance (warten bis Tippen fertig)
            if (customerSearchTimeout) clearTimeout(customerSearchTimeout);
            
            if (searchTerm.length < 2) {
                dropdown.style.display = 'none';
                return;
            }
            
            customerSearchTimeout = setTimeout(async () => {
                console.log('ğŸ” Suche Kunden:', searchTerm);
                
                // Hole alle Kunden
                const snapshot = await db.ref('customers').once('value');
                const customers = [];
                
                snapshot.forEach((childSnapshot) => {
                    const customer = childSnapshot.val();
                    const customerId = childSnapshot.key;
                    
                    // Suche in Name UND Telefon
                    const nameMatch = (customer.name || '').toLowerCase().includes(searchTerm);
                    const phoneMatch = (customer.phone || '').toLowerCase().includes(searchTerm);
                    
                    if (nameMatch || phoneMatch) {
                        // ğŸ†• v5.90.216: Nutze address ODER defaultPickup!
                        const pickupAddress = customer.defaultPickup || customer.address || null;
                        const pickupCoords = customer.defaultPickupCoords || customer.addressCoords || null;
                        
                        customers.push({
                            id: customerId,
                            name: customer.name || 'Unbekannt',
                            phone: customer.phone || '',
                            defaultPickup: pickupAddress,
                            defaultPickupCoords: pickupCoords
                        });
                    }
                });
                
                // Zeige Ergebnisse
                if (customers.length === 0) {
                    dropdown.innerHTML = `
                        <div style="padding:10px;text-align:center;color:#6b7280;font-size:13px;">
                            ğŸ’¾ Keine Kunden gefunden
                        </div>
                        <button onclick="createNewCustomerQuick('${searchTerm}')" style="width:100%;padding:10px;background:#10b981;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;margin:5px 0;">
                            â• Neuer Kunde
                        </button>
                    `;
                } else {
                    dropdown.innerHTML = customers.map(customer => `
                        <div onclick="selectCustomerFromDropdown('${customer.id}', '${customer.name.replace(/'/g, "\\'")}', '${customer.phone}', '${customer.defaultPickup || ''}', '${JSON.stringify(customer.defaultPickupCoords || null).replace(/'/g, "\\'")})" 
                            style="padding:10px;border-bottom:1px solid #e5e7eb;cursor:pointer;font-size:13px;"
                            onmouseover="this.style.background='#f3f4f6'"
                            onmouseout="this.style.background='white'">
                            <div style="font-weight:600;color:#111827;">${customer.name}</div>
                            <div style="font-size:12px;color:#6b7280;">ğŸ“± ${customer.phone}</div>
                            ${customer.defaultPickup ? `<div style="font-size:11px;color:#10b981;margin-top:2px;">ğŸ“ ${customer.defaultPickup}</div>` : ''}
                        </div>
                    `).join('');
                }
                
                dropdown.style.display = 'block';
                console.log(`âœ… ${customers.length} Kunden gefunden`);
                
            }, 300); // 300ms VerzÃ¶gerung
        }
        
        // ğŸ†• v5.90.208: KUNDE AUS DROPDOWN AUSWÃ„HLEN!
        function selectCustomerFromDropdown(customerId, customerName, customerPhone, defaultPickup, defaultPickupCoordsStr) {
            console.log('âœ… Kunde ausgewÃ¤hlt:', customerName);
            
            try {
                // SchlieÃŸe Dropdown
                const dropdown = document.getElementById('fqb-customer-dropdown');
                if (dropdown) {
                    dropdown.style.display = 'none';
                } else {
                    console.warn('âš ï¸ fqb-customer-dropdown nicht gefunden!');
                }
                
                // FÃ¼lle Suchfeld
                const searchField = document.getElementById('fqb-customer-search');
                if (searchField) {
                    searchField.value = customerName + ' (' + customerPhone + ')';
                } else {
                    console.warn('âš ï¸ fqb-customer-search nicht gefunden!');
                }
                
                // Zeige Kunde-Info
                const customerInfo = document.getElementById('fqb-customer-info');
                if (customerInfo) {
                    customerInfo.innerHTML = `
                        <div style="display:flex;justify-content:space-between;align-items:start;">
                            <div>
                                <strong style="color:#065f46;">âœ… ${customerName}</strong><br>
                                ğŸ“± ${customerPhone}
                            </div>
                            <button onclick="clearSelectedCustomer()" style="background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;font-size:11px;cursor:pointer;">ğŸ’¾</button>
                        </div>
                    `;
                    customerInfo.style.display = 'block';
                    console.log('âœ… fqb-customer-info angezeigt fÃ¼r:', customerName);
                } else {
                    console.error('ğŸ’¾ fqb-customer-info Element NICHT gefunden!');
                }
                
                // Hide new customer button
                const newCustomerBtn = document.getElementById('fqb-new-customer-btn');
                if (newCustomerBtn) {
                    newCustomerBtn.style.display = 'none';
                }
                
                // Speichere Daten
                floatingBookingData.customerId = customerId;
                floatingBookingData.customerName = customerName;
                floatingBookingData.customerPhone = customerPhone;
                
                console.log('âœ… Kunde gespeichert in floatingBookingData');
                
            } catch (error) {
                console.error('ğŸ’¾ FEHLER in selectCustomerFromDropdown:', error);
            }
            
            // ğŸ†• v5.90.208: ABHOLORT AUS CRM LADEN!
            if (defaultPickup && defaultPickup !== 'null' && defaultPickup !== '') {
                let coords = null;
                try {
                    coords = JSON.parse(defaultPickupCoordsStr);
                } catch(e) {}
                
                document.getElementById('fqb-pickup-display').innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:start;">
                        <strong>âœ… ${defaultPickup}</strong>
                        <button onclick="clearPickupAddress()" style="background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;font-size:11px;cursor:pointer;">ğŸ’¾</button>
                    </div>
                `;
                document.getElementById('fqb-pickup-display').style.background = '#f0fdf4';
                document.getElementById('fqb-pickup-display').style.borderColor = '#10b981';
                
                floatingBookingData.pickup = defaultPickup;
                floatingBookingData.pickupCoords = coords;
                
                // ğŸ†• v5.90.228: SETZE AUCH pickupData fÃ¼r Karten-Logik!
                if (coords && coords.lat && coords.lon) {
                    pickupData = {
                        address: defaultPickup,
                        lat: coords.lat,
                        lon: coords.lon
                    };
                    console.log('âœ… pickupData gesetzt fÃ¼r Karten-Logik:', pickupData);
                    
                    // ğŸ†• v5.90.228: ZEIGE GRÃœNEN PIN AUF KARTE!
                    if (fleetMapStandalone && !pickupPinStandalone) {
                        setPickupPin(coords.lat, coords.lon);
                    }
                }
                
                console.log('âœ… Abholort aus CRM geladen:', defaultPickup);
            }
        }
        
        // Kunde lÃ¶schen
        function clearSelectedCustomer() {
            document.getElementById('fqb-customer-search').value = '';
            document.getElementById('fqb-customer-info').style.display = 'none';
            document.getElementById('fqb-customer-dropdown').style.display = 'none';
            
            floatingBookingData.customerId = null;
            floatingBookingData.customerName = null;
            floatingBookingData.customerPhone = null;
            
            console.log('ğŸ’¾ Kunde gelÃ¶scht');
        }
        
        // Abholort lÃ¶schen
        function clearPickupAddress() {
            document.getElementById('fqb-pickup-display').innerHTML = 'Warte auf Karte...';
            document.getElementById('fqb-pickup-display').style.background = '#f9fafb';
            document.getElementById('fqb-pickup-display').style.borderColor = '#e5e7eb';
            document.getElementById('fqb-pickup-display').style.color = '#6b7280';
            document.getElementById('fqb-pickup-clear').style.display = 'none';
            
            floatingBookingData.pickup = null;
            floatingBookingData.pickupCoords = null;
            
            // ğŸ†• v5.90.228: LÃ–SCHE AUCH pickupData UND PIN!
            pickupData = null;
            if (pickupPinStandalone && fleetMapStandalone) {
                fleetMapStandalone.removeLayer(pickupPinStandalone);
                pickupPinStandalone = null;
            }
            
            console.log('ğŸ’¾ Abholort gelÃ¶scht (inkl. Pin)');
        }
        
        // ğŸ†• v5.90.210: ZIELORT LÃ–SCHEN!
        function clearDestinationAddress() {
            document.getElementById('fqb-destination-display').innerHTML = 'Warte auf Karte...';
            document.getElementById('fqb-destination-display').style.background = '#f9fafb';
            document.getElementById('fqb-destination-display').style.borderColor = '#e5e7eb';
            document.getElementById('fqb-destination-display').style.color = '#6b7280';
            document.getElementById('fqb-destination-clear').style.display = 'none';
            
            floatingBookingData.destination = null;
            floatingBookingData.destCoords = null;
            floatingBookingData.price = null;
            floatingBookingData.distance = null;
            floatingBookingData.duration = null;
            
            // ğŸ†• v5.90.228: LÃ–SCHE AUCH destinationData UND PIN!
            destinationData = null;
            if (destinationPinStandalone && fleetMapStandalone) {
                fleetMapStandalone.removeLayer(destinationPinStandalone);
                destinationPinStandalone = null;
            }
            
            // LÃ¶sche Route
            if (routeLineStandalone && fleetMapStandalone) {
                fleetMapStandalone.removeLayer(routeLineStandalone);
                routeLineStandalone = null;
            }
            
            // Preis zurÃ¼cksetzen
            document.getElementById('fqb-price-display').innerHTML = '-,-- â‚¬';
            document.getElementById('fqb-route-info').style.display = 'none';
            
            console.log('ğŸ’¾ Zielort gelÃ¶scht (inkl. Pin + Route)');
        }
        
        // ğŸ†• v5.90.210: ADRESSEN TAUSCHEN!
        function swapAddresses() {
            console.log('ğŸ”„ Tausche Adressen...');
            
            if (!floatingBookingData.pickup || !floatingBookingData.destination) {
                alert('âš ï¸ Beide Adressen mÃ¼ssen gesetzt sein!');
                return;
            }
            
            // Speichere alte Werte
            const tempPickup = floatingBookingData.pickup;
            const tempPickupCoords = floatingBookingData.pickupCoords;
            
            // Tausche
            floatingBookingData.pickup = floatingBookingData.destination;
            floatingBookingData.pickupCoords = floatingBookingData.destCoords;
            floatingBookingData.destination = tempPickup;
            floatingBookingData.destCoords = tempPickupCoords;
            
            // Update UI
            document.getElementById('fqb-pickup-display').innerHTML = `
                <strong>âœ… ${floatingBookingData.pickup}</strong>
            `;
            document.getElementById('fqb-pickup-display').style.background = '#f0fdf4';
            document.getElementById('fqb-pickup-display').style.borderColor = '#10b981';
            document.getElementById('fqb-pickup-display').style.color = '#065f46';
            document.getElementById('fqb-pickup-clear').style.display = 'block';
            
            document.getElementById('fqb-destination-display').innerHTML = `
                <strong>âœ… ${floatingBookingData.destination}</strong>
            `;
            document.getElementById('fqb-destination-display').style.background = '#eff6ff';
            document.getElementById('fqb-destination-display').style.borderColor = '#3b82f6';
            document.getElementById('fqb-destination-display').style.color = '#1e40af';
            document.getElementById('fqb-destination-clear').style.display = 'block';
            
            console.log('âœ… Adressen getauscht!');
            alert('âœ… Adressen getauscht!');
        }
        
        // ğŸ†• v5.90.210: ZEIT-FUNKTIONEN FÃœR MODAL!
        function setFQBTimeNow() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const hoursField = document.getElementById('fqb-time-hours');
            const minutesField = document.getElementById('fqb-time-minutes');
            
            // FORCE: Erst leeren, dann neu setzen!
            if (hoursField) {
                hoursField.value = '';  // Leeren
                hoursField.value = String(hours).padStart(2, '0');  // Neu setzen
            }
            if (minutesField) {
                minutesField.value = '';  // Leeren
                minutesField.value = String(minutes).padStart(2, '0');  // Neu setzen
            }
            
            console.log('ğŸ• Zeit FORCE gesetzt:', String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0'));
        }
        
        function setFQBTimePlus30() {
            const now = new Date();
            now.setMinutes(now.getMinutes() + 30);
            const hours = now.getHours();
            const minutes = now.getMinutes();
            document.getElementById('fqb-time-hours').value = String(hours).padStart(2, '0');
            document.getElementById('fqb-time-minutes').value = String(minutes).padStart(2, '0');
        }
        
        // Neuer Kunde schnell anlegen
        async function createNewCustomerQuick(searchTerm) {
            const name = prompt('Name des neuen Kunden:', searchTerm || '');
            if (!name) return;
            
            const phone = prompt('Telefonnummer:');
            if (!phone) return;
            
            const customerId = 'cust_' + Date.now();
            const customer = {
                name: name,
                phone: phone,
                createdAt: Date.now(),
                source: 'floating-quick-booking'
            };
            
            await db.ref(`customers/${customerId}`).set(customer);
            
            alert('âœ… Kunde angelegt: ' + name);
            
            // AuswÃ¤hlen
            selectCustomerFromDropdown(customerId, name, phone, null, null);
        }
        
        // Kunde suchen
        async function searchCustomerForBooking() {
            const phone = document.getElementById('fqb-customer-phone').value.trim();
            if (!phone) {
                alert('Bitte Telefonnummer eingeben!');
                return;
            }
            
            console.log('ğŸ” Suche Kunde:', phone);
            
            // Suche in /customers
            const snapshot = await db.ref('customers').orderByChild('phone').equalTo(phone).once('value');
            const customers = snapshot.val();
            
            if (customers) {
                const customerId = Object.keys(customers)[0];
                const customer = customers[customerId];
                
                document.getElementById('fqb-customer-info').innerHTML = `
                    <strong style="color:#065f46;">âœ… ${customer.name}</strong><br>
                    ğŸ“± ${customer.phone}
                `;
                document.getElementById('fqb-customer-info').style.display = 'block';
                document.getElementById('fqb-new-customer-btn').style.display = 'none';
                
                floatingBookingData.customerId = customerId;
                floatingBookingData.customerName = customer.name;
                floatingBookingData.customerPhone = customer.phone;
                
                // ğŸ†• v5.90.208: LADE ABHOLORT!
                if (customer.defaultPickup) {
                    document.getElementById('fqb-pickup-display').innerHTML = `
                        <strong>âœ… ${customer.defaultPickup}</strong>
                        <button onclick="clearPickupAddress()" style="float:right;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;font-size:11px;cursor:pointer;">ğŸ’¾</button>
                    `;
                    document.getElementById('fqb-pickup-display').style.background = '#f0fdf4';
                    document.getElementById('fqb-pickup-display').style.borderColor = '#10b981';
                    
                    floatingBookingData.pickup = customer.defaultPickup;
                    floatingBookingData.pickupCoords = customer.defaultPickupCoords || null;
                    
                    console.log('âœ… Abholort aus CRM geladen:', customer.defaultPickup);
                }
                
                console.log('âœ… Kunde gefunden:', customer.name);
            } else {
                document.getElementById('fqb-customer-info').style.display = 'none';
                document.getElementById('fqb-new-customer-btn').style.display = 'block';
                console.log('ğŸ’¾ Kunde nicht gefunden');
            }
        }
        
        // Neuer Kunde
        function createNewCustomerInBooking() {
            const phone = document.getElementById('fqb-customer-phone').value.trim();
            const name = prompt('Name des neuen Kunden:');
            
            if (!name) return;
            
            const customerId = 'cust_' + Date.now();
            const customer = {
                name: name,
                phone: phone,
                createdAt: Date.now(),
                source: 'floating-quick-booking'
            };
            
            db.ref(`customers/${customerId}`).set(customer).then(() => {
                alert('âœ… Kunde angelegt: ' + name);
                
                document.getElementById('fqb-customer-info').innerHTML = `
                    <strong style="color:#065f46;">âœ… ${name}</strong><br>
                    ğŸ“± ${phone}
                `;
                document.getElementById('fqb-customer-info').style.display = 'block';
                document.getElementById('fqb-new-customer-btn').style.display = 'none';
                
                floatingBookingData.customerId = customerId;
                floatingBookingData.customerName = name;
                floatingBookingData.customerPhone = phone;
            });
        }
        
        // ğŸ†• v5.90.208: LIVE KUNDEN-SUCHE IM MODAL!
        // ğŸ†• v5.90.209: LIVE SUCHE (nutzt customerSearchTimeout von oben!)
        async function liveSearchCustomers() {
            clearTimeout(customerSearchTimeout);
            
            const search = document.getElementById('fqb-customer-search').value.trim().toLowerCase();
            const dropdown = document.getElementById('fqb-customer-dropdown');
            
            if (search.length < 2) {
                dropdown.style.display = 'none';
                return;
            }
            
            customerSearchTimeout = setTimeout(async () => {
                console.log('ğŸ” Suche Kunden:', search);
                
                const snapshot = await db.ref('customers').once('value');
                const customers = [];
                
                snapshot.forEach((child) => {
                    const customer = child.val();
                    const name = (customer.name || '').toLowerCase();
                    const phone = (customer.phone || '').toLowerCase();
                    
                    if (name.includes(search) || phone.includes(search)) {
                        customers.push({
                            id: child.key,
                            ...customer
                        });
                    }
                });
                
                if (customers.length === 0) {
                    dropdown.innerHTML = '<div style="padding:10px;text-align:center;color:#6b7280;">Kein Kunde gefunden</div>';
                    dropdown.style.display = 'block';
                    return;
                }
                
                dropdown.innerHTML = customers.slice(0, 10).map(customer => `
                    <div onclick="selectCustomerFromDropdown('${customer.id}', '${customer.name}', '${customer.phone}')" style="padding:10px;border-bottom:1px solid #e5e7eb;cursor:pointer;transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                        <div style="font-weight:600;color:#111827;">${customer.name}</div>
                        <div style="font-size:12px;color:#6b7280;">ğŸ“± ${customer.phone}</div>
                    </div>
                `).join('');
                
                dropdown.style.display = 'block';
                
            }, 300);
        }
        
        async function selectCustomerFromDropdown(customerId, customerName, customerPhone) {
            console.log('âœ… Kunde ausgewÃ¤hlt:', customerName);
            
            // SchlieÃŸe Dropdown
            document.getElementById('fqb-customer-dropdown').style.display = 'none';
            document.getElementById('fqb-customer-search').value = `${customerName} - ${customerPhone}`;
            
            // Setze Daten
            floatingBookingData.customerId = customerId;
            floatingBookingData.customerName = customerName;
            floatingBookingData.customerPhone = customerPhone;
            
            // Lade Kundendaten (inklusive Abholort!)
            const snapshot = await db.ref(`customers/${customerId}`).once('value');
            const customer = snapshot.val();
            
            if (customer && customer.defaultPickup) {
                document.getElementById('fqb-pickup-display').innerHTML = `
                    <strong>âœ… ${customer.defaultPickup}</strong>
                    <button onclick="clearPickupAddress()" style="float:right;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;font-size:11px;cursor:pointer;">ğŸ’¾</button>
                `;
                document.getElementById('fqb-pickup-display').style.background = '#f0fdf4';
                document.getElementById('fqb-pickup-display').style.borderColor = '#10b981';
                
                floatingBookingData.pickup = customer.defaultPickup;
                floatingBookingData.pickupCoords = customer.defaultPickupCoords || null;
                
                console.log('âœ… Abholort aus CRM geladen:', customer.defaultPickup);
            }
        }
        
        // ğŸ†• v5.90.208: ADRESSEN LÃ–SCHEN!
        function clearPickupAddress() {
            document.getElementById('fqb-pickup-display').innerHTML = 'Warte auf Karte...';
            document.getElementById('fqb-pickup-display').style.background = '#f9fafb';
            document.getElementById('fqb-pickup-display').style.borderColor = '#e5e7eb';
            
            floatingBookingData.pickup = null;
            floatingBookingData.pickupCoords = null;
            
            console.log('ğŸ’¾ Abholort gelÃ¶scht');
        }
        
        function clearDestinationAddress() {
            document.getElementById('fqb-destination-display').innerHTML = 'Warte auf Karte...';
            document.getElementById('fqb-destination-display').style.background = '#f9fafb';
            document.getElementById('fqb-destination-display').style.borderColor = '#e5e7eb';
            
            floatingBookingData.destination = null;
            floatingBookingData.destCoords = null;
            
            // Preis zurÃ¼cksetzen
            document.getElementById('fqb-price-display').innerHTML = '-,-- â‚¬';
            document.getElementById('fqb-route-info').style.display = 'none';
            
            floatingBookingData.price = null;
            floatingBookingData.distance = null;
            floatingBookingData.duration = null;
            
            console.log('ğŸ’¾ Zielort gelÃ¶scht');
        }
        
        // ğŸ†• v5.90.215: BUCHUNG ABSCHICKEN (MIT ALLEN FEATURES VOM SCHNELLBUCHUNGS-MODAL!)
        async function submitFloatingQuickBooking() {
            console.log('ğŸš• Erstelle Buchung...', floatingBookingData);
            
            // ğŸ”’ DOPPELKLICK-SCHUTZ!
            if (window.isSubmittingFloatingBooking) {
                console.log('âš ï¸ Submit bereits in Bearbeitung - ignoriere Klick');
                return;
            }
            
            window.isSubmittingFloatingBooking = true;
            console.log('ğŸ”’ Submit gesperrt (Doppelklick-Schutz)');
            
            try {
                // Validierung
                if (!floatingBookingData.customerName || !floatingBookingData.customerPhone) {
                    alert('ğŸ’¾ Bitte Kunde eingeben!');
                    window.isSubmittingFloatingBooking = false;
                    return;
                }
                
                if (!floatingBookingData.pickup || !floatingBookingData.destination) {
                    alert('ğŸ’¾ Bitte Pins auf Karte setzen!');
                    window.isSubmittingFloatingBooking = false;
                    return;
                }
                
                const date = document.getElementById('fqb-date').value;
                const hours = document.getElementById('fqb-time-hours').value;
                const minutes = document.getElementById('fqb-time-minutes').value;
                const notes = document.getElementById('fqb-notes').value;
                
                if (!date || !hours || !minutes) {
                    alert('ğŸ’¾ Bitte Datum und Zeit eingeben!');
                    window.isSubmittingFloatingBooking = false;
                    return;
                }
                
                // Timestamp erstellen
                const timeString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                const datetime = `${date}T${timeString}`;
                const scheduledTime = new Date(datetime).getTime();
                
                // ğŸ†• v5.90.215: AUTO-GEOCODE WENN COORDS FEHLEN!
                if (!floatingBookingData.pickupCoords || !floatingBookingData.destCoords) {
                    console.log('âš ï¸ Koordinaten fehlen - versuche Auto-Geocode...');
                    
                    const tasks = [];
                    if (!floatingBookingData.pickupCoords && floatingBookingData.pickup) {
                        tasks.push(
                            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(floatingBookingData.pickup)}&countrycodes=de&viewbox=10.6,54.7,14.4,53.1&bounded=1&limit=1`)
                                .then(r => r.json())
                                .then(results => {
                                    if (results.length > 0) {
                                        floatingBookingData.pickupCoords = { lat: parseFloat(results[0].lat), lon: parseFloat(results[0].lon) };
                                        console.log('âœ… Abholort geocoded:', floatingBookingData.pickupCoords);
                                    }
                                })
                        );
                    }
                    if (!floatingBookingData.destCoords && floatingBookingData.destination) {
                        tasks.push(
                            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(floatingBookingData.destination)}&countrycodes=de&viewbox=10.6,54.7,14.4,53.1&bounded=1&limit=1`)
                                .then(r => r.json())
                                .then(results => {
                                    if (results.length > 0) {
                                        floatingBookingData.destCoords = { lat: parseFloat(results[0].lat), lon: parseFloat(results[0].lon) };
                                        console.log('âœ… Zielort geocoded:', floatingBookingData.destCoords);
                                    }
                                })
                        );
                    }
                    
                    if (tasks.length > 0) {
                        const toast = document.createElement('div');
                        toast.style.cssText = 'position:fixed;top:20px;right:20px;background:#3b82f6;color:white;padding:15px 20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:99999;font-weight:600;';
                        toast.innerHTML = 'ğŸ—ºï¸ Suche Koordinaten...';
                        document.body.appendChild(toast);
                        
                        await Promise.all(tasks);
                        toast.remove();
                    }
                    
                    // PrÃ¼fe erneut
                    if (!floatingBookingData.pickupCoords || !floatingBookingData.destCoords) {
                        alert('ğŸ’¾ Koordinaten konnten nicht gefunden werden!');
                        window.isSubmittingFloatingBooking = false;
                        return;
                    }
                }
                
                // ğŸ†• v5.90.215: BERECHNE ROUTE + PREIS (falls noch nicht berechnet!)
                let routeData = {
                    distance: floatingBookingData.distance,
                    duration: floatingBookingData.duration,
                    price: floatingBookingData.price
                };
                
                if (!routeData.price || !routeData.distance) {
                    console.log('ğŸ’° Berechne Route + Preis...');
                    try {
                        routeData = await calculateRoute(floatingBookingData.pickupCoords, floatingBookingData.destCoords);
                        console.log('âœ… Route berechnet:', routeData);
                        
                        // Preis berechnen
                        const pickupTimestamp = scheduledTime;
                        const pricing = calculatePrice(parseFloat(routeData.distance), pickupTimestamp);
                        // ğŸ†• v5.90.220: RUNDE PREIS um Floating Point Fehler zu vermeiden!
                        routeData.price = Math.round(parseFloat(pricing.total) * 100) / 100;
                        console.log('âœ… Preis berechnet:', routeData.price, 'â‚¬');
                        
                        // Validierung
                        if (!routeData.price || routeData.price <= 0 || isNaN(routeData.price)) {
                            console.error('ğŸ’¾ KRITISCHER FEHLER: UngÃ¼ltiger Preis!', routeData.price);
                            alert('ğŸ’¾ FEHLER: Preis konnte nicht berechnet werden!');
                            window.isSubmittingFloatingBooking = false;
                            return;
                        }
                    } catch (err) {
                        console.error('ğŸ’¾ Fehler beim Berechnen der Route:', err);
                        alert('ğŸ’¾ Fehler beim Berechnen der Route: ' + err.message);
                        window.isSubmittingFloatingBooking = false;
                        return;
                    }
                }
                
                // ğŸ†• v5.90.215: SUCHE userId (wie im Schnellbuchungs-Modal!)
                let userId = null;
                try {
                    userId = await findUserIdForCustomer(floatingBookingData.customerName, floatingBookingData.customerPhone);
                    console.log('âœ… userId gefunden:', userId);
                } catch (err) {
                    console.log('â„¹ï¸ Kein userId gefunden (nicht schlimm)');
                }
                
                // Buchung erstellen
                const rideId = 'ride_' + Date.now();
                const ride = {
                    customerId: floatingBookingData.customerId,
                    customerName: floatingBookingData.customerName,
                    customerPhone: floatingBookingData.customerPhone,
                    userId: userId, // ğŸ†• userId!
                    
                    pickup: floatingBookingData.pickup,
                    pickupCoords: floatingBookingData.pickupCoords,
                    
                    destination: floatingBookingData.destination,
                    destCoords: floatingBookingData.destCoords,
                    
                    // ğŸ†• v5.90.220: RUNDE PREISE korrekt!
                    price: Math.round(parseFloat(routeData.price) * 100) / 100 || 0,
                    calculatedPrice: Math.round(parseFloat(routeData.price) * 100) / 100 || 0,
                    distance: routeData.distance || '0',
                    duration: routeData.duration || '0',
                    
                    scheduledTime: scheduledTime,
                    pickupTimestamp: scheduledTime, // ğŸ†• v5.90.217: FÃ¼r Kalender-Sortierung!
                    status: 'new', // ğŸ†• v5.90.217: 'new' statt 'pending' fÃ¼r Kalender!
                    
                    notes: notes || '',
                    
                    // ğŸ†• v5.90.222: Personen aus Formular!
                    passengers: parseInt(document.getElementById('fqb-passengers')?.value || 1),
                    
                    // ğŸ†• v5.90.222: Fahrzeug aus Formular!
                    vehicleId: document.getElementById('fqb-vehicle')?.value || null,
                    vehicle: null, // Wird spÃ¤ter gefÃ¼llt wenn vehicleId gesetzt
                    
                    timestamp: Date.now(),
                    createdAt: Date.now(),
                    createdBy: currentUser.uid,
                    source: 'floating-quick-booking'
                };
                
                try {
                    await db.ref(`rides/${rideId}`).set(ride);
                    
                    console.log('âœ… Buchung erfolgreich erstellt:', rideId);
                    
                    // ğŸ†• v5.90.221: TELEGRAM AN ADMIN!
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    console.log('ğŸ“± TELEGRAM: Sende Benachrichtigung...');
                    
                    try {
                        const rideForTelegram = {
                            firebaseId: rideId,
                            id: rideId,
                            ...ride
                        };
                        
                        await sendTelegramForNewRide(rideForTelegram);
                        console.log('âœ… TELEGRAM: Benachrichtigung gesendet!');
                    } catch (telegramError) {
                        console.error('ğŸ’¾ TELEGRAM-Fehler:', telegramError);
                    }
                    
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    
                    alert(`âœ… Buchung erstellt!\n\n${floatingBookingData.customerName}\n${floatingBookingData.pickup} â†’ ${floatingBookingData.destination}\n\nğŸ’° ${parseFloat(routeData.price).toFixed(2)} â‚¬`);
                    
                    // ğŸ†• v5.90.221: UPDATE VIEWS (wie Schnellbuchen)!
                    updateViews();
                    console.log('âœ… Views aktualisiert!');
                    
                    // ğŸ†• v5.90.218: KALENDER AUTO-RELOAD!
                    if (typeof renderCalendar === 'function') {
                        console.log('ğŸ”„ Lade Kalender neu...');
                        setTimeout(() => {
                            renderCalendar();
                            console.log('âœ… Kalender aktualisiert!');
                        }, 500);
                    }
                    
                    // Modal schlieÃŸen
                    closeFloatingQuickBooking();
                    
                    // Pins zurÃ¼cksetzen
                    resetPinsStandalone();
                    
                    // floatingBookingData zurÃ¼cksetzen
                    floatingBookingData = {
                        customerId: null,
                        customerName: null,
                        customerPhone: null,
                        pickup: null,
                        pickupCoords: null,
                        destination: null,
                        destCoords: null,
                        price: null,
                        distance: null,
                        duration: null
                    };
                    
                    console.log('âœ… Buchung erfolgreich erstellt:', rideId);
                    
                } catch (error) {
                    alert('ğŸ’¾ Fehler beim Erstellen der Buchung!');
                    console.error('ğŸ’¾ Fehler:', error);
                } finally {
                    window.isSubmittingFloatingBooking = false;
                    console.log('ğŸ”“ Submit entsperrt');
                }
            } catch (err) {
                alert('ğŸ’¾ Fehler: ' + err.message);
                console.error('ğŸ’¾ Fehler:', err);
                window.isSubmittingFloatingBooking = false;
            }
        }
        
        async function refreshFleetMapStandalone() {
            if (!fleetMapStandaloneInitialized) return;
            
            try {
                // Lade Fahrer-Positionen
                const driversSnapshot = await db.ref('vehicles').once('value');
                const driversData = driversSnapshot.val() || {};
                
                // Lade aktive Fahrten
                const ridesSnapshot = await db.ref('rides').once('value');
                const ridesData = ridesSnapshot.val() || {};
                
                // Finde aktive Fahrten pro Fahrzeug
                const vehicleRides = {};
                for (const rideId in ridesData) {
                    const ride = ridesData[rideId];
                    // ğŸ†• v5.90.252: Nur Fahrten die HEUTE sind!
                    if (isRideActiveToday(ride)) {
                        vehicleRides[ride.vehicleId] = {
                            ...ride,
                            firebaseId: rideId
                        };
                    }
                }
                
                // Alte Marker entfernen
                for (const id in fleetMarkersStandalone) {
                    fleetMapStandalone.removeLayer(fleetMarkersStandalone[id]);
                }
                for (const id in fleetRoutesStandalone) {
                    fleetMapStandalone.removeLayer(fleetRoutesStandalone[id]);
                }
                fleetMarkersStandalone = {};
                fleetRoutesStandalone = {};
                
                let onlineCount = 0;
                let busyCount = 0;
                let vehicleListHtml = '';
                
                // Marker erstellen
                for (const vehicleId in driversData) {
                    const driver = driversData[vehicleId];
                    
                    if (!driver.lat || !driver.lon) continue;
                    if (!VEHICLES[vehicleId]) continue;
                    
                    const ride = vehicleRides[vehicleId];
                    const isOnline = driver.isOnline;
                    const isBusy = !!ride;
                    
                    if (isOnline) onlineCount++;
                    if (isBusy) busyCount++;
                    
                    // Marker-Farbe
                    let color = isOnline ? (isBusy ? '#ef4444' : '#22c55e') : '#6b7280';
                    if (ride && ride.status === 'assigned') color = '#f59e0b';
                    
                    // Marker erstellen
                    const marker = L.circleMarker([driver.lat, driver.lon], {
                        radius: 12,
                        fillColor: color,
                        color: '#fff',
                        weight: 3,
                        opacity: 1,
                        fillOpacity: 0.9
                    }).addTo(fleetMapStandalone);
                    
                    fleetMarkersStandalone[vehicleId] = marker;
                    
                    // Popup
                    let popupContent = `
                        <div style="min-width:200px;">
                            <div style="font-weight:700;font-size:15px;margin-bottom:8px;color:#1f2937;">
                                ğŸš— ${VEHICLES[vehicleId].name}
                            </div>
                            <div style="font-size:13px;color:#666;margin-bottom:6px;">
                                ${VEHICLES[vehicleId].plate}
                            </div>
                            <div style="font-size:12px;color:#999;">
                                ğŸ“ ${driver.lat.toFixed(4)}, ${driver.lon.toFixed(4)}
                            </div>
                    `;
                    
                    // ğŸ†• v5.90.248: ALLE FAHRTEN FÃœR DIESES FAHRZEUG!
                    const allVehicleRides = Object.entries(ridesData)
                        .filter(([id, r]) => r.vehicleId === vehicleId)
                        .map(([id, r]) => ({ ...r, firebaseId: id }))
                        .sort((a, b) => (a.pickupTimestamp || 0) - (b.pickupTimestamp || 0));
                    
                    if (ride) {
                        // ğŸ†• v5.90.271: FORMATIERE ZEIT RICHTIG (Deutsche Zeit statt UTC!)
                        let pickupTime = ride.pickupTime || '-';
                        let pickupDate = ride.pickupDate || '-';
                        
                        // Falls keine formatierten Felder â†’ aus Timestamp erstellen!
                        if ((!ride.pickupTime || ride.pickupTime === '-') && ride.pickupTimestamp) {
                            const date = new Date(ride.pickupTimestamp);
                            pickupTime = date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                            pickupDate = date.toLocaleDateString('de-DE');
                        }
                        
                        const statusColor = ride.status === 'assigned' ? '#f59e0b' : '#ef4444';
                        const statusIcon = ride.status === 'assigned' ? 'ğŸŸ ' : 'ğŸ”´';
                        const statusText = ride.status === 'assigned' ? 'Zugewiesen' : 'Besetzt';
                        
                        popupContent += `
                            <div style="margin-top:10px;padding:12px;background:#f3f4f6;border-radius:8px;border-left:4px solid ${statusColor};">
                                <div style="font-weight:700;color:${statusColor};margin-bottom:8px;font-size:14px;">
                                    ${statusIcon} ${statusText}
                                </div>
                                <div style="color:#374151;font-size:13px;line-height:1.6;">
                                    <strong>${ride.customerName || 'Unbekannt'}</strong><br>
                                    ğŸ“ ${ride.pickup}<br>
                                    ğŸ¯ ${ride.destination}<br>
                                    â° ${pickupTime} Uhr<br>
                                    ğŸ“… ${pickupDate}
                                    ${ride.price ? `<br>ğŸ’° ${ride.price}â‚¬` : ''}
                                </div>
                                <button onclick="completeRideFromMap('${ride.firebaseId}')" style="width:100%;margin-top:10px;padding:10px;background:#10b981;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;transition:all 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                                    âœ… Fahrt abschlieÃŸen
                                </button>
                            </div>
                        `;
                    }
                    
                    // ğŸ†• v5.90.248: TAGESPROGRAMM!
                    const upcomingRides = allVehicleRides.filter(r => 
                        r.status !== 'completed' && 
                        r.status !== 'cancelled' && 
                        r.firebaseId !== (ride?.firebaseId)
                    );
                    
                    if (upcomingRides.length > 0) {
                        popupContent += `
                            <div style="margin-top:12px;padding:12px;background:#eff6ff;border-radius:8px;border-left:4px solid #3b82f6;">
                                <div style="font-weight:700;color:#3b82f6;margin-bottom:8px;font-size:13px;">
                                    ğŸ“‹ Tagesprogramm (${upcomingRides.length})
                                </div>
                        `;
                        
                        upcomingRides.slice(0, 3).forEach(r => {
                            // ğŸ†• v5.90.271: FORMATIERE ZEIT (Deutsche Zeit!)
                            let time = r.pickupTime || '-';
                            let date = r.pickupDate || '-';
                            
                            // Falls nicht formatiert â†’ aus Timestamp erstellen!
                            if ((!r.pickupTime || r.pickupTime === '-') && r.pickupTimestamp) {
                                const d = new Date(r.pickupTimestamp);
                                time = d.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                                date = d.toLocaleDateString('de-DE');
                            }
                            
                            const statusDot = r.status === 'new' ? 'ğŸŸ¢' : r.status === 'assigned' ? 'ğŸŸ¡' : 'âšª';
                            
                            popupContent += `
                                <div style="padding:8px;background:white;border-radius:6px;margin-bottom:6px;font-size:12px;">
                                    ${statusDot} <strong>${date} ${time}</strong><br>
                                    <span style="color:#6b7280;">${r.customerName || 'Unbekannt'}</span><br>
                                    <span style="color:#9ca3af;font-size:11px;">${r.pickup?.substring(0, 30)}...</span>
                                </div>
                            `;
                        });
                        
                        if (upcomingRides.length > 3) {
                            popupContent += `
                                <div style="text-align:center;color:#6b7280;font-size:11px;margin-top:4px;">
                                    + ${upcomingRides.length - 3} weitere
                                </div>
                            `;
                        }
                        
                        popupContent += '</div>';
                    }
                    
                    popupContent += '</div>';
                    marker.bindPopup(popupContent, { maxWidth: 350, minWidth: 250 });
                }
                
                // ğŸ†• v5.90.525: NÃ„CHSTER TERMIN + FAHRZEUGE IN DER NÃ„HE!
                const statusEl = document.getElementById('fleet-status-standalone');
                if (statusEl) {
                    let statusHtml = '';
                    
                    // 1. NÃ¤chster Termin (wie in der anderen Fleet View)
                    const allFutureRides = [];
                    for (const rideId in ridesData) {
                        const ride = ridesData[rideId];
                        const pickupTime = ride.pickupTimestamp || ride.createdAt || 0;
                        const now = Date.now();
                        
                        const activeStatuses = ['new', 'vorbestellt', 'assigned', 'accepted'];
                        if (pickupTime > now && activeStatuses.includes(ride.status)) {
                            allFutureRides.push({
                                ...ride,
                                firebaseId: rideId,
                                pickupTime: pickupTime
                            });
                        }
                    }
                    
                    allFutureRides.sort((a, b) => a.pickupTime - b.pickupTime);
                    
                    if (allFutureRides.length > 0) {
                        const nextRide = allFutureRides[0];
                        const now = Date.now();
                        const minutesUntil = Math.round((nextRide.pickupTime - now) / 60000);
                        const timeStr = new Date(nextRide.pickupTime).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                        
                        let vehicleName = 'Nicht zugewiesen';
                        if (nextRide.vehicleId) {
                            vehicleName = VEHICLES[nextRide.vehicleId]?.name || nextRide.vehicleId;
                        }
                        
                        let bgColor = '#dbeafe', borderColor = '#3b82f6', textColor = '#1e40af';
                        if (minutesUntil <= 15) {
                            bgColor = '#fef2f2'; borderColor = '#ef4444'; textColor = '#991b1b';
                        } else if (minutesUntil <= 30) {
                            bgColor = '#fef3c7'; borderColor = '#f59e0b'; textColor = '#92400e';
                        }
                        
                        statusHtml += `
                            <div style="background:${bgColor};border:2px solid ${borderColor};padding:12px;border-radius:10px;margin-bottom:12px;">
                                <div style="font-weight:700;font-size:13px;color:${textColor};margin-bottom:6px;">
                                    ğŸ”” NÃ„CHSTER TERMIN
                                </div>
                                <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                                    <div style="font-size:18px;font-weight:700;color:${textColor};">
                                        â° In ${minutesUntil} Min
                                    </div>
                                    <div style="font-size:13px;color:${textColor};">
                                        ${timeStr} Uhr
                                    </div>
                                </div>
                                <div style="font-size:11px;color:${textColor};line-height:1.4;">
                                    <div>ğŸ’¾ ${nextRide.customerName || 'Unbekannt'}</div>
                                    <div>ğŸ“ ${nextRide.pickup || 'Unbekannt'}</div>
                                    <div>ğŸš— ${vehicleName}</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // 2. Fahrzeuge in der NÃ¤he (wenn Suchfeld verwendet wurde)
                    if (window.lastFleetSearchCoords) {
                        const nearbyVehicles = [];
                        const MAX_DISTANCE = 10; // km
                        
                        for (const vehicleId in driversData) {
                            const driver = driversData[vehicleId];
                            if (!driver || !driver.lat || !driver.lon) continue;
                            
                            const distance = calculateGPSDistance(
                                window.lastFleetSearchCoords.lat,
                                window.lastFleetSearchCoords.lon,
                                driver.lat,
                                driver.lon
                            );
                            
                            if (distance <= MAX_DISTANCE) {
                                const isBusy = vehicleRides[vehicleId] !== undefined;
                                nearbyVehicles.push({
                                    id: vehicleId,
                                    name: driver.vehicle || VEHICLES[vehicleId]?.name || vehicleId,
                                    distance: distance,
                                    busy: isBusy
                                });
                            }
                        }
                        
                        nearbyVehicles.sort((a, b) => a.distance - b.distance);
                        
                        const freeCo = nearbyVehicles.filter(v => !v.busy).length;
                        const busyCo = nearbyVehicles.filter(v => v.busy).length;
                        
                        let nearbyColor = freeCo > 0 ? '#10b981' : '#ef4444';
                        let nearbyBg = freeCo > 0 ? '#d1fae5' : '#fee2e2';
                        
                        statusHtml += `
                            <div style="background:${nearbyBg};border:2px solid ${nearbyColor};padding:12px;border-radius:10px;margin-bottom:12px;">
                                <div style="font-weight:700;font-size:13px;color:${nearbyColor};margin-bottom:6px;">
                                    ğŸ“ FAHRZEUGE IN DER NÃ„HE (max 10 km)
                                </div>
                                <div style="font-size:16px;font-weight:700;color:${nearbyColor};margin-bottom:4px;">
                                    ${nearbyVehicles.length} Fahrzeug${nearbyVehicles.length !== 1 ? 'e' : ''}
                                </div>
                                <div style="font-size:11px;color:#374151;">
                                    ğŸŸ¢ ${freeCo} frei Â· ğŸ”´ ${busyCo} besetzt
                                </div>
                                ${nearbyVehicles.length > 0 ? `
                                    <div style="margin-top:8px;font-size:11px;color:#6b7280;">
                                        ${nearbyVehicles.slice(0,3).map(v => `
                                            <div>ğŸš— ${v.name} - ${v.distance.toFixed(1)} km ${v.busy ? 'ğŸ”´' : 'ğŸŸ¢'}</div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                    
                    // 3. Status (Online/Besetzt)
                    statusHtml += `
                        <div style="text-align:center;font-size:12px;color:#6b7280;padding:8px;">
                            ${onlineCount} online Â· ${busyCount} besetzt
                        </div>
                    `;
                    
                    statusEl.innerHTML = statusHtml;
                }
                
                // ğŸ†• v5.90.525: TERMINE NÃ„CHSTE STUNDE!
                const upcomingRidesEl = document.getElementById('fleet-upcoming-rides');
                if (upcomingRidesEl) {
                    const now = Date.now();
                    const oneHourLater = now + (60 * 60 * 1000); // +1 Stunde
                    
                    // Hole alle Fahrten in nÃ¤chster Stunde
                    const upcomingRides = [];
                    for (const rideId in ridesData) {
                        const ride = ridesData[rideId];
                        const pickupTime = ride.pickupTimestamp || ride.createdAt || 0;
                        
                        const activeStatuses = ['new', 'vorbestellt', 'assigned', 'accepted'];
                        if (pickupTime > now && pickupTime <= oneHourLater && activeStatuses.includes(ride.status)) {
                            upcomingRides.push({
                                ...ride,
                                firebaseId: rideId,
                                pickupTime: pickupTime
                            });
                        }
                    }
                    
                    upcomingRides.sort((a, b) => a.pickupTime - b.pickupTime);
                    
                    if (upcomingRides.length === 0) {
                        upcomingRidesEl.innerHTML = `
                            <div style="text-align:center;padding:30px 10px;color:#9ca3af;">
                                <div style="font-size:24px;margin-bottom:4px;">âœ…</div>
                                <div style="font-size:10px;">Keine Termine</div>
                            </div>
                        `;
                    } else {
                        let upcomingHtml = '';
                        
                        upcomingRides.forEach(ride => {
                            const minutesUntil = Math.round((ride.pickupTime - now) / 60000);
                            const timeStr = new Date(ride.pickupTime).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                            
                            let vehicleName = 'Nicht zugew.';
                            let vehicleIcon = 'âš ï¸';
                            if (ride.vehicleId) {
                                const veh = VEHICLES[ride.vehicleId]?.name || ride.vehicleId;
                                vehicleName = veh.length > 15 ? veh.substring(0,12) + '...' : veh;
                                vehicleIcon = 'ğŸš—';
                            }
                            
                            // Dezentere Farben
                            let bgColor = '#ffffff';
                            let borderColor = '#e5e7eb';
                            let dotColor = '#10b981';
                            
                            if (minutesUntil <= 15) {
                                borderColor = '#fca5a5';
                                dotColor = '#ef4444';
                            } else if (minutesUntil <= 30) {
                                borderColor = '#fcd34d';
                                dotColor = '#f59e0b';
                            }
                            
                            upcomingHtml += `
                                <div style="
                                    background:${bgColor};
                                    border-left:3px solid ${borderColor};
                                    padding:6px 8px;
                                    margin-bottom:6px;
                                    border-radius:4px;
                                    cursor:pointer;
                                    transition:all 0.2s;
                                " onmouseenter="this.style.background='#f9fafb'" 
                                   onmouseleave="this.style.background='${bgColor}'"
                                   onclick="viewRideDetails('${ride.firebaseId}')">
                                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                                        <div style="font-weight:600;font-size:11px;color:#1f2937;">
                                            ${timeStr}
                                        </div>
                                        <div style="font-size:9px;color:#6b7280;display:flex;align-items:center;gap:3px;">
                                            <div style="width:6px;height:6px;background:${dotColor};border-radius:50%;"></div>
                                            ${minutesUntil}m
                                        </div>
                                    </div>
                                    <div style="font-size:10px;color:#374151;margin-bottom:2px;font-weight:500;">
                                        ğŸ’¾ ${(ride.customerName || 'Unbekannt').substring(0, 20)}
                                    </div>
                                    <div style="font-size:9px;color:#6b7280;margin-bottom:1px;">
                                        ğŸ“ ${(ride.pickup || '?').substring(0, 22)}${(ride.pickup || '').length > 22 ? '...' : ''}
                                    </div>
                                    <div style="font-size:9px;color:#6b7280;margin-bottom:3px;">
                                        ğŸ¯ ${(ride.destination || '?').substring(0, 22)}${(ride.destination || '').length > 22 ? '...' : ''}
                                    </div>
                                    <div style="font-size:9px;color:#6b7280;font-weight:500;">
                                        ${vehicleIcon} ${vehicleName}
                                    </div>
                                </div>
                            `;
                        });
                        
                        upcomingRidesEl.innerHTML = upcomingHtml;
                    }
                }
                
                console.log('ğŸ—ºï¸ Standalone FahrzeugÃ¼bersicht aktualisiert');
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden:', error);
            }
        }
        
        function clearFleetSearchStandalone() {
            document.getElementById('fleet-address-search-standalone').value = '';
            document.getElementById('fleet-address-dropdown-standalone').style.display = 'none';
        }
        
        // ğŸ†• v5.90.207: INFO-BOX EIN-/AUSKLAPPEN!
        function toggleFleetInfo() {
            const content = document.getElementById('fleet-info-content');
            const toggle = document.getElementById('fleet-info-toggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = 'â–¼';
            } else {
                content.style.display = 'none';
                toggle.textContent = 'â–¶';
            }
        }
        
        // ğŸ†• v5.90.203: AUTOCOMPLETE FÃœR STANDALONE SUCHFELD!
        function initFleetSearchStandalone() {
            const input = document.getElementById('fleet-address-search-standalone');
            const dropdown = document.getElementById('fleet-address-dropdown-standalone');
            
            if (!input || !dropdown) return;
            
            let searchTimeout;
            
            input.addEventListener('input', async (e) => {
                const query = e.target.value;
                
                clearTimeout(searchTimeout);
                
                if (query.length < 2) {
                    dropdown.style.display = 'none';
                    return;
                }
                
                dropdown.style.display = 'block';
                dropdown.innerHTML = '<div style="padding:12px;color:#999;text-align:center;">ğŸ” Suche...</div>';
                
                searchTimeout = setTimeout(async () => {
                    try {
                        // Suche mit Nominatim
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=de&viewbox=10.6,54.7,14.4,53.1&bounded=1&limit=10&addressdetails=1`
                        );
                        const results = await response.json();
                        
                        if (results.length === 0) {
                            dropdown.innerHTML = '<div style="padding:12px;color:#999;text-align:center;">Keine Ergebnisse</div>';
                            return;
                        }
                        
                        dropdown.innerHTML = results.map(r => {
                            const address = r.address;
                            let displayText = '';
                            
                            if (address.road) {
                                displayText = address.road;
                                if (address.house_number) displayText += ' ' + address.house_number;
                            }
                            if (address.postcode) displayText += ', ' + address.postcode;
                            if (address.town || address.city) displayText += ' ' + (address.town || address.city);
                            
                            if (!displayText) displayText = r.display_name;
                            
                            return `
                                <div onclick="selectFleetAddress('${displayText.replace(/'/g, "\\'")}', ${r.lat}, ${r.lon})" style="
                                    padding:12px;
                                    cursor:pointer;
                                    border-bottom:1px solid #f0f0f0;
                                    transition:background 0.2s;
                                    font-size:13px;
                                " onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                    ${displayText}
                                </div>
                            `;
                        }).join('');
                        
                    } catch (error) {
                        console.error('ğŸ’¾ Autocomplete Fehler:', error);
                        dropdown.innerHTML = '<div style="padding:12px;color:#ef4444;">Fehler bei der Suche</div>';
                    }
                }, 300);
            });
            
            // SchlieÃŸe bei Klick auÃŸerhalb
            document.addEventListener('click', (e) => {
                if (e.target !== input && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }
        
        function selectFleetAddress(address, lat, lon) {
            const input = document.getElementById('fleet-address-search-standalone');
            const dropdown = document.getElementById('fleet-address-dropdown-standalone');
            
            if (input) input.value = address;
            if (dropdown) dropdown.style.display = 'none';
            
            // ğŸ†• v5.90.525: SPEICHERE KOORDINATEN FÃœR "FAHRZEUGE IN DER NÃ„HE"!
            window.lastFleetSearchCoords = { lat: lat, lon: lon };
            console.log('ğŸ“ Suche gespeichert:', address, lat, lon);
            
            // Aktualisiere sofort um "Fahrzeuge in der NÃ¤he" zu zeigen
            setTimeout(() => {
                if (typeof updateFleetMapDataStandalone === 'function') {
                    updateFleetMapDataStandalone();
                }
            }, 100);
            
            // Zentriere Karte auf Position
            if (fleetMapStandalone) {
                fleetMapStandalone.setView([lat, lon], 16);
                
                // Entferne alten Pin
                if (tempPinMarkerStandalone) {
                    fleetMapStandalone.removeLayer(tempPinMarkerStandalone);
                }
                
                // Setze Pin
                tempPinMarkerStandalone = L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'temp-pin-marker',
                        html: `<div style="
                            background:#10b981;
                            color:white;
                            width:40px;
                            height:40px;
                            border-radius:50% 50% 50% 0;
                            transform:rotate(-45deg);
                            display:flex;
                            align-items:center;
                            justify-content:center;
                            border:3px solid white;
                            box-shadow:0 4px 12px rgba(16,185,129,0.5);
                            font-size:20px;
                        ">
                            <span style="transform:rotate(45deg);">ğŸ“</span>
                        </div>`,
                        iconSize: [40, 40],
                        iconAnchor: [20, 40]
                    }),
                    draggable: true
                }).addTo(fleetMapStandalone);
                
                // Verschiebbar
                tempPinMarkerStandalone.on('dragend', async function(event) {
                    const newPos = event.target.getLatLng();
                    await loadAddressForPin(newPos.lat, newPos.lng, tempPinMarkerStandalone);
                });
                
                // Lade Popup
                loadAddressForPin(lat, lon, tempPinMarkerStandalone);
            }
        }
        
        async function drawRouteToDestination(vehicleId, driver, ride, color) {
            if (!ride.destCoords) return;
            
            try {
                const response = await fetch(
                    `https://router.project-osrm.org/route/v1/driving/` +
                    `${driver.lon},${driver.lat};${ride.destCoords.lon},${ride.destCoords.lat}` +
                    `?overview=full&geometries=geojson`
                );
                const data = await response.json();
                
                if (data.routes && data.routes[0]) {
                    const coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                    const route = L.polyline(coords, {
                        color: color,
                        weight: 4,
                        opacity: 0.7,
                        dashArray: '10, 10'
                    }).addTo(fleetMap);
                    
                    // Ziel-Marker
                    const destIcon = L.divIcon({
                        className: 'dest-marker',
                        html: `<div style="font-size:24px;">ğŸ“</div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 24]
                    });
                    
                    const destMarker = L.marker([ride.destCoords.lat, ride.destCoords.lon], { icon: destIcon })
                        .bindPopup(`<strong>Ziel:</strong><br>${ride.destination}`)
                        .addTo(fleetMap);
                    
                    fleetRoutes[vehicleId] = L.layerGroup([route, destMarker]);
                    fleetRoutes[vehicleId].addTo(fleetMap);
                }
            } catch (error) {
                console.error('Route Fehler:', error);
            }
        }
        
        async function drawRouteToPickup(vehicleId, driver, ride, color) {
            if (!ride.pickupCoords) return;
            
            try {
                const response = await fetch(
                    `https://router.project-osrm.org/route/v1/driving/` +
                    `${driver.lon},${driver.lat};${ride.pickupCoords.lon},${ride.pickupCoords.lat}` +
                    `?overview=full&geometries=geojson`
                );
                const data = await response.json();
                
                if (data.routes && data.routes[0]) {
                    const coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                    const route = L.polyline(coords, {
                        color: color,
                        weight: 4,
                        opacity: 0.7,
                        dashArray: '5, 10'
                    }).addTo(fleetMap);
                    
                    // Abholort-Marker
                    const pickupIcon = L.divIcon({
                        className: 'pickup-marker',
                        html: `<div style="font-size:24px;">ğŸ’¾</div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 24]
                    });
                    
                    const pickupMarker = L.marker([ride.pickupCoords.lat, ride.pickupCoords.lon], { icon: pickupIcon })
                        .bindPopup(`<strong>Abholort:</strong><br>${ride.pickup}<br><strong>Kunde:</strong> ${ride.customerName}`)
                        .addTo(fleetMap);
                    
                    fleetRoutes[vehicleId] = L.layerGroup([route, pickupMarker]);
                    fleetRoutes[vehicleId].addTo(fleetMap);
                }
            } catch (error) {
                console.error('Route Fehler:', error);
            }
        }
        
        function focusVehicle(vehicleId) {
            const marker = fleetMarkers[vehicleId];
            if (marker && fleetMap) {
                fleetMap.setView(marker.getLatLng(), 14);
                // marker.openPopup(); // Altes Popup nicht mehr
            }
            
            // ğŸ†• v5.90.248: ZEIGE ERWEITERTES MODAL!
            showVehicleDetailsModal(vehicleId);
        }
        
        // ğŸ†• v5.90.248: FAHRZEUG-DETAILS MODAL MIT TAGESPROGRAMM!
        function showVehicleDetailsModal(vehicleId) {
            const vehicle = VEHICLES[vehicleId];
            if (!vehicle) {
                console.error('Fahrzeug nicht gefunden:', vehicleId);
                return;
            }
            
            // Finde alle Fahrten fÃ¼r dieses Fahrzeug (vehicleId ODER assignedVehicle)
            const vehicleRides = rides.filter(r => 
                r.vehicleId === vehicleId || r.assignedVehicle === vehicleId
            );
            
            // ğŸ†• v5.90.289: Aktuelle Fahrt = Fahrer fÃ¤hrt zum Kunden ODER hat Gast an Bord
            // NUR on_way (unterwegs zum Kunden) oder picked_up (Gast an Bord)!
            // NICHT accepted (nur angenommen, noch nicht losgefahren)!
            const currentRide = vehicleRides.find(r => 
                r.status === 'on_way' || r.status === 'picked_up'
            );
            
            // ZukÃ¼nftige Fahrten (vorbestellt, new, assigned, accepted)
            // ğŸ†• v5.90.314: NUR FAHRTEN VON HEUTE!
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Heute 00:00 Uhr
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1); // Morgen 00:00 Uhr
            
            const upcomingRides = vehicleRides
                .filter(r => {
                    // Nicht die aktuelle Fahrt
                    if (r === currentRide) return false;
                    
                    // ğŸ†• v5.90.314: NUR FAHRTEN VON HEUTE!
                    const rideTime = r.pickupTimestamp || r.timestamp || 0;
                    const rideDate = new Date(rideTime);
                    
                    // Muss zwischen heute 00:00 und morgen 00:00 sein
                    if (rideDate < today || rideDate >= tomorrow) {
                        console.log(`ğŸ“… v5.90.314: Fahrt ausgeblendet (nicht heute): ${r.customerName || 'Unbekannt'} - Datum: ${rideDate.toLocaleDateString('de-DE')}`);
                        return false;
                    }
                    
                    // ğŸ†• v5.90.318: Keine abgeschlossenen/stornierten Fahrten!
                    if (r.status === 'completed' || r.status === 'cancelled') {
                        console.log(`âœ… v5.90.318: Abgeschlossene Fahrt ausgeblendet: ${r.customerName || 'Unbekannt'}`);
                        return false;
                    }
                    
                    // ğŸ†• v5.90.318: Keine VERGANGENEN Fahrten (Ã¤lter als jetzt - 5 Min)!
                    const now = Date.now();
                    if (rideTime < (now - 5 * 60 * 1000)) {
                        console.log(`â° v5.90.318: Vergangene Fahrt ausgeblendet: ${r.customerName || 'Unbekannt'} (${new Date(rideTime).toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'})})`);
                        return false;
                    }
                    
                    return true;
                })
                .sort((a, b) => {
                    const timeA = a.pickupTimestamp || a.timestamp || 0;
                    const timeB = b.pickupTimestamp || b.timestamp || 0;
                    return timeA - timeB;
                });
            
            // Erstelle Modal
            const modal = document.createElement('div');
            modal.id = 'vehicle-details-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10001;padding:20px;';
            
            let currentRideHtml = '';
            if (currentRide) {
                const pickupTime = currentRide.pickupTime || '?';
                const pickupDate = currentRide.pickupDate || new Date(currentRide.pickupTimestamp || currentRide.timestamp).toLocaleDateString('de-DE');
                const duration = currentRide.timestamp ? Math.round((Date.now() - currentRide.timestamp) / 60000) : 0;
                
                // Status-Label dynamisch
                let statusLabel = 'ğŸ”´ AKTIVE FAHRT';
                let statusColor = '#ef4444';
                let backgroundColor = '#fee2e2';
                
                if (currentRide.status === 'on_way') {
                    statusLabel = 'ğŸš— FAHRT ZUM KUNDEN';
                    statusColor = '#3b82f6';
                    backgroundColor = '#dbeafe';
                } else if (currentRide.status === 'picked_up') {
                    statusLabel = 'ğŸ’¾ GAST AN BORD';
                    statusColor = '#10b981';
                    backgroundColor = '#d1fae5';
                } else if (currentRide.status === 'new') {
                    statusLabel = 'ğŸ”„ ZURÃœCKGESETZTE FAHRT';
                    statusColor = '#f59e0b';
                    backgroundColor = '#fef3c7';
                } else if (currentRide.status === 'cancelled' || currentRide.status === 'storniert') {
                    statusLabel = 'ğŸ’¾ STORNIERTE FAHRT';
                    statusColor = '#6b7280';
                    backgroundColor = '#f3f4f6';
                }
                
                currentRideHtml = `
                    <div style="background:${backgroundColor};border:2px solid ${statusColor};border-radius:12px;padding:15px;margin-bottom:15px;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                            <div style="background:${statusColor};color:white;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700;">
                                ${statusLabel}
                            </div>
                            <div style="font-size:12px;color:#991b1b;">
                                â±ï¸ Seit ${duration} Min
                            </div>
                        </div>
                        
                        <div style="font-weight:700;font-size:16px;color:#111827;margin-bottom:8px;">
                            ğŸ’¾ ${currentRide.customerName || 'Unbekannt'}
                        </div>
                        
                        ${currentRide.customerPhone ? `
                        <div style="margin-bottom:8px;">
                            <a href="tel:${currentRide.customerPhone}" style="display:inline-flex;align-items:center;gap:6px;padding:8px 12px;background:#10b981;color:white;text-decoration:none;border-radius:8px;font-weight:600;font-size:13px;transition:all 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                                ğŸ’¾ ${currentRide.customerPhone}
                            </a>
                        </div>
                        ` : ''}
                        
                        <div style="font-size:13px;color:#4b5563;margin-bottom:6px;">
                            ğŸ“… ${pickupDate} Â· ğŸ• ${pickupTime}
                        </div>
                        
                        <div style="background:white;padding:10px;border-radius:8px;margin:10px 0;font-size:13px;color:#374151;">
                            <div style="margin-bottom:4px;">
                                ğŸ“ <strong>Von:</strong> ${currentRide.pickup || '?'}
                            </div>
                            <div>
                                ğŸ¯ <strong>Nach:</strong> ${currentRide.destination || '?'}
                            </div>
                        </div>
                        
                        <div style="display:flex;gap:8px;margin-top:10px;">
                            <div style="flex:1;text-align:center;padding:8px;background:white;border-radius:6px;">
                                ğŸ’° <strong>${currentRide.price || '?'}â‚¬</strong>
                            </div>
                            <div style="flex:1;text-align:center;padding:8px;background:white;border-radius:6px;">
                                ğŸ“ <strong>${currentRide.distance || '?'} km</strong>
                            </div>
                        </div>
                        
                        ${currentRide.status === 'new' ? `
                        <div style="margin-top:12px;">
                            <button onclick="deleteResetRide('${currentRide.firebaseId}')" style="width:100%;padding:12px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px;transition:all 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                                ğŸ—‘ï¸ Fahrt lÃ¶schen
                            </button>
                        </div>
                        ` : `
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;">
                            <button onclick="completeRideFromModal('${currentRide.firebaseId}')" style="padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px;transition:all 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                                âœ… AbschlieÃŸen
                            </button>
                            <button onclick="resetActiveRide('${currentRide.firebaseId}')" style="padding:12px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px;transition:all 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                                ğŸ”„ ZurÃ¼cksetzen
                            </button>
                        </div>
                        `}
                    </div>
                `;
            }
            
            let upcomingHtml = '';
            if (upcomingRides.length > 0) {
                upcomingHtml = `
                    <div style="margin-bottom:10px;">
                        <div style="font-weight:700;font-size:14px;color:#374151;margin-bottom:10px;display:flex;align-items:center;gap:8px;">
                            ğŸ“‹ TAGESPROGRAMM
                            <span style="background:#3b82f6;color:white;padding:2px 8px;border-radius:12px;font-size:11px;">
                                ${upcomingRides.length}
                            </span>
                        </div>
                        
                        <div style="max-height:300px;overflow-y:auto;">
                            ${upcomingRides.map(ride => {
                                const pickupTime = ride.pickupTime || '?';
                                const pickupDate = ride.pickupDate || new Date(ride.pickupTimestamp || ride.timestamp).toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit'});
                                
                                // ğŸ†• v5.90.314: Status-Mapping mit ALLEN Status!
                                const statusMap = {
                                    'new': { color: '#10b981', icon: 'ğŸŸ¢', text: 'Neu' },
                                    'assigned': { color: '#f59e0b', icon: 'ğŸŸ¡', text: 'Zugeteilt' },
                                    'accepted': { color: '#3b82f6', icon: 'ğŸ”µ', text: 'Angenommen' },
                                    'on_way': { color: '#8b5cf6', icon: 'ğŸŸ£', text: 'Unterwegs' },
                                    'picked_up': { color: '#ec4899', icon: 'ğŸŸ ', text: 'Gast an Bord' },
                                    'completed': { color: '#22c55e', icon: 'âœ…', text: 'Abgeschlossen' },
                                    'cancelled': { color: '#6b7280', icon: 'ğŸ’¾', text: 'Storniert' }
                                };
                                
                                const currentStatus = statusMap[ride.status] || statusMap['new'];
                                const statusColor = currentStatus.color;
                                const statusIcon = currentStatus.icon;
                                const statusText = currentStatus.text;
                                
                                return `
                                    <div style="background:#f9fafb;border:2px solid #e5e7eb;border-left:4px solid ${statusColor};border-radius:10px;padding:12px;margin-bottom:8px;">
                                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
                                            <div style="flex:1;">
                                                <div style="font-weight:600;font-size:14px;color:#111827;">
                                                    ğŸ’¾ ${ride.customerName || 'Unbekannt'}
                                                </div>
                                                ${ride.customerPhone ? `
                                                <div style="margin-top:4px;">
                                                    <a href="tel:${ride.customerPhone}" style="display:inline-flex;align-items:center;gap:4px;padding:4px 8px;background:#10b981;color:white;text-decoration:none;border-radius:6px;font-weight:600;font-size:11px;transition:all 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'" onclick="event.stopPropagation()">
                                                        ğŸ’¾ ${ride.customerPhone}
                                                    </a>
                                                </div>
                                                ` : ''}
                                                <div style="font-size:12px;color:#6b7280;margin-top:4px;">
                                                    ğŸ“… ${pickupDate} Â· ğŸ• ${pickupTime}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div style="font-size:12px;color:#4b5563;margin-bottom:8px;">
                                            <div style="margin-bottom:3px;">ğŸ“ ${ride.pickup || '?'}</div>
                                            <div>ğŸ¯ ${ride.destination || '?'}</div>
                                        </div>
                                        
                                        <div style="display:flex;gap:8px;margin-bottom:8px;">
                                            <div style="font-size:11px;color:#6b7280;">
                                                ğŸ’° ${ride.price || '?'}â‚¬
                                            </div>
                                            <div style="font-size:11px;color:#6b7280;">
                                                ğŸ“ ${ride.distance || '?'} km
                                            </div>
                                        </div>
                                        
                                        <!-- ğŸ†• v5.90.525: STATUS-DROPDOWN + VORBESTELLT -->
                                        <div style="margin-top:8px;">
                                            <label style="font-size:11px;color:#6b7280;font-weight:600;display:block;margin-bottom:4px;">Status:</label>
                                            <select onchange="updateRideStatus('${ride.firebaseId}', this.value)" style="width:100%;padding:8px;border:2px solid ${statusColor};border-radius:6px;font-size:13px;font-weight:600;color:${statusColor};background:white;cursor:pointer;" onclick="event.stopPropagation()">
                                                <option value="vorbestellt" ${ride.status === 'vorbestellt' ? 'selected' : ''}>ğŸŸ¡ Vorbestellt</option>
                                                <option value="new" ${ride.status === 'new' ? 'selected' : ''}>ğŸŸ¢ Neu</option>
                                                <option value="assigned" ${ride.status === 'assigned' ? 'selected' : ''}>ğŸŸ¡ Zugeteilt</option>
                                                <option value="accepted" ${ride.status === 'accepted' ? 'selected' : ''}>ğŸ”µ Angenommen</option>
                                                <option value="on_way" ${ride.status === 'on_way' ? 'selected' : ''}>ğŸŸ£ Unterwegs</option>
                                                <option value="picked_up" ${ride.status === 'picked_up' ? 'selected' : ''}>ğŸŸ  Gast an Bord</option>
                                                <option value="completed" ${ride.status === 'completed' ? 'selected' : ''}>âœ… Abgeschlossen</option>
                                                <option value="cancelled" ${ride.status === 'cancelled' ? 'selected' : ''}>ğŸ’¾ Storniert</option>
                                            </select>
                                        </div>
                                        
                                        <!-- ğŸ†• v5.90.314: ZEIT-EDITOR BUTTON -->
                                        <button onclick="editRideTime('${ride.firebaseId}', '${pickupTime}')" style="width:100%;margin-top:6px;padding:8px;background:#3b82f6;color:white;border:none;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                                            ğŸ“ Zeit Ã¤ndern
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            } else if (!currentRide) {
                upcomingHtml = `
                    <div style="text-align:center;padding:40px 20px;color:#9ca3af;">
                        <div style="font-size:48px;margin-bottom:10px;">âœ…</div>
                        <div style="font-size:14px;">Keine Fahrten geplant</div>
                    </div>
                `;
            }
            
            modal.innerHTML = `
                <div style="background:white;border-radius:16px;width:100%;max-width:500px;max-height:90vh;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.4);">
                    <!-- Header -->
                    <div style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white;padding:20px;display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <h3 style="margin:0;font-size:18px;font-weight:700;">ğŸš— ${vehicle.name}</h3>
                            <div style="font-size:13px;opacity:0.9;margin-top:4px;">
                                ğŸš™ ${vehicle.plate || '?'}
                            </div>
                        </div>
                        <button onclick="document.getElementById('vehicle-details-modal').remove()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:20px;font-weight:bold;">Ã—</button>
                    </div>
                    
                    <!-- Content -->
                    <div style="flex:1;overflow-y:auto;padding:20px;">
                        ${currentRideHtml}
                        ${upcomingHtml}
                    </div>
                    
                    <!-- Footer -->
                    <div style="padding:15px;border-top:2px solid #e5e7eb;background:#f9fafb;text-align:center;color:#6b7280;font-size:12px;">
                        ${currentRide ? 'ğŸ”´ In Fahrt' : upcomingRides.length > 0 ? `ğŸ“‹ ${upcomingRides.length} Fahrten geplant` : 'âœ… VerfÃ¼gbar'}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // SchlieÃŸen bei Klick auf Backdrop
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // ğŸ†• v5.90.248: FAHRT ABSCHLIESSEN AUS MODAL
        async function completeRideFromModal(rideId) {
            if (!confirm('Fahrt wirklich abschlieÃŸen?')) return;
            
            try {
                await updateRide(rideId, {
                    status: 'completed',
                    completedAt: Date.now()
                });
                
                console.log('âœ… Fahrt abgeschlossen:', rideId);
                
                // SchlieÃŸe Modal
                const modal = document.getElementById('vehicle-details-modal');
                if (modal) modal.remove();
                
                // Aktualisiere Fleet Map
                setTimeout(() => refreshFleetMap(), 500);
                
                alert('âœ… Fahrt erfolgreich abgeschlossen!');
                
            } catch (e) {
                console.error('ğŸ’¾ Fehler:', e);
                alert('ğŸ’¾ Fehler beim AbschlieÃŸen: ' + e.message);
            }
        }
        
        // ğŸ†• v5.90.283: RESET AKTIVE FAHRT
        async function resetActiveRide(rideId) {
            if (!confirm('âš ï¸ Fahrt wirklich zurÃ¼cksetzen?\n\nDie Fahrt wird wieder auf "new" gesetzt und das Fahrzeug wird freigegeben.')) return;
            
            try {
                // 1. Fahrt zurÃ¼cksetzen
                await updateRide(rideId, {
                    status: 'new',
                    vehicleId: null,
                    assignedVehicle: null, // Auch dieses Feld!
                    vehicle: null,
                    vehiclePlate: null,
                    vehicleDriver: null,
                    driverAssignedAt: null,
                    acceptedAt: null,
                    pickedUpAt: null,
                    completedAt: null
                });
                
                console.log('ğŸ”„ Fahrt zurÃ¼ckgesetzt:', rideId);
                
                // 2. Tracking-Link lÃ¶schen (falls vorhanden)
                const ride = rides.find(r => r.firebaseId === rideId);
                if (ride && ride.trackingLink) {
                    await db.ref(`rides/${rideId}/trackingLink`).remove();
                    console.log('ğŸ—‘ï¸ Tracking-Link gelÃ¶scht');
                }
                
                // 3. SchlieÃŸe Modal
                const modal = document.getElementById('vehicle-details-modal');
                if (modal) modal.remove();
                
                // 4. Lade Fahrten neu (WICHTIG: Vor refreshFleetMap!)
                await loadAdminRides();
                
                // 5. Aktualisiere Fleet Map
                setTimeout(() => refreshFleetMap(), 500);
                
                alert('âœ… Fahrt wurde zurÃ¼ckgesetzt!\n\nDie Fahrt ist jetzt wieder verfÃ¼gbar und kann neu zugewiesen werden.');
                
            } catch (e) {
                console.error('ğŸ’¾ Fehler beim ZurÃ¼cksetzen:', e);
                alert('ğŸ’¾ Fehler beim ZurÃ¼cksetzen: ' + e.message);
            }
        }
        
        // ğŸ†• v5.90.285: LÃ–SCHE ZURÃœCKGESETZTE FAHRT
        // ğŸ†• v5.90.525: FAHRZEUG KOMPLETT FREIGEBEN (RESET)
        async function resetVehicleForRide(rideId) {
            const confirmText = 
                'ğŸ”„ FAHRZEUG FREIGEBEN?\n\n' +
                'Das wird zurÃ¼ckgesetzt:\n' +
                'âœ… Status â†’ "new"\n' +
                'âœ… Fahrzeug â†’ Nicht zugewiesen\n' +
                'âœ… Tracking-Link â†’ GelÃ¶scht\n' +
                'âœ… GPS-Daten â†’ GelÃ¶scht\n\n' +
                'Fahrzeug ist danach wieder FREI!\n\n' +
                'Fortfahren?';
            
            if (!confirm(confirmText)) return;
            
            try {
                // Fahrt zurÃ¼cksetzen
                await db.ref(`rides/${rideId}`).update({
                    status: 'new',
                    vehicleId: null,
                    assignedTo: null,
                    vehicle: null,
                    vehicleLabel: null,
                    assignedVehicleName: null,
                    assignedAt: null,
                    assignedBy: null,
                    trackingLink: null,
                    driverLocation: null,
                    etaMinutes: null,
                    estimatedArrivalAt: null,
                    drivingTimeToPickup: null,
                    acceptedAt: null,
                    startedDrivingAt: null,
                    resetAt: Date.now(),
                    resetBy: currentUser?.uid || 'admin'
                });
                
                console.log('âœ… Fahrzeug freigegeben fÃ¼r Fahrt:', rideId);
                
                // ğŸ“œ PROTOKOLL
                logActivity('status', 'reset', `Fahrzeug freigegeben (Reset)`, {
                    rideId: rideId
                });
                
                // SchlieÃŸe Modal
                const modal = document.getElementById('vehicle-details-modal');
                if (modal) modal.remove();
                
                const statusModal = document.getElementById('status-change-modal');
                if (statusModal) statusModal.remove();
                
                // Aktualisiere View
                if (currentView === 'vehicle-overview-view') {
                    loadFleetOverviewStandalone();
                } else if (currentView === 'schedule-view') {
                    renderCalendar();
                } else if (currentView === 'admin-view') {
                    await loadAdminRides();
                }
                
                // Aktualisiere Fleet Map
                setTimeout(() => refreshFleetMap(), 500);
                
                alert('âœ… Fahrzeug freigegeben!\n\nStatus: neu\nFahrzeug: nicht zugewiesen\nTracking: gelÃ¶scht');
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Reset:', error);
                alert('ğŸ’¾ Fehler beim Freigeben: ' + error.message);
            }
        }

        async function deleteResetRide(rideId) {
            if (!confirm('âš ï¸ ZurÃ¼ckgesetzte Fahrt wirklich lÃ¶schen?\n\nDiese Aktion kann nicht rÃ¼ckgÃ¤ngig gemacht werden!')) return;
            
            try {
                // Fahrt aus Firebase lÃ¶schen
                await db.ref(`rides/${rideId}`).remove();
                console.log('ğŸ—‘ï¸ Fahrt gelÃ¶scht:', rideId);
                
                // SchlieÃŸe Modal
                const modal = document.getElementById('vehicle-details-modal');
                if (modal) modal.remove();
                
                // Lade Fahrten neu
                await loadAdminRides();
                
                // Aktualisiere Fleet Map
                setTimeout(() => refreshFleetMap(), 500);
                
                alert('âœ… Fahrt wurde gelÃ¶scht!');
                
            } catch (e) {
                console.error('ğŸ’¾ Fehler beim LÃ¶schen:', e);
                alert('ğŸ’¾ Fehler beim LÃ¶schen: ' + e.message);
            }
        }
        
        // ğŸ†• v5.90.248: ZEIGE FAHRT-DETAILS AUS FAHRZEUG-MODAL
        function showRideDetailsFromVehicle(rideId) {
            const ride = rides.find(r => r.firebaseId === rideId);
            if (!ride) {
                alert('Fahrt nicht gefunden!');
                return;
            }
            
            // SchlieÃŸe Fahrzeug-Modal
            const vehicleModal = document.getElementById('vehicle-details-modal');
            if (vehicleModal) vehicleModal.remove();
            
            // Zeige Fahrt-Details (nutze existierende Funktion wenn vorhanden)
            if (typeof showRideDetails === 'function') {
                showRideDetails(ride);
            } else {
                alert(`ğŸ“‹ Fahrt-Details:\n\nğŸ’¾ ${ride.customerName}\nğŸ“ ${ride.pickup}\nğŸ¯ ${ride.destination}\nğŸ’° ${ride.price}â‚¬\nğŸ• ${ride.pickupTime || '?'}`);
            }
        }
        
        // ğŸ†• v5.90.249: UPDATE AKTIVE FAHRT BANNER
        function updateActiveRideBanner(currentRide) {
            const banner = document.getElementById('driver-active-ride-banner');
            if (!banner) return;
            
            if (!currentRide) {
                banner.style.display = 'none';
                return;
            }
            
            banner.style.display = 'block';
            
            // Dauer berechnen
            const duration = currentRide.timestamp ? Math.round((Date.now() - currentRide.timestamp) / 60000) : 0;
            document.getElementById('active-ride-duration').textContent = `â±ï¸ Seit ${duration} Min`;
            
            // Kunde
            document.getElementById('active-ride-customer').textContent = `ğŸ’¾ ${currentRide.customerName || 'Unbekannt'}`;
            
            // Zeit & Datum
            const pickupTime = currentRide.pickupTime || '?';
            const pickupDate = currentRide.pickupDate || new Date(currentRide.pickupTimestamp || currentRide.timestamp).toLocaleDateString('de-DE');
            document.getElementById('active-ride-time').textContent = `ğŸ“… ${pickupDate} Â· ğŸ• ${pickupTime}`;
            
            // Route
            document.getElementById('active-ride-from').innerHTML = `ğŸ“ <strong>Von:</strong> ${currentRide.pickup || '?'}`;
            document.getElementById('active-ride-to').innerHTML = `ğŸ¯ <strong>Nach:</strong> ${currentRide.destination || '?'}`;
            
            // Preis & Distanz
            document.getElementById('active-ride-price').textContent = `${currentRide.price || '?'}â‚¬`;
            document.getElementById('active-ride-distance').textContent = `${currentRide.distance || '?'} km`;
            
            // Speichere aktuelle Fahrt ID global
            window.currentActiveRideId = currentRide.firebaseId;
        }
        
        // ğŸ†• v5.90.314: STATUS Ã„NDERN
        async function updateRideStatus(rideId, newStatus) {
            if (!rideId || !newStatus) return;
            
            console.log(`ğŸ”„ v5.90.314: Status Ã¤ndern: ${rideId} â†’ ${newStatus}`);
            
            try {
                await db.ref('rides/' + rideId).update({
                    status: newStatus,
                    updatedAt: Date.now()
                });
                
                // ğŸ†• v5.90.542: SPEICHERE STATUS!
                saveDriverState(rideId, newStatus);
                
                // ğŸ†• v5.90.542: CLEAR STATE wenn completed
                if (newStatus === 'completed' || newStatus === 'cancelled') {
                    clearDriverState();
                }
                
                alert(`âœ… Status geÃ¤ndert zu: ${newStatus}`);
                
                // Modal neu laden
                const modal = document.getElementById('vehicle-details-modal');
                if (modal) {
                    modal.remove();
                }
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Status-Update:', error);
                alert('ğŸ’¾ Fehler beim Status-Update!');
            }
        }
        
        // ğŸ†• v5.90.314: ZEIT Ã„NDERN
        function editRideTime(rideId, currentTime) {
            if (!rideId) return;
            
            const ride = rides.find(r => r.firebaseId === rideId);
            if (!ride) return;
            
            const newTime = prompt(`ğŸ• Neue Abholzeit (HH:MM):`, currentTime);
            if (!newTime) return;
            
            // Zeit validieren
            const timeMatch = newTime.match(/^(\d{1,2}):(\d{2})$/);
            if (!timeMatch) {
                alert('ğŸ’¾ UngÃ¼ltige Zeit! Format: HH:MM');
                return;
            }
            
            const hours = parseInt(timeMatch[1]);
            const minutes = parseInt(timeMatch[2]);
            
            if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
                alert('ğŸ’¾ UngÃ¼ltige Zeit!');
                return;
            }
            
            // Neuen Timestamp berechnen
            const rideDate = new Date(ride.pickupTimestamp || ride.timestamp);
            rideDate.setHours(hours, minutes, 0, 0);
            const newTimestamp = rideDate.getTime();
            
            console.log(`ğŸ• v5.90.314: Zeit Ã¤ndern: ${rideId} â†’ ${newTime}`);
            
            // In Firebase speichern
            db.ref('rides/' + rideId).update({
                pickupTime: newTime,
                pickupTimestamp: newTimestamp,
                updatedAt: Date.now()
            }).then(() => {
                alert(`âœ… Zeit geÃ¤ndert zu: ${newTime}`);
                
                // Modal neu laden
                const modal = document.getElementById('vehicle-details-modal');
                if (modal) {
                    modal.remove();
                }
            }).catch(error => {
                console.error('ğŸ’¾ Fehler beim Zeit-Update:', error);
                alert('ğŸ’¾ Fehler beim Zeit-Update!');
            });
        }
        
        // ğŸ†• v5.90.249: UPDATE TAGESPROGRAMM
        function updateDriverSchedule(myRides, currentRide) {
            const panel = document.getElementById('driver-schedule-panel');
            const list = document.getElementById('driver-schedule-list');
            const countBadge = document.getElementById('schedule-count');
            
            if (!panel || !list) return;
            
            // Filtere: Alle Fahrten auÃŸer current, completed, cancelled, vergangene
            const now = Date.now();
            const upcomingRides = myRides
                .filter(r => {
                    if (r === currentRide) return false;
                    if (r.status === 'completed' || r.status === 'cancelled') return false;
                    
                    // ğŸ†• v5.90.318: Keine VERGANGENEN Fahrten!
                    const rideTime = r.pickupTimestamp || r.timestamp || 0;
                    if (rideTime < (now - 5 * 60 * 1000)) {
                        return false;
                    }
                    
                    return true;
                })
                .sort((a, b) => {
                    const timeA = a.pickupTimestamp || a.timestamp || 0;
                    const timeB = b.pickupTimestamp || b.timestamp || 0;
                    return timeA - timeB;
                });
            
            if (upcomingRides.length === 0) {
                panel.style.display = 'none';
                return;
            }
            
            panel.style.display = 'block';
            countBadge.textContent = upcomingRides.length;
            
            // Render Liste
            list.innerHTML = upcomingRides.map(ride => {
                const pickupTime = ride.pickupTime || '?';
                const pickupDate = ride.pickupDate || new Date(ride.pickupTimestamp || ride.timestamp).toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit'});
                
                // Status-Farbe
                let statusColor = '#10b981';
                let statusIcon = 'ğŸŸ¢';
                let statusText = 'Geplant';
                
                if (ride.status === 'assigned') {
                    statusColor = '#f59e0b';
                    statusIcon = 'ğŸŸ¡';
                    statusText = 'Zugeteilt';
                } else if (ride.status === 'accepted') {
                    statusColor = '#3b82f6';
                    statusIcon = 'ğŸ”µ';
                    statusText = 'Angenommen';
                }
                
                return `
                    <div style="background:#f9fafb;border:2px solid #e5e7eb;border-left:4px solid ${statusColor};border-radius:10px;padding:15px;margin-bottom:10px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='#eff6ff'" onmouseout="this.style.background='#f9fafb'">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px;">
                            <div style="flex:1;">
                                <div style="font-weight:700;font-size:15px;color:#111827;margin-bottom:4px;">
                                    ğŸ’¾ ${ride.customerName || 'Unbekannt'}
                                </div>
                                <div style="font-size:13px;color:#6b7280;">
                                    ğŸ“… ${pickupDate} Â· ğŸ• ${pickupTime}
                                </div>
                            </div>
                            <div style="background:${statusColor}15;color:${statusColor};padding:4px 10px;border-radius:8px;font-size:11px;font-weight:700;">
                                ${statusIcon} ${statusText}
                            </div>
                        </div>
                        
                        <div style="font-size:13px;color:#4b5563;margin-bottom:10px;">
                            <div style="margin-bottom:4px;">ğŸ“ ${ride.pickup || '?'}</div>
                            <div>ğŸ¯ ${ride.destination || '?'}</div>
                        </div>
                        
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div style="display:flex;gap:15px;font-size:12px;color:#6b7280;">
                                <span>ğŸ’° ${ride.price || '?'}â‚¬</span>
                                <span>ğŸ“ ${ride.distance || '?'} km</span>
                            </div>
                            <button onclick="event.stopPropagation();acceptRide('${ride.firebaseId}')" style="padding:8px 14px;background:${statusColor};color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:12px;transition:all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                                ${ride.status === 'new' ? 'âœ… Annehmen' : 'ğŸ—ºï¸ Details'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ğŸ†• v5.90.249: NAVIGATION FÃœR AKTIVE FAHRT Ã–FFNEN
        function openNavigationForCurrent() {
            if (!window.currentActiveRideId) {
                alert('Keine aktive Fahrt!');
                return;
            }
            
            const ride = rides.find(r => r.firebaseId === window.currentActiveRideId);
            if (!ride || !ride.destCoords) {
                alert('Ziel-Koordinaten fehlen!');
                return;
            }
            
            // Ã–ffne Google Maps Navigation
            const url = `https://www.google.com/maps/dir/?api=1&destination=${ride.destCoords.lat},${ride.destCoords.lon}`;
            window.open(url, '_blank');
        }
        
        // ğŸ†• v5.90.249: AKTIVE FAHRT ABSCHLIESSEN
        async function completeCurrentRide() {
            if (!window.currentActiveRideId) {
                alert('Keine aktive Fahrt!');
                return;
            }
            
            if (!confirm('Fahrt wirklich abschlieÃŸen?')) return;
            
            try {
                await updateRide(window.currentActiveRideId, {
                    status: 'completed',
                    completedAt: Date.now()
                });
                
                console.log('âœ… Fahrt abgeschlossen:', window.currentActiveRideId);
                window.currentActiveRideId = null;
                
                alert('âœ… Fahrt erfolgreich abgeschlossen!');
                
                // Update View
                if (typeof updateDriverView === 'function') {
                    updateDriverView();
                }
                
            } catch (e) {
                console.error('ğŸ’¾ Fehler:', e);
                alert('ğŸ’¾ Fehler beim AbschlieÃŸen: ' + e.message);
            }
        }
        
        function toggleFleetAutoRefresh() {
            const btn = document.getElementById('fleet-auto-btn');
            
            if (fleetAutoRefresh) {
                // Stoppen
                clearInterval(fleetAutoRefresh);
                fleetAutoRefresh = null;
                if (btn) {
                    btn.textContent = 'â–¶ï¸ Auto-Update';
                    btn.style.background = '#10b981';
                }
                console.log('â¹ï¸ Auto-Update gestoppt');
            } else {
                // Starten (alle 10 Sekunden)
                fleetAutoRefresh = setInterval(refreshFleetMap, 10000);
                if (btn) {
                    btn.textContent = 'â¹ï¸ Auto-Update';
                    btn.style.background = '#ef4444';
                }
                console.log('â–¶ï¸ Auto-Update gestartet (10s)');
                refreshFleetMap(); // Sofort aktualisieren
            }
        }
        
        // ğŸ”´ LIVE-LOG SYSTEM
        let liveLogActive = false;
        let liveLogListener = null;
        let liveLogFilters = {
            booking: true,
            driver: true,
            assignment: true,
            status: true,
            gps: false,
            system: true
        };
        let liveLogEntries = [];
        
        function toggleLiveLog() {
            if (liveLogActive) {
                stopLiveLog();
            } else {
                startLiveLog();
            }
        }
        
        async function startLiveLog() {
            if (!isFirebaseReady) {
                addLiveLogEntry('error', 'ğŸ’¾ Firebase nicht verbunden!');
                return;
            }
            
            liveLogActive = true;
            
            // Update UI
            const btn = document.getElementById('live-log-toggle-btn');
            const status = document.getElementById('live-log-status');
            if (btn) {
                btn.textContent = 'â¹ï¸ Stoppen';
                btn.style.background = '#dc2626';
            }
            if (status) {
                status.textContent = '(ğŸ”´ LIVE)';
                status.style.color = '#ff6b6b';
            }
            
            addLiveLogEntry('system', 'ğŸŸ¢ Live-Log gestartet...');
            
            // ğŸ“œ ZUERST: Letzte Logs laden (letzte 2 STUNDEN oder max 100)
            // ğŸ†• v5.21.2: Von 30 Min auf 120 Min erweitert!
            const twoHoursAgo = Date.now() - (120 * 60 * 1000);
            try {
                const recentSnapshot = await db.ref('activityLog')
                    .orderByChild('timestamp')
                    .startAt(twoHoursAgo)
                    .limitToLast(100)
                    .once('value');
                
                const recentLogs = [];
                recentSnapshot.forEach(child => {
                    recentLogs.push(child.val());
                });
                
                if (recentLogs.length > 0) {
                    addLiveLogEntry('system', `ğŸ“œ ${recentLogs.length} Ereignisse aus den letzten 2 Stunden geladen:`);
                    recentLogs.forEach(log => {
                        if (log && shouldShowLiveLog(log.type)) {
                            displayLiveLogEntry(log);
                        }
                    });
                    addLiveLogEntry('system', 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Live-Modus aktiv â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
                } else {
                    addLiveLogEntry('system', 'ğŸ“­ Keine Ereignisse in den letzten 2 Stunden');
                }
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der letzten Logs:', error);
            }
            
            // Firebase Listener fÃ¼r NEUE Log-EintrÃ¤ge
            const now = Date.now();
            liveLogListener = db.ref('activityLog')
                .orderByChild('timestamp')
                .startAt(now)
                .on('child_added', (snapshot) => {
                    const log = snapshot.val();
                    if (log && shouldShowLiveLog(log.type)) {
                        displayLiveLogEntry(log);
                    }
                });
            
            console.log('ğŸ”´ Live-Log gestartet');
        }
        
        function stopLiveLog() {
            liveLogActive = false;
            
            // Firebase Listener entfernen
            if (liveLogListener && isFirebaseReady) {
                db.ref('activityLog').off('child_added', liveLogListener);
                liveLogListener = null;
            }
            
            // Update UI
            const btn = document.getElementById('live-log-toggle-btn');
            const status = document.getElementById('live-log-status');
            if (btn) {
                btn.textContent = 'â–¶ï¸ Starten';
                btn.style.background = '#10b981';
            }
            if (status) {
                status.textContent = '(gestoppt)';
                status.style.color = 'rgba(255,255,255,0.8)';
            }
            
            addLiveLogEntry('system', 'â¹ï¸ Live-Log gestoppt');
            
            console.log('â¹ï¸ Live-Log gestoppt');
        }
        
        function shouldShowLiveLog(type) {
            return liveLogFilters[type] === true;
        }
        
        function updateLiveFilters() {
            liveLogFilters = {
                booking: document.getElementById('live-filter-booking')?.checked ?? true,
                driver: document.getElementById('live-filter-driver')?.checked ?? true,
                assignment: document.getElementById('live-filter-assignment')?.checked ?? true,
                status: document.getElementById('live-filter-status')?.checked ?? true,
                gps: document.getElementById('live-filter-gps')?.checked ?? false,
                system: document.getElementById('live-filter-system')?.checked ?? true
            };
            console.log('ğŸ“‹ Live-Filter aktualisiert:', liveLogFilters);
        }
        
        function displayLiveLogEntry(log) {
            const time = new Date(log.timestamp).toLocaleTimeString('de-DE', {
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
            
            // Farbe basierend auf Typ
            let color = '#00ff00';
            let icon = 'ğŸ“';
            
            switch(log.type) {
                case 'booking':
                    color = '#60a5fa'; // blau
                    icon = 'ğŸ“±';
                    break;
                case 'driver':
                    color = log.action === 'online' ? '#34d399' : '#f87171'; // grÃ¼n/rot
                    icon = 'ğŸš—';
                    break;
                case 'assignment':
                    color = '#fbbf24'; // gelb
                    icon = 'ğŸ¯';
                    break;
                case 'status':
                    if (log.action === 'completed') {
                        color = '#34d399'; // grÃ¼n
                        icon = 'âœ…';
                    } else if (log.action === 'cancelled') {
                        color = '#f87171'; // rot
                        icon = 'ğŸ’¾';
                    } else if (log.action === 'deleted') {
                        color = '#dc2626'; // dunkelrot
                        icon = 'ğŸ—‘ï¸';
                    } else {
                        color = '#a78bfa'; // lila
                        icon = 'ğŸ“±';
                    }
                    break;
                case 'gps':
                    color = log.action === 'active' ? '#34d399' : '#f87171';
                    icon = log.action === 'active' ? 'ğŸ“' : 'ğŸ’¾';
                    break;
                case 'system':
                    // Spezielle Farben fÃ¼r Login/Logout/Telegram
                    if (log.action === 'login') {
                        color = '#22c55e'; // grÃ¼n
                        icon = 'ğŸ”';
                    } else if (log.action === 'logout') {
                        color = '#f97316'; // orange
                        icon = 'ğŸšª';
                    } else if (log.action === 'telegram') {
                        color = '#0088cc'; // telegram-blau
                        icon = 'ğŸ“±';
                    } else if (log.action === 'connection_lost') {
                        color = '#ef4444'; // rot
                        icon = 'âš ï¸';
                    } else if (log.action === 'connection_restored') {
                        color = '#22c55e'; // grÃ¼n
                        icon = 'âœ…';
                    } else {
                        color = '#f482b6'; // pink
                        icon = 'âš™ï¸';
                    }
                    break;
            }
            
            // Device-Info falls vorhanden
            let deviceInfo = '';
            if (log.device) {
                deviceInfo = ` [${log.device.os}/${log.device.browser}]`;
            }
            
            // App-Version falls vorhanden
            let versionInfo = '';
            if (log.data && log.data.appVersion) {
                versionInfo = ` v${log.data.appVersion}`;
            }
            
            // ZusÃ¤tzliche Daten
            let extraInfo = '';
            if (log.data) {
                if (log.data.customer) extraInfo += ` ğŸ’¾${log.data.customer}`;
                // E-Mail bei Fahrer-Logs anzeigen (falls nicht schon in message)
                if (log.data.email && log.type === 'driver' && !log.message.includes(log.data.email)) {
                    extraInfo += ` ğŸ“§${log.data.email}`;
                }
                if (log.data.driver) extraInfo += ` ğŸš—${log.data.driver}`;
                if (log.data.price) extraInfo += ` ğŸ’°${log.data.price}â‚¬`;
            }
            
            const entry = `[${time}] ${icon} ${log.message}${extraInfo}${deviceInfo}${versionInfo}`;
            addLiveLogEntry(log.type, entry, color);
        }
        
        function addLiveLogEntry(type, text, color = '#888') {
            const console = document.getElementById('live-log-console');
            if (!console) return;
            
            const entry = document.createElement('div');
            entry.style.color = color;
            entry.style.marginBottom = '4px';
            entry.style.borderLeft = `3px solid ${color}`;
            entry.style.paddingLeft = '8px';
            entry.textContent = text;
            
            console.appendChild(entry);
            
            // Speichere fÃ¼r Export
            liveLogEntries.push({ time: new Date().toISOString(), type, text });
            
            // Max 200 EintrÃ¤ge behalten
            while (console.children.length > 200) {
                console.removeChild(console.firstChild);
            }
            
            // Auto-Scroll nach unten
            console.scrollTop = console.scrollHeight;
        }
        
        function clearLiveLogConsole() {
            const console = document.getElementById('live-log-console');
            if (console) {
                console.innerHTML = '<div style="color:#888;">// Console geleert...</div>';
            }
            liveLogEntries = [];
        }
        
        function exportLiveLog() {
            const console = document.getElementById('live-log-console');
            if (!console) return;
            
            const text = console.innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert('âœ… Live-Log in Zwischenablage kopiert!');
            }).catch(() => {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('âœ… Live-Log kopiert!');
            });
        }
        
        // ğŸ“œ AKTIVITÃ„TS-PROTOKOLL SYSTEM
        
        /**
         * AktivitÃ¤t loggen
         * @param {string} type - Typ: booking, driver, assignment, status, gps, system
         * @param {string} action - Aktion: created, online, offline, assigned, accepted, etc.
         * @param {string} message - Beschreibung
         * @param {object} data - ZusÃ¤tzliche Daten
         */
        // ğŸ“± DEVICE INFO SAMMELN
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            
            // Betriebssystem erkennen
            let os = 'Unbekannt';
            if (/Android/i.test(ua)) os = 'Android';
            else if (/iPhone|iPad|iPod/i.test(ua)) os = 'iOS';
            else if (/Windows/i.test(ua)) os = 'Windows';
            else if (/Mac/i.test(ua)) os = 'macOS';
            else if (/Linux/i.test(ua)) os = 'Linux';
            
            // Browser erkennen
            let browser = 'Unbekannt';
            if (/Chrome/i.test(ua) && !/Edge/i.test(ua)) browser = 'Chrome';
            else if (/Safari/i.test(ua) && !/Chrome/i.test(ua)) browser = 'Safari';
            else if (/Firefox/i.test(ua)) browser = 'Firefox';
            else if (/Edge/i.test(ua)) browser = 'Edge';
            else if (/Opera|OPR/i.test(ua)) browser = 'Opera';
            
            // Device-Typ
            let device = 'Desktop';
            if (/Mobile|Android|iPhone/i.test(ua)) device = 'Mobile';
            else if (/iPad|Tablet/i.test(ua)) device = 'Tablet';
            
            // Login-Status
            let loginStatus = 'Gast';
            if (currentUser) {
                if (userRole === 'admin') loginStatus = 'Admin';
                else if (userRole === 'driver') loginStatus = 'Fahrer';
                else loginStatus = 'Eingeloggt';
            }
            
            return {
                os: os,
                browser: browser,
                device: device,
                loginStatus: loginStatus,
                appVersion: APP_VERSION,
                screenWidth: window.innerWidth,
                screenHeight: window.innerHeight,
                online: navigator.onLine
            };
        }
        
        async function logActivity(type, action, message, data = {}) {
            if (!isFirebaseReady) {
                console.log('ğŸ“œ Log (offline):', type, action, message);
                return;
            }
            
            // ğŸ“± Device-Infos hinzufÃ¼gen
            const deviceInfo = getDeviceInfo();
            
            const logEntry = {
                timestamp: Date.now(),
                type: type,
                action: action,
                message: message,
                data: data,
                date: new Date().toISOString().split('T')[0],
                // ğŸ“± NEU: Device-Infos
                device: deviceInfo
            };
            
            try {
                await db.ref('activityLog').push(logEntry);
                console.log('ğŸ“œ Logged:', type, action, message);
            } catch (error) {
                console.error('ğŸ’¾ Log Fehler:', error);
            }
        }
        
        // Protokoll laden
        async function loadActivityLog() {
            if (!isFirebaseReady) {
                document.getElementById('activity-log-list').innerHTML = 
                    '<p style="text-align:center;color:#999;">Firebase nicht verbunden</p>';
                return;
            }
            
            try {
                const snapshot = await db.ref('activityLog')
                    .orderByChild('timestamp')
                    .limitToLast(200)
                    .once('value');
                
                const logs = [];
                snapshot.forEach(child => {
                    const log = child.val();
                    log.id = child.key;
                    logs.push(log);
                });
                
                // Neueste zuerst
                logs.reverse();
                
                renderActivityLog(logs);
                updateLogStats(logs);
                
            } catch (error) {
                console.error('ğŸ’¾ Log laden Fehler:', error);
            }
        }
        
        // ğŸ—‘ï¸ GELÃ–SCHTE FAHRTEN LADEN
        async function loadDeletedRides() {
            const container = document.getElementById('deleted-rides-list');
            const filterTime = document.getElementById('deleted-filter-time').value;
            
            if (!container) return;
            container.innerHTML = '<p style="text-align:center;color:#666;">â³ Lade gelÃ¶schte Fahrten...</p>';
            
            if (!isFirebaseReady) {
                container.innerHTML = '<p style="text-align:center;color:#ef4444;">ğŸ’¾ Firebase nicht verbunden</p>';
                return;
            }
            
            try {
                // Lade aus activityLog wo action === 'deleted'
                const snapshot = await db.ref('activityLog')
                    .orderByChild('action')
                    .equalTo('deleted')
                    .once('value');
                
                if (!snapshot.exists()) {
                    container.innerHTML = '<p style="text-align:center;color:#999;">Keine gelÃ¶schten Fahrten gefunden</p>';
                    return;
                }
                
                let deletedRides = [];
                snapshot.forEach(child => {
                    deletedRides.push({
                        id: child.key,
                        ...child.val()
                    });
                });
                
                // Nach Zeit sortieren (neueste zuerst)
                deletedRides.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                
                // Zeit-Filter anwenden
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                const yesterday = today - 86400000;
                const weekAgo = today - 7 * 86400000;
                
                if (filterTime === 'today') {
                    deletedRides = deletedRides.filter(r => r.timestamp >= today);
                } else if (filterTime === 'yesterday') {
                    deletedRides = deletedRides.filter(r => r.timestamp >= yesterday && r.timestamp < today);
                } else if (filterTime === 'week') {
                    deletedRides = deletedRides.filter(r => r.timestamp >= weekAgo);
                }
                
                if (deletedRides.length === 0) {
                    container.innerHTML = '<p style="text-align:center;color:#999;">Keine gelÃ¶schten Fahrten im gewÃ¤hlten Zeitraum</p>';
                    return;
                }
                
                // Render
                let html = '';
                deletedRides.forEach(ride => {
                    const data = ride.data || {};
                    const time = new Date(ride.timestamp);
                    const timeStr = time.toLocaleString('de-DE', {
                        day: '2-digit', month: '2-digit', year: '2-digit',
                        hour: '2-digit', minute: '2-digit'
                    });
                    
                    html += `
                        <div style="background:#fee2e2;padding:12px;border-radius:8px;margin-bottom:10px;border-left:4px solid #ef4444;">
                            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
                                <strong style="color:#dc2626;">ğŸ—‘ï¸ GelÃ¶scht am ${timeStr}</strong>
                            </div>
                            <div style="font-size:13px;color:#333;">
                                <div style="margin-bottom:4px;">ğŸ’¾ <strong>Kunde:</strong> ${data.customer || 'Unbekannt'}</div>
                                <div style="margin-bottom:4px;">ğŸ’¾ <strong>Telefon:</strong> ${data.phone || '-'}</div>
                                <div style="margin-bottom:4px;">ğŸ“ <strong>Von:</strong> ${data.pickup || data.from || '-'}</div>
                                <div style="margin-bottom:4px;">ğŸ“ <strong>Nach:</strong> ${data.destination || data.to || '-'}</div>
                                <div style="margin-bottom:4px;">ğŸ’° <strong>Preis:</strong> ${data.price ? data.price + 'â‚¬' : '-'}</div>
                                <div style="margin-bottom:4px;">ğŸš• <strong>Status war:</strong> ${data.status || '-'}</div>
                                ${data.vehicle ? `<div style="margin-bottom:4px;">ğŸš— <strong>Fahrzeug:</strong> ${data.vehicle}</div>` : ''}
                            </div>
                            <div style="margin-top:8px;padding-top:8px;border-top:1px dashed #fca5a5;font-size:11px;color:#991b1b;">
                                ğŸ—‘ï¸ <strong>GelÃ¶scht von:</strong> ${data.deletedBy || 'Unbekannt'}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = `<div style="font-size:12px;color:#666;margin-bottom:10px;">ğŸ“± ${deletedRides.length} gelÃ¶schte Fahrt${deletedRides.length > 1 ? 'en' : ''} gefunden</div>` + html;
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden gelÃ¶schter Fahrten:', error);
                container.innerHTML = '<p style="text-align:center;color:#ef4444;">ğŸ’¾ Fehler beim Laden</p>';
            }
        }
        
        // Protokoll rendern
        function renderActivityLog(logs) {
            const container = document.getElementById('activity-log-list');
            const filterType = document.getElementById('log-filter-type').value;
            const filterTime = document.getElementById('log-filter-time').value;
            
            // Filtern
            let filtered = logs;
            
            // Nach Typ filtern
            if (filterType !== 'all') {
                if (filterType === 'deleted') {
                    // Spezialfall: GelÃ¶schte Fahrten (action === 'deleted')
                    filtered = filtered.filter(l => l.action === 'deleted');
                } else {
                    filtered = filtered.filter(l => l.type === filterType);
                }
            }
            
            // Nach Zeit filtern
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const yesterday = today - 86400000;
            const weekAgo = today - 7 * 86400000;
            
            if (filterTime === 'today') {
                filtered = filtered.filter(l => l.timestamp >= today);
            } else if (filterTime === 'yesterday') {
                filtered = filtered.filter(l => l.timestamp >= yesterday && l.timestamp < today);
            } else if (filterTime === 'week') {
                filtered = filtered.filter(l => l.timestamp >= weekAgo);
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#999;">Keine EintrÃ¤ge gefunden</p>';
                return;
            }
            
            let html = '';
            filtered.forEach(log => {
                const time = new Date(log.timestamp);
                const timeStr = time.toLocaleString('de-DE', {
                    day: '2-digit', month: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                });
                
                // Icon basierend auf Typ
                let icon = 'ğŸ“';
                let bgColor = '#f3f4f6';
                
                switch(log.type) {
                    case 'booking':
                        icon = 'ğŸ“±';
                        bgColor = '#dbeafe';
                        break;
                    case 'driver':
                        icon = 'ğŸš—';
                        bgColor = log.action === 'online' ? '#dcfce7' : '#fee2e2';
                        break;
                    case 'assignment':
                        icon = 'ğŸ¯';
                        bgColor = '#fef3c7';
                        break;
                    case 'status':
                        if (log.action === 'completed') {
                            icon = 'âœ…';
                            bgColor = '#dcfce7';
                        } else if (log.action === 'cancelled') {
                            icon = 'ğŸ’¾';
                            bgColor = '#fee2e2';
                        } else if (log.action === 'deleted') {
                            icon = 'ğŸ—‘ï¸';
                            bgColor = '#fecaca'; // dunkleres Rot fÃ¼r LÃ¶schung
                        } else {
                            icon = 'ğŸ“±';
                            bgColor = '#e0e7ff';
                        }
                        break;
                    case 'gps':
                        icon = log.action === 'active' ? 'ğŸ“' : 'ğŸ’¾';
                        bgColor = log.action === 'active' ? '#dcfce7' : '#fee2e2';
                        break;
                    case 'system':
                        icon = 'âš™ï¸';
                        bgColor = '#f3e8ff';
                        break;
                }
                
                html += `
                    <div style="background:${bgColor};padding:10px;border-radius:6px;margin-bottom:8px;font-size:13px;">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                            <div>
                                <span style="font-size:16px;">${icon}</span>
                                <strong>${log.message}</strong>
                            </div>
                            <span style="font-size:11px;color:#666;white-space:nowrap;">${timeStr}</span>
                        </div>
                        ${log.data && Object.keys(log.data).length > 0 ? `
                            <div style="font-size:11px;color:#666;margin-top:5px;">
                                ${log.data.customer ? `ğŸ’¾ ${log.data.customer}` : ''}
                                ${log.data.email ? `ğŸ“§ ${log.data.email}` : ''}
                                ${log.data.phone ? ` â€¢ ğŸ’¾ ${log.data.phone}` : ''}
                                ${log.data.driver ? ` â€¢ ğŸš— ${log.data.driver}` : ''}
                                ${log.data.vehicle ? ` â€¢ ${log.data.vehicle}` : ''}
                                ${log.data.price ? ` â€¢ ğŸ’° ${log.data.price}â‚¬` : ''}
                                ${log.data.from || log.data.pickup ? `<br>ğŸ“ ${log.data.from || log.data.pickup}` : ''}
                                ${log.data.to || log.data.destination ? ` â†’ ${log.data.to || log.data.destination}` : ''}
                                ${log.data.deletedBy ? `<br>ğŸ—‘ï¸ <strong>GelÃ¶scht von:</strong> ${log.data.deletedBy}` : ''}
                                ${log.data.reason ? `<br>â„¹ï¸ Grund: ${log.data.reason}` : ''}
                            </div>
                        ` : ''}
                        ${log.device ? `
                            <div style="font-size:10px;color:#999;margin-top:5px;padding-top:5px;border-top:1px dashed #ddd;">
                                ğŸ“± ${log.device.os} (${log.device.browser}) â€¢ 
                                ${log.device.device} â€¢ 
                                ğŸ” ${log.device.loginStatus} â€¢ 
                                ğŸ“¦ v${log.device.appVersion}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Statistiken aktualisieren
        function updateLogStats(logs) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayTimestamp = today.getTime();
            
            const todayLogs = logs.filter(l => l.timestamp >= todayTimestamp);
            
            const bookings = todayLogs.filter(l => l.type === 'booking' && l.action === 'created').length;
            const completed = todayLogs.filter(l => l.type === 'status' && l.action === 'completed').length;
            const deleted = todayLogs.filter(l => l.action === 'deleted').length;
            
            // Fahrer online zÃ¤hlen (aus drivers-Objekt)
            let onlineCount = 0;
            if (typeof drivers !== 'undefined') {
                for (const id in drivers) {
                    if (drivers[id] && drivers[id].online) onlineCount++;
                }
            }
            
            document.getElementById('log-stat-bookings').textContent = bookings;
            document.getElementById('log-stat-completed').textContent = completed;
            document.getElementById('log-stat-online').textContent = onlineCount;
            document.getElementById('log-stat-deleted').textContent = deleted;
        }
        
        // Filter anwenden
        function filterActivityLog() {
            loadActivityLog();
        }
        
        // Protokoll exportieren
        async function exportActivityLog() {
            if (!isFirebaseReady) return;
            
            try {
                const snapshot = await db.ref('activityLog')
                    .orderByChild('timestamp')
                    .once('value');
                
                const logs = [];
                snapshot.forEach(child => {
                    logs.push(child.val());
                });
                
                // Als CSV mit Device-Infos
                let csv = 'Datum;Uhrzeit;Typ;Aktion;Nachricht;Kunde;Fahrer;Preis;Betriebssystem;Browser;GerÃ¤t;Login-Status;App-Version\n';
                logs.forEach(log => {
                    const time = new Date(log.timestamp);
                    csv += `${time.toLocaleDateString('de-DE')};`;
                    csv += `${time.toLocaleTimeString('de-DE')};`;
                    csv += `${log.type};`;
                    csv += `${log.action};`;
                    csv += `"${log.message}";`;
                    csv += `${log.data?.customer || ''};`;
                    csv += `${log.data?.driver || ''};`;
                    csv += `${log.data?.price || ''};`;
                    // Device-Infos
                    csv += `${log.device?.os || ''};`;
                    csv += `${log.device?.browser || ''};`;
                    csv += `${log.device?.device || ''};`;
                    csv += `${log.device?.loginStatus || ''};`;
                    csv += `${log.device?.appVersion || ''}\n`;
                });
                
                // Download
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `aktivitaetsprotokoll_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                
                alert('âœ… Protokoll exportiert!');
                
            } catch (error) {
                console.error('ğŸ’¾ Export Fehler:', error);
                alert('ğŸ’¾ Export fehlgeschlagen');
            }
        }
        
        // Protokoll leeren
        async function clearActivityLog() {
            if (!confirm('ğŸ—‘ï¸ Gesamtes AktivitÃ¤ts-Protokoll wirklich lÃ¶schen?\n\nDiese Aktion kann nicht rÃ¼ckgÃ¤ngig gemacht werden!')) {
                return;
            }
            
            try {
                await db.ref('activityLog').remove();
                loadActivityLog();
                alert('âœ… Protokoll gelÃ¶scht!');
                
                // Selbst loggen
                logActivity('system', 'cleared', 'Protokoll wurde geleert');
                
            } catch (error) {
                console.error('ğŸ’¾ LÃ¶schen Fehler:', error);
                alert('ğŸ’¾ LÃ¶schen fehlgeschlagen');
            }
        }
        
        // ğŸš— FAHRZEUG-VERWALTUNG
        async function loadVehiclesFromFirebase() {
            if (!isFirebaseReady) return;
            
            try {
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('ğŸ”¥ v5.90.372: LADE FAHRZEUGE MIT AUTO-CLEANUP');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
                const snapshot = await db.ref('vehicles').once('value');
                const data = snapshot.val();
                
                if (!data) {
                    // Keine Daten â†’ Initialisiere mit offiziellen Fahrzeugen
                    console.log('ğŸ“ Keine Fahrzeuge in Firebase â†’ Initialisiere...');
                    await db.ref('vehicles').set(OFFICIAL_VEHICLES);
                    VEHICLES = { ...OFFICIAL_VEHICLES };
                    
                    // FÃ¼ge .id zu jedem Fahrzeug hinzu
                    Object.keys(VEHICLES).forEach(key => {
                        VEHICLES[key].id = key;
                    });
                    
                    console.log('âœ… Offizielle Fahrzeuge in Firebase gespeichert');
                    updateVehicleDropdowns();
                    return;
                }
                
                // ğŸ§¹ CLEANUP: LÃ¶sche alle Fahrzeuge die NICHT in der Whitelist sind!
                const keysInFirebase = Object.keys(data);
                const officialKeys = Object.keys(OFFICIAL_VEHICLES);
                
                console.log('ğŸ“‹ Fahrzeuge in Firebase:', keysInFirebase);
                console.log('âœ… Erlaubte Fahrzeuge:', officialKeys);
                
                let deletedCount = 0;
                for (const key of keysInFirebase) {
                    if (!officialKeys.includes(key)) {
                        console.log('ğŸ—‘ï¸ LÃ–SCHE unerlaubtes Fahrzeug:', key);
                        await db.ref(`vehicles/${key}`).remove();
                        deletedCount++;
                    }
                }
                
                if (deletedCount > 0) {
                    console.log(`âœ… ${deletedCount} unerlaubte Fahrzeuge gelÃ¶scht!`);
                }
                
                // ğŸ”§ Lade offizielle Fahrzeuge und merge mit Firebase-Daten
                VEHICLES = {};
                
                for (const key of officialKeys) {
                    const officialData = OFFICIAL_VEHICLES[key];
                    const firebaseData = data[key] || {};
                    
                    // Merge: Offizielle Daten haben Vorrang fÃ¼r name/plate!
                    VEHICLES[key] = {
                        id: key,  // IMMER setzen!
                        name: officialData.name,  // Aus OFFICIAL_VEHICLES
                        plate: officialData.plate,  // Aus OFFICIAL_VEHICLES
                        priority: officialData.priority,
                        // ZusÃ¤tzliche Daten aus Firebase (GPS, online, etc.)
                        lat: firebaseData.lat,
                        lon: firebaseData.lon,
                        online: firebaseData.online || false,
                        timestamp: firebaseData.timestamp,
                        lastUpdate: firebaseData.lastUpdate
                    };
                    
                    console.log(`âœ… ${key}: ${VEHICLES[key].name} (${VEHICLES[key].plate})`);
                }
                
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log(`ğŸš— ${Object.keys(VEHICLES).length} Fahrzeuge geladen!`);
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
                // ğŸ”¥ v5.90.373: Cleanup /monitoring/drivers/ von unerlaubten Fahrzeugen!
                await cleanupMonitoringDrivers();
                
                // Aktualisiere Fahrer-Dropdown falls vorhanden
                updateVehicleDropdowns();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der Fahrzeuge:', error);
            }
        }
        
        // ğŸ”¥ v5.90.375: Cleanup /monitoring/drivers/ + BESSERES LOGGING!
        async function cleanupMonitoringDrivers() {
            try {
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('ğŸ§¹ v5.90.375: CLEANUP /monitoring/drivers/');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
                const snapshot = await db.ref('monitoring/drivers').once('value');
                const data = snapshot.val();
                
                if (!data) {
                    console.log('âœ… Keine Monitoring-Daten vorhanden');
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    return;
                }
                
                const monitoredVehicles = Object.keys(data);
                const officialKeys = Object.keys(OFFICIAL_VEHICLES);
                
                console.log('ğŸ“± Monitoring-Daten:');
                console.log('   Monitored:', monitoredVehicles.join(', '));
                console.log('   Official:', officialKeys.join(', '));
                
                let deletedCount = 0;
                for (const vehicleId of monitoredVehicles) {
                    if (!officialKeys.includes(vehicleId)) {
                        const vehicleName = data[vehicleId]?.vehicle || vehicleId;
                        console.log(`ğŸ—‘ï¸ LÃ–SCHE: ${vehicleName} (${vehicleId}) - NICHT IN WHITELIST!`);
                        await db.ref(`monitoring/drivers/${vehicleId}`).remove();
                        deletedCount++;
                    } else {
                        console.log(`âœ… BEHALTEN: ${vehicleId} - in Whitelist`);
                    }
                }
                
                if (deletedCount > 0) {
                    console.log('');
                    console.log(`âœ… ${deletedCount} unerlaubte Monitoring-EintrÃ¤ge gelÃ¶scht!`);
                } else {
                    console.log('');
                    console.log('âœ… Alle Monitoring-EintrÃ¤ge sind sauber!');
                }
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Cleanup von Monitoring:', error);
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            }
        }
        
        // ğŸ†• v5.90.300: ISARFUNK Vehicle Select!
        // ğŸ†• v5.90.366: SELECT VEHICLE WITH ERROR HANDLING
        function selectVehicleIsarfunk(vehicleId) {
            try {
                console.log('ğŸš— v5.90.366: Fahrzeug gewÃ¤hlt:', vehicleId);
                
                if (!vehicleId) {
                    console.error('ğŸ’¾ Keine Fahrzeug-ID Ã¼bergeben!');
                    alert('ğŸ’¾ Fehler: Keine Fahrzeug-ID!');
                    return;
                }
                
                const select = document.getElementById('vehicle');
                if (select) {
                    select.value = vehicleId;
                } else {
                    console.warn('âš ï¸ Vehicle select element not found');
                }
                
                // ğŸ†• v5.90.366: setVehicle mit Try-Catch
                try {
                    setVehicle();
                } catch (e) {
                    console.error('ğŸ’¾ Fehler in setVehicle():', e);
                    alert('ğŸ’¾ Fehler beim Setzen des Fahrzeugs!');
                    return;
                }
                
                // ğŸ†• v5.90.366: updateDriverViewIsarfunk mit Try-Catch
                try {
                    updateDriverViewIsarfunk();
                } catch (e) {
                    console.error('ğŸ’¾ Fehler in updateDriverViewIsarfunk():', e);
                    // View sollte trotzdem laden, nur ohne Update
                }
                
                console.log('âœ… v5.90.366: Fahrzeug erfolgreich gesetzt!');
            } catch (error) {
                console.error('ğŸ’¥ CRITICAL ERROR in selectVehicleIsarfunk:', error);
                alert('ğŸ’¾ Fehler beim AuswÃ¤hlen des Fahrzeugs!\n\nBitte Seite neu laden.');
            }
        }
        
        // ğŸ†• v5.90.294: TESLA-BUTTON SELECT!
        function selectVehicleButton(vehicleId) {
            console.log('ğŸš— Tesla-Button geklickt:', vehicleId);
            
            // Setze hidden select
            const select = document.getElementById('vehicle');
            if (select) {
                select.value = vehicleId;
            }
            
            // Rufe setVehicle auf
            setVehicle();
            
            // Update Button-Grid (neu rendern mit selected state)
            updateVehicleDropdowns();
        }
        
        function updateVehicleDropdowns() {
            console.log('ğŸ”„ Update Vehicle Dropdowns, Fahrzeuge:', Object.keys(VEHICLES).length);
            
            // ğŸ†• v5.90.300: ISARFUNK BUTTON-GRID!
            const buttonGridIsarfunk = document.getElementById('vehicle-grid-isarfunk');
            if (buttonGridIsarfunk) {
                const sortedVehicles = Object.values(VEHICLES).sort((a, b) => {
                    const prioA = a.priority || 5;
                    const prioB = b.priority || 5;
                    return prioA - prioB;
                });
                
                buttonGridIsarfunk.innerHTML = sortedVehicles.map(v => {
                    const name = v.name || 'Unbekannt';
                    const icon = name.toLowerCase().includes('bus') ? 'ğŸš' : 
                                name.toLowerCase().includes('tesla') ? 'âš¡' : 'ğŸš—';
                    return `
                        <button onclick="selectVehicleIsarfunk('${v.id}')" style="
                            padding: 20px;
                            background: white;
                            color: #1f2937;
                            border: 3px solid #e5e7eb;
                            border-radius: 12px;
                            font-size: 16px;
                            font-weight: 700;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            gap: 12px;
                        ">
                            <span style="font-size: 32px;">${icon}</span>
                            <div style="flex: 1; text-align: left;">
                                <div style="font-size: 18px; font-weight: 900;">${v.plate || v.name}</div>
                                <div style="font-size: 13px; opacity: 0.7;">${v.name}</div>
                            </div>
                            <span style="font-size: 20px; color: #10b981;">â†’</span>
                        </button>
                    `;
                }).join('');
            }
            
            // ğŸ†• v5.90.295: NEUE BUTTON-GRID fÃ¼r Modal!
            const buttonGridNew = document.getElementById('vehicle-button-grid-new');
            if (buttonGridNew) {
                const sortedVehicles = Object.values(VEHICLES).sort((a, b) => {
                    const prioA = a.priority || 5;
                    const prioB = b.priority || 5;
                    return prioA - prioB;
                });
                
                buttonGridNew.innerHTML = sortedVehicles.map(v => {
                    const name = v.name || 'Unbekannt';
                    const icon = name.toLowerCase().includes('bus') || name.toLowerCase().includes('pax') ? 'ğŸš' : 
                                name.toLowerCase().includes('model y') ? 'ğŸš™' : 
                                name.toLowerCase().includes('tesla') ? 'âš¡' : 'ğŸš—';
                    return `
                        <button onclick="selectVehicleButtonNew('${v.id}')" style="
                            padding: 24px;
                            background: white;
                            color: #1f2937;
                            border: 3px solid #e5e7eb;
                            border-radius: 16px;
                            font-size: 18px;
                            font-weight: 700;
                            cursor: pointer;
                            transition: all 0.2s;
                            display: flex;
                            align-items: center;
                            gap: 16px;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        " onmouseover="this.style.transform='scale(1.02)'; this.style.borderColor='#10b981'" onmouseout="this.style.transform='scale(1)'; this.style.borderColor='#e5e7eb'">
                            <span style="font-size: 36px;">${icon}</span>
                            <div style="flex: 1; text-align: left;">
                                <div style="font-size: 20px; font-weight: 900;">${v.plate || v.name}</div>
                                <div style="font-size: 14px; opacity: 0.7;">${v.name}</div>
                            </div>
                            <span style="font-size: 24px; color: #10b981;">â†’</span>
                        </button>
                    `;
                }).join('');
            }
            
            // Hidden Select fÃ¼r KompatibilitÃ¤t
            const driverSelect = document.getElementById('vehicle');
            if (driverSelect) {
                const currentValue = driverSelect.value;
                driverSelect.innerHTML = '<option value="">Fahrzeug wÃ¤hlen</option>';
                
                const sortedVehicles = Object.values(VEHICLES).sort((a, b) => {
                    const prioA = a.priority || 5;
                    const prioB = b.priority || 5;
                    return prioA - prioB;
                });
                
                sortedVehicles.forEach(v => {
                    const name = v.name || 'Unbekannt';
                    const icon = name.toLowerCase().includes('bus') || name.toLowerCase().includes('pax') ? 'ğŸš' : 
                                name.toLowerCase().includes('model y') ? 'ğŸš™' : 'ğŸš—';
                    driverSelect.innerHTML += `<option value="${v.id}" ${v.id === currentValue ? 'selected' : ''}>${icon} ${v.plate || name}</option>`;
                });
            }
            
            // Aktualisiere alle Fahrzeug-Dropdowns in der App
            const selects = document.querySelectorAll('#edit-ride-modal select, .vehicle-select');
            selects.forEach(select => {
                if (select.id === 'edit-vehicle' || select.classList.contains('vehicle-select')) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">-- Fahrzeug wÃ¤hlen --</option>';
                    Object.values(VEHICLES).forEach(v => {
                        select.innerHTML += `<option value="${v.id}" ${v.id === currentValue ? 'selected' : ''}>${v.name} (${v.plate})</option>`;
                    });
                }
            });
        }
        
        function renderVehicles() {
            const container = document.getElementById('vehicles-list');
            if (!container) return;
            
            if (Object.keys(VEHICLES).length === 0) {
                container.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">Keine Fahrzeuge vorhanden</div>';
                return;
            }
            
            let html = '';
            Object.values(VEHICLES).forEach(v => {
                const priorityIcon = v.priority === 1 ? 'â­â­â­' : v.priority === 10 ? 'â­' : 'â­â­';
                const priorityText = v.priority === 1 ? 'Hoch' : v.priority === 10 ? 'Niedrig' : 'Normal';
                html += `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:#f8fafc;border-radius:8px;margin-bottom:8px;border-left:4px solid #f59e0b;">
                        <div>
                            <div style="font-weight:600;color:#1e293b;">${v.name}</div>
                            <div style="font-size:13px;color:#64828b;">ğŸš— ${v.plate}</div>
                            <div style="font-size:11px;color:#9ca3af;margin-top:2px;">${priorityIcon} ${priorityText}</div>
                        </div>
                        <div style="display:flex;gap:8px;">
                            <button onclick="editVehicle('${v.id}')" style="padding:8px 12px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;">âœï¸</button>
                            <button onclick="deleteVehicle('${v.id}')" style="padding:8px 12px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function showAddVehicleModal(vehicleId = null) {
            const vehicle = vehicleId ? VEHICLES[vehicleId] : null;
            const isEdit = !!vehicle;
            
            const modal = document.createElement('div');
            modal.id = 'vehicle-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;';
            
            modal.innerHTML = `
                <div style="background:white;padding:25px;border-radius:12px;width:90%;max-width:400px;box-shadow:0 10px 40px rgba(0,0,0,0.3);">
                    <h3 style="margin:0 0 20px 0;">${isEdit ? 'âœï¸ Fahrzeug bearbeiten' : 'â• Neues Fahrzeug'}</h3>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block;font-weight:600;margin-bottom:5px;">Fahrzeug-Name *</label>
                        <input type="text" id="vehicle-name" value="${vehicle ? vehicle.name : ''}" placeholder="z.B. Tesla Model 3 #1" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;box-sizing:border-box;">
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block;font-weight:600;margin-bottom:5px;">Kennzeichen *</label>
                        <input type="text" id="vehicle-plate" value="${vehicle ? vehicle.plate : ''}" placeholder="z.B. PW-TX 111" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;box-sizing:border-box;">
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block;font-weight:600;margin-bottom:5px;">PrioritÃ¤t</label>
                        <select id="vehicle-priority" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;box-sizing:border-box;">
                            <option value="1" ${vehicle && vehicle.priority === 1 ? 'selected' : ''}>â­â­â­ Hoch (z.B. Tesla, Prius IK)</option>
                            <option value="5" ${!vehicle || vehicle.priority === 5 ? 'selected' : ''}>â­â­ Normal (Standard-Fahrzeuge)</option>
                            <option value="10" ${vehicle && vehicle.priority === 10 ? 'selected' : ''}>â­ Niedrig (Reserve-Fahrzeuge)</option>
                        </select>
                        <div style="font-size:11px;color:#666;margin-top:4px;">Hohe PrioritÃ¤t = Erscheint zuerst in Liste</div>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <label style="display:block;font-weight:600;margin-bottom:5px;">Fahrzeug-ID</label>
                        <input type="text" id="vehicle-id" value="${vehicle ? vehicle.id : ''}" placeholder="z.B. tesla_model3_1" ${isEdit ? 'readonly style="background:#f3f4f6;"' : ''} style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;box-sizing:border-box;">
                        <div style="font-size:11px;color:#666;margin-top:4px;">Eindeutige ID (ohne Leerzeichen)</div>
                    </div>
                    
                    <div style="display:flex;gap:10px;">
                        <button onclick="document.getElementById('vehicle-modal').remove()" style="flex:1;padding:12px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Abbrechen</button>
                        <button onclick="saveVehicle('${vehicleId || ''}')" style="flex:1;padding:12px;background:#f59e0b;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">${isEdit ? 'Speichern' : 'HinzufÃ¼gen'}</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function editVehicle(vehicleId) {
            showAddVehicleModal(vehicleId);
        }
        
        async function saveVehicle(existingId) {
            const name = document.getElementById('vehicle-name').value.trim();
            const plate = document.getElementById('vehicle-plate').value.trim();
            const priority = parseInt(document.getElementById('vehicle-priority').value) || 5;
            
            if (!name || !plate) {
                alert('ğŸ’¾ Bitte Name und Kennzeichen eingeben!');
                return;
            }
            
            // ğŸ†• v5.90.262: ID = Normalisiertes Kennzeichen!
            const id = normalizeVehicleId(plate);
            
            if (!id) {
                alert('ğŸ’¾ UngÃ¼ltiges Kennzeichen!');
                return;
            }
            
            // PrÃ¼fe ob ID schon existiert (nur bei neuem Fahrzeug)
            if (!existingId && VEHICLES[id]) {
                alert('ğŸ’¾ Dieses Kennzeichen existiert bereits!');
                return;
            }
            
            const vehicle = { id, name, plate, priority };
            
            try {
                // Speichere in Firebase
                await db.ref('vehicles/' + id).set(vehicle);
                
                // LÃ¶sche altes Fahrzeug falls ID geÃ¤ndert wurde
                if (existingId && existingId !== id) {
                    await db.ref('vehicles/' + existingId).remove();
                    delete VEHICLES[existingId];
                }
                
                VEHICLES[id] = vehicle;
                
                console.log('âœ… Fahrzeug gespeichert:', vehicle);
                alert('âœ… Fahrzeug gespeichert!');
                
                document.getElementById('vehicle-modal').remove();
                renderVehicles();
                updateVehicleDropdowns();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Speichern:', error);
                alert('ğŸ’¾ Fehler beim Speichern!');
            }
        }
        
        async function deleteVehicle(vehicleId) {
            const vehicle = VEHICLES[vehicleId];
            if (!vehicle) return;
            
            if (!confirm(`ğŸ—‘ï¸ Fahrzeug "${vehicle.name}" wirklich lÃ¶schen?`)) return;
            
            try {
                await db.ref('vehicles/' + vehicleId).remove();
                delete VEHICLES[vehicleId];
                
                console.log('ğŸ—‘ï¸ Fahrzeug gelÃ¶scht:', vehicleId);
                alert('âœ… Fahrzeug gelÃ¶scht!');
                
                renderVehicles();
                updateVehicleDropdowns();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim LÃ¶schen:', error);
                alert('ğŸ’¾ Fehler beim LÃ¶schen!');
            }
        }
        
        // ğŸ‘¥ BENUTZER-VERWALTUNG
        let allUsers = [];
        
        async function loadAllUsers() {
            if (!isFirebaseReady) {
                alert('ğŸ’¾ Firebase nicht verbunden!');
                return;
            }
            
            try {
                const snapshot = await db.ref('users').once('value');
                allUsers = [];
                snapshot.forEach(child => {
                    const user = child.val();
                    user.uid = child.key;
                    allUsers.push(user);
                });
                
                console.log('ğŸ‘¥ Benutzer geladen:', allUsers.length);
                renderUsersList(allUsers);
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der Benutzer:', error);
                alert('ğŸ’¾ Fehler beim Laden der Benutzer');
            }
        }
        
        function searchUsers() {
            const query = document.getElementById('user-search').value.toLowerCase();
            const filtered = allUsers.filter(u => 
                (u.email && u.email.toLowerCase().includes(query)) ||
                (u.displayName && u.displayName.toLowerCase().includes(query))
            );
            renderUsersList(filtered);
        }
        
        // ğŸš— Fahrzeug-Liste
        const vehicles = ['Tesla #1', 'Tesla #2', 'Tesla #3', 'Tesla #4', 'Tesla #5'];
        
        // â• NEUER MITARBEITER
        function showAddUserModal() {
            const modal = document.createElement('div');
            modal.id = 'add-user-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;width:90%;max-width:400px;">
                    <h3 style="margin:0 0 15px 0;">â• Neuer Mitarbeiter</h3>
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        <div>
                            <label style="font-size:12px;color:#666;">Name *</label>
                            <input type="text" id="new-user-name" placeholder="Max Mustermann" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                        </div>
                        <div>
                            <label style="font-size:12px;color:#666;">Email *</label>
                            <input type="email" id="new-user-email" placeholder="fahrer@gmail.com" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                        </div>
                        <div>
                            <label style="font-size:12px;color:#666;">Telefon</label>
                            <input type="text" id="new-user-phone" placeholder="0173 1234827" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                        </div>
                        <div>
                            <label style="font-size:12px;color:#666;">Rolle *</label>
                            <select id="new-user-role" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                                <option value="fahrgast">Fahrgast</option>
                                <option value="fahrer" selected>Fahrer</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size:12px;color:#666;">Fahrzeug (fÃ¼r Fahrer)</label>
                            <select id="new-user-vehicle" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                                <option value="">-- Kein Fahrzeug --</option>
                                ${vehicles.map(v => `<option value="${v}">${v}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div style="background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;padding:10px;margin-top:15px;font-size:12px;">
                        âš ï¸ Der Mitarbeiter muss sich spÃ¤ter selbst mit dieser Email registrieren. Die Rolle wird automatisch zugewiesen.
                    </div>
                    <div style="display:flex;gap:10px;margin-top:15px;">
                        <button onclick="saveNewUser()" style="flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">ğŸ’¾ Speichern</button>
                        <button onclick="closeAddUserModal()" style="flex:1;padding:12px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Abbrechen</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeAddUserModal() {
            const modal = document.getElementById('add-user-modal');
            if (modal) modal.remove();
        }
        
        async function saveNewUser() {
            const name = document.getElementById('new-user-name').value.trim();
            const email = document.getElementById('new-user-email').value.trim();
            const role = document.getElementById('new-user-role').value;
            
            if (!name || !email) {
                alert('ğŸ’¾ Name und Email sind erforderlich!');
                return;
            }
            
            // Erstelle vorab einen Eintrag - wird mit echtem UID verknÃ¼pft wenn User sich registriert
            const userData = {
                displayName: name,
                email: email,
                phone: document.getElementById('new-user-phone').value.trim(),
                role: role,
                vehicle: document.getElementById('new-user-vehicle').value,
                preRegistered: true,
                createdAt: Date.now()
            };
            
            try {
                // Speichere unter Email als Key (wird spÃ¤ter mit UID verknÃ¼pft)
                const emailKey = email.replace(/\./g, '_').replace(/@/g, '_at_');
                await db.ref('preRegisteredUsers/' + emailKey).set(userData);
                console.log('âœ… Mitarbeiter vorregistriert:', email);
                closeAddUserModal();
                alert('âœ… Mitarbeiter "' + name + '" wurde angelegt!\n\nDer Mitarbeiter kann sich jetzt mit ' + email + ' registrieren und bekommt automatisch die Rolle "' + role + '".');
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler beim Speichern');
            }
        }
        
        function renderUsersList(users) {
            const container = document.getElementById('users-list');
            
            if (users.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">Keine Benutzer gefunden</div>';
                return;
            }
            
            container.innerHTML = users.map(user => {
                const roleOptions = ['fahrgast', 'fahrer', 'admin'];
                const currentRole = user.role || 'fahrgast';
                
                return `
                    <div style="background:white;border:1px solid #e0e0e0;border-radius:8px;padding:12px;margin-bottom:10px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div style="flex:1;">
                                <div style="font-weight:600;">${user.displayName || 'Unbekannt'}</div>
                                <div style="font-size:12px;color:#666;">${user.email}</div>
                                ${user.phone ? `<div style="font-size:11px;color:#888;">ğŸ’¾ ${user.phone}</div>` : ''}
                                ${user.vehicle ? `<div style="font-size:11px;color:#10b981;">ğŸš— ${user.vehicle}</div>` : ''}
                                <div style="font-size:10px;color:#999;">Letzter Login: ${user.lastLogin ? new Date(user.lastLogin).toLocaleString('de-DE') : 'Nie'}</div>
                            </div>
                            <div style="display:flex;flex-direction:column;gap:5px;align-items:flex-end;">
                                <select onchange="changeUserRole('${user.uid}', this.value)" style="padding:6px;border:2px solid #e0e0e0;border-radius:6px;font-size:12px;">
                                    ${roleOptions.map(role => `<option value="${role}" ${currentRole === role ? 'selected' : ''}>${role.charAt(0).toUpperCase() + role.slice(1)}</option>`).join('')}
                                </select>
                                <button onclick="editUser('${user.uid}')" style="padding:6px 10px;background:#3b82f6;color:white;border:none;border-radius:6px;font-size:11px;cursor:pointer;">
                                    âœï¸ Bearbeiten
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function editUser(uid) {
            const user = allUsers.find(u => u.uid === uid);
            if (!user) return;
            
            const currentVehicle = user.vehicle || '';
            
            const modal = document.createElement('div');
            modal.id = 'edit-user-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;width:90%;max-width:400px;">
                    <h3 style="margin:0 0 15px 0;">âœï¸ Mitarbeiter bearbeiten</h3>
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        <div>
                            <label style="font-size:12px;color:#666;">Name</label>
                            <input type="text" id="edit-user-name" value="${user.displayName || ''}" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                        </div>
                        <div>
                            <label style="font-size:12px;color:#666;">Email (nicht Ã¤nderbar)</label>
                            <input type="text" value="${user.email}" disabled style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;background:#f3f4f6;">
                        </div>
                        <div>
                            <label style="font-size:12px;color:#666;">Telefon</label>
                            <input type="text" id="edit-user-phone" value="${user.phone || ''}" placeholder="0173 1234827" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                        </div>
                        <div>
                            <label style="font-size:12px;color:#666;">Fahrzeug (fÃ¼r Fahrer)</label>
                            <select id="edit-user-vehicle" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                                <option value="">-- Kein Fahrzeug --</option>
                                ${vehicles.map(v => `<option value="${v}" ${currentVehicle === v ? 'selected' : ''}>${v}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div style="display:flex;gap:10px;margin-top:15px;">
                        <button onclick="saveUser('${uid}')" style="flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">ğŸ’¾ Speichern</button>
                        <button onclick="closeEditUserModal()" style="flex:1;padding:12px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Abbrechen</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeEditUserModal() {
            const modal = document.getElementById('edit-user-modal');
            if (modal) modal.remove();
        }
        
        async function saveUser(uid) {
            const updates = {
                displayName: document.getElementById('edit-user-name').value.trim(),
                phone: document.getElementById('edit-user-phone').value.trim(),
                vehicle: document.getElementById('edit-user-vehicle').value
            };
            
            try {
                await db.ref('users/' + uid).update(updates);
                console.log('âœ… Benutzer aktualisiert');
                closeEditUserModal();
                loadAllUsers();
                alert('âœ… Benutzer aktualisiert!');
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler beim Speichern');
            }
        }
        
        async function changeUserRole(uid, newRole) {
            if (!isFirebaseReady) return;
            
            try {
                await db.ref('users/' + uid).update({ role: newRole });
                console.log('âœ… Rolle geÃ¤ndert:', uid, 'â†’', newRole);
                
                // Update lokale Liste
                const user = allUsers.find(u => u.uid === uid);
                if (user) user.role = newRole;
                
                alert('âœ… Rolle geÃ¤ndert zu: ' + newRole);
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Ã„ndern der Rolle:', error);
                alert('ğŸ’¾ Fehler beim Ã„ndern der Rolle');
            }
        }
        
        // ğŸ“‹ STAMMKUNDEN-CRM FUNKTIONEN
        // ğŸ†• v5.90.142: ZENTRALE KUNDEN-LADE-FUNKTION!
        // Diese Funktion wird von ALLEN anderen Funktionen verwendet!
        async function getCustomer(customerId) {
            console.log('ğŸ” v5.90.142: getCustomer aufgerufen fÃ¼r:', customerId);
            
            // 1. PrÃ¼fe ob Kunde in allCustomers ist
            let customer = allCustomers.find(c => c.id === customerId);
            
            if (customer) {
                console.log('âœ… Kunde bereits in allCustomers:', customer.name);
                return customer;
            }
            
            // 2. Nicht gefunden? Lade aus Firebase!
            console.log('âš ï¸ Kunde nicht in allCustomers - lade aus Firebase...');
            
            if (!isFirebaseReady) {
                console.error('ğŸ’¾ Firebase nicht bereit!');
                return null;
            }
            
            try {
                const snapshot = await db.ref(`customers/${customerId}`).once('value');
                const customerData = snapshot.val();
                
                if (!customerData) {
                    console.error('ğŸ’¾ Kunde nicht in Firebase gefunden:', customerId);
                    return null;
                }
                
                // 3. FÃ¼ge ID hinzu
                customer = { ...customerData, id: customerId };
                
                // 4. FÃ¼ge zu allCustomers hinzu
                allCustomers.push(customer);
                console.log('âœ… Kunde aus Firebase geladen und zu allCustomers hinzugefÃ¼gt:', customer.name);
                
                return customer;
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden:', error);
                return null;
            }
        }
        
        let allCustomers = [];
        let allAppUsers = [];
        let allPOIs = []; // ğŸ†• v5.87.75: FRÃœH initialisieren fÃ¼r Autocomplete!
        let currentCrmTab = 'customers';
        
        function switchCrmTab(tab) {
            currentCrmTab = tab;
            const customersTab = document.getElementById('crm-tab-customers');
            const usersTab = document.getElementById('crm-tab-users');
            
            if (tab === 'customers') {
                customersTab.style.background = '#10b981';
                customersTab.style.color = 'white';
                usersTab.style.background = '#f3f4f6';
                usersTab.style.color = '#333';
                loadAllCustomers();
            } else {
                usersTab.style.background = '#3b82f6';
                usersTab.style.color = 'white';
                customersTab.style.background = '#f3f4f6';
                customersTab.style.color = '#333';
                loadAllAppUsers();
            }
        }
        
        async function loadAllAppUsers() {
            if (!isFirebaseReady) {
                alert('ğŸ’¾ Firebase nicht verbunden!');
                return;
            }
            
            const container = document.getElementById('customers-list');
            container.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">â³ Lade App-User...</div>';
            
            try {
                const snapshot = await db.ref('users').once('value');
                allAppUsers = [];
                snapshot.forEach(child => {
                    const user = child.val();
                    user.uid = child.key;
                    allAppUsers.push(user);
                });
                
                // Sortiere nach Registrierung (neueste zuerst)
                allAppUsers.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                
                console.log('ğŸ“± App-User geladen:', allAppUsers.length);
                renderAppUsersList(allAppUsers);
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der User:', error);
                container.innerHTML = '<div style="text-align:center;color:red;padding:20px;">ğŸ’¾ Fehler beim Laden</div>';
            }
        }
        
        function renderAppUsersList(users) {
            const container = document.getElementById('customers-list');
            
            if (users.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">Keine App-User gefunden</div>';
                return;
            }
            
            container.innerHTML = users.map(u => {
                const createdDate = u.createdAt ? new Date(u.createdAt).toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'}) : 'Unbekannt';
                const lastLogin = u.lastLogin ? new Date(u.lastLogin).toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'}) : 'Nie';
                
                // Login-Methode ermitteln
                let loginMethod = 'â“';
                if (u.phone) loginMethod = 'ğŸ“± Telefon';
                else if (u.email && u.email.includes('@')) loginMethod = 'âœ‰ï¸ E-Mail';
                if (u.providerId === 'google.com') loginMethod = 'ğŸ”µ Google';
                
                // Rolle mit Farbe
                let roleColor = '#666';
                let roleText = u.role || 'Fahrgast';
                if (u.role === 'admin') { roleColor = '#dc2626'; roleText = 'ğŸ‘‘ Admin'; }
                else if (u.role === 'driver') { roleColor = '#2563eb'; roleText = 'ğŸš— Fahrer'; }
                else { roleText = 'ğŸ’¾ Fahrgast'; }
                
                return `
                    <div style="background:white;border:1px solid #e0e0e0;border-radius:8px;padding:12px;margin-bottom:10px;">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                            <div style="flex:1;">
                                <div style="font-weight:600;font-size:15px;">${u.displayName || u.name || 'Unbekannt'}</div>
                                ${u.phone ? `<div style="font-size:13px;color:#666;">ğŸ’¾ ${u.phone}</div>` : ''}
                                ${u.email ? `<div style="font-size:12px;color:#888;">ğŸ“§ ${u.email}</div>` : ''}
                                <div style="display:flex;gap:10px;margin-top:6px;flex-wrap:wrap;">
                                    <span style="font-size:11px;background:#f3f4f6;padding:2px 8px;border-radius:4px;">${loginMethod}</span>
                                    <span style="font-size:11px;background:${roleColor}22;color:${roleColor};padding:2px 8px;border-radius:4px;font-weight:600;">${roleText}</span>
                                </div>
                                <div style="font-size:11px;color:#999;margin-top:6px;">
                                    ğŸ“… Registriert: ${createdDate}<br>
                                    ğŸ• Letzter Login: ${lastLogin}
                                </div>
                            </div>
                            <div style="display:flex;flex-direction:column;gap:5px;">
                                <button onclick="addUserToCustomers('${u.uid}')" style="padding:8px 12px;background:#10b981;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;">
                                    â• Ins CRM
                                </button>
                                <button onclick="bookForAppUser('${u.uid}')" style="padding:8px 12px;background:#8b5cf6;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;">
                                    ğŸš• Buchen
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // App-User ins CRM Ã¼bernehmen
        async function addUserToCustomers(uid) {
            const user = allAppUsers.find(u => u.uid === uid);
            if (!user) return;
            
            try {
                // PrÃ¼fe ob schon im CRM (per Telefon oder Email)
                const existingCustomer = allCustomers.find(c => 
                    (user.phone && c.phone === user.phone) ||
                    (user.email && c.email === user.email)
                );
                
                if (existingCustomer) {
                    alert('â„¹ï¸ Dieser User ist bereits im CRM vorhanden!');
                    return;
                }
                
                // Ins CRM eintragen
                // ğŸ†• v5.90.12: NORMALISIERE Phone fÃ¼r customerId!
                const customerId = user.phone ? normalizePhoneNumber(user.phone).replace(/[^0-9+]/g, '') : uid;
                await db.ref('customers/' + customerId).set({
                    name: user.displayName || user.name || 'Unbekannt',
                    phone: user.phone ? normalizePhoneNumber(user.phone) : '',
                    email: user.email || '',
                    address: user.address || '',
                    totalRides: 0,
                    totalRevenue: 0,
                    createdAt: Date.now(),
                    source: 'app-registration'
                });
                
                alert('âœ… User wurde ins CRM Ã¼bernommen!');
                
                // Wechsle zum CRM Tab
                switchCrmTab('customers');
                
            } catch (error) {
                console.error('Fehler:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // Fahrt fÃ¼r App-User buchen
        function bookForAppUser(uid) {
            const user = allAppUsers.find(u => u.uid === uid);
            if (!user) return;
            
            // Formular ausfÃ¼llen
            if (user.displayName || user.name) {
                document.getElementById('customer-name').value = user.displayName || user.name;
            }
            if (user.phone) {
                document.getElementById('customer-phone').value = user.phone;
            }
            
            // Zum Buchungsformular scrollen
            document.getElementById('booking-section').scrollIntoView({ behavior: 'smooth' });
            
            alert('âœ… Kundendaten Ã¼bernommen!\n\nBitte Abholadresse eingeben.');
        }
        
        async function loadAllCustomers() {
            if (!isFirebaseReady) {
                alert('ğŸ’¾ Firebase nicht verbunden!');
                return;
            }
            
            try {
                const snapshot = await db.ref('customers').once('value');
                allCustomers = [];
                snapshot.forEach(child => {
                    const customer = child.val();
                    customer.id = child.key;
                    allCustomers.push(customer);
                });
                
                // Sortiere nach letzter Fahrt (neueste zuerst)
                allCustomers.sort((a, b) => (b.lastRide || 0) - (a.lastRide || 0));
                
                console.log('ğŸ“‹ Kunden geladen:', allCustomers.length);
                renderCustomersList(allCustomers);
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der Kunden:', error);
                alert('ğŸ’¾ Fehler beim Laden der Kunden');
            }
        }
        
        function searchCustomers() {
            const query = document.getElementById('customer-search').value.toLowerCase();
            
            if (currentCrmTab === 'customers') {
                const filtered = allCustomers.filter(c => 
                    (c.name && c.name.toLowerCase().includes(query)) ||
                    (c.email && c.email.toLowerCase().includes(query)) ||
                    (c.phone && c.phone.includes(query)) ||
                    (c.address && c.address.toLowerCase().includes(query))
                );
                renderCustomersList(filtered);
            } else {
                const filtered = allAppUsers.filter(u => 
                    (u.displayName && u.displayName.toLowerCase().includes(query)) ||
                    (u.name && u.name.toLowerCase().includes(query)) ||
                    (u.email && u.email.toLowerCase().includes(query)) ||
                    (u.phone && u.phone.includes(query))
                );
                renderAppUsersList(filtered);
            }
        }
        
        function renderCustomersList(customers) {
            const container = document.getElementById('customers-list');
            
            if (customers.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">Keine Kunden gefunden</div>';
                return;
            }
            
            container.innerHTML = customers.map(c => {
                const lastRideDate = c.lastRide ? new Date(c.lastRide).toLocaleDateString('de-DE') : 'Nie';
                return `
                    <div style="background:white;border:1px solid #e0e0e0;border-radius:8px;padding:12px;margin-bottom:10px;">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                            <div style="flex:1;">
                                <div style="font-weight:600;font-size:15px;">${c.name || 'Unbekannt'}</div>
                                ${c.phone ? `<div style="font-size:13px;color:#666;">ğŸ’¾ ${c.phone}</div>` : ''}
                                ${c.email ? `<div style="font-size:12px;color:#888;">ğŸ“§ ${c.email}</div>` : ''}
                                ${c.address ? `<div style="font-size:12px;color:#888;">ğŸ“ ${c.address}</div>` : ''}
                                <div style="font-size:11px;color:#999;margin-top:4px;">
                                    ğŸš• ${c.totalRides || 0} Fahrten Â· ğŸ’° ${(c.totalRevenue || 0).toFixed(2)}â‚¬ Â· ğŸ“… ${lastRideDate}
                                </div>
                            </div>
                            <div style="display:flex;flex-direction:column;gap:5px;">
                                ${c.phone ? `
                                <button onclick="callCustomer('${c.phone.replace(/'/g, "\\'")}')" style="padding:8px 12px;background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;font-weight:600;box-shadow:0 2px 6px rgba(59,130,246,0.3);">
                                    ğŸ’¾ Anrufen
                                </button>
                                ` : ''}
                                <button onclick="bookForCustomer('${c.id}')" style="padding:8px 12px;background:#10b981;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;">
                                    ğŸš• Buchen
                                </button>
                                <button onclick="exportCustomerToVCF('${c.id}')" style="padding:8px 12px;background:#f59e0b;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;" title="Als Kontakt exportieren">
                                    ğŸ“± Zu Kontakten
                                </button>
                                <button onclick="showCustomerHistory('${c.id}', '${(c.name || '').replace(/'/g, "\\'")}', '${(c.phone || '').replace(/'/g, "\\'")}')" style="padding:8px 12px;background:#8b5cf6;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;">
                                    ğŸ“‹ Verlauf
                                </button>
                                <button onclick="editCustomer('${c.id}')" style="padding:8px 12px;background:#3b82f6;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;">
                                    âœï¸ Bearbeiten
                                </button>
                            </div>
                        </div>
                        ${c.notes ? `<div style="font-size:11px;color:#666;margin-top:8px;padding:8px;background:#f9fafb;border-radius:4px;">ğŸ“ ${c.notes}</div>` : ''}
                        <div id="customer-history-${c.id}" style="display:none;margin-top:10px;"></div>
                    </div>
                `;
            }).join('');
        }
        
        // ğŸ’¾ Stammkunden-Erkennung bei Telefonnummer-Eingabe (NUR FÃœR EINGELOGGTE!)
        let phoneCheckTimeout = null;
        let lastCheckedPhone = '';
        
        // ğŸ“‹ KUNDEN-FAHRTVERLAUF ANZEIGEN - v5.86.0 VERBESSERT!
        async function showCustomerHistory(customerId, customerName, customerPhone) {
            const historyDiv = document.getElementById('customer-history-' + customerId);
            if (!historyDiv) return;
            
            // Toggle: Wenn schon offen, schlieÃŸen
            if (historyDiv.style.display === 'block') {
                historyDiv.style.display = 'none';
                return;
            }
            
            historyDiv.innerHTML = '<div style="text-align:center;padding:10px;color:#666;">â³ Lade Fahrtverlauf...</div>';
            historyDiv.style.display = 'block';
            
            if (!isFirebaseReady) {
                historyDiv.innerHTML = '<div style="color:red;padding:10px;">ğŸ’¾ Firebase nicht verbunden</div>';
                return;
            }
            
            console.log(`ğŸ” Suche Fahrten fÃ¼r: ${customerName} / ${customerPhone}`);
            
            try {
                const snapshot = await db.ref('rides').orderByChild('createdAt').once('value');
                const customerRides = [];
                
                // Normalisiere fÃ¼r Vergleich
                const normalizedPhone = customerPhone ? customerPhone.replace(/\D/g, '').slice(-10) : '';
                const normalizedName = customerName ? customerName.toLowerCase().trim() : '';
                
                console.log(`ğŸ“± Suche mit: Name="${normalizedName}", Tel="${normalizedPhone}"`);
                
                let phoneMatches = 0;
                let nameMatches = 0;
                let fuzzyMatches = 0;
                
                snapshot.forEach(child => {
                    const ride = child.val();
                    ride.firebaseId = child.key;
                    
                    let isMatch = false;
                    let matchReason = '';
                    
                    // 1. TELEFON-MATCH (beste Methode)
                    if (normalizedPhone && ride.customerPhone) {
                        const ridePhone = ride.customerPhone.replace(/\D/g, '').slice(-10);
                        if (ridePhone === normalizedPhone) {
                            isMatch = true;
                            matchReason = 'phone-exact';
                            phoneMatches++;
                        } else if (ridePhone.includes(normalizedPhone) || normalizedPhone.includes(ridePhone)) {
                            isMatch = true;
                            matchReason = 'phone-partial';
                            phoneMatches++;
                        }
                    }
                    
                    // 2. NAMEN-MATCH (exakt)
                    if (!isMatch && normalizedName && ride.customerName) {
                        const rideName = ride.customerName.toLowerCase().trim();
                        if (rideName === normalizedName) {
                            isMatch = true;
                            matchReason = 'name-exact';
                            nameMatches++;
                        }
                    }
                    
                    // 3. FUZZY NAMEN-MATCH (Teil-String)
                    if (!isMatch && normalizedName && ride.customerName) {
                        const rideName = ride.customerName.toLowerCase().trim();
                        // Beide Richtungen prÃ¼fen
                        if (rideName.includes(normalizedName) || normalizedName.includes(rideName)) {
                            isMatch = true;
                            matchReason = 'name-fuzzy';
                            fuzzyMatches++;
                        }
                    }
                    
                    if (isMatch) {
                        ride.matchReason = matchReason; // FÃ¼r Debug
                        customerRides.push(ride);
                    }
                });
                
                console.log(`âœ… Matches: ${customerRides.length} (ğŸ’¾ Phone: ${phoneMatches}, ğŸ’¾ Exakt: ${nameMatches}, ğŸ” Fuzzy: ${fuzzyMatches})`);
                
                // Sortiere nach Datum (neueste zuerst)
                customerRides.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                
                if (customerRides.length === 0) {
                    historyDiv.innerHTML = `
                        <div style="background:#fef3c7;border:2px dashed #f59e0b;border-radius:8px;padding:15px;text-align:center;">
                            <div style="font-size:32px;margin-bottom:8px;">ğŸ“­</div>
                            <div style="font-weight:600;color:#92400e;margin-bottom:4px;">Keine Fahrten gefunden</div>
                            <div style="font-size:12px;color:#92400e;">
                                Suchte nach:<br>
                                ğŸ’¾ Name: "${customerName}"<br>
                                ğŸ’¾ Telefon: "${customerPhone}"
                            </div>
                        </div>
                    `;
                    showToast(`âš ï¸ Keine Fahrten fÃ¼r ${customerName} gefunden`, 'warning');
                    return;
                }
                
                // Statistiken berechnen
                let totalRevenue = 0;
                let completedRides = 0;
                let cancelledRides = 0;
                
                customerRides.forEach(r => {
                    if (r.status === 'completed') {
                        completedRides++;
                        totalRevenue += parseFloat(r.price) || 0;
                    } else if (r.status === 'storniert' || r.status === 'cancelled') {
                        cancelledRides++;
                    }
                });
                
                // HTML erstellen
                let html = `
                    <div style="background:#f0fdf4;border-radius:6px;padding:12px;margin-bottom:12px;border:2px solid #10b981;">
                        <div style="font-weight:600;margin-bottom:8px;color:#1f2937;">ğŸ“± Statistik fÃ¼r ${customerName}</div>
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;font-size:12px;">
                            <div style="text-align:center;background:white;padding:8px;border-radius:6px;">
                                <div style="font-size:20px;font-weight:bold;color:#16a34a;">${completedRides}</div>
                                <div style="color:#666;">Abgeschlossen</div>
                            </div>
                            <div style="text-align:center;background:white;padding:8px;border-radius:6px;">
                                <div style="font-size:20px;font-weight:bold;color:#dc2626;">${cancelledRides}</div>
                                <div style="color:#666;">Storniert</div>
                            </div>
                            <div style="text-align:center;background:white;padding:8px;border-radius:6px;">
                                <div style="font-size:20px;font-weight:bold;color:#2563eb;">${totalRevenue.toFixed(2)}â‚¬</div>
                                <div style="color:#666;">Umsatz</div>
                            </div>
                        </div>
                    </div>
                    <div style="font-weight:600;margin-bottom:8px;color:#1f2937;">ğŸ“‹ Letzte ${Math.min(customerRides.length, 10)} Fahrten:</div>
                `;
                
                // Zeige max 10 Fahrten
                const displayRides = customerRides.slice(0, 10);
                
                displayRides.forEach(ride => {
                    const date = ride.createdAt ? new Date(ride.createdAt).toLocaleDateString('de-DE', {
                        day: '2-digit', month: '2-digit', year: '2-digit'
                    }) : '?';
                    const time = ride.createdAt ? new Date(ride.createdAt).toLocaleTimeString('de-DE', {
                        hour: '2-digit', minute: '2-digit'
                    }) : '';
                    
                    let statusColor = '#666';
                    let statusIcon = 'â³';
                    if (ride.status === 'completed') {
                        statusColor = '#16a34a';
                        statusIcon = 'âœ…';
                    } else if (ride.status === 'storniert' || ride.status === 'cancelled') {
                        statusColor = '#dc2626';
                        statusIcon = 'ğŸ’¾';
                    } else if (ride.status === 'accepted' || ride.status === 'picked_up') {
                        statusColor = '#2563eb';
                        statusIcon = 'ğŸš—';
                    }
                    
                    // Escape fÃ¼r onclick
                    const pickupEsc = (ride.pickup || '').replace(/'/g, "\\'");
                    const destEsc = (ride.destination || '').replace(/'/g, "\\'");
                    const nameEsc = (ride.customerName || customerName || '').replace(/'/g, "\\'");
                    const phoneEsc = (ride.customerPhone || customerPhone || '').replace(/'/g, "\\'");
                    
                    html += `
                        <div style="background:white;border:1px solid #e5e7eb;border-radius:6px;padding:10px;margin-bottom:8px;font-size:12px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <div style="flex:1;">
                                    <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
                                        <span style="color:${statusColor};font-weight:600;font-size:14px;">${statusIcon}</span>
                                        <span style="color:#666;">${date} ${time}</span>
                                    </div>
                                    <div style="color:#333;margin-top:4px;font-size:13px;">
                                        ğŸ“ ${ride.pickup || '?'} â†’ ${ride.destination || '?'}
                                    </div>
                                    ${ride.vehicle ? `<div style="color:#888;font-size:11px;margin-top:2px;">ğŸš— ${ride.vehicle}</div>` : ''}
                                </div>
                                <div style="display:flex;align-items:center;gap:8px;">
                                    <div style="text-align:right;">
                                        <div style="font-weight:700;font-size:16px;color:#16a34a;">${ride.price || '?'}â‚¬</div>
                                    </div>
                                    ${ride.status === 'cancelled' || ride.status === 'storniert' ? `
                                        <button onclick="showCancelledRideDetails('${ride.firebaseId}')" style="padding:6px 10px;background:#ef4444;color:white;border:none;border-radius:4px;font-size:11px;cursor:pointer;font-weight:600;white-space:nowrap;">
                                            ğŸ“ Details
                                        </button>
                                    ` : `
                                        <button onclick="rebookFromHistory('${pickupEsc}', '${destEsc}', '${nameEsc}', '${phoneEsc}')" style="padding:6px 10px;background:#10b981;color:white;border:none;border-radius:4px;font-size:11px;cursor:pointer;font-weight:600;white-space:nowrap;">
                                            ğŸ” Buchen
                                        </button>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                if (customerRides.length > 10) {
                    html += `<div style="text-align:center;color:#666;font-size:11px;padding:8px;background:#f9fafb;border-radius:6px;">... und ${customerRides.length - 10} weitere Fahrten</div>`;
                }
                
                historyDiv.innerHTML = html;
                showToast(`âœ… ${customerRides.length} Fahrten geladen`, 'success');
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden des Verlaufs:', error);
                historyDiv.innerHTML = '<div style="color:red;padding:10px;">ğŸ’¾ Fehler beim Laden</div>';
                showToast('ğŸ’¾ Fehler beim Laden des Verlaufs', 'error');
            }
        }
        
        // ğŸ” FAHRT AUS KUNDENVERLAUF WIEDER BUCHEN
        function rebookFromHistory(pickup, destination, customerName, customerPhone) {
            // Wechsle zum Fahrgast-Tab
            switchView('passenger');
            
            // FÃ¼lle das Buchungsformular
            const pickupField = document.getElementById('pickup');
            const destField = document.getElementById('destination');
            const nameField = document.getElementById('customer-name');
            const phoneField = document.getElementById('customer-phone');
            
            if (pickupField) pickupField.value = pickup;
            if (destField) destField.value = destination;
            if (nameField) nameField.value = customerName;
            if (phoneField) phoneField.value = customerPhone;
            
            // Berechne Route neu
            if (pickup && destination) {
                calculateRoute();
            }
            
            // Scroll zum Formular
            const form = document.getElementById('booking-form');
            if (form) {
                form.scrollIntoView({ behavior: 'smooth' });
            }
            
            // BestÃ¤tigung
            alert('âœ… Daten Ã¼bernommen!\n\nğŸ“ ' + pickup + ' â†’ ' + destination + '\nğŸ’¾ ' + customerName + '\n\nBitte Abholzeit wÃ¤hlen und buchen.');
        }
        
        // ğŸ†• v5.90.173: RECHNUNG FÃœR KUNDEN ERSTELLEN (nutzt bestehendes Modal!)
        async function openInvoiceForCustomer(customerId, customerName, customerPhone, customerAddress) {
            console.log('ğŸ“± Ã–ffne Rechnung fÃ¼r Kunde:', customerName);
            
            // Ã–ffne das bestehende leere Rechnung-Modal
            await openInvoiceModalEmpty();
            
            // Warte kurz bis Modal gerendert ist
            setTimeout(() => {
                // FÃ¼lle Kundenname aus
                const nameField = document.getElementById('inv-customer-name');
                if (nameField) {
                    nameField.value = customerName;
                    console.log('âœ… Name gefÃ¼llt:', customerName);
                }
                
                // FÃ¼lle Adresse aus (falls vorhanden)
                if (customerAddress) {
                    const addressField = document.getElementById('inv-address');
                    if (addressField) {
                        addressField.value = customerAddress;
                        console.log('âœ… Adresse gefÃ¼llt:', customerAddress);
                    }
                }
                
                // Speichere customerId & customerPhone fÃ¼r spÃ¤tere Verwendung
                if (!window.invoiceCustomerData) {
                    window.invoiceCustomerData = {};
                }
                window.invoiceCustomerData.id = customerId;
                window.invoiceCustomerData.phone = customerPhone;
                window.invoiceCustomerData.name = customerName;
                
                console.log('âœ… Kundendaten vorausgefÃ¼llt');
                
                // Fokus auf Von-Feld
                const pickupField = document.getElementById('inv-pickup');
                if (pickupField) {
                    pickupField.focus();
                }
                
            }, 200);
        }
        
        // ğŸ†• v5.90.172: LÃ„NDERVORWAHL AUTOMATISCH HINZUFÃœGEN
        function addCountryCode(input) {
            if (!input || !input.value) return;
            
            let phone = input.value.trim();
            
            // Bereits +49 oder + vorhanden? Dann nichts machen
            if (phone.startsWith('+')) {
                return;
            }
            
            // ğŸ†• v5.90.237: PrÃ¼fe ob Dropdown vorhanden ist (neue Kunden-Modals)
            const phoneCountrySelect = input.previousElementSibling;
            if (phoneCountrySelect && phoneCountrySelect.tagName === 'SELECT') {
                // Dropdown vorhanden! â†’ Entferne fÃ¼hrende 0
                const cleanPhone = phone.replace(/[\s\-]/g, '');
                if (cleanPhone.startsWith('0')) {
                    input.value = cleanPhone.substring(1); // Entferne 0
                    console.log('âœ… FÃ¼hrende 0 entfernt:', input.value);
                }
                return; // Dropdown kÃ¼mmert sich um +49
            }
            
            // Entferne Leerzeichen und Bindestriche fÃ¼r Check
            const cleanPhone = phone.replace(/[\s\-]/g, '');
            
            // Beginnt mit 0? Dann ersetze durch +49
            if (cleanPhone.startsWith('0')) {
                phone = '+49' + cleanPhone.substring(1);
                input.value = phone;
                console.log('âœ… +49 hinzugefÃ¼gt:', phone);
            }
            // Beginnt mit 49? Dann fÃ¼ge + hinzu
            else if (cleanPhone.startsWith('49')) {
                phone = '+' + cleanPhone;
                input.value = phone;
                console.log('âœ… + hinzugefÃ¼gt:', phone);
            }
            // Beginnt mit Ziffer (aber nicht 0 oder 49)? Dann fÃ¼ge +49 hinzu
            else if (/^\d/.test(cleanPhone)) {
                phone = '+49' + cleanPhone;
                input.value = phone;
                console.log('âœ… +49 vorangestellt:', phone);
            }
        }
        
        // ğŸ†• v5.90.237: AUTO-CLEAN PHONE INPUT (wÃ¤hrend Eingabe!)
        function autoCleanPhoneInput(input) {
            if (!input) return;
            
            // Erlaube nur Zahlen und Leerzeichen
            input.value = input.value.replace(/[^0-9 ]/g, '');
            
            // PrÃ¼fe ob Dropdown vorhanden
            const phoneCountrySelect = input.previousElementSibling;
            if (phoneCountrySelect && phoneCountrySelect.tagName === 'SELECT') {
                // Dropdown vorhanden â†’ Entferne fÃ¼hrende 0 automatisch
                let val = input.value.trim();
                if (val.startsWith('0')) {
                    input.value = val.substring(1);
                    console.log('âœ… Auto-Clean: FÃ¼hrende 0 entfernt');
                }
            }
        }
        
        async function openQuickBookingModal(prefilledCustomer = null) {
            if (!isFirebaseReady) {
                alert('ğŸ’¾ Firebase nicht verbunden!');
                return;
            }
            
            // ğŸ†• v5.64.3: Entferne alte Modals falls vorhanden (verhindert Duplikate)
            const oldModal = document.getElementById('quick-booking-modal');
            if (oldModal) {
                console.log('ğŸ§¹ Entferne altes Schnellbuchungs-Modal...');
                oldModal.remove();
            }
            
            // Lade Kunden wenn noch nicht geladen
            if (allCustomers.length === 0) {
                console.log('â³ Lade Kunden fÃ¼r Schnellbuchung...');
                await loadAllCustomers();
                console.log('âœ… Kunden geladen:', allCustomers.length);
            }
            
            // ğŸ†• v5.90.559: RESET QB WAYPOINTS!
            qbWaypoints = [];
            qbWaypointCounter = 0;
            
            const modal = document.createElement('div');
            modal.id = 'quick-booking-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10001;padding:20px;overflow-y:auto;-webkit-overflow-scrolling:touch;';
            
            // Aktuelle Zeit + 15 Minuten als Default (LOKAL!)
            const now = new Date();
            now.setMinutes(now.getMinutes() + 15);
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            const defaultDate = `${yyyy}-${mm}-${dd}T${hh}:${min}`;  // ğŸ”§ v5.90.354: LOKAL!
            
            modal.innerHTML = `
                <div style="
                    background:white;
                    border-radius:12px;
                    padding:0;
                    width:100%;
                    max-width:700px;
                    max-height:90vh;
                    overflow:hidden;
                    box-shadow:0 20px 60px rgba(0,0,0,0.3);
                    display:flex;
                    flex-direction:column;
                ">
                    <!-- Header -->
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:20px;background:linear-gradient(135deg, #667eea, #764ba2);color:white;border-radius:12px 12px 0 0;">
                        <h3 style="margin:0;font-size:18px;font-weight:700;">âš¡ Schnellbuchung</h3>
                        <button onclick="document.getElementById('quick-booking-modal').remove()" style="background:none;border:none;font-size:28px;cursor:pointer;color:white;line-height:1;padding:0;opacity:0.9;">Ã—</button>
                    </div>
                    
                    <!-- Content mit Scroll -->
                    <div style="padding:20px;overflow-y:auto;flex:1;">
                        
                        <!-- Kunde -->
                        <div style="margin-bottom:15px;position:relative;">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:#1f2937;font-size:14px;" title="Kunde aus CRM wÃ¤hlen oder neu anlegen">ğŸ’¾ Kunde (Rechnung)</label>
                            <input 
                                type="text" 
                                id="quick-booking-customer-search" 
                                placeholder="Telefon oder Name eingeben..." 
                                oninput="searchQuickBookingCustomer()"
                                onpaste="setTimeout(searchQuickBookingCustomer, 100)"
                                onchange="searchQuickBookingCustomer()"
                                autocomplete="off"
                                title="Tippe min. 3 Zeichen um zu suchen"
                                style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;">
                            <input type="hidden" id="quick-booking-customer" value="">
                            <div id="quick-booking-customer-dropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:white;border:2px solid #10b981;border-radius:8px;max-height:200px;overflow-y:auto;z-index:10000;margin-top:4px;box-shadow:0 4px 12px rgba(0,0,0,0.15);"></div>
                            
                            <!-- ğŸ†• v5.90.125: KUNDE BEARBEITEN BUTTON! -->
                            <div id="quick-booking-edit-customer-btn" style="display:none;margin-top:8px;">
                                <button onclick="editQuickBookingCustomer()" title="Kundendaten bearbeiten" style="width:100%;padding:10px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;gap:8px;">
                                    âœï¸ Kundendaten bearbeiten
                                </button>
                            </div>
                            
                            <!-- ğŸ†• v5.64.23: HANDY-KONTAKTE BUTTON -->
                            <button onclick="importPhoneContact()" title="Kontakt aus Handy-Kontakten importieren" style="margin-top:8px;width:100%;padding:10px;background:#f0f9ff;color:#1e40af;border:2px solid #3b82f6;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;gap:8px;">
                                ğŸ“± Aus Handy-Kontakten importieren
                            </button>
                        </div>
                        
                        <!-- ğŸ†• v5.75.0: GAST-NAME (optional) - NUR INFO-FELD! -->
                        <div style="margin-bottom:15px;">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:#1f2937;font-size:14px;" title="Optional: Name des Fahrgastes (z.B. bei Hotel-Buchungen). Wird NICHT als Kunde angelegt!">
                                ğŸ§³ Fahrgast-Name (optional)
                                <span style="font-weight:400;font-size:12px;color:#6b7280;margin-left:4px;">nur Info</span>
                            </label>
                            <input 
                                type="text" 
                                id="quick-booking-guest-name" 
                                placeholder="z.B. Herr MÃ¼ller" 
                                style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;background:#f9fafb;">
                        </div>
                        
                        <!-- ğŸ†• v5.88.21: FAHRGAST-TELEFON (optional) - NUR INFO-FELD! -->
                        <div style="margin-bottom:15px;">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:#1f2937;font-size:14px;" title="Optional: Telefon des Fahrgastes fÃ¼r Kontakt. Wird NICHT als Kunde angelegt!">
                                ğŸ“± Fahrgast-Telefon (optional)
                                <span style="font-weight:400;font-size:12px;color:#6b7280;margin-left:4px;">nur Info</span>
                            </label>
                            <input 
                                type="tel" 
                                id="quick-booking-guest-phone" 
                                placeholder="z.B. 0170 1234827" 
                                onblur="addCountryCode(this)"
                                style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;background:#f9fafb;">
                            <div style="font-size:12px;color:#6b7280;margin-top:4px;">
                                â„¹ï¸ Nur fÃ¼r Kontakt - wird NICHT als Kunde angelegt | ğŸ’¡ +49 automatisch
                            </div>
                        </div>
                        
                        <!-- Startzeit -->
                        <div style="margin-bottom:15px;">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:#1f2937;font-size:14px;">ğŸ“… Startzeit</label>
                            
                            <!-- Wochentag-Anzeige -->
                            <div id="quick-booking-weekday-display" style="font-size:13px;color:#6b7280;margin-bottom:6px;font-weight:500;padding:4px 0;">
                                <!-- Wird mit JavaScript gefÃ¼llt -->
                            </div>
                            
                            <!-- Datum und Zeit in separaten Feldern -->
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                                <div>
                                    <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px;">Datum</label>
                                    
                                    <!-- ğŸ†• v5.76.1: CUSTOM CALENDAR PICKER - Als Button statt Input -->
                                    <div style="position:relative;">
                                        <!-- Anzeige-Button (klickbar) -->
                                        <button type="button"
                                            id="quick-booking-date-display" 
                                            onclick="toggleQuickBookingCalendar()" 
                                            style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;cursor:pointer;background:white;text-align:left;font-weight:500;color:#1f2937;">
                                            Datum wÃ¤hlen
                                        </button>
                                        
                                        <!-- Hidden Feld fÃ¼r Wert -->
                                        <input type="hidden" id="quick-booking-date" value="${defaultDate.split('T')[0]}">
                                    </div>
                                </div>
                                <div>
                                    <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px;">Uhrzeit</label>
                                    <div style="display:flex;gap:6px;">
                                        <button type="button" id="quick-booking-time-btn" onclick="openQuickBookingTimeKeypad()" style="flex:1;padding:12px;border:2px solid #667eea;background:white;border-radius:8px;font-size:14px;font-weight:600;color:#667eea;cursor:pointer;font-family:'Courier New',monospace;">
                                            ${defaultDate.split('T')[1] || '09:00'}
                                        </button>
                                        <button type="button" onclick="openQuickBookingTimeKeypad()" style="padding:12px 14px;border:2px solid #667eea;background:#667eea;color:white;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                                            âŒ¨ï¸
                                        </button>
                                    </div>
                                    <input type="hidden" id="quick-booking-time" value="${defaultDate.split('T')[1] || '09:00'}">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Abholort -->
                        <div style="margin-bottom:15px;position:relative;">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:#1f2937;font-size:14px;" title="Von wo soll der Kunde abgeholt werden?">ğŸ“ Abholort</label>
                            <input type="text" id="quick-booking-pickup" placeholder="Adresse eingeben..." title="Tippe Adresse ein - Dropdown mit VorschlÃ¤gen erscheint" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;">
                            <div id="quick-booking-pickup-dropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:white;border:2px solid #e5e7eb;border-radius:8px;max-height:200px;overflow-y:auto;z-index:1000;margin-top:4px;box-shadow:0 4px 12px rgba(0,0,0,0.1);"></div>
                            
                            <!-- ğŸ†• v5.90.240: AUF KARTE WÃ„HLEN FÃœR ABHOLORT! -->
                            <button onclick="openQuickBookingMapPickerForPickup()" title="Abholort auf Karte auswÃ¤hlen" style="margin-top:8px;width:100%;padding:10px;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;gap:8px;">
                                ğŸ“ Auf Karte wÃ¤hlen
                            </button>
                        </div>
                        
                        <!-- Swap Button -->
                        <div style="text-align:center;margin:-6px 0 10px 0;">
                            <button onclick="swapQuickBookingLocations()" title="Abholort und Zielort vertauschen" style="padding:8px 16px;background:white;border:2px solid #667eea;color:#667eea;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;transition:all 0.2s;" onmouseover="this.style.background='#667eea';this.style.color='white';" onmouseout="this.style.background='white';this.style.color='#667eea';">
                                ğŸ”„ Tauschen
                            </button>
                        </div>
                        
                        <!-- Zielort -->
                        <div style="margin-bottom:15px;position:relative;">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:#1f2937;font-size:14px;" title="Wohin soll der Kunde fahren?">ğŸ¯ Zielort</label>
                            <input type="text" id="quick-booking-destination" placeholder="Adresse eingeben..." title="Tippe Adresse ein - Dropdown mit VorschlÃ¤gen erscheint" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;">
                            <div id="quick-booking-destination-dropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:white;border:2px solid #e5e7eb;border-radius:8px;max-height:200px;overflow-y:auto;z-index:1000;margin-top:4px;box-shadow:0 4px 12px rgba(0,0,0,0.1);"></div>
                            
                            <!-- ğŸ†• v5.90.236: AUF KARTE WÃ„HLEN! -->
                            <button onclick="openQuickBookingMapPicker()" title="Zielort auf Karte auswÃ¤hlen" style="margin-top:8px;width:100%;padding:10px;background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;gap:8px;">
                                ğŸ“ Auf Karte wÃ¤hlen
                            </button>
                            
                            <!-- ğŸ†• v5.90.105: Als Favorit speichern Button -->
                            <button onclick="saveDestinationAsPOI()" title="Diesen Zielort als Favorit speichern fÃ¼r spÃ¤tere Nutzung" style="margin-top:8px;width:100%;padding:8px;background:#fef3c7;color:#92400e;border:2px dashed #f59e0b;border-radius:6px;font-weight:600;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;gap:6px;transition:all 0.2s;" onmouseover="this.style.background='#fcd34d';this.style.borderStyle='solid';" onmouseout="this.style.background='#fef3c7';this.style.borderStyle='dashed';">
                                â­ Als Favorit speichern
                            </button>
                        </div>
                        
                        <!-- ğŸ†• v5.90.559: ZWISCHENZIELE! -->
                        <div id="quick-booking-waypoints-container" style="margin-bottom:15px;"></div>
                        
                        <button onclick="addQuickBookingWaypoint()" style="width:100%;padding:8px;border:2px dashed #10b981;background:white;border-radius:6px;color:#10b981;font-weight:600;cursor:pointer;transition:all 0.2s;font-size:13px;" onmouseover="this.style.background='#d1fae5'" onmouseout="this.style.background='white'">
                            + Zwischenstopp
                        </button>
                        
                        <!-- HÃ¤ufige Zielorte -->
                        <div id="quick-booking-frequent-destinations" style="display:none;margin-bottom:15px;"></div>
                        
                        <!-- Favoriten Button -->
                        <div style="margin-bottom:15px;">
                            <button onclick="showQuickBookingFavorites()" title="HÃ¤ufig genutzte Adressen anzeigen und speichern" style="width:100%;padding:10px;background:#f9fafb;color:#666;border:2px solid #e5e7eb;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;">
                                â­ Favoriten
                            </button>
                        </div>
                        
                        <!-- Personen & Fahrzeug -->
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px;">
                            <div>
                                <label style="display:block;font-weight:600;margin-bottom:8px;color:#1f2937;font-size:14px;">ğŸ‘¥ Personen</label>
                                <select id="quick-booking-passengers" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;">
                                    <option value="1">1 Person</option>
                                    <option value="2">2 Personen</option>
                                    <option value="3">3 Personen</option>
                                    <option value="4">4 Personen</option>
                                    <option value="5">5 Personen</option>
                                    <option value="6">6 Personen</option>
                                    <option value="7">7 Personen</option>
                                    <option value="8">8 Personen</option>
                                </select>
                            </div>
                            <div>
                                <label style="display:block;font-weight:600;margin-bottom:8px;color:#1f2937;font-size:14px;">ğŸš— Fahrzeug</label>
                                <select id="quick-booking-vehicle" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;">
                                    <option value="">Automatisch</option>
                                    <!-- Wird dynamisch gefÃ¼llt -->
                                </select>
                            </div>
                        </div>
                        
                        <!-- Notizen -->
                        <div style="margin-bottom:15px;">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:#1f2937;font-size:14px;">ğŸ“ Notizen (optional)</label>
                            <textarea id="quick-booking-notes" placeholder="z.B. Rollstuhl, Kindersitz..." style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;min-height:60px;resize:vertical;box-sizing:border-box;"></textarea>
                        </div>
                        
                        <!-- ğŸ†• v5.90.106: PREIS-BERECHNUNG OPTION - Radio Buttons! -->
                        <div style="margin-bottom:15px;padding:12px;background:#f0fdf4;border:2px solid #10b981;border-radius:8px;">
                            <div style="font-size:14px;font-weight:600;color:#048257;margin-bottom:8px;">ğŸ’° Preis-Berechnung:</div>
                            
                            <label style="display:flex;align-items:center;cursor:pointer;font-size:13px;margin-bottom:6px;" title="Taxipreis automatisch aus Distanz berechnen">
                                <input type="radio" name="quick-booking-price-mode" value="taxi" checked style="margin-right:8px;cursor:pointer;">
                                <span>ğŸ’° Taxipreis berechnen</span>
                            </label>
                            
                            <label style="display:flex;align-items:center;cursor:pointer;font-size:13px;" title="Krankenfahrt - kein Preis wird berechnet">
                                <input type="radio" name="quick-booking-price-mode" value="medical" style="margin-right:8px;cursor:pointer;">
                                <span>ğŸ¥ Krankenfahrt (kein Preis)</span>
                            </label>
                        </div>
                        
                        <!-- ğŸ†• v5.64.18: ZEIT-BERECHNUNG OPTION -->
                        <div style="margin-bottom:15px;padding:12px;background:#eff6ff;border:2px solid #3b82f6;border-radius:8px;">
                            <div style="font-size:13px;font-weight:600;color:#1e40af;margin-bottom:8px;" title="Fahrtdauer-Berechnung wÃ¤hlen">â±ï¸ Fahrtdauer:</div>
                            <label style="display:flex;align-items:center;cursor:pointer;font-size:13px;margin-bottom:6px;" title="Fahrtdauer aus Distanz und Geschwindigkeit berechnen">
                                <input type="radio" name="quick-booking-duration-mode" value="calculated" checked style="margin-right:8px;cursor:pointer;">
                                <span>ğŸ“ Aus Distanz berechnen</span>
                            </label>
                            <label style="display:flex;align-items:center;cursor:pointer;font-size:13px;" title="Feste Fahrtdauer von 15 Minuten verwenden">
                                <input type="radio" name="quick-booking-duration-mode" value="fixed" style="margin-right:8px;cursor:pointer;">
                                <span>ğŸ• Feste Zeit (15 Min)</span>
                            </label>
                        </div>
                        
                        <!-- Favorit Button -->
                        <div style="margin-bottom:15px;">
                            <button onclick="saveQuickBookingAsFavorite()" title="Diese Strecke als Favorit speichern (z.B. hÃ¤ufig genutzte Route)" style="width:100%;padding:10px;background:#fbbf24;color:#78350f;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;">
                                â­ Als Favorit speichern
                            </button>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:20px;border-top:2px solid #e5e7eb;">
                        <button onclick="document.getElementById('quick-booking-modal').remove()" title="Schnellbuchung abbrechen" style="padding:14px;background:#f3f4f6;color:#6b7280;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                            Abbrechen
                        </button>
                        <button onclick="submitQuickBooking()" title="Fahrt jetzt buchen und Fahrer benachrichtigen" style="padding:14px;background:linear-gradient(135deg, #10b981 0%, #059669 100%);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px;box-shadow:0 2px 8px rgba(16, 185, 129, 0.3);">
                            âš¡ Buchen
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ğŸ†• v5.48.3: SchlieÃŸe Dropdown beim Klicken auÃŸerhalb
            setTimeout(() => {
                document.addEventListener('click', function closeCustomerDropdown(e) {
                    const dropdown = document.getElementById('quick-booking-customer-dropdown');
                    const searchInput = document.getElementById('quick-booking-customer-search');
                    if (dropdown && searchInput && !searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                        dropdown.style.display = 'none';
                    }
                });
            }, 100);
            
            // ğŸ†• v5.38.4: Setup Autocomplete fÃ¼r Schnellbuchung
            setupQuickBookingAutocomplete();
            
            // ğŸ†• v5.90.134: Touch-Events fÃ¼r Edit-Button (Mobile Fix!)
            setTimeout(() => {
                const editBtn = document.querySelector('#quick-booking-edit-customer-btn button');
                if (editBtn) {
                    console.log('ğŸ”§ v5.90.134: Touch-Events fÃ¼r Edit-Button hinzugefÃ¼gt');
                    editBtn.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        console.log('ğŸ‘† Edit-Button Touch!');
                        editQuickBookingCustomer();
                    });
                }
            }, 100);
            
            // ğŸ†• v5.38.4: Lade Fahrzeuge
            loadQuickBookingVehicles();
            
            // ğŸ†• v5.65.4: Zeige Wochentag an
            updateQuickBookingWeekday();
            
            // ğŸ†• v5.64.9: VorausfÃ¼llen wenn Kunde aus CRM Ã¼bergeben wurde!
            if (prefilledCustomer) {
                setTimeout(() => {
                    console.log('ğŸ“ FÃ¼lle Kundendaten vor:', prefilledCustomer.name || prefilledCustomer.phone);
                    
                    // Kunde
                    const searchInput = document.getElementById('quick-booking-customer-search');
                    const customerIdInput = document.getElementById('quick-booking-customer');
                    if (searchInput && customerIdInput) {
                        // ğŸ†• v5.73.0: Bei neuen Kunden (kein Name) â†’ Telefon anzeigen!
                        const displayValue = prefilledCustomer.name || prefilledCustomer.phone || '';
                        searchInput.value = displayValue;
                        customerIdInput.value = prefilledCustomer.id || '';
                        // GrÃ¼ner Border = ausgewÃ¤hlt
                        searchInput.style.borderColor = '#10b981';
                        searchInput.style.background = '#f0fdf4';
                        
                        // ğŸ†• v5.73.0: Bei neuen Kunden Placeholder setzen!
                        if (prefilledCustomer.isNew) {
                            searchInput.placeholder = 'Name eingeben (erforderlich)...';
                            searchInput.style.borderColor = '#f59e0b';
                            searchInput.style.background = '#fffbeb';
                        }
                    }
                    
                    // ğŸ†• v5.64.11: Abholort (mit Koordinaten!)
                    const pickupInput = document.getElementById('quick-booking-pickup');
                    if (pickupInput && prefilledCustomer.address) {
                        pickupInput.value = prefilledCustomer.address;
                        // Koordinaten nachschlagen!
                        geocodeCustomerAddress(prefilledCustomer.address, 'quick-booking-pickup');
                    }
                    
                    // ğŸ†• v5.64.11: Zielort (mit Koordinaten!)
                    const destInput = document.getElementById('quick-booking-destination');
                    if (destInput && prefilledCustomer.favoriteDestination) {
                        destInput.value = prefilledCustomer.favoriteDestination;
                        // Koordinaten nachschlagen!
                        geocodeCustomerAddress(prefilledCustomer.favoriteDestination, 'quick-booking-destination');
                    }
                    
                    // Toast: Kundendaten Ã¼bernommen!
                    const toast = document.createElement('div');
                    toast.style.cssText = 'position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:12px 20px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:99999;font-weight:600;font-size:14px;';
                    // ğŸ†• v5.73.0: Bei neuen Kunden andere Message!
                    const toastMessage = prefilledCustomer.isNew 
                        ? `ğŸ’¾ ${prefilledCustomer.phone} - Bitte Namen eingeben!`
                        : `âœ… Kundendaten Ã¼bernommen: ${prefilledCustomer.name}`;
                    toast.innerHTML = toastMessage;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                    
                    // HÃ¤ufige Zielorte laden (nur wenn NICHT neu!)
                    if (!prefilledCustomer.isNew) {
                        loadFrequentDestinations(prefilledCustomer.id);
                    }
                }, 200);
            }
            
            // ğŸ†• v5.76.0: Initialisiere Calendar Picker
            setTimeout(() => {
                initQuickBookingCalendar();
                updateQuickBookingWeekday();
            }, 250);
        }
        
        // ğŸ†• v5.48.3: Live-Suche fÃ¼r Kunden (ab 3 Zeichen)
        function searchQuickBookingCustomer() {
            const searchInput = document.getElementById('quick-booking-customer-search');
            const dropdown = document.getElementById('quick-booking-customer-dropdown');
            const searchText = searchInput.value.trim().toLowerCase();
            
            // Mindestens 3 Zeichen!
            if (searchText.length < 3) {
                dropdown.style.display = 'none';
                return;
            }
            
            // Filtere Kunden
            const matches = allCustomers.filter(c => {
                const name = (c.name || '').toLowerCase();
                const phone = (c.phone || '').toLowerCase();
                return name.includes(searchText) || phone.includes(searchText);
            });
            
            // Zeige Ergebnisse
            if (matches.length === 0) {
                // ğŸ†• v5.52.9: NEUER KUNDE OPTION!
                dropdown.innerHTML = `
                    <div style="padding:12px;text-align:center;color:#999;">Kein Kunde gefunden</div>
                    <div style="padding:8px;background:#f9fafb;border-top:1px solid #e5e7eb;">
                        <button onclick="createNewCustomerFromQuickBooking()" 
                                style="width:100%;padding:10px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;">
                            â• Als neuen Kunden anlegen
                        </button>
                    </div>
                `;
                dropdown.style.display = 'block';
                return;
            }
            
            // Erstelle Dropdown
            dropdown.innerHTML = matches.map(c => `
                <div onclick="selectQuickBookingCustomer('${c.id}', '${(c.name || 'Unbekannt').replace(/'/g, "\\'")}', '${(c.phone || '').replace(/'/g, "\\'")}', '${(c.address || '').replace(/'/g, "\\'")}', '${(c.favoriteDestination || '').replace(/'/g, "\\'")}' )" 
                    style="padding:12px;cursor:pointer;border-bottom:1px solid #f3f4f6;transition:background 0.2s;"
                    onmouseover="this.style.background='#f0fdf4'"
                    onmouseout="this.style.background='white'">
                    <div style="font-weight:600;color:#1f2937;">${c.name || 'Unbekannt'}</div>
                    <div style="font-size:12px;color:#6b7280;margin-top:2px;">
                        ${c.phone ? 'ğŸ’¾ ' + c.phone : ''}
                        ${c.address ? ' Â· ğŸ  ' + c.address : ''}
                    </div>
                    <div style="font-size:11px;color:#10b981;margin-top:4px;">
                        ğŸš• ${c.totalRides || 0} Fahrten Â· ğŸ’° ${(c.totalRevenue || 0).toFixed(2)}â‚¬
                    </div>
                </div>
            `).join('');
            
            // ğŸ†• v5.86.28: NEUER KUNDE BUTTON IMMER ANZEIGEN!
            dropdown.innerHTML += `
                <div style="padding:8px;background:#f9fafb;border-top:2px solid #e5e7eb;position:sticky;bottom:0;">
                    <button onclick="createNewCustomerFromQuickBooking()" 
                            style="width:100%;padding:10px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;gap:6px;transition:all 0.3s;"
                            onmouseover="this.style.background='#2563eb'"
                            onmouseout="this.style.background='#3b82f6'">
                        â• Stattdessen neuen Kunden anlegen
                    </button>
                </div>
            `;
            
            dropdown.style.display = 'block';
        }
        
        // ğŸ†• v5.48.3: Kunde aus Dropdown wÃ¤hlen
        
        // ğŸ†• v5.49.0: Finde hÃ¤ufigste Zielorte eines Kunden
        async function getMostFrequentDestinations(customerPhone, customerId) {
            console.log('ğŸ” Suche hÃ¤ufigste Zielorte fÃ¼r:', customerPhone, customerId);
            
            try {
                // Lade alle Fahrten aus Firebase
                const snapshot = await db.ref('rides').once('value');
                const allRides = [];
                
                snapshot.forEach(child => {
                    const ride = child.val();
                    ride.firebaseId = child.key;
                    allRides.push(ride);
                });
                
                // Filtere Fahrten dieses Kunden (nach Telefon oder ID)
                const customerRides = allRides.filter(r => {
                    if (customerPhone && r.customerPhone === customerPhone) return true;
                    if (customerId && r.customerId === customerId) return true;
                    return false;
                });
                
                console.log('ğŸ“± Gefunden:', customerRides.length, 'Fahrten von diesem Kunden');
                
                // ğŸ†• v5.63.9: SMART MATCHING - Normalisiere Adressen!
                function normalizeAddress(addr) {
                    if (!addr) return '';
                    
                    // Konvertiere zu Lowercase
                    let normalized = addr.toLowerCase();
                    
                    // Entferne Postleitzahlen (5 Ziffern)
                    normalized = normalized.replace(/\b\d{5}\b/g, '');
                    
                    // Entferne hÃ¤ufige PrÃ¤fixe
                    normalized = normalized.replace(/^(am|an der|in der|zur|zum)\s+/gi, '');
                    
                    // StraÃŸenabkÃ¼rzungen vereinheitlichen
                    normalized = normalized.replace(/straÃŸe|str\.|str$/gi, 'strasse');
                    
                    // Entferne mehrfache Leerzeichen
                    normalized = normalized.replace(/\s+/g, ' ').trim();
                    
                    // Entferne Sonderzeichen
                    normalized = normalized.replace(/[,\.]/g, '');
                    
                    return normalized;
                }
                
                // ZÃ¤hle Zielorte (mit Normalisierung!)
                const destinationGroups = {}; // normalisiert â†’ [original addresses]
                const destinationCount = {};  // normalisiert â†’ count
                
                customerRides.forEach(ride => {
                    if (ride.destination) {
                        const original = ride.destination.trim();
                        const normalized = normalizeAddress(original);
                        
                        if (!destinationGroups[normalized]) {
                            destinationGroups[normalized] = [];
                        }
                        destinationGroups[normalized].push(original);
                        
                        destinationCount[normalized] = (destinationCount[normalized] || 0) + 1;
                    }
                });
                
                console.log('ğŸ”¥ Normalisierte Ziele:', Object.keys(destinationCount).length);
                console.log('   Gruppen:', destinationGroups);
                console.log('   Counts:', destinationCount);
                
                // Sortiere nach HÃ¤ufigkeit
                const sorted = Object.entries(destinationCount)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)  // Top 5
                    .map(([normalizedDest, count]) => {
                        // WÃ¤hle die hÃ¤ufigste/lÃ¤ngste Original-Adresse aus dieser Gruppe
                        const originals = destinationGroups[normalizedDest];
                        const bestOriginal = originals.sort((a, b) => b.length - a.length)[0];
                        
                        return { 
                            destination: bestOriginal,
                            count: count 
                        };
                    });
                
                console.log('ğŸ”¥ Top Zielorte (smart matched):', sorted);
                
                return sorted;
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der Zielorte:', error);
                return [];
            }
        }
        
        // ğŸ†• v5.49.0: Zeige hÃ¤ufigste Zielorte als Buttons
        async function showFrequentDestinations(customerPhone, customerId, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Zeige Loading
            container.innerHTML = '<div style="padding:10px;color:#666;font-size:13px;">ğŸ” Lade hÃ¤ufige Zielorte...</div>';
            container.style.display = 'block';
            
            const frequentDests = await getMostFrequentDestinations(customerPhone, customerId);
            
            if (frequentDests.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            // Erstelle Buttons
            let html = '<div style="margin-top:10px;padding:12px;background:#f0fdf4;border:2px solid #10b981;border-radius:8px;">';
            html += '<div style="font-weight:600;margin-bottom:8px;color:#059669;font-size:13px;">ğŸ”¥ HÃ¤ufige Zielorte:</div>';
            html += '<div style="display:flex;flex-direction:column;gap:6px;">';
            
            frequentDests.forEach(item => {
                const fieldPrefix = containerId.includes('panel') ? 'qb-panel' : 'quick-booking';
                html += `
                    <button 
                        onclick="selectFrequentDestination('${item.destination.replace(/'/g, "\\'")}', '${fieldPrefix}')"
                        style="padding:10px;background:white;border:2px solid #10b981;border-radius:6px;cursor:pointer;text-align:left;transition:all 0.2s;font-size:13px;"
                        onmouseover="this.style.background='#d1fae5'"
                        onmouseout="this.style.background='white'">
                        <span style="color:#059669;font-weight:600;">ğŸ“ ${item.destination}</span>
                        <span style="color:#6b7280;margin-left:8px;font-size:11px;">(${item.count}x)</span>
                    </button>
                `;
            });
            
            html += '</div></div>';
            container.innerHTML = html;
            container.style.display = 'block';
        }
        
        // ğŸ†• v5.49.0: WÃ¤hle hÃ¤ufiges Ziel aus
        async function selectFrequentDestination(destination, fieldPrefix) {
            console.log('âœ… HÃ¤ufiges Ziel gewÃ¤hlt:', destination);
            
            // Setze Adresse ins Feld
            document.getElementById(`${fieldPrefix}-destination`).value = destination;
            
            // Geocode fÃ¼r Koordinaten
            const fieldType = `${fieldPrefix}-destination`;
            await geocodeCustomerAddress(destination, fieldType);
            
            console.log('âœ… Ziel eingetragen + Koordinaten gesetzt');
        }
        
        // ğŸ†• v5.52.9: NEUEN KUNDEN AUS SCHNELLBUCHUNG ANLEGEN
        async function createNewCustomerFromQuickBooking() {
            const searchInput = document.getElementById('quick-booking-customer-search');
            const enteredText = searchInput.value.trim();
            
            if (!enteredText) {
                alert('ğŸ’¾ Bitte Namen oder Telefonnummer eingeben!');
                return;
            }
            
            // ğŸ†• v5.64.23: ERKENNE OB TELEFONNUMMER!
            const isPhone = /^[\d\s\+\-\(\)]+$/.test(enteredText);
            const prefillName = isPhone ? '' : enteredText;
            const prefillPhone = isPhone ? enteredText : '';
            
            // Mini-Modal fÃ¼r zusÃ¤tzliche Daten
            const miniModal = document.createElement('div');
            miniModal.id = 'new-qb-customer-modal';  // ğŸ”§ ID fÃ¼r sicheres SchlieÃŸen!
            miniModal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:10001;display:flex;align-items:center;justify-content:center;padding:20px;';
            miniModal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;max-width:400px;width:100%;">
                    <h3 style="margin:0 0 15px 0;color:#1f2937;">â• Neuer Kunde</h3>
                    
                    <div style="margin-bottom:12px;">
                        <label style="display:block;font-weight:600;margin-bottom:6px;color:#374151;">ğŸ’¾ Telefon: <span style="color:#ef4444;">*</span></label>
                        <input type="tel" id="new-qb-customer-phone" value="${prefillPhone}" placeholder="z.B. 0170 1234827" 
                               onblur="addCountryCode(this)"
                               style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;">
                        <div style="font-size:11px;color:#6b7280;margin-top:4px;">
                            ğŸ’¡ Tipp: +49 wird automatisch hinzugefÃ¼gt
                        </div>
                    </div>
                    
                    <div style="margin-bottom:12px;">
                        <label style="display:block;font-weight:600;margin-bottom:6px;color:#374151;">ğŸ’¾ Name: <span style="color:#ef4444;">*</span></label>
                        <input type="text" id="new-qb-customer-name" value="${prefillName}" placeholder="z.B. Max Mustermann" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;">
                    </div>
                    
                    <div style="margin-bottom:12px;">
                        <label style="display:block;font-weight:600;margin-bottom:6px;color:#374151;">ğŸ“§ Email:</label>
                        <input type="email" id="new-qb-customer-email" placeholder="Optional" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;">
                    </div>
                    
                    <div style="margin-bottom:15px;position:relative;">
                        <label style="display:block;font-weight:600;margin-bottom:6px;color:#374151;">ğŸ  Adresse:</label>
                        <input type="text" id="new-qb-customer-address" placeholder="Optional" autocomplete="off" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;">
                        <div id="new-qb-customer-address-dropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:white;border:2px solid #10b981;border-radius:8px;max-height:200px;overflow-y:auto;z-index:10002;margin-top:4px;box-shadow:0 4px 12px rgba(0,0,0,0.15);"></div>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                        <button onclick="closeMiniModal()" style="padding:14px;background:#f3f4f6;color:#6b7280;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                            Abbrechen
                        </button>
                        <button onclick="saveNewQuickBookingCustomer()" style="padding:14px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px;">
                            ğŸ’¾ Speichern
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(miniModal);
            
            // ğŸ†• v5.87.20: AUTOCOMPLETE FÃœR ADRESS-FELD!
            const addressInput = document.getElementById('new-qb-customer-address');
            const addressDropdown = document.getElementById('new-qb-customer-address-dropdown');
            let addressAutocompleteTimeout = null;
            
            if (addressInput && addressDropdown) {
                // Focus Event - Zeige Favoriten
                addressInput.addEventListener('focus', () => {
                    const value = addressInput.value.trim();
                    if (!value || value.length < 3) {
                        searchAddresses('', 'new-qb-customer-address');
                    }
                });
                
                // Input Event - Suche Adressen
                addressInput.addEventListener('input', (e) => {
                    clearTimeout(addressAutocompleteTimeout);
                    const value = e.target.value.trim();
                    
                    if (value.length === 0) {
                        searchAddresses('', 'new-qb-customer-address');
                        return;
                    }
                    
                    if (value.length < 3) {
                        addressDropdown.style.display = 'none';
                        return;
                    }
                    
                    addressAutocompleteTimeout = setTimeout(() => {
                        searchAddresses(value, 'new-qb-customer-address');
                    }, 300);
                });
                
                // Click auÃŸerhalb schlieÃŸt Dropdown
                document.addEventListener('click', (e) => {
                    if (e.target !== addressInput && !addressDropdown.contains(e.target)) {
                        addressDropdown.style.display = 'none';
                    }
                });
                
                console.log('âœ… Autocomplete fÃ¼r Kunden-Adresse aktiviert!');
            }
            
            // ğŸ†• v5.64.23: FOKUS AUF ERSTES LEERES FELD!
            setTimeout(() => {
                if (isPhone) {
                    document.getElementById('new-qb-customer-name').focus();
                } else {
                    document.getElementById('new-qb-customer-phone').focus();
                }
            }, 100);
        }
        
        // ğŸ”§ Helper: SchlieÃŸe Mini-Modal sicher
        function closeMiniModal() {
            const miniModal = document.getElementById('new-qb-customer-modal');
            if (miniModal) {
                miniModal.remove();
            }
        }
        
        // ğŸ†• v5.87.85: Ã–FFNE "NEUER KUNDE" MODAL MIT TELEFONNUMMER (fÃ¼r Anrufe!)
        function openNewCustomerModalWithPhone(phone) {
            console.log('ğŸ’¾ Ã–ffne Neuer-Kunde-Modal mit Telefon:', phone);
            
            // Mini-Modal fÃ¼r zusÃ¤tzliche Daten
            const miniModal = document.createElement('div');
            miniModal.id = 'new-qb-customer-modal';
            miniModal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:10001;display:flex;align-items:center;justify-content:center;padding:20px;';
            miniModal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;max-width:400px;width:100%;">
                    <h3 style="margin:0 0 15px 0;color:#1f2937;">â• Neuer Kunde</h3>
                    
                    <div style="margin-bottom:12px;">
                        <label style="display:block;font-weight:600;margin-bottom:6px;color:#374151;">ğŸ’¾ Telefon: <span style="color:#ef4444;">*</span></label>
                        <input type="tel" id="new-qb-customer-phone" value="${phone}" placeholder="z.B. 0170 1234827" 
                               onblur="addCountryCode(this)"
                               style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;">
                        <div style="font-size:11px;color:#6b7280;margin-top:4px;">
                            ğŸ’¡ Tipp: +49 wird automatisch hinzugefÃ¼gt
                        </div>
                    </div>
                    
                    <div style="margin-bottom:12px;">
                        <label style="display:block;font-weight:600;margin-bottom:6px;color:#374151;">ğŸ’¾ Name: <span style="color:#ef4444;">*</span></label>
                        <input type="text" id="new-qb-customer-name" value="" placeholder="z.B. Max Mustermann" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;">
                    </div>
                    
                    <div style="margin-bottom:12px;">
                        <label style="display:block;font-weight:600;margin-bottom:6px;color:#374151;">ğŸ“§ Email:</label>
                        <input type="email" id="new-qb-customer-email" placeholder="Optional" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;">
                    </div>
                    
                    <div style="margin-bottom:15px;position:relative;">
                        <label style="display:block;font-weight:600;margin-bottom:6px;color:#374151;">ğŸ  Adresse:</label>
                        <input type="text" id="new-qb-customer-address" placeholder="Optional" autocomplete="off" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;">
                        <div id="new-qb-customer-address-dropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:white;border:2px solid #10b981;border-radius:8px;max-height:200px;overflow-y:auto;z-index:10002;margin-top:4px;box-shadow:0 4px 12px rgba(0,0,0,0.15);"></div>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                        <button onclick="closeMiniModal()" style="padding:14px;background:#f3f4f6;color:#6b7280;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                            Abbrechen
                        </button>
                        <button onclick="saveNewQuickBookingCustomer()" style="padding:14px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px;">
                            ğŸ’¾ Speichern
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(miniModal);
            
            // ğŸ†• v5.87.20: AUTOCOMPLETE FÃœR ADRESS-FELD!
            const addressInput = document.getElementById('new-qb-customer-address');
            const addressDropdown = document.getElementById('new-qb-customer-address-dropdown');
            let addressAutocompleteTimeout = null;
            
            if (addressInput && addressDropdown) {
                // Focus Event - Zeige Favoriten
                addressInput.addEventListener('focus', () => {
                    const value = addressInput.value.trim();
                    if (!value || value.length < 3) {
                        searchAddresses('', 'new-qb-customer-address');
                    }
                });
                
                // Input Event - Suche Adressen
                addressInput.addEventListener('input', (e) => {
                    clearTimeout(addressAutocompleteTimeout);
                    const value = e.target.value.trim();
                    
                    if (value.length === 0) {
                        searchAddresses('', 'new-qb-customer-address');
                        return;
                    }
                    
                    if (value.length < 3) {
                        addressDropdown.style.display = 'none';
                        return;
                    }
                    
                    addressAutocompleteTimeout = setTimeout(() => {
                        searchAddresses(value, 'new-qb-customer-address');
                    }, 300);
                });
                
                // Click auÃŸerhalb schlieÃŸt Dropdown
                document.addEventListener('click', (e) => {
                    if (e.target !== addressInput && !addressDropdown.contains(e.target)) {
                        addressDropdown.style.display = 'none';
                    }
                });
                
                console.log('âœ… Autocomplete fÃ¼r Kunden-Adresse aktiviert!');
            }
            
            // â­ FOKUS AUF NAME (Telefon ist schon ausgefÃ¼llt!)
            setTimeout(() => {
                document.getElementById('new-qb-customer-name').focus();
            }, 100);
        }
        
        // ğŸ”§ Helper: SchlieÃŸe Mini-Modal sicher
        function closeMiniModal() {
            const miniModal = document.getElementById('new-qb-customer-modal');
            if (miniModal) {
                miniModal.remove();
                console.log('âœ… Mini-Modal geschlossen');
            }
        }
        
        // ğŸ†• v5.65.4: Zeige Wochentag fÃ¼r gewÃ¤hltes Datum an
        function updateQuickBookingWeekday() {
            const dateInput = document.getElementById('quick-booking-date');
            const weekdayDisplay = document.getElementById('quick-booking-weekday-display');
            
            if (!dateInput || !weekdayDisplay) return;
            
            const dateValue = dateInput.value;
            if (!dateValue) {
                weekdayDisplay.textContent = '';
                return;
            }
            
            // Parse Datum
            const date = new Date(dateValue + 'T12:00:00'); // Mittag fÃ¼r Zeitzone-Sicherheit
            const weekdays = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
            const months = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            
            const weekday = weekdays[date.getDay()];
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            
            // Formatiere schÃ¶n
            weekdayDisplay.innerHTML = `<strong>${weekday}</strong>, ${day}. ${month} ${year}`;
            console.log('ğŸ“… Wochentag aktualisiert:', weekday);
        }
        
        // ğŸ†• v5.76.1: CUSTOM CALENDAR PICKER FÃœR SCHNELLBUCHUNG - ALS OVERLAY!
        let quickBookingCalendarCurrentMonth = new Date();
        let quickBookingCalendarSelectedDate = null;
        
        function toggleQuickBookingCalendar() {
            let calendarOverlay = document.getElementById('quick-booking-calendar-overlay');
            
            if (calendarOverlay) {
                // SchlieÃŸen
                calendarOverlay.remove();
            } else {
                // Ã–ffnen - als FIXED OVERLAY
                calendarOverlay = document.createElement('div');
                calendarOverlay.id = 'quick-booking-calendar-overlay';
                calendarOverlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:20000;display:flex;align-items:center;justify-content:center;padding:20px;';
                
                calendarOverlay.innerHTML = `
                    <div onclick="event.stopPropagation()" style="background:white;border-radius:16px;padding:20px;max-width:380px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.4);">
                        <!-- Header mit Monat/Jahr Navigation -->
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                            <button onclick="changeQuickBookingMonth(-1);event.stopPropagation();" style="background:none;border:none;font-size:24px;cursor:pointer;padding:8px 12px;color:#667eea;font-weight:700;">â—„</button>
                            <div id="quick-booking-cal-month" style="font-weight:700;font-size:17px;color:#1f2937;"></div>
                            <button onclick="changeQuickBookingMonth(1);event.stopPropagation();" style="background:none;border:none;font-size:24px;cursor:pointer;padding:8px 12px;color:#667eea;font-weight:700;">â–º</button>
                        </div>
                        
                        <!-- Wochentage -->
                        <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:12px;">
                            <div style="text-align:center;font-size:12px;font-weight:700;color:#9ca3af;padding:8px 0;">Mo</div>
                            <div style="text-align:center;font-size:12px;font-weight:700;color:#9ca3af;padding:8px 0;">Di</div>
                            <div style="text-align:center;font-size:12px;font-weight:700;color:#9ca3af;padding:8px 0;">Mi</div>
                            <div style="text-align:center;font-size:12px;font-weight:700;color:#9ca3af;padding:8px 0;">Do</div>
                            <div style="text-align:center;font-size:12px;font-weight:700;color:#9ca3af;padding:8px 0;">Fr</div>
                            <div style="text-align:center;font-size:12px;font-weight:700;color:#10b981;padding:8px 0;">Sa</div>
                            <div style="text-align:center;font-size:12px;font-weight:700;color:#10b981;padding:8px 0;">So</div>
                        </div>
                        
                        <!-- Tage (wird mit JS gefÃ¼llt) -->
                        <div id="quick-booking-cal-days" style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:15px;">
                            <!-- Wird dynamisch gefÃ¼llt -->
                        </div>
                        
                        <!-- Abbrechen Button -->
                        <button onclick="document.getElementById('quick-booking-calendar-overlay').remove()" style="width:100%;padding:12px;background:#f3f4f6;border:none;border-radius:8px;font-weight:600;cursor:pointer;color:#6b7280;font-size:14px;">
                            Abbrechen
                        </button>
                    </div>
                `;
                
                // Klick auf Overlay (auÃŸerhalb) schlieÃŸt Calendar
                calendarOverlay.onclick = function() {
                    this.remove();
                };
                
                document.body.appendChild(calendarOverlay);
                renderQuickBookingCalendar();
            }
        }
        
        function renderQuickBookingCalendar() {
            const year = quickBookingCalendarCurrentMonth.getFullYear();
            const month = quickBookingCalendarCurrentMonth.getMonth();
            
            // Monat/Jahr Header
            const months = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            const monthHeader = document.getElementById('quick-booking-cal-month');
            if (monthHeader) {
                monthHeader.textContent = `${months[month]} ${year}`;
            }
            
            // Tage rendern
            const daysContainer = document.getElementById('quick-booking-cal-days');
            if (!daysContainer) return;
            
            daysContainer.innerHTML = '';
            
            // Erster Tag des Monats
            const firstDay = new Date(year, month, 1);
            let firstDayOfWeek = firstDay.getDay(); // 0 = Sonntag
            // In DE: Montag = 0
            firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
            
            // Anzahl Tage im Monat
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Heute
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // GewÃ¤hltes Datum
            const selectedDateValue = document.getElementById('quick-booking-date').value;
            const selectedDate = selectedDateValue ? new Date(selectedDateValue + 'T12:00:00') : null;
            
            // Leere Zellen fÃ¼r Wochenanfang
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                daysContainer.appendChild(emptyCell);
            }
            
            // Tage des Monats
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                date.setHours(0, 0, 0, 0);
                
                const dayCell = document.createElement('div');
                dayCell.textContent = day;
                dayCell.style.cssText = 'text-align:center;padding:12px 8px;cursor:pointer;border-radius:8px;font-size:15px;transition:all 0.2s;font-weight:500;';
                
                // ğŸ†• v5.90.157: Admin-Check
                const isAdmin = currentUser && (currentUser.email === 'patrick061977@gmail.com' || currentUser.email === 'admin@taxi-heringsdorf.de');
                
                // Styling
                const isToday = date.getTime() === today.getTime();
                const isSelected = selectedDate && date.getTime() === selectedDate.getTime();
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                const isPast = date < today;
                
                // ğŸ†• v5.90.157: Vergangene Tage nur fÃ¼r Nicht-Admins deaktivieren
                if (isPast && !isAdmin) {
                    dayCell.style.color = '#d1d5db';
                    dayCell.style.cursor = 'not-allowed';
                } else if (isPast && isAdmin) {
                    // Admin sieht vergangene Tage anders (aber klickbar!)
                    dayCell.style.color = '#9ca3af';
                    dayCell.style.fontStyle = 'italic';
                } else if (isSelected) {
                    dayCell.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    dayCell.style.color = 'white';
                    dayCell.style.fontWeight = '700';
                } else if (isToday) {
                    dayCell.style.background = '#dbeafe';
                    dayCell.style.color = '#1e40af';
                    dayCell.style.fontWeight = '600';
                } else if (isWeekend) {
                    dayCell.style.color = '#10b981';
                    dayCell.style.fontWeight = '600';
                } else {
                    dayCell.style.color = '#374151';
                }
                
                // ğŸ†• v5.90.157: Hover & Click fÃ¼r Admins auch bei vergangenen Tagen!
                if (!isPast || isAdmin) {
                    dayCell.onmouseover = function() {
                        if (!isSelected) {
                            this.style.background = '#f3f4f6';
                        }
                    };
                    dayCell.onmouseout = function() {
                        if (!isSelected) {
                            if (isToday) {
                                this.style.background = '#dbeafe';
                            } else {
                                this.style.background = 'transparent';
                            }
                        }
                    };
                    
                    // Click Handler
                    dayCell.onclick = function() {
                        selectQuickBookingDate(date);
                    };
                }
                
                daysContainer.appendChild(dayCell);
            }
        }
        
        function changeQuickBookingMonth(delta) {
            quickBookingCalendarCurrentMonth.setMonth(quickBookingCalendarCurrentMonth.getMonth() + delta);
            renderQuickBookingCalendar();
        }
        
        function selectQuickBookingDate(date) {
            // Format: YYYY-MM-DD
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateString = `${year}-${month}-${day}`;
            
            // Setze Wert
            document.getElementById('quick-booking-date').value = dateString;
            
            // Update Anzeige
            const weekdays = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
            const months = ['Jan', 'Feb', 'MÃ¤r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
            const displayText = `${weekdays[date.getDay()]}, ${day}. ${months[date.getMonth()]} ${year}`;
            const displayButton = document.getElementById('quick-booking-date-display');
            if (displayButton) {
                displayButton.textContent = displayText;
            }
            
            // Wochentag-Anzeige aktualisieren
            updateQuickBookingWeekday();
            
            // Calendar schlieÃŸen
            const overlay = document.getElementById('quick-booking-calendar-overlay');
            if (overlay) {
                overlay.remove();
            }
            
            console.log('ğŸ“… Datum gewÃ¤hlt:', dateString, displayText);
        }
        
        // Initialisierung: Setze initiales Datum im Display
        function initQuickBookingCalendar() {
            const dateInput = document.getElementById('quick-booking-date');
            const displayButton = document.getElementById('quick-booking-date-display');
            
            if (dateInput && dateInput.value && displayButton) {
                const date = new Date(dateInput.value + 'T12:00:00');
                quickBookingCalendarCurrentMonth = new Date(date.getFullYear(), date.getMonth(), 1);
                
                const weekdays = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
                const months = ['Jan', 'Feb', 'MÃ¤r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
                const day = String(date.getDate()).padStart(2, '0');
                const displayText = `${weekdays[date.getDay()]}, ${day}. ${months[date.getMonth()]} ${date.getFullYear()}`;
                displayButton.textContent = displayText;
            }
        }
        
        // ğŸ†• v5.52.9: SPEICHERE NEUEN KUNDEN AUS SCHNELLBUCHUNG
        async function saveNewQuickBookingCustomer() {
            const phone = document.getElementById('new-qb-customer-phone').value.trim();
            const name = document.getElementById('new-qb-customer-name').value.trim();
            const email = document.getElementById('new-qb-customer-email').value.trim();
            const address = document.getElementById('new-qb-customer-address').value.trim();
            
            // ğŸ†• v5.64.23: TELEFON + NAME PFLICHT!
            if (!phone) {
                alert('ğŸ’¾ Telefonnummer ist erforderlich!');
                document.getElementById('new-qb-customer-phone').focus();
                return;
            }
            
            if (!name) {
                alert('ğŸ’¾ Name ist erforderlich!');
                document.getElementById('new-qb-customer-name').focus();
                return;
            }
            
            const customer = {
                name: name,
                phone: phone,
                email: email,
                address: address,
                billingAddresses: [{
                    id: Date.now(),
                    label: 'Standard',
                    address: address,
                    isDefault: true
                }],
                notes: 'Erstellt via Schnellbuchung',
                totalRides: 0,
                totalRevenue: 0,
                createdAt: Date.now()
            };
            
            // Toast
            const toast = document.createElement('div');
            toast.style.cssText = 'position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:15px 20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:99999;font-weight:600;animation:slideIn 0.3s ease;';
            toast.innerHTML = `â³ Speichere "${name}"...`;
            document.body.appendChild(toast);
            
            try {
                // Speichere in Firebase
                const newRef = await db.ref('customers').push(customer);
                customer.id = newRef.key;
                
                // FÃ¼ge zur lokalen Liste hinzu
                allCustomers.unshift(customer);
                
                // SchlieÃŸe Mini-Modal
                closeMiniModal();
                
                // WÃ¤hle den neuen Kunden in der Schnellbuchung aus
                selectQuickBookingCustomer(customer.id, name, phone, address, '');
                
                // Update Toast
                toast.style.background = '#10b981';
                toast.innerHTML = `âœ… "${name}" ins CRM gespeichert!`;
                setTimeout(() => toast.remove(), 2000);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                toast.style.background = '#ef4444';
                toast.innerHTML = `ğŸ’¾ Fehler beim Speichern!`;
                setTimeout(() => toast.remove(), 3000);
            }
        }
        
        // ğŸ†• v5.64.23: HANDY-KONTAKTE IMPORTIEREN
        async function importPhoneContact() {
            // Check if Contact Picker API is supported
            if (!('contacts' in navigator) || !('ContactsManager' in window)) {
                alert('ğŸ’¾ Dein Browser unterstÃ¼tzt leider keinen Handy-Kontakte-Import.\n\nBitte gib Name und Telefon manuell ein.');
                return;
            }
            
            try {
                const props = ['name', 'tel'];
                const opts = {multiple: false};
                
                const contacts = await navigator.contacts.select(props, opts);
                
                if (contacts && contacts.length > 0) {
                    const contact = contacts[0];
                    const name = contact.name && contact.name.length > 0 ? contact.name[0] : '';
                    const phone = contact.tel && contact.tel.length > 0 ? contact.tel[0] : '';
                    
                    if (!name && !phone) {
                        alert('ğŸ’¾ Kontakt enthÃ¤lt keinen Namen oder Telefonnummer!');
                        return;
                    }
                    
                    // PrÃ¼fe ob Kunde schon existiert
                    const existing = allCustomers.find(c => 
                        (phone && c.phone === phone) || 
                        (name && c.name === name)
                    );
                    
                    if (existing) {
                        // Kunde existiert schon - wÃ¤hle ihn aus
                        selectQuickBookingCustomer(existing.id, existing.name, existing.phone, existing.address || '', existing.favoriteDestination || '');
                        
                        const toast = document.createElement('div');
                        toast.style.cssText = 'position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:15px 20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:99999;font-weight:600;';
                        toast.innerHTML = `âœ… "${existing.name}" ausgewÃ¤hlt!`;
                        document.body.appendChild(toast);
                        setTimeout(() => toast.remove(), 2000);
                    } else {
                        // Neuer Kunde - Ã¶ffne Anlege-Popup mit vorausgefÃ¼llten Daten
                        const searchInput = document.getElementById('quick-booking-customer-search');
                        searchInput.value = phone || name;
                        
                        // Warte kurz, dann Ã¶ffne Popup
                        setTimeout(() => {
                            createNewCustomerFromQuickBooking();
                            
                            // Warte bis Popup da ist, dann fÃ¼lle Felder aus
                            setTimeout(() => {
                                if (phone) document.getElementById('new-qb-customer-phone').value = phone;
                                if (name) document.getElementById('new-qb-customer-name').value = name;
                            }, 100);
                        }, 100);
                    }
                }
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Kontakt-Import:', error);
                if (error.name !== 'AbortError') {
                    alert('ğŸ’¾ Fehler beim Importieren!\n\n' + error.message);
                }
            }
        }
        
        // ğŸ†• v5.90.140: KUNDE AUS SCHNELLBUCHUNG BEARBEITEN - MIT FIREBASE!
        // ğŸ†• v5.90.142: KUNDE AUS SCHNELLBUCHUNG BEARBEITEN - mit getCustomer!
        async function editQuickBookingCustomer() {
            const editBtn = document.getElementById('quick-booking-edit-customer-btn');
            const customerId = editBtn ? editBtn.dataset.customerId : null;
            
            if (!customerId) {
                alert('ğŸ’¾ Kein Kunde ausgewÃ¤hlt!');
                return;
            }
            
            console.log('âœï¸ editQuickBookingCustomer aufgerufen fÃ¼r:', customerId);
            
            // Verwende zentrale getCustomer Funktion
            const customer = await getCustomer(customerId);
            
            if (!customer) {
                alert('ğŸ’¾ Kunde nicht gefunden!');
                return;
            }
            
            // SchlieÃŸe Schnellbuchungs-Modal
            const quickModal = document.getElementById('quick-booking-modal');
            if (quickModal) {
                quickModal.remove();
                console.log('âœ… Schnellbuchungs-Modal geschlossen');
            }
            
            // Rufe editCustomer auf
            editCustomer(customerId);
        }
        
        function selectQuickBookingCustomer(id, name, phone, address, favoriteDestination) {
            console.log('âœ… Kunde gewÃ¤hlt:', name);
            console.log('   ID:', id, '| Phone:', phone); // ğŸ†• v5.87.75
            
            // Setze Hidden Field
            document.getElementById('quick-booking-customer').value = id;
            
            // ğŸ†• v5.87.75: BEI "UNBEKANNT" â†’ TELEFON BEHALTEN!
            const searchField = document.getElementById('quick-booking-customer-search');
            if (id === 'new' || !name || name === 'Unbekannt') {
                // Bei neuen/unbekannten Kunden: TELEFON im Suchfeld behalten!
                if (phone) {
                    searchField.value = phone;
                    console.log('ğŸ’¾ Telefonnummer bleibt im Suchfeld:', phone);
                }
            } else {
                // Bei bekannten Kunden: Namen anzeigen
                searchField.value = name;
            }
            
            // SchlieÃŸe Dropdown
            document.getElementById('quick-booking-customer-dropdown').style.display = 'none';
            
            // ğŸ†• v5.90.125: ZEIGE EDIT-BUTTON wenn Kunde ausgewÃ¤hlt!
            const editBtn = document.getElementById('quick-booking-edit-customer-btn');
            if (editBtn) {
                if (id && id !== 'new') {
                    editBtn.style.display = 'block';
                    // Speichere ID fÃ¼r Edit-Funktion
                    editBtn.dataset.customerId = id;
                } else {
                    editBtn.style.display = 'none';
                }
            }
            
            // ğŸ†• v5.64.3: Leere hÃ¤ufige Zielorte VOR dem Neuladen (verhindert alte Daten)
            const frequentContainer = document.getElementById('quick-booking-frequent-destinations');
            if (frequentContainer) {
                frequentContainer.innerHTML = '';
                frequentContainer.style.display = 'none';
            }
            
            // Lade Kundendaten (Adresse, etc.)
            if (address) {
                document.getElementById('quick-booking-pickup').value = address;
                // ğŸ†• v5.48.4: GEOCODE Adresse um Koordinaten zu bekommen!
                geocodeCustomerAddress(address, 'quick-booking-pickup');
            }
            if (favoriteDestination) {
                document.getElementById('quick-booking-destination').value = favoriteDestination;
                // ğŸ†• v5.48.4: GEOCODE Zieladresse um Koordinaten zu bekommen!
                geocodeCustomerAddress(favoriteDestination, 'quick-booking-destination');
            }
            
            // ğŸ†• v5.49.0: Zeige hÃ¤ufige Zielorte!
            if (phone) {
                console.log('ğŸ”¥ Lade hÃ¤ufige Zielorte fÃ¼r:', name, '(' + phone + ')');
                showFrequentDestinations(phone, id, 'quick-booking-frequent-destinations');
            } else {
                console.log('âš ï¸ Kunde hat keine Telefonnummer â†’ Keine hÃ¤ufigen Zielorte');
            }
        }
        
        // ğŸ†• v5.48.4: Geocode Kundenadresse und setze Koordinaten
        async function geocodeCustomerAddress(address, fieldType) {
            console.log('ğŸŒ Geocode Kundenadresse:', address, 'fÃ¼r', fieldType);
            
            // ğŸ†• v5.48.5: FÃ¼ge Region hinzu wenn keine Stadt/PLZ vorhanden!
            let searchAddress = address;
            const hasCity = address.toLowerCase().includes('heringsdorf') || 
                           address.toLowerCase().includes('zinnowitz') || 
                           address.toLowerCase().includes('ahlbeck') ||
                           address.toLowerCase().includes('bansin') ||
                           address.toLowerCase().includes('Ã¼ckeritz') ||
                           address.toLowerCase().includes('usedom');
            const hasPostalCode = /\d{5}/.test(address); // PrÃ¼fe auf 5-stellige PLZ
            
            if (!hasCity && !hasPostalCode) {
                // FÃ¼ge Heringsdorf + Region hinzu fÃ¼r bessere Geocoding-Ergebnisse
                searchAddress = `${address}, Heringsdorf, Usedom, Mecklenburg-Vorpommern, Deutschland`;
                console.log('ğŸ“ Erweitere Adresse fÃ¼r Geocoding:', searchAddress);
            }
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchAddress)}&limit=1`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    
                    console.log('âœ… Geocoding erfolgreich:', {
                        original: address,
                        searched: searchAddress,
                        result: data[0].display_name,
                        coords: { lat, lon }
                    });
                    
                    // Setze Koordinaten je nach Feld
                    if (fieldType === 'quick-booking-pickup') {
                        quickBookingPickupCoords = { lat, lon };
                        console.log('âœ… Pickup-Koordinaten gesetzt:', quickBookingPickupCoords);
                    } else if (fieldType === 'quick-booking-destination') {
                        quickBookingDestCoords = { lat, lon };
                        console.log('âœ… Destination-Koordinaten gesetzt:', quickBookingDestCoords);
                    } else if (fieldType === 'qb-panel-pickup') {
                        qbPanelPickupCoords = { lat, lon };
                        console.log('âœ… Panel-Pickup-Koordinaten gesetzt:', qbPanelPickupCoords);
                    } else if (fieldType === 'qb-panel-destination') {
                        qbPanelDestCoords = { lat, lon };
                        console.log('âœ… Panel-Destination-Koordinaten gesetzt:', qbPanelDestCoords);
                    }
                } else {
                    console.warn('âš ï¸ Keine Koordinaten gefunden fÃ¼r:', searchAddress);
                }
            } catch (error) {
                console.error('ğŸ’¾ Geocoding Fehler:', error);
            }
        }
        
        function loadQuickBookingCustomerData() {
            const customerId = document.getElementById('quick-booking-customer').value;
            if (!customerId) return;
            
            const customer = allCustomers.find(c => c.id === customerId);
            if (!customer) return;
            
            // Lade Kundendaten ins Formular
            if (customer.address) {
                document.getElementById('quick-booking-pickup').value = customer.address;
            }
            if (customer.favoriteDestination) {
                document.getElementById('quick-booking-destination').value = customer.favoriteDestination;
            }
        }
        
        // ğŸ†• v5.52.9: SPEICHERE NEUEN KUNDEN AUS SCHNELLBUCHUNG
        async function saveNewQuickBookingCustomer() {
            const phone = document.getElementById('new-qb-customer-phone').value.trim();
            const name = document.getElementById('new-qb-customer-name').value.trim();
            const email = document.getElementById('new-qb-customer-email').value.trim();
            const address = document.getElementById('new-qb-customer-address').value.trim();
            
            // ğŸ†• v5.64.23: TELEFON + NAME PFLICHT!
            if (!phone) {
                alert('ğŸ’¾ Telefonnummer ist erforderlich!');
                document.getElementById('new-qb-customer-phone').focus();
                return;
            }
            
            if (!name) {
                alert('ğŸ’¾ Name ist erforderlich!');
                document.getElementById('new-qb-customer-name').focus();
                return;
            }
            
            const customer = {
                name: name,
                phone: phone,
                email: email,
                address: address,
                billingAddresses: [{
                    id: Date.now(),
                    label: 'Standard',
                    address: address,
                    isDefault: true
                }],
                notes: 'Erstellt via Schnellbuchung',
                totalRides: 0,
                totalRevenue: 0,
                createdAt: Date.now()
            };
            
            // Toast
            const toast = document.createElement('div');
            toast.style.cssText = 'position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:15px 20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:99999;font-weight:600;animation:slideIn 0.3s ease;';
            toast.innerHTML = `â³ Speichere "${name}"...`;
            document.body.appendChild(toast);
            
            try {
                // Speichere in Firebase
                const newRef = await db.ref('customers').push(customer);
                customer.id = newRef.key;
                
                // FÃ¼ge zur lokalen Liste hinzu
                allCustomers.unshift(customer);
                
                // SchlieÃŸe Mini-Modal
                closeMiniModal();
                
                // WÃ¤hle den neuen Kunden in der Schnellbuchung aus
                selectQuickBookingCustomer(customer.id, name, phone, address, '');
                
                // Update Toast
                toast.style.background = '#10b981';
                toast.innerHTML = `âœ… "${name}" ins CRM gespeichert!`;
                setTimeout(() => toast.remove(), 2000);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                toast.style.background = '#ef4444';
                toast.innerHTML = `ğŸ’¾ Fehler beim Speichern!`;
                setTimeout(() => toast.remove(), 3000);
            }
        }
        
        // ğŸ†• v5.64.23: HANDY-KONTAKTE IMPORTIEREN
        async function importPhoneContact() {
            // Check if Contact Picker API is supported
            if (!('contacts' in navigator) || !('ContactsManager' in window)) {
                alert('ğŸ’¾ Dein Browser unterstÃ¼tzt leider keinen Handy-Kontakte-Import.\n\nBitte gib Name und Telefon manuell ein.');
                return;
            }
            
            try {
                const props = ['name', 'tel'];
                const opts = {multiple: false};
                
                const contacts = await navigator.contacts.select(props, opts);
                
                if (contacts && contacts.length > 0) {
                    const contact = contacts[0];
                    const name = contact.name && contact.name.length > 0 ? contact.name[0] : '';
                    const phone = contact.tel && contact.tel.length > 0 ? contact.tel[0] : '';
                    
                    if (!name && !phone) {
                        alert('ğŸ’¾ Kontakt enthÃ¤lt keinen Namen oder Telefonnummer!');
                        return;
                    }
                    
                    // PrÃ¼fe ob Kunde schon existiert
                    const existing = allCustomers.find(c => 
                        (phone && c.phone === phone) || 
                        (name && c.name === name)
                    );
                    
                    if (existing) {
                        // Kunde existiert schon - wÃ¤hle ihn aus
                        selectQuickBookingCustomer(existing.id, existing.name, existing.phone, existing.address || '', existing.favoriteDestination || '');
                        
                        const toast = document.createElement('div');
                        toast.style.cssText = 'position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:15px 20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:99999;font-weight:600;';
                        toast.innerHTML = `âœ… "${existing.name}" ausgewÃ¤hlt!`;
                        document.body.appendChild(toast);
                        setTimeout(() => toast.remove(), 2000);
                    } else {
                        // Neuer Kunde - Ã¶ffne Anlege-Popup mit vorausgefÃ¼llten Daten
                        const searchInput = document.getElementById('quick-booking-customer-search');
                        searchInput.value = phone || name;
                        
                        // Warte kurz, dann Ã¶ffne Popup
                        setTimeout(() => {
                            createNewCustomerFromQuickBooking();
                            
                            // Warte bis Popup da ist, dann fÃ¼lle Felder aus
                            setTimeout(() => {
                                if (phone) document.getElementById('new-qb-customer-phone').value = phone;
                                if (name) document.getElementById('new-qb-customer-name').value = name;
                            }, 100);
                        }, 100);
                    }
                }
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Kontakt-Import:', error);
                if (error.name !== 'AbortError') {
                    alert('ğŸ’¾ Fehler beim Importieren!\n\n' + error.message);
                }
            }
        }
        
        // ğŸ†• v5.90.140: KUNDE AUS SCHNELLBUCHUNG BEARBEITEN - MIT FIREBASE!
        // ğŸ†• v5.90.142: KUNDE AUS SCHNELLBUCHUNG BEARBEITEN - mit getCustomer!
        async function editQuickBookingCustomer() {
            const editBtn = document.getElementById('quick-booking-edit-customer-btn');
            const customerId = editBtn ? editBtn.dataset.customerId : null;
            
            if (!customerId) {
                alert('ğŸ’¾ Kein Kunde ausgewÃ¤hlt!');
                return;
            }
            
            console.log('âœï¸ editQuickBookingCustomer aufgerufen fÃ¼r:', customerId);
            
            // Verwende zentrale getCustomer Funktion
            const customer = await getCustomer(customerId);
            
            if (!customer) {
                alert('ğŸ’¾ Kunde nicht gefunden!');
                return;
            }
            
            // SchlieÃŸe Schnellbuchungs-Modal
            const quickModal = document.getElementById('quick-booking-modal');
            if (quickModal) {
                quickModal.remove();
                console.log('âœ… Schnellbuchungs-Modal geschlossen');
            }
            
            // Rufe editCustomer auf
            editCustomer(customerId);
        }
        
        function selectQuickBookingCustomer(id, name, phone, address, favoriteDestination) {
            console.log('âœ… Kunde gewÃ¤hlt:', name);
            console.log('   ID:', id, '| Phone:', phone); // ğŸ†• v5.87.75
            
            // Setze Hidden Field
            document.getElementById('quick-booking-customer').value = id;
            
            // ğŸ†• v5.87.75: BEI "UNBEKANNT" â†’ TELEFON BEHALTEN!
            const searchField = document.getElementById('quick-booking-customer-search');
            if (id === 'new' || !name || name === 'Unbekannt') {
                // Bei neuen/unbekannten Kunden: TELEFON im Suchfeld behalten!
                if (phone) {
                    searchField.value = phone;
                    console.log('ğŸ’¾ Telefonnummer bleibt im Suchfeld:', phone);
                }
            } else {
                // Bei bekannten Kunden: Namen anzeigen
                searchField.value = name;
            }
            
            // SchlieÃŸe Dropdown
            document.getElementById('quick-booking-customer-dropdown').style.display = 'none';
            
            // ğŸ†• v5.90.125: ZEIGE EDIT-BUTTON wenn Kunde ausgewÃ¤hlt!
            const editBtn = document.getElementById('quick-booking-edit-customer-btn');
            if (editBtn) {
                if (id && id !== 'new') {
                    editBtn.style.display = 'block';
                    // Speichere ID fÃ¼r Edit-Funktion
                    editBtn.dataset.customerId = id;
                } else {
                    editBtn.style.display = 'none';
                }
            }
            
            // ğŸ†• v5.64.3: Leere hÃ¤ufige Zielorte VOR dem Neuladen (verhindert alte Daten)
            const frequentContainer = document.getElementById('quick-booking-frequent-destinations');
            if (frequentContainer) {
                frequentContainer.innerHTML = '';
                frequentContainer.style.display = 'none';
            }
            
            // Lade Kundendaten (Adresse, etc.)
            if (address) {
                document.getElementById('quick-booking-pickup').value = address;
                // ğŸ†• v5.48.4: GEOCODE Adresse um Koordinaten zu bekommen!
                geocodeCustomerAddress(address, 'quick-booking-pickup');
            }
            if (favoriteDestination) {
                document.getElementById('quick-booking-destination').value = favoriteDestination;
                // ğŸ†• v5.48.4: GEOCODE Zieladresse um Koordinaten zu bekommen!
                geocodeCustomerAddress(favoriteDestination, 'quick-booking-destination');
            }
            
            // ğŸ†• v5.49.0: Zeige hÃ¤ufige Zielorte!
            if (phone) {
                console.log('ğŸ”¥ Lade hÃ¤ufige Zielorte fÃ¼r:', name, '(' + phone + ')');
                showFrequentDestinations(phone, id, 'quick-booking-frequent-destinations');
            } else {
                console.log('âš ï¸ Kunde hat keine Telefonnummer â†’ Keine hÃ¤ufigen Zielorte');
            }
        }
        
        // ğŸ†• v5.48.4: Geocode Kundenadresse und setze Koordinaten
        async function geocodeCustomerAddress(address, fieldType) {
            console.log('ğŸŒ Geocode Kundenadresse:', address, 'fÃ¼r', fieldType);
            
            // ğŸ†• v5.48.5: FÃ¼ge Region hinzu wenn keine Stadt/PLZ vorhanden!
            let searchAddress = address;
            const hasCity = address.toLowerCase().includes('heringsdorf') || 
                           address.toLowerCase().includes('zinnowitz') || 
                           address.toLowerCase().includes('ahlbeck') ||
                           address.toLowerCase().includes('bansin') ||
                           address.toLowerCase().includes('Ã¼ckeritz') ||
                           address.toLowerCase().includes('usedom');
            const hasPostalCode = /\d{5}/.test(address); // PrÃ¼fe auf 5-stellige PLZ
            
            if (!hasCity && !hasPostalCode) {
                // FÃ¼ge Heringsdorf + Region hinzu fÃ¼r bessere Geocoding-Ergebnisse
                searchAddress = `${address}, Heringsdorf, Usedom, Mecklenburg-Vorpommern, Deutschland`;
                console.log('ğŸ“ Erweitere Adresse fÃ¼r Geocoding:', searchAddress);
            }
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchAddress)}&limit=1`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    
                    console.log('âœ… Geocoding erfolgreich:', {
                        original: address,
                        searched: searchAddress,
                        result: data[0].display_name,
                        coords: { lat, lon }
                    });
                    
                    // Setze Koordinaten je nach Feld
                    if (fieldType === 'quick-booking-pickup') {
                        quickBookingPickupCoords = { lat, lon };
                        console.log('âœ… Pickup-Koordinaten gesetzt:', quickBookingPickupCoords);
                    } else if (fieldType === 'quick-booking-destination') {
                        quickBookingDestCoords = { lat, lon };
                        console.log('âœ… Destination-Koordinaten gesetzt:', quickBookingDestCoords);
                    } else if (fieldType === 'qb-panel-pickup') {
                        qbPanelPickupCoords = { lat, lon };
                        console.log('âœ… Panel-Pickup-Koordinaten gesetzt:', qbPanelPickupCoords);
                    } else if (fieldType === 'qb-panel-destination') {
                        qbPanelDestCoords = { lat, lon };
                        console.log('âœ… Panel-Destination-Koordinaten gesetzt:', qbPanelDestCoords);
                    }
                } else {
                    console.warn('âš ï¸ Keine Koordinaten gefunden fÃ¼r:', searchAddress);
                }
            } catch (error) {
                console.error('ğŸ’¾ Geocoding Fehler:', error);
            }
        }
        
        function loadQuickBookingCustomerData() {
            const customerId = document.getElementById('quick-booking-customer').value;
            if (!customerId) return;
            
            const customer = allCustomers.find(c => c.id === customerId);
            if (!customer) return;
            
            // Lade Kundendaten ins Formular
            if (customer.address) {
                document.getElementById('quick-booking-pickup').value = customer.address;
            }
            if (customer.favoriteDestination) {
                document.getElementById('quick-booking-destination').value = customer.favoriteDestination;
            }
        }
        
        // ğŸ†• v5.36.0: Vertausche Abholort und Zielort
        function swapQuickBookingLocations() {
            const pickupField = document.getElementById('quick-booking-pickup');
            const destinationField = document.getElementById('quick-booking-destination');
            
            if (!pickupField || !destinationField) return;
            
            // Werte tauschen
            const temp = pickupField.value;
            pickupField.value = destinationField.value;
            destinationField.value = temp;
            
            console.log('â‡„ Orte vertauscht!');
            console.log('  Abholort:', pickupField.value);
            console.log('  Zielort:', destinationField.value);
        }
        
        // ğŸ†• v5.38.4: AUTOCOMPLETE FÃœR SCHNELLBUCHUNG
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let quickBookingPickupCoords = null;
        let quickBookingDestCoords = null;
        let quickBookingAutocompleteTimeout = null;
        
        function setupQuickBookingAutocomplete() {
            ['quick-booking-pickup', 'quick-booking-destination'].forEach(fieldId => {
                const input = document.getElementById(fieldId);
                const dropdown = document.getElementById(fieldId + '-dropdown');
                
                if (!input || !dropdown) return;
                
                // ğŸ†• v5.86.11: FOCUS EVENT - Zeige Favoriten beim Klick!
                input.addEventListener('focus', () => {
                    const value = input.value.trim();
                    if (!value || value.length < 3) {
                        // Zeige Favoriten sofort!
                        searchQuickBookingAddresses('', fieldId);
                    }
                });
                
                input.addEventListener('input', (e) => {
                    // Reset coords
                    if (fieldId === 'quick-booking-pickup') quickBookingPickupCoords = null;
                    else quickBookingDestCoords = null;
                    
                    clearTimeout(quickBookingAutocompleteTimeout);
                    const value = e.target.value.trim();
                    
                    // ğŸ†• v5.86.11: AUCH BEI < 3 ZEICHEN SUCHEN (fÃ¼r Favoriten!)
                    if (value.length === 0) {
                        // Leer? Zeige Favoriten!
                        searchQuickBookingAddresses('', fieldId);
                        return;
                    }
                    
                    if (value.length < 3) {
                        // 1-2 Zeichen? Zeige Favoriten!
                        dropdown.innerHTML = '<div style="padding:10px;color:#999;">Mindestens 3 Zeichen fÃ¼r Suche...</div>';
                        dropdown.style.display = 'block';
                        return;
                    }
                    
                    dropdown.innerHTML = '<div style="padding:10px;color:#999;">Suche...</div>';
                    dropdown.style.display = 'block';
                    
                    quickBookingAutocompleteTimeout = setTimeout(() => {
                        searchQuickBookingAddresses(value, fieldId);
                    }, 300);
                });
                
                // SchlieÃŸe Dropdown
                document.addEventListener('click', (e) => {
                    if (e.target !== input && !dropdown.contains(e.target)) {
                        dropdown.style.display = 'none';
                    }
                });
            });
        }
        
        async function searchQuickBookingAddresses(query, fieldId) {
            const dropdown = document.getElementById(fieldId + '-dropdown');
            
            // ğŸ†• v5.88.30: HÃ¤ufige Ziele aus Cache laden (schnell!)
            const frequentFromBookings = await loadFrequentDestinations();
            
            // POIs aus Firebase
            const savedPOIs = allPOIs.length > 0 ? allPOIs : [];
            
            // Kombiniere: Gespeicherte POIs + HÃ¤ufige Orte aus Buchungen
            const frequentDestinations = [...savedPOIs];
            
            // FÃ¼ge hÃ¤ufige Buchungsziele hinzu (ohne Anzahl - nur "Beliebtes Ziel")
            for (const freq of frequentFromBookings) {
                const alreadyExists = frequentDestinations.some(poi => 
                    poi.name.toLowerCase() === freq.name.toLowerCase() ||
                    (poi.address && poi.address.toLowerCase() === freq.name.toLowerCase())
                );
                if (!alreadyExists) {
                    frequentDestinations.push({
                        name: freq.name,
                        address: freq.name,         // ğŸ”§ v5.90.96: Echte Adresse!
                        label: 'â­ Beliebtes Ziel', // Nur Label zur Anzeige
                        lat: freq.lat,
                        lon: freq.lon,
                        fromBookings: true
                    });
                }
            }
            
            // ğŸ”§ v5.90.94: NUR noch suchbasiert!
            if (!query || query.trim() === '') {
                dropdown.style.display = 'none';
                return;
            }
            
            if (query.length < 2) {
                dropdown.innerHTML = '<div style="padding:10px;color:#999;text-align:center;">ğŸ’¡ Mindestens 2 Zeichen eingeben...</div>';
                dropdown.style.display = 'block';
                return;
            }
            
            try {
                // ğŸ”§ v5.90.193: EINFACHE SUCHE - includes wie vorher!
                const lowerQuery = query.toLowerCase();
                
                // Einfaches Matching in POIs (wie vorher - hat funktioniert!)
                const matchingPOIs = frequentDestinations.filter(dest => 
                    dest.name.toLowerCase().includes(lowerQuery) || 
                    (dest.address && dest.address.toLowerCase().includes(lowerQuery))
                );
                
                console.log('ğŸ” Admin POI-Matching:', matchingPOIs.length, 'Treffer fÃ¼r:', query);
                
                // ğŸ†• v5.90.198: Bekannte Orte auch im Admin!
                const matchingKnownPlaces = [];
                for (const [key, place] of Object.entries(KNOWN_PLACES)) {
                    if (key.includes(lowerQuery) || place.name.toLowerCase().includes(lowerQuery)) {
                        matchingKnownPlaces.push(place);
                    }
                }
                console.log('ğŸ™ï¸ Bekannte Orte gefunden:', matchingKnownPlaces.length);
                
                // ğŸ†• v5.88.24: PARALLELE SUCHE - deutsch UND polnisch gleichzeitig!
                const polishQuery = typeof convertGermanToPolish === 'function' ? convertGermanToPolish(query) : null;
                const queriesAreDifferent = polishQuery && polishQuery.toLowerCase() !== query.toLowerCase();
                
                console.log('ğŸ” Schnellbuchung Suche deutsch:', query);
                if (queriesAreDifferent) {
                    console.log('ğŸ” Schnellbuchung Suche polnisch:', polishQuery);
                }
                
                // Starte beide Suchen parallel
                // ğŸ†• v5.90.650: MIT extratags + namedetails fÃ¼r POI-Namen (Hotels, Restaurants)!
                const searchPromises = [
                    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=de&viewbox=10.6,54.7,14.4,53.1&bounded=1&limit=15&addressdetails=1&extratags=1&namedetails=1`)
                ];
                
                if (queriesAreDifferent) {
                    searchPromises.push(
                        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(polishQuery)}&countrycodes=de&viewbox=10.6,54.7,14.4,53.1&bounded=1&limit=15&addressdetails=1&extratags=1&namedetails=1`)
                    );
                }
                
                const responses = await Promise.all(searchPromises);
                const resultsArrays = await Promise.all(responses.map(r => r.json()));
                
                // Kombiniere Ergebnisse und entferne Duplikate (nach place_id)
                const seenIds = new Set();
                const results = [];
                for (const arr of resultsArrays) {
                    for (const item of arr) {
                        if (!seenIds.has(item.place_id)) {
                            seenIds.add(item.place_id);
                            results.push(item);
                        }
                    }
                }
                
                console.log('âœ… Schnellbuchung kombinierte Ergebnisse:', results.length);
                
                // ğŸ†• v5.90.200: INTELLIGENTE HAUSNUMMERN-SUCHE!
                // Wenn User "KulmstraÃŸe 22" sucht aber nur "KulmstraÃŸe 24" gefunden wird
                // â†’ Zeige trotzdem "KulmstraÃŸe 22" an (mit Koordinaten von StraÃŸe)!
                const hasHouseNumber = /\d+/.test(query);
                if (hasHouseNumber && results.length > 0) {
                    const extractedNumber = query.match(/\d+/)?.[0];
                    const streetName = query.replace(/\d+/g, '').trim();
                    
                    console.log(`ğŸ  Hausnummern-Suche: "${streetName}" Nr. ${extractedNumber}`);
                    
                    // PrÃ¼fe ob die EXAKTE Hausnummer fehlt
                    const hasExactMatch = results.some(r => 
                        r.address?.house_number === extractedNumber &&
                        r.address?.road?.toLowerCase().includes(streetName.toLowerCase())
                    );
                    
                    if (!hasExactMatch) {
                        // Finde StraÃŸe (ohne Hausnummer oder mit anderer Nummer)
                        const streetResult = results.find(r => 
                            r.address?.road?.toLowerCase().includes(streetName.toLowerCase())
                        );
                        
                        if (streetResult) {
                            console.log(`âœ… StraÃŸe gefunden! FÃ¼ge gewÃ¼nschte Hausnummer hinzu: ${extractedNumber}`);
                            
                            // Erstelle "virtuelle" Adresse mit gewÃ¼nschter Hausnummer
                            const virtualAddress = {
                                ...streetResult,
                                display_name: `${streetResult.address.road} ${extractedNumber}, ${streetResult.address.postcode} ${streetResult.address.town || streetResult.address.city}`,
                                address: {
                                    ...streetResult.address,
                                    house_number: extractedNumber
                                },
                                isVirtual: true,
                                place_id: 'virtual_' + Date.now()
                            };
                            
                            // FÃ¼ge OBEN in Liste ein!
                            results.unshift(virtualAddress);
                            console.log('ğŸ¯ Virtuelle Adresse erstellt:', virtualAddress.display_name);
                        }
                    }
                }
                
                // ğŸ†• v5.90.198: Wenn ALLE leer â†’ Keine Ergebnisse
                if (matchingPOIs.length === 0 && matchingKnownPlaces.length === 0 && results.length === 0) {
                    dropdown.innerHTML = '<div style="padding:10px;color:#999;">Keine Ergebnisse</div>';
                    return;
                }
                
                // ğŸ†• v5.90.198: BEKANNTE ORTE ZUERST!
                let knownPlacesHTML = '';
                if (matchingKnownPlaces.length > 0) {
                    knownPlacesHTML = `
                        <div style="padding:8px;background:#dbeafe;border-bottom:2px solid #3b82f6;font-weight:600;font-size:12px;color:#1e40af;">
                            ğŸ‡µğŸ‡± BEKANNTE ORTE
                        </div>
                    `;
                    knownPlacesHTML += matchingKnownPlaces.map(place => {
                        return `
                            <div class="autocomplete-item" onclick="selectQuickBookingAddress('${fieldId}', '${place.fullAddress.replace(/'/g, "\\'")}', ${place.lat}, ${place.lon})" style="
                                padding:12px;
                                cursor:pointer;
                                border-bottom:1px solid #bfdbfe;
                                background:#eff6ff;
                                transition:background 0.2s;
                            " onmouseover="this.style.background='#dbeafe'" onmouseout="this.style.background='#eff6ff'">
                                <div style="font-weight:600;color:#3b82f6;">ğŸ™ï¸ ${place.name}</div>
                                <div style="font-size:13px;color:#666;margin-top:2px;padding-left:20px;">${place.fullAddress}</div>
                            </div>
                        `;
                    }).join('');
                }
                
                // ğŸ†• v5.90.241: DUPLIKATE ENTFERNEN!
                // Wenn "SeebrÃ¼cke Ahlbeck" in knownPlaces ist, nicht nochmal in Nominatim zeigen!
                const knownPlaceNames = matchingKnownPlaces.map(p => p.name.toLowerCase());
                const poiNames = matchingPOIs.map(p => p.name.toLowerCase());
                const allKnownNames = [...knownPlaceNames, ...poiNames];
                
                // Filtere Nominatim-Ergebnisse: Entferne wenn Name schon in bekannten Orten
                const resultsToShow = results.filter(r => {
                    const poiName = (r.address?.amenity || r.address?.tourism || r.address?.building || r.name || '').toLowerCase();
                    return !allKnownNames.includes(poiName);
                });
                
                console.log('ğŸ“± Schnellbuchung: Zeige Ergebnisse nach Duplikat-Entfernung:', resultsToShow.length);
                
                // ğŸ†• v5.90.198: BEKANNTE ORTE ZUERST!
                let poiHTML = '';
                if (matchingPOIs.length > 0) {
                    poiHTML = `
                        <div style="padding:8px;background:#fef3c7;border-bottom:2px solid #f59e0b;font-weight:600;font-size:12px;color:#92400e;">
                            ğŸ¥ BEKANNTE ORTE
                        </div>
                    `;
                    poiHTML += matchingPOIs.map(dest => {
                        // ğŸ”§ v5.90.91: SAUBERE LÃ¶sung - address oder name
                        const addressString = dest.address || dest.name;
                        const displayLabel = dest.label || dest.address || '';
                        
                        return `
                            <div class="autocomplete-item" onclick="selectQuickBookingAddress('${fieldId}', '${addressString.replace(/'/g, "\\'")}', ${dest.lat}, ${dest.lon})" style="
                                padding: 12px;
                                cursor: pointer;
                                border-bottom: 1px solid #e5e7eb;
                                background:#fffbeb;
                            ">
                                <div style="font-weight:600;color:#f59e0b;">ğŸ¥ ${dest.name}</div>
                                <div style="font-size:13px;color:#666;margin-top:2px;padding-left:20px;">${displayLabel}</div>
                            </div>
                        `;
                    }).join('');
                    
                    // Nur Trennlinie wenn auch Nominatim-Ergebnisse kommen
                    if (results.length > 0) {
                        poiHTML += `
                            <div style="padding:8px;background:#f3f4f6;border-bottom:2px solid #9ca3af;font-weight:600;font-size:12px;color:#4b5563;">
                                ğŸ“ WEITERE ERGEBNISSE
                            </div>
                        `;
                    }
                }
                
                // ğŸ†• v5.90.242: REIHENFOLGE: Favoriten (POIs) ZUERST, dann Bekannte Orte, dann Nominatim!
                dropdown.innerHTML = poiHTML + knownPlacesHTML + resultsToShow.map(r => {
                    const address = r.address;
                    let displayText = '';
                    let fullAddress = '';
                    
                    // ğŸ†• v5.90.200: Markiere virtuelle Hausnummern!
                    const isVirtual = r.isVirtual === true;
                    
                    // ğŸ¨ HOTEL, RESTAURANT, POI, KRANKENHAUS Namen
                    // ğŸ†• v5.90.650: ERWEITERTE POI-Erkennung wie im CRM Map Picker!
                    let poiName = r.name; // PrimÃ¤r: Offizieller Name aus Nominatim!
                    
                    // Falls kein Name: Versuche spezifische POI-Felder
                    if (!poiName || poiName === address.road) {
                        poiName = address.hotel || 
                                  address.restaurant || 
                                  address.cafe || 
                                  address.tourism || 
                                  address.amenity || 
                                  address.shop || 
                                  address.building;
                    }
                    
                    // Baue Haupt-Adresszeile
                    if (address.road) {
                        fullAddress = address.road;
                        if (address.house_number) fullAddress += ' ' + address.house_number;
                    }
                    
                    // Ort
                    let city = '';
                    if (address.village) city = address.village;
                    else if (address.town) city = address.town;
                    else if (address.city) city = address.city;
                    else if (address.municipality) city = address.municipality;
                    
                    // PLZ
                    const zip = address.postcode || '';
                    
                    // ğŸ¨ Baue schÃ¶ne Anzeige (wie Fahrgast-Tab!)
                    if (poiName && poiName !== fullAddress && poiName !== city && poiName !== address.road) {
                        displayText = `<div style="font-weight:600;color:#667eea;">ğŸ¨ ${poiName}</div>`;
                        displayText += `<div style="font-size:13px;color:#666;margin-top:2px;padding-left:20px;">`;
                        if (fullAddress) displayText += fullAddress;
                        if (zip) displayText += ', ' + zip;
                        if (city) displayText += ' ' + city;
                        displayText += '</div>';
                    } else {
                        if (fullAddress) {
                            displayText = fullAddress;
                            if (zip) displayText += ', ' + zip;
                            if (city) displayText += ' ' + city;
                            
                            // ğŸ†• v5.90.200: Zeige Badge fÃ¼r virtuelle Hausnummer!
                            if (isVirtual) {
                                displayText = `<div style="display:flex;align-items:center;gap:8px;">
                                    <span>ğŸ </span>
                                    <span>${displayText}</span>
                                    <span style="background:#10b981;color:white;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600;">SMART</span>
                                </div>`;
                            }
                        } else {
                            displayText = r.display_name;
                        }
                    }
                    
                    // VollstÃ¤ndige Adresse als String
                    let addressString = '';
                    if (poiName && poiName !== fullAddress && poiName !== city && poiName !== address.road) {
                        addressString = poiName + ', ';
                    }
                    if (fullAddress) addressString += fullAddress;
                    if (zip) addressString += ', ' + zip;
                    if (city) addressString += ' ' + city;
                    
                    if (!addressString) addressString = r.display_name;
                    
                    return `
                        <div class="autocomplete-item" onclick="selectQuickBookingAddress('${fieldId}', '${addressString.replace(/'/g, "\\'")}', ${r.lat}, ${r.lon})" style="
                            padding:12px;
                            cursor:pointer;
                            border-bottom:1px solid ${isVirtual ? '#10b981' : '#f0f0f0'};
                            ${isVirtual ? 'background:#f0fdf4;border-left:3px solid #10b981;' : ''}
                            transition:background 0.2s;
                        " onmouseover="this.style.background='${isVirtual ? '#d1fae5' : '#f9fafb'}'" onmouseout="this.style.background='${isVirtual ? '#f0fdf4' : 'white'}'">
                            ${displayText}
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Autocomplete Fehler:', error);
                dropdown.innerHTML = '<div style="padding:10px;color:#ef4444;">Fehler bei der Suche</div>';
            }
        }
        
        function selectQuickBookingAddress(fieldId, address, lat, lon) {
            const input = document.getElementById(fieldId);
            const dropdown = document.getElementById(fieldId + '-dropdown');
            
            // ğŸ”§ v5.90.90: WARN wenn "Beliebtes Ziel" in Adresse!
            if (address && address.includes('Beliebtes Ziel')) {
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.error('ğŸš¨ QUICK-BOOKING: "Beliebtes Ziel" erkannt!');
                console.error('ğŸ“ Adresse:', address);
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
                // Notfall-Fix
                address = address.replace(', Beliebtes Ziel', '').replace(',Beliebtes Ziel', '');
                console.log('âœ… Bereinigt zu:', address);
            }
            
            input.value = address;
            dropdown.style.display = 'none';
            
            // Speichere Koordinaten
            if (fieldId === 'quick-booking-pickup') {
                quickBookingPickupCoords = { lat, lon };
            } else {
                quickBookingDestCoords = { lat, lon };
            }
            
            console.log('ğŸ“ Adresse gewÃ¤hlt:', address, {lat, lon});
        }
        
        // ğŸ†• v5.38.4: FAHRZEUG-LISTE LADEN
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function loadQuickBookingVehicles() {
            const select = document.getElementById('quick-booking-vehicle');
            if (!select) return;
            
            if (isFirebaseReady) {
                db.ref('vehicles').once('value').then(snapshot => {
                    const vehicles = [];
                    snapshot.forEach(child => {
                        const v = child.val();
                        v.id = child.key;
                        vehicles.push(v);
                    });
                    
                    // ğŸ†• v5.90.235: Sortiere: PrioritÃ¤t â†’ Online â†’ Alphabetisch
                    vehicles.sort((a, b) => {
                        // 1. PrioritÃ¤t (1=hoch, 10=niedrig)
                        const priorityA = a.priority || 5;
                        const priorityB = b.priority || 5;
                        if (priorityA !== priorityB) return priorityA - priorityB;
                        
                        // 2. Online-Status
                        if (a.isOnline && !b.isOnline) return -1;
                        if (!a.isOnline && b.isOnline) return 1;
                        
                        // 3. Alphabetisch
                        return (a.name || '').localeCompare(b.name || '');
                    });
                    
                    // FÃ¼lle Dropdown
                    select.innerHTML = '<option value="">Automatisch zuweisen</option>' +
                        vehicles.map(v => {
                            const onlineText = v.isOnline ? 'ğŸŸ¢' : 'ğŸ”´';
                            return `<option value="${v.id}">${onlineText} ${v.name || v.id}</option>`;
                        }).join('');
                    
                    console.log('ğŸš— Fahrzeuge geladen:', vehicles.length);
                });
            }
        }
        
        // ğŸ†• v5.38.4: FAVORITEN SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // ğŸ†• v5.90.252: HELPER - IST FAHRT HEUTE/AKTIV?
        function isRideActiveToday(ride) {
            if (!ride || !ride.vehicleId) return false;
            
            // ğŸ†• v5.90.525: on_way hinzugefÃ¼gt!
            // accepted = Angenommen â†’ Taxi BESETZT
            // on_way = Fahre zum Kunden â†’ Taxi BESETZT
            // picked_up = Kunde drin â†’ Taxi BESETZT
            if (!['accepted', 'on_way', 'picked_up'].includes(ride.status)) return false;
            
            // Zeit-Check: Nur HEUTE oder frÃ¼her!
            const todayEnd = new Date();
            todayEnd.setHours(23, 59, 59, 999);
            
            const rideTime = ride.pickupTimestamp || ride.timestamp || 0;
            
            // Fahrt ist HEUTE oder in Vergangenheit?
            const isToday = rideTime <= todayEnd.getTime();
            
            if (!isToday) {
                console.log(`â° Fahrt fÃ¼r ${ride.vehicleId} ist in Zukunft (${new Date(rideTime).toLocaleDateString('de-DE')}) â†’ NICHT als aktiv markiert`);
            }
            
            return isToday;
        }
        
        // ğŸ†• v5.90.253: DEV MODE SYSTEM! ğŸ”
        let devModeActive = false;
        let devTooltip = null;
        
        function toggleDevMode() {
            devModeActive = !devModeActive;
            
            const statusSpan = document.getElementById('dev-mode-status');
            const toggleBtn = document.getElementById('dev-mode-toggle');
            
            if (devModeActive) {
                statusSpan.textContent = 'AN';
                statusSpan.style.color = '#10b981';
                toggleBtn.style.background = 'rgba(16, 185, 129, 0.3)';
                toggleBtn.style.borderColor = 'rgba(16, 185, 129, 0.5)';
                
                // Erstelle Tooltip Element
                createDevTooltip();
                
                // Aktiviere Hover Events
                activateDevMode();
                
                console.log('ğŸ” Dev Mode AKTIVIERT!');
                
                // Toast
                showToast('ğŸ” Dev Mode aktiviert!', 'Bewege Maus Ã¼ber Elemente', '#10b981');
            } else {
                statusSpan.textContent = 'AUS';
                statusSpan.style.color = 'white';
                toggleBtn.style.background = 'rgba(255,255,255,0.2)';
                toggleBtn.style.borderColor = 'rgba(255,255,255,0.3)';
                
                // Deaktiviere
                deactivateDevMode();
                
                console.log('ğŸ” Dev Mode DEAKTIVIERT!');
                
                showToast('ğŸ” Dev Mode deaktiviert', '', '#6b7280');
            }
        }
        
        function createDevTooltip() {
            if (devTooltip) return;
            
            devTooltip = document.createElement('div');
            devTooltip.id = 'dev-tooltip';
            devTooltip.style.cssText = `
                position: fixed;
                background: rgba(0, 0, 0, 0.95);
                color: white;
                padding: 12px 16px;
                border-radius: 8px;
                font-size: 12px;
                font-family: monospace;
                pointer-events: none;
                z-index: 999999;
                display: none;
                max-width: 400px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
                border: 2px solid #10b981;
            `;
            document.body.appendChild(devTooltip);
        }
        
        function activateDevMode() {
            // FÃ¼ge Hover Events zu allen interaktiven Elementen hinzu
            document.addEventListener('mouseover', handleDevHover);
            document.addEventListener('mouseout', handleDevOut);
            // ğŸ†• v5.90.254: Rechtsklick fixiert Tooltip!
            document.addEventListener('contextmenu', handleDevRightClick);
        }
        
        function deactivateDevMode() {
            document.removeEventListener('mouseover', handleDevHover);
            document.removeEventListener('mouseout', handleDevOut);
            document.removeEventListener('contextmenu', handleDevRightClick);
            
            if (devTooltip) {
                devTooltip.style.display = 'none';
            }
        }
        
        let tooltipPinned = false;
        let pinnedElement = null;
        
        function handleDevRightClick(e) {
            if (!devModeActive || !devTooltip) return;
            
            // Wenn Tooltip angeklickt wird, ignoriere
            if (e.target === devTooltip || devTooltip.contains(e.target)) {
                return;
            }
            
            // Verhindere Standard Context Menu
            e.preventDefault();
            e.stopPropagation();
            
            // Toggle Pin
            if (tooltipPinned && pinnedElement === e.target) {
                // Unpin
                tooltipPinned = false;
                pinnedElement = null;
                devTooltip.style.borderColor = '#10b981';
                console.log('ğŸ“ Tooltip gelÃ¶st');
            } else {
                // Pin
                tooltipPinned = true;
                pinnedElement = e.target;
                devTooltip.style.borderColor = '#f59e0b'; // Orange = Gepinnt
                console.log('ğŸ“Œ Tooltip fixiert! (Nochmal Rechtsklick zum LÃ¶sen)');
                
                // Zeige Info im Tooltip
                showDevInfo(e.target, e.clientX, e.clientY, true);
            }
            
            return false;
        }
        
        function handleDevHover(e) {
            if (!devModeActive || !devTooltip) return;
            
            // Wenn gepinnt, ignoriere Hover
            if (tooltipPinned) return;
            
            showDevInfo(e.target, e.clientX, e.clientY, false);
        }
        
        function handleDevOut(e) {
            if (!devModeActive || !devTooltip) return;
            
            // Wenn gepinnt, nicht ausblenden
            if (tooltipPinned) return;
            
            devTooltip.style.display = 'none';
        }
        
        function showDevInfo(target, x, y, isPinned) {
            if (!devTooltip) return;
            
            // Ignoriere Tooltip selbst
            if (target.id === 'dev-tooltip') return;
            
            // Sammle Infos
            let info = [];
            
            // ğŸ†• Pinned Status
            if (isPinned) {
                info.push(`ğŸ“Œ <strong style="color:#f59e0b;">FIXIERT (Rechtsklick zum LÃ¶sen)</strong>`);
            }
            
            // Element Type
            info.push(`ğŸ“¦ <strong>Tag:</strong> ${target.tagName.toLowerCase()}`);
            
            // ID
            if (target.id) {
                info.push(`ğŸ†” <strong>ID:</strong> ${target.id}`);
            }
            
            // Klassen
            if (target.className && typeof target.className === 'string' && target.className.trim()) {
                info.push(`ğŸ¨ <strong>Class:</strong> ${target.className}`);
            }
            
            // onclick Funktion
            if (target.onclick) {
                const funcStr = target.onclick.toString();
                const funcName = funcStr.match(/function\s+(\w+)|(\w+)\s*\(/);
                if (funcName) {
                    info.push(`âš¡ <strong>onClick:</strong> ${funcName[1] || funcName[2] || 'anonymous'}()`);
                } else {
                    // Extrahiere ersten Teil der Funktion
                    const snippet = funcStr.substring(0, 50).replace(/\n/g, ' ');
                    info.push(`âš¡ <strong>onClick:</strong> ${snippet}...`);
                }
            }
            
            // oninput Funktion
            if (target.oninput) {
                const funcStr = target.oninput.toString();
                const funcName = funcStr.match(/(\w+)\s*\(/);
                if (funcName) {
                    info.push(`âŒ¨ï¸ <strong>onInput:</strong> ${funcName[1]}()`);
                }
            }
            
            // Value (fÃ¼r Inputs)
            if (target.value !== undefined && target.tagName.toLowerCase() !== 'button') {
                info.push(`ğŸ’¬ <strong>Value:</strong> "${target.value}"`);
            }
            
            // Placeholder
            if (target.placeholder) {
                info.push(`ğŸ“ <strong>Placeholder:</strong> "${target.placeholder}"`);
            }
            
            // data-* Attribute
            for (const attr of target.attributes) {
                if (attr.name.startsWith('data-')) {
                    info.push(`ğŸ“± <strong>${attr.name}:</strong> ${attr.value}`);
                }
            }
            
            // Parent View (suche nach view Container)
            let viewParent = target.closest('.view');
            if (viewParent && viewParent.id) {
                info.push(`ğŸ–¥ï¸ <strong>View:</strong> ${viewParent.id}`);
            }
            
            // Modal?
            let modalParent = target.closest('[id*="modal"]');
            if (modalParent && modalParent.id) {
                info.push(`ğŸªŸ <strong>Modal:</strong> ${modalParent.id}`);
            }
            
            // Nur anzeigen wenn wir Infos haben
            if (info.length > 1) {
                devTooltip.innerHTML = info.join('<br>');
                devTooltip.style.display = 'block';
                
                // Position bei Maus
                devTooltip.style.left = (x + 15) + 'px';
                devTooltip.style.top = (y + 15) + 'px';
            }
        }
        
        function showToast(title, message, color) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${color};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 99999;
                font-weight: 600;
                font-size: 14px;
            `;
            toast.innerHTML = `<div>${title}</div>${message ? '<div style="font-size:12px;opacity:0.9;margin-top:4px;">' + message + '</div>' : ''}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }
        
        function showQuickBookingFavorites() {
            const favorites = JSON.parse(localStorage.getItem('quickBookingFavorites') || '[]');
            
            if (favorites.length === 0) {
                alert('â„¹ï¸ Noch keine Favoriten gespeichert!\n\nFÃ¼lle Abholort und Zielort aus und klicke auf "Als Favorit speichern".');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'quick-booking-favorites-modal'; // ğŸ”§ v5.90.105: ID hinzugefÃ¼gt!
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:10002;padding:15px;';
            
            modal.innerHTML = `
                <div style="background:white;border-radius:16px;padding:20px;width:100%;max-width:500px;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h3 style="margin:0;font-size:18px;">â­ Favoriten</h3>
                        <button onclick="document.getElementById('quick-booking-favorites-modal').remove()" style="background:none;border:none;font-size:28px;cursor:pointer;color:#999;line-height:1;">Ã—</button>
                    </div>
                    
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        ${favorites.map((fav, index) => `
                            <div style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:12px;">
                                <div style="font-size:13px;margin-bottom:8px;">
                                    <div><strong>ğŸ“ Von:</strong> ${fav.pickup}</div>
                                    <div><strong>ğŸ¯ Nach:</strong> ${fav.destination}</div>
                                </div>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;">
                                    <button onclick="useQuickBookingFavorite(${index})" style="padding:8px;background:#10b981;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;font-weight:600;">
                                        âœ… Verwenden
                                    </button>
                                    <button onclick="deleteQuickBookingFavorite(${index})" style="padding:8px;background:#ef4444;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;font-weight:600;">
                                        ğŸ—‘ï¸ LÃ¶schen
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <button onclick="document.getElementById('quick-booking-favorites-modal').remove()" style="width:100%;margin-top:15px;padding:12px;background:#f3f4f6;color:#666;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                        SchlieÃŸen
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function useQuickBookingFavorite(index) {
            const favorites = JSON.parse(localStorage.getItem('quickBookingFavorites') || '[]');
            const fav = favorites[index];
            
            if (!fav) return;
            
            document.getElementById('quick-booking-pickup').value = fav.pickup;
            document.getElementById('quick-booking-destination').value = fav.destination;
            
            // Speichere Koordinaten falls vorhanden
            if (fav.pickupCoords) quickBookingPickupCoords = fav.pickupCoords;
            if (fav.destCoords) quickBookingDestCoords = fav.destCoords;
            
            // SchlieÃŸe Modal
            document.querySelectorAll('div[style*="z-index:10001"]').forEach(m => m.remove());
            
            console.log('â­ Favorit verwendet:', fav);
        }
        
        function deleteQuickBookingFavorite(index) {
            if (!confirm('Favorit wirklich lÃ¶schen?')) return;
            
            const favorites = JSON.parse(localStorage.getItem('quickBookingFavorites') || '[]');
            favorites.splice(index, 1);
            localStorage.setItem('quickBookingFavorites', JSON.stringify(favorites));
            
            // Refresh Modal
            document.querySelectorAll('div[style*="z-index:10001"]').forEach(m => m.remove());
            showQuickBookingFavorites();
        }
        
        function saveQuickBookingAsFavorite() {
            const pickup = document.getElementById('quick-booking-pickup').value.trim();
            const destination = document.getElementById('quick-booking-destination').value.trim();
            
            if (!pickup || !destination) {
                alert('ğŸ’¾ Bitte Abholort und Zielort ausfÃ¼llen!');
                return;
            }
            
            const favorites = JSON.parse(localStorage.getItem('quickBookingFavorites') || '[]');
            
            // Check Duplikat
            const exists = favorites.some(f => f.pickup === pickup && f.destination === destination);
            if (exists) {
                alert('â„¹ï¸ Dieser Favorit existiert bereits!');
                return;
            }
            
            favorites.push({
                pickup,
                destination,
                pickupCoords: quickBookingPickupCoords,
                destCoords: quickBookingDestCoords,
                created: Date.now()
            });
            
            localStorage.setItem('quickBookingFavorites', JSON.stringify(favorites));
            alert('âœ… Als Favorit gespeichert!');
        }
        
        // ğŸ†• v5.90.105: ZIELORT ALS POI SPEICHERN
        async function saveDestinationAsPOI() {
            console.log('â­ saveDestinationAsPOI() aufgerufen');
            
            const destinationInput = document.getElementById('quick-booking-destination');
            if (!destinationInput) {
                console.error('ğŸ’¾ quick-booking-destination Input nicht gefunden!');
                alert('ğŸ’¾ Fehler: Zielort-Feld nicht gefunden!');
                return;
            }
            
            const destination = destinationInput.value.trim();
            console.log('ğŸ“ Zielort:', destination);
            
            if (!destination) {
                console.warn('âš ï¸ Kein Zielort eingegeben');
                alert('ğŸ’¾ Bitte erst einen Zielort eingeben!');
                return;
            }
            
            // Frage nach POI-Name
            const poiName = prompt('â­ POI-Name eingeben:\n\nWie soll dieser Ort gespeichert werden?\n(z.B. "Hotel Ahlbeck", "Flughafen", "Bahnhof")', '');
            console.log('ğŸ“ POI-Name eingegeben:', poiName);
            
            if (!poiName || !poiName.trim()) {
                console.log('ğŸ’¾ POI-Speichern abgebrochen (kein Name)');
                return; // Abgebrochen
            }
            
            try {
                // Hole Koordinaten
                let coords = quickBookingDestCoords;
                console.log('ğŸ“ Aktuelle Coords:', coords);
                
                // Falls noch keine Coords â†’ geocode jetzt
                if (!coords || !coords.lat || !coords.lon) {
                    console.log('ğŸ” Geocode Zielort fÃ¼r POI...');
                    coords = await geocode(destination);
                    if (!coords) {
                        console.error('ğŸ’¾ Geocoding fehlgeschlagen');
                        alert('ğŸ’¾ Konnte Koordinaten nicht ermitteln!');
                        return;
                    }
                    console.log('âœ… Geocoding erfolgreich:', coords);
                }
                
                // Speichere in Firebase
                const poiData = {
                    name: poiName.trim(),
                    address: destination,
                    lat: coords.lat,
                    lon: coords.lon,
                    category: 'Sonstige', // Default Kategorie
                    createdAt: Date.now(),
                    createdBy: 'Schnellbuchung',
                    source: 'manual'
                };
                
                console.log('ğŸ’¾ Speichere POI in Firebase:', poiData);
                await db.ref('pois').push(poiData);
                console.log('âœ… POI erfolgreich in Firebase gespeichert!');
                
                // Erfolgsmeldung
                const toast = document.createElement('div');
                toast.style.cssText = 'position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:15px 25px;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.2);z-index:99999;font-weight:700;font-size:15px;display:flex;align-items:center;gap:10px;';
                toast.innerHTML = `
                    <div style="font-size:24px;">â­</div>
                    <div>
                        <div style="font-size:15px;">${poiName}</div>
                        <div style="font-size:12px;opacity:0.9;font-weight:400;margin-top:2px;">Als POI gespeichert!</div>
                    </div>
                `;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
                
                console.log('âœ… Toast angezeigt - POI gespeichert:', poiName, destination);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim POI speichern:', error);
                console.error('   Error Details:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                alert('ğŸ’¾ Fehler beim Speichern: ' + error.message);
            }
        }
        
        // ğŸ†• v5.90.236: KARTEN-PICKER FÃœR SCHNELLBUCHUNG!
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let quickBookingMapPickerMap = null;
        let quickBookingMapPickerMarker = null;
        
        function openQuickBookingMapPicker() {
            console.log('ğŸ“ Ã–ffne Karten-Picker...');
            
            // Modal erstellen
            const modal = document.createElement('div');
            modal.id = 'quick-booking-map-picker-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:10002;padding:20px;';
            
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;width:100%;max-width:900px;max-height:90vh;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                    <!-- Header -->
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:20px;background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white;">
                        <h3 style="margin:0;font-size:18px;font-weight:700;">ğŸ“ Zielort auf Karte wÃ¤hlen</h3>
                        <button onclick="closeQuickBookingMapPicker()" style="background:none;border:none;font-size:28px;cursor:pointer;color:white;line-height:1;padding:0;opacity:0.9;">Ã—</button>
                    </div>
                    
                    <!-- Info -->
                    <div style="padding:15px;background:#eff6ff;border-bottom:2px solid #3b82f6;">
                        <div style="font-size:13px;color:#1e40af;font-weight:600;">
                            ğŸ’¡ Klicke auf die Karte um einen Ort auszuwÃ¤hlen
                        </div>
                    </div>
                    
                    <!-- Karte -->
                    <div id="quick-booking-map-picker" style="flex:1;min-height:400px;"></div>
                    
                    <!-- AusgewÃ¤hlte Adresse -->
                    <div id="quick-booking-map-picker-selected" style="display:none;padding:15px;background:#f0fdf4;border-top:2px solid #10b981;">
                        <div style="font-size:12px;color:#048257;font-weight:600;margin-bottom:4px;">âœ… AusgewÃ¤hlt:</div>
                        <div id="quick-booking-map-picker-address" style="font-size:14px;color:#1f2937;font-weight:600;"></div>
                    </div>
                    
                    <!-- Buttons -->
                    <div style="padding:20px;background:#f9fafb;border-top:1px solid #e5e7eb;display:flex;gap:10px;">
                        <button onclick="closeQuickBookingMapPicker()" style="flex:1;padding:12px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                            Abbrechen
                        </button>
                        <button id="quick-booking-map-picker-confirm" onclick="confirmQuickBookingMapPicker()" disabled style="flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;opacity:0.5;">
                            âœ… Ãœbernehmen
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initialisiere Karte nach kurzer VerzÃ¶gerung
            setTimeout(() => {
                initQuickBookingMapPicker();
            }, 100);
        }
        
        function initQuickBookingMapPicker() {
            const container = document.getElementById('quick-booking-map-picker');
            if (!container) return;
            
            console.log('ğŸ—ºï¸ Initialisiere Karten-Picker...');
            
            // Default: Heringsdorf
            const defaultLat = 53.9547;
            const defaultLon = 14.1783;
            
            // Erstelle Karte
            quickBookingMapPickerMap = L.map(container).setView([defaultLat, defaultLon], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap'
            }).addTo(quickBookingMapPickerMap);
            
            // Klick auf Karte
            quickBookingMapPickerMap.on('click', async function(e) {
                const lat = e.latlng.lat;
                const lon = e.latlng.lng;
                
                console.log('ğŸ“ Karte geklickt:', lat, lon);
                
                // Entferne alten Marker
                if (quickBookingMapPickerMarker) {
                    quickBookingMapPickerMap.removeLayer(quickBookingMapPickerMarker);
                }
                
                // Neuer Marker
                quickBookingMapPickerMarker = L.marker([lat, lon], {
                    icon: L.divIcon({
                        html: '<div style="background:#3b82f6;color:white;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-size:16px;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);">ğŸ“</div>',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                }).addTo(quickBookingMapPickerMap);
                
                // Lade Adresse
                await loadQuickBookingMapPickerAddress(lat, lon);
            });
            
            console.log('âœ… Karten-Picker initialisiert!');
        }
        
        async function loadQuickBookingMapPickerAddress(lat, lon) {
            console.log('ğŸ”„ Lade Adresse fÃ¼r:', lat, lon);
            
            const selectedDiv = document.getElementById('quick-booking-map-picker-selected');
            const addressDiv = document.getElementById('quick-booking-map-picker-address');
            const confirmBtn = document.getElementById('quick-booking-map-picker-confirm');
            
            // Zeige "LÃ¤dt..."
            selectedDiv.style.display = 'block';
            addressDiv.textContent = 'ğŸ”„ Lade Adresse...';
            confirmBtn.disabled = true;
            confirmBtn.style.opacity = '0.5';
            
            try {
                // Reverse Geocoding
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`
                );
                const data = await response.json();
                
                console.log('âœ… Adresse geladen:', data);
                
                // Baue Adresse
                const address = data.address || {};
                let displayAddress = '';
                
                if (address.road) {
                    displayAddress = address.road;
                    if (address.house_number) displayAddress += ' ' + address.house_number;
                }
                
                if (address.postcode && address.village) {
                    if (displayAddress) displayAddress += ', ';
                    displayAddress += address.postcode + ' ' + address.village;
                } else if (address.postcode && address.town) {
                    if (displayAddress) displayAddress += ', ';
                    displayAddress += address.postcode + ' ' + address.town;
                } else if (address.postcode && address.city) {
                    if (displayAddress) displayAddress += ', ';
                    displayAddress += address.postcode + ' ' + address.city;
                }
                
                if (!displayAddress) {
                    displayAddress = data.display_name;
                }
                
                // Zeige Adresse
                addressDiv.textContent = displayAddress;
                
                // Speichere fÃ¼r Ãœbernahme
                quickBookingMapPickerMarker.pickedAddress = displayAddress;
                quickBookingMapPickerMarker.pickedLat = lat;
                quickBookingMapPickerMarker.pickedLon = lon;
                
                // Aktiviere Button
                confirmBtn.disabled = false;
                confirmBtn.style.opacity = '1';
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der Adresse:', error);
                addressDiv.textContent = 'ğŸ’¾ Fehler beim Laden der Adresse';
                confirmBtn.disabled = true;
                confirmBtn.style.opacity = '0.5';
            }
        }
        
        function confirmQuickBookingMapPicker() {
            if (!quickBookingMapPickerMarker || !quickBookingMapPickerMarker.pickedAddress) {
                alert('ğŸ’¾ Bitte erst einen Ort auf der Karte auswÃ¤hlen!');
                return;
            }
            
            console.log('âœ… Ãœbernehme Adresse:', quickBookingMapPickerMarker.pickedAddress);
            
            // FÃ¼lle Zielort-Feld
            const destField = document.getElementById('quick-booking-destination');
            if (destField) {
                destField.value = quickBookingMapPickerMarker.pickedAddress;
                
                // Speichere Koordinaten
                quickBookingDestCoords = {
                    lat: quickBookingMapPickerMarker.pickedLat,
                    lon: quickBookingMapPickerMarker.pickedLon
                };
                
                console.log('âœ… Koordinaten gespeichert:', quickBookingDestCoords);
            }
            
            // SchlieÃŸe Modal
            closeQuickBookingMapPicker();
            
            // Trigger Preis-Berechnung
            setTimeout(() => {
                if (destField) {
                    destField.dispatchEvent(new Event('change'));
                }
            }, 100);
        }
        
        function closeQuickBookingMapPicker() {
            const modal = document.getElementById('quick-booking-map-picker-modal');
            if (modal) {
                // Cleanup Karte
                if (quickBookingMapPickerMap) {
                    quickBookingMapPickerMap.remove();
                    quickBookingMapPickerMap = null;
                }
                quickBookingMapPickerMarker = null;
                
                // Entferne Modal
                modal.remove();
            }
        }
        
        // ğŸ†• v5.90.535: UNIVERSAL KARTEN-PICKER FÃœR ALLE ADRESS-FELDER!
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let universalMapPicker = {
            map: null,
            marker: null,
            targetInputId: null,
            onConfirm: null,
            nearbyPOIs: [],
            poiMarkers: [] // ğŸ†• v5.90.651: Marker fÃ¼r POIs auf der Karte
        };
        
        // ğŸ†• v5.90.651: Filtere nur echte POIs (keine Privatadressen)
        function filterPublicPOIs(allPOIs) {
            if (!allPOIs || allPOIs.length === 0) return [];
            
            const poiKeywords = [
                'bahnhof', 'hotel', 'restaurant', 'cafÃ©', 'cafe', 
                'seebrÃ¼cke', 'strand', 'flughafen', 'krankenhaus',
                'klinik', 'apotheke', 'kirche', 'museum', 'rathaus',
                'einkaufszentrum', 'supermarkt', 'tankstelle',
                'campingplatz', 'ferienwohnung', 'pension', 'imbiss',
                'pizzeria', 'gaststÃ¤tte', 'bar', 'kneipe', 'disco',
                'theater', 'kino', 'bibliothek', 'schwimmbad', 'sauna',
                'fitness', 'arzt', 'zahnarzt', 'tierarzt', 'polizei',
                'feuerwehr', 'post', 'bank', 'sparkasse', 'geldautomat'
            ];
            
            // HÃ¤ufige Personennamen (Blacklist)
            const nameBlacklist = [
                'herr', 'frau', 'dr.', 'prof.', 'familie',
                'mÃ¼ller', 'schmidt', 'schneider', 'fischer', 'weber',
                'meyer', 'wagner', 'becker', 'schulz', 'hoffmann'
            ];
            
            return allPOIs.filter(poi => {
                if (!poi.name || !poi.lat || !poi.lon) return false;
                
                const nameLower = poi.name.toLowerCase();
                
                // Blacklist Check: Personennamen raus!
                if (nameBlacklist.some(name => nameLower.includes(name))) {
                    return false;
                }
                
                // Keyword Check: EnthÃ¤lt POI-Keywords?
                const hasPOIKeyword = poiKeywords.some(keyword => nameLower.includes(keyword));
                
                // Nur durchlassen wenn POI-Keyword gefunden
                return hasPOIKeyword;
            });
        }
        
        function openUniversalMapPicker(inputId, title = 'ğŸ“ Adresse auf Karte wÃ¤hlen', onConfirmCallback = null) {
            console.log('ğŸ“ v5.90.535: Ã–ffne Universal Karten-Picker fÃ¼r:', inputId);
            
            universalMapPicker.targetInputId = inputId;
            universalMapPicker.onConfirm = onConfirmCallback;
            
            // Modal erstellen
            const modal = document.createElement('div');
            modal.id = 'universal-map-picker-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:100001;padding:20px;';
            
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;width:100%;max-width:900px;max-height:90vh;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                    <!-- Header -->
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:20px;background:linear-gradient(135deg,#10b981,#059669);color:white;">
                        <h3 style="margin:0;font-size:18px;font-weight:700;">${title}</h3>
                        <button onclick="closeUniversalMapPicker()" style="background:none;border:none;font-size:28px;cursor:pointer;color:white;line-height:1;padding:0;opacity:0.9;">Ã—</button>
                    </div>
                    
                    <!-- Info -->
                    <div style="padding:15px;background:#ecfdf5;border-bottom:2px solid #10b981;">
                        <div style="font-size:13px;color:#065f46;font-weight:600;">
                            ğŸ’¡ Klicke auf die Karte um einen Ort auszuwÃ¤hlen
                        </div>
                    </div>
                    
                    <!-- ğŸ†• v5.90.653: POI FILTER BUTTONS -->
                    <div id="poi-filter-buttons" style="padding:12px 15px;background:#f9fafb;border-bottom:1px solid #e5e7eb;display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
                        <button onclick="filterPOIsByType('all')" class="poi-filter-btn active" data-type="all" style="padding:8px 14px;background:#10b981;color:white;border:2px solid #10b981;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;">
                            ğŸ—ºï¸ Alle
                        </button>
                        <button onclick="filterPOIsByType('bahnhof')" class="poi-filter-btn" data-type="bahnhof" style="padding:8px 14px;background:white;color:#374151;border:2px solid #e5e7eb;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;">
                            ğŸš‰ BahnhÃ¶fe
                        </button>
                        <button onclick="filterPOIsByType('hotel')" class="poi-filter-btn" data-type="hotel" style="padding:8px 14px;background:white;color:#374151;border:2px solid #e5e7eb;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;">
                            ğŸ¨ Hotels
                        </button>
                        <button onclick="filterPOIsByType('restaurant')" class="poi-filter-btn" data-type="restaurant" style="padding:8px 14px;background:white;color:#374151;border:2px solid #e5e7eb;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;">
                            ğŸ½ï¸ Restaurants
                        </button>
                        <button onclick="filterPOIsByType('cafe')" class="poi-filter-btn" data-type="cafe" style="padding:8px 14px;background:white;color:#374151;border:2px solid #e5e7eb;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;">
                            â˜• CafÃ©s
                        </button>
                        <button onclick="filterPOIsByType('museum')" class="poi-filter-btn" data-type="museum" style="padding:8px 14px;background:white;color:#374151;border:2px solid #e5e7eb;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;">
                            ğŸ›ï¸ SehenswÃ¼rdigkeiten
                        </button>
                    </div>
                    
                    <!-- Karte -->
                    <div id="universal-map-picker-container" style="flex:1;min-height:400px;"></div>
                    
                    <!-- AusgewÃ¤hlte Adresse -->
                    <div id="universal-map-picker-selected" style="display:none;padding:15px;background:#f0fdf4;border-top:2px solid #10b981;">
                        <div style="font-size:12px;color:#048257;font-weight:600;margin-bottom:4px;">âœ… AusgewÃ¤hlt:</div>
                        <div id="universal-map-picker-address" style="font-size:14px;color:#1f2937;font-weight:600;"></div>
                    </div>
                    
                    <!-- ğŸ†• v5.90.539: POI VORSCHLÃ„GE (NACH Karten-Click) -->
                    <div id="universal-map-picker-pois" style="display:none;padding:15px;background:#fffbeb;border-top:2px solid #f59e0b;max-height:180px;overflow-y:auto;">
                        <div style="font-size:12px;color:#92400e;font-weight:600;margin-bottom:8px;">ğŸ’¡ Das kÃ¶nnte sein:</div>
                        <div id="universal-map-picker-pois-list"></div>
                    </div>
                    
                    <!-- Buttons -->
                    <div style="padding:20px;background:#f9fafb;border-top:1px solid #e5e7eb;display:flex;gap:10px;">
                        <button onclick="closeUniversalMapPicker()" style="flex:1;padding:12px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                            Abbrechen
                        </button>
                        <button id="universal-map-picker-confirm-address" onclick="confirmUniversalMapPicker(false)" disabled style="flex:1;padding:12px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;opacity:0.5;">
                            ğŸ“ Nur Adresse
                        </button>
                        <button id="universal-map-picker-confirm-poi" onclick="confirmUniversalMapPicker(true)" disabled style="flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;opacity:0.5;display:none;">
                            âœ… Mit POI-Name
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initialisiere Karte nach kurzer VerzÃ¶gerung
            setTimeout(() => {
                initUniversalMapPicker();
            }, 100);
        }
        
        // ğŸ†• v5.90.651: POI-Marker auf Karte anzeigen
        // ğŸ”§ v5.90.653: Mit Filter und Zoom-Responsive!
        function addPOIMarkersToMap(filterType = 'all') {
            console.log('ğŸ—ºï¸ v5.90.653: FÃ¼ge POI-Marker hinzu... Filter:', filterType);
            
            // Entferne alte Marker
            if (universalMapPicker.poiMarkers && universalMapPicker.poiMarkers.length > 0) {
                universalMapPicker.poiMarkers.forEach(marker => {
                    universalMapPicker.map.removeLayer(marker);
                });
                universalMapPicker.poiMarkers = [];
            }
            
            // Filtere nur echte POIs (keine Privatadressen)
            const publicPOIs = filterPublicPOIs(allPOIs);
            
            console.log(`ğŸ¨ ${publicPOIs.length} Ã¶ffentliche POIs gefiltert (von ${allPOIs.length} gesamt)`);
            
            if (publicPOIs.length === 0) {
                console.log('â„¹ï¸ Keine POIs zum Anzeigen');
                return;
            }
            
            // Bestimme Icon basierend auf POI-Type
            function getPOIIcon(poiName) {
                const name = poiName.toLowerCase();
                
                if (name.includes('bahnhof')) return 'ğŸš‰';
                if (name.includes('seebrÃ¼cke')) return 'ğŸŒŠ';
                if (name.includes('hotel') || name.includes('pension')) return 'ğŸ¨';
                if (name.includes('restaurant') || name.includes('gaststÃ¤tte')) return 'ğŸ½ï¸';
                if (name.includes('cafÃ©') || name.includes('cafe')) return 'â˜•';
                if (name.includes('strand')) return 'ğŸ–ï¸';
                if (name.includes('krankenhaus') || name.includes('klinik')) return 'ğŸ¥';
                if (name.includes('apotheke')) return 'ğŸ’Š';
                if (name.includes('supermarkt') || name.includes('einkauf')) return 'ğŸ›’';
                if (name.includes('kirche')) return 'â›ª';
                if (name.includes('museum')) return 'ğŸ›ï¸';
                
                return 'ğŸ“'; // Default
            }
            
            // ğŸ†• v5.90.653: Bestimme POI-Typ fÃ¼r Filter
            function getPOIType(poiName) {
                const name = poiName.toLowerCase();
                
                if (name.includes('bahnhof')) return 'bahnhof';
                if (name.includes('hotel') || name.includes('pension')) return 'hotel';
                if (name.includes('restaurant') || name.includes('gaststÃ¤tte')) return 'restaurant';
                if (name.includes('cafÃ©') || name.includes('cafe')) return 'cafe';
                if (name.includes('museum') || name.includes('kirche') || name.includes('seebrÃ¼cke')) return 'museum';
                
                return 'other';
            }
            
            // ğŸ†• v5.90.653: Hole aktuellen Zoom-Level
            const currentZoom = universalMapPicker.map.getZoom();
            
            // Zoom-responsive Icon-GrÃ¶ÃŸe
            // Zoom 10-12 = klein (20px), Zoom 13-15 = mittel (28px), Zoom 16+ = groÃŸ (36px)
            let iconSize, fontSize;
            if (currentZoom >= 16) {
                iconSize = 36;
                fontSize = 18;
            } else if (currentZoom >= 13) {
                iconSize = 28;
                fontSize = 14;
            } else {
                iconSize = 20;
                fontSize = 11;
            }
            
            console.log(`ğŸ” Zoom ${currentZoom} â†’ Icon-GrÃ¶ÃŸe: ${iconSize}px`);
            
            // Erstelle Marker fÃ¼r jeden POI
            publicPOIs.forEach(poi => {
                const icon = getPOIIcon(poi.name);
                const poiType = getPOIType(poi.name);
                
                // ğŸ†• v5.90.653: Filter anwenden
                if (filterType !== 'all' && poiType !== filterType) {
                    return; // Skip this POI
                }
                
                const markerColor = '#f59e0b'; // Orange fÃ¼r POIs
                
                const marker = L.marker([poi.lat, poi.lon], {
                    icon: L.divIcon({
                        html: `<div style="background:${markerColor};color:white;border-radius:50%;width:${iconSize}px;height:${iconSize}px;display:flex;align-items:center;justify-content:center;font-size:${fontSize}px;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);cursor:pointer;">${icon}</div>`,
                        iconSize: [iconSize, iconSize],
                        iconAnchor: [iconSize/2, iconSize/2]
                    }),
                    poiType: poiType // Speichere Typ fÃ¼r Filter
                }).addTo(universalMapPicker.map);
                
                // Popup mit POI-Info
                marker.bindPopup(`
                    <div style="min-width:200px;">
                        <div style="font-weight:700;font-size:14px;margin-bottom:4px;">${icon} ${poi.name}</div>
                        <div style="font-size:12px;color:#666;margin-bottom:8px;">${poi.address || 'Keine Adresse'}</div>
                        <button onclick="selectPOIFromMap('${poi.name.replace(/'/g, "\\'")}', '${poi.address ? poi.address.replace(/'/g, "\\'") : ''}', ${poi.lat}, ${poi.lon})" 
                                style="width:100%;padding:8px;background:#10b981;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;">
                            âœ… AuswÃ¤hlen
                        </button>
                    </div>
                `, {
                    maxWidth: 250
                });
                
                universalMapPicker.poiMarkers.push(marker);
            });
            
            console.log(`âœ… ${universalMapPicker.poiMarkers.length} POI-Marker zur Karte hinzugefÃ¼gt!`);
        }
        
        // ğŸ†• v5.90.651: POI vom Marker auswÃ¤hlen
        function selectPOIFromMap(name, address, lat, lon) {
            console.log('âœ… v5.90.651: POI vom Marker gewÃ¤hlt:', name);
            
            // Entferne alten User-Marker (falls vorhanden)
            if (universalMapPicker.marker) {
                universalMapPicker.map.removeLayer(universalMapPicker.marker);
            }
            
            // Setze neuen Marker an POI-Position
            universalMapPicker.marker = L.marker([lat, lon], {
                icon: L.divIcon({
                    html: '<div style="background:#10b981;color:white;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-size:16px;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);">âœ…</div>',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(universalMapPicker.map);
            
            // Speichere Daten
            const fullAddress = address || name;
            universalMapPicker.marker.pickedAddress = fullAddress;
            universalMapPicker.marker.pickedLat = lat;
            universalMapPicker.marker.pickedLon = lon;
            universalMapPicker.marker.pickedName = name;
            
            // Zeige ausgewÃ¤hlte Adresse an
            const selectedDiv = document.getElementById('universal-map-picker-selected');
            const addressDiv = document.getElementById('universal-map-picker-address');
            if (selectedDiv && addressDiv) {
                selectedDiv.style.display = 'block';
                addressDiv.textContent = `${name} - ${fullAddress}`;
            }
            
            // Aktiviere Confirm-Button
            const confirmAddressBtn = document.getElementById('universal-map-picker-confirm-address');
            if (confirmAddressBtn) {
                confirmAddressBtn.disabled = false;
                confirmAddressBtn.style.opacity = '1';
            }
            
            // SchlieÃŸe alle Popups
            universalMapPicker.map.closePopup();
        }
        
        // ğŸ†• v5.90.653: POI Filter Funktion
        let currentPOIFilter = 'all';
        
        function filterPOIsByType(type) {
            console.log('ğŸ” v5.90.653: Filter POIs nach Typ:', type);
            
            currentPOIFilter = type;
            
            // Update Button-Styles
            document.querySelectorAll('.poi-filter-btn').forEach(btn => {
                if (btn.dataset.type === type) {
                    btn.style.background = '#10b981';
                    btn.style.color = 'white';
                    btn.style.borderColor = '#10b981';
                } else {
                    btn.style.background = 'white';
                    btn.style.color = '#374151';
                    btn.style.borderColor = '#e5e7eb';
                }
            });
            
            // Marker neu laden mit Filter
            addPOIMarkersToMap(type);
        }
        
        function initUniversalMapPicker() {
            const container = document.getElementById('universal-map-picker-container');
            if (!container) {
                console.error('ğŸ’¾ Universal Map Picker Container nicht gefunden!');
                return;
            }
            
            console.log('ğŸ—ºï¸ v5.90.535: Initialisiere Universal Karten-Picker...');
            
            // Default: Heringsdorf
            const defaultLat = 53.9547;
            const defaultLon = 14.1783;
            
            // Erstelle Karte
            universalMapPicker.map = L.map(container).setView([defaultLat, defaultLon], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap'
            }).addTo(universalMapPicker.map);
            
            // ğŸ†• v5.90.651: POI-MARKER auf Karte anzeigen!
            addPOIMarkersToMap();
            
            // ğŸ†• v5.90.653: Zoom-Event fÃ¼r responsive Icons!
            universalMapPicker.map.on('zoomend', function() {
                console.log('ğŸ” Zoom geÃ¤ndert, aktualisiere POI-Marker...');
                addPOIMarkersToMap(currentPOIFilter);
            });
            
            // Klick auf Karte
            universalMapPicker.map.on('click', async function(e) {
                const lat = e.latlng.lat;
                const lon = e.latlng.lng;
                
                console.log('ğŸ“ v5.90.535: Karte geklickt:', lat, lon);
                
                // Entferne alten Marker
                if (universalMapPicker.marker) {
                    universalMapPicker.map.removeLayer(universalMapPicker.marker);
                }
                
                // Neuer Marker
                universalMapPicker.marker = L.marker([lat, lon], {
                    icon: L.divIcon({
                        html: '<div style="background:#10b981;color:white;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-size:16px;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);">ğŸ“</div>',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                }).addTo(universalMapPicker.map);
                
                // Lade Adresse
                await loadUniversalMapPickerAddress(lat, lon);
            });
            
            console.log('âœ… v5.90.535: Universal Karten-Picker initialisiert!');
        }
        
        async function loadUniversalMapPickerAddress(lat, lon) {
            console.log('ğŸ”„ v5.90.535: Lade Adresse fÃ¼r:', lat, lon);
            
            const selectedDiv = document.getElementById('universal-map-picker-selected');
            const addressDiv = document.getElementById('universal-map-picker-address');
            const confirmAddressBtn = document.getElementById('universal-map-picker-confirm-address');
            
            if (!selectedDiv || !addressDiv) {
                console.error('ğŸ’¾ Universal Map Picker Elemente nicht gefunden!');
                return;
            }
            
            // Zeige "LÃ¤dt..."
            selectedDiv.style.display = 'block';
            addressDiv.textContent = 'ğŸ”„ Lade Adresse...';
            if (confirmAddressBtn) {
                confirmAddressBtn.disabled = true;
                confirmAddressBtn.style.opacity = '0.5';
            }
            
            try {
                // Reverse Geocoding
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`
                );
                const data = await response.json();
                
                console.log('âœ… v5.90.535: Adresse geladen:', data);
                
                // Baue Adresse
                const address = data.address || {};
                let displayAddress = '';
                
                if (address.road) {
                    displayAddress = address.road;
                    if (address.house_number) displayAddress += ' ' + address.house_number;
                }
                
                if (address.postcode && address.village) {
                    if (displayAddress) displayAddress += ', ';
                    displayAddress += address.postcode + ' ' + address.village;
                } else if (address.postcode && address.town) {
                    if (displayAddress) displayAddress += ', ';
                    displayAddress += address.postcode + ' ' + address.town;
                } else if (address.postcode && address.city) {
                    if (displayAddress) displayAddress += ', ';
                    displayAddress += address.postcode + ' ' + address.city;
                }
                
                if (!displayAddress) {
                    displayAddress = data.display_name;
                }
                
                // Zeige Adresse
                addressDiv.textContent = displayAddress;
                
                // Speichere fÃ¼r Ãœbernahme
                universalMapPicker.marker.pickedAddress = displayAddress;
                universalMapPicker.marker.pickedLat = lat;
                universalMapPicker.marker.pickedLon = lon;
                universalMapPicker.marker.pickedData = data;
                
                // Aktiviere "Nur Adresse" Button
                const confirmAddressBtn = document.getElementById('universal-map-picker-confirm-address');
                if (confirmAddressBtn) {
                    confirmAddressBtn.disabled = false;
                    confirmAddressBtn.style.opacity = '1';
                }
                
                // ğŸ†• v5.90.540: POI-SUCHE OPTIONAL (schneller!)
                setTimeout(() => searchNearbyPOIs(lat, lon, displayAddress), 0);
                
            } catch (error) {
                console.error('ğŸ’¾ v5.90.535: Fehler beim Laden der Adresse:', error);
                addressDiv.textContent = 'ğŸ’¾ Fehler beim Laden der Adresse';
                if (confirmAddressBtn) {
                    confirmAddressBtn.disabled = true;
                    confirmAddressBtn.style.opacity = '0.5';
                }
            }
        }
        
        function confirmUniversalMapPicker(withPOI = false) {
            if (!universalMapPicker.marker || !universalMapPicker.marker.pickedAddress) {
                alert('ğŸ’¾ Bitte erst einen Ort auf der Karte auswÃ¤hlen!');
                return;
            }
            
            let finalAddress = universalMapPicker.marker.pickedAddress;
            let poiName = null;
            
            // ğŸ†• v5.90.574: Mit POI-Name?
            if (withPOI && selectedPOIIndex !== null && universalMapPicker.nearbyPOIs) {
                const poi = universalMapPicker.nearbyPOIs[selectedPOIIndex];
                if (poi && poi.name) {
                    poiName = poi.name;
                    
                    // ğŸ†• v5.90.574: PrÃ¼fe ob CRM-Feld (edit-customer-address)
                    const isCRMField = universalMapPicker.targetInputId === 'edit-customer-address';
                    
                    if (isCRMField) {
                        // CRM: Name NICHT in Adresse schreiben, nur pure Adresse
                        console.log('âœ… v5.90.574: CRM-Feld erkannt - POI-Name separat behandeln');
                        // finalAddress bleibt wie sie ist (nur Adresse)
                        
                        // ğŸ†• v5.90.584: POI-Name IMMER Ã¼bernehmen!
                        const nameField = document.getElementById('edit-customer-name');
                        if (nameField) {
                            // IMMER Ã¼berschreiben wenn POI ausgewÃ¤hlt!
                            nameField.value = poiName;
                            console.log('âœ… v5.90.584: POI-Name ins Name-Feld geschrieben (Ã¼berschrieben):', poiName);
                        } else {
                            console.warn('âš ï¸ v5.90.584: Name-Feld nicht gefunden!');
                        }
                    } else {
                        // Schnellbuchung/andere: Name + Adresse zusammen
                        finalAddress = `${poiName}, ${universalMapPicker.marker.pickedAddress}`;
                        console.log('âœ… v5.90.574: Mit POI (Name + Adresse):', poiName);
                    }
                }
            }
            
            console.log('âœ… v5.90.574: Ãœbernehme:', finalAddress);
            console.log('   FÃ¼r Input:', universalMapPicker.targetInputId);
            
            // FÃ¼lle Ziel-Feld
            const targetField = document.getElementById(universalMapPicker.targetInputId);
            if (targetField) {
                targetField.value = finalAddress;
                
                // Trigger Input Event (fÃ¼r Autocomplete/Validation)
                const event = new Event('input', { bubbles: true });
                targetField.dispatchEvent(event);
                
                console.log('âœ… v5.90.574: Adresse ins Feld geschrieben!');
            } else {
                console.error('ğŸ’¾ v5.90.574: Ziel-Feld nicht gefunden:', universalMapPicker.targetInputId);
            }
            
            // Custom Callback?
            if (universalMapPicker.onConfirm && typeof universalMapPicker.onConfirm === 'function') {
                universalMapPicker.onConfirm({
                    address: finalAddress,
                    poiName: poiName,
                    lat: universalMapPicker.marker.pickedLat,
                    lon: universalMapPicker.marker.pickedLon,
                    data: universalMapPicker.marker.pickedData
                });
            }
            
            // SchlieÃŸe Modal
            closeUniversalMapPicker();
        }
        
        function closeUniversalMapPicker() {
            const modal = document.getElementById('universal-map-picker-modal');
            if (modal) {
                // Cleanup Karte
                if (universalMapPicker.map) {
                    universalMapPicker.map.remove();
                    universalMapPicker.map = null;
                }
                universalMapPicker.marker = null;
                universalMapPicker.targetInputId = null;
                universalMapPicker.onConfirm = null;
                
                // Entferne Modal
                modal.remove();
                
                console.log('ğŸ—‘ï¸ v5.90.535: Universal Map Picker geschlossen');
            }
        }
        
        // ğŸ†• v5.90.539: POI-SUCHE **NACH** KARTEN-CLICK
        async function searchNearbyPOIs(lat, lon, baseAddress) {
            console.log('ğŸ” v5.90.568: Suche POIs bei:', lat, lon);
            
            const poisDiv = document.getElementById('universal-map-picker-pois');
            const listDiv = document.getElementById('universal-map-picker-pois-list');
            const poiBtn = document.getElementById('universal-map-picker-confirm-poi');
            
            if (!poisDiv || !listDiv) {
                console.error('ğŸ’¾ POI Container nicht gefunden!');
                return;
            }
            
            // Zeige Loading
            poisDiv.style.display = 'block';
            listDiv.innerHTML = '<div style="padding:8px;text-align:center;color:#92400e;font-size:12px;">ğŸ”„ Suche POIs in der NÃ¤he...</div>';
            
            try {
                // ğŸ†• v5.90.568: Reverse Geocoding mit POI-Details
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?` +
                    `format=json&` +
                    `lat=${lat}&` +
                    `lon=${lon}&` +
                    `zoom=18&` +
                    `addressdetails=1&` +
                    `extratags=1&` +
                    `namedetails=1`
                );
                
                const data = await response.json();
                
                console.log('âœ… v5.90.568: POI-Daten:', data);
                
                // Baue POI-Liste
                const pois = [];
                
                // 1. Haupt-POI (falls vorhanden)
                if (data.name && data.name !== data.address?.road) {
                    pois.push({
                        name: data.name,
                        type: data.type || data.class || 'Ort',
                        class: data.class,
                        isMain: true
                    });
                }
                
                // 2. POI aus Adresse extrahieren
                const addr = data.address || {};
                if (addr.amenity) pois.push({ name: addr.amenity, type: 'amenity' });
                if (addr.tourism) pois.push({ name: addr.tourism, type: 'tourism' });
                if (addr.shop) pois.push({ name: addr.shop, type: 'shop' });
                if (addr.restaurant) pois.push({ name: addr.restaurant, type: 'restaurant' });
                if (addr.hotel) pois.push({ name: addr.hotel, type: 'hotel' });
                if (addr.cafe) pois.push({ name: addr.cafe, type: 'cafe' });
                
                // 3. StraÃŸenname als Fallback
                if (pois.length === 0 && addr.road) {
                    pois.push({
                        name: addr.road + (addr.house_number ? ' ' + addr.house_number : ''),
                        type: 'address',
                        isAddress: true
                    });
                }
                
                if (pois.length === 0) {
                    poisDiv.style.display = 'none';
                    console.log('â„¹ï¸ Keine POIs gefunden');
                    return;
                }
                
                // Speichere POIs
                universalMapPicker.nearbyPOIs = pois;
                
                // Rendere POIs
                listDiv.innerHTML = pois.map((poi, index) => {
                    const icon = getPoiIcon(poi.type);
                    const label = poi.isMain ? '<span style="background:#f59e0b;color:white;padding:1px 4px;border-radius:3px;font-size:9px;margin-left:4px;">Haupt</span>' : '';
                    
                    return `
                        <div onclick="selectPOI(${index})" 
                             id="poi-${index}"
                             style="padding:10px;margin-bottom:6px;background:white;border:2px solid #f59e0b;border-radius:8px;cursor:pointer;transition:all 0.2s;"
                             onmouseover="this.style.background='#fffbeb';this.style.borderColor='#d97706'"
                             onmouseout="if(!this.classList.contains('selected')){this.style.background='white';this.style.borderColor='#f59e0b'}">
                            <div style="font-weight:600;color:#1f2937;font-size:13px;">
                                ${icon} ${poi.name} ${label}
                            </div>
                            <div style="font-size:11px;color:#6b7280;margin-top:2px;">
                                ${poi.type}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Zeige POI-Button
                if (poiBtn) {
                    poiBtn.style.display = 'block';
                }
                
                console.log(`âœ… ${pois.length} POI(s) gefunden!`);
                
            } catch (error) {
                console.error('ğŸ’¾ v5.90.568: POI-Suche Fehler:', error);
                poisDiv.style.display = 'none';
            }
        }
        
        function getPoiIcon(type) {
            const icons = {
                'restaurant': 'ğŸ½ï¸',
                'cafe': 'â˜•',
                'hotel': 'ğŸ¨',
                'shop': 'ğŸª',
                'tourism': 'ğŸ—ºï¸',
                'amenity': 'ğŸ“',
                'bar': 'ğŸº',
                'fast_food': 'ğŸ”'
            };
            return icons[type] || 'ğŸ“';
        }
        
        let selectedPOIIndex = null;
        function selectPOI(index) {
            document.querySelectorAll('[id^="poi-"]').forEach(el => {
                el.classList.remove('selected');
                el.style.background = 'white';
                el.style.borderColor = '#f59e0b';
            });
            
            const selectedEl = document.getElementById(`poi-${index}`);
            if (selectedEl) {
                selectedEl.classList.add('selected');
                selectedEl.style.background = '#fef3c7';
                selectedEl.style.borderColor = '#d97706';
            }
            
            selectedPOIIndex = index;
            
            const poiBtn = document.getElementById('universal-map-picker-confirm-poi');
            if (poiBtn) {
                poiBtn.disabled = false;
                poiBtn.style.opacity = '1';
            }
            
            console.log('âœ… POI ausgewÃ¤hlt:', index, universalMapPicker.nearbyPOIs[index].name);
        }
        
        // ğŸ†• v5.90.240: KARTEN-PICKER FÃœR ABHOLORT!
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function openQuickBookingMapPickerForPickup() {
            console.log('ğŸ“ Ã–ffne Karten-Picker fÃ¼r ABHOLORT...');
            
            // Modal erstellen
            const modal = document.createElement('div');
            modal.id = 'quick-booking-map-picker-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:10002;padding:20px;';
            
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;width:100%;max-width:900px;max-height:90vh;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                    <!-- Header -->
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:20px;background:linear-gradient(135deg,#10b981,#059669);color:white;">
                        <h3 style="margin:0;font-size:18px;font-weight:700;">ğŸ“ Abholort auf Karte wÃ¤hlen</h3>
                        <button onclick="closeQuickBookingMapPicker()" style="background:none;border:none;font-size:28px;cursor:pointer;color:white;line-height:1;padding:0;opacity:0.9;">Ã—</button>
                    </div>
                    
                    <!-- Info -->
                    <div style="padding:15px;background:#d1fae5;border-bottom:2px solid #10b981;">
                        <div style="font-size:13px;color:#065f46;font-weight:600;">
                            ğŸ’¡ Klicke auf die Karte um den Abholort auszuwÃ¤hlen
                        </div>
                    </div>
                    
                    <!-- Karte -->
                    <div id="quick-booking-map-picker" style="flex:1;min-height:400px;"></div>
                    
                    <!-- AusgewÃ¤hlte Adresse -->
                    <div id="quick-booking-map-picker-selected" style="display:none;padding:15px;background:#d1fae5;border-top:2px solid#10b981;">
                        <div style="font-size:12px;color:#065f46;font-weight:600;margin-bottom:4px;">âœ… AusgewÃ¤hlt:</div>
                        <div id="quick-booking-map-picker-address" style="font-size:14px;color:#1f2937;font-weight:600;"></div>
                    </div>
                    
                    <!-- Buttons -->
                    <div style="padding:20px;background:#f9fafb;border-top:1px solid #e5e7eb;display:flex;gap:10px;">
                        <button onclick="closeQuickBookingMapPicker()" style="flex:1;padding:12px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                            Abbrechen
                        </button>
                        <button id="quick-booking-map-picker-confirm" onclick="confirmQuickBookingMapPickerForPickup()" disabled style="flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;opacity:0.5;">
                            âœ… Ãœbernehmen
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initialisiere Karte nach kurzer VerzÃ¶gerung
            setTimeout(() => {
                initQuickBookingMapPicker();
            }, 100);
        }
        
        function confirmQuickBookingMapPickerForPickup() {
            if (!quickBookingMapPickerMarker || !quickBookingMapPickerMarker.pickedAddress) {
                alert('ğŸ’¾ Bitte erst einen Ort auf der Karte auswÃ¤hlen!');
                return;
            }
            
            console.log('âœ… Ãœbernehme ABHOLORT:', quickBookingMapPickerMarker.pickedAddress);
            
            // FÃ¼lle ABHOLORT-Feld
            const pickupField = document.getElementById('quick-booking-pickup');
            if (pickupField) {
                pickupField.value = quickBookingMapPickerMarker.pickedAddress;
                
                // Speichere Koordinaten
                quickBookingPickupCoords = {
                    lat: quickBookingMapPickerMarker.pickedLat,
                    lon: quickBookingMapPickerMarker.pickedLon
                };
                
                console.log('âœ… Abholort-Koordinaten gespeichert:', quickBookingPickupCoords);
            }
            
            // SchlieÃŸe Modal
            closeQuickBookingMapPicker();
            
            // Trigger Preis-Berechnung falls Zielort schon da ist
            setTimeout(() => {
                if (pickupField) {
                    pickupField.dispatchEvent(new Event('change'));
                }
            }, 100);
        }
        
        // ğŸ†• v5.38.6: SCHNELLBUCHUNG-PANEL IM KALENDER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let qbPanelCustomer = null;
        // qbPanelPickupCoords & qbPanelDestCoords bereits in Zeile 3857 deklariert! âœ…
        let qbPanelAutocompleteTimeout = null;
        
        // ğŸ†• v5.41.1: Route & Extra-Zeit
        let qbPanelRouteDuration = 15; // Default 15 Min
        let qbPanelExtraTime = 0; // Default 0 Min Extra
        
        function toggleQuickBookingPanel() {
            const panel = document.getElementById('quick-booking-panel');
            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'block';
                
                // ğŸ†• v5.52.0: Position & GrÃ¶ÃŸe aus localStorage laden
                restorePanelPosition();
                
                // ğŸ†• v5.51.0: Button-Text auf BUCHEN setzen (NEU-Modus)
                const submitBtn = document.getElementById('qb-panel-submit-btn');
                if (submitBtn) submitBtn.innerHTML = 'âš¡ Buchen';
                
                // SOFORT Kunden laden wenn Panel Ã¶ffnet!
                if (allCustomers.length === 0 && isFirebaseReady) {
                    loadAllCustomersNow();
                }
                
                setupQuickBookingPanelAutocomplete();
                loadQuickBookingPanelVehicles();
                loadQuickBookingPanelCustomers();
                watchPickupChanges();
                
                // ğŸ†• v5.41.1: Default Extra-Zeit auf 0 setzen
                setExtraTime(0);
                
                // ğŸ†• v5.52.0: Dragging initialisieren (nur einmal!)
                if (!panel.dataset.draggingInit) {
                    initPanelDragging();
                    panel.dataset.draggingInit = 'true';
                }
            } else {
                panel.style.display = 'none';
            }
        }
        
        // ğŸ†• v5.52.0: PANEL DRAGGING & RESIZING
        function restorePanelPosition() {
            const panel = document.getElementById('quick-booking-panel');
            const saved = localStorage.getItem('qb-panel-position');
            
            if (saved) {
                try {
                    const pos = JSON.parse(saved);
                    if (pos.top) panel.style.top = pos.top;
                    if (pos.left) panel.style.left = pos.left;
                    if (pos.right) panel.style.right = pos.right;
                    if (pos.width) panel.style.width = pos.width;
                    if (pos.height) panel.style.height = pos.height;
                    console.log('ğŸ“ Panel-Position wiederhergestellt:', pos);
                } catch (e) {
                    console.error('ğŸ’¾ Fehler beim Laden der Position:', e);
                }
            }
        }
        
        function savePanelPosition() {
            const panel = document.getElementById('quick-booking-panel');
            const pos = {
                top: panel.style.top,
                left: panel.style.left,
                right: panel.style.right,
                width: panel.style.width,
                height: panel.style.height
            };
            localStorage.setItem('qb-panel-position', JSON.stringify(pos));
        }
        
        function initPanelDragging() {
            const panel = document.getElementById('quick-booking-panel');
            const header = document.getElementById('qb-panel-header');
            
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;
            
            header.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);
            
            function dragStart(e) {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
                
                if (e.target === header || header.contains(e.target)) {
                    isDragging = true;
                    panel.style.transition = 'none';
                }
            }
            
            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    
                    xOffset = currentX;
                    yOffset = currentY;
                    
                    // Berechne Position
                    const rect = panel.getBoundingClientRect();
                    panel.style.left = rect.left + currentX + 'px';
                    panel.style.top = rect.top + currentY + 'px';
                    panel.style.right = 'auto'; // Remove right positioning
                    
                    initialX = e.clientX;
                    initialY = e.clientY;
                }
            }
            
            function dragEnd() {
                if (isDragging) {
                    isDragging = false;
                    panel.style.transition = '';
                    savePanelPosition();
                    xOffset = 0;
                    yOffset = 0;
                    console.log('ğŸ’¾ Panel-Position gespeichert');
                }
            }
            
            // ğŸ†• RESIZE OBSERVER - speichert GrÃ¶ÃŸe automatisch
            const resizeObserver = new ResizeObserver(() => {
                if (panel.style.display !== 'none') {
                    savePanelPosition();
                }
            });
            resizeObserver.observe(panel);
        }
        
        
        // Kunden SOFORT laden
        function loadAllCustomersNow() {
            db.ref('customers').once('value').then(snapshot => {
                allCustomers = [];
                snapshot.forEach(child => {
                    const customer = child.val();
                    customer.id = child.key;
                    allCustomers.push(customer);
                });
                console.log('âœ… Kunden geladen:', allCustomers.length);
            });
        }
        
        function closeQuickBookingPanel() {
            document.getElementById('quick-booking-panel').style.display = 'none';
            
            // ğŸ”§ v5.39.9: LEERE alle Felder beim SchlieÃŸen!
            document.getElementById('qb-panel-customer').value = '';
            document.getElementById('qb-panel-pickup').value = '';
            document.getElementById('qb-panel-destination').value = '';
            document.getElementById('qb-panel-start-time').value = '';
            document.getElementById('qb-panel-end-time').value = '';
            document.getElementById('qb-panel-passengers').value = '1';
            document.getElementById('qb-panel-vehicle').value = '';
            document.getElementById('qb-panel-notes').value = '';
            
            // Reset globale Variablen
            window.editingRideId = null;
            window.copiedFromRideId = null; // ğŸ”’ v5.40.4: Auch kopierte Fahrt-ID zurÃ¼cksetzen
            qbPanelCustomer = null;
            qbPanelPickupCoords = null;
            qbPanelDestCoords = null;
            
            // ğŸ†• v5.41.1: Reset Route & Extra-Zeit
            qbPanelRouteDuration = 15;
            qbPanelExtraTime = 0;
            const routeInfo = document.getElementById('qb-panel-route-info');
            if (routeInfo) routeInfo.style.display = 'none';
            
            console.log('ğŸ”„ Panel geschlossen & alle Felder geleert');
        }
        
        // Kunden-Autocomplete
        function loadQuickBookingPanelCustomers() {
            const input = document.getElementById('qb-panel-customer');
            const dropdown = document.getElementById('qb-panel-customer-dropdown');
            
            if (!input || !dropdown) return;
            
            // Entferne alte Event Listener falls vorhanden
            const newInput = input.cloneNode(true);
            input.parentNode.replaceChild(newInput, input);
            
            const finalInput = document.getElementById('qb-panel-customer');
            const finalDropdown = document.getElementById('qb-panel-customer-dropdown');
            
            finalInput.addEventListener('input', (e) => {
                const value = e.target.value.trim().toLowerCase();
                
                if (value.length < 2) {
                    finalDropdown.style.display = 'none';
                    qbPanelCustomer = null;
                    return;
                }
                
                console.log('ğŸ” Suche Kunde:', value, 'Anzahl Kunden:', allCustomers.length);
                
                // Filter Kunden
                const filtered = allCustomers.filter(c => {
                    const name = (c.name || '').toLowerCase();
                    const phone = (c.phone || '').toLowerCase();
                    return name.includes(value) || phone.includes(value);
                });
                
                console.log('ğŸ“‹ Gefiltert:', filtered.length);
                
                if (filtered.length === 0) {
                    finalDropdown.innerHTML = '<div style="padding:10px;color:#999;">Keine Kunden gefunden</div>';
                    finalDropdown.style.display = 'block';
                    return;
                }
                
                finalDropdown.innerHTML = filtered.slice(0, 10).map(c => `
                    <div onclick="selectQuickBookingPanelCustomer('${c.id}')" style="
                        padding:12px;
                        cursor:pointer;
                        border-bottom:1px solid #f0f0f0;
                        transition:background 0.2s;
                    " onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                        <div style="font-weight:600;font-size:14px;">${c.name || 'Unbekannt'}</div>
                        <div style="font-size:12px;color:#999;">${c.phone || ''}</div>
                    </div>
                `).join('');
                
                finalDropdown.style.display = 'block';
            });
            
            // SchlieÃŸe Dropdown bei Klick auÃŸerhalb
            document.addEventListener('click', (e) => {
                if (e.target !== finalInput && !finalDropdown.contains(e.target)) {
                    finalDropdown.style.display = 'none';
                }
            });
        }
        
        function selectQuickBookingPanelCustomer(customerId) {
            const customer = allCustomers.find(c => c.id === customerId);
            if (!customer) return;
            
            qbPanelCustomer = customer;
            document.getElementById('qb-panel-customer').value = customer.name || 'Unbekannt';
            document.getElementById('qb-panel-customer-dropdown').style.display = 'none';
            
            // âœ… AUTO-FILL: Lade Kundendaten wenn vorhanden
            if (customer.address) {
                document.getElementById('qb-panel-pickup').value = customer.address;
                console.log('âœ… Kundenadresse in Abholort eingetragen:', customer.address);
                // ğŸ†• v5.48.4: GEOCODE Adresse um Koordinaten zu bekommen!
                geocodeCustomerAddress(customer.address, 'qb-panel-pickup');
            }
            
            // ğŸ†• Zeige Adress-Optionen wenn Kunde gewÃ¤hlt
            showAddressOptions();
            
            // ğŸ†• v5.49.0: Zeige hÃ¤ufige Zielorte!
            showFrequentDestinations(customer.phone, customer.id, 'qb-panel-frequent-destinations');
            
            console.log('ğŸ’¾ Kunde gewÃ¤hlt:', customer);
        }
        
        // ğŸ†• Zeige/Verstecke Adress-Optionen
        function showAddressOptions() {
            const options = document.getElementById('qb-panel-address-options');
            const pickupInput = document.getElementById('qb-panel-pickup');
            
            // Zeige nur wenn Kunde gewÃ¤hlt UND Adresse eingegeben
            if (qbPanelCustomer && pickupInput.value.trim()) {
                options.style.display = 'block';
            } else {
                options.style.display = 'none';
            }
        }
        
        // ğŸ†• Ãœberwache Abholort-Ã„nderungen
        function watchPickupChanges() {
            const pickupInput = document.getElementById('qb-panel-pickup');
            if (!pickupInput) return;
            
            pickupInput.addEventListener('input', () => {
                showAddressOptions();
            });
        }
        
        // ğŸ†• SWAP-BUTTON: Adressen tauschen
        function swapPanelAddresses() {
            const pickupInput = document.getElementById('qb-panel-pickup');
            const destInput = document.getElementById('qb-panel-destination');
            
            const temp = pickupInput.value;
            pickupInput.value = destInput.value;
            destInput.value = temp;
            
            // Koordinaten auch tauschen
            const tempCoords = qbPanelPickupCoords;
            qbPanelPickupCoords = qbPanelDestCoords;
            qbPanelDestCoords = tempCoords;
            
            console.log('ğŸ”„ Adressen getauscht!');
        }
        
        // ğŸ†• ENDZEIT AUTOMATISCH: +15 Minuten nach Startzeit
        function updatePanelEndTime() {
            const startInput = document.getElementById('qb-panel-start-time');
            const endInput = document.getElementById('qb-panel-end-time');
            const startDisplay = document.getElementById('qb-panel-start-display');
            
            if (!startInput.value) {
                if (startDisplay) {
                    startDisplay.textContent = '';
                    startDisplay.style.display = 'none';
                }
                return;
            }
            
            // ğŸ”§ BUGFIX v5.39.2: Kein String-Parsing! Parse datetime-local richtig!
            const dtParts = startInput.value.split('T');
            const dateParts = dtParts[0].split('-');
            const timeParts = dtParts[1].split(':');
            
            const startDate = new Date(
                parseInt(dateParts[0]),      // Jahr
                parseInt(dateParts[1]) - 1,  // Monat (0-11!)
                parseInt(dateParts[2]),      // Tag
                parseInt(timeParts[0]),      // Stunde
                parseInt(timeParts[1]),      // Minute
                0,                           // Sekunde
                0                            // Millisekunde
            );
            
            // ğŸ†• v5.51.0: GROSSE WOCHENTAG-ANZEIGE!
            if (startDisplay) {
                const weekdays = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
                const months = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
                
                const weekday = weekdays[startDate.getDay()];
                const day = startDate.getDate();
                const month = months[startDate.getMonth()];
                const year = startDate.getFullYear();
                const hours = String(startDate.getHours()).padStart(2, '0');
                const minutes = String(startDate.getMinutes()).padStart(2, '0');
                
                startDisplay.innerHTML = `ğŸ“… ${weekday}, ${day}. ${month} ${year}<br>ğŸ• ${hours}:${minutes} Uhr`;
                startDisplay.style.display = 'block';
            }
            
            // ğŸ†• v5.41.1: Endzeit = Start + Routendauer + Extra-Zeit
            const totalMinutes = qbPanelRouteDuration + qbPanelExtraTime;
            const endDate = new Date(startDate.getTime() + (totalMinutes * 60 * 1000));
            
            // Format fÃ¼r datetime-local Input
            const year = endDate.getFullYear();
            const month = String(endDate.getMonth() + 1).padStart(2, '0');
            const day = String(endDate.getDate()).padStart(2, '0');
            const hours = String(endDate.getHours()).padStart(2, '0');
            const minutes = String(endDate.getMinutes()).padStart(2, '0');
            
            endInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
            
            // Endzeit-Anzeige auch updaten
            updatePanelEndDisplay();
            
            console.log(`â±ï¸ Endzeit: ${qbPanelRouteDuration} Min Fahrt + ${qbPanelExtraTime} Min Extra = ${totalMinutes} Min`);
        }
        
        // ğŸ†• ENDZEIT-ANZEIGE aktualisieren
        function updatePanelEndDisplay() {
            const endInput = document.getElementById('qb-panel-end-time');
            const endDisplay = document.getElementById('qb-panel-end-display');
            
            if (!endInput || !endDisplay || !endInput.value) {
                if (endDisplay) {
                    endDisplay.textContent = '';
                    endDisplay.style.display = 'none';
                }
                return;
            }
            
            // ğŸ”§ BUGFIX v5.39.2: Kein String-Parsing!
            const dtParts = endInput.value.split('T');
            const dateParts = dtParts[0].split('-');
            const timeParts = dtParts[1].split(':');
            
            const endDate = new Date(
                parseInt(dateParts[0]),
                parseInt(dateParts[1]) - 1,
                parseInt(dateParts[2]),
                parseInt(timeParts[0]),
                parseInt(timeParts[1]),
                0,
                0
            );
            
            // ğŸ†• v5.51.0: GROSSE WOCHENTAG-ANZEIGE!
            const weekdays = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
            const months = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            
            const weekday = weekdays[endDate.getDay()];
            const day = endDate.getDate();
            const month = months[endDate.getMonth()];
            const year = endDate.getFullYear();
            const hours = String(endDate.getHours()).padStart(2, '0');
            const minutes = String(endDate.getMinutes()).padStart(2, '0');
            
            endDisplay.innerHTML = `ğŸ“… ${weekday}, ${day}. ${month} ${year}<br>ğŸ• ${hours}:${minutes} Uhr`;
            endDisplay.style.display = 'block';
        }
        
        // ğŸ†• v5.41.1: EXTRA-ZEIT setzen
        function setExtraTime(minutes) {
            qbPanelExtraTime = minutes;
            
            // Button-Styling aktualisieren
            [0, 5, 10, 15].forEach(m => {
                const btn = document.getElementById(`extra-time-${m}`);
                if (!btn) return;
                
                if (m === minutes) {
                    // Aktiv
                    btn.style.background = '#3b82f6';
                    btn.style.color = 'white';
                    btn.classList.add('active');
                } else {
                    // Inaktiv
                    btn.style.background = 'white';
                    btn.style.color = '#1e40af';
                    btn.classList.remove('active');
                }
            });
            
            // Endzeit neu berechnen
            updatePanelEndTime();
            
            console.log(`â±ï¸ Extra-Zeit gesetzt: +${minutes} Min`);
        }
        
        // ğŸ†• v5.41.1: ROUTE berechnen fÃ¼r Admin Panel (Fahrtdauer)
        async function calculateRouteForPanel() {
            const pickup = document.getElementById('qb-panel-pickup').value.trim();
            const destination = document.getElementById('qb-panel-destination').value.trim();
            const routeInfo = document.getElementById('qb-panel-route-info');
            
            if (!pickup || !destination || !qbPanelPickupCoords || !qbPanelDestCoords) {
                // Keine vollstÃ¤ndigen Koordinaten â†’ Default 15 Min
                qbPanelRouteDuration = 15;
                if (routeInfo) routeInfo.style.display = 'none';
                updatePanelEndTime();
                return;
            }
            
            try {
                // Routing API (GraphHopper oder OpenRouteService)
                const url = `https://graphhopper.com/api/1/route?` +
                    `point=${qbPanelPickupCoords.lat},${qbPanelPickupCoords.lon}` +
                    `&point=${qbPanelDestCoords.lat},${qbPanelDestCoords.lon}` +
                    `&vehicle=car` +
                    `&locale=de` +
                    `&key=c930e6fa-be62-4c91-b102-c68b98e9d19d` +
                    `&points_encoded=false`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.paths && data.paths.length > 0) {
                    const path = data.paths[0];
                    const distanceKm = (path.distance / 1000).toFixed(1);
                    const durationMin = Math.ceil(path.time / 1000 / 60);
                    
                    qbPanelRouteDuration = durationMin;
                    
                    // Info anzeigen
                    if (routeInfo) {
                        routeInfo.innerHTML = `ğŸš— Route: ${distanceKm} km â€¢ ${durationMin} Min Fahrtdauer`;
                        routeInfo.style.display = 'block';
                    }
                    
                    // Endzeit neu berechnen
                    updatePanelEndTime();
                    
                    console.log(`ğŸ—ºï¸ Route berechnet: ${distanceKm} km, ${durationMin} Min`);
                } else {
                    // Fallback: 15 Min
                    qbPanelRouteDuration = 15;
                    if (routeInfo) routeInfo.style.display = 'none';
                    updatePanelEndTime();
                }
            } catch (error) {
                console.error('ğŸ’¾ Route-Fehler:', error);
                // Fallback: 15 Min
                qbPanelRouteDuration = 15;
                if (routeInfo) routeInfo.style.display = 'none';
                updatePanelEndTime();
            }
        }
        
        // Adressen-Autocomplete
        function setupQuickBookingPanelAutocomplete() {
            ['qb-panel-pickup', 'qb-panel-destination'].forEach(fieldId => {
                const input = document.getElementById(fieldId);
                const dropdown = document.getElementById(fieldId + '-dropdown');
                
                if (!input || !dropdown) return;
                
                input.addEventListener('input', (e) => {
                    if (fieldId === 'qb-panel-pickup') qbPanelPickupCoords = null;
                    else qbPanelDestCoords = null;
                    
                    clearTimeout(qbPanelAutocompleteTimeout);
                    const value = e.target.value.trim();
                    
                    if (value.length < 3) {
                        dropdown.style.display = 'none';
                        return;
                    }
                    
                    dropdown.innerHTML = '<div style="padding:10px;color:#999;">Suche...</div>';
                    dropdown.style.display = 'block';
                    
                    qbPanelAutocompleteTimeout = setTimeout(() => {
                        searchQuickBookingPanelAddresses(value, fieldId);
                    }, 300);
                });
                
                document.addEventListener('click', (e) => {
                    if (e.target !== input && !dropdown.contains(e.target)) {
                        dropdown.style.display = 'none';
                    }
                });
            });
            
            // âœ… Startzeit & Endzeit Anzeige
            const startInput = document.getElementById('qb-panel-start-time');
            const endInput = document.getElementById('qb-panel-end-time');
            
            if (startInput) {
                startInput.addEventListener('change', updatePanelEndTime);
            }
            
            if (endInput) {
                endInput.addEventListener('change', updatePanelEndDisplay);
            }
        }
        
        async function searchQuickBookingPanelAddresses(query, fieldId) {
            const dropdown = document.getElementById(fieldId + '-dropdown');
            
            try {
                // ğŸ†• v5.88.15: Konvertiere deutsche Namen zu polnischen!
                const searchQuery = typeof convertGermanToPolish === 'function' ? convertGermanToPolish(query) : query;
                
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?` +
                    `format=json&` +
                    `q=${encodeURIComponent(searchQuery)}&` +
                    `countrycodes=de&viewbox=10.6,54.7,14.4,53.1&bounded=1&` +
                    `limit=8&` +
                    `addressdetails=1`
                );
                
                const results = await response.json();
                
                if (results.length === 0) {
                    dropdown.innerHTML = '<div style="padding:10px;color:#999;">Keine Ergebnisse</div>';
                    return;
                }
                
                // ğŸ†• v5.52.3: Filter Usedom + WICHTIGE FESTLAND-ZIELE + POLEN!
                const usedomResults = results.filter(r => {
                    const display = r.display_name.toLowerCase();
                    return display.includes('usedom') || 
                           display.includes('heringsdorf') || 
                           display.includes('ahlbeck') ||
                           display.includes('bansin') ||
                           display.includes('zinnowitz') ||
                           display.includes('karlshagen') ||
                           display.includes('peenemÃ¼nde') ||
                           display.includes('koserow') ||
                           display.includes('Ã¼ckeritz') ||
                           display.includes('loddin') ||
                           display.includes('zempin') ||
                           display.includes('trassenheide') ||
                           // ğŸ†• v5.52.3: FESTLAND-ZIELE!
                           display.includes('greifswald') ||
                           display.includes('wolgast') ||
                           display.includes('anklam') ||
                           display.includes('stralsund') ||
                           display.includes('neubrandenburg') ||
                           // ğŸ†• v5.88.15: POLEN!
                           display.includes('Å›winoujÅ›cie') ||
                           display.includes('swinoujscie') ||
                           display.includes('miÄ™dzyzdroje') ||
                           display.includes('miedzyzdroje') ||
                           display.includes('wolin') ||
                           display.includes('szczecin') ||
                           display.includes('koÅ‚obrzeg') ||
                           display.includes('polen') ||
                           display.includes('polska');
                });
                
                const resultsToShow = usedomResults.length > 0 ? usedomResults : results;
                
                dropdown.innerHTML = resultsToShow.map(r => {
                    const address = r.address;
                    const poiName = address.amenity || address.tourism || address.building || r.name;
                    
                    let displayText = '';
                    if (poiName) displayText += poiName + ', ';
                    if (address.road) displayText += address.road + ' ';
                    if (address.house_number) displayText += address.house_number + ', ';
                    if (address.village || address.town || address.city) {
                        displayText += (address.village || address.town || address.city);
                    }
                    
                    return `
                        <div onclick="selectQuickBookingPanelAddress('${fieldId}', '${displayText.replace(/'/g, "\\'")}', ${r.lat}, ${r.lon})" style="
                            padding:12px;
                            cursor:pointer;
                            border-bottom:1px solid #f0f0f0;
                            transition:background 0.2s;
                        " onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                            <div style="font-weight:600;font-size:14px;">${displayText}</div>
                            <div style="font-size:11px;color:#999;">${r.display_name}</div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Autocomplete Fehler:', error);
                dropdown.innerHTML = '<div style="padding:10px;color:#ef4444;">Fehler bei der Suche</div>';
            }
        }
        
        function selectQuickBookingPanelAddress(fieldId, address, lat, lon) {
            document.getElementById(fieldId).value = address;
            document.getElementById(fieldId + '-dropdown').style.display = 'none';
            
            if (fieldId === 'qb-panel-pickup') {
                qbPanelPickupCoords = { lat, lon };
            } else {
                qbPanelDestCoords = { lat, lon };
            }
            
            console.log('ğŸ“ Adresse gewÃ¤hlt:', address, {lat, lon});
            
            // ğŸ†• v5.41.1: Route berechnen wenn beide Adressen da sind
            if (qbPanelPickupCoords && qbPanelDestCoords) {
                calculateRouteForPanel();
            }
        }
        
        // Fahrzeuge laden
        async function loadQuickBookingPanelVehicles() {
            const select = document.getElementById('qb-panel-vehicle');
            if (!select || !isFirebaseReady) return;
            
            // ğŸ†• v5.52.1: Lade ALLE Fahrzeuge aus Verwaltung + prÃ¼fe Online-Status
            try {
                const [vehiclesSnapshot, driversSnapshot] = await Promise.all([
                    db.ref('vehicles').once('value'),
                    db.ref('vehicles').once('value')
                ]);
                
                const vehicles = [];
                const onlineVehicleIds = new Set();
                
                // Sammle Online-Fahrzeuge von Fahrern
                driversSnapshot.forEach(child => {
                    const driver = child.val();
                    if (driver.online && driver.vehicle) {
                        onlineVehicleIds.add(driver.vehicle);
                    }
                });
                
                // Lade alle Fahrzeuge aus Verwaltung
                vehiclesSnapshot.forEach(child => {
                    const v = child.val();
                    v.id = child.key;
                    v.isOnline = onlineVehicleIds.has(v.id);
                    vehicles.push(v);
                });
                
                // ğŸ†• v5.90.235: Sortiere: PrioritÃ¤t â†’ Online â†’ Alphabetisch
                vehicles.sort((a, b) => {
                    // 1. PrioritÃ¤t (1=hoch, 10=niedrig)
                    const priorityA = a.priority || 5;
                    const priorityB = b.priority || 5;
                    if (priorityA !== priorityB) return priorityA - priorityB;
                    
                    // 2. Online-Status
                    if (a.isOnline && !b.isOnline) return -1;
                    if (!a.isOnline && b.isOnline) return 1;
                    
                    // 3. Alphabetisch
                    return (a.name || '').localeCompare(b.name || '');
                });
                
                // ğŸ†• v5.52.1: Zeige Name + Kennzeichen!
                select.innerHTML = '<option value="">Automatisch zuweisen</option>' +
                    vehicles.map(v => {
                        const statusIcon = v.isOnline ? 'ğŸŸ¢' : 'âšª';
                        const displayName = `${v.name || v.id} (${v.plate || 'Kein Kennzeichen'})`;
                        return `<option value="${v.id}">${statusIcon} ${displayName}</option>`;
                    }).join('');
                    
                console.log('ğŸš— Fahrzeuge geladen:', vehicles.length, 'davon online:', onlineVehicleIds.size);
            } catch (err) {
                console.error('ğŸ’¾ Fehler beim Laden der Fahrzeuge:', err);
            }
        }
        
        // ğŸ†• v5.63.7: UPDATE AI-NACHFRAGEN HEADER
        function updateAiNachfragenHeader() {
            // Diese Funktion prÃ¼ft ob die Fahrt vollstÃ¤ndig ist
            // und versteckt ggf. Warning-Header
            // 
            // Aktuell: Platzhalter-Funktion
            // TODO: Implementiere konkrete Logik wenn klar ist welcher Header gemeint ist
            console.log('ğŸ“‹ updateAiNachfragenHeader aufgerufen');
        }
        
        // Datetime-Anzeige aktualisieren (mit Wochentag!)
        // Kalender-Zeit-Klick (wird von Kalender aufgerufen)
        // ğŸ†• Kalender-Zeit-Klick: Startzeit setzen & Endzeit automatisch +15 Min
        function setQuickBookingPanelTime(datetime) {
            console.log('â° Zeit aus Kalender ausgewÃ¤hlt:', datetime);
            
            // Formatiere Datum fÃ¼r separate Felder
            const d = new Date(datetime);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const hours = String(d.getHours()).padStart(2, '0');
            const minutes = String(d.getMinutes()).padStart(2, '0');
            
            const dateValue = `${year}-${month}-${day}`;
            const timeValue = `${hours}:${minutes}`;
            
            console.log('   Formatiertes Datum:', dateValue);
            console.log('   Formatierte Zeit:', timeValue);
            
            // Ã–ffne Schnellbuchungs-Modal
            openQuickBookingModal();
            
            // Warte kurz bis Modal geladen ist, dann setze Datum + Zeit
            setTimeout(() => {
                const dateInput = document.getElementById('quick-booking-date');
                const timeInput = document.getElementById('quick-booking-time');
                
                if (dateInput && timeInput) {
                    dateInput.value = dateValue;
                    timeInput.value = timeValue;
                    console.log('âœ… Datum & Zeit ins Modal eingetragen!');
                    
                    // Wochentag aktualisieren
                    updateQuickBookingWeekday();
                    
                    // Fokus auf Kunde damit man direkt eingeben kann
                    const customerInput = document.getElementById('quick-booking-customer-search');
                    if (customerInput) customerInput.focus();
                } else {
                    console.error('ğŸ’¾ Datum/Zeit-Inputs nicht gefunden!');
                }
            }, 500);
        }
        
        // Buchung absenden
        async function submitQuickBookingPanel() {
            // ğŸ”’ v5.64.16: DOPPELKLICK-SCHUTZ!
            if (window.isSubmittingQuickBookingPanel) {
                console.log('âš ï¸ Submit bereits in Bearbeitung - ignoriere Klick');
                return;
            }
            
            window.isSubmittingQuickBookingPanel = true;
            console.log('ğŸ”’ Panel-Submit gesperrt (Doppelklick-Schutz)');
            
            try {
                if (!qbPanelCustomer) {
                    alert('ğŸ’¾ Bitte Kunde auswÃ¤hlen!');
                    return;
                }
                
                const startTime = document.getElementById('qb-panel-start-time').value;
                const endTime = document.getElementById('qb-panel-end-time').value;
                const pickup = document.getElementById('qb-panel-pickup').value;
                const destination = document.getElementById('qb-panel-destination').value;
                const passengers = parseInt(document.getElementById('qb-panel-passengers').value);
                const vehicle = document.getElementById('qb-panel-vehicle').value;
                const notes = document.getElementById('qb-panel-notes').value;
                
                if (!startTime) {
                    alert('ğŸ’¾ Bitte Startzeit auswÃ¤hlen!');
                    return;
                }
                
                if (!endTime) {
                    alert('ğŸ’¾ Bitte Endzeit auswÃ¤hlen!');
                    return;
                }
                
                if (!pickup || !destination) {
                    alert('ğŸ’¾ Bitte Abholort und Zielort eingeben!');
                    return;
                }
                
                // ğŸ†• v5.64.25: AUTO-GEOCODE WENN COORDS FEHLEN!
                if (!qbPanelPickupCoords || !qbPanelDestCoords) {
                    console.log('âš ï¸ Panel-Koordinaten fehlen - versuche Auto-Geocode...');
                    
                    // Versuche Adressen zu geocoden
                    const tasks = [];
                    if (!qbPanelPickupCoords && pickup) {
                        tasks.push(
                            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(pickup)}&countrycodes=de&viewbox=10.6,54.7,14.4,53.1&bounded=1&limit=1`)
                                .then(r => r.json())
                                .then(results => {
                                    if (results.length > 0) {
                                        qbPanelPickupCoords = { lat: parseFloat(results[0].lat), lon: parseFloat(results[0].lon) };
                                        console.log('âœ… Panel-Abholort geocoded:', qbPanelPickupCoords);
                                    }
                                })
                        );
                    }
                    if (!qbPanelDestCoords && destination) {
                        tasks.push(
                            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(destination)}&countrycodes=de&viewbox=10.6,54.7,14.4,53.1&bounded=1&limit=1`)
                                .then(r => r.json())
                                .then(results => {
                                    if (results.length > 0) {
                                        qbPanelDestCoords = { lat: parseFloat(results[0].lat), lon: parseFloat(results[0].lon) };
                                        console.log('âœ… Panel-Zielort geocoded:', qbPanelDestCoords);
                                    }
                                })
                        );
                    }
                    
                    if (tasks.length > 0) {
                        const toast = document.createElement('div');
                        toast.style.cssText = 'position:fixed;top:20px;right:20px;background:#3b82f6;color:white;padding:15px 20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:99999;font-weight:600;';
                        toast.innerHTML = 'ğŸ—ºï¸ Suche Koordinaten...';
                        document.body.appendChild(toast);
                        
                        await Promise.all(tasks);
                        toast.remove();
                    }
                    
                    // PrÃ¼fe erneut
                    if (!qbPanelPickupCoords || !qbPanelDestCoords) {
                        alert('ğŸ’¾ Koordinaten konnten nicht gefunden werden!\n\nğŸ’¡ Tipp: WÃ¤hle Adressen aus dem Dropdown (erscheint beim Tippen).');
                        return;
                    }
                }
                
                // ğŸ†• v5.48.2: BERECHNE ROUTE + PREIS!
                console.log('ğŸ’° Berechne Route fÃ¼r Panel-Schnellbuchung...');
                let routeData;
                try {
                routeData = await calculateRoute(qbPanelPickupCoords, qbPanelDestCoords);
                console.log('âœ… Route berechnet:', routeData);
                
                // ğŸ†• v5.50.2: PREIS BERECHNEN!
                const startDate = new Date(startTime);
                const pricing = calculatePrice(parseFloat(routeData.distance), startDate.getTime());
                
                // ğŸ†• v5.50.2: FÃ¼ge Preis zu routeData hinzu!
                routeData.price = pricing.total;
                
                console.log('âœ… Preis berechnet:', pricing.total, 'â‚¬');
                
                // ğŸ†• v5.50.6: KRITISCHE VALIDIERUNG - Verhindere undefined/NaN/0 in Firebase!
                if (!routeData.price || routeData.price <= 0 || isNaN(routeData.price)) {
                    console.error('ğŸ’¾ KRITISCHER FEHLER: UngÃ¼ltiger Preis!', routeData.price);
                    console.error('   Route-Daten:', routeData);
                    console.error('   Pricing:', pricing);
                    alert('ğŸ’¾ FEHLER: Preis konnte nicht berechnet werden!\n\nBitte Ã¼berprÃ¼fe die Adressen und versuche es erneut.\n\nPreis war: ' + routeData.price);
                    return;
                }
                console.log('âœ… Preis validiert:', routeData.price, 'â‚¬ - Speicherung erlaubt!');
                
                } catch (error) {
                    console.error('ğŸ’¾ Fehler bei Routenberechnung:', error);
                    alert('ğŸ’¾ Fehler bei Routenberechnung!\n\nBitte versuche es erneut.');
                    return;
                }
                
                try {
                    const startDate = new Date(startTime);
                    const endDate = new Date(endTime);
                    const durationMinutes = Math.round((endDate - startDate) / (1000 * 60));
                
                    // ğŸ†• v5.90.82: STELLE SICHER DASS customerPhone GESETZT IST!
                    let finalCustomerPhone = qbPanelCustomer.phone || '';
                    
                    // Falls kein Phone im Objekt, hole es aus Firebase customers
                    if (!finalCustomerPhone && qbPanelCustomer.id) {
                        try {
                            const customerSnapshot = await db.ref('customers/' + qbPanelCustomer.id).once('value');
                            const customerData = customerSnapshot.val();
                            if (customerData && customerData.phone) {
                                finalCustomerPhone = customerData.phone;
                                console.log('âœ… customerPhone aus Firebase /customers geholt:', finalCustomerPhone);
                            }
                        } catch (error) {
                            console.warn('âš ï¸ Konnte customerPhone nicht aus /customers holen:', error);
                        }
                    }
                    
                    // ğŸ†• v5.90.82: FALLBACK - Suche in /users nach Kundenname!
                    if (!finalCustomerPhone && qbPanelCustomer.name) {
                        try {
                            console.log('ğŸ” Suche User mit Name:', qbPanelCustomer.name);
                            const usersSnapshot = await db.ref('users').orderByChild('displayName').equalTo(qbPanelCustomer.name).limitToFirst(1).once('value');
                            if (usersSnapshot.exists()) {
                                usersSnapshot.forEach(userSnapshot => {
                                    const userData = userSnapshot.val();
                                    if (userData && userData.phone) {
                                        finalCustomerPhone = userData.phone;
                                        console.log('âœ… customerPhone aus /users geholt:', finalCustomerPhone);
                                    }
                                });
                            } else {
                                console.log('â„¹ï¸ Kein User mit Name gefunden:', qbPanelCustomer.name);
                            }
                        } catch (error) {
                            console.warn('âš ï¸ Konnte customerPhone nicht aus /users holen:', error);
                        }
                    }
                    
                    // ğŸ†• v5.90.85: FINDE userId FÃœR "MEINE FAHRTEN"!
                    const userId = await findUserIdForCustomer(qbPanelCustomer.name, finalCustomerPhone);
                    
                    if (!userId) {
                        console.warn('âš ï¸ WARNUNG: Keine userId gefunden fÃ¼r', qbPanelCustomer.name);
                        console.warn('   Fahrt wird gespeichert, aber erscheint NICHT in "Meine Fahrten"');
                        console.warn('   LÃ–SUNG: Kunde muss sich einmal in App einloggen!');
                    }
                    
                    const rideData = {
                        customerId: qbPanelCustomer.id,
                        userId: userId || null, // ğŸ†• v5.90.85: AUTH-UID FÃœR "MEINE FAHRTEN"!
                        customerName: qbPanelCustomer.name || 'Unbekannt',
                        customerPhone: finalCustomerPhone,
                        pickup,
                        destination,
                        pickupTime: startDate.toISOString(),
                        pickupTimestamp: startDate.getTime(), // ğŸ”§ v5.39.8: FIX - Als Zahl fÃ¼r Zeitslot-Check!
                        endTime: endDate.toISOString(),
                        endTimestamp: endDate.getTime(), // ğŸ”§ v5.39.8: FIX - Als Zahl!
                        durationMinutes: durationMinutes,
                        passengers,
                        status: 'vorbestellt', // Default, wird unten ggf. auf 'accepted' gesetzt
                        createdAt: new Date().toISOString(),
                        notes: notes || '',
                        vehicleId: vehicle || null,
                        pickupCoords: qbPanelPickupCoords,
                        destCoords: qbPanelDestCoords,
                        // ğŸ†• v5.48.2: PREIS, DISTANZ, DAUER!
                        price: routeData.price,
                        distance: routeData.distance,
                        duration: routeData.duration,
                        createdBy: 'admin',
                        adminProtection: true, // ğŸ†• v5.90.37: ADMIN-SCHUTZ!
                        isAdvanceBooking: true,
                        bookingSource: 'admin-panel' // ğŸ†• v5.49.0: Admin Panel Buchung!
                    };
                
                    // ğŸ†• v5.63.6: FAHRZEUG-FELDER SETZEN (wie bei Schnellbuchung)!
                    if (vehicle && vehicle !== 'auto') {
                        try {
                            console.log('ğŸš— Panel: Lade Fahrzeugdaten fÃ¼r:', vehicle);
                            const vehicleSnapshot = await db.ref('vehicles/' + vehicle).once('value');
                            const vehicleData = vehicleSnapshot.val();
                        
                            if (vehicleData) {
                                rideData.vehicle = vehicleData.name || vehicle;
                                rideData.vehicleLabel = vehicleData.name || vehicle;
                                rideData.vehiclePlate = vehicleData.plate || '';
                                rideData.status = 'accepted'; // â† WICHTIG!
                                rideData.acceptedAt = Date.now();
                                rideData.assignedBy = 'admin';
                            
                                console.log('âœ… Panel: Fahrzeug gesetzt:', vehicleData.name, vehicleData.plate);
                            } else {
                                console.warn('âš ï¸ Panel: Fahrzeugdaten nicht gefunden fÃ¼r:', vehicle);
                            }
                        } catch (error) {
                            console.error('ğŸ’¾ Panel: Fehler beim Laden der Fahrzeugdaten:', error);
                        }
                    }
                
                    // ğŸ”§ EDIT vs CREATE: PrÃ¼fe ob wir bearbeiten oder neu erstellen
                    let rideRef;
                
                    // ğŸ”’ v5.40.3: TRIPLE-SCHUTZ fÃ¼r Kopieren-Bug!
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    console.log('ğŸ” SPEICHERN - WICHTIGE INFO:');
                    console.log('   window.editingRideId:', window.editingRideId);
                    console.log('   Typ:', typeof window.editingRideId);
                    console.log('   Ist null?', window.editingRideId === null);
                    console.log('   Ist undefined?', window.editingRideId === undefined);
                    console.log('   Ist falsy?', !window.editingRideId);
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
                    if (window.editingRideId) {
                        // BEARBEITEN: Update existierende Fahrt
                        console.log('âš ï¸ MODUS: BEARBEITEN (Update)');
                        await db.ref(`rides/${window.editingRideId}`).update(rideData);
                        rideRef = { key: window.editingRideId };
                        console.log('âœï¸ Fahrt aktualisiert:', window.editingRideId);
                    } else {
                        // NEU ERSTELLEN: Push neue Fahrt
                        console.log('âœ… MODUS: NEU ERSTELLEN (Push)');
                        rideRef = await db.ref('rides').push(rideData);
                        console.log('âœ… Neue Fahrt erstellt:', rideRef.key);
                    
                        // ğŸ”’ v5.40.3: EXTRA-PRÃœFUNG! Fahrt wirklich in Firebase?
                        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                        console.log('ğŸ” VERIFIKATION: PrÃ¼fe ob Fahrt existiert...');
                        const verifySnapshot = await db.ref(`rides/${rideRef.key}`).once('value');
                        if (verifySnapshot.exists()) {
                            const verifyData = verifySnapshot.val();
                            console.log('âœ… BESTÃ„TIGT! Fahrt existiert in Firebase!');
                            console.log('   ID:', rideRef.key);
                            console.log('   Abholzeit:', verifyData.pickupTime);
                            console.log('   Von:', verifyData.pickup);
                            console.log('   Nach:', verifyData.destination);
                        } else {
                            console.error('ğŸ’¾ FEHLER! Fahrt NICHT in Firebase gefunden!');
                        }
                        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    }
                
                    // ğŸ”’ v5.40.4: SUPER-DEBUG! PrÃ¼fe ob Original-Fahrt noch existiert!
                    if (window.copiedFromRideId) {
                        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                        console.log('ğŸ” SUPER-DEBUG: PrÃ¼fe Original-Fahrt...');
                        console.log('   Original-Fahrt-ID:', window.copiedFromRideId);
                        console.log('   Neue-Fahrt-ID:', rideRef.key);
                    
                        try {
                            const originalSnapshot = await db.ref(`rides/${window.copiedFromRideId}`).once('value');
                            if (originalSnapshot.exists()) {
                                const originalData = originalSnapshot.val();
                                console.log('âœ… ORIGINAL-FAHRT NOCH DA!');
                                console.log('   Zeit:', originalData.pickupTime);
                                console.log('   Von:', originalData.pickup);
                                console.log('   Nach:', originalData.destination);
                            } else {
                                console.error('ğŸ’¾ğŸ’¾ğŸ’¾ KRITISCH: ORIGINAL-FAHRT WURDE GELÃ–SCHT! ğŸ’¾ğŸ’¾ğŸ’¾');
                                console.error('   GelÃ¶schte ID:', window.copiedFromRideId);
                                console.error('   Das sollte NICHT passieren beim Kopieren!');
                            }
                        } catch (error) {
                            console.error('ğŸ’¾ Fehler beim PrÃ¼fen der Original-Fahrt:', error);
                        }
                    
                        // Reset
                        window.copiedFromRideId = null;
                        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    }
                
                    // ğŸ“± v5.40.5: TELEGRAM fÃ¼r NEUE Schnellbuchungen!
                    if (!window.editingRideId) {
                        // Nur bei NEUEN Fahrten (nicht beim Bearbeiten)
                        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                        console.log('ğŸ“± TELEGRAM: Sende Benachrichtigung fÃ¼r Schnellbuchung...');
                    
                        try {
                            // Baue ride-Objekt fÃ¼r Telegram
                            const rideForTelegram = {
                                firebaseId: rideRef.key,
                                id: rideRef.key,
                                ...rideData
                            };
                        
                            await sendTelegramForNewRide(rideForTelegram);
                            console.log('âœ… TELEGRAM: Benachrichtigung gesendet!');
                        } catch (error) {
                            console.error('ğŸ’¾ TELEGRAM: Fehler beim Senden:', error);
                        }
                        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                        
                        // ğŸ†• v5.87.97: SMS AN KUNDEN SENDEN!
                        try {
                            const rideForSMS = {
                                firebaseId: rideRef.key,
                                ...rideData
                            };
                            await sendCustomerNotifications(rideForSMS);
                            console.log('âœ… Kunden-SMS gesendet (wenn aktiviert)');
                        } catch (smsError) {
                            console.error('ğŸ’¾ Fehler beim SMS-Versand:', smsError);
                        }
                    }
                
                    // ğŸ†• Speichere Adressen in CRM wenn Checkboxen aktiviert
                    const saveAsMain = document.getElementById('qb-panel-save-as-main').checked;
                    const saveAsBilling = document.getElementById('qb-panel-save-as-billing').checked;
                
                    if (saveAsMain || saveAsBilling) {
                        const updates = {};
                    
                        if (saveAsMain) {
                            updates['address'] = pickup;
                            console.log('ğŸ’¾ Stammadresse gespeichert:', pickup);
                        }
                    
                        if (saveAsBilling) {
                            updates['billingAddress'] = pickup;
                            console.log('ğŸ’¾ Rechnungsadresse gespeichert:', pickup);
                        }
                    
                        await db.ref(`customers/${qbPanelCustomer.id}`).update(updates);
                    
                        // Update lokales Objekt
                        if (saveAsMain) qbPanelCustomer.address = pickup;
                        if (saveAsBilling) qbPanelCustomer.billingAddress = pickup;
                    }
                
                    const successMsg = window.editingRideId ? 'âœ… Fahrt aktualisiert!' : 'âœ… Fahrt erfolgreich gebucht!';
                    alert(successMsg + (saveAsMain || saveAsBilling ? '\nğŸ’¾ Adresse im CRM gespeichert!' : ''));
                
                    // ğŸ”§ Reset editingRideId
                    window.editingRideId = null;
                
                    // Panel schlieÃŸen
                    closeQuickBookingPanel();
                
                    // Kalender neu laden
                    if (typeof loadCalendar === 'function') {
                        loadCalendar();
                    }
                
                    // Felder zurÃ¼cksetzen
                    document.getElementById('qb-panel-customer').value = '';
                    document.getElementById('qb-panel-start-time').value = '';
                    document.getElementById('qb-panel-end-time').value = '';
                    document.getElementById('qb-panel-pickup').value = '';
                    document.getElementById('qb-panel-destination').value = '';
                    document.getElementById('qb-panel-passengers').value = '1';
                    document.getElementById('qb-panel-vehicle').value = '';
                    document.getElementById('qb-panel-notes').value = '';
                    document.getElementById('qb-panel-save-as-main').checked = false;
                    document.getElementById('qb-panel-save-as-billing').checked = false;
                    document.getElementById('qb-panel-address-options').style.display = 'none';
                    qbPanelCustomer = null;
                    qbPanelPickupCoords = null;
                    qbPanelDestCoords = null;
                
                    console.log('âœ… Schnellbuchung erstellt:', rideRef.key, 'Dauer:', durationMinutes, 'Min');
                    
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim Speichern:', error);
                    alert('ğŸ’¾ Fehler beim Speichern: ' + error.message);
                }
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Buchen:', error);
                alert('ğŸ’¾ Fehler beim Buchen: ' + error.message);
            } finally {
                // ğŸ”’ v5.64.16: DOPPELKLICK-SCHUTZ zurÃ¼cksetzen!
                window.isSubmittingQuickBookingPanel = false;
                console.log('ğŸ”“ Panel-Submit entsperrt (Doppelklick-Schutz zurÃ¼ckgesetzt)');
            }
        }
        
        // ğŸ†• FAHRT BEARBEITEN
        async function editRideFromCalendar(rideId) {
            try {
                const snapshot = await db.ref(`rides/${rideId}`).once('value');
                const ride = snapshot.val();
                
                if (!ride) {
                    alert('ğŸ’¾ Fahrt nicht gefunden!');
                    return;
                }
                
                // ğŸ†• v5.64.39: SICHERHEITS-CHECK! Panel muss existieren!
                const panel = document.getElementById('quick-booking-panel');
                if (!panel) {
                    console.error('ğŸ’¾ Schnellbuchungs-Panel nicht gefunden!');
                    alert('ğŸ’¾ Fehler: Schnellbuchungs-Panel nicht gefunden!\n\nBitte lade die Seite neu.');
                    return;
                }
                
                // Panel Ã¶ffnen
                if (panel.style.display === 'none' || panel.style.display === '') {
                    toggleQuickBookingPanel();
                }
                
                // Felder fÃ¼llen
                if (ride.customerId) {
                    const customer = allCustomers.find(c => c.id === ride.customerId);
                    if (customer) {
                        qbPanelCustomer = customer;
                        document.getElementById('qb-panel-customer').value = customer.name || 'Unbekannt';
                    } else {
                        qbPanelCustomer = {id: ride.customerId, name: ride.customerName || 'Unbekannt', phone: ride.customerPhone || ''};
                        document.getElementById('qb-panel-customer').value = ride.customerName || 'Unbekannt';
                    }
                }
                
                // Zeiten setzen
                if (ride.pickupTime) {
                    const startDate = new Date(ride.pickupTime);
                    document.getElementById('qb-panel-start-time').value = formatForDatetimeLocal(startDate);
                }
                
                if (ride.endTime) {
                    const endDate = new Date(ride.endTime);
                    document.getElementById('qb-panel-end-time').value = formatForDatetimeLocal(endDate);
                } else if (ride.pickupTime && ride.durationMinutes) {
                    const startDate = new Date(ride.pickupTime);
                    const endDate = new Date(startDate.getTime() + (ride.durationMinutes * 60 * 1000));
                    document.getElementById('qb-panel-end-time').value = formatForDatetimeLocal(endDate);
                }
                
                // Anzeigen updaten
                updatePanelEndTime();
                
                // Adressen
                document.getElementById('qb-panel-pickup').value = ride.pickup || '';
                document.getElementById('qb-panel-destination').value = ride.destination || '';
                
                // Koordinaten
                qbPanelPickupCoords = ride.pickupCoords || null;
                qbPanelDestCoords = ride.destCoords || null;
                
                // Weitere Felder
                document.getElementById('qb-panel-passengers').value = ride.passengers || 1;
                document.getElementById('qb-panel-notes').value = ride.notes || '';
                
                // ğŸ†• v5.63.7: FAHRZEUG-DROPDOWN NACH LADEN SETZEN!
                // Warte auf Fahrzeug-Dropdown Laden, dann setze Wert
                console.log('ğŸš— Lade Fahrzeuge fÃ¼r Dropdown...');
                await loadQuickBookingPanelVehicles(); // Warte auf Laden!
                
                // Jetzt setze Fahrzeug-Wert
                if (ride.vehicleId) {
                    document.getElementById('qb-panel-vehicle').value = ride.vehicleId;
                    console.log('âœ… Fahrzeug gesetzt:', ride.vehicleId);
                } else {
                    document.getElementById('qb-panel-vehicle').value = '';
                    console.log('âšª Kein Fahrzeug zugewiesen');
                }
                
                // Adress-Optionen anzeigen
                showAddressOptions();
                
                // ğŸ†• v5.63.9: HÃ„UFIGE ZIELORTE ANZEIGEN beim Bearbeiten!
                if (qbPanelCustomer && qbPanelCustomer.phone) {
                    console.log('ğŸ”¥ Lade hÃ¤ufige Zielorte fÃ¼r:', qbPanelCustomer.name);
                    showFrequentDestinations(qbPanelCustomer.phone, qbPanelCustomer.id, 'qb-panel-frequent-destinations');
                }
                
                // ğŸ”§ WICHTIG: Speichere Original-ID fÃ¼r Update statt Create
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('âœï¸ BEARBEITEN MODUS AKTIVIERT!');
                console.log('   Fahrt-ID:', rideId);
                console.log('   editingRideId wird gesetzt auf:', rideId);
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                window.editingRideId = rideId;
                
                // ğŸ†• v5.51.0: Button-Text auf SPEICHERN setzen (BEARBEITEN-Modus)
                const submitBtn = document.getElementById('qb-panel-submit-btn');
                if (submitBtn) submitBtn.innerHTML = 'ğŸ’¾ Speichern';
                
                // ğŸ†• v5.63.7: VERSTECKE AI-NACHFRAGEN HEADER wenn Fahrt vollstÃ¤ndig
                updateAiNachfragenHeader();
                
                console.log('âœï¸ Fahrt wird bearbeitet:', rideId);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden:', error);
                alert('ğŸ’¾ Fehler beim Laden der Fahrt: ' + error.message);
            }
        }
        
        // ğŸ†• v5.90.22: FAHRT ABSCHLIESSEN MIT PREIS-BEARBEITUNG
        async function completeRideWithPrice(rideId) {
            try {
                const snapshot = await db.ref(`rides/${rideId}`).once('value');
                const ride = snapshot.val();
                
                if (!ride) {
                    alert('ğŸ’¾ Fahrt nicht gefunden!');
                    return;
                }
                
                // Aktuellen Preis holen - SICHER in Number umwandeln!
                const currentPrice = parseFloat(ride.price || ride.calculatedPrice || 0) || 0;
                
                console.log('ğŸ’° Preis geladen:', {
                    raw: ride.price,
                    calculated: ride.calculatedPrice,
                    final: currentPrice,
                    type: typeof currentPrice
                });
                
                // Modal erstellen
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    padding: 20px;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; max-width: 500px; width: 100%; padding: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <h3 style="margin: 0 0 20px 0; color: #1f2937; font-size: 20px;">
                            âœ… Fahrt abschlieÃŸen
                        </h3>
                        
                        <div style="background: #f3f4f6; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            <div style="font-size: 13px; color: #6b7280; margin-bottom: 5px;">Kunde:</div>
                            <div style="font-weight: 600; color: #1f2937; margin-bottom: 10px;">${ride.customerName || 'Unbekannt'}</div>
                            
                            <div style="font-size: 13px; color: #6b7280; margin-bottom: 5px;">Route:</div>
                            <div style="font-size: 14px; color: #1f2937;">
                                ğŸ“ ${ride.pickup || 'Start'}<br>
                                ğŸ¯ ${ride.destination || 'Ziel'}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #1f2937;">
                                ğŸ’° Endpreis (EUR):
                            </label>
                            <div style="position: relative;">
                                <input 
                                    type="number" 
                                    id="complete-ride-price" 
                                    value="${currentPrice.toFixed(2)}" 
                                    step="0.01" 
                                    min="0"
                                    style="width: 100%; padding: 12px 40px 12px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; font-weight: 600;"
                                    onchange="this.value = parseFloat(this.value || 0).toFixed(2)">
                                <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #6b7280; font-weight: 600;">â‚¬</span>
                            </div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                                Berechneter Preis: ${currentPrice.toFixed(2)} â‚¬
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button onclick="closeCompleteRideModal()" 
                                    style="padding: 12px; background: #e5e7eb; color: #374151; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                ğŸ’¾ Abbrechen
                            </button>
                            <button onclick="saveCompletedRide('${rideId}')" 
                                    style="padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                âœ… AbschlieÃŸen
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Focus auf Preis-Input
                setTimeout(() => {
                    const priceInput = document.getElementById('complete-ride-price');
                    if (priceInput) {
                        priceInput.focus();
                        priceInput.select();
                    }
                }, 100);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // ğŸ†• v5.90.34: SchlieÃŸe AbschlieÃŸen-Modal
        window.closeCompleteRideModal = function() {
            const modals = document.querySelectorAll('div[style*="position: fixed"][style*="z-index: 10000"]');
            modals.forEach(modal => modal.remove());
            console.log('âœ… AbschlieÃŸen-Modal geschlossen');
        };
        
        // ğŸ†• v5.90.30: SPEICHERE ABGESCHLOSSENE FAHRT - VERBESSERT
        window.saveCompletedRide = async function(rideId) {
            try {
                const priceInput = document.getElementById('complete-ride-price');
                if (!priceInput) {
                    alert('ğŸ’¾ Preis-Eingabe nicht gefunden!');
                    return;
                }
                
                const finalPrice = parseFloat(priceInput.value);
                
                if (isNaN(finalPrice) || finalPrice < 0) {
                    alert('ğŸ’¾ Bitte gÃ¼ltigen Preis eingeben!');
                    return;
                }
                
                // Update in Firebase
                await db.ref(`rides/${rideId}`).update({
                    price: finalPrice,
                    status: 'completed',
                    completedAt: Date.now()
                });
                
                // Modal schlieÃŸen - ALLE Modals mit diesem Style
                document.querySelectorAll('div[style*="position: fixed"]').forEach(modal => {
                    if (modal.style.zIndex === '10000') modal.remove();
                });
                
                // Success
                alert(`âœ… Fahrt abgeschlossen!\nEndpreis: ${finalPrice.toFixed(2)} â‚¬`);
                
                // Reload Kalender
                if (typeof loadRidesForCalendar === 'function') {
                    loadRidesForCalendar();
                }
                
                console.log('âœ… Fahrt abgeschlossen:', rideId, 'Preis:', finalPrice);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler beim Speichern: ' + error.message);
            }
        };
        
        // ğŸ†• FAHRT KOPIEREN
        async function copyRideFromCalendar(rideId) {
            try {
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('ğŸ“‹ FAHRT KOPIEREN GESTARTET!');
                console.log('   Von Fahrt:', rideId);
                console.log('   âœ… Wird kopiert: Kunde, Gast, Start, Ziel, Personen, Notizen');
                console.log('   ğŸ’¾ Wird NICHT kopiert: Fahrzeug, Uhrzeit');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
                const snapshot = await db.ref(`rides/${rideId}`).once('value');
                const ride = snapshot.val();
                
                if (!ride) {
                    alert('ğŸ’¾ Fahrt nicht gefunden!');
                    return;
                }
                
                // Erstelle Customer-Objekt
                let customer = null;
                if (ride.customerId) {
                    // Versuche Kunde aus allCustomers zu finden
                    customer = allCustomers.find(c => c.id === ride.customerId);
                    if (!customer) {
                        // Fallback: Erstelle Customer-Objekt aus Fahrt-Daten
                        customer = {
                            id: ride.customerId,
                            name: ride.customerName || 'Unbekannt',
                            phone: ride.customerPhone || '',
                            address: ride.pickup || ''
                        };
                    }
                }
                
                console.log('ğŸ“‹ Fahrt-Daten:');
                console.log('   âœ… Kunde:', customer ? customer.name : 'Keiner');
                console.log('   âœ… Gast:', ride.guestName || 'Keiner');
                console.log('   âœ… Von:', ride.pickup);
                console.log('   âœ… Nach:', ride.destination);
                console.log('   âœ… Personen:', ride.passengers || 1);
                console.log('   âœ… Notizen:', ride.notes || 'Keine');
                console.log('   ğŸ’¾ Fahrzeug: NICHT kopiert');
                console.log('   ğŸ’¾ Zeit: NICHT kopiert (Default: Jetzt + 15 Min)');
                
                // Ã–ffne Schnellbuchungs-Modal mit kopierten Daten
                await openQuickBookingModal(customer);
                
                // Warte kurz bis Modal fertig geladen ist
                setTimeout(() => {
                    // ğŸ†• v5.75.1: QUICK BOOKING MODAL IDS!
                    const pickupInput = document.getElementById('quick-booking-pickup');
                    const destInput = document.getElementById('quick-booking-destination');
                    const passengersInput = document.getElementById('quick-booking-passengers');
                    const notesInput = document.getElementById('quick-booking-notes');
                    const guestNameInput = document.getElementById('quick-booking-guest-name');
                    
                    if (pickupInput) pickupInput.value = ride.pickup || '';
                    if (destInput) destInput.value = ride.destination || '';
                    if (passengersInput) passengersInput.value = ride.passengers || 1;
                    if (notesInput) notesInput.value = ride.notes || '';
                    
                    // ğŸ†• v5.75.1: Gast-Name kopieren wenn vorhanden!
                    if (guestNameInput && ride.guestName) {
                        guestNameInput.value = ride.guestName;
                        console.log('âœ… Gast-Name kopiert:', ride.guestName);
                    }
                    
                    // ğŸ’¾ v5.75.1: FAHRZEUG WIRD NICHT MEHR KOPIERT!
                    // ğŸ’¾ v5.75.1: ZEIT WIRD NICHT KOPIERT (bleibt auf +15 Min Default)
                    
                    // Koordinaten fÃ¼r Route (falls vorhanden)
                    if (ride.pickupCoords) {
                        window.quickBookingPickupCoords = ride.pickupCoords;
                        console.log('âœ… Pickup-Koordinaten kopiert');
                    }
                    if (ride.destCoords) {
                        window.quickBookingDestCoords = ride.destCoords;
                        console.log('âœ… Ziel-Koordinaten kopiert');
                    }
                    
                    console.log('âœ… Fahrt-Daten kopiert (ohne Fahrzeug + Zeit)!');
                    console.log('ğŸ“‹ Kopiert: Kunde, Gast, Start, Ziel, Personen, Notizen');
                    
                    // Fokus auf Datum damit User direkt Zeit eingeben kann
                    const dateInput = document.getElementById('quick-booking-date');
                    if (dateInput) dateInput.focus();
                    
                }, 500);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Kopieren:', error);
                alert('ğŸ’¾ Fehler beim Kopieren der Fahrt: ' + error.message);
            }
        }
        
        // ğŸ†• FAHRT LÃ–SCHEN
        // ğŸ†• v5.64.41: ADMIN-STORNIERUNG MIT TELEGRAM
        async function cancelRideAsAdmin(rideId) {
            const snapshot = await db.ref(`rides/${rideId}`).once('value');
            const ride = snapshot.val();
            
            if (!ride) {
                alert('ğŸ’¾ Fahrt nicht gefunden!');
                return;
            }
            
            if (ride.status === 'cancelled') {
                alert('âš ï¸ Fahrt ist bereits storniert!');
                return;
            }
            
            // ğŸ†• v5.87.58: STORNO-SCHUTZ fÃ¼r Hotel-Fahrten! ğŸ”’
            if (ride.hotelCalendarId) {
                const hotelName = ride.hotelName || 'Hotel';
                const extraConfirm = confirm(
                    `âš ï¸ ACHTUNG: HOTEL-FAHRT!\n\n` +
                    `ğŸ¨ Hotel: ${hotelName}\n` +
                    `ğŸ’¾ Gast: ${ride.guestName || ride.customerName || '?'}\n` +
                    `ğŸ“ Von: ${ride.pickup || '?'}\n` +
                    `ğŸ¯ Nach: ${ride.destination || '?'}\n\n` +
                    `ğŸ”’ Diese Fahrt wurde vom Hotel-Kalender importiert!\n\n` +
                    `ğŸ’¾ WIRKLICH STORNIEREN?\n` +
                    `(Das Hotel wird NICHT automatisch informiert!)`
                );
                
                if (!extraConfirm) {
                    console.log('ğŸ”’ Hotel-Fahrt Stornierung abgebrochen');
                    return;
                }
            }
            
            const confirmMsg = `Fahrt wirklich stornieren?\n\n` +
                `ğŸ“ Von: ${ride.pickup || '?'}\n` +
                `ğŸ¯ Nach: ${ride.destination || '?'}\n` +
                `ğŸ’¾ Kunde: ${ride.customerName || '?'}\n\n` +
                `âš ï¸ Der Fahrer wird per Telegram benachrichtigt!`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            try {
                // Status auf cancelled setzen
                await db.ref(`rides/${rideId}`).update({
                    status: 'cancelled',
                    cancelledAt: Date.now(),
                    cancelledBy: 'admin',
                    cancellationReason: 'Von Admin storniert'
                });
                
                // ğŸ“± TELEGRAM AN FAHRER - AUCH WENN NICHT ZUGEWIESEN!
                console.log('ğŸ“± Sende Stornierung-Telegram...');
                
                // Nachricht vorbereiten
                const cancelMessage = `ğŸš« <b>FAHRT STORNIERT (ADMIN)!</b>\n\n` +
                    `ğŸ’¾ Kunde: ${ride.customerName || 'Unbekannt'}\n` +
                    `ğŸ“ Von: ${ride.pickup}\n` +
                    `ğŸ¯ Nach: ${ride.destination}\n` +
                    `ğŸ’° Preis: ${ride.price || '?'}â‚¬\n\n` +
                    `ğŸ’¾ Die Fahrt wurde vom Admin storniert.`;
                
                // Sende an zugewiesenen Fahrer ODER an alle
                if (ride.assignedTo) {
                    // An zugewiesenen Fahrer
                    try {
                        await sendTelegramToDriverCancel(ride.assignedTo, cancelMessage);
                        console.log('âœ… Telegram an zugewiesenen Fahrer gesendet');
                    } catch (error) {
                        console.error('ğŸ’¾ Telegram-Fehler:', error);
                    }
                } else {
                    // KEINE Zuweisung - Sende Info-Telegram an Admin-Gruppe
                    console.log('âš ï¸ Fahrt war nicht zugewiesen - Info-Nachricht');
                    // Hier kÃ¶nnte man eine Nachricht an eine Admin-Gruppe senden
                }
                
                alert('âœ… Fahrt storniert!\n\nTelegram wurde gesendet.');
                
                // Logs
                logActivity('status', 'cancelled', 'Admin-Stornierung', {
                    customer: ride.customerName,
                    from: ride.pickup,
                    to: ride.destination
                });
                
                // Views aktualisieren
                updateAdminView();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Stornieren:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // ğŸ†• v5.90.525: FAHRT ABSCHLIESSEN ALS ADMIN!
        async function completeRideAsAdmin(rideId) {
            const snapshot = await db.ref(`rides/${rideId}`).once('value');
            const ride = snapshot.val();
            
            if (!ride) {
                alert('ğŸ’¾ Fahrt nicht gefunden!');
                return;
            }
            
            if (ride.status === 'completed') {
                alert('âš ï¸ Fahrt ist bereits abgeschlossen!');
                return;
            }
            
            const confirmMsg = `Fahrt jetzt abschlieÃŸen?\n\n` +
                `ğŸ“ Von: ${ride.pickup || '?'}\n` +
                `ğŸ¯ Nach: ${ride.destination || '?'}\n` +
                `ğŸ’¾ Kunde: ${ride.customerName || '?'}\n` +
                `ğŸ’° Preis: ${ride.price || '?'}â‚¬\n\n` +
                `âœ… Status wird auf "Abgeschlossen" gesetzt.`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            try {
                await db.ref(`rides/${rideId}`).update({
                    status: 'completed',
                    completedAt: Date.now(),
                    completedBy: 'admin'
                });
                
                console.log('âœ… Fahrt abgeschlossen:', rideId);
                
                alert('âœ… Fahrt abgeschlossen!');
                
                // Logs
                logActivity('status', 'completed', 'Admin-Abschluss', {
                    customer: ride.customerName,
                    from: ride.pickup,
                    to: ride.destination
                });
                
                // Views aktualisieren
                updateAdminView();
                if (typeof updateDriverView === 'function') updateDriverView();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim AbschlieÃŸen:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }

        async function deleteRideFromCalendar(rideId) {
            const snapshot = await db.ref(`rides/${rideId}`).once('value');
            const ride = snapshot.val();
            
            if (!ride) {
                alert('ğŸ’¾ Fahrt nicht gefunden!');
                return;
            }
            
            // ğŸ”§ v5.40.9: FIX - firebaseId hinzufÃ¼gen fÃ¼r Telegram!
            ride.firebaseId = rideId;
            ride.id = ride.id || rideId;
            
            const confirmMsg = `Fahrt wirklich lÃ¶schen?\n\n` +
                `ğŸ“ Von: ${ride.pickup || '?'}\n` +
                `ğŸ¯ Nach: ${ride.destination || '?'}\n` +
                `ğŸ’¾ Kunde: ${ride.customerName || '?'}`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            try {
                await db.ref(`rides/${rideId}`).remove();
                
                // ğŸ“± v5.40.6: TELEGRAM fÃ¼r gelÃ¶schte Fahrten!
                console.log('ğŸ“± TELEGRAM: Sende LÃ¶sch-Benachrichtigung...');
                try {
                    await sendTelegramForDeletedRide(ride);
                    console.log('âœ… TELEGRAM: LÃ¶sch-Benachrichtigung gesendet!');
                } catch (telegramError) {
                    console.error('ğŸ’¾ TELEGRAM: Fehler beim Senden:', telegramError);
                }
                
                alert('âœ… Fahrt gelÃ¶scht!');
                
                // Kalender neu laden
                if (typeof loadCalendar === 'function') {
                    loadCalendar();
                } else if (typeof renderCalendar === 'function') {
                    renderCalendar();
                }
                
                console.log('ğŸ—‘ï¸ Fahrt gelÃ¶scht:', rideId);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim LÃ¶schen:', error);
                alert('ğŸ’¾ Fehler beim LÃ¶schen: ' + error.message);
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.52.2: RECHNUNGS-SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // ğŸ†• v5.52.4: Globale Variablen fÃ¼r Rechnungs-Positionen
        let invoicePositions = [];
        let invoiceRideData = null;
        let invoiceCustomerData = null;
        let invoiceSelectedBillingAddress = null; // ğŸ†• v5.52.5: GewÃ¤hlte Rechnungsadresse
        
        async function openInvoiceModal(rideId) {
            console.log('ğŸ“± Ã–ffne Rechnungsmodal fÃ¼r:', rideId);
            
            try {
                // Lade Fahrt
                const snapshot = await db.ref(`rides/${rideId}`).once('value');
                const ride = snapshot.val();
                
                if (!ride) {
                    alert('ğŸ’¾ Fahrt nicht gefunden!');
                    return;
                }
                
                // ğŸ†• v5.90.591: CHECK STATUS BEVOR MODAL Ã–FFNET!
                if (ride.status !== 'completed' && ride.status !== 'cancelled') {
                    alert('âš ï¸ Rechnung kann nur fÃ¼r abgeschlossene oder stornierte Fahrten erstellt werden!\n\nAktueller Status: ' + (ride.status || 'unbekannt'));
                    console.warn('ğŸš« v5.90.591: Rechnung nicht erlaubt fÃ¼r Status:', ride.status);
                    return;
                }
                
                // Lade Kunde (falls customerId vorhanden)
                let customer = null;
                if (ride.customerId) {
                    const customerSnapshot = await db.ref(`customers/${ride.customerId}`).once('value');
                    customer = customerSnapshot.val();
                }
                
                // ğŸ†• v5.52.4: Speichere Daten global
                invoiceRideData = ride;
                invoiceCustomerData = customer;
                
                // ğŸ†• v5.90.321: WENN RECHNUNG EXISTIERT â†’ LADE SIE!
                let existingInvoice = null;
                if (ride.invoiceNumber) {
                    console.log('ğŸ“± v5.90.321: Lade bestehende Rechnung:', ride.invoiceNumber);
                    const invoiceSnapshot = await db.ref(`invoices/${ride.invoiceNumber}`).once('value');
                    existingInvoice = invoiceSnapshot.val();
                    
                    if (existingInvoice) {
                        console.log('âœ… v5.90.321: Rechnung geladen!', existingInvoice);
                    }
                }
                
                // ğŸ†• v5.52.5: Initialisiere Rechnungsadresse
                if (existingInvoice && existingInvoice.customerAddress) {
                    // ğŸ†• v5.90.321: Nutze Adresse aus Rechnung!
                    invoiceSelectedBillingAddress = existingInvoice.customerAddress;
                } else if (customer?.billingAddresses && customer.billingAddresses.length > 0) {
                    const defaultAddr = customer.billingAddresses.find(a => a.isDefault) || customer.billingAddresses[0];
                    invoiceSelectedBillingAddress = defaultAddr.address;
                } else if (customer?.billingAddress) {
                    // Migration: Alte Adresse
                    invoiceSelectedBillingAddress = customer.billingAddress;
                } else if (customer?.address) {
                    invoiceSelectedBillingAddress = customer.address;
                } else {
                    invoiceSelectedBillingAddress = '';
                }
                
                // ğŸ†• v5.90.321: Initialisiere Positionen
                // ğŸ”§ v5.90.339: FIX - distance MUSS vor if/else definiert werden!
                const distance = parseFloat(ride.distance) || 0;
                // ğŸ”§ v5.90.340: FIX - vatRate MUSS auch vor if/else definiert werden!
                const vatRate = distance < 50 ? 7 : 19;
                
                if (existingInvoice && existingInvoice.positions && existingInvoice.positions.length > 0) {
                    // Nutze bestehende Positionen!
                    console.log('âœ… v5.90.321: Nutze bestehende Positionen:', existingInvoice.positions);
                    invoicePositions = existingInvoice.positions.map((pos, idx) => ({
                        id: idx + 1,
                        description: pos.description || 'Position',
                        amount: parseFloat(pos.amount) || 0,
                        vatRate: parseFloat(pos.vatRate) || 7
                    }));
                } else {
                    // Neue Rechnung: v5.90.306: Initialisiere Positionen mit Hauptfahrt + MwSt
                    const grossPrice = parseFloat(ride.price) || 0;
                    
                    invoicePositions = [
                        {
                            id: 1,
                            description: 'Taxifahrt',
                            amount: grossPrice,
                            vatRate: vatRate // ğŸ†• v5.90.306: MwSt basierend auf Distanz
                        }
                    ];
                }
                
                // ğŸ†• v5.87.90: NEUES FLEXIBLES RECHNUNGS-MODAL
                const customerName = ride.customerName || customer?.name || 'Unbekannt';
                const customerAddress = invoiceSelectedBillingAddress || customer?.billingAddress || customer?.address || '';
                const customerEmail = customer?.email || '';
                const customerPhone = customer?.phone || ride.phone || '';
                const guestName = ride.guestName || '';
                const rideDate = new Date(ride.pickupTimestamp || ride.createdAt).toLocaleDateString('de-DE');
                const rideTime = new Date(ride.pickupTimestamp || ride.createdAt).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
                const pickup = ride.pickup || '';
                const destination = ride.destination || '';
                
                const modal = document.createElement('div');
                modal.id = 'invoice-modal';
                modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:99999;padding:20px;';
                
                modal.innerHTML = `
                    <div style="background:white;border-radius:16px;max-width:800px;width:100%;max-height:90vh;overflow-y:auto;">
                        <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:20px;border-radius:16px 16px 0 0;position:sticky;top:0;z-index:10;">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <h3 style="margin:0;font-size:20px;">ğŸ“± Rechnung erstellen</h3>
                                <button onclick="closeInvoiceModal()" 
                                    style="background:rgba(255,255,255,0.2);border:none;color:white;font-size:24px;width:32px;height:32px;border-radius:50%;cursor:pointer;">Ã—</button>
                            </div>
                        </div>
                        
                        <div style="padding:20px;">
                            <!-- ğŸ†• BEARBEITBARE FELDER -->
                            <div style="background:#f0f9ff;border:2px solid #3b82f6;padding:15px;border-radius:10px;margin-bottom:20px;">
                                <div style="font-weight:700;margin-bottom:15px;color:#1e40af;">âœï¸ Rechnungsdaten (bearbeitbar)</div>
                                
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                                    <div>
                                        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">Kundenname:</label>
                                        <div style="display:flex;gap:8px;">
                                            <input type="text" id="inv-customer-name" value="${customerName}"
                                                   style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
                                            <button onclick="openCustomerEditFromInvoice()" 
                                                    style="padding:10px 16px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;white-space:nowrap;font-size:13px;"
                                                    title="Kunde im CRM bearbeiten">
                                                âœï¸ CRM
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">Gastname (optional):</label>
                                        <input type="text" id="inv-guest-name" value="${guestName}"
                                               style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
                                    </div>
                                </div>
                                
                                <div style="margin-top:10px;">
                                    <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">Rechnungsadresse:</label>
                                    <textarea id="inv-address" rows="2" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;resize:vertical;">${customerAddress}</textarea>
                                </div>
                                
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:10px;">
                                    <div>
                                        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">Von:</label>
                                        <input type="text" id="inv-pickup" value="${pickup}"
                                               style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
                                    </div>
                                    <div>
                                        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">Nach:</label>
                                        <input type="text" id="inv-destination" value="${destination}"
                                               style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
                                    </div>
                                </div>
                                
                                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;margin-top:10px;">
                                    <div>
                                        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">ğŸ“… Datum:</label>
                                        <input type="date" id="inv-date" value="${getLocalDateString(ride.pickupTimestamp || ride.createdAt)}"
                                               style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
                                    </div>
                                    <div>
                                        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">ğŸ• Uhrzeit:</label>
                                        <input type="time" id="inv-time" value="${new Date(ride.pickupTimestamp || ride.createdAt).toTimeString().split(' ')[0].slice(0,5)}"
                                               style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
                                    </div>
                                    <div>
                                        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">Distanz (km):</label>
                                        <div style="display:flex;gap:5px;">
                                            <input type="number" id="invoice-distance" value="${distance.toFixed(1)}" step="0.1" min="0"
                                                   onchange="updateInvoiceDistanceAndVat()"
                                                   style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
                                            <button onclick="recalculateInvoiceDistance()" title="Distanz neu berechnen"
                                                    style="padding:10px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer;white-space:nowrap;">
                                                ğŸ”„
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                                
                                <!-- ğŸ†• v5.90.176: LIEFERDATUM & LIEFERZEITRAUM -->
                                <div style="background:#f0f9ff;border:2px solid #3b82f6;padding:12px;border-radius:8px;margin-top:10px;">
                                    <div style="font-weight:600;margin-bottom:10px;color:#1e40af;">ğŸ“¦ Lieferung (optional)</div>
                                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
                                        <div>
                                            <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">ğŸ“… Lieferdatum:</label>
                                            <input type="date" id="inv-delivery-date" 
                                                   style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
                                            <div style="font-size:10px;color:#6b7280;margin-top:2px;">
                                                ğŸ’¡ Auch Vergangenheit mÃ¶glich
                                            </div>
                                        </div>
                                        <div>
                                            <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">ğŸ• Von:</label>
                                            <input type="time" id="inv-delivery-from" 
                                                   style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
                                        </div>
                                        <div>
                                            <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">ğŸ• Bis:</label>
                                            <input type="time" id="inv-delivery-to" 
                                                   style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
                                        </div>
                                    </div>
                                </div>
                            <!-- ğŸ†• CHECKBOXEN: WAS SOLL AUF DIE RECHNUNG? -->
                            <div style="background:#fefce8;border:2px solid #eab308;padding:15px;border-radius:10px;margin-bottom:20px;">
                                <div style="font-weight:700;margin-bottom:15px;color:#854d0e;">ğŸ“‹ Was soll auf die Rechnung?</div>
                                
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:white;border-radius:6px;">
                                        <input type="checkbox" id="inv-show-customer" checked style="width:18px;height:18px;">
                                        <span>ğŸ’¾ Kundenname</span>
                                    </label>
                                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:white;border-radius:6px;">
                                        <input type="checkbox" id="inv-show-address" checked style="width:18px;height:18px;">
                                        <span>ğŸ“ Adresse</span>
                                    </label>
                                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:white;border-radius:6px;">
                                        <input type="checkbox" id="inv-show-guest" ${guestName ? 'checked' : ''} style="width:18px;height:18px;">
                                        <span>ğŸ“ Gastname</span>
                                    </label>
                                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:white;border-radius:6px;">
                                        <input type="checkbox" id="inv-show-route" checked style="width:18px;height:18px;">
                                        <span>ğŸš• Von/Nach</span>
                                    </label>
                                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:white;border-radius:6px;">
                                        <input type="checkbox" id="inv-show-datetime" checked style="width:18px;height:18px;">
                                        <span>ğŸ“… Datum/Uhrzeit</span>
                                    </label>
                                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:white;border-radius:6px;">
                                        <input type="checkbox" id="inv-show-distance" style="width:18px;height:18px;">
                                        <span>ğŸ“ Distanz (km)</span>
                                    </label>
                                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:white;border-radius:6px;">
                                        <input type="checkbox" id="inv-show-vat" checked style="width:18px;height:18px;">
                                        <span>ğŸ’¶ MwSt-Ausweis</span>
                                    </label>
                                </div>
                                
                                <div style="margin-top:15px;padding:10px;background:#dcfce7;border-radius:6px;font-size:13px;color:#166534;">
                                    ğŸ”’ <strong>Immer dabei:</strong> Rechnungsnummer, Datum, Bankdaten, Steuernummer
                                </div>
                            </div>
                            
                            <!-- POSITIONEN -->
                            <div style="background:#f0fdf4;border:2px solid #10b981;padding:15px;border-radius:10px;margin-bottom:20px;">
                                <div style="font-weight:700;margin-bottom:15px;color:#048257;">ğŸ’° Positionen (Brutto-BetrÃ¤ge)</div>
                                
                                <div id="invoice-positions-container"></div>
                                
                                <button onclick="addInvoicePosition()" 
                                        style="width:100%;padding:10px;margin-top:10px;background:#10b981;color:white;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.3s;"
                                        onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                                    + Position hinzufÃ¼gen
                                </button>
                                
                                <!-- MwSt Auswahl -->
                                <div style="margin-top:15px;display:flex;align-items:center;gap:10px;">
                                    <label style="font-size:13px;color:#6b7280;">MwSt-Satz:</label>
                                    <select id="invoice-vat-rate" onchange="updateInvoiceCalculation()"
                                            style="padding:8px 15px;border:2px solid #10b981;border-radius:8px;font-size:14px;font-weight:600;">
                                        <option value="7" ${vatRate === 7 ? 'selected' : ''}>7% (ermÃ¤ÃŸigt)</option>
                                        <option value="19" ${vatRate === 19 ? 'selected' : ''}>19% (normal)</option>
                                    </select>
                                </div>
                                
                                <!-- ğŸ†• v5.90.7: ZAHLUNGSART AUSWAHL -->
                                <div style="margin-top:15px;display:flex;align-items:center;gap:10px;">
                                    <label style="font-size:13px;color:#6b7280;">ğŸ’³ Zahlungsart:</label>
                                    <select id="invoice-payment-method"
                                            style="padding:8px 15px;border:2px solid #10b981;border-radius:8px;font-size:14px;font-weight:600;flex:1;">
                                        <option value="bar" selected>ğŸ’µ Bar</option>
                                        <option value="ec">ğŸ’³ EC-Karte</option>
                                        <option value="credit">ğŸ’³ Kreditkarte</option>
                                        <option value="paypal">ğŸ…¿ï¸ PayPal</option>
                                        <option value="rechnung">ğŸ“± Rechnung</option>
                                        <option value="uberweisung">ğŸ¦ Ãœberweisung</option>
                                    </select>
                                </div>
                                
                                <!-- BERECHNUNG -->
                                <div style="border-top:2px solid #10b981;padding-top:15px;margin-top:15px;">
                                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;font-size:14px;">
                                        <span>Gesamt (brutto):</span>
                                        <span id="invoice-gross-total" style="font-weight:600;">0.00â‚¬</span>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;font-size:14px;color:#6b7280;">
                                        <span>davon Netto:</span>
                                        <span id="invoice-net-display">0.00â‚¬</span>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;font-size:14px;color:#6b7280;">
                                        <span>davon MwSt (<span id="invoice-vat-rate-display">7</span>%):</span>
                                        <span id="invoice-vat-display">0.00â‚¬</span>
                                    </div>
                                </div>
                                
                                <input type="hidden" id="invoice-ride-id" value="${rideId}">
                            </div>
                            
                            <!-- BUTTONS -->
                            <div style="display:flex;gap:10px;flex-direction:column;">
                                <button onclick="generateInvoicePDFv2()" 
                                        style="width:100%;padding:15px;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;transition:all 0.3s;">
                                    ğŸ“¥ PDF erstellen & speichern
                                </button>
                                
                                <!-- ERST NACH SPEICHERN SICHTBAR! -->
                                <div id="invoice-share-buttons" style="display:none;gap:10px;flex-direction:column;">
                                    <button onclick="generateAndEmailInvoice()" 
                                            style="width:100%;padding:15px;background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;border:none;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:8px;">
                                        ğŸ“§ Per E-Mail senden
                                    </button>
                                    
                                    <button onclick="shareInvoiceViaWhatsApp()" 
                                            style="width:100%;padding:15px;background:linear-gradient(135deg,#25D366,#128C7E);color:white;border:none;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:8px;">
                                        ğŸ“¤ Per WhatsApp senden
                                    </button>
                                </div>
                                
                                <button onclick="closeInvoiceModal()" 
                                        style="width:100%;padding:12px;background:#6b7280;color:white;border:none;border-radius:10px;font-weight:600;cursor:pointer;">
                                    Abbrechen
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Rendere Positionen initial
                renderInvoicePositions();
                updateInvoiceCalculation();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Ã–ffnen des Rechnungsmodals:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        function closeInvoiceModal() {
            const modal = document.getElementById('invoice-modal');
            if (modal) modal.remove();
            invoicePositions = [];
            invoiceRideData = null;
            invoiceCustomerData = null;
            invoiceSelectedBillingAddress = null; // ğŸ†• v5.52.5
        }
        
        // ğŸ†• v5.90.148: Ã–FFNE KUNDEN-BEARBEITUNG AUS RECHNUNG
        async function openCustomerEditFromInvoice() {
            console.log('âœï¸ v5.90.148: Ã–ffne CRM-Bearbeitung aus Rechnung');
            
            let customerId = null;
            
            // 1. PrÃ¼fe ob wir eine Customer ID haben (von Fahrt)
            if (invoiceRideData && invoiceRideData.customerId) {
                customerId = invoiceRideData.customerId;
                console.log('âœ… Customer ID von Fahrt:', customerId);
            } 
            // 2. Wenn nicht, suche nach Name
            else {
                const customerName = document.getElementById('inv-customer-name')?.value?.trim();
                
                if (!customerName) {
                    alert('âš ï¸ Bitte erst einen Kundennamen eingeben!');
                    return;
                }
                
                console.log('ğŸ” Suche Kunde nach Name:', customerName);
                
                // ğŸ†• v5.90.153: BESSERE SUCHE - TEILSTRING + CASE-INSENSITIVE!
                try {
                    // Lade ALLE Kunden
                    const snapshot = await db.ref('customers').once('value');
                    
                    if (!snapshot.exists()) {
                        alert('ğŸ’¾ Keine Kunden im CRM gefunden!');
                        return;
                    }
                    
                    // Filter in JavaScript - case-insensitive & Teilstring
                    const searchLower = customerName.toLowerCase();
                    const matches = [];
                    
                    snapshot.forEach(child => {
                        const customer = child.val();
                        const nameLower = (customer.name || '').toLowerCase();
                        
                        // PrÃ¼fe ob Name den Suchbegriff enthÃ¤lt
                        if (nameLower.includes(searchLower)) {
                            matches.push({
                                id: child.key,
                                name: customer.name,
                                phone: customer.phone
                            });
                        }
                    });
                    
                    console.log(`ğŸ” ${matches.length} Treffer gefunden:`, matches);
                    
                    if (matches.length === 0) {
                        alert(`ğŸ’¾ Kunde "${customerName}" nicht gefunden!\n\nBitte erst im CRM (Admin-Bereich) anlegen.`);
                        return;
                    }
                    
                    if (matches.length === 1) {
                        // Genau 1 Treffer â†’ direkt Ã¶ffnen
                        customerId = matches[0].id;
                        console.log('âœ… 1 Treffer gefunden:', matches[0].name);
                    } else {
                        // Mehrere Treffer â†’ User fragen
                        let message = `ğŸ” ${matches.length} Kunden gefunden:\n\n`;
                        matches.forEach((m, i) => {
                            message += `${i + 1}. ${m.name}`;
                            if (m.phone) message += ` (${m.phone})`;
                            message += '\n';
                        });
                        message += '\nÃ–ffne ersten Kunden...';
                        
                        alert(message);
                        customerId = matches[0].id;
                        console.log('âœ… Mehrere Treffer - nehme ersten:', matches[0].name);
                    }
                    
                    console.log('âœ… Kunde gefunden:', customerId);
                    
                } catch (error) {
                    console.error('ğŸ’¾ Fehler bei Suche:', error);
                    alert('ğŸ’¾ Fehler beim Suchen: ' + error.message);
                    return;
                }
            }
            
            // 3. Ã–ffne Edit-Modal
            if (customerId) {
                console.log('ğŸ“ Ã–ffne Edit-Modal fÃ¼r:', customerId);
                await editCustomer(customerId);
            } else {
                alert('ğŸ’¾ Kunde konnte nicht gefunden werden!');
            }
        }
        
        // ğŸ†• v5.90.149: Ã–FFNE KUNDEN-BEARBEITUNG AUS RECHNUNGS-LISTE
        async function openCustomerEditFromInvoiceList(customerId, customerName, invoiceId) {
            console.log('âœï¸ v5.90.149: Ã–ffne CRM aus Rechnungs-Liste');
            console.log('   Customer ID:', customerId);
            console.log('   Customer Name:', customerName);
            console.log('   Invoice ID:', invoiceId);
            
            // 1. PrÃ¼fe ob Customer ID vorhanden
            if (customerId && customerId !== '') {
                console.log('âœ… Customer ID vorhanden:', customerId);
                await editCustomer(customerId);
                return;
            }
            
            // 2. Suche nach Name
            if (!customerName || customerName.trim() === '') {
                alert('ğŸ’¾ Kein Kundenname gefunden!\n\nBitte erst im CRM anlegen.');
                return;
            }
            
            console.log('ğŸ” Suche Kunde nach Name:', customerName);
            
            // ğŸ†• v5.90.153: BESSERE SUCHE!
            try {
                // Lade ALLE Kunden
                const snapshot = await db.ref('customers').once('value');
                
                if (!snapshot.exists()) {
                    alert('ğŸ’¾ Keine Kunden im CRM!');
                    return;
                }
                
                // Filter - case-insensitive & Teilstring
                const searchLower = customerName.toLowerCase();
                const matches = [];
                
                snapshot.forEach(child => {
                    const customer = child.val();
                    const nameLower = (customer.name || '').toLowerCase();
                    
                    if (nameLower.includes(searchLower)) {
                        matches.push({
                            id: child.key,
                            name: customer.name,
                            phone: customer.phone
                        });
                    }
                });
                
                if (matches.length === 0) {
                    alert(`ğŸ’¾ Kunde "${customerName}" nicht im CRM gefunden!\n\nBitte erst im Admin-Bereich anlegen.`);
                    return;
                }
                
                const foundId = matches[0].id;
                console.log(`âœ… ${matches.length} Treffer - nehme ersten:`, matches[0].name);
                
                if (foundId) {
                    console.log('âœ… Kunde gefunden:', foundId);
                    await editCustomer(foundId);
                } else {
                    alert('ğŸ’¾ Kunde konnte nicht gefunden werden!');
                }
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler bei Suche:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // ğŸ†• v5.90.149: Ã–FFNE KUNDEN-BEARBEITUNG AUS KALENDER
        async function openCustomerEditFromCalendar(customerId, customerName, rideId) {
            console.log('âœï¸ v5.90.149: Ã–ffne CRM aus Kalender');
            console.log('   Customer ID:', customerId);
            console.log('   Customer Name:', customerName);
            console.log('   Ride ID:', rideId);
            
            // 1. PrÃ¼fe ob Customer ID vorhanden
            if (customerId && customerId !== '') {
                console.log('âœ… Customer ID vorhanden:', customerId);
                await editCustomer(customerId);
                return;
            }
            
            // 2. Suche nach Name
            if (!customerName || customerName.trim() === '') {
                alert('ğŸ’¾ Kein Kundenname gefunden!\n\nBitte erst im CRM anlegen.');
                return;
            }
            
            console.log('ğŸ” Suche Kunde nach Name:', customerName);
            
            // ğŸ†• v5.90.153: BESSERE SUCHE!
            try {
                // Lade ALLE Kunden
                const snapshot = await db.ref('customers').once('value');
                
                if (!snapshot.exists()) {
                    alert('ğŸ’¾ Keine Kunden im CRM!');
                    return;
                }
                
                // Filter - case-insensitive & Teilstring
                const searchLower = customerName.toLowerCase();
                const matches = [];
                
                snapshot.forEach(child => {
                    const customer = child.val();
                    const nameLower = (customer.name || '').toLowerCase();
                    
                    if (nameLower.includes(searchLower)) {
                        matches.push({
                            id: child.key,
                            name: customer.name,
                            phone: customer.phone
                        });
                    }
                });
                
                if (matches.length === 0) {
                    alert(`ğŸ’¾ Kunde "${customerName}" nicht im CRM gefunden!\n\nBitte erst im Admin-Bereich anlegen.`);
                    return;
                }
                
                const foundId = matches[0].id;
                console.log(`âœ… ${matches.length} Treffer - nehme ersten:`, matches[0].name);
                
                if (foundId) {
                    console.log('âœ… Kunde gefunden:', foundId);
                    await editCustomer(foundId);
                } else {
                    alert('ğŸ’¾ Kunde konnte nicht gefunden werden!');
                }
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler bei Suche:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // ğŸ†• v5.90.24: LEERE RECHNUNG ERSTELLEN (ohne Fahrt)
        async function openInvoiceModalEmpty() {
            console.log('ğŸ“± Ã–ffne leeres Rechnungsmodal');
            
            try {
                // ğŸ†• Leere globale Daten
                invoiceRideData = null;
                invoiceCustomerData = null;
                invoiceSelectedBillingAddress = '';
                
                // ğŸ†• v5.90.306: Initialisiere leere Position MIT MwSt
                invoicePositions = [
                    {
                        id: 1,
                        description: '',
                        amount: 0,
                        vatRate: 7 // ğŸ†• Standard 7%
                    }
                ];
                
                // Leere Werte
                const customerName = '';
                const customerAddress = '';
                const guestName = '';
                const rideDate = new Date().toLocaleDateString('de-DE');
                const rideTime = new Date().toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
                const pickup = '';
                const destination = '';
                const distance = 0;
                
                const modal = document.createElement('div');
                modal.id = 'invoice-modal';
                modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:99999;padding:20px;';
                
                modal.innerHTML = `
                    <div style="background:white;border-radius:16px;max-width:800px;width:100%;max-height:90vh;overflow-y:auto;">
                        <div style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;padding:20px;border-radius:16px 16px 0 0;position:sticky;top:0;z-index:10;">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <h3 style="margin:0;font-size:20px;">ğŸ“± Neue Rechnung erstellen (leer)</h3>
                                <button onclick="closeInvoiceModal()" 
                                    style="background:rgba(255,255,255,0.2);border:none;color:white;font-size:24px;width:32px;height:32px;border-radius:50%;cursor:pointer;">Ã—</button>
                            </div>
                        </div>
                        
                        <div style="padding:20px;">
                            <!-- ğŸ†• BEARBEITBARE FELDER -->
                            <div style="background:#f0f9ff;border:2px solid #3b82f6;padding:15px;border-radius:10px;margin-bottom:20px;">
                                <div style="font-weight:700;margin-bottom:15px;color:#1e40af;">âœï¸ Rechnungsdaten</div>
                                
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                                    <div>
                                        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">Kundenname:</label>
                                        <div style="display:flex;gap:8px;">
                                            <input type="text" id="inv-customer-name" value=""
                                                   style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;" placeholder="Name eingeben">
                                            <button onclick="openCustomerEditFromInvoice()" 
                                                    style="padding:10px 16px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;white-space:nowrap;font-size:13px;"
                                                    title="Kunde im CRM bearbeiten">
                                                âœï¸ CRM
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">Gastname (optional):</label>
                                        <input type="text" id="inv-guest-name" value=""
                                               style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;" placeholder="Optional">
                                    </div>
                                </div>
                                
                                <div style="margin-top:10px;">
                                    <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">Rechnungsadresse:</label>
                                    <textarea id="inv-address" rows="2" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;resize:vertical;" placeholder="StraÃŸe, PLZ Ort"></textarea>
                                </div>
                                
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:10px;">
                                    <div>
                                        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">Von:</label>
                                        <input type="text" id="inv-pickup" value=""
                                               style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;" placeholder="Startort">
                                    </div>
                                    <div>
                                        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">Nach:</label>
                                        <input type="text" id="inv-destination" value=""
                                               style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;" placeholder="Zielort">
                                    </div>
                                </div>
                                
                                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;margin-top:10px;">
                                    <div>
                                        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">ğŸ“… Datum:</label>
                                        <input type="date" id="inv-date" value="${getLocalDateString()}"
                                               style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
                                    </div>
                                    <div>
                                        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">ğŸ• Uhrzeit:</label>
                                        <input type="time" id="inv-time" value="${new Date().toTimeString().split(' ')[0].slice(0,5)}"
                                               style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
                                    </div>
                                    <div>
                                        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">ğŸ“ Distanz (km):</label>
                                        <div style="display:flex;gap:5px;">
                                            <input type="number" id="invoice-distance" value="0.0" step="0.1" min="0"
                                                   onchange="updateInvoiceDistanceAndVat()"
                                                   style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
                                            <button onclick="recalculateInvoiceDistance()" title="Distanz neu berechnen"
                                                    style="padding:10px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer;white-space:nowrap;">
                                                ğŸ”„
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                                
                                <!-- ğŸ†• v5.90.176: LIEFERDATUM & LIEFERZEITRAUM -->
                                <div style="background:#f0f9ff;border:2px solid #3b82f6;padding:12px;border-radius:8px;margin-bottom:15px;">
                                    <div style="font-weight:600;margin-bottom:10px;color:#1e40af;">ğŸ“¦ Lieferung (optional)</div>
                                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
                                        <div>
                                            <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">ğŸ“… Lieferdatum:</label>
                                            <input type="date" id="inv-delivery-date" 
                                                   style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
                                            <div style="font-size:10px;color:#6b7280;margin-top:2px;">
                                                ğŸ’¡ Auch Vergangenheit mÃ¶glich
                                            </div>
                                        </div>
                                        <div>
                                            <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">ğŸ• Von:</label>
                                            <input type="time" id="inv-delivery-from" 
                                                   style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
                                        </div>
                                        <div>
                                            <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">ğŸ• Bis:</label>
                                            <input type="time" id="inv-delivery-to" 
                                                   style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
                                        </div>
                                    </div>
                                </div>
                            
                            <!-- ğŸ†• CHECKBOXEN: WAS SOLL AUF DIE RECHNUNG? -->
                            <div style="background:#fefce8;border:2px solid #eab308;padding:15px;border-radius:10px;margin-bottom:20px;">
                                <div style="font-weight:700;margin-bottom:15px;color:#854d0e;">ğŸ“‹ Was soll auf die Rechnung?</div>
                                
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:white;border-radius:6px;">
                                        <input type="checkbox" id="inv-show-customer" checked style="width:18px;height:18px;">
                                        <span>ğŸ’¾ Kundenname</span>
                                    </label>
                                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:white;border-radius:6px;">
                                        <input type="checkbox" id="inv-show-address" checked style="width:18px;height:18px;">
                                        <span>ğŸ“ Adresse</span>
                                    </label>
                                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:white;border-radius:6px;">
                                        <input type="checkbox" id="inv-show-guest" style="width:18px;height:18px;">
                                        <span>ğŸ“ Gastname</span>
                                    </label>
                                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:white;border-radius:6px;">
                                        <input type="checkbox" id="inv-show-route" checked style="width:18px;height:18px;">
                                        <span>ğŸš• Von/Nach</span>
                                    </label>
                                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:white;border-radius:6px;">
                                        <input type="checkbox" id="inv-show-datetime" checked style="width:18px;height:18px;">
                                        <span>ğŸ“… Datum/Uhrzeit</span>
                                    </label>
                                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:white;border-radius:6px;">
                                        <input type="checkbox" id="inv-show-distance" style="width:18px;height:18px;">
                                        <span>ğŸ“ Distanz (km)</span>
                                    </label>
                                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:white;border-radius:6px;">
                                        <input type="checkbox" id="inv-show-vat" checked style="width:18px;height:18px;">
                                        <span>ğŸ’¶ MwSt-Ausweis</span>
                                    </label>
                                </div>
                                
                                <div style="margin-top:15px;padding:10px;background:#dcfce7;border-radius:6px;font-size:13px;color:#166534;">
                                    ğŸ”’ <strong>Immer dabei:</strong> Rechnungsnummer, Datum, Bankdaten, Steuernummer
                                </div>
                            </div>
                            
                            <!-- POSITIONEN -->
                            <div style="background:#f0fdf4;border:2px solid #10b981;padding:15px;border-radius:10px;margin-bottom:20px;">
                                <div style="font-weight:700;margin-bottom:15px;color:#048257;">ğŸ’° Positionen (Brutto-BetrÃ¤ge)</div>
                                
                                <div id="invoice-positions-container"></div>
                                
                                <button onclick="addInvoicePosition()" 
                                        style="width:100%;padding:10px;margin-top:10px;background:#10b981;color:white;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.3s;"
                                        onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                                    + Position hinzufÃ¼gen
                                </button>
                                
                                <div style="margin-top:15px;padding-top:15px;border-top:2px solid #e0e0e0;">
                                    <div style="display:flex;justify-content:space-between;align-items:center;">
                                        <span style="font-weight:600;font-size:15px;">Gesamt (Brutto):</span>
                                        <span id="invoice-total" style="font-weight:700;font-size:20px;color:#10b981;">0.00 â‚¬</span>
                                    </div>
                                    <div id="invoice-vat-display" style="margin-top:10px;padding:10px;background:#f3f4f6;border-radius:6px;font-size:13px;"></div>
                                </div>
                            </div>
                            
                            <!-- ğŸ†• v5.90.7: ZAHLUNGSART -->
                            <div style="background:#fef3c7;border:2px solid #fbbf24;padding:15px;border-radius:10px;margin-bottom:20px;">
                                <label style="display:block;font-weight:700;margin-bottom:10px;color:#92400e;">ğŸ’³ Zahlungsart</label>
                                <select id="invoice-payment-method" style="width:100%;padding:12px;border:2px solid #fbbf24;border-radius:8px;font-size:14px;cursor:pointer;">
                                    <option value="rechnung" selected>ğŸ“± Rechnung (Standard)</option>
                                    <option value="bar">ğŸ’¶ Bar bezahlt</option>
                                    <option value="ec">ğŸ’³ EC-Karte</option>
                                    <option value="kreditkarte">ğŸ’³ Kreditkarte</option>
                                </select>
                            </div>
                            
                            <!-- BUTTONS -->
                            <input type="hidden" id="invoice-ride-id" value="">
                            <input type="hidden" id="invoice-vat-rate" value="7">
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
                                <button onclick="generateInvoicePDFv2()" 
                                        style="padding:15px;background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-size:15px;box-shadow:0 4px 12px rgba(139,92,246,0.3);">
                                    ğŸ“± PDF erstellen
                                </button>
                                <button onclick="generateAndEmailInvoice()" 
                                        style="padding:15px;background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-size:15px;box-shadow:0 4px 12px rgba(59,130,246,0.3);">
                                    ğŸ“§ Per E-Mail
                                </button>
                                <button onclick="shareInvoiceViaWhatsApp()" 
                                        style="padding:15px;background:#25D366;color:white;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-size:15px;box-shadow:0 4px 12px rgba(37,211,102,0.3);">
                                    ğŸ“¤ WhatsApp
                                </button>
                            </div>
                            
                            <button onclick="closeInvoiceModal()" 
                                    style="width:100%;padding:12px;background:#6b7280;color:white;border:none;border-radius:8px;margin-top:10px;cursor:pointer;">
                                Abbrechen
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Rendere Positionen initial
                renderInvoicePositions();
                updateInvoiceCalculation();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Ã–ffnen des leeren Rechnungsmodals:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // ğŸ†• v5.90.14: RECHNUNG PER WHATSAPP TEILEN
        // ğŸ†• v5.90.307: WHATSAPP MIT PDF-LINK!
        async function shareInvoiceViaWhatsApp() {
            // Rufe neue Funktion auf!
            await generateInvoicePDFAndSendWhatsApp();
        }
        
        // ğŸ†• v5.90.14: RECHNUNG TEILEN (MIT PDF)
        async function shareInvoiceWithPDF() {
            try {
                console.log('ğŸ“¤ Starte Share mit PDF...');
                
                const rideId = document.getElementById('invoice-ride-id')?.value;
                if (!rideId) {
                    alert('ğŸ’¾ Keine Fahrt ausgewÃ¤hlt!');
                    return;
                }
                
                // Zeige Loading
                showToast('â³ Erstelle PDF...', 'info');
                
                // Erstelle PDF (nutze bestehende Funktion)
                await generateInvoicePDFv2();
                
                showToast('âœ… PDF erstellt! Jetzt per WhatsApp senden...', 'success');
                
                // Nach kurzer VerzÃ¶gerung WhatsApp Ã¶ffnen
                setTimeout(() => {
                    shareInvoiceViaWhatsApp();
                }, 1000);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // ğŸ†• v5.90.15: BESTEHENDE RECHNUNG PER WHATSAPP TEILEN
        async function shareExistingInvoiceViaWhatsApp(invoiceId) {
            try {
                console.log('ğŸ“¤ Teile bestehende Rechnung:', invoiceId);
                
                // Lade Rechnung aus Firebase
                const invSnapshot = await db.ref(`invoices/${invoiceId}`).once('value');
                const invoice = invSnapshot.val();
                
                if (!invoice) {
                    alert('ğŸ’¾ Rechnung nicht gefunden!');
                    return;
                }
                
                // Lade zugehÃ¶rige Fahrt (wenn vorhanden)
                let customerPhone = null;
                let customerName = invoice.customerName || 'Kunde';
                
                if (invoice.rideId) {
                    const rideSnapshot = await db.ref(`rides/${invoice.rideId}`).once('value');
                    const ride = rideSnapshot.val();
                    
                    if (ride) {
                        customerPhone = ride.customerPhone;
                        if (!customerName || customerName === 'Kunde') {
                            customerName = ride.customerName || 'Kunde';
                        }
                    }
                }
                
                // Versuche Customer aus CRM
                if (!customerPhone && invoice.customerId) {
                    const custSnapshot = await db.ref(`customers/${invoice.customerId}`).once('value');
                    const customer = custSnapshot.val();
                    if (customer) {
                        customerPhone = customer.phone;
                        if (!customerName || customerName === 'Kunde') {
                            customerName = customer.name;
                        }
                    }
                }
                
                if (!customerPhone) {
                    const input = prompt('âš ï¸ Keine Telefonnummer gespeichert!\n\nBitte Telefonnummer eingeben:');
                    if (!input) return;
                    customerPhone = input;
                }
                
                // Normalisiere Phone
                const normalizedPhone = normalizePhoneNumber(customerPhone);
                const whatsappPhone = normalizedPhone.replace(/[^0-9]/g, '');
                
                console.log('ğŸ“± WhatsApp Phone:', whatsappPhone);
                
                // Erstelle Nachricht
                const invoiceNumber = invoice.invoiceNumber || invoiceId;
                const amount = invoice.totalGross || 0;
                
                const message = `Hallo ${customerName},\n\nhier ist Ihre Rechnung ${invoiceNumber} Ã¼ber ${amount.toFixed(2)}â‚¬.\n\nVielen Dank fÃ¼r Ihre Fahrt! ğŸš•\n\nMit freundlichen GrÃ¼ÃŸen\nFunk Taxi Heringsdorf`;
                
                const url = `https://wa.me/${whatsappPhone}?text=${encodeURIComponent(message)}`;
                
                window.open(url, '_blank');
                
                showToast('ğŸ’¬ WhatsApp geÃ¶ffnet! PDF bitte manuell anhÃ¤ngen.', 'success', 4000);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // ğŸ†• v5.90.15: RECHNUNG VIA RIDE TEILEN
        async function shareRideInvoiceViaWhatsApp(rideId) {
            try {
                console.log('ğŸ“¤ Teile Rechnung fÃ¼r Fahrt:', rideId);
                
                // Lade Fahrt
                const rideSnapshot = await db.ref(`rides/${rideId}`).once('value');
                const ride = rideSnapshot.val();
                
                if (!ride) {
                    alert('ğŸ’¾ Fahrt nicht gefunden!');
                    return;
                }
                
                if (!ride.invoiceNumber) {
                    alert('ğŸ’¾ Keine Rechnung fÃ¼r diese Fahrt vorhanden!');
                    return;
                }
                
                // Nutze invoiceNumber um Rechnung zu teilen
                await shareExistingInvoiceViaWhatsApp(ride.invoiceNumber);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // ğŸ†• v5.52.4: Rendere Positionen-Liste
        function renderInvoicePositions() {
            const container = document.getElementById('invoice-positions-container');
            if (!container) return;
            
            container.innerHTML = invoicePositions.map((pos, index) => `
                <div style="display:grid;grid-template-columns:1fr 120px 100px 40px;gap:10px;margin-bottom:10px;align-items:center;">
                    <input type="text" 
                           value="${pos.description}" 
                           onchange="updateInvoicePositionDescription(${index}, this.value)"
                           placeholder="Beschreibung (z.B. Trinkgeld)"
                           style="padding:8px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;">
                    <input type="number" 
                           value="${pos.amount.toFixed(2)}" 
                           onchange="updateInvoicePositionAmount(${index}, this.value)"
                           step="0.01" 
                           min="0"
                           placeholder="Betrag"
                           style="padding:8px;border:2px solid #10b981;border-radius:8px;font-size:14px;font-weight:600;">
                    <select onchange="updateInvoicePositionVat(${index}, this.value)"
                            style="padding:8px;border:2px solid #3b82f6;border-radius:8px;font-size:13px;font-weight:600;background:white;cursor:pointer;">
                        <option value="0" ${pos.vatRate === 0 ? 'selected' : ''}>0% MwSt</option>
                        <option value="7" ${pos.vatRate === 7 ? 'selected' : ''}>7% MwSt</option>
                        <option value="19" ${pos.vatRate === 19 ? 'selected' : ''}>19% MwSt</option>
                    </select>
                    ${index > 0 ? `
                        <button onclick="removeInvoicePosition(${index})" 
                                style="padding:8px;background:#ef4444;color:white;border:none;border-radius:8px;cursor:pointer;font-size:16px;">
                            ğŸ—‘ï¸
                        </button>
                    ` : `<div></div>`}
                </div>
            `).join('');
            
            updateInvoiceCalculation();
        }
        
        // ğŸ†• v5.52.4: Position hinzufÃ¼gen
        function addInvoicePosition() {
            const nextId = Math.max(...invoicePositions.map(p => p.id), 0) + 1;
            invoicePositions.push({
                id: nextId,
                description: '',
                amount: 0,
                vatRate: 7 // ğŸ†• v5.90.306: Standard 7%
            });
            renderInvoicePositions();
        }
        
        // ğŸ†• v5.52.4: Position entfernen
        function removeInvoicePosition(index) {
            invoicePositions.splice(index, 1);
            renderInvoicePositions();
        }
        
        // ğŸ†• v5.52.4: Position-Betrag Ã¤ndern
        function updateInvoicePositionAmount(index, value) {
            invoicePositions[index].amount = parseFloat(value) || 0;
            updateInvoiceCalculation();
        }
        
        // ğŸ†• v5.52.4: Position-Beschreibung Ã¤ndern
        function updateInvoicePositionDescription(index, value) {
            invoicePositions[index].description = value;
        }
        
        // ğŸ†• v5.90.306: Position-MwSt Ã¤ndern
        function updateInvoicePositionVat(index, value) {
            invoicePositions[index].vatRate = parseFloat(value) || 0;
            console.log('ğŸ’° Position', index, 'MwSt geÃ¤ndert:', value + '%');
            updateInvoiceCalculation();
        }
        
        // ğŸ†• v5.52.4: Distanz Ã¤ndern â†’ Auto-MwSt
        function updateInvoiceDistanceAndVat() {
            const distance = parseFloat(document.getElementById('invoice-distance').value) || 0;
            const vatSelect = document.getElementById('invoice-vat-rate');
            
            // Auto-MwSt basierend auf Distanz
            if (distance < 50) {
                vatSelect.value = '7';
            } else {
                vatSelect.value = '19';
            }
            
            updateInvoiceCalculation();
        }
        
        // ğŸ†• v5.90.306: NEUE Berechnung - Jede Position hat eigene MwSt!
        function updateInvoiceCalculation() {
            // Berechne fÃ¼r jede Position: Netto + MwSt
            let totalNet = 0;
            let totalVat = 0;
            let vatBreakdown = { 0: 0, 7: 0, 19: 0 }; // Aufteilung nach MwSt-Satz
            
            invoicePositions.forEach(pos => {
                const gross = parseFloat(pos.amount) || 0;
                const vatRate = parseFloat(pos.vatRate) || 0;
                
                // RÃœCKWÃ„RTS: Brutto â†’ Netto + MwSt
                const net = gross / (1 + (vatRate / 100));
                const vat = gross - net;
                
                totalNet += net;
                totalVat += vat;
                
                // Aufteilung sammeln
                if (vatRate === 0 || vatRate === 7 || vatRate === 19) {
                    vatBreakdown[vatRate] += vat;
                }
                
                console.log(`ğŸ’° Position "${pos.description}": ${gross.toFixed(2)}â‚¬ brutto (${net.toFixed(2)}â‚¬ netto + ${vat.toFixed(2)}â‚¬ MwSt ${vatRate}%)`);
            });
            
            const totalGross = totalNet + totalVat;
            
            // ğŸ†• v5.90.306: UPDATE UI mit Gesamt-Werten
            const grossEl = document.getElementById('invoice-gross-total');
            const netEl = document.getElementById('invoice-net-display');
            const vatEl = document.getElementById('invoice-vat-display');
            const vatRateEl = document.getElementById('invoice-vat-rate-display');
            const totalEl = document.getElementById('invoice-total');
            
            if (grossEl) grossEl.textContent = totalGross.toFixed(2) + 'â‚¬';
            if (netEl) netEl.textContent = totalNet.toFixed(2) + 'â‚¬';
            if (vatEl) {
                // Zeige MwSt-Aufteilung
                const vatParts = [];
                if (vatBreakdown[0] > 0) vatParts.push(`${vatBreakdown[0].toFixed(2)}â‚¬ (0%)`);
                if (vatBreakdown[7] > 0) vatParts.push(`${vatBreakdown[7].toFixed(2)}â‚¬ (7%)`);
                if (vatBreakdown[19] > 0) vatParts.push(`${vatBreakdown[19].toFixed(2)}â‚¬ (19%)`);
                
                if (vatParts.length > 1) {
                    // Mehrere MwSt-SÃ¤tze
                    vatEl.innerHTML = `${totalVat.toFixed(2)}â‚¬<br><small style="font-size:11px;opacity:0.8;">${vatParts.join(' + ')}</small>`;
                } else {
                    // Nur ein MwSt-Satz
                    vatEl.textContent = totalVat.toFixed(2) + 'â‚¬';
                }
            }
            if (vatRateEl) {
                // Zeige "gemischt" wenn mehrere SÃ¤tze
                const uniqueRates = [...new Set(invoicePositions.map(p => p.vatRate))];
                if (uniqueRates.length > 1) {
                    vatRateEl.textContent = 'gemischt';
                } else {
                    vatRateEl.textContent = uniqueRates[0] || 0;
                }
            }
            if (totalEl) totalEl.textContent = totalGross.toFixed(2) + ' â‚¬';
            
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ’° RECHNUNG GESAMT:');
            console.log('   Netto:', totalNet.toFixed(2) + 'â‚¬');
            console.log('   MwSt 0%:', vatBreakdown[0].toFixed(2) + 'â‚¬');
            console.log('   MwSt 7%:', vatBreakdown[7].toFixed(2) + 'â‚¬');
            console.log('   MwSt 19%:', vatBreakdown[19].toFixed(2) + 'â‚¬');
            console.log('   MwSt Gesamt:', totalVat.toFixed(2) + 'â‚¬');
            console.log('   Brutto:', totalGross.toFixed(2) + 'â‚¬');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        }
        
        // ğŸ†• v5.90.10: DISTANZ NEU BERECHNEN
        async function recalculateInvoiceDistance() {
            try {
                const pickup = document.getElementById('inv-pickup').value.trim();
                const destination = document.getElementById('inv-destination').value.trim();
                
                if (!pickup || !destination) {
                    alert('ğŸ’¾ Bitte Von- und Nach-Adresse eingeben!');
                    return;
                }
                
                console.log('ğŸ”„ Berechne Distanz:', pickup, 'â†’', destination);
                
                // Zeige Loading
                const distanceInput = document.getElementById('invoice-distance');
                const oldValue = distanceInput.value;
                distanceInput.value = '...';
                distanceInput.disabled = true;
                
                // Berechne mit Google Maps
                const result = await calculateDistanceViaAPI(pickup, destination);
                
                if (result && result.distance) {
                    const distanceKm = result.distance / 1000;
                    distanceInput.value = distanceKm.toFixed(1);
                    distanceInput.disabled = false;
                    
                    // Update MwSt
                    updateInvoiceDistanceAndVat();
                    
                    showToast(`âœ… Distanz aktualisiert: ${distanceKm.toFixed(1)} km`, 'success');
                } else {
                    distanceInput.value = oldValue;
                    distanceInput.disabled = false;
                    alert('ğŸ’¾ Distanz konnte nicht berechnet werden. Bitte manuell eingeben.');
                }
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Berechnen:', error);
                document.getElementById('invoice-distance').disabled = false;
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        async function generateInvoicePDF() {
            try {
                // ğŸ†• v5.52.4: Hole Werte aus neuem System
                const rideId = document.getElementById('invoice-ride-id').value;
                const vatRate = parseFloat(document.getElementById('invoice-vat-rate').value) || 0;
                const distance = parseFloat(document.getElementById('invoice-distance').value) || 0;
                
                // Berechne aus Positionen
                const totalGross = invoicePositions.reduce((sum, pos) => sum + (parseFloat(pos.amount) || 0), 0);
                const netPrice = totalGross / (1 + (vatRate / 100));
                const vatAmount = totalGross - netPrice;
                
                const ride = invoiceRideData;
                const customer = invoiceCustomerData;
                
                if (!ride) {
                    alert('ğŸ’¾ Fahrt nicht gefunden!');
                    return;
                }
                
                // Hole nÃ¤chste Rechnungsnummer
                const invoiceNumber = await getNextInvoiceNumber();
                
                // ğŸ†• v5.90.549: invoiceDate MUSS definiert werden!
                const invoiceDate = new Date();
                
                console.log('ğŸ“± Erstelle PDF:', invoiceNumber);
                
                // Erstelle PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // HEADER - Firmendaten
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text('Taxiunternehmen Patrick Wydra', 20, 20);
                doc.text('Amselring 10', 20, 25);
                doc.text('17424 Ostseebad Heringsdorf', 20, 30);
                doc.text('Tel.: 038378/22022', 20, 35);
                
                // TITEL
                doc.setFontSize(20);
                doc.setTextColor(0);
                doc.setFont(undefined, 'bold');
                doc.text('Rechnung', 20, 50);
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Rechnungsnr.: ${invoiceNumber}`, 20, 58);
                doc.text(`Datum: ${invoiceDate.toLocaleDateString('de-DE')}`, 20, 63);
                
                // KUNDE
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('Kunde:', 20, 80);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                
                let yPos = 86;
                doc.text(ride.customerName || customer?.name || 'Unbekannt', 20, yPos);
                
                // ğŸ†• v5.52.5: Nutze gewÃ¤hlte Rechnungsadresse
                if (invoiceSelectedBillingAddress) {
                    yPos += 5;
                    const addressLines = doc.splitTextToSize(invoiceSelectedBillingAddress, 80);
                    doc.text(addressLines, 20, yPos);
                    yPos += addressLines.length * 5;
                } else if (customer?.billingAddress) {
                    // Fallback: alte einzelne Adresse
                    yPos += 5;
                    const addressLines = doc.splitTextToSize(customer.billingAddress, 80);
                    doc.text(addressLines, 20, yPos);
                    yPos += addressLines.length * 5;
                } else if (customer?.address) {
                    yPos += 5;
                    const addressLines = doc.splitTextToSize(customer.address, 80);
                    doc.text(addressLines, 20, yPos);
                    yPos += addressLines.length * 5;
                }
                
                // ğŸ†• v5.87.89: GASTNAME (fÃ¼r Hotel-Fahrten)
                if (ride.guestName) {
                    yPos += 8;
                    doc.setFont(undefined, 'bold');
                    doc.text('Gastname:', 20, yPos);
                    doc.setFont(undefined, 'normal');
                    yPos += 5;
                    doc.text(ride.guestName, 20, yPos);
                }
                
                // FAHRTDETAILS
                yPos += 10;
                doc.setFont(undefined, 'bold');
                doc.text('Fahrtdetails:', 20, yPos);
                doc.setFont(undefined, 'normal');
                
                yPos += 6;
                doc.text(`Datum: ${new Date(ride.pickupTimestamp || ride.createdAt).toLocaleDateString('de-DE')}`, 20, yPos);
                yPos += 5;
                doc.text(`Uhrzeit: ${new Date(ride.pickupTimestamp || ride.createdAt).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})}`, 20, yPos);
                yPos += 5;
                doc.text(`Von: ${ride.pickup || 'Unbekannt'}`, 20, yPos);
                yPos += 5;
                doc.text(`Nach: ${ride.destination || 'Unbekannt'}`, 20, yPos);
                yPos += 5;
                doc.text(`Distanz: ${distance.toFixed(1)} km`, 20, yPos);
                
                // ğŸ†• v5.52.4: POSITIONEN-TABELLE
                yPos += 15;
                doc.setDrawColor(200);
                doc.line(20, yPos, 190, yPos);
                
                yPos += 8;
                doc.setFont(undefined, 'bold');
                doc.text('Pos.', 20, yPos);
                doc.text('Beschreibung', 40, yPos);
                doc.text('Betrag', 160, yPos, { align: 'right' });
                
                yPos += 2;
                doc.line(20, yPos, 190, yPos);
                
                yPos += 6;
                doc.setFont(undefined, 'normal');
                
                // Alle Positionen ausgeben
                invoicePositions.forEach((pos, index) => {
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.text(`${index + 1}`, 20, yPos);
                    const desc = pos.description || 'Position';
                    const descLines = doc.splitTextToSize(desc, 115);
                    doc.text(descLines, 40, yPos);
                    doc.text(`${pos.amount.toFixed(2)}â‚¬`, 160, yPos, { align: 'right' });
                    
                    yPos += Math.max(6, descLines.length * 5);
                });
                
                yPos += 4;
                doc.line(20, yPos, 190, yPos);
                
                yPos += 6;
                doc.text('Zwischensumme (netto):', 100, yPos);
                doc.text(`${netPrice.toFixed(2)}â‚¬`, 160, yPos, { align: 'right' });
                
                yPos += 6;
                doc.text(`Umsatzsteuer ${vatRate}%:`, 100, yPos);
                doc.text(`${vatAmount.toFixed(2)}â‚¬`, 160, yPos, { align: 'right' });
                
                yPos += 2;
                doc.setDrawColor(0);
                doc.line(100, yPos, 190, yPos);
                
                yPos += 6;
                doc.setFont(undefined, 'bold');
                doc.setFontSize(12);
                doc.text('Gesamtbetrag:', 100, yPos);
                doc.text(`${totalGross.toFixed(2)}â‚¬`, 160, yPos, { align: 'right' });
                
                // FOOTER - Bankdaten
                yPos += 20;
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(80);
                
                // Wenn zu nah am Ende â†’ neue Seite
                if (yPos > 260) {
                    doc.addPage();
                    yPos = 20;
                }
                
                // ğŸ†• v5.87.91: KOMPAKTES FOOTER-LAYOUT (nebeneinander)
                doc.setDrawColor(200);
                doc.line(20, yPos, 190, yPos);
                yPos += 5;
                
                doc.setFontSize(8);
                // Linke Spalte: Bankverbindung
                doc.text('Bankverbindung:', 20, yPos);
                doc.text('Volksbank Vorpommern', 20, yPos + 4);
                doc.text('IBAN: DE16 1309 1054 0001 5524 90', 20, yPos + 8);
                doc.text('BIC: GENODEF1HST', 20, yPos + 12);
                
                // Rechte Spalte: Steuerdaten
                doc.text('Steuernummer: 084 289/01178', 120, yPos);
                doc.text('IK: 601318664', 120, yPos + 4);
                
                yPos += 16;
                
                // ğŸ†• v5.52.4: Speichere in Firebase mit Positionen
                const invoiceData = {
                    invoiceNumber: invoiceNumber,
                    rideId: rideId,
                    customerName: ride.customerName || customer?.name || 'Unbekannt',
                    customerId: ride.customerId || null,
                    date: Date.now(),
                    positions: invoicePositions,
                    totalGross: totalGross,
                    netPrice: netPrice,
                    vatRate: vatRate,
                    vatAmount: vatAmount,
                    pickup: ride.pickup,
                    destination: ride.destination,
                    distance: distance
                };
                
                await db.ref(`invoices/${invoiceNumber}`).set(invoiceData);
                console.log('âœ… Rechnung in Firebase gespeichert:', invoiceNumber);
                
                // PDF herunterladen
                doc.save(`Rechnung_${invoiceNumber}_${new Date().toLocaleDateString('de-DE').replace(/\./g, '_')}.pdf`);
                
                alert(`âœ… Rechnung ${invoiceNumber} erstellt und heruntergeladen!`);
                
                closeInvoiceModal();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Erstellen der Rechnung:', error);
                alert('ğŸ’¾ Fehler beim Erstellen der Rechnung: ' + error.message);
            }
        }
        
        // ğŸ†• v5.87.90: NEUE FLEXIBLE PDF-GENERIERUNG MIT CHECKBOXEN
        // ğŸ†• v5.90.152: RECHNUNG ERSTELLEN UND PER E-MAIL VERSENDEN!
        async function generateAndEmailInvoice() {
            try {
                console.log('ğŸ“§ v5.90.152: Erstelle Rechnung und versende per E-Mail...');
                
                // 1. Erst Rechnung erstellen (wie generateInvoicePDFv2)
                const rideId = document.getElementById('invoice-ride-id').value;
                const vatRate = parseFloat(document.getElementById('invoice-vat-rate').value) || 7;
                
                // Hole Werte aus bearbeitbaren Feldern
                const customerName = document.getElementById('inv-customer-name').value.trim();
                const guestName = document.getElementById('inv-guest-name').value.trim();
                const address = document.getElementById('inv-address').value.trim();
                const pickup = document.getElementById('inv-pickup').value.trim();
                const destination = document.getElementById('inv-destination').value.trim();
                const rideDate = document.getElementById('inv-date').value.trim();
                const rideTime = document.getElementById('inv-time').value.trim();
                const distance = parseFloat(document.getElementById('invoice-distance').value) || 0;
                
                // Checkboxes
                const showCustomer = document.getElementById('inv-show-customer').checked;
                const showAddress = document.getElementById('inv-show-address').checked;
                const showGuest = document.getElementById('inv-show-guest').checked;
                const showRoute = document.getElementById('inv-show-route').checked;
                const showDateTime = document.getElementById('inv-show-datetime').checked;
                const showDistance = document.getElementById('inv-show-distance').checked;
                const showVat = document.getElementById('inv-show-vat').checked;
                
                const paymentMethod = document.getElementById('invoice-payment-method').value;
                
                // Berechne
                const totalGross = invoicePositions.reduce((sum, pos) => sum + (parseFloat(pos.amount) || 0), 0);
                const netPrice = totalGross / (1 + (vatRate / 100));
                const vatAmount = totalGross - netPrice;
                
                // Hole nÃ¤chste Rechnungsnummer
                const invoiceNumber = await getNextInvoiceNumber();
                
                // ğŸ†• v5.90.549: invoiceDate MUSS definiert werden!
                const invoiceDate = new Date();
                
                console.log('ğŸ“± Erstelle Rechnung:', invoiceNumber);
                
                // Speichere in Firebase
                const invoiceData = {
                    invoiceNumber: invoiceNumber,
                    rideId: rideId,
                    customerId: invoiceCustomerData?.id || invoiceRideData?.customerId || null,
                    customerEmail: invoiceCustomerData?.email || '',
                    customerName: customerName,
                    guestName: guestName,
                    address: address,
                    pickup: pickup,
                    destination: destination,
                    rideDate: rideDate,
                    rideTime: rideTime,
                    distance: distance,
                    positions: invoicePositions,
                    totalGross: totalGross,
                    netPrice: netPrice,
                    vatRate: vatRate,
                    vatAmount: vatAmount,
                    paymentMethod: paymentMethod,
                    displayOptions: {
                        showCustomer, showAddress, showGuest,
                        showRoute, showDateTime, showDistance, showVat
                    },
                    status: 'offen',
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };
                
                await db.ref(`invoices/${invoiceNumber}`).set(invoiceData);
                console.log('âœ… Rechnung in Firebase gespeichert:', invoiceNumber);
                
                // VerknÃ¼pfe mit Fahrt
                if (rideId) {
                    await db.ref(`rides/${rideId}`).update({
                        invoiceNumber: invoiceNumber,
                        invoiceAmount: totalGross,
                        invoiceCreatedAt: Date.now()
                    });
                }
                
                // Log
                logActivity('admin', 'invoice_created', `Rechnung ${invoiceNumber} erstellt (und per E-Mail versendet)`, {
                    customer: customerName,
                    amount: totalGross
                });
                
                // 2. Jetzt per E-Mail versenden!
                showToast('âœ… Rechnung erstellt! Ã–ffne E-Mail...', 'success');
                
                // Warte kurz damit User die Toast sieht
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Rufe E-Mail-Versand auf
                await sendSingleInvoiceViaEmail(invoiceNumber);
                
                // Modal schlieÃŸen
                closeInvoiceModal();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler beim Erstellen/Versenden: ' + error.message);
            }
        }
        
        // ğŸ†• v5.90.307: PDF ERSTELLEN & PER WHATSAPP VERSENDEN!
        async function generateInvoicePDFAndSendWhatsApp() {
            try {
                console.log('ğŸ“± v5.90.307: PDF erstellen & WhatsApp versenden');
                
                // 1. ERSTELLE PDF (wie gewohnt)
                const rideId = document.getElementById('invoice-ride-id').value;
                const distance = parseFloat(document.getElementById('invoice-distance').value) || 0;
                
                // ğŸ†• v5.90.306: Berechne aus Positionen mit eigener MwSt
                let totalNet = 0;
                let totalVat = 0;
                let vatBreakdown = { 0: 0, 7: 0, 19: 0 };
                
                invoicePositions.forEach(pos => {
                    const gross = parseFloat(pos.amount) || 0;
                    const vatRate = parseFloat(pos.vatRate) || 0;
                    const net = gross / (1 + (vatRate / 100));
                    const vat = gross - net;
                    totalNet += net;
                    totalVat += vat;
                    if (vatRate === 0 || vatRate === 7 || vatRate === 19) {
                        vatBreakdown[vatRate] += vat;
                    }
                });
                
                const totalGross = totalNet + totalVat;
                
                const ride = invoiceRideData;
                const customer = invoiceCustomerData;
                
                if (!ride && !customer) {
                    alert('ğŸ’¾ Keine Daten vorhanden!');
                    return;
                }
                
                // Hole Kundendaten
                const customerName = document.getElementById('inv-customer-name')?.value || ride?.customerName || customer?.name || 'Kunde';
                const customerPhone = customer?.phone || ride?.customerPhone || '';
                
                if (!customerPhone) {
                    alert('ğŸ’¾ Keine Telefonnummer vorhanden!\n\nBitte im CRM hinterlegen.');
                    return;
                }
                
                // Hole nÃ¤chste Rechnungsnummer
                const invoiceNumber = await getNextInvoiceNumber();
                
                // ğŸ†• v5.90.549: invoiceDate MUSS definiert werden!
                const invoiceDate = new Date();
                
                console.log('ğŸ“± Erstelle PDF:', invoiceNumber);
                showToast('ğŸ“± Erstelle PDF...', 'info');
                
                // Erstelle PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // HEADER
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text('Taxiunternehmen Patrick Wydra', 20, 20);
                doc.text('Amselring 10', 20, 25);
                doc.text('17424 Ostseebad Heringsdorf', 20, 30);
                doc.text('Tel.: 038378/22022', 20, 35);
                
                // TITEL
                doc.setFontSize(20);
                doc.setTextColor(0);
                doc.setFont(undefined, 'bold');
                doc.text('Rechnung', 20, 50);
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Rechnungsnr.: ${invoiceNumber}`, 20, 58);
                doc.text(`Datum: ${invoiceDate.toLocaleDateString('de-DE')}`, 20, 63);
                
                // KUNDE
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('Kunde:', 20, 80);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                
                let yPos = 86;
                doc.text(customerName, 20, yPos);
                
                if (invoiceSelectedBillingAddress) {
                    yPos += 5;
                    const addressLines = doc.splitTextToSize(invoiceSelectedBillingAddress, 80);
                    doc.text(addressLines, 20, yPos);
                    yPos += addressLines.length * 5;
                }
                
                // POSITIONEN
                yPos = Math.max(yPos, 120);
                doc.setFont(undefined, 'bold');
                doc.text('Positionen:', 20, yPos);
                yPos += 7;
                
                doc.setFont(undefined, 'normal');
                invoicePositions.forEach(pos => {
                    const vatText = pos.vatRate > 0 ? ` (${pos.vatRate}% MwSt)` : ' (0% MwSt)';
                    doc.text(`${pos.description}${vatText}`, 20, yPos);
                    doc.text(`${(pos.amount || 0).toFixed(2)} â‚¬`, 180, yPos, { align: 'right' });
                    yPos += 5;
                });
                
                // SUMMEN
                yPos += 5;
                doc.line(20, yPos, 190, yPos);
                yPos += 7;
                
                doc.text('Zwischensumme:', 20, yPos);
                doc.text(`${totalGross.toFixed(2)} â‚¬`, 180, yPos, { align: 'right' });
                yPos += 7;
                
                doc.text('Netto:', 20, yPos);
                doc.text(`${totalNet.toFixed(2)} â‚¬`, 180, yPos, { align: 'right' });
                yPos += 5;
                
                // MwSt-Aufteilung
                if (vatBreakdown[0] > 0) {
                    doc.text('MwSt 0%:', 20, yPos);
                    doc.text(`${vatBreakdown[0].toFixed(2)} â‚¬`, 180, yPos, { align: 'right' });
                    yPos += 5;
                }
                if (vatBreakdown[7] > 0) {
                    doc.text('MwSt 7%:', 20, yPos);
                    doc.text(`${vatBreakdown[7].toFixed(2)} â‚¬`, 180, yPos, { align: 'right' });
                    yPos += 5;
                }
                if (vatBreakdown[19] > 0) {
                    doc.text('MwSt 19%:', 20, yPos);
                    doc.text(`${vatBreakdown[19].toFixed(2)} â‚¬`, 180, yPos, { align: 'right' });
                    yPos += 5;
                }
                
                yPos += 2;
                doc.line(20, yPos, 190, yPos);
                yPos += 7;
                
                doc.setFont(undefined, 'bold');
                doc.setFontSize(12);
                doc.text('Gesamt:', 20, yPos);
                doc.text(`${totalGross.toFixed(2)} â‚¬`, 180, yPos, { align: 'right' });
                
                // FOOTER
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(100);
                doc.text('Steuernummer: 86/079/11816 | Zahlbar innerhalb 14 Tagen ohne Abzug', 20, 280);
                
                // 2. KONVERTIERE PDF ZU BLOB
                console.log('ğŸ’¾ Konvertiere PDF zu Blob...');
                const pdfBlob = doc.output('blob');
                
                // 3. UPLOAD ZU FIREBASE STORAGE
                console.log('â˜ï¸ Lade hoch zu Firebase Storage...');
                showToast('â˜ï¸ Lade PDF hoch...', 'info');
                
                const fileName = `rechnung-${invoiceNumber}.pdf`;
                const storageRef = window.firebaseStorage.ref(`invoices/${fileName}`);
                
                const uploadTask = await storageRef.put(pdfBlob, {
                    contentType: 'application/pdf',
                    customMetadata: {
                        invoiceNumber: invoiceNumber,
                        customerName: customerName,
                        amount: totalGross.toString(),
                        createdAt: new Date().toISOString()
                    }
                });
                
                console.log('âœ… PDF hochgeladen!');
                
                // 4. HOLE DOWNLOAD-URL
                const downloadURL = await storageRef.getDownloadURL();
                console.log('ğŸ”— Download-URL:', downloadURL);
                
                // 5. SPEICHERE RECHNUNG IN FIREBASE DB
                const invoiceData = {
                    invoiceNumber: invoiceNumber,
                    customerName: customerName,
                    customerPhone: customerPhone,
                    amount: totalGross,
                    netAmount: totalNet,
                    vatAmount: totalVat,
                    vatBreakdown: vatBreakdown,
                    positions: invoicePositions,
                    rideId: rideId,
                    distance: distance,
                    pdfUrl: downloadURL,  // â† WICHTIG!
                    pdfFileName: fileName,
                    status: 'offen',
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };
                
                await db.ref(`invoices/${invoiceNumber}`).set(invoiceData);
                console.log('âœ… Rechnung in DB gespeichert');
                
                // VerknÃ¼pfe mit Fahrt
                if (rideId) {
                    await db.ref(`rides/${rideId}`).update({
                        invoiceNumber: invoiceNumber,
                        invoiceAmount: totalGross,
                        invoicePdfUrl: downloadURL,
                        invoiceCreatedAt: Date.now()
                    });
                }
                
                // 6. Ã–FFNE WHATSAPP
                console.log('ğŸ“± Ã–ffne WhatsApp...');
                showToast('âœ… PDF erstellt! Ã–ffne WhatsApp...', 'success');
                
                const whatsappText = encodeURIComponent(
                    `Hallo ${customerName},\n\n` +
                    `hier ist Ihre Rechnung Nr. ${invoiceNumber} Ã¼ber ${totalGross.toFixed(2)} â‚¬:\n\n` +
                    `${downloadURL}\n\n` +
                    `Einfach auf den Link klicken zum Herunterladen.\n\n` +
                    `Vielen Dank!\n` +
                    `Taxi Patrick Wydra`
                );
                
                // Normalisiere Telefonnummer fÃ¼r WhatsApp (ohne +, Leerzeichen, etc.)
                const whatsappPhone = customerPhone.replace(/[\s\-\(\)]/g, '').replace(/^\+/, '');
                
                const whatsappUrl = `https://wa.me/${whatsappPhone}?text=${whatsappText}`;
                
                console.log('ğŸ“± WhatsApp URL:', whatsappUrl);
                
                // Ã–ffne WhatsApp in neuem Tab
                window.open(whatsappUrl, '_blank');
                
                // Log
                logActivity('admin', 'invoice_sent_whatsapp', `Rechnung ${invoiceNumber} per WhatsApp versendet`, {
                    customer: customerName,
                    phone: customerPhone,
                    amount: totalGross,
                    pdfUrl: downloadURL
                });
                
                // Modal schlieÃŸen
                setTimeout(() => closeInvoiceModal(), 1000);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler beim Erstellen/Versenden:\n\n' + error.message);
            }
        }
        
        async function generateInvoicePDFv2() {
            try {
                const rideId = document.getElementById('invoice-ride-id').value;
                const vatRate = parseFloat(document.getElementById('invoice-vat-rate').value) || 7;
                
                // ğŸ†• v5.90.542: PRÃœFE OB RECHNUNG SCHON EXISTIERT!
                if (rideId) {
                    const rideSnapshot = await db.ref(`rides/${rideId}`).once('value');
                    const rideData = rideSnapshot.val();
                    
                    if (rideData && rideData.invoiceNumber) {
                        const existingInvoiceNumber = rideData.invoiceNumber;
                        
                        // ğŸ†• v5.90.549: LADE RECHNUNG AUS FIREBASE!
                        const invoiceSnapshot = await db.ref(`invoices/${existingInvoiceNumber}`).once('value');
                        const existingInvoice = invoiceSnapshot.val();
                        
                        if (existingInvoice) {
                            console.log('âœ… Lade existierende Rechnung:', existingInvoiceNumber);
                            
                            // FÃœLLE FELDER MIT BESTEHENDEN DATEN!
                            document.getElementById('inv-customer-name').value = existingInvoice.customerName || '';
                            document.getElementById('inv-guest-name').value = existingInvoice.guestName || '';
                            document.getElementById('inv-address').value = existingInvoice.address || '';
                            document.getElementById('inv-pickup').value = existingInvoice.pickup || '';
                            document.getElementById('inv-destination').value = existingInvoice.destination || '';
                            document.getElementById('inv-date').value = existingInvoice.rideDate || '';
                            document.getElementById('inv-time').value = existingInvoice.rideTime || '';
                            document.getElementById('invoice-distance').value = existingInvoice.distance || 0;
                            document.getElementById('invoice-vat-rate').value = existingInvoice.vatRate || 7;
                            
                            // Lade Positionen
                            if (existingInvoice.positions && Array.isArray(existingInvoice.positions)) {
                                invoicePositions = existingInvoice.positions;
                                renderInvoicePositions();
                            }
                            
                            showToast('âœ… Rechnung geladen: ' + existingInvoiceNumber, 'success');
                            return; // STOPP - Modal ist jetzt gefÃ¼llt!
                        }
                        
                        // FALLBACK: Wenn Rechnung nicht in /invoices gefunden
                        const confirmed = confirm(
                            `âš ï¸ RECHNUNG EXISTIERT BEREITS!\n\n` +
                            `Rechnungsnummer: ${existingInvoiceNumber}\n` +
                            `Erstellt am: ${new Date(rideData.invoiceCreatedAt).toLocaleString('de-DE')}\n\n` +
                            `MÃ¶chtest du die Rechnung NEU ERSTELLEN?\n` +
                            `â†’ JA: Neue Rechnung mit GLEICHER Nummer\n` +
                            `â†’ NEIN: Abbrechen`
                        );
                        
                        if (!confirmed) {
                            console.log('ğŸ›‘ Rechnung-Erstellung abgebrochen (existiert bereits)');
                            return;
                        }
                        
                        // ğŸ†• v5.90.542: VERWENDE BESTEHENDE NUMMER!
                        console.log('ğŸ”„ Erstelle Rechnung NEU mit bestehender Nummer:', existingInvoiceNumber);
                    }
                }
                
                // Hole Werte aus bearbeitbaren Feldern
                const customerName = document.getElementById('inv-customer-name').value.trim();
                const guestName = document.getElementById('inv-guest-name').value.trim();
                const address = document.getElementById('inv-address').value.trim();
                const pickup = document.getElementById('inv-pickup').value.trim();
                const destination = document.getElementById('inv-destination').value.trim();
                const rideDate = document.getElementById('inv-date').value.trim();
                const rideTime = document.getElementById('inv-time').value.trim();
                const distance = parseFloat(document.getElementById('invoice-distance').value) || 0;
                
                // Hole Checkbox-Status
                const showCustomer = document.getElementById('inv-show-customer').checked;
                const showAddress = document.getElementById('inv-show-address').checked;
                const showGuest = document.getElementById('inv-show-guest').checked;
                const showRoute = document.getElementById('inv-show-route').checked;
                const showDateTime = document.getElementById('inv-show-datetime').checked;
                const showDistance = document.getElementById('inv-show-distance').checked;
                const showVat = document.getElementById('inv-show-vat').checked;
                
                // ğŸ†• v5.90.8: ZAHLUNGSART
                const paymentMethod = document.getElementById('invoice-payment-method').value;
                
                // Berechne aus Positionen
                const totalGross = invoicePositions.reduce((sum, pos) => sum + (parseFloat(pos.amount) || 0), 0);
                const netPrice = totalGross / (1 + (vatRate / 100));
                const vatAmount = totalGross - netPrice;
                
                // ğŸ†• v5.90.542: PRÃœFE OB RECHNUNG EXISTIERT â†’ NUTZE BESTEHENDE NUMMER!
                let invoiceNumber;
                let invoiceDate;
                
                if (rideId) {
                    const rideSnapshot = await db.ref(`rides/${rideId}`).once('value');
                    const rideData = rideSnapshot.val();
                    
                    if (rideData && rideData.invoiceNumber) {
                        // âœ… NUTZE BESTEHENDE NUMMER!
                        invoiceNumber = rideData.invoiceNumber;
                        invoiceDate = rideData.invoiceCreatedAt ? new Date(rideData.invoiceCreatedAt) : new Date();
                        console.log('ğŸ”„ v5.90.538: Verwende bestehende Nummer:', invoiceNumber);
                    } else {
                        // âœ… NEUE NUMMER!
                        invoiceNumber = await getNextInvoiceNumber();
                        invoiceDate = new Date();
                        console.log('ğŸ†• v5.90.538: Neue Rechnung-Nummer:', invoiceNumber);
                    }
                } else {
                    // Ohne rideId â†’ Neue Nummer
                    invoiceNumber = await getNextInvoiceNumber();
                    invoiceDate = new Date();
                }
                
                console.log('ğŸ“± Erstelle flexible PDF:', invoiceNumber);
                
                // Erstelle PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // HEADER - Firmendaten (IMMER)
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text('Taxiunternehmen Patrick Wydra', 20, 20);
                doc.text('Amselring 10', 20, 25);
                doc.text('17424 Ostseebad Heringsdorf', 20, 30);
                doc.text('Tel.: 038378/22022', 20, 35);
                
                // TITEL (IMMER)
                doc.setFontSize(20);
                doc.setTextColor(0);
                doc.setFont(undefined, 'bold');
                doc.text('Rechnung', 20, 50);
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Rechnungsnr.: ${invoiceNumber}`, 20, 58);
                doc.text(`Datum: ${invoiceDate.toLocaleDateString('de-DE')}`, 20, 63);
                
                let yPos = 75;
                
                // KUNDE (optional)
                if (showCustomer && customerName) {
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.text('Kunde:', 20, yPos);
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(10);
                    yPos += 6;
                    doc.text(customerName, 20, yPos);
                    yPos += 5;
                }
                
                // ADRESSE (optional)
                if (showAddress && address) {
                    const addressLines = doc.splitTextToSize(address, 80);
                    doc.text(addressLines, 20, yPos);
                    yPos += addressLines.length * 5;
                }
                
                // GASTNAME (optional)
                if (showGuest && guestName) {
                    yPos += 3;
                    doc.setFont(undefined, 'bold');
                    doc.text('Gastname:', 20, yPos);
                    doc.setFont(undefined, 'normal');
                    yPos += 5;
                    doc.text(guestName, 20, yPos);
                    yPos += 5;
                }
                
                // FAHRTDETAILS
                yPos += 5;
                let hasDetails = false;
                
                if (showDateTime || showRoute || showDistance) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Fahrtdetails:', 20, yPos);
                    doc.setFont(undefined, 'normal');
                    yPos += 6;
                    hasDetails = true;
                }
                
                if (showDateTime) {
                    doc.text(`Datum: ${rideDate}`, 20, yPos);
                    yPos += 5;
                    doc.text(`Uhrzeit: ${rideTime}`, 20, yPos);
                    yPos += 5;
                }
                
                if (showRoute) {
                    doc.text(`Von: ${pickup}`, 20, yPos);
                    yPos += 5;
                    doc.text(`Nach: ${destination}`, 20, yPos);
                    yPos += 5;
                }
                
                if (showDistance) {
                    doc.text(`Distanz: ${distance.toFixed(1)} km`, 20, yPos);
                    yPos += 5;
                }
                
                // ğŸ†• v5.90.176: LIEFERDATUM & LIEFERZEITRAUM
                const deliveryDate = document.getElementById('inv-delivery-date')?.value?.trim();
                const deliveryFrom = document.getElementById('inv-delivery-from')?.value?.trim();
                const deliveryTo = document.getElementById('inv-delivery-to')?.value?.trim();
                
                if (deliveryDate || deliveryFrom || deliveryTo) {
                    yPos += 3;
                    doc.setFont(undefined, 'bold');
                    doc.text('Lieferung:', 20, yPos);
                    doc.setFont(undefined, 'normal');
                    yPos += 5;
                    
                    if (deliveryDate) {
                        // Konvertiere YYYY-MM-DD zu DD.MM.YYYY
                        const [year, month, day] = deliveryDate.split('-');
                        const germanDate = `${day}.${month}.${year}`;
                        doc.text(`Datum: ${germanDate}`, 20, yPos);
                        yPos += 5;
                    }
                    
                    if (deliveryFrom && deliveryTo) {
                        doc.text(`Zeitraum: ${deliveryFrom} - ${deliveryTo} Uhr`, 20, yPos);
                        yPos += 5;
                    } else if (deliveryFrom) {
                        doc.text(`Ab: ${deliveryFrom} Uhr`, 20, yPos);
                        yPos += 5;
                    } else if (deliveryTo) {
                        doc.text(`Bis: ${deliveryTo} Uhr`, 20, yPos);
                        yPos += 5;
                    }
                }
                
                // POSITIONEN (IMMER)
                yPos += 10;
                doc.setDrawColor(200);
                doc.line(20, yPos, 190, yPos);
                
                yPos += 8;
                doc.setFont(undefined, 'bold');
                doc.text('Pos.', 20, yPos);
                doc.text('Beschreibung', 40, yPos);
                doc.text('Betrag', 160, yPos, { align: 'right' });
                
                yPos += 2;
                doc.line(20, yPos, 190, yPos);
                
                yPos += 6;
                doc.setFont(undefined, 'normal');
                
                invoicePositions.forEach((pos, index) => {
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.text(`${index + 1}`, 20, yPos);
                    const desc = pos.description || 'Position';
                    const descLines = doc.splitTextToSize(desc, 115);
                    doc.text(descLines, 40, yPos);
                    doc.text(`${parseFloat(pos.amount).toFixed(2)}â‚¬`, 160, yPos, { align: 'right' });
                    
                    yPos += Math.max(6, descLines.length * 5);
                });
                
                yPos += 4;
                doc.line(20, yPos, 190, yPos);
                
                // MWST (optional)
                if (showVat) {
                    yPos += 6;
                    doc.text('Zwischensumme (netto):', 100, yPos);
                    doc.text(`${netPrice.toFixed(2)}â‚¬`, 160, yPos, { align: 'right' });
                    
                    yPos += 6;
                    doc.text(`Umsatzsteuer ${vatRate}%:`, 100, yPos);
                    doc.text(`${vatAmount.toFixed(2)}â‚¬`, 160, yPos, { align: 'right' });
                    
                    yPos += 2;
                    doc.setDrawColor(0);
                    doc.line(100, yPos, 190, yPos);
                }
                
                // GESAMTBETRAG (IMMER)
                yPos += 6;
                doc.setFont(undefined, 'bold');
                doc.setFontSize(12);
                doc.text('Gesamtbetrag:', 100, yPos);
                doc.text(`${totalGross.toFixed(2)}â‚¬`, 160, yPos, { align: 'right' });
                
                // ğŸ†• v5.90.7: ZAHLUNGSART
                yPos += 10;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(100);
                
                const paymentMethodNames = {
                    'bar': 'Bar',
                    'ec': 'EC-Karte',
                    'credit': 'Kreditkarte',
                    'paypal': 'PayPal',
                    'rechnung': 'Rechnung',
                    'uberweisung': 'Ueberweisung'
                };
                
                doc.text(`Zahlungsart: ${paymentMethodNames[paymentMethod] || paymentMethod}`, 20, yPos);
                
                // FOOTER - Bankdaten (IMMER) - ğŸ†• v5.87.91: KOMPAKT NEBENEINANDER
                yPos += 15;
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(80);
                
                if (yPos > 260) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setDrawColor(200);
                doc.line(20, yPos, 190, yPos);
                yPos += 5;
                
                // Linke Spalte: Bankverbindung
                doc.text('Bankverbindung:', 20, yPos);
                doc.text('Volksbank Vorpommern', 20, yPos + 4);
                doc.text('IBAN: DE16 1309 1054 0001 5524 90', 20, yPos + 8);
                doc.text('BIC: GENODEF1HST', 20, yPos + 12);
                
                // Rechte Spalte: Steuerdaten
                doc.text('Steuernummer: 084 289/01178', 120, yPos);
                doc.text('IK: 601318664', 120, yPos + 4);
                
                // Speichere in Firebase
                const invoiceData = {
                    invoiceNumber: invoiceNumber,
                    rideId: rideId,
                    customerId: invoiceCustomerData?.id || invoiceRideData?.customerId || null, // ğŸ†• v5.90.152
                    customerEmail: invoiceCustomerData?.email || '', // ğŸ†• v5.90.152
                    customerName: customerName,
                    guestName: guestName,
                    address: address,
                    pickup: pickup,
                    destination: destination,
                    rideDate: rideDate,
                    rideTime: rideTime,
                    distance: distance,
                    positions: invoicePositions,
                    totalGross: totalGross,
                    netPrice: netPrice,
                    vatRate: vatRate,
                    vatAmount: vatAmount,
                    paymentMethod: paymentMethod, // ğŸ†• v5.90.7
                    // Speichere Checkbox-Status fÃ¼r spÃ¤tere Bearbeitung
                    displayOptions: {
                        showCustomer, showAddress, showGuest,
                        showRoute, showDateTime, showDistance, showVat
                    },
                    status: 'offen',
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };
                
                await db.ref(`invoices/${invoiceNumber}`).set(invoiceData);
                console.log('âœ… Rechnung in Firebase gespeichert:', invoiceNumber);
                
                // ğŸ†• v5.90.10: Speichere Rechnung auch in der Fahrt
                if (rideId) {
                    await db.ref(`rides/${rideId}`).update({
                        invoiceNumber: invoiceNumber,
                        invoiceAmount: totalGross,
                        invoiceCreatedAt: Date.now()
                    });
                    console.log('âœ… Rechnung in Fahrt verknÃ¼pft');
                }
                
                // PDF herunterladen
                doc.save(`Rechnung_${invoiceNumber}_${new Date().toLocaleDateString('de-DE').replace(/\./g, '_')}.pdf`);
                
                // Log
                logActivity('admin', 'invoice_created', `Rechnung ${invoiceNumber} erstellt`, {
                    customer: customerName,
                    total: totalGross
                });
                
                // ğŸ¯ v5.90.542: ZEIGE SHARE-BUTTONS!
                showToast(`âœ… Rechnung ${invoiceNumber} erstellt!\nğŸ“¥ PDF wurde heruntergeladen.\nğŸ’¾ In Firebase gespeichert.`, 'success');
                
                // Blende Share-Buttons ein!
                const shareButtons = document.getElementById('invoice-share-buttons');
                if (shareButtons) {
                    shareButtons.style.display = 'flex';
                }
                
                // Verstecke "PDF erstellen" Button
                const createBtn = document.querySelector('button[onclick="generateInvoicePDFv2()"]');
                if (createBtn) {
                    createBtn.disabled = true;
                    createBtn.style.opacity = '0.5';
                    createBtn.style.cursor = 'not-allowed';
                    createBtn.innerHTML = 'âœ… PDF bereits erstellt!';
                }
                
                // Lade Rechnungsliste neu (falls offen)
                if (typeof loadInvoicesList === 'function') {
                    loadInvoicesList();
                }
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Erstellen der Rechnung:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // ğŸ†• v5.90.24: NEUES RECHNUNGSFORMAT 20-26-001
        async function getNextInvoiceNumber() {
            try {
                const currentYear = new Date().getFullYear();
                
                // Lade Counter fÃ¼r aktuelles Jahr
                const snapshot = await db.ref(`invoiceCounter/${currentYear}`).once('value');
                let counter = snapshot.val() || 0;
                
                counter++;
                
                // Speichere neue Nummer fÃ¼r dieses Jahr
                await db.ref(`invoiceCounter/${currentYear}`).set(counter);
                
                // ğŸ†• Format: 20-26-001, 20-26-002, etc.
                const shortYear = String(currentYear).substring(2); // 2026 â†’ 26
                const paddedCounter = String(counter).padStart(3, '0');
                return `20-${shortYear}-${paddedCounter}`;
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Abrufen der Rechnungsnummer:', error);
                // Fallback: Zeitstempel mit neuem Format
                const year = new Date().getFullYear();
                const shortYear = String(year).substring(2);
                return `20-${shortYear}-${Date.now()}`;
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.87.90: EINZEL-RECHNUNGEN VERWALTUNG
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let allInvoices = [];
        
        // ğŸ†• v5.90.178: ZEIGE ALLE FAHRTEN FÃœR RECHNUNGS-ERSTELLUNG!
        async function loadRidesForInvoicing() {
            console.log('ğŸš• Lade ALLE Fahrten aus Kalender fÃ¼r Rechnungs-Erstellung...');
            
            // ğŸ†• v5.90.197: Beide Container fÃ¼llen!
            const container = document.getElementById('single-invoices-list');
            const countEl = document.getElementById('single-invoices-count');
            const rechnungContainer = document.getElementById('rechnung-single-invoices-list');
            const rechnungCountEl = document.getElementById('rechnung-single-invoices-count');
            
            // Zeige Loading in BEIDEN Containern
            const loadingHTML = `
                <div style="text-align:center;padding:40px;color:#6b7280;">
                    <div style="font-size:48px;margin-bottom:10px;">ğŸš•</div>
                    <div style="font-weight:600;margin-bottom:6px;">Lade Fahrten...</div>
                </div>
            `;
            
            if (container) container.innerHTML = loadingHTML;
            if (rechnungContainer) rechnungContainer.innerHTML = loadingHTML;
            
            try {
                // ğŸ†• v5.90.309: 100 Fahrten laden fÃ¼r bessere Suche!
                console.log('ğŸš• Lade letzte 100 Fahrten fÃ¼r Rechnungen...');
                const snapshot = await db.ref('rides')
                    .orderByChild('pickupTimestamp')
                    .limitToLast(100)  // â† 100 fÃ¼r bessere Detailsuche!
                    .once('value');
                
                const allRides = [];
                snapshot.forEach(child => {
                    const ride = child.val();
                    
                    // ğŸ†• v5.90.182: ALLE FAHRTEN DIE IM KALENDER SICHTBAR SIND!
                    // AUSNAHME: Hotel-Kalender hat eigenes Programm
                    const isHotelRide = ride.source === 'hotel_calendar_import' 
                                     || ride.source === 'hotel_booking'
                                     || ride.hotelBooking === true;
                    
                    // Wenn NICHT Hotel-Fahrt â†’ Zeige in Liste!
                    if (!isHotelRide) {
                        allRides.push({
                            id: child.key,
                            ...ride
                        });
                    }
                });
                
                // Neueste zuerst (umgekehrt chronologisch)
                allRides.reverse();
                
                console.log(`âœ… ${allRides.length} Kalender-Fahrten geladen (gefiltert, letzte 50)`);
                
                // ğŸ†• v5.90.197: Update Counter in BEIDEN Views!
                if (countEl) countEl.textContent = allRides.length;
                if (rechnungCountEl) rechnungCountEl.textContent = allRides.length;
                
                // Rendere Liste
                renderRidesForInvoicing(allRides);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der Fahrten:', error);
                container.innerHTML = `
                    <div style="text-align:center;padding:40px;color:#ef4444;">
                        <div style="font-size:48px;margin-bottom:10px;">ğŸ’¾</div>
                        <div style="font-weight:600;">Fehler beim Laden!</div>
                        <div style="font-size:14px;margin-top:8px;">${error.message}</div>
                    </div>
                `;
            }
        }
        
        // ğŸ†• v5.90.309: DETAILSUCHE VARIABLEN
        let detailedSearchActive = false;
        let detailedSearchParams = {};
        
        // ğŸ†• v5.90.309: DETAILSUCHE ANWENDEN
        function applyDetailedSearch() {
            const searchText = document.getElementById('invoice-search-text').value.toLowerCase().trim();
            const searchStatus = document.getElementById('invoice-search-status').value;
            const searchDateFrom = document.getElementById('invoice-search-date-from').value;
            const searchDateTo = document.getElementById('invoice-search-date-to').value;
            
            // PrÃ¼fe ob irgendwas eingegeben wurde
            if (!searchText && !searchStatus && !searchDateFrom && !searchDateTo) {
                alert('âš ï¸ Bitte mindestens ein Suchkriterium eingeben!');
                return;
            }
            
            detailedSearchActive = true;
            detailedSearchParams = {
                text: searchText,
                status: searchStatus,
                dateFrom: searchDateFrom ? new Date(searchDateFrom).getTime() : null,
                dateTo: searchDateTo ? new Date(searchDateTo + 'T23:59:59').getTime() : null
            };
            
            console.log('ğŸ” Detailsuche aktiviert:', detailedSearchParams);
            
            // Schnell-Filter deaktivieren (grau machen)
            const buttons = document.querySelectorAll('[id^="filter-"]');
            buttons.forEach(btn => {
                btn.style.background = '#9ca3af';
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });
            
            // Neu laden
            loadRidesForInvoicing();
        }
        
        // ğŸ†• v5.90.309: DETAILSUCHE ZURÃœCKSETZEN
        function resetDetailedSearch() {
            document.getElementById('invoice-search-text').value = '';
            document.getElementById('invoice-search-status').value = '';
            document.getElementById('invoice-search-date-from').value = '';
            document.getElementById('invoice-search-date-to').value = '';
            
            detailedSearchActive = false;
            detailedSearchParams = {};
            
            console.log('ğŸ”„ Detailsuche zurÃ¼ckgesetzt');
            
            // Schnell-Filter wieder aktivieren
            const buttons = document.querySelectorAll('[id^="filter-"]');
            buttons.forEach(btn => {
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            });
            
            // Standard-Filter wiederherstellen
            setInvoiceFilter('completed_no_invoice');
        }
        
        // ğŸ†• v5.90.309: STATISTIKEN BERECHNEN & ANZEIGEN
        function updateInvoiceStatistics(rides) {
            const statsContainer = document.getElementById('invoice-statistics');
            
            if (rides.length === 0) {
                statsContainer.style.display = 'none';
                return;
            }
            
            statsContainer.style.display = 'block';
            
            // Berechne Statistiken
            const totalCount = rides.length;
            let totalAmount = 0;
            let withInvoiceCount = 0;
            let withInvoiceAmount = 0;
            
            rides.forEach(ride => {
                const price = parseFloat(ride.price) || 0;
                totalAmount += price;
                
                if (ride.invoiceNumber) {
                    withInvoiceCount++;
                    withInvoiceAmount += price;
                }
            });
            
            // Update UI
            document.getElementById('stat-total-count').textContent = totalCount;
            document.getElementById('stat-total-amount').textContent = totalAmount.toFixed(2) + 'â‚¬';
            document.getElementById('stat-with-invoice').textContent = withInvoiceCount + ' (' + withInvoiceAmount.toFixed(2) + 'â‚¬)';
        }
        
        // ğŸ†• v5.90.308: FILTER STATUS
        let currentInvoiceFilter = 'completed_no_invoice'; // Standard: Abgeschlossen ohne Rechnung
        
        // ğŸ†• v5.90.308: FILTER SETZEN
        function setInvoiceFilter(filter) {
            // ğŸ†• v5.90.309: Nur wenn Detailsuche NICHT aktiv!
            if (detailedSearchActive) {
                alert('âš ï¸ Detailsuche ist aktiv!\n\nBitte erst zurÃ¼cksetzen.');
                return;
            }
            
            currentInvoiceFilter = filter;
            console.log('ğŸ” Filter gesetzt:', filter);
            
            // Update Button-Styles
            const buttons = {
                'all': document.getElementById('filter-all'),
                'completed': document.getElementById('filter-completed'),
                'pending': document.getElementById('filter-pending'),
                'with_invoice': document.getElementById('filter-with-invoice'),
                'no_invoice': document.getElementById('filter-no-invoice'),
                'completed_no_invoice': document.getElementById('filter-completed-no-invoice')
            };
            
            // Alle grau
            Object.values(buttons).forEach(btn => {
                if (btn) {
                    btn.style.background = '#6b7280';
                    btn.style.boxShadow = 'none';
                }
            });
            
            // Aktiver Button grÃ¼n
            const activeBtn = buttons[filter];
            if (activeBtn) {
                activeBtn.style.background = 'linear-gradient(135deg,#10b981,#059669)';
                activeBtn.style.boxShadow = '0 2px 6px rgba(16,185,129,0.3)';
            }
            
            // Neu laden
            loadRidesForInvoicing();
        }
        
        // ğŸ†• v5.90.308: RECHNUNG ERSTELLEN & DIREKT PER WHATSAPP SENDEN!
        async function openInvoiceModalAndSendWhatsApp(rideId) {
            try {
                console.log('ğŸ“± v5.90.308: Rechnung erstellen & WhatsApp senden fÃ¼r:', rideId);
                
                // 1. Ã–ffne Modal
                await openInvoiceModal(rideId);
                
                // 2. Warte kurz damit Modal gerendert ist
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 3. Klicke automatisch auf WhatsApp-Button
                // (Der Button ruft generateInvoicePDFAndSendWhatsApp auf)
                showToast('ğŸ’¡ PrÃ¼fe Daten und klicke "Per WhatsApp senden"', 'info');
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // ğŸ†• v5.90.308: VORHANDENE RECHNUNG NOCHMAL PER WHATSAPP SENDEN!
        async function resendInvoiceViaWhatsApp(rideId, invoiceNumber) {
            try {
                console.log('ğŸ“± v5.90.308: Rechnung nochmal senden:', invoiceNumber);
                
                // Lade Rechnung aus DB
                const invoiceSnapshot = await db.ref(`invoices/${invoiceNumber}`).once('value');
                const invoice = invoiceSnapshot.val();
                
                if (!invoice) {
                    alert('ğŸ’¾ Rechnung nicht gefunden!');
                    return;
                }
                
                // PrÃ¼fe ob PDF-URL vorhanden
                if (!invoice.pdfUrl) {
                    alert('ğŸ’¾ Kein PDF-Link vorhanden!\n\nBitte erstelle die Rechnung neu.');
                    return;
                }
                
                // PrÃ¼fe Telefonnummer
                if (!invoice.customerPhone) {
                    // Versuche aus Fahrt zu laden
                    const rideSnapshot = await db.ref(`rides/${rideId}`).once('value');
                    const ride = rideSnapshot.val();
                    
                    if (!ride || !ride.customerPhone) {
                        alert('ğŸ’¾ Keine Telefonnummer vorhanden!\n\nBitte im CRM hinterlegen.');
                        return;
                    }
                    
                    invoice.customerPhone = ride.customerPhone;
                }
                
                // Ã–ffne WhatsApp
                showToast('ğŸ“± Ã–ffne WhatsApp...', 'info');
                
                // ğŸ†• v5.90.552: DEBUG - PrÃ¼fe PDF-URL!
                console.log('ğŸ“± v5.90.552: PDF-URL:', invoice.pdfUrl);
                console.log('ğŸ“± v5.90.552: Kundename:', invoice.customerName);
                console.log('ğŸ“± v5.90.552: Betrag:', invoice.amount);
                
                if (!invoice.pdfUrl) {
                    alert('âš ï¸ KEIN PDF-LINK!\n\nDie Rechnung wurde erstellt, aber der PDF-Link fehlt in Firebase.\n\nBitte Rechnung neu erstellen!');
                    return;
                }
                
                const whatsappText = encodeURIComponent(
                    `Hallo ${invoice.customerName || 'Kunde'},\n\n` +
                    `hier ist Ihre Rechnung Nr. ${invoiceNumber} Ã¼ber ${invoice.amount.toFixed(2)} â‚¬:\n\n` +
                    `${invoice.pdfUrl}\n\n` +
                    `Einfach auf den Link klicken zum Herunterladen.\n\n` +
                    `Vielen Dank!\n` +
                    `Taxi Patrick Wydra`
                );
                
                // ğŸ†• v5.90.552: DEBUG - Zeige WhatsApp-Text!
                console.log('ğŸ“± v5.90.552: WhatsApp-Text:', decodeURIComponent(whatsappText));
                
                const whatsappPhone = invoice.customerPhone.replace(/[\s\-\(\)]/g, '').replace(/^\+/, '');
                const whatsappUrl = `https://wa.me/${whatsappPhone}?text=${whatsappText}`;
                
                console.log('ğŸ“± v5.90.552: WhatsApp-URL:', whatsappUrl);
                
                window.open(whatsappUrl, '_blank');
                
                showToast('âœ… WhatsApp geÃ¶ffnet!', 'success');
                
                // Log
                logActivity('admin', 'invoice_resent_whatsapp', `Rechnung ${invoiceNumber} erneut per WhatsApp versendet`, {
                    customer: invoice.customerName,
                    phone: invoice.customerPhone,
                    amount: invoice.amount
                });
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // ğŸ†• v5.90.178: RENDERE FAHRTEN-LISTE FÃœR RECHNUNGS-ERSTELLUNG!
        function renderRidesForInvoicing(rides) {
            // ğŸ†• v5.90.197: Beide Container fÃ¼llen!
            const container = document.getElementById('single-invoices-list');
            const rechnungContainer = document.getElementById('rechnung-single-invoices-list');
            const filterInfo = document.getElementById('rechnung-filter-info');
            
            // ğŸ†• v5.90.309: DETAILSUCHE ZUERST!
            if (detailedSearchActive) {
                console.log('ğŸ” Wende Detailsuche an:', detailedSearchParams);
                
                rides = rides.filter(ride => {
                    // Text-Suche
                    if (detailedSearchParams.text) {
                        const searchLower = detailedSearchParams.text;
                        const customerName = (ride.customerName || '').toLowerCase();
                        const guestName = (ride.guestName || '').toLowerCase();
                        const invoiceNumber = (ride.invoiceNumber || '').toLowerCase();
                        const pickup = (ride.pickup || '').toLowerCase();
                        const destination = (ride.destination || '').toLowerCase();
                        
                        if (!customerName.includes(searchLower) && 
                            !guestName.includes(searchLower) && 
                            !invoiceNumber.includes(searchLower) &&
                            !pickup.includes(searchLower) &&
                            !destination.includes(searchLower)) {
                            return false;
                        }
                    }
                    
                    // Status-Filter
                    if (detailedSearchParams.status) {
                        if (ride.status !== detailedSearchParams.status) {
                            return false;
                        }
                    }
                    
                    // Datum Von
                    if (detailedSearchParams.dateFrom) {
                        const rideTime = ride.pickupTimestamp || 0;
                        if (rideTime < detailedSearchParams.dateFrom) {
                            return false;
                        }
                    }
                    
                    // Datum Bis
                    if (detailedSearchParams.dateTo) {
                        const rideTime = ride.pickupTimestamp || 0;
                        if (rideTime > detailedSearchParams.dateTo) {
                            return false;
                        }
                    }
                    
                    return true;
                });
                
                filterInfo.textContent = `ğŸ” Detailsuche (${rides.length} Treffer)`;
                filterInfo.style.color = '#3b82f6';
                filterInfo.style.fontWeight = '700';
                
            } else {
                // ğŸ†• v5.90.308: SCHNELL-FILTER ANWENDEN!
                let filteredRides = rides;
                let filterText = '';
                
                switch (currentInvoiceFilter) {
                    case 'completed_no_invoice':
                        filteredRides = rides.filter(r => r.status === 'completed' && !r.invoiceNumber);
                        filterText = 'âœ… Abgeschlossen ohne Rechnung';
                        break;
                    case 'completed':
                        filteredRides = rides.filter(r => r.status === 'completed');
                        filterText = 'âœ… Nur Abgeschlossen';
                        break;
                    case 'pending':
                        filteredRides = rides.filter(r => r.status !== 'completed' && r.status !== 'cancelled');
                        filterText = 'â³ Nur Offene';
                        break;
                    case 'with_invoice':
                        filteredRides = rides.filter(r => r.invoiceNumber);
                        filterText = 'ğŸ’° Mit Rechnung';
                        break;
                    case 'no_invoice':
                        filteredRides = rides.filter(r => !r.invoiceNumber);
                        filterText = 'ğŸ’¾ Ohne Rechnung';
                        break;
                    case 'all':
                    default:
                        filteredRides = rides;
                        filterText = 'ğŸ“± Alle Fahrten';
                        break;
                }
                
                rides = filteredRides;
                
                console.log(`ğŸ” Filter: ${filterText} â†’ ${rides.length} Fahrten`);
                
                // Filter-Info anzeigen
                if (filterInfo) {
                    filterInfo.textContent = `${filterText} (${rides.length})`;
                    filterInfo.style.color = '#6b7280';
                    filterInfo.style.fontWeight = '600';
                }
            }
            
            // ğŸ†• v5.90.309: STATISTIKEN UPDATE!
            updateInvoiceStatistics(rides);
            
            const emptyHTML = `
                <div style="text-align:center;padding:40px;color:#6b7280;">
                    <div style="font-size:48px;margin-bottom:10px;">ğŸš•</div>
                    <div style="font-weight:600;">Keine Fahrten gefunden</div>
                    <div style="font-size:14px;margin-top:8px;color:#9ca3af;">
                        ${detailedSearchActive ? 'Versuche andere Suchkriterien' : (currentInvoiceFilter === 'completed_no_invoice' ? 'Alle abgeschlossenen Fahrten haben bereits Rechnungen!' : 'Ã„ndere den Filter um andere Fahrten zu sehen')}
                    </div>
                </div>
            `;
            
            if (rides.length === 0) {
                if (container) container.innerHTML = emptyHTML;
                if (rechnungContainer) rechnungContainer.innerHTML = emptyHTML;
                return;
            }
            
            let html = '<div style="display:flex;flex-direction:column;gap:12px;">';
            
            rides.forEach(ride => {
                // Datum & Zeit formatieren
                const rideDate = ride.pickupDate || new Date(ride.pickupTimestamp).toLocaleDateString('de-DE');
                const rideTime = ride.pickupTime || new Date(ride.pickupTimestamp).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
                
                // Status-Badge
                let statusBadge = '';
                let actionButton = '';
                
                if (ride.invoiceNumber) {
                    // Hat schon Rechnung
                    statusBadge = `
                        <div style="display:inline-flex;align-items:center;gap:6px;padding:4px 10px;background:#10b981;color:white;border-radius:20px;font-size:12px;font-weight:600;">
                            âœ… ${ride.invoiceNumber}
                        </div>
                    `;
                    
                    // ğŸ†• v5.90.309: ERWEITERTE BUTTONS!
                    actionButton = `
                        <div style="display:flex;gap:6px;flex-wrap:wrap;">
                            <button onclick="downloadInvoicePDF('${ride.invoiceNumber}', '${ride.id}')" 
                                    style="padding:8px 12px;background:#8b5cf6;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:12px;box-shadow:0 2px 4px rgba(139,92,246,0.3);">
                                ğŸ“¥ PDF
                            </button>
                            <button onclick="resendInvoiceViaWhatsApp('${ride.id}', '${ride.invoiceNumber}')" 
                                    style="padding:8px 12px;background:linear-gradient(135deg,#25D366,#128C7E);color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:12px;box-shadow:0 2px 4px rgba(37,211,102,0.3);">
                                ğŸ“± WhatsApp
                            </button>
                            <button onclick="openInvoiceModal('${ride.id}')" 
                                    style="padding:8px 12px;background:#f59e0b;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:12px;box-shadow:0 2px 4px rgba(245,158,11,0.3);">
                                âœï¸ Bearbeiten
                            </button>
                        </div>
                    `;
                } else {
                    // Noch keine Rechnung
                    statusBadge = `
                        <div style="display:inline-flex;align-items:center;gap:6px;padding:4px 10px;background:#f59e0b;color:white;border-radius:20px;font-size:12px;font-weight:600;">
                            â³ Keine Rechnung
                        </div>
                    `;
                    
                    // ğŸ†• v5.90.320: ZWEI BUTTONS!
                    actionButton = `
                        <div style="display:flex;gap:8px;flex-wrap:wrap;">
                            <button onclick="openInvoiceModal('${ride.id}')" 
                                    style="padding:10px 16px;background:linear-gradient(135deg,#3b82f6,#1e40af);color:white;border:none;border-radius:6px;font-weight:700;cursor:pointer;font-size:13px;box-shadow:0 2px 6px rgba(59,130,246,0.3);">
                                ğŸ“± Rechnung erstellen
                            </button>
                            <button onclick="openInvoiceModalAndSendWhatsApp('${ride.id}')" 
                                    style="padding:10px 16px;background:linear-gradient(135deg,#25D366,#128C7E);color:white;border:none;border-radius:6px;font-weight:700;cursor:pointer;font-size:13px;box-shadow:0 2px 6px rgba(37,211,102,0.3);">
                                ğŸ“± Per WhatsApp
                            </button>
                        </div>
                    `;
                }
                
                // Preis - sicher behandeln (kann String, Number oder null sein!)
                const price = ride.price ? `${parseFloat(ride.price).toFixed(2)}â‚¬` : '-';
                
                html += `
                    <div style="background:white;border:2px solid #e5e7eb;border-radius:10px;padding:14px;transition:all 0.2s;" 
                         onmouseover="this.style.borderColor='#8b5cf6';this.style.boxShadow='0 4px 12px rgba(139,92,246,0.15)'" 
                         onmouseout="this.style.borderColor='#e5e7eb';this.style.boxShadow='none'">
                        
                        <!-- Header: Datum, Zeit, Status -->
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <div style="display:flex;align-items:center;gap:10px;">
                                <span style="font-weight:700;font-size:15px;color:#1f2937;">ğŸ“… ${rideDate}</span>
                                <span style="font-weight:600;font-size:15px;color:#6b7280;">ğŸ• ${rideTime}</span>
                            </div>
                            ${statusBadge}
                        </div>
                        
                        <!-- Kunde -->
                        <div style="margin-bottom:8px;">
                            <span style="font-weight:700;font-size:16px;color:#8b5cf6;">ğŸ’¾ ${ride.customerName || 'Unbekannt'}</span>
                            ${ride.guestName ? `<span style="font-size:13px;color:#6b7280;margin-left:8px;">(${ride.guestName})</span>` : ''}
                        </div>
                        
                        <!-- Route -->
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;color:#374151;font-size:14px;">
                            <span style="font-weight:600;">ğŸ“ ${ride.pickup || 'Unbekannt'}</span>
                            <span style="color:#9ca3af;">â†’</span>
                            <span style="font-weight:600;">ğŸ¯ ${ride.destination || 'Unbekannt'}</span>
                        </div>
                        
                        <!-- Preis & Action -->
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;padding-top:12px;border-top:1px solid #e5e7eb;">
                            <div style="font-weight:700;font-size:18px;color:#10b981;">ğŸ’° ${price}</div>
                            ${actionButton}
                        </div>
                        
                    </div>
                `;
            });
            
            html += '</div>';
            
            // ğŸ†• v5.90.197: Beide Container fÃ¼llen!
            if (container) container.innerHTML = html;
            if (rechnungContainer) rechnungContainer.innerHTML = html;
            
            console.log('âœ… Fahrten-Liste gerendert in', container ? 'Admin' : '', rechnungContainer ? 'Rechnung-View' : '');
        }
        
        // ALTE FUNKTION (fÃ¼r Rechnungs-Liste in anderen Views)
        async function loadInvoicesList() {
            console.log('ğŸ“± Lade Einzel-Rechnungen...');
            
            const container = document.getElementById('single-invoices-list');
            const countEl = document.getElementById('single-invoices-count');
            
            if (!container) return;
            
            try {
                const snapshot = await db.ref('invoices').orderByChild('createdAt').once('value');
                
                allInvoices = [];
                snapshot.forEach(child => {
                    allInvoices.push({
                        id: child.key,
                        ...child.val()
                    });
                });
                
                // Neueste zuerst
                allInvoices.reverse();
                
                if (countEl) countEl.textContent = allInvoices.length;
                
                renderInvoicesList(allInvoices);
                updateInvoicesSummary(allInvoices);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der Rechnungen:', error);
                container.innerHTML = `<div style="text-align:center;padding:20px;color:#ef4444;">ğŸ’¾ Fehler: ${error.message}</div>`;
            }
        }
        
        function renderInvoicesList(invoices) {
            const container = document.getElementById('single-invoices-list');
            if (!container) return;
            
            if (invoices.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;padding:40px;color:#6b7280;">
                        <div style="font-size:48px;margin-bottom:10px;">ğŸ“±</div>
                        <div style="font-weight:600;">Keine Rechnungen gefunden</div>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table style="width:100%;border-collapse:collapse;font-size:14px;">
                    <thead>
                        <tr style="background:#f3f4f6;border-bottom:2px solid #e5e7eb;">
                            <th style="padding:12px;text-align:left;">RE-Nr.</th>
                            <th style="padding:12px;text-align:left;">Kunde</th>
                            <th style="padding:12px;text-align:left;">Betrag</th>
                            <th style="padding:12px;text-align:left;">Datum</th>
                            <th style="padding:12px;text-align:center;">Status</th>
                            <th style="padding:12px;text-align:center;">Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            invoices.forEach(inv => {
                const statusColor = inv.status === 'bezahlt' ? '#10b981' : '#f59e0b';
                const statusText = inv.status === 'bezahlt' ? 'âœ… Bezahlt' : 'â³ Offen';
                const dateStr = inv.createdAt ? new Date(inv.createdAt).toLocaleDateString('de-DE') : '-';
                
                html += `
                    <tr style="border-bottom:1px solid #e5e7eb;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                        <td style="padding:12px;font-weight:600;color:#8b5cf6;">${inv.invoiceNumber || inv.id}</td>
                        <td style="padding:12px;">
                            <div style="font-weight:500;">${inv.customerName || 'Unbekannt'}</div>
                            ${inv.guestName ? `<div style="font-size:12px;color:#6b7280;">ğŸ“ ${inv.guestName}</div>` : ''}
                        </td>
                        <td style="padding:12px;font-weight:600;">${(inv.totalGross || 0).toFixed(2)}â‚¬</td>
                        <td style="padding:12px;color:#6b7280;">${dateStr}</td>
                        <td style="padding:12px;text-align:center;">
                            <span style="padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600;background:${statusColor}20;color:${statusColor};">${statusText}</span>
                        </td>
                        <td style="padding:12px;text-align:center;">
                            <div style="display:flex;gap:5px;justify-content:center;flex-wrap:wrap;">
                                <button onclick="editInvoice('${inv.id}')" style="padding:6px 10px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;" title="Bearbeiten">âœï¸</button>
                                
                                <!-- ğŸ†• v5.90.148: CRM BUTTON! -->
                                <button onclick="openCustomerEditFromInvoiceList('${inv.customerId || ''}', '${(inv.customerName || '').replace(/'/g, "\\'")}', '${inv.id}')" 
                                        style="padding:6px 10px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;" 
                                        title="Kunde im CRM bearbeiten">CRM</button>
                                
                                <button onclick="regenerateInvoicePDF('${inv.id}')" style="padding:6px 10px;background:#8b5cf6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;" title="PDF neu erstellen">ğŸ“¥</button>
                                
                                <!-- ğŸ†• v5.90.128: E-MAIL VERSAND -->
                                <button onclick="sendSingleInvoiceViaEmail('${inv.id}')" style="padding:6px 10px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;" title="Per E-Mail senden">ğŸ“§</button>
                                <button onclick="shareExistingInvoiceViaWhatsApp('${inv.id}')" style="padding:6px 10px;background:#25D366;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;" title="Per WhatsApp senden">ğŸ“¤</button>
                                
                                <button onclick="toggleInvoiceStatus('${inv.id}')" style="padding:6px 10px;background:${inv.status === 'bezahlt' ? '#f59e0b' : '#10b981'};color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;" title="${inv.status === 'bezahlt' ? 'Als offen markieren' : 'Als bezahlt markieren'}">${inv.status === 'bezahlt' ? 'â†©ï¸' : 'âœ…'}</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function filterInvoicesList() {
            const search = (document.getElementById('invoice-search')?.value || '').toLowerCase();
            const statusFilter = document.getElementById('invoice-status-filter')?.value || '';
            const monthFilter = document.getElementById('invoice-month-filter')?.value || '';
            
            let filtered = allInvoices.filter(inv => {
                // Textsuche
                if (search) {
                    const searchText = `${inv.customerName || ''} ${inv.guestName || ''} ${inv.invoiceNumber || inv.id}`.toLowerCase();
                    if (!searchText.includes(search)) return false;
                }
                
                // Status
                if (statusFilter && inv.status !== statusFilter) return false;
                
                // Monat
                if (monthFilter && inv.createdAt) {
                    const invDate = new Date(inv.createdAt);
                    const invMonth = `${invDate.getFullYear()}-${String(invDate.getMonth() + 1).padStart(2, '0')}`;
                    if (invMonth !== monthFilter) return false;
                }
                
                return true;
            });
            
            renderInvoicesList(filtered);
            updateInvoicesSummary(filtered);
        }
        
        function updateInvoicesSummary(invoices) {
            const summaryEl = document.getElementById('invoices-summary');
            if (!summaryEl) return;
            
            const total = invoices.length;
            const openAmount = invoices.filter(i => i.status !== 'bezahlt').reduce((sum, i) => sum + (i.totalGross || 0), 0);
            const paidAmount = invoices.filter(i => i.status === 'bezahlt').reduce((sum, i) => sum + (i.totalGross || 0), 0);
            
            document.getElementById('invoices-total-count').textContent = total;
            document.getElementById('invoices-open-amount').textContent = openAmount.toFixed(2) + 'â‚¬';
            document.getElementById('invoices-paid-amount').textContent = paidAmount.toFixed(2) + 'â‚¬';
            
            summaryEl.style.display = 'block';
        }
        
        async function toggleInvoiceStatus(invoiceId) {
            try {
                const inv = allInvoices.find(i => i.id === invoiceId);
                if (!inv) return;
                
                const newStatus = inv.status === 'bezahlt' ? 'offen' : 'bezahlt';
                
                await db.ref(`invoices/${invoiceId}/status`).set(newStatus);
                await db.ref(`invoices/${invoiceId}/updatedAt`).set(Date.now());
                
                if (newStatus === 'bezahlt') {
                    await db.ref(`invoices/${invoiceId}/paidAt`).set(Date.now());
                }
                
                console.log(`âœ… Status geÃ¤ndert: ${invoiceId} â†’ ${newStatus}`);
                
                loadInvoicesList();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        async function editInvoice(invoiceId) {
            console.log('âœï¸ Bearbeite Rechnung:', invoiceId);
            
            try {
                const snapshot = await db.ref(`invoices/${invoiceId}`).once('value');
                const inv = snapshot.val();
                
                if (!inv) {
                    alert('ğŸ’¾ Rechnung nicht gefunden!');
                    return;
                }
                
                // Ã–ffne Bearbeitungs-Modal
                const modal = document.createElement('div');
                modal.id = 'edit-invoice-modal';
                modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:99999;padding:20px;';
                
                const displayOpts = inv.displayOptions || {};
                
                modal.innerHTML = `
                    <div style="background:white;border-radius:16px;max-width:800px;width:100%;max-height:90vh;overflow-y:auto;">
                        <div style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;padding:20px;border-radius:16px 16px 0 0;position:sticky;top:0;z-index:10;">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <h3 style="margin:0;font-size:20px;">âœï¸ Rechnung ${inv.invoiceNumber || invoiceId} bearbeiten</h3>
                                <button onclick="closeEditInvoiceModal()" style="background:rgba(255,255,255,0.2);border:none;color:white;font-size:24px;width:32px;height:32px;border-radius:50%;cursor:pointer;">Ã—</button>
                            </div>
                        </div>
                        
                        <div style="padding:20px;">
                            <!-- FESTE DATEN -->
                            <div style="background:#f3f4f6;padding:15px;border-radius:10px;margin-bottom:20px;">
                                <div style="font-weight:700;margin-bottom:10px;color:#6b7280;">ğŸ”’ Feste Daten (nicht Ã¤nderbar)</div>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:14px;">
                                    <div><strong>Rechnungsnr.:</strong> ${inv.invoiceNumber || invoiceId}</div>
                                    <div><strong>Erstellt:</strong> ${inv.createdAt ? new Date(inv.createdAt).toLocaleDateString('de-DE') : '-'}</div>
                                </div>
                            </div>
                            
                            <!-- BEARBEITBARE FELDER -->
                            <div style="background:#f0f9ff;border:2px solid #3b82f6;padding:15px;border-radius:10px;margin-bottom:20px;">
                                <div style="font-weight:700;margin-bottom:15px;color:#1e40af;">âœï¸ Bearbeitbare Daten</div>
                                
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                                    <div>
                                        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">Kundenname:</label>
                                        <input type="text" id="edit-inv-customer" value="${inv.customerName || ''}" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                                    </div>
                                    <div>
                                        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">Gastname:</label>
                                        <input type="text" id="edit-inv-guest" value="${inv.guestName || ''}" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                                    </div>
                                </div>
                                
                                <div style="margin-top:10px;">
                                    <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">Adresse:</label>
                                    <textarea id="edit-inv-address" rows="2" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">${inv.address || ''}</textarea>
                                </div>
                                
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:10px;">
                                    <div>
                                        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">Von:</label>
                                        <input type="text" id="edit-inv-pickup" value="${inv.pickup || ''}" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                                    </div>
                                    <div>
                                        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:5px;">Nach:</label>
                                        <input type="text" id="edit-inv-destination" value="${inv.destination || ''}" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- POSITIONEN -->
                            <div style="background:#f0fdf4;border:2px solid #10b981;padding:15px;border-radius:10px;margin-bottom:20px;">
                                <div style="font-weight:700;margin-bottom:15px;color:#048257;">ğŸ’° Positionen</div>
                                <div id="edit-inv-positions"></div>
                                <button onclick="addEditInvoicePosition()" style="width:100%;padding:10px;margin-top:10px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;">+ Position hinzufÃ¼gen</button>
                                
                                <div style="margin-top:15px;padding-top:15px;border-top:2px solid #10b981;">
                                    <div style="display:flex;justify-content:space-between;font-weight:600;font-size:16px;">
                                        <span>Gesamtbetrag:</span>
                                        <span id="edit-inv-total">${(inv.totalGross || 0).toFixed(2)}â‚¬</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- BUTTONS -->
                            <div style="display:flex;gap:10px;">
                                <button onclick="saveEditedInvoice('${invoiceId}')" style="flex:1;padding:15px;background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;border:none;border-radius:10px;font-weight:700;cursor:pointer;">
                                    ğŸ’¾ Speichern
                                </button>
                                <button onclick="regenerateInvoicePDF('${invoiceId}')" style="flex:1;padding:15px;background:#10b981;color:white;border:none;border-radius:10px;font-weight:700;cursor:pointer;">
                                    ğŸ“¥ Neue PDF erstellen
                                </button>
                                <button onclick="closeEditInvoiceModal()" style="flex:0.3;padding:15px;background:#6b7280;color:white;border:none;border-radius:10px;cursor:pointer;">
                                    Abbrechen
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Lade Positionen
                editInvoicePositions = inv.positions || [{ description: 'Taxifahrt', amount: inv.totalGross || 0 }];
                renderEditInvoicePositions();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        let editInvoicePositions = [];
        
        function renderEditInvoicePositions() {
            const container = document.getElementById('edit-inv-positions');
            if (!container) return;
            
            let html = '';
            editInvoicePositions.forEach((pos, index) => {
                html += `
                    <div style="display:flex;gap:10px;margin-bottom:10px;align-items:center;">
                        <input type="text" value="${pos.description || ''}" onchange="editInvoicePositions[${index}].description=this.value" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:8px;" placeholder="Beschreibung">
                        <input type="number" value="${pos.amount || 0}" step="0.01" onchange="editInvoicePositions[${index}].amount=parseFloat(this.value);updateEditInvoiceTotal()" style="width:100px;padding:10px;border:2px solid #e0e0e0;border-radius:8px;text-align:right;" placeholder="0.00">
                        <span style="color:#6b7280;">â‚¬</span>
                        ${editInvoicePositions.length > 1 ? `<button onclick="removeEditInvoicePosition(${index})" style="padding:8px 12px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;">ğŸ—‘ï¸</button>` : ''}
                    </div>
                `;
            });
            container.innerHTML = html;
            updateEditInvoiceTotal();
        }
        
        function addEditInvoicePosition() {
            editInvoicePositions.push({ description: '', amount: 0 });
            renderEditInvoicePositions();
        }
        
        function removeEditInvoicePosition(index) {
            editInvoicePositions.splice(index, 1);
            renderEditInvoicePositions();
        }
        
        function updateEditInvoiceTotal() {
            const total = editInvoicePositions.reduce((sum, pos) => sum + (parseFloat(pos.amount) || 0), 0);
            const el = document.getElementById('edit-inv-total');
            if (el) el.textContent = total.toFixed(2) + 'â‚¬';
        }
        
        async function saveEditedInvoice(invoiceId) {
            try {
                const customerName = document.getElementById('edit-inv-customer').value.trim();
                const guestName = document.getElementById('edit-inv-guest').value.trim();
                const address = document.getElementById('edit-inv-address').value.trim();
                const pickup = document.getElementById('edit-inv-pickup').value.trim();
                const destination = document.getElementById('edit-inv-destination').value.trim();
                
                const totalGross = editInvoicePositions.reduce((sum, pos) => sum + (parseFloat(pos.amount) || 0), 0);
                
                // Hole alten Datensatz fÃ¼r vatRate
                const oldSnap = await db.ref(`invoices/${invoiceId}`).once('value');
                const oldData = oldSnap.val() || {};
                const vatRate = oldData.vatRate || 7;
                
                const netPrice = totalGross / (1 + (vatRate / 100));
                const vatAmount = totalGross - netPrice;
                
                const updates = {
                    customerName,
                    guestName,
                    address,
                    pickup,
                    destination,
                    positions: editInvoicePositions,
                    totalGross,
                    netPrice,
                    vatAmount,
                    updatedAt: Date.now()
                };
                
                await db.ref(`invoices/${invoiceId}`).update(updates);
                
                console.log('âœ… Rechnung aktualisiert:', invoiceId);
                alert('âœ… Rechnung gespeichert!');
                
                closeEditInvoiceModal();
                loadInvoicesList();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        function closeEditInvoiceModal() {
            const modal = document.getElementById('edit-invoice-modal');
            if (modal) modal.remove();
        }
        
        async function regenerateInvoicePDF(invoiceId) {
            try {
                const snapshot = await db.ref(`invoices/${invoiceId}`).once('value');
                const inv = snapshot.val();
                
                if (!inv) {
                    alert('ğŸ’¾ Rechnung nicht gefunden!');
                    return;
                }
                
                console.log('ğŸ“± Regeneriere PDF fÃ¼r:', invoiceId);
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const displayOpts = inv.displayOptions || {
                    showCustomer: true, showAddress: true, showGuest: true,
                    showRoute: true, showDateTime: true, showDistance: false, showVat: true
                };
                
                // HEADER (IMMER)
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text('Taxiunternehmen Patrick Wydra', 20, 20);
                doc.text('Amselring 10', 20, 25);
                doc.text('17424 Ostseebad Heringsdorf', 20, 30);
                doc.text('Tel.: 038378/22022', 20, 35);
                
                // TITEL (IMMER)
                doc.setFontSize(20);
                doc.setTextColor(0);
                doc.setFont(undefined, 'bold');
                doc.text('Rechnung', 20, 50);
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Rechnungsnr.: ${inv.invoiceNumber || invoiceId}`, 20, 58);
                doc.text(`Datum: ${inv.createdAt ? new Date(inv.createdAt).toLocaleDateString('de-DE') : new Date().toLocaleDateString('de-DE')}`, 20, 63);
                
                let yPos = 75;
                
                if (displayOpts.showCustomer && inv.customerName) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Kunde:', 20, yPos);
                    doc.setFont(undefined, 'normal');
                    yPos += 6;
                    doc.text(inv.customerName, 20, yPos);
                    yPos += 5;
                }
                
                if (displayOpts.showAddress && inv.address) {
                    const lines = doc.splitTextToSize(inv.address, 80);
                    doc.text(lines, 20, yPos);
                    yPos += lines.length * 5;
                }
                
                if (displayOpts.showGuest && inv.guestName) {
                    yPos += 3;
                    doc.setFont(undefined, 'bold');
                    doc.text('Gastname:', 20, yPos);
                    doc.setFont(undefined, 'normal');
                    yPos += 5;
                    doc.text(inv.guestName, 20, yPos);
                    yPos += 5;
                }
                
                if (displayOpts.showRoute || displayOpts.showDateTime || displayOpts.showDistance) {
                    yPos += 5;
                    doc.setFont(undefined, 'bold');
                    doc.text('Fahrtdetails:', 20, yPos);
                    doc.setFont(undefined, 'normal');
                    yPos += 6;
                    
                    if (displayOpts.showDateTime) {
                        doc.text(`Datum: ${inv.rideDate || '-'}`, 20, yPos);
                        yPos += 5;
                        doc.text(`Uhrzeit: ${inv.rideTime || '-'}`, 20, yPos);
                        yPos += 5;
                    }
                    
                    if (displayOpts.showRoute) {
                        doc.text(`Von: ${inv.pickup || '-'}`, 20, yPos);
                        yPos += 5;
                        doc.text(`Nach: ${inv.destination || '-'}`, 20, yPos);
                        yPos += 5;
                    }
                    
                    if (displayOpts.showDistance) {
                        doc.text(`Distanz: ${(inv.distance || 0).toFixed(1)} km`, 20, yPos);
                        yPos += 5;
                    }
                }
                
                // POSITIONEN (IMMER)
                yPos += 10;
                doc.setDrawColor(200);
                doc.line(20, yPos, 190, yPos);
                
                yPos += 8;
                doc.setFont(undefined, 'bold');
                doc.text('Pos.', 20, yPos);
                doc.text('Beschreibung', 40, yPos);
                doc.text('Betrag', 160, yPos, { align: 'right' });
                
                yPos += 2;
                doc.line(20, yPos, 190, yPos);
                yPos += 6;
                doc.setFont(undefined, 'normal');
                
                const positions = inv.positions || [{ description: 'Taxifahrt', amount: inv.totalGross }];
                positions.forEach((pos, index) => {
                    doc.text(`${index + 1}`, 20, yPos);
                    doc.text(pos.description || 'Position', 40, yPos);
                    doc.text(`${parseFloat(pos.amount).toFixed(2)}â‚¬`, 160, yPos, { align: 'right' });
                    yPos += 6;
                });
                
                yPos += 4;
                doc.line(20, yPos, 190, yPos);
                
                if (displayOpts.showVat) {
                    yPos += 6;
                    doc.text('Netto:', 100, yPos);
                    doc.text(`${(inv.netPrice || 0).toFixed(2)}â‚¬`, 160, yPos, { align: 'right' });
                    yPos += 6;
                    doc.text(`MwSt ${inv.vatRate || 7}%:`, 100, yPos);
                    doc.text(`${(inv.vatAmount || 0).toFixed(2)}â‚¬`, 160, yPos, { align: 'right' });
                    yPos += 2;
                    doc.line(100, yPos, 190, yPos);
                }
                
                yPos += 6;
                doc.setFont(undefined, 'bold');
                doc.setFontSize(12);
                doc.text('Gesamtbetrag:', 100, yPos);
                doc.text(`${(inv.totalGross || 0).toFixed(2)}â‚¬`, 160, yPos, { align: 'right' });
                
                // FOOTER (IMMER) - ğŸ†• v5.87.91: KOMPAKT NEBENEINANDER
                yPos += 15;
                if (yPos > 260) { doc.addPage(); yPos = 20; }
                
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(80);
                
                doc.setDrawColor(200);
                doc.line(20, yPos, 190, yPos);
                yPos += 5;
                
                // Linke Spalte: Bankverbindung
                doc.text('Bankverbindung:', 20, yPos);
                doc.text('Volksbank Vorpommern', 20, yPos + 4);
                doc.text('IBAN: DE16 1309 1054 0001 5524 90', 20, yPos + 8);
                doc.text('BIC: GENODEF1HST', 20, yPos + 12);
                
                // Rechte Spalte: Steuerdaten
                doc.text('Steuernummer: 084 289/01178', 120, yPos);
                doc.text('IK: 601318664', 120, yPos + 4);
                
                doc.save(`Rechnung_${inv.invoiceNumber || invoiceId}_${new Date().toLocaleDateString('de-DE').replace(/\./g, '_')}.pdf`);
                
                alert('âœ… PDF wurde erstellt!');
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.52.6: NOSHOW-RECHNUNG SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let noShowRideData = null;
        let noShowCustomerData = null;
        
        async function openNoShowInvoiceModal(rideId) {
            console.log('ğŸ“ Ã–ffne NoShow-Rechnung fÃ¼r:', rideId);
            
            try {
                // Lade Fahrt
                const snapshot = await db.ref(`rides/${rideId}`).once('value');
                const ride = snapshot.val();
                
                if (!ride) {
                    alert('ğŸ’¾ Fahrt nicht gefunden!');
                    return;
                }
                
                // Lade Kunde
                let customer = null;
                if (ride.customerId) {
                    const customerSnapshot = await db.ref(`customers/${ride.customerId}`).once('value');
                    customer = customerSnapshot.val();
                }
                
                noShowRideData = ride;
                noShowCustomerData = customer;
                
                // Berechne Standard-Werte
                const distance = parseFloat(ride.distance) || 0;
                const anfahrtKm = distance > 0 ? (distance / 2).toFixed(1) : '0.0'; // Halbe Strecke als Anfahrt
                const grundgebuehr = 5.00;
                const anfahrtEuro = distance > 0 ? ((distance / 2) * 2.50).toFixed(2) : '0.00'; // 2.50â‚¬ pro km
                const wartezeitMin = 10;
                const wartezeitEuro = (wartezeitMin * 0.50).toFixed(2); // 0.50â‚¬ pro Min
                
                const gesamt = (parseFloat(grundgebuehr) + parseFloat(anfahrtEuro) + parseFloat(wartezeitEuro)).toFixed(2);
                
                // Zahlungsziel: 14 Tage
                const zahlungsziel = new Date();
                zahlungsziel.setDate(zahlungsziel.getDate() + 14);
                
                const modal = document.createElement('div');
                modal.id = 'noshow-invoice-modal';
                modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:99999;padding:20px;';
                
                modal.innerHTML = `
                    <div style="background:white;border-radius:16px;max-width:700px;width:100%;max-height:90vh;overflow-y:auto;">
                        <div style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:20px;border-radius:16px 16px 0 0;position:sticky;top:0;z-index:10;">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <h3 style="margin:0;font-size:20px;">ğŸ“ NoShow-Rechnung erstellen</h3>
                                <button onclick="closeNoShowInvoiceModal()" 
                                    style="background:rgba(255,255,255,0.2);border:none;color:white;font-size:24px;width:32px;height:32px;border-radius:50%;cursor:pointer;">Ã—</button>
                            </div>
                        </div>
                        
                        <div style="padding:20px;">
                            <!-- KUNDE -->
                            <div style="background:#f9fafb;padding:15px;border-radius:10px;margin-bottom:20px;">
                                <div style="font-weight:700;margin-bottom:10px;color:#1f2937;">ğŸ’¾ Kunde</div>
                                <div style="margin-bottom:5px;"><strong>Name:</strong> ${ride.customerName || customer?.name || 'Unbekannt'}</div>
                                ${customer?.email ? `<div style="margin-bottom:5px;"><strong>Email:</strong> ${customer.email}</div>` : ''}
                                ${customer?.phone ? `<div style="margin-bottom:5px;"><strong>Telefon:</strong> ${customer.phone}</div>` : ''}
                                
                                ${(() => {
                                    // Rechnungsadresse
                                    if (customer?.billingAddresses && customer.billingAddresses.length > 0) {
                                        const defaultAddr = customer.billingAddresses.find(a => a.isDefault) || customer.billingAddresses[0];
                                        return `<div style="margin-top:8px;padding:8px;background:#fff;border-radius:6px;"><strong>Rechnungsadresse:</strong><br>${defaultAddr.address}</div>`;
                                    } else if (customer?.billingAddress) {
                                        return `<div style="margin-top:8px;padding:8px;background:#fff;border-radius:6px;"><strong>Rechnungsadresse:</strong><br>${customer.billingAddress}</div>`;
                                    } else if (customer?.address) {
                                        return `<div style="margin-top:8px;padding:8px;background:#fff;border-radius:6px;"><strong>Adresse:</strong><br>${customer.address}</div>`;
                                    }
                                    return '';
                                })()}
                            </div>
                            
                            <!-- BESTELLUNG -->
                            <div style="background:#fef3c7;border:2px solid #f59e0b;padding:15px;border-radius:10px;margin-bottom:20px;">
                                <div style="font-weight:700;margin-bottom:10px;color:#92400e;">ğŸ“… Bestelldetails</div>
                                
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
                                    <div>
                                        <label style="display:block;font-size:13px;color:#6b7280;margin-bottom:5px;">Bestelldatum:</label>
                                        <input type="date" id="noshow-order-date" value="${getLocalDateString(ride.createdAt || Date.now())}"
                                               style="width:100%;padding:8px;border:2px solid #f59e0b;border-radius:8px;font-size:14px;">
                                    </div>
                                    <div>
                                        <label style="display:block;font-size:13px;color:#6b7280;margin-bottom:5px;">Bestelluhrzeit:</label>
                                        <input type="time" id="noshow-order-time" value="${new Date(ride.createdAt || Date.now()).toTimeString().slice(0,5)}"
                                               style="width:100%;padding:8px;border:2px solid #f59e0b;border-radius:8px;font-size:14px;">
                                    </div>
                                </div>
                                
                                <div>
                                    <label style="display:block;font-size:13px;color:#6b7280;margin-bottom:5px;">Abholadresse:</label>
                                    <input type="text" id="noshow-pickup-address" value="${ride.pickup || ''}"
                                           style="width:100%;padding:8px;border:2px solid #f59e0b;border-radius:8px;font-size:14px;">
                                </div>
                                
                                <div style="margin-top:10px;">
                                    <label style="display:block;font-size:13px;color:#6b7280;margin-bottom:5px;">Geplante Abholzeit:</label>
                                    <input type="time" id="noshow-pickup-time" value="${new Date(ride.pickupTimestamp || Date.now()).toTimeString().slice(0,5)}"
                                           style="width:100%;padding:8px;border:2px solid #f59e0b;border-radius:8px;font-size:14px;">
                                </div>
                            </div>
                            
                            <!-- KOSTENAUFSTELLUNG -->
                            <div style="background:#fef2f2;border:2px solid #ef4444;padding:15px;border-radius:10px;margin-bottom:20px;">
                                <div style="font-weight:700;margin-bottom:15px;color:#991b1b;">ğŸ’° Kostenaufstellung</div>
                                
                                <div style="margin-bottom:10px;">
                                    <label style="display:block;font-size:13px;color:#6b7280;margin-bottom:5px;">GrundgebÃ¼hr:</label>
                                    <input type="number" id="noshow-grundgebuehr" value="${grundgebuehr}" step="0.01" min="0"
                                           onchange="updateNoShowTotal()"
                                           style="width:100%;padding:8px;border:2px solid #ef4444;border-radius:8px;font-size:14px;font-weight:600;">
                                </div>
                                
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
                                    <div>
                                        <label style="display:block;font-size:13px;color:#6b7280;margin-bottom:5px;">Anfahrt (km):</label>
                                        <input type="number" id="noshow-anfahrt-km" value="${anfahrtKm}" step="0.1" min="0"
                                               onchange="updateNoShowTotal()"
                                               style="width:100%;padding:8px;border:2px solid #ef4444;border-radius:8px;font-size:14px;font-weight:600;">
                                    </div>
                                    <div>
                                        <label style="display:block;font-size:13px;color:#6b7280;margin-bottom:5px;">Anfahrt (â‚¬):</label>
                                        <input type="number" id="noshow-anfahrt-euro" value="${anfahrtEuro}" step="0.01" min="0"
                                               onchange="updateNoShowTotal()"
                                               style="width:100%;padding:8px;border:2px solid #ef4444;border-radius:8px;font-size:14px;font-weight:600;">
                                    </div>
                                </div>
                                
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px;">
                                    <div>
                                        <label style="display:block;font-size:13px;color:#6b7280;margin-bottom:5px;">Wartezeit (Min):</label>
                                        <input type="number" id="noshow-wartezeit-min" value="${wartezeitMin}" step="1" min="0"
                                               onchange="updateNoShowTotal()"
                                               style="width:100%;padding:8px;border:2px solid #ef4444;border-radius:8px;font-size:14px;font-weight:600;">
                                    </div>
                                    <div>
                                        <label style="display:block;font-size:13px;color:#6b7280;margin-bottom:5px;">Wartezeit (â‚¬):</label>
                                        <input type="number" id="noshow-wartezeit-euro" value="${wartezeitEuro}" step="0.01" min="0"
                                               onchange="updateNoShowTotal()"
                                               style="width:100%;padding:8px;border:2px solid #ef4444;border-radius:8px;font-size:14px;font-weight:600;">
                                    </div>
                                </div>
                                
                                <div style="border-top:2px solid #ef4444;padding-top:15px;">
                                    <div style="display:flex;justify-content:space-between;font-size:18px;font-weight:700;color:#991b1b;">
                                        <span>Gesamtbetrag:</span>
                                        <span id="noshow-total">${gesamt}â‚¬</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ZAHLUNGSZIEL -->
                            <div style="background:#f0fdf4;border:2px solid #10b981;padding:15px;border-radius:10px;margin-bottom:20px;">
                                <div style="font-weight:700;margin-bottom:10px;color:#048257;">ğŸ“† Zahlungsziel</div>
                                <input type="date" id="noshow-payment-deadline" value="${getLocalDateString(zahlungsziel)}"
                                       style="width:100%;padding:8px;border:2px solid #10b981;border-radius:8px;font-size:14px;font-weight:600;">
                                <div style="font-size:12px;color:#6b7280;margin-top:5px;">Standard: 14 Tage ab heute</div>
                            </div>
                            
                            <!-- BUTTONS -->
                            <div style="display:flex;gap:10px;">
                                <button onclick="generateNoShowPDF()" 
                                        style="flex:1;padding:15px;background:linear-gradient(135deg,#f59e0b,#d97706);color:white;border:none;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;transition:all 0.3s;">
                                    ğŸ“¥ NoShow-PDF erstellen
                                </button>
                                <button onclick="closeNoShowInvoiceModal()" 
                                        style="flex:0.3;padding:15px;background:#6b7280;color:white;border:none;border-radius:10px;font-weight:600;cursor:pointer;">
                                    Abbrechen
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Ã–ffnen NoShow-Modal:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        function closeNoShowInvoiceModal() {
            const modal = document.getElementById('noshow-invoice-modal');
            if (modal) modal.remove();
            noShowRideData = null;
            noShowCustomerData = null;
        }
        
        function updateNoShowTotal() {
            const grundgebuehr = parseFloat(document.getElementById('noshow-grundgebuehr').value) || 0;
            const anfahrtEuro = parseFloat(document.getElementById('noshow-anfahrt-euro').value) || 0;
            const wartezeitEuro = parseFloat(document.getElementById('noshow-wartezeit-euro').value) || 0;
            
            const total = grundgebuehr + anfahrtEuro + wartezeitEuro;
            document.getElementById('noshow-total').textContent = total.toFixed(2) + 'â‚¬';
        }
        
        async function generateNoShowPDF() {
            try {
                // Hole Werte aus Modal
                const orderDate = document.getElementById('noshow-order-date').value;
                const orderTime = document.getElementById('noshow-order-time').value;
                const pickupAddress = document.getElementById('noshow-pickup-address').value;
                const pickupTime = document.getElementById('noshow-pickup-time').value;
                
                const grundgebuehr = parseFloat(document.getElementById('noshow-grundgebuehr').value) || 0;
                const anfahrtKm = parseFloat(document.getElementById('noshow-anfahrt-km').value) || 0;
                const anfahrtEuro = parseFloat(document.getElementById('noshow-anfahrt-euro').value) || 0;
                const wartezeitMin = parseFloat(document.getElementById('noshow-wartezeit-min').value) || 0;
                const wartezeitEuro = parseFloat(document.getElementById('noshow-wartezeit-euro').value) || 0;
                const paymentDeadline = document.getElementById('noshow-payment-deadline').value;
                
                const gesamt = grundgebuehr + anfahrtEuro + wartezeitEuro;
                
                const ride = noShowRideData;
                const customer = noShowCustomerData;
                
                // Hole Rechnungsnummer
                const invoiceNumber = await getNextNoShowInvoiceNumber();
                const invoiceDate = new Date(); // ğŸ› FIX: invoiceDate definieren!
                
                console.log('ğŸ“ Erstelle NoShow-PDF:', invoiceNumber);
                
                // Erstelle PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // HEADER - Firmendaten
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Funk Taxi Heringsdorf', 20, 20);
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('Patrick Wydra', 20, 26);
                doc.text('Amselring 10 â€¢ 17424 Ostseebad Heringsdorf', 20, 31);
                doc.text('Tel: 038378 22022 â€¢ Mobil: 0151 27585179', 20, 36);
                
                // KUNDENADRESSE
                let yPos = 50;
                doc.setFont(undefined, 'bold');
                doc.text(ride.customerName || customer?.name || 'Unbekannt', 20, yPos);
                doc.setFont(undefined, 'normal');
                
                // Rechnungsadresse
                let billingAddr = '';
                if (customer?.billingAddresses && customer.billingAddresses.length > 0) {
                    const defaultAddr = customer.billingAddresses.find(a => a.isDefault) || customer.billingAddresses[0];
                    billingAddr = defaultAddr.address;
                } else if (customer?.billingAddress) {
                    billingAddr = customer.billingAddress;
                } else if (customer?.address) {
                    billingAddr = customer.address;
                }
                
                if (billingAddr) {
                    yPos += 5;
                    const addrLines = doc.splitTextToSize(billingAddr, 80);
                    doc.text(addrLines, 20, yPos);
                    yPos += addrLines.length * 5;
                }
                
                // RECHNUNGSNUMMER & DATUM
                yPos += 10;
                doc.setFont(undefined, 'bold');
                doc.text(`Rechnungsnummer: ${invoiceNumber}`, 20, yPos);
                doc.text(`Datum: ${invoiceDate.toLocaleDateString('de-DE')}`, 120, yPos);
                
                // TITEL
                yPos += 10;
                doc.setFontSize(12);
                doc.text('Rechnung -- EntschÃ¤digung wegen Nichterscheinen (No-Show)', 20, yPos);
                
                // ANREDE
                yPos += 10;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Sehr geehrte/r ${ride.customerName || customer?.name || 'Kunde'},`, 20, yPos);
                
                // TEXT
                yPos += 8;
                const orderDateFormatted = new Date(orderDate).toLocaleDateString('de-DE');
                doc.text(`Sie haben am ${orderDateFormatted} um ${orderTime} Uhr ein Taxi zur Abholung an`, 20, yPos);
                yPos += 5;
                doc.text(`folgender Adresse bestellt:`, 20, yPos);
                
                yPos += 8;
                doc.setFont(undefined, 'bold');
                doc.text(pickupAddress, 30, yPos);
                doc.setFont(undefined, 'normal');
                
                yPos += 8;
                doc.text(`Unser Fahrzeug war pÃ¼nktlich um ${pickupTime} Uhr vor Ort. Trotz telefonischer`, 20, yPos);
                yPos += 5;
                doc.text(`Kontaktversuche und einer Wartezeit von ${wartezeitMin} Minuten sind Sie nicht erschienen`, 20, yPos);
                yPos += 5;
                doc.text(`und haben die Fahrt nicht in Anspruch genommen.`, 20, yPos);
                
                // KOSTENAUFSTELLUNG
                yPos += 12;
                doc.setFont(undefined, 'bold');
                doc.text('Kostenaufstellung:', 20, yPos);
                
                yPos += 2;
                doc.setDrawColor(200);
                doc.line(20, yPos, 190, yPos);
                
                yPos += 8;
                doc.setFont(undefined, 'bold');
                doc.text('Position', 20, yPos);
                doc.text('Menge', 100, yPos);
                doc.text('Betrag', 160, yPos, { align: 'right' });
                
                yPos += 2;
                doc.line(20, yPos, 190, yPos);
                
                yPos += 6;
                doc.setFont(undefined, 'normal');
                doc.text('GrundgebÃ¼hr (gem. Taxitarif)', 20, yPos);
                doc.text('1', 100, yPos);
                doc.text(`${grundgebuehr.toFixed(2)} â‚¬`, 160, yPos, { align: 'right' });
                
                yPos += 6;
                doc.text('Anfahrt zum Abholort', 20, yPos);
                doc.text(`${anfahrtKm.toFixed(1)} km`, 100, yPos);
                doc.text(`${anfahrtEuro.toFixed(2)} â‚¬`, 160, yPos, { align: 'right' });
                
                yPos += 6;
                doc.text('Wartezeit vor Ort', 20, yPos);
                doc.text(`${wartezeitMin} min`, 100, yPos);
                doc.text(`${wartezeitEuro.toFixed(2)} â‚¬`, 160, yPos, { align: 'right' });
                
                yPos += 2;
                doc.line(20, yPos, 190, yPos);
                
                yPos += 6;
                doc.setFont(undefined, 'bold');
                doc.text('Gesamtbetrag', 100, yPos);
                doc.text(`${gesamt.toFixed(2)} â‚¬`, 160, yPos, { align: 'right' });
                
                // RECHTLICHE GRUNDLAGE
                yPos += 12;
                doc.setFont(undefined, 'bold');
                doc.text('Rechtliche Grundlage:', 20, yPos);
                
                yPos += 6;
                doc.setFont(undefined, 'normal');
                const legalText1 = doc.splitTextToSize(
                    'Mit Ihrer Bestellung ist ein BefÃ¶rderungsvertrag (Werkvertrag) zustande gekommen. Da Sie Ihrer Mitwirkungspflicht -- nÃ¤mlich am vereinbarten Ort zur Abholung bereit zu stehen -- nicht nachgekommen sind, steht mir gemÃ¤ÃŸ Â§Â§ 642, 643 BGB ein EntschÃ¤digungsanspruch zu.',
                    170
                );
                doc.text(legalText1, 20, yPos);
                yPos += legalText1.length * 5;
                
                yPos += 3;
                const legalText2 = doc.splitTextToSize(
                    'Dieser Anspruch umfasst die VergÃ¼tung fÃ¼r die bereits erbrachte Teilleistung (Anfahrt) sowie eine EntschÃ¤digung dafÃ¼r, dass ich meine Arbeitskraft und mein Fahrzeug bereitgehalten habe und meine zeitliche Disposition durchkreuzt wurde (vgl. AG Siegen, Urteil vom 19.11.2001).',
                    170
                );
                doc.text(legalText2, 20, yPos);
                yPos += legalText2.length * 5;
                
                // ZAHLUNGSMODALITÃ„TEN
                yPos += 8;
                doc.setFont(undefined, 'bold');
                doc.text('ZahlungsmodalitÃ¤ten:', 20, yPos);
                
                yPos += 6;
                doc.setFont(undefined, 'normal');
                const paymentDeadlineFormatted = new Date(paymentDeadline).toLocaleDateString('de-DE');
                doc.text(`Bitte Ã¼berweisen Sie den Gesamtbetrag von ${gesamt.toFixed(2)} â‚¬ bis zum ${paymentDeadlineFormatted}`, 20, yPos);
                yPos += 5;
                doc.text('auf folgendes Konto:', 20, yPos);
                
                yPos += 8;
                doc.text('Kontoinhaber: Patrick Wydra', 30, yPos);
                yPos += 5;
                doc.text('IBAN: DE16 1309 1054 0001 5524 90', 30, yPos);
                yPos += 5;
                doc.text('BIC: GENODEF1HST', 30, yPos);
                yPos += 5;
                doc.text(`Verwendungszweck: Rechnung ${invoiceNumber}`, 30, yPos);
                
                yPos += 8;
                doc.text('Bei Nichtzahlung behalte ich mir vor, die Forderung gerichtlich geltend zu machen,', 20, yPos);
                yPos += 5;
                doc.text('was fÃ¼r Sie mit weiteren Kosten verbunden wÃ¤re.', 20, yPos);
                
                // GRUÃŸ
                yPos += 10;
                doc.text('Mit freundlichen GrÃ¼ÃŸen', 20, yPos);
                yPos += 8;
                doc.text('Patrick Wydra', 20, yPos);
                yPos += 5;
                doc.text('Funk Taxi Heringsdorf', 20, yPos);
                
                // Speichere in Firebase
                const noShowData = {
                    invoiceNumber: invoiceNumber,
                    rideId: ride.id || ride.firebaseId,
                    customerName: ride.customerName || customer?.name,
                    customerId: ride.customerId || null,
                    date: Date.now(),
                    orderDate: orderDate,
                    orderTime: orderTime,
                    pickupAddress: pickupAddress,
                    pickupTime: pickupTime,
                    grundgebuehr: grundgebuehr,
                    anfahrtKm: anfahrtKm,
                    anfahrtEuro: anfahrtEuro,
                    wartezeitMin: wartezeitMin,
                    wartezeitEuro: wartezeitEuro,
                    gesamt: gesamt,
                    paymentDeadline: paymentDeadline
                };
                
                await db.ref(`noShowInvoices/${invoiceNumber}`).set(noShowData);
                console.log('âœ… NoShow-Rechnung in Firebase gespeichert:', invoiceNumber);
                
                // PDF herunterladen
                doc.save(`NoShow-Rechnung_${invoiceNumber}_${new Date().toLocaleDateString('de-DE').replace(/\./g, '_')}.pdf`);
                
                alert(`âœ… NoShow-Rechnung ${invoiceNumber} erstellt und heruntergeladen!`);
                
                closeNoShowInvoiceModal();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Erstellen der NoShow-Rechnung:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        async function getNextNoShowInvoiceNumber() {
            try {
                const currentYear = new Date().getFullYear();
                
                // Lade Counter fÃ¼r aktuelles Jahr
                const snapshot = await db.ref(`noShowInvoiceCounter/${currentYear}`).once('value');
                let counter = snapshot.val() || 0;
                
                counter++;
                
                // Speichere neue Nummer fÃ¼r dieses Jahr
                await db.ref(`noShowInvoiceCounter/${currentYear}`).set(counter);
                
                // Format: 20-26-NS-001, 20-26-NS-002, etc.
                const shortYear = String(currentYear).substring(2); // 2026 â†’ 26
                const paddedCounter = String(counter).padStart(3, '0');
                return `20-${shortYear}-NS-${paddedCounter}`;
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Abrufen der NoShow-Rechnungsnummer:', error);
                const year = new Date().getFullYear();
                const shortYear = String(year).substring(2);
                return `20-${shortYear}-NS-${Date.now()}`;
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // ğŸ†• Helper: Format fÃ¼r datetime-local Input
        function formatForDatetimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        
        // ğŸ†• v5.90.123: ZIFFERNBLOCK FÃœR QUICK-BOOKING MODAL
        function openQuickBookingTimeKeypad() {
            const timeBtn = document.getElementById('quick-booking-time-btn');
            const timeInput = document.getElementById('quick-booking-time');
            
            const currentTime = timeBtn ? timeBtn.textContent.trim() : '09:00';
            
            console.log('âŒ¨ï¸ Ã–ffne Ziffernblock fÃ¼r Quick-Booking:', currentTime);
            
            showTimeKeypad(currentTime, (newTime) => {
                console.log('âœ… Zeit gewÃ¤hlt:', newTime);
                
                if (timeBtn) timeBtn.textContent = newTime;
                if (timeInput) timeInput.value = newTime;
                
                console.log('ğŸ“± Quick-Booking Zeit gesetzt:', newTime);
            });
        }
        
        async function submitQuickBooking() {
            // ğŸ”’ v5.64.16: DOPPELKLICK-SCHUTZ!
            if (window.isSubmittingQuickBooking) {
                console.log('âš ï¸ Submit bereits in Bearbeitung - ignoriere Klick');
                return;
            }
            
            window.isSubmittingQuickBooking = true;
            console.log('ğŸ”’ Submit gesperrt (Doppelklick-Schutz)');
            
            try {
                const customerId = document.getElementById('quick-booking-customer').value;
                
                // ğŸ†• v5.65.4: Kombiniere separate Datum + Zeit Felder
                const dateValue = document.getElementById('quick-booking-date').value;
                const timeValue = document.getElementById('quick-booking-time').value;
                const datetime = dateValue && timeValue ? `${dateValue}T${timeValue}` : '';
                console.log('ğŸ“… Kombiniertes Datum/Zeit:', datetime);
                
                const pickup = document.getElementById('quick-booking-pickup').value;
                const destination = document.getElementById('quick-booking-destination').value;
                const passengers = parseInt(document.getElementById('quick-booking-passengers').value);
                const vehicle = document.getElementById('quick-booking-vehicle').value;
                const notes = document.getElementById('quick-booking-notes').value;
                
                // ğŸ†• v5.84.1: ERWEITERTE KUNDEN-VALIDIERUNG
                // Hole Suchfeld-Wert (kÃ¶nnte Name oder Telefonnummer sein)
                const searchField = document.getElementById('quick-booking-customer-search');
                const searchValue = searchField ? searchField.value.trim() : '';
                
                // Fall 1: Kein Kunde ausgewÃ¤hlt UND Suchfeld leer
                if (!customerId && !searchValue) {
                    alert('ğŸ’¾ Bitte Kunde auswÃ¤hlen oder Telefonnummer/Name eingeben!');
                    return;
                }
                
                // Fall 2: Kein Kunde ausgewÃ¤hlt ABER Suchfeld hat Wert
                // â†’ PrÃ¼fe ob es eine Telefonnummer ist
                let isNewPhoneCustomer = false;
                let newCustomerPhone = '';
                let newCustomerName = '';
                
                if (!customerId && searchValue) {
                    // PrÃ¼fe ob Suchfeld eine Telefonnummer ist (nur Zahlen/+/Leerzeichen)
                    const phonePattern = /^[\d\s\+\-\(\)]+$/;
                    
                    if (phonePattern.test(searchValue)) {
                        // Nur Telefonnummer â†’ Frage nach Name!
                        alert('âš ï¸ Bitte Namen eingeben!\n\nGebe statt der Telefonnummer den Namen des Kunden ein.\nDie Telefonnummer wird automatisch gespeichert.');
                        searchField.focus();
                        return;
                    } else {
                        // Text (Name) â†’ Erstelle neuen Kunden
                        
                        // ğŸ†• v5.86.15: PRÃœFE ZUERST window.aiBookingPhone (von AI-Assistent)
                        if (window.aiBookingPhone) {
                            isNewPhoneCustomer = true;
                            newCustomerPhone = window.aiBookingPhone;
                            newCustomerName = searchValue;
                            console.log('ğŸ¤– AI-Buchung: Neuer Kunde mit Telefon:', newCustomerPhone, 'â†’', newCustomerName);
                        } else {
                            // PrÃ¼fe ob es einen versteckten Phone-Wert gibt
                            const hiddenCustomer = allCustomers.find(c => c.id === 'new');
                            if (hiddenCustomer && hiddenCustomer.phone) {
                                isNewPhoneCustomer = true;
                                newCustomerPhone = hiddenCustomer.phone;
                                newCustomerName = searchValue;
                                console.log('ğŸ†• Neuer Kunde aus Telefon:', newCustomerPhone, 'â†’', newCustomerName);
                            } else {
                                alert('ğŸ’¾ Kunde nicht gefunden!\n\nBitte wÃ¤hle einen Kunden aus der Liste oder gebe eine Telefonnummer ein.');
                                return;
                            }
                        }
                    }
                }
                
                // Validierung - Rest
                if (!datetime) {
                    alert('ğŸ’¾ Bitte Datum & Zeit eingeben!');
                    return;
                }
                if (!pickup) {
                    alert('ğŸ’¾ Bitte Abholort eingeben!');
                    return;
                }
                if (!destination) {
                    alert('ğŸ’¾ Bitte Zielort eingeben!');
                    return;
                }
                
                // ğŸ†• v5.84.1: NEUER KUNDE AUS TELEFON â†’ SPEICHERN!
                let finalCustomerId = customerId;
                let finalCustomer = null;
                
                if (isNewPhoneCustomer) {
                    console.log('ğŸ†• Neuer Kunde aus Telefon - speichere ins CRM...');
                    console.log('ğŸ’¾ Telefon:', newCustomerPhone);
                    console.log('ğŸ’¾ Name:', newCustomerName);
                    console.log('ğŸ“ Adresse:', pickup); // ğŸ†• v5.87.73
                    
                    try {
                        // ğŸ†• v5.90.275: NORMALISIERE TELEFONNUMMER!
                        const normalizedPhone = normalizePhoneNumber(newCustomerPhone);
                        
                        // Speichere Kunde in Firebase CRM
                        const newCustomerRef = db.ref('customers').push();
                        await newCustomerRef.set({
                            name: newCustomerName,
                            phone: normalizedPhone, // âœ… Normalisiert!
                            address: pickup || '', // ğŸ†• v5.87.73: ADRESSE SPEICHERN!
                            email: '',
                            createdAt: firebase.database.ServerValue.TIMESTAMP,
                            createdBy: 'quick-booking-phone',
                            source: 'phone-number'
                        });
                        
                        finalCustomerId = newCustomerRef.key;
                        console.log('âœ… Neuer Kunde gespeichert:', finalCustomerId, '-', newCustomerName, '-', pickup);
                        
                        // Create finalCustomer
                        finalCustomer = {
                            id: finalCustomerId,
                            name: newCustomerName,
                            phone: normalizedPhone, // âœ… Normalisiert!
                            address: pickup || '', // ğŸ†• v5.87.73
                            email: ''
                        };
                        
                        // Update allCustomers Array
                        allCustomers.push(finalCustomer);
                        
                        // Update Anrufhistorie falls vorhanden
                        const callHistorySnapshot = await db.ref('callHistory')
                            .orderByChild('caller')
                            .equalTo(newCustomerPhone)
                            .once('value');
                        
                        if (callHistorySnapshot.exists()) {
                            const updates = {};
                            callHistorySnapshot.forEach(child => {
                                updates[child.key + '/customerId'] = finalCustomerId;
                                updates[child.key + '/customerName'] = newCustomerName;
                            });
                            await db.ref('callHistory').update(updates);
                            console.log('âœ… Anrufhistorie aktualisiert mit neuem Kunden');
                        }
                        
                    } catch (error) {
                        console.error('ğŸ’¾ Fehler beim Speichern:', error);
                        alert('ğŸ’¾ Fehler beim Speichern des Kunden:\n\n' + error.message);
                        return;
                    }
                } else {
                    // Normaler Flow: Kunde aus customerId laden
                    const customer = allCustomers.find(c => c.id === customerId);
                    if (!customer) {
                        alert('ğŸ’¾ Kunde nicht gefunden!');
                        return;
                    }
                    
                    finalCustomer = customer;
                }
                
                // ğŸ†• v5.73.0: NEUER KUNDE (isNew) â†’ INS CRM SPEICHERN!
                if (finalCustomer && finalCustomer.isNew) {
                    console.log('ğŸ†• Neuer Kunde erkannt - speichere ins CRM...');
                    console.log('ğŸ“ Adresse:', pickup);
                    
                    // Hole Name aus dem Suchfeld
                    const searchField = document.getElementById('quick-booking-customer-search');
                    let customerName = searchField ? searchField.value.trim() : '';
                    
                    // ğŸ†• v5.88.20: Gastname ist NUR ein Info-Feld - NICHT fÃ¼r Kunden-Anlage verwenden!
                    // Der Gastname wird spÃ¤ter nur in der Fahrt gespeichert, nicht als Kunde.
                    
                    // Wenn Kundenname leer â†’ Frage nach dem AUFTRAGGEBER (nicht Fahrgast!)
                    if (!customerName) {
                        customerName = prompt(
                            'ğŸ’¾ Wer ist der AUFTRAGGEBER?\n\n' +
                            'ğŸ’¾ Telefon: ' + finalCustomer.phone + '\n\n' +
                            'ğŸ’¡ Das ist der Kunde der die Rechnung bekommt!\n' +
                            '(z.B. Hotel-Name, Firmenname, oder Privatperson)\n\n' +
                            'âš ï¸ NICHT den Fahrgast-Namen eingeben!'
                        );
                        if (!customerName || !customerName.trim()) {
                            alert('ğŸ’¾ Kundenname ist erforderlich!');
                            return;
                        }
                        customerName = customerName.trim();
                    }
                    
                    try {
                        // ğŸ†• v5.90.275: NORMALISIERE TELEFONNUMMER!
                        const normalizedPhone = normalizePhoneNumber(finalCustomer.phone);
                        
                        // Speichere Kunde in Firebase CRM
                        const newCustomerRef = db.ref('customers').push();
                        await newCustomerRef.set({
                            name: customerName,
                            phone: normalizedPhone, // âœ… Normalisiert!
                            address: pickup || '', // ğŸ†• v5.87.73: ADRESSE SPEICHERN!
                            email: '',
                            createdAt: firebase.database.ServerValue.TIMESTAMP,
                            createdBy: 'quick-booking',
                            source: 'call-booking'
                        });
                        
                        finalCustomerId = newCustomerRef.key;
                        console.log('âœ… Neuer Kunde gespeichert:', finalCustomerId, '-', customerName, '-', pickup);
                        
                        // Update finalCustomer
                        finalCustomer = {
                            id: finalCustomerId,
                            name: customerName,
                            phone: normalizedPhone, // âœ… Normalisiert!
                            address: pickup || '', // ğŸ†• v5.87.73
                            email: ''
                        };
                        
                        // Update allCustomers Array
                        allCustomers.push(finalCustomer);
                        
                        // ğŸ†• v5.73.0: UPDATE ANRUFHISTORIE!
                        const callHistorySnapshot = await db.ref('callHistory')
                            .orderByChild('caller')
                            .equalTo(finalCustomer.phone)
                            .once('value');
                        
                        if (callHistorySnapshot.exists()) {
                            const updates = {};
                            callHistorySnapshot.forEach(child => {
                                updates[`callHistory/${child.key}/customerFound`] = true;
                                updates[`callHistory/${child.key}/customerName`] = customerName;
                                updates[`callHistory/${child.key}/customerId`] = finalCustomerId;
                            });
                            await db.ref().update(updates);
                            console.log('âœ… Anrufhistorie aktualisiert!');
                        }
                        
                    } catch (err) {
                        console.error('ğŸ’¾ Fehler beim Speichern des Kunden:', err);
                        alert('ğŸ’¾ Fehler beim Speichern: ' + err.message);
                        return;
                    }
                }
                
                // ğŸ†• v5.90.106: LESE OPTIONEN AUS - Radio Buttons!
                const priceMode = document.querySelector('input[name="quick-booking-price-mode"]:checked').value;
                const shouldCalculatePrice = (priceMode === 'taxi'); // true wenn Taxi, false wenn medical
                const durationMode = document.querySelector('input[name="quick-booking-duration-mode"]:checked').value;
                console.log('ğŸ’° Preis-Modus:', priceMode, 'â†’ Berechnen?', shouldCalculatePrice);
                console.log('â±ï¸ Dauer-Modus:', durationMode);
                
                // ğŸ†• v5.64.25: AUTO-GEOCODE WENN COORDS FEHLEN!
                if (!quickBookingPickupCoords || !quickBookingDestCoords) {
                    console.log('âš ï¸ Koordinaten fehlen - versuche Auto-Geocode...');
                    
                    // Versuche Adressen zu geocoden
                    const tasks = [];
                    if (!quickBookingPickupCoords && pickup) {
                        tasks.push(
                            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(pickup)}&countrycodes=de&viewbox=10.6,54.7,14.4,53.1&bounded=1&limit=1`)
                                .then(r => r.json())
                                .then(results => {
                                    if (results.length > 0) {
                                        quickBookingPickupCoords = { lat: parseFloat(results[0].lat), lon: parseFloat(results[0].lon) };
                                        console.log('âœ… Abholort geocoded:', quickBookingPickupCoords);
                                    }
                                })
                        );
                    }
                    if (!quickBookingDestCoords && destination) {
                        tasks.push(
                            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(destination)}&countrycodes=de&viewbox=10.6,54.7,14.4,53.1&bounded=1&limit=1`)
                                .then(r => r.json())
                                .then(results => {
                                    if (results.length > 0) {
                                        quickBookingDestCoords = { lat: parseFloat(results[0].lat), lon: parseFloat(results[0].lon) };
                                        console.log('âœ… Zielort geocoded:', quickBookingDestCoords);
                                    }
                                })
                        );
                    }
                    
                    if (tasks.length > 0) {
                        const toast = document.createElement('div');
                        toast.style.cssText = 'position:fixed;top:20px;right:20px;background:#3b82f6;color:white;padding:15px 20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:99999;font-weight:600;';
                        toast.innerHTML = 'ğŸ—ºï¸ Suche Koordinaten...';
                        document.body.appendChild(toast);
                        
                        await Promise.all(tasks);
                        toast.remove();
                    }
                    
                    // PrÃ¼fe erneut
                    if (!quickBookingPickupCoords || !quickBookingDestCoords) {
                        alert('ğŸ’¾ Koordinaten konnten nicht gefunden werden!\n\nğŸ’¡ Tipp: WÃ¤hle Adressen aus dem Dropdown (erscheint beim Tippen).');
                        return;
                    }
                }
                
                // ğŸ†• v5.48.2: BERECHNE ROUTE + PREIS!
                console.log('ğŸ’° Berechne Route fÃ¼r Schnellbuchung...');
                let routeData;
                try {
                    routeData = await calculateRoute(quickBookingPickupCoords, quickBookingDestCoords);
                    console.log('âœ… Route berechnet:', routeData);
                    
                    // ğŸ†• v5.64.18: PREIS-BERECHNUNG OPTIONAL!
                    const pickupTimestamp = new Date(datetime).getTime();
                    if (shouldCalculatePrice) {
                        // PREIS BERECHNEN!
                        const pricing = calculatePrice(parseFloat(routeData.distance), pickupTimestamp);
                        routeData.price = pricing.total;
                        console.log('âœ… Preis berechnet:', pricing.total, 'â‚¬');
                        
                        // Validierung
                        if (!routeData.price || routeData.price <= 0 || isNaN(routeData.price)) {
                            console.error('ğŸ’¾ KRITISCHER FEHLER: UngÃ¼ltiger Preis!', routeData.price);
                            alert('ğŸ’¾ FEHLER: Preis konnte nicht berechnet werden!\n\nBitte Ã¼berprÃ¼fe die Adressen.');
                            return;
                        }
                    } else {
                        // KEIN PREIS! (z.B. Krankenfahrt)
                        routeData.price = 0;
                        console.log('â„¹ï¸ Preis-Berechnung deaktiviert â†’ 0 â‚¬');
                    }
                    
                    // ğŸ†• v5.64.18: ZEIT-BERECHNUNG OPTIONAL!
                    if (durationMode === 'fixed') {
                        // FESTE ZEIT: 15 Minuten
                        routeData.duration = 15;
                        console.log('â±ï¸ Feste Dauer: 15 Min');
                    } else {
                        // Dauer aus Route (bereits berechnet)
                        console.log('â±ï¸ Berechnete Dauer:', routeData.duration, 'Min');
                    }
                    
                } catch (error) {
                    console.error('ğŸ’¾ Fehler bei Routenberechnung:', error);
                    alert('ğŸ’¾ Fehler bei Routenberechnung!\n\nBitte versuche es erneut.');
                    return;
                }
                
                // Erstelle Fahrt
                const pickupDate = new Date(datetime);
                const pickupTimestamp = pickupDate.getTime();
                
                // ğŸ†• v5.90.81: STELLE SICHER DASS customerPhone GESETZT IST!
                let finalCustomerPhone = finalCustomer.phone || '';
                
                // Falls kein Phone im Objekt, hole es aus Firebase customers
                if (!finalCustomerPhone && finalCustomerId) {
                    try {
                        const customerSnapshot = await db.ref('customers/' + finalCustomerId).once('value');
                        const customerData = customerSnapshot.val();
                        if (customerData && customerData.phone) {
                            finalCustomerPhone = customerData.phone;
                            console.log('âœ… customerPhone aus Firebase /customers geholt:', finalCustomerPhone);
                        }
                    } catch (error) {
                        console.warn('âš ï¸ Konnte customerPhone nicht aus /customers holen:', error);
                    }
                }
                
                // ğŸ†• v5.90.82: FALLBACK - Suche in /users nach Kundenname!
                if (!finalCustomerPhone && finalCustomer.name) {
                    try {
                        console.log('ğŸ” Suche User mit Name:', finalCustomer.name);
                        const usersSnapshot = await db.ref('users').orderByChild('displayName').equalTo(finalCustomer.name).limitToFirst(1).once('value');
                        if (usersSnapshot.exists()) {
                            usersSnapshot.forEach(userSnapshot => {
                                const userData = userSnapshot.val();
                                if (userData && userData.phone) {
                                    finalCustomerPhone = userData.phone;
                                    console.log('âœ… customerPhone aus /users geholt:', finalCustomerPhone);
                                }
                            });
                        } else {
                            console.log('â„¹ï¸ Kein User mit Name gefunden:', finalCustomer.name);
                        }
                    } catch (error) {
                        console.warn('âš ï¸ Konnte customerPhone nicht aus /users holen:', error);
                    }
                }
                
                // ğŸ†• v5.90.85: FINDE userId FÃœR "MEINE FAHRTEN"!
                const userId = await findUserIdForCustomer(finalCustomer.name, finalCustomerPhone);
                
                if (!userId) {
                    console.warn('âš ï¸ WARNUNG: Keine userId gefunden fÃ¼r', finalCustomer.name);
                    console.warn('   Fahrt wird gespeichert, aber erscheint NICHT in "Meine Fahrten"');
                    console.warn('   LÃ–SUNG: Kunde muss sich einmal in App einloggen!');
                }
                
                // ğŸ†• v5.90.305: INTELLIGENTE STATUS-LOGIK!
                const now = Date.now();
                const minutesUntilPickup = (pickupTimestamp - now) / 60000;
                
                let rideStatus;
                let assignmentInfo = {};
                
                if (vehicle) {
                    // MANUELL ZUGEWIESEN â†’ Status: "assigned" (NICHT "accepted"!)
                    rideStatus = 'assigned';
                    assignmentInfo = {
                        vehicle: vehicle,
                        vehicleAssignedAt: Date.now(),
                        vehicleAssignedBy: currentUser?.name || 'admin',
                        assignmentMethod: 'manual'
                    };
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    console.log('âœ… MANUELL ZUGEWIESEN');
                    console.log('   Status: assigned (Fahrer hat NICHT bestÃ¤tigt!)');
                    console.log('   Fahrzeug:', vehicle);
                    console.log('   Zeit bis Abholung:', Math.round(minutesUntilPickup), 'Min');
                    console.log('   Fahrer sieht ab:', minutesUntilPickup <= 30 ? 'JETZT' : '30 Min vorher');
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                } else {
                    // KEIN FAHRZEUG â†’ Auto-Assign oder Vorbestellung
                    if (minutesUntilPickup < 30) {
                        // SOFORT-FAHRT â†’ Auto-Assign lÃ¤uft gleich!
                        rideStatus = 'new';
                        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                        console.log('âš¡ SOFORT-FAHRT ERKANNT');
                        console.log('   Status: new');
                        console.log('   Zeit bis Abholung:', Math.round(minutesUntilPickup), 'Min');
                        console.log('   Auto-Assign: LÃ¤uft nach Speichern!');
                        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    } else {
                        // VORBESTELLUNG â†’ Scheduler aktiviert spÃ¤ter
                        rideStatus = 'vorbestellt';
                        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                        console.log('â° VORBESTELLUNG ERKANNT');
                        console.log('   Status: vorbestellt');
                        console.log('   Zeit bis Abholung:', Math.round(minutesUntilPickup), 'Min');
                        console.log('   Scheduler aktiviert in:', Math.round(minutesUntilPickup - 30), 'Min');
                        console.log('   Dann: Auto-Assign lÃ¤uft automatisch');
                        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    }
                }
                
                // ğŸ†• v5.90.559: SAMMLE ZWISCHENZIELE!
                const waypointsData = qbWaypoints.map(wp => ({
                    address: wp.address,
                    coords: wp.coords
                }));
                
                if (waypointsData.length > 0) {
                    console.log('ğŸ›‘ Quick-Booking mit', waypointsData.length, 'Zwischenzielen:', waypointsData);
                }
                
                const ride = {
                    userId: userId || null, // ğŸ†• v5.90.85: AUTH-UID FÃœR "MEINE FAHRTEN"!
                    customerName: finalCustomer.name || 'Unbekannt',
                    customerPhone: finalCustomerPhone,
                    // ğŸ†• v5.75.0: GAST-NAME (optional)
                    guestName: document.getElementById('quick-booking-guest-name')?.value?.trim() || '',
                    // ğŸ†• v5.88.21: GAST-TELEFON (optional) - nur Info!
                    guestPhone: document.getElementById('quick-booking-guest-phone')?.value?.trim() || '',
                    pickup: pickup,
                    destination: destination,
                    // ğŸ†• v5.90.559: ZWISCHENZIELE!
                    waypoints: waypointsData.length > 0 ? waypointsData : null,
                    timestamp: pickupTimestamp, // ğŸ”§ v5.90.344: FÃœR FAHRER-VIEW FILTER!
                    pickupTimestamp: pickupTimestamp,
                    pickupTime: pickupDate.toISOString(), // ğŸ”§ v5.39.8: FIX - Auch als ISO String!
                    passengers: passengers,
                    createdAt: Date.now(),
                    status: rideStatus, // ğŸ†• v5.90.305: Intelligente Status-Logik!
                    bookedBy: 'admin',
                    notes: notes || '',
                    customerId: finalCustomerId,
                    pickupCoords: quickBookingPickupCoords, // ğŸ”§ v5.39.8: FIX - Koordinaten!
                    destCoords: quickBookingDestCoords, // ğŸ”§ v5.39.8: FIX - Koordinaten!
                    // ğŸ†• v5.48.2: PREIS, DISTANZ, DAUER!
                    price: routeData.price,
                    distance: routeData.distance,
                    duration: routeData.duration,
                    // ğŸ†• v5.86.15: Unterscheide AI-Buchung von Admin-Schnellbuchung
                    bookingSource: window.aiBookingPhone ? 'ai-assistant' : 'admin-quick',
                    // ğŸ†• v5.90.305: Assignment-Info
                    ...assignmentInfo
                };
                
                // ğŸ†• v5.90.305: FAHRZEUG-INFO - Status ist bereits korrekt gesetzt!
                // Fahrzeug-Details hinzufÃ¼gen wenn ausgewÃ¤hlt
                if (vehicle) {
                    try {
                        console.log('ğŸš— Schnellbuchung: Lade Fahrzeug-Details:', vehicle);
                        
                        // Lade Fahrzeugdaten fÃ¼r lokale Ride-Objekt Vorab-FÃ¼llung
                        const vehicleSnapshot = await db.ref('vehicles/' + vehicle).once('value');
                        const vehicleData = vehicleSnapshot.val();
                        
                        if (vehicleData) {
                            // Setze Fahrzeug-Details (Status bleibt "assigned"!)
                            ride.vehicleId = vehicle;
                            ride.vehicle = vehicleData.name || vehicle;
                            ride.vehicleLabel = vehicleData.name || vehicle;
                            ride.vehiclePlate = vehicleData.plate || '';
                            // ğŸ’¾ NICHT: ride.status = 'accepted' - Das macht nur der Fahrer!
                            // ğŸ’¾ NICHT: ride.acceptedAt - Das setzt nur der Fahrer!
                            
                            console.log('âœ… Fahrzeug-Details gesetzt:', vehicleData.name);
                            console.log('   Status bleibt:', ride.status);
                        } else {
                            console.warn('âš ï¸ Fahrzeugdaten nicht gefunden fÃ¼r:', vehicle);
                        }
                    } catch (error) {
                        console.error('ğŸ’¾ Fehler beim Laden der Fahrzeugdaten:', error);
                    }
                }
                
                try {
                    // Speichere in Firebase
                    const rideRef = await db.ref('rides').push(ride);
                    const rideId = rideRef.key;
                    console.log('âœ… Schnellbuchung erstellt:', rideId);
                    
                    // ğŸ†• v5.86.11: TELEGRAM AN ADMIN (wie im Panel!)
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    console.log('ğŸ“± TELEGRAM: Sende Benachrichtigung fÃ¼r Schnellbuchung...');
                    
                    try {
                        // Baue ride-Objekt fÃ¼r Telegram
                        const rideForTelegram = {
                            firebaseId: rideId,
                            id: rideId,
                            ...ride
                        };
                    
                        await sendTelegramForNewRide(rideForTelegram);
                        console.log('âœ… TELEGRAM: Benachrichtigung an Admin gesendet!');
                    } catch (error) {
                        console.error('ğŸ’¾ TELEGRAM: Fehler beim Senden:', error);
                    }
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    
                    // ğŸ†• v5.57.0: TELEGRAM AN FAHRER SENDEN (wenn Fahrzeug zugewiesen!)
                    if (vehicle && ride.status === 'accepted') {
                        try {
                            // Setze firebaseId fÃ¼r Telegram
                            ride.firebaseId = rideId;
                            
                            // ğŸ†• v5.64.43: FINDE FAHRER FÃœR FAHRZEUG!
                            console.log('ğŸ“± Suche Fahrer fÃ¼r Fahrzeug:', vehicle);
                            const driversSnapshot = await db.ref('vehicles').once('value');
                            let driverId = null;
                            
                            driversSnapshot.forEach(child => {
                                const driver = child.val();
                                if (child.key === vehicle || driver.vehicle === vehicle) {
                                    driverId = child.key;
                                    console.log('âœ… Fahrer gefunden:', driverId);
                                }
                            });
                            
                            if (driverId) {
                                await sendTelegramToDriver(driverId, ride, 0);
                                console.log('âœ… Telegram an Fahrer gesendet!');
                            } else {
                                console.warn('âš ï¸ Kein Fahrer fÃ¼r Fahrzeug:', vehicle);
                            }
                        } catch (telegramError) {
                            console.error('ğŸ’¾ Fehler beim Telegram-Versand:', telegramError);
                            // Fahrt wurde trotzdem erstellt, nur Telegram fehlgeschlagen
                        }
                    }
                    
                    // ğŸ†• v5.87.97: SMS AN KUNDEN SENDEN!
                    try {
                        ride.firebaseId = rideId;
                        await sendCustomerNotifications(ride);
                        console.log('âœ… Kunden-SMS gesendet (wenn aktiviert)');
                    } catch (smsError) {
                        console.error('ğŸ’¾ Fehler beim SMS-Versand:', smsError);
                    }
                    
                    // CRM aktualisieren
                    await db.ref('customers/' + finalCustomerId).update({
                        lastRide: Date.now(),
                        totalRides: (finalCustomer.totalRides || 0) + 1
                    });
                    
                    // SchlieÃŸe Modal
                    document.getElementById('quick-booking-modal').remove();
                    
                    // ğŸ†• v5.88.15: AI-Assistent zurÃ¼cksetzen wenn Buchung von dort kam!
                    if (window.aiBookingPhone || document.getElementById('ai-input-text')?.value) {
                        clearAIAssistant();
                        console.log('ğŸ—‘ï¸ AI-Assistent nach erfolgreicher Buchung zurÃ¼ckgesetzt!');
                    }
                    
                    // ğŸ†• v5.57.0: Erfolgs-Meldung MIT Fahrzeug-Info!
                    let successMessage = 'âœ… Fahrt erfolgreich gebucht!\n\n' +
                          'ğŸ’¾ ' + finalCustomer.name + '\n';
                    
                    // ğŸ†• v5.75.0: Gast-Name anzeigen wenn vorhanden!
                    if (ride.guestName) {
                        successMessage += 'ğŸ“ Gast: ' + ride.guestName + '\n';
                    }
                    
                    successMessage += 'ğŸ“… ' + new Date(pickupTimestamp).toLocaleString('de-DE') + '\n' +
                          'ğŸ“ ' + pickup + '\n' +
                          'ğŸ¯ ' + destination + '\n' +
                          'ğŸ’° ' + parseFloat(ride.price || 0).toFixed(2) + 'â‚¬\n' +
                          'ğŸ“ ' + (ride.distance || 0) + ' km';
                    
                    // ğŸ†• v5.57.0: Zeige Fahrzeug-Info wenn zugewiesen!
                    if (vehicle && ride.vehicle) {
                        successMessage += '\n\nğŸš— Zugewiesen: ' + ride.vehicle;
                        if (ride.vehiclePlate) {
                            successMessage += ' (' + ride.vehiclePlate + ')';
                        }
                        successMessage += '\nğŸ“± Telegram gesendet!';
                    }
                    
                    alert(successMessage);
                    
                    // ğŸ†• v5.90.333: AUTO-ZUWEISUNG fÃ¼r SOFORT-FAHRTEN!
                    if (rideStatus === 'new' && !vehicle) {
                        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                        console.log('ğŸš€ v5.90.333: Starte Auto-Zuweisung fÃ¼r Sofort-Fahrt...');
                        console.log('   Fahrt-ID:', rideId);
                        console.log('   Pickup:', quickBookingPickupCoords);
                        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                        
                        try {
                            // Lade vollstÃ¤ndige Fahrt aus Firebase fÃ¼r Auto-Assignment
                            const rideSnapshot = await db.ref('rides/' + rideId).once('value');
                            const fullRide = rideSnapshot.val();
                            
                            if (fullRide) {
                                await startAutoAssignment(rideId, fullRide);
                                console.log('âœ… v5.90.333: Auto-Zuweisung abgeschlossen!');
                            } else {
                                console.error('ğŸ’¾ v5.90.333: Fahrt nicht gefunden in Firebase!');
                            }
                        } catch (autoAssignError) {
                            console.error('ğŸ’¾ v5.90.333: Fehler bei Auto-Zuweisung:', autoAssignError);
                            // Fahrt existiert trotzdem, nur Auto-Assign fehlgeschlagen
                        }
                    }
                    
                    // Aktualisiere Views
                    updateViews();
                    
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim Buchen:', error);
                    alert('ğŸ’¾ Fehler beim Buchen: ' + error.message);
                }
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Buchen:', error);
                alert('ğŸ’¾ Fehler beim Buchen: ' + error.message);
            } finally {
                // ğŸ”’ v5.64.16: DOPPELKLICK-SCHUTZ zurÃ¼cksetzen!
                window.isSubmittingQuickBooking = false;
                console.log('ğŸ”“ Submit entsperrt (Doppelklick-Schutz zurÃ¼ckgesetzt)');
            }
        }
        
        // ğŸ†• v5.52.5: Globale Variable fÃ¼r Rechnungsadressen beim Bearbeiten
        let currentCustomerBillingAddresses = [];
        
        // ğŸ†• v5.90.142: KUNDE BEARBEITEN - mit getCustomer!
        async function editCustomer(customerId) {
            console.log('ğŸ”§ editCustomer() aufgerufen fÃ¼r:', customerId);
            
            // Verwende zentrale getCustomer Funktion
            const customer = await getCustomer(customerId);
            
            if (!customer) {
                console.error('ğŸ’¾ Kunde nicht gefunden!');
                alert('ğŸ’¾ Kunde nicht gefunden!');
                return;
            }
            
            console.log('âœ… Kunde geladen, erstelle Modal...');
            
            // ğŸ†• v5.52.5: Lade bestehende Rechnungsadressen oder erstelle Standard
            currentCustomerBillingAddresses = customer.billingAddresses ? [...customer.billingAddresses] : [];
            
            // Migration: Alte einzelne billingAddress â†’ neues Array
            if (!customer.billingAddresses && customer.billingAddress) {
                currentCustomerBillingAddresses = [{
                    id: Date.now(),
                    label: 'Standard',
                    address: customer.billingAddress,
                    isDefault: true
                }];
            }
            
            // Wenn keine Adresse vorhanden, erstelle leeres Array
            if (currentCustomerBillingAddresses.length === 0) {
                currentCustomerBillingAddresses = [];
            }
            
            // ğŸ†• v5.90.129: Telefonnummer aufteilen in LÃ¤ndervorwahl + Nummer
            function splitPhoneNumber(fullPhone) {
                if (!fullPhone) return { country: '+49', number: '' };
                
                const phone = fullPhone.trim();
                // PrÃ¼fe auf LÃ¤ndervorwahlen
                if (phone.startsWith('+49')) return { country: '+49', number: phone.substring(3).trim() };
                if (phone.startsWith('+43')) return { country: '+43', number: phone.substring(3).trim() };
                if (phone.startsWith('+41')) return { country: '+41', number: phone.substring(3).trim() };
                if (phone.startsWith('+48')) return { country: '+48', number: phone.substring(3).trim() };
                
                // Fallback: Wenn keine Vorwahl, nimm +49
                return { country: '+49', number: phone };
            }
            
            const phone = splitPhoneNumber(customer.phone);
            const mobile = splitPhoneNumber(customer.mobilePhone);
            
            const modal = document.createElement('div');
            modal.id = 'edit-customer-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:100000;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;width:90%;max-width:500px;max-height:90vh;overflow-y:auto;position:relative;">
                    <!-- ğŸ†• v5.90.296: X-BUTTON zum SchlieÃŸen! -->
                    <button onclick="document.getElementById('edit-customer-modal').remove()" style="
                        position: absolute;
                        top: 16px;
                        right: 16px;
                        background: #ef4444;
                        color: white;
                        border: none;
                        width: 36px;
                        height: 36px;
                        border-radius: 50%;
                        font-size: 20px;
                        font-weight: 700;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                        z-index: 10;
                    ">âœ•</button>
                    <h3 style="margin:0 0 15px 0;padding-right:50px;">âœï¸ Kunde bearbeiten</h3>
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        <input type="text" id="edit-customer-name" value="${customer.name || ''}" placeholder="Name *" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;">
                        
                        <!-- ğŸ†• v5.90.129: TELEFON MIT LÃ„NDERVORWAHL -->
                        <div>
                            <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px;">ğŸ“ Festnetz-Telefon</label>
                            <div style="display:flex;gap:8px;">
                                <select id="edit-customer-phone-country" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;width:100px;box-sizing:border-box;">
                                    <option value="+49">ğŸ‡©ğŸ‡ª +49</option>
                                    <option value="+43">ğŸ‡¦ğŸ‡¹ +43</option>
                                    <option value="+41">ğŸ‡¨ğŸ‡­ +41</option>
                                    <option value="+48">ğŸ‡µğŸ‡± +48</option>
                                </select>
                                <input type="tel" id="edit-customer-phone" placeholder="170 1234827" 
                                    onblur="addCountryCode(this)"
                                    oninput="autoCleanPhoneInput(this)"
                                    style="flex:1;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;box-sizing:border-box;min-width:0;">
                                ${customer.phone ? `<button onclick="window.location.href='tel:${customer.phone}'" style="padding:12px 16px;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:8px;cursor:pointer;font-size:18px;min-width:50px;" title="Anrufen">ğŸ“</button>` : ''}
                            </div>
                        </div>
                        
                        <!-- ğŸ†• v5.90.568: ZWEITE FESTNETZ-NUMMER (fÃ¼r Hotels mit Durchwahl) -->
                        <div id="second-phone-container" style="display:none;position:relative;">
                            <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px;">ğŸ“ Zweite Festnetz-Nummer (z.B. Durchwahl)</label>
                            <div style="display:flex;gap:8px;">
                                <select id="edit-customer-phone2-country" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;width:100px;box-sizing:border-box;">
                                    <option value="+49">ğŸ‡©ğŸ‡ª +49</option>
                                    <option value="+43">ğŸ‡¦ğŸ‡¹ +43</option>
                                    <option value="+41">ğŸ‡¨ğŸ‡­ +41</option>
                                    <option value="+48">ğŸ‡µğŸ‡± +48</option>
                                </select>
                                <input type="tel" id="edit-customer-phone2" placeholder="170 1234828" 
                                    onblur="addCountryCode(this)"
                                    oninput="autoCleanPhoneInput(this)"
                                    style="flex:1;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;box-sizing:border-box;min-width:0;">
                                <button onclick="removeSecondPhone()" style="padding:12px 16px;background:#ef4444;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;min-width:50px;" title="Entfernen">
                                    âœ•
                                </button>
                            </div>
                            <div style="font-size:11px;color:#6b7280;margin-top:4px;padding:0 4px;">
                                â„¹ï¸ FÃ¼r Hotels/Unternehmen mit mehreren Telefonnummern
                            </div>
                        </div>
                        
                        <!-- Button zum HinzufÃ¼gen der 2. Nummer -->
                        <button id="add-second-phone-btn" onclick="showSecondPhone()" style="width:100%;padding:10px;background:#f3f4f6;color:#6b7280;border:2px dashed #d1d5db;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;transition:all 0.2s;" onmouseover="this.style.background='#e5e7eb';this.style.borderColor='#9ca3af'" onmouseout="this.style.background='#f3f4f6';this.style.borderColor='#d1d5db'">
                            â• Zweite Festnetz-Nummer hinzufÃ¼gen
                        </button>
                        
                        <!-- ğŸ†• v5.90.129: MOBILFUNKNUMMER MIT LÃ„NDERVORWAHL -->
                        <div style="position:relative;">
                            <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px;">ğŸ“± Mobilfunknummer (fÃ¼r Google Kalender)</label>
                            <div style="display:flex;gap:8px;">
                                <select id="edit-customer-mobile-country" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;width:100px;box-sizing:border-box;">
                                    <option value="+49">ğŸ‡©ğŸ‡ª +49</option>
                                    <option value="+43">ğŸ‡¦ğŸ‡¹ +43</option>
                                    <option value="+41">ğŸ‡¨ğŸ‡­ +41</option>
                                    <option value="+48">ğŸ‡µğŸ‡± +48</option>
                                </select>
                                <input type="tel" id="edit-customer-mobile" placeholder="170 1234827" 
                                    onblur="addCountryCode(this)"
                                    oninput="autoCleanPhoneInput(this)"
                                    style="flex:1;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;box-sizing:border-box;min-width:0;">
                                ${customer.mobilePhone ? `<button onclick="window.location.href='tel:${customer.mobilePhone}'" style="padding:12px 16px;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:8px;cursor:pointer;font-size:18px;min-width:50px;" title="Anrufen">ğŸ“</button>` : ''}
                            </div>
                            <div style="font-size:11px;color:#6b7280;margin-top:4px;padding:0 4px;">
                                â„¹ï¸ Optional: Wird fÃ¼r Google Kalender-Synchronisation verwendet
                            </div>
                        </div>
                        
                        <input type="email" id="edit-customer-email" value="${customer.email || ''}" placeholder="Email" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;">
                        <div style="position:relative;display:flex;gap:8px;align-items:center;">
                            <input type="text" id="edit-customer-address" value="${customer.address || ''}" placeholder="ğŸ  Wohnanschrift" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;flex:1;">
                            <button onclick="openUniversalMapPicker('edit-customer-address', 'ğŸ  Wohnanschrift auf Karte wÃ¤hlen')" style="background:#10b981;color:white;border:none;border-radius:8px;width:44px;height:44px;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;flex-shrink:0;position:relative;z-index:10001;" title="Auf Karte wÃ¤hlen">
                                ğŸ—ºï¸
                            </button>
                            <div id="edit-customer-address-dropdown" style="position:absolute;top:100%;left:0;right:52px;background:white;border:1px solid #e0e0e0;border-radius:8px;max-height:200px;overflow-y:auto;display:none;z-index:10000;box-shadow:0 4px 6px rgba(0,0,0,0.1);"></div>
                        </div>
                        
                        <!-- ğŸ†• v5.52.5: MEHRFACH-RECHNUNGSADRESSEN -->
                        <div style="margin-top:10px;padding:15px;background:#f0fdf4;border:2px solid #10b981;border-radius:8px;">
                            <div style="font-weight:700;margin-bottom:10px;color:#048257;">ğŸ“¬ Rechnungsadressen</div>
                            
                            <div id="billing-addresses-list" style="margin-bottom:10px;"></div>
                            
                            <button onclick="addBillingAddressField()" 
                                    style="width:100%;padding:10px;background:#10b981;color:white;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.3s;"
                                    onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                                + Rechnungsadresse hinzufÃ¼gen
                            </button>
                        </div>
                        
                        <textarea id="edit-customer-notes" placeholder="Notizen" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;min-height:60px;">${customer.notes || ''}</textarea>
                        
                        <!-- ğŸ†• v5.90.245: KATEGORIE MIT CUSTOM DROPDOWN FÃœR TESLA! -->
                        <div>
                            <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px;">ğŸ“‚ Kategorie</label>
                            <div style="position:relative;">
                                <button id="edit-customer-category-btn" onclick="toggleEditCustomerCategoryDropdown()" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;background:white;text-align:left;cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
                                    <span id="edit-customer-category-label">Keine Kategorie</span>
                                    <span>â–¼</span>
                                </button>
                                <div id="edit-customer-category-dropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:white;border:2px solid #e0e0e0;border-radius:8px;margin-top:4px;z-index:1001;box-shadow:0 4px 12px rgba(0,0,0,0.15);max-height:300px;overflow-y:auto;">
                                    <div onclick="selectEditCustomerCategory('', 'Keine Kategorie')" style="padding:12px;cursor:pointer;border-bottom:1px solid #e5e7eb;transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                                        Keine Kategorie
                                    </div>
                                    <div onclick="selectEditCustomerCategory('favorite', 'â­ Favorit (Schnellwahl)')" style="padding:12px;cursor:pointer;border-bottom:1px solid #e5e7eb;transition:background 0.2s;" onmouseover="this.style.background='#fef3c7'" onmouseout="this.style.background='white'">
                                        â­ Favorit (Schnellwahl)
                                    </div>
                                    <div onclick="selectEditCustomerCategory('driver', 'ğŸš— Fahrer')" style="padding:12px;cursor:pointer;border-bottom:1px solid #e5e7eb;transition:background 0.2s;" onmouseover="this.style.background='#dbeafe'" onmouseout="this.style.background='white'">
                                        ğŸš— Fahrer
                                    </div>
                                    <div onclick="selectEditCustomerCategory('hotel', 'ğŸ¨ Hotel')" style="padding:12px;cursor:pointer;border-bottom:1px solid #e5e7eb;transition:background 0.2s;" onmouseover="this.style.background='#f3e8ff'" onmouseout="this.style.background='white'">
                                        ğŸ¨ Hotel
                                    </div>
                                    <div onclick="selectEditCustomerCategory('restaurant', 'ğŸ½ï¸ Restaurant')" style="padding:12px;cursor:pointer;border-bottom:1px solid #e5e7eb;transition:background 0.2s;" onmouseover="this.style.background='#fef3c7'" onmouseout="this.style.background='white'">
                                        ğŸ½ï¸ Restaurant
                                    </div>
                                    <div onclick="selectEditCustomerCategory('vip', 'ğŸ‘‘ VIP')" style="padding:12px;cursor:pointer;border-bottom:1px solid #e5e7eb;transition:background 0.2s;" onmouseover="this.style.background='#fef3c7'" onmouseout="this.style.background='white'">
                                        ğŸ‘‘ VIP
                                    </div>
                                    <div onclick="selectEditCustomerCategory('business', 'ğŸ’¼ GeschÃ¤ftskunde')" style="padding:12px;cursor:pointer;transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                                        ğŸ’¼ GeschÃ¤ftskunde
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="edit-customer-category" value="">
                            <div style="font-size:11px;color:#6b7280;margin-top:4px;padding:0 4px;">
                                â„¹ï¸ "Favorit" erscheint im Schnellanruf-Button ğŸ’¾
                            </div>
                        </div>
                    </div>
                    <div style="font-size:12px;color:#666;margin-top:10px;padding:10px;background:#f9fafb;border-radius:6px;">
                        ğŸš• ${customer.totalRides || 0} Fahrten Â· ğŸ’° ${(customer.totalRevenue || 0).toFixed(2)}â‚¬
                    </div>
                    <div style="display:flex;gap:10px;margin-top:15px;">
                        <button onclick="updateCustomer('${customerId}')" style="flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">ğŸ’¾ Speichern</button>
                        <button onclick="applyCustomerDataToInvoice('${customerId}')" style="flex:1;padding:12px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;">ğŸ“± Daten Ã¼bernehmen</button>
                        <button onclick="closeEditCustomerModal()" style="flex:1;padding:12px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Abbrechen</button>
                    </div>
                    <button onclick="deleteCustomer('${customerId}')" style="width:100%;margin-top:10px;padding:12px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">ğŸ—‘ï¸ Kunde lÃ¶schen</button>
                </div>
            `;
            console.log('ğŸ“± Modal HTML erstellt, fÃ¼ge zum DOM hinzu...');
            document.body.appendChild(modal);
            console.log('âœ… v5.90.135: Modal zum DOM hinzugefÃ¼gt!');
            console.log('   Modal ID:', modal.id);
            console.log('   Modal im DOM:', document.getElementById('edit-customer-modal') ? 'JA' : 'NEIN');
            
            // ğŸ†• v5.90.129: Setze Telefonnummer-Dropdowns und -Werte
            setTimeout(() => {
                // Telefon
                const phoneCountrySelect = document.getElementById('edit-customer-phone-country');
                const phoneInput = document.getElementById('edit-customer-phone');
                if (phoneCountrySelect && phoneInput) {
                    phoneCountrySelect.value = phone.country;
                    phoneInput.value = phone.number;
                }
                
                // Mobilnummer
                const mobileCountrySelect = document.getElementById('edit-customer-mobile-country');
                const mobileInput = document.getElementById('edit-customer-mobile');
                if (mobileCountrySelect && mobileInput) {
                    mobileCountrySelect.value = mobile.country;
                    mobileInput.value = mobile.number;
                }
                
                // ğŸ†• v5.90.565: Zweite Telefonnummer (falls vorhanden)
                if (customer.phone2) {
                    const phone2Parts = splitPhoneNumber(customer.phone2);
                    const phone2Container = document.getElementById('second-phone-container');
                    const phone2CountrySelect = document.getElementById('edit-customer-phone2-country');
                    const phone2Input = document.getElementById('edit-customer-phone2');
                    const addBtn = document.getElementById('add-second-phone-btn');
                    
                    if (phone2Container && phone2CountrySelect && phone2Input && addBtn) {
                        phone2Container.style.display = 'block';
                        addBtn.style.display = 'none';
                        phone2CountrySelect.value = phone2Parts.country;
                        phone2Input.value = phone2Parts.number;
                    }
                }
                
                // ğŸ†• v5.90.245: Setze Kategorie (Custom Dropdown!)
                const categoryInput = document.getElementById('edit-customer-category');
                if (categoryInput && customer.category) {
                    categoryInput.value = customer.category;
                    
                    // Setze auch Label
                    const labels = {
                        'favorite': 'â­ Favorit (Schnellwahl)',
                        'driver': 'ğŸš— Fahrer',
                        'hotel': 'ğŸ¨ Hotel',
                        'restaurant': 'ğŸ½ï¸ Restaurant',
                        'vip': 'ğŸ‘‘ VIP',
                        'business': 'ğŸ’¼ GeschÃ¤ftskunde'
                    };
                    const label = labels[customer.category] || 'Keine Kategorie';
                    const labelElement = document.getElementById('edit-customer-category-label');
                    if (labelElement) {
                        labelElement.textContent = label;
                    }
                }
            }, 10);
            
            // Rendere Adressen-Liste
            renderBillingAddressesList();
            
            // Autocomplete aktivieren nach Modal erscheint
            setTimeout(() => {
                setupCustomerAddressAutocomplete('edit-customer-address', 'edit-customer-address-dropdown');
            }, 100);
        }
        
        // ğŸ†• v5.90.196: AUTOCOMPLETE FÃœR KUNDEN-ADRESSE!
        function setupCustomerAddressAutocomplete(inputId, dropdownId) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            
            if (!input || !dropdown) {
                console.warn('âš ï¸ Autocomplete Elements nicht gefunden:', inputId, dropdownId);
                return;
            }
            
            let autocompleteTimeout;
            
            input.addEventListener('input', (e) => {
                const value = e.target.value;
                
                clearTimeout(autocompleteTimeout);
                
                if (value.length < 3) {
                    dropdown.style.display = 'none';
                    return;
                }
                
                dropdown.innerHTML = '<div style="padding:10px;color:#999;">Suche...</div>';
                dropdown.style.display = 'block';
                
                autocompleteTimeout = setTimeout(async () => {
                    try {
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(value)}&countrycodes=de&viewbox=10.6,54.7,14.4,53.1&bounded=1&limit=10&addressdetails=1`
                        );
                        const results = await response.json();
                        
                        if (results.length === 0) {
                            dropdown.innerHTML = '<div style="padding:10px;color:#999;">Keine Ergebnisse</div>';
                            return;
                        }
                        
                        dropdown.innerHTML = results.map(r => {
                            const address = r.address;
                            let displayText = r.display_name;
                            
                            // Baue schÃ¶ne Adresse
                            if (address.road) {
                                displayText = address.road;
                                if (address.house_number) displayText += ' ' + address.house_number;
                                if (address.postcode) displayText += ', ' + address.postcode;
                                if (address.town || address.city) displayText += ' ' + (address.town || address.city);
                            }
                            
                            return `
                                <div onclick="selectCustomerAddress('${displayText.replace(/'/g, "\\'")}', ${r.lat}, ${r.lon})" style="
                                    padding:12px;
                                    cursor:pointer;
                                    border-bottom:1px solid #f0f0f0;
                                    transition:background 0.2s;
                                " onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                    ${displayText}
                                </div>
                            `;
                        }).join('');
                        
                    } catch (error) {
                        console.error('Autocomplete Fehler:', error);
                        dropdown.innerHTML = '<div style="padding:10px;color:#ef4444;">Fehler bei der Suche</div>';
                    }
                }, 300);
            });
            
            // SchlieÃŸe Dropdown bei Klick auÃŸerhalb
            document.addEventListener('click', (e) => {
                if (e.target !== input && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }
        
        function selectCustomerAddress(address, lat, lon) {
            const input = document.getElementById('edit-customer-address');
            const dropdown = document.getElementById('edit-customer-address-dropdown');
            
            if (input) {
                input.value = address;
                // Speichere auch Koordinaten (optional)
                input.dataset.lat = lat;
                input.dataset.lon = lon;
            }
            
            if (dropdown) {
                dropdown.style.display = 'none';
            }
        }
        
        // ğŸ†• v5.52.5: Rendere Liste der Rechnungsadressen
        function renderBillingAddressesList() {
            const container = document.getElementById('billing-addresses-list');
            if (!container) return;
            
            if (currentCustomerBillingAddresses.length === 0) {
                container.innerHTML = '<div style="padding:10px;text-align:center;color:#6b7280;font-size:13px;">Noch keine Rechnungsadressen</div>';
                return;
            }
            
            container.innerHTML = currentCustomerBillingAddresses.map((addr, index) => `
                <div style="background:white;border:2px solid ${addr.isDefault ? '#10b981' : '#e5e7eb'};border-radius:8px;padding:12px;margin-bottom:10px;">
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
                        <div style="flex:1;">
                            <input type="text" 
                                   id="billing-label-${index}"
                                   value="${addr.label || ''}" 
                                   onchange="updateBillingAddressLabel(${index}, this.value)"
                                   placeholder="Label (z.B. Privat, Firma)"
                                   style="padding:6px 8px;border:1px solid #e5e7eb;border-radius:6px;font-size:13px;font-weight:600;width:100%;margin-bottom:8px;">
                            
                            <div style="position:relative;">
                                <textarea 
                                    id="billing-address-${index}"
                                    onchange="updateBillingAddressText(${index}, this.value)"
                                    placeholder="Rechnungsadresse"
                                    style="padding:8px;border:1px solid #e5e7eb;border-radius:6px;font-size:13px;width:100%;min-height:60px;resize:vertical;">${addr.address || ''}</textarea>
                                <div id="billing-address-dropdown-${index}" 
                                     style="position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #e5e7eb;border-radius:8px;max-height:200px;overflow-y:auto;display:none;z-index:10001;box-shadow:0 4px 6px rgba(0,0,0,0.1);"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:8px;align-items:center;">
                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;flex:1;">
                            <input type="checkbox" 
                                   ${addr.isDefault ? 'checked' : ''} 
                                   onchange="setBillingAddressDefault(${index})"
                                   style="width:16px;height:16px;">
                            <span style="font-size:13px;color:#6b7280;">Als Standard</span>
                        </label>
                        
                        <button onclick="removeBillingAddress(${index})" 
                                style="padding:6px 12px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Aktiviere Autocomplete fÃ¼r alle Adressfelder
            setTimeout(() => {
                currentCustomerBillingAddresses.forEach((_, index) => {
                    setupBillingAddressAutocomplete(index);
                });
            }, 100);
        }
        
        // ğŸ†• v5.52.5: Autocomplete fÃ¼r Rechnungsadresse-Feld
        function setupBillingAddressAutocomplete(index) {
            const textarea = document.getElementById(`billing-address-${index}`);
            const dropdown = document.getElementById(`billing-address-dropdown-${index}`);
            
            if (!textarea || !dropdown) return;
            
            let timeout;
            
            textarea.addEventListener('input', (e) => {
                clearTimeout(timeout);
                const value = e.target.value.trim();
                
                if (value.length < 3) {
                    dropdown.style.display = 'none';
                    return;
                }
                
                dropdown.innerHTML = '<div style="padding:10px;color:#999;font-size:13px;">Suche...</div>';
                dropdown.style.display = 'block';
                
                timeout = setTimeout(() => {
                    searchAddressForBilling(value, index);
                }, 300);
            });
            
            document.addEventListener('click', (e) => {
                if (e.target !== textarea && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }
        
        // ğŸ†• v5.52.5: Adresssuche fÃ¼r Rechnungsadresse
        async function searchAddressForBilling(query, index) {
            const dropdown = document.getElementById(`billing-address-dropdown-${index}`);
            if (!dropdown) return;
            
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?` +
                    `format=json&` +
                    `q=${encodeURIComponent(query)}&` +
                    `countrycodes=de&viewbox=10.6,54.7,14.4,53.1&bounded=1&` +
                    `limit=8&` +
                    `addressdetails=1`
                );
                
                const results = await response.json();
                
                if (results.length === 0) {
                    dropdown.innerHTML = '<div style="padding:10px;color:#999;font-size:13px;">Keine Ergebnisse</div>';
                    return;
                }
                
                const usedomResults = results.filter(r => {
                    const display = r.display_name.toLowerCase();
                    return display.includes('usedom') || 
                           display.includes('heringsdorf') || 
                           display.includes('ahlbeck') ||
                           display.includes('bansin') ||
                           display.includes('zinnowitz') ||
                           display.includes('karlshagen') ||
                           display.includes('peenemÃ¼nde') ||
                           display.includes('koserow') ||
                           display.includes('Ã¼ckeritz') ||
                           display.includes('loddin') ||
                           display.includes('zempin') ||
                           display.includes('trassenheide') ||
                           display.includes('greifswald') ||
                           display.includes('wolgast') ||
                           display.includes('anklam') ||
                           display.includes('stralsund') ||
                           display.includes('neubrandenburg');
                });
                
                const resultsToShow = usedomResults.length > 0 ? usedomResults : results;
                
                dropdown.innerHTML = resultsToShow.map(r => {
                    const address = r.address;
                    let displayText = '';
                    if (address.road) displayText += address.road + ' ';
                    if (address.house_number) displayText += address.house_number + ', ';
                    if (address.postcode) displayText += address.postcode + ' ';
                    if (address.village || address.town || address.city) {
                        displayText += (address.village || address.town || address.city);
                    }
                    
                    return `
                        <div onclick="selectBillingAddress(${index}, '${displayText.replace(/'/g, "\\'")}', '${r.display_name.replace(/'/g, "\\'")}' )" 
                             style="padding:10px;cursor:pointer;border-bottom:1px solid #f0f0f0;transition:background 0.2s;"
                             onmouseover="this.style.background='#f9fafb'" 
                             onmouseout="this.style.background='white'">
                            <div style="font-weight:600;font-size:13px;">${displayText}</div>
                            <div style="font-size:11px;color:#999;">${r.display_name}</div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Autocomplete Fehler:', error);
                dropdown.innerHTML = '<div style="padding:10px;color:#ef4444;font-size:13px;">Fehler bei der Suche</div>';
            }
        }
        
        // ğŸ†• v5.52.5: Adresse aus Dropdown auswÃ¤hlen
        function selectBillingAddress(index, shortAddress, fullAddress) {
            const textarea = document.getElementById(`billing-address-${index}`);
            const dropdown = document.getElementById(`billing-address-dropdown-${index}`);
            
            if (textarea) {
                textarea.value = fullAddress;
                currentCustomerBillingAddresses[index].address = fullAddress;
            }
            
            if (dropdown) {
                dropdown.style.display = 'none';
            }
        }
        
        // ğŸ†• v5.52.5: Neue leere Adresse hinzufÃ¼gen
        function addBillingAddressField() {
            const nextId = Date.now();
            currentCustomerBillingAddresses.push({
                id: nextId,
                label: '',
                address: '',
                isDefault: currentCustomerBillingAddresses.length === 0 // Erste ist automatisch Standard
            });
            renderBillingAddressesList();
        }
        
        // ğŸ†• v5.52.5: Adresse entfernen
        function removeBillingAddress(index) {
            if (currentCustomerBillingAddresses.length === 1) {
                alert('âš ï¸ Du kannst nicht die letzte Adresse lÃ¶schen!');
                return;
            }
            
            const wasDefault = currentCustomerBillingAddresses[index].isDefault;
            currentCustomerBillingAddresses.splice(index, 1);
            
            // Wenn Standard gelÃ¶scht wurde, setze ersten Eintrag als Standard
            if (wasDefault && currentCustomerBillingAddresses.length > 0) {
                currentCustomerBillingAddresses[0].isDefault = true;
            }
            
            renderBillingAddressesList();
        }
        
        // ğŸ†• v5.52.5: Label Ã¤ndern
        function updateBillingAddressLabel(index, value) {
            currentCustomerBillingAddresses[index].label = value;
        }
        
        // ğŸ†• v5.52.5: Adress-Text Ã¤ndern
        function updateBillingAddressText(index, value) {
            currentCustomerBillingAddresses[index].address = value;
        }
        
        // ğŸ†• v5.52.5: Als Standard markieren
        function setBillingAddressDefault(index) {
            // Entferne Standard von allen
            currentCustomerBillingAddresses.forEach(addr => addr.isDefault = false);
            // Setze neuen Standard
            currentCustomerBillingAddresses[index].isDefault = true;
            renderBillingAddressesList();
        }
        
        // ğŸ†• v5.52.5: Rechnungsadresse im Rechnungsmodal Ã¤ndern
        function updateInvoiceBillingAddress() {
            const select = document.getElementById('invoice-billing-address-select');
            if (!select || !invoiceCustomerData) return;
            
            const selectedId = parseInt(select.value);
            const selectedAddr = invoiceCustomerData.billingAddresses.find(a => a.id === selectedId);
            
            if (selectedAddr) {
                invoiceSelectedBillingAddress = selectedAddr.address;
                console.log('ğŸ“¬ Rechnungsadresse gewÃ¤hlt:', selectedAddr.label, '-', selectedAddr.address);
            }
        }
        
        // ğŸ†• v5.90.176: KUNDENDATEN IN RECHNUNG ÃœBERNEHMEN!
        async function applyCustomerDataToInvoice(customerId) {
            console.log('ğŸ“± Ãœbernehme Kundendaten in Rechnung:', customerId);
            
            // Lade aktuelle Werte aus CRM-Modal
            const name = document.getElementById('edit-customer-name')?.value?.trim() || '';
            const email = document.getElementById('edit-customer-email')?.value?.trim() || '';
            const address = document.getElementById('edit-customer-address')?.value?.trim() || '';
            const notes = document.getElementById('edit-customer-notes')?.value?.trim() || '';
            
            // Telefon zusammensetzen
            const phoneCountry = document.getElementById('edit-customer-phone-country')?.value || '+49';
            const phoneNumber = document.getElementById('edit-customer-phone')?.value?.trim() || '';
            const phone = phoneCountry + phoneNumber;
            
            // Mobil zusammensetzen
            const mobileCountry = document.getElementById('edit-customer-mobile-country')?.value || '+49';
            const mobileNumber = document.getElementById('edit-customer-mobile')?.value?.trim() || '';
            const mobile = mobileCountry + mobileNumber;
            
            console.log('ğŸ“ Daten aus CRM-Modal:', { name, email, address, phone, mobile });
            
            // Ãœbernehme in Rechnung-Modal (wenn offen)
            const invName = document.getElementById('inv-customer-name');
            const invAddress = document.getElementById('inv-address');
            
            if (invName) {
                invName.value = name;
                console.log('âœ… Name Ã¼bernommen:', name);
            }
            
            if (invAddress) {
                invAddress.value = address;
                console.log('âœ… Adresse Ã¼bernommen:', address);
            }
            
            // Speichere in globalem invoiceCustomerData
            if (!window.invoiceCustomerData) {
                window.invoiceCustomerData = {};
            }
            window.invoiceCustomerData.id = customerId;
            window.invoiceCustomerData.name = name;
            window.invoiceCustomerData.email = email;
            window.invoiceCustomerData.address = address;
            window.invoiceCustomerData.phone = phone;
            window.invoiceCustomerData.mobile = mobile;
            window.invoiceCustomerData.notes = notes;
            
            console.log('âœ… invoiceCustomerData aktualisiert:', window.invoiceCustomerData);
            
            // SchlieÃŸe CRM-Modal
            closeEditCustomerModal();
            
            // Erfolgs-Meldung
            showToast('âœ… Kundendaten Ã¼bernommen!', 'success');
        }
        
        function closeEditCustomerModal() {
            const modal = document.getElementById('edit-customer-modal');
            if (modal) modal.remove();
            currentCustomerBillingAddresses = [];
        }
        
        // ğŸ†• v5.90.565: Zweite Telefonnummer ein-/ausblenden
        function showSecondPhone() {
            const container = document.getElementById('second-phone-container');
            const addBtn = document.getElementById('add-second-phone-btn');
            if (container && addBtn) {
                container.style.display = 'block';
                addBtn.style.display = 'none';
            }
        }
        
        function removeSecondPhone() {
            const container = document.getElementById('second-phone-container');
            const addBtn = document.getElementById('add-second-phone-btn');
            const input = document.getElementById('edit-customer-phone2');
            if (container && addBtn && input) {
                container.style.display = 'none';
                addBtn.style.display = 'block';
                input.value = ''; // Leere das Feld
            }
        }
        
        async function updateCustomer(customerId) {
            const name = document.getElementById('edit-customer-name').value.trim();
            if (!name) {
                alert('ğŸ’¾ Name ist erforderlich!');
                return;
            }
            
            // ğŸ†• v5.52.5: Speichere Mehrfach-Rechnungsadressen
            const address = document.getElementById('edit-customer-address').value.trim();
            
            // PrÃ¼fe ob mindestens eine Rechnungsadresse vorhanden
            if (currentCustomerBillingAddresses.length === 0) {
                // Fallback: Nutze Wohnanschrift als Standard-Rechnungsadresse
                currentCustomerBillingAddresses = [{
                    id: Date.now(),
                    label: 'Standard',
                    address: address,
                    isDefault: true
                }];
            }
            
            // ğŸ†• v5.90.129: Kombiniere LÃ¤ndervorwahl + Telefonnummer
            const phoneCountry = document.getElementById('edit-customer-phone-country').value;
            let phoneNumber = document.getElementById('edit-customer-phone').value.trim().replace(/\s/g, '');
            
            // ğŸ†• v5.90.301: ENTFERNE DOPPELTE VORWAHL!
            if (phoneNumber.startsWith('+49')) {
                phoneNumber = phoneNumber.substring(3); // Entferne +49
            } else if (phoneNumber.startsWith('+')) {
                phoneNumber = phoneNumber.substring(1); // Entferne +
            } else if (phoneNumber.startsWith('49')) {
                phoneNumber = phoneNumber.substring(2); // Entferne 49
            }
            // Entferne fÃ¼hrende 0
            if (phoneNumber.startsWith('0')) {
                phoneNumber = phoneNumber.substring(1);
            }
            
            const fullPhone = phoneNumber ? phoneCountry + phoneNumber : '';
            
            const mobileCountry = document.getElementById('edit-customer-mobile-country').value;
            let mobileNumber = document.getElementById('edit-customer-mobile').value.trim().replace(/\s/g, '');
            
            // ğŸ†• v5.90.301: ENTFERNE DOPPELTE VORWAHL!
            if (mobileNumber.startsWith('+49')) {
                mobileNumber = mobileNumber.substring(3);
            } else if (mobileNumber.startsWith('+')) {
                mobileNumber = mobileNumber.substring(1);
            } else if (mobileNumber.startsWith('49')) {
                mobileNumber = mobileNumber.substring(2);
            }
            if (mobileNumber.startsWith('0')) {
                mobileNumber = mobileNumber.substring(1);
            }
            
            const fullMobile = mobileNumber ? mobileCountry + mobileNumber : '';
            
            // ğŸ†• v5.90.565: Zweite Telefonnummer (optional)
            const phone2Country = document.getElementById('edit-customer-phone2-country')?.value || '+49';
            let phone2Number = document.getElementById('edit-customer-phone2')?.value?.trim().replace(/\s/g, '') || '';
            
            let fullPhone2 = '';
            if (phone2Number) {
                // Entferne doppelte Vorwahl
                if (phone2Number.startsWith('+49')) {
                    phone2Number = phone2Number.substring(3);
                } else if (phone2Number.startsWith('+')) {
                    phone2Number = phone2Number.substring(1);
                } else if (phone2Number.startsWith('49')) {
                    phone2Number = phone2Number.substring(2);
                }
                if (phone2Number.startsWith('0')) {
                    phone2Number = phone2Number.substring(1);
                }
                fullPhone2 = phone2Country + phone2Number;
            }
            
            const updates = {
                name: name,
                phone: fullPhone, // ğŸ†• v5.90.129: VollstÃ¤ndige Nummer mit LÃ¤ndervorwahl
                mobilePhone: fullMobile, // ğŸ†• v5.90.129: VollstÃ¤ndige Nummer mit LÃ¤ndervorwahl
                phone2: fullPhone2, // ğŸ†• v5.90.565: Zweite Telefonnummer
                email: document.getElementById('edit-customer-email').value.trim(),
                address: address,
                billingAddresses: currentCustomerBillingAddresses, // ğŸ†• v5.52.5: Array!
                notes: document.getElementById('edit-customer-notes').value.trim(),
                category: document.getElementById('edit-customer-category')?.value || '' // ğŸ†• v5.90.232: Kategorie!
            };
            
            // ğŸš€ v5.52.8: OPTIMISTISCHES UI UPDATE - Modal SOFORT schlieÃŸen!
            closeEditCustomerModal();
            
            // ğŸš€ v5.52.8: Zeige Toast
            const toast = document.createElement('div');
            toast.style.cssText = 'position:fixed;top:20px;right:20px;background:#3b82f6;color:white;padding:15px 20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:99999;font-weight:600;animation:slideIn 0.3s ease;';
            toast.innerHTML = `â³ Update "${name}"...`;
            document.body.appendChild(toast);
            
            try {
                await db.ref('customers/' + customerId).update(updates);
                
                // ğŸš€ v5.52.8: Update lokale Kopie (kein komplettes Neuladen!)
                const customer = allCustomers.find(c => c.id === customerId);
                if (customer) {
                    Object.assign(customer, updates);
                }
                
                // ğŸš€ v5.52.8: Nur die Liste neu rendern (OHNE Firebase-Load!)
                renderCustomersList(allCustomers);
                
                console.log('âœ… Kunde aktualisiert:', name);
                
                // ğŸš€ v5.52.8: Update Toast zu Erfolg
                toast.style.background = '#10b981';
                toast.innerHTML = `âœ… "${name}" aktualisiert!`;
                setTimeout(() => toast.remove(), 2000);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Aktualisieren:', error);
                
                // ğŸš€ v5.52.8: Update Toast zu Fehler
                toast.style.background = '#ef4444';
                toast.innerHTML = `ğŸ’¾ Fehler beim Aktualisieren!`;
                setTimeout(() => toast.remove(), 3000);
            }
        }
        
        // ğŸ†• v5.90.142: KUNDE LÃ–SCHEN - mit getCustomer!
        async function deleteCustomer(customerId) {
            if (!confirm('âš ï¸ Kunde wirklich lÃ¶schen?\n\nDiese Aktion kann nicht rÃ¼ckgÃ¤ngig gemacht werden!')) return;
            
            // Verwende zentrale getCustomer Funktion
            const customer = await getCustomer(customerId);
            const customerName = customer ? customer.name : 'Kunde';
            
            // ğŸš€ v5.52.8: OPTIMISTISCHES UI UPDATE - Modal SOFORT schlieÃŸen!
            closeEditCustomerModal();
            
            // ğŸš€ v5.52.8: Zeige Toast
            const toast = document.createElement('div');
            toast.style.cssText = 'position:fixed;top:20px;right:20px;background:#ef4444;color:white;padding:15px 20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:99999;font-weight:600;animation:slideIn 0.3s ease;';
            toast.innerHTML = `â³ LÃ¶sche "${customerName}"...`;
            document.body.appendChild(toast);
            
            try {
                await db.ref('customers/' + customerId).remove();
                
                // ğŸš€ v5.52.8: Entferne aus lokaler Liste (kein komplettes Neuladen!)
                const index = allCustomers.findIndex(c => c.id === customerId);
                if (index !== -1) {
                    allCustomers.splice(index, 1);
                }
                
                // ğŸš€ v5.52.8: Nur die Liste neu rendern (OHNE Firebase-Load!)
                renderCustomersList(allCustomers);
                
                console.log('ğŸ—‘ï¸ Kunde gelÃ¶scht');
                
                // ğŸš€ v5.52.8: Update Toast zu Erfolg
                toast.style.background = '#10b981';
                toast.innerHTML = `âœ… "${customerName}" gelÃ¶scht!`;
                setTimeout(() => toast.remove(), 2000);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim LÃ¶schen:', error);
                
                // ğŸš€ v5.52.8: Update Toast zu Fehler
                toast.style.background = '#ef4444';
                toast.innerHTML = `ğŸ’¾ Fehler beim LÃ¶schen!`;
                setTimeout(() => toast.remove(), 3000);
            }
        }
        
        // ğŸ§¹ CACHE LEEREN FUNKTION
        async function clearAppCache() {
            if (!confirm('ğŸ§¹ Cache leeren?\n\nDies hilft bei Problemen mit alten Versionen.\nDie App wird neu geladen.')) return;
            
            try {
                // 1. Service Worker deregistrieren
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                        console.log('âœ… Service Worker deregistriert');
                    }
                }
                
                // 2. Cache Storage leeren
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    for (let name of cacheNames) {
                        await caches.delete(name);
                        console.log('âœ… Cache gelÃ¶scht:', name);
                    }
                }
                
                // 3. LocalStorage NICHT lÃ¶schen (Stammkunden-Daten behalten!)
                // localStorage.clear(); // NICHT ausfÃ¼hren!
                
                alert('âœ… Cache geleert!\n\nDie App wird jetzt neu geladen.');
                
                // 4. Hard Reload
                window.location.reload(true);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Cache leeren:', error);
                alert('ğŸ’¾ Fehler beim Cache leeren!\n\nVersuche es manuell:\nEinstellungen â†’ Datenschutz â†’ Browserdaten lÃ¶schen');
            }
        }

        // ğŸ“‹ DEBUG LOGS EXPORTIEREN
        let consoleLogHistory = []; // Speichere alle Console-Logs
        
        // Console-Logs abfangen und speichern
        (function() {
            const originalLog = console.log;
            const originalError = console.error;
            const originalWarn = console.warn;
            
            console.log = function(...args) {
                // ğŸ› v5.47.2: Konvertiere ALLE Args zu Strings (auch Objects!)
                const message = args.map(arg => {
                    if (typeof arg === 'object' && arg !== null) {
                        try {
                            return JSON.stringify(arg);
                        } catch (e) {
                            return String(arg);
                        }
                    }
                    return String(arg);
                }).join(' ');
                
                consoleLogHistory.push({ type: 'log', time: new Date().toISOString(), message });
                originalLog.apply(console, args);
            };
            
            console.error = function(...args) {
                // ğŸ› v5.47.2: Konvertiere ALLE Args zu Strings (auch Objects!)
                const message = args.map(arg => {
                    if (typeof arg === 'object' && arg !== null) {
                        try {
                            return JSON.stringify(arg);
                        } catch (e) {
                            return String(arg);
                        }
                    }
                    return String(arg);
                }).join(' ');
                
                consoleLogHistory.push({ type: 'error', time: new Date().toISOString(), message });
                originalError.apply(console, args);
            };
            
            console.warn = function(...args) {
                // ğŸ› v5.47.2: Konvertiere ALLE Args zu Strings (auch Objects!)
                const message = args.map(arg => {
                    if (typeof arg === 'object' && arg !== null) {
                        try {
                            return JSON.stringify(arg);
                        } catch (e) {
                            return String(arg);
                        }
                    }
                    return String(arg);
                }).join(' ');
                
                consoleLogHistory.push({ type: 'warn', time: new Date().toISOString(), message });
                originalWarn.apply(console, args);
            };
        })();
        
        function exportDebugLogs() {
            try {
                // Sammle ALLE Debug-Infos
                const allRides = rides.map(r => ({
                    id: r.id,
                    status: r.status,
                    pickup: r.pickup,
                    destination: r.destination,
                    customerName: r.customerName,
                    price: r.price,
                    createdAt: r.createdAt
                }));
                
                const allDrivers = Object.keys(drivers).map(id => ({
                    id: id,
                    vehicle: drivers[id].vehicle,
                    online: drivers[id].online,
                    lat: drivers[id].lat,
                    lng: drivers[id].lng,
                    timestamp: drivers[id].timestamp
                }));
                
                const localStorageData = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    localStorageData[key] = localStorage.getItem(key);
                }
                
                const debugInfo = {
                    timestamp: new Date().toISOString(),
                    version: "4.2.1",
                    userAgent: navigator.userAgent,
                    
                    // App-Status
                    currentView: currentView,
                    isOnline: isOnline,
                    isFirebaseReady: isFirebaseReady,
                    currentUser: currentUser ? { uid: currentUser.uid, email: currentUser.email, name: currentUser.displayName } : null,
                    
                    // Daten
                    rides_count: rides.length,
                    all_rides: allRides,
                    drivers_count: Object.keys(drivers).length,
                    all_drivers: allDrivers,
                    localStorage_complete: localStorageData,
                    regularCustomer: regularCustomer,
                    
                    // GPS
                    pickupCoords: pickupCoords,
                    destCoords: destCoords,
                    watchId: watchId,
                    
                    // Wake Lock
                    wakeLock_active: wakeLock !== null,
                    
                    // Console Logs (letzte 100)
                    console_logs: consoleLogHistory.slice(-100)
                };
                
                // Formatiere als JSON fÃ¼r einfaches Kopieren
                const debugJSON = JSON.stringify(debugInfo, null, 2);
                
                // Formatiere auch als lesbaren Text
                const debugText = `
ğŸš• TAXI-APP MEGA DEBUG EXPORT
========================
Version: ${debugInfo.version}
Zeitpunkt: ${debugInfo.timestamp}

ğŸ“± GERÃ„T:
${debugInfo.userAgent}

ğŸ’¾ USER:
- Angemeldet: ${debugInfo.currentUser ? 'Ja (' + debugInfo.currentUser.email + ')' : 'Nein'}
- Stammkunde: ${debugInfo.regularCustomer ? debugInfo.regularCustomer.name + ' (' + debugInfo.regularCustomer.rideCount + ' Fahrten)' : 'Nein'}

ğŸ“± STATUS:
- Ansicht: ${debugInfo.currentView}
- Online: ${debugInfo.isOnline}
- Firebase: ${debugInfo.isFirebaseReady}
- Wake Lock: ${debugInfo.wakeLock_active ? 'Aktiv' : 'Inaktiv'}

ğŸ—ƒï¸ DATEN:
- Fahrten in Firebase: ${debugInfo.rides_count}
- Fahrer registriert: ${debugInfo.drivers_count}
- Fahrer online: ${allDrivers.filter(d => d.online).length}

ğŸš— ALLE FAHRER:
${allDrivers.map(d => `- ${d.vehicle} | Online: ${d.online} | GPS: ${d.lat ? 'Ja' : 'Nein'}`).join('\n') || '(keine)'}

ğŸš– LETZTE 10 FAHRTEN:
${allRides.slice(-10).map(r => `- #${r.id} | ${r.status} | ${r.pickup} â†’ ${r.destination} | ${r.price}â‚¬`).join('\n') || '(keine)'}

ğŸ“ CONSOLE LOGS (letzte 20):
${consoleLogHistory.slice(-20).map(l => `[${l.type.toUpperCase()}] ${l.time}: ${l.message}`).join('\n') || '(keine)'}

ğŸ’¾ LOCALSTORAGE KEYS:
${Object.keys(localStorageData).join(', ')}

========================

ğŸ“¦ KOMPLETTE DATEN ALS JSON:
Siehe unten fÃ¼r vollstÃ¤ndigen JSON-Export...

${debugJSON}
`;
                
                // Erstelle Blob fÃ¼r Download
                const blob = new Blob([debugText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `taxi-app-debug-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
                
                // Zeige Options-Dialog
                const choice = confirm(
                    'ğŸ“‹ DEBUG EXPORT\n\n' +
                    'WÃ¤hle eine Option:\n\n' +
                    '[OK] = In Zwischenablage kopieren\n' +
                    '[Abbrechen] = Als Datei herunterladen'
                );
                
                if (choice) {
                    // Kopiere in Zwischenablage
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(debugText).then(() => {
                            alert('âœ… Mega-Debug-Export kopiert!\n\nAlles ist in deiner Zwischenablage:\n- Console Logs\n- Alle Fahrten\n- Alle Fahrer\n- localStorage\n- etc.');
                        }).catch(err => {
                            prompt('ğŸ“‹ Debug-Export (Strg+C zum Kopieren):', debugText);
                        });
                    } else {
                        prompt('ğŸ“‹ Debug-Export (Strg+C zum Kopieren):', debugText);
                    }
                } else {
                    // Download als Datei
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    alert('âœ… Debug-Export heruntergeladen!\n\nSiehe Downloads-Ordner.');
                }
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Exportieren:', error);
                alert('ğŸ’¾ Fehler beim Exportieren der Logs!');
            }
        }
        
        // ğŸ› SUPER DEBUG EXPORT
        function exportSuperDebug() {
            try {
                const now = new Date().toISOString();
                
                // System Info
                const systemInfo = {
                    version: "4.7.1",
                    build: "20251123-0800",
                    timestamp: now,
                    userAgent: navigator.userAgent,
                    currentView: currentView,
                    isOnline: isOnline,
                    isFirebaseReady: isFirebaseReady,
                    currentUser: currentUser ? {
                        uid: currentUser.uid,
                        email: currentUser.email,
                        name: currentUser.displayName
                    } : null
                };
                
                // Erstelle Text-Export
                let debugText = `
=====================================
ğŸ› SUPER DEBUG EXPORT
=====================================
Version: ${systemInfo.version}
Build: ${systemInfo.build}
Zeit: ${systemInfo.timestamp}
User: ${systemInfo.currentUser?.email || 'Nicht eingeloggt'}

ğŸ“± SYSTEM:
- Browser: ${systemInfo.userAgent}
- View: ${systemInfo.currentView}
- Online: ${systemInfo.isOnline}
- Firebase: ${systemInfo.isFirebaseReady}

ğŸ”´ FEHLER (${debugErrors.length}):
`;
                
                if (debugErrors.length === 0) {
                    debugText += 'âœ… Keine Fehler aufgetreten!\n';
                } else {
                    debugErrors.forEach((err, i) => {
                        debugText += `
[${i+1}] ${err.time}
Message: ${err.message}
File: ${err.filename}:${err.line}:${err.column}
Stack: ${err.stack}
---
`;
                    });
                }
                
                debugText += `
ğŸ“‹ CONSOLE LOGS (letzte ${Math.min(debugLogs.length, 100)}):
`;
                debugLogs.slice(-100).forEach(log => {
                    const icon = log.type === 'error' ? 'ğŸ”´' : log.type === 'warn' ? 'âš ï¸' : 'ğŸ“';
                    debugText += `[${log.time}] ${icon} ${log.message}\n`;
                });
                
                debugText += `
ğŸ” FIREBASE QUERIES (${debugFirebaseQueries.length}):
`;
                if (debugFirebaseQueries.length === 0) {
                    debugText += 'Keine Queries aufgezeichnet\n';
                } else {
                    debugFirebaseQueries.slice(-20).forEach(query => {
                        debugText += `[${query.time}] ${query.path}\n  â†’ ${query.result}\n`;
                    });
                }
                
                debugText += `
âš¡ STATE CHANGES (${debugStateChanges.length}):
`;
                if (debugStateChanges.length === 0) {
                    debugText += 'Keine State Changes aufgezeichnet\n';
                } else {
                    debugStateChanges.slice(-20).forEach(change => {
                        debugText += `[${change.time}] ${change.description}\n  ${change.oldValue} â†’ ${change.newValue}\n`;
                    });
                }
                
                debugText += `
ğŸ’¾ AKTUELLER STATE:
- Rides in Array: ${rides.length}
- Drivers online: ${Object.values(drivers).filter(d => d.online).length}
- Current Vehicle: ${currentVehicle || 'none'}
- Current Ride: ${myCurrentRide?.id || 'none'}
- Pickup Coords: ${pickupCoords ? 'Set' : 'None'}
- Dest Coords: ${destCoords ? 'Set' : 'None'}

ğŸ“¦ FAHRTEN (letzte 10):
`;
                rides.slice(-10).forEach(r => {
                    debugText += `#${r.id} | ${r.status} | ${r.customerName || 'N/A'} | ${r.pickup} â†’ ${r.destination}\n`;
                });
                
                debugText += `
=====================================
`;
                
                // Download als Datei
                const blob = new Blob([debugText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `super-debug-${now.slice(0,19).replace(/:/g,'-')}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert(
                    'ğŸ› Super Debug Export erstellt!\n\n' +
                    `ğŸ“± ${debugErrors.length} Fehler\n` +
                    `ğŸ“‹ ${debugLogs.length} Console Logs\n` +
                    `ğŸ” ${debugFirebaseQueries.length} Firebase Queries\n` +
                    `âš¡ ${debugStateChanges.length} State Changes\n\n` +
                    'âœ… Datei heruntergeladen!\n' +
                    'Schicke mir diese Datei und ich kann ALLES sehen!'
                );
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Super Debug Export:', error);
                alert('ğŸ’¾ Fehler beim Export: ' + error.message);
            }
        }

        // SOUNDS
        // ğŸ”Š ALERT STATUS MAP-NULL-CHECK-FIX
        let soundAvailable = false;
        let vibrationAvailable = false;
        
        function playDriverNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const beeps = [0, 0.25, 0.5, 0.75, 1.0, 1.25, 1.5, 1.75];
                
                beeps.forEach((time) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 1400;
                    oscillator.type = 'square';
                    
                    gainNode.gain.setValueAtTime(0.8, audioContext.currentTime + time);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + time + 0.15);
                    
                    oscillator.start(audioContext.currentTime + time);
                    oscillator.stop(audioContext.currentTime + time + 0.15);
                });
                
                soundAvailable = true;
                updateAlertStatus();
                return true;
            } catch (e) {
                console.error('Sound Fehler:', e);
                soundAvailable = false;
                updateAlertStatus();
                return false;
            }
        }
        
        // ğŸ§ª TEST FUNKTIONEN
        function testSound() {
            const success = playDriverNotificationSound();
            if (success) {
                setTimeout(() => alert('âœ… Sound funktioniert!'), 500);
            } else {
                alert('ğŸ’¾ Sound blockiert!\n\nBitte in Browser-Einstellungen:\nSound erlauben');
            }
        }
        
        function testVibration() {
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 400, 100, 200]);
                vibrationAvailable = true;
                updateAlertStatus();
                setTimeout(() => alert('âœ… Vibration funktioniert!'), 500);
            } else {
                vibrationAvailable = false;
                updateAlertStatus();
                alert('ğŸ’¾ Vibration nicht verfÃ¼gbar!\n\nGerÃ¤t unterstÃ¼tzt keine Vibration.');
            }
        }
        
        // ğŸ“± UPDATE STATUS INDICATORS
        function updateAlertStatus() {
            const soundIcon = document.getElementById('sound-status');
            const vibrationIcon = document.getElementById('vibration-status');
            const alertsIndicator = document.getElementById('alerts-indicator');
            
            if (currentView === 'driver' && (currentVehicle || isOnline)) {
                alertsIndicator.style.display = 'flex';
                
                if (soundIcon) {
                    soundIcon.textContent = soundAvailable ? 'ğŸ”Š' : 'ğŸ”‡';
                    soundIcon.title = soundAvailable ? 'Sound: OK' : 'Sound: Inaktiv';
                }
                
                if (vibrationIcon) {
                    vibrationIcon.textContent = vibrationAvailable ? 'ğŸ“³' : 'ğŸ“µ';
                    vibrationIcon.title = vibrationAvailable ? 'Vibration: OK' : 'Vibration: Inaktiv';
                }
            } else {
                alertsIndicator.style.display = 'none';
            }
        }
        
        // ğŸ†• v5.20.8: STORNIERUNG-ALARM FÃœR FAHRER
        function showCancellationAlarm(ride) {
            if (!ride) return;
            
            console.log('ğŸš¨ Zeige Stornierung-Alarm fÃ¼r:', ride.id);
            
            // Vibration
            if (navigator.vibrate) {
                navigator.vibrate([500, 200, 500, 200, 500]); // SOS Pattern
            }
            
            // Sound
            playDriverNotificationSound();
            
            // ğŸš¨ FULLSCREEN STORNIERUNG-ALARM
            const overlay = document.createElement('div');
            overlay.id = 'cancellation-alarm-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(220, 38, 38, 0.95);
                z-index: 99999;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                padding: 20px;
                animation: pulseRed 0.5s ease-in-out infinite alternate;
            `;
            
            // Animation CSS hinzufÃ¼gen
            const style = document.createElement('style');
            style.textContent = `
                @keyframes pulseRed {
                    from { background: rgba(220, 38, 38, 0.9); }
                    to { background: rgba(185, 28, 28, 0.95); }
                }
            `;
            document.head.appendChild(style);
            
            overlay.innerHTML = `
                <div style="text-align: center; color: white; max-width: 400px;">
                    <div style="font-size: 80px; margin-bottom: 20px;">ğŸš«</div>
                    <div style="font-size: 28px; font-weight: bold; margin-bottom: 20px;">
                        FAHRT STORNIERT!
                    </div>
                    
                    <div style="
                        background: rgba(255,255,255,0.15);
                        padding: 20px;
                        border-radius: 12px;
                        margin-bottom: 25px;
                        text-align: left;
                    ">
                        ${ride.customerName ? `<div style="font-size: 18px; margin-bottom: 10px;">ğŸ’¾ ${ride.customerName}</div>` : ''}
                        <div style="font-size: 14px; margin-bottom: 8px;">ğŸ“ Von: ${ride.pickup}</div>
                        <div style="font-size: 14px; margin-bottom: 8px;">ğŸ¯ Nach: ${ride.destination}</div>
                        <div style="font-size: 16px; font-weight: bold;">ğŸ’° ${ride.price}â‚¬</div>
                    </div>
                    
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 25px;">
                        Der Kunde hat die Fahrt storniert.
                    </div>
                    
                    <button onclick="closeCancellationAlarm()" style="
                        padding: 15px 40px;
                        background: white;
                        color: #dc2626;
                        border: none;
                        border-radius: 10px;
                        font-size: 18px;
                        font-weight: bold;
                        cursor: pointer;
                    ">
                        âœ“ Verstanden
                    </button>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Auch im AktivitÃ¤ts-Protokoll loggen
            logActivity('status', 'cancel_alert', `ğŸš¨ Stornierung-Alarm: ${ride.customerName || 'Kunde'}`, {
                customer: ride.customerName,
                from: ride.pickup,
                to: ride.destination,
                price: ride.price
            });
        }
        
        function closeCancellationAlarm() {
            const overlay = document.getElementById('cancellation-alarm-overlay');
            if (overlay) {
                overlay.remove();
            }
            // Aktualisiere stornierte Fahrten Liste
            loadCancelledRides();
            updateViews();
        }
        
        // ğŸš• FULLSCREEN POPUP FUNKTIONEN
        function showNewRideFullscreen() {
            if (!currentVehicle) return;
            
            // Zeige neue AuftrÃ¤ge die:
            // 1. Status 'new' haben UND (keine vehicleId ODER mir zugewiesen)
            // 2. ODER mir zugewiesen sind (assignedTo)
            const myRides = rides.filter(r => {
                const isNew = r.status === 'new';
                const isUnassigned = !r.vehicleId;
                const isAssignedToMe = r.assignedTo === currentVehicle;
                const isMyRide = r.vehicleId === currentVehicle || r.vehicle === (VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle);
                
                // ğŸ†• v5.26.14h: Nur zeigen wenn noch NICHT gezeigt!
                const notShownYet = !shownRidePopups.has(r.firebaseId || r.id);
                
                return (isNew && (isUnassigned || isMyRide || isAssignedToMe) && notShownYet);
            });
            
            if (myRides.length === 0) return;
            
            // Zeige ersten neuen Auftrag
            const ride = myRides[0];
            
            // ğŸ†• v5.26.14h: Merke dass wir diese Fahrt gezeigt haben!
            shownRidePopups.add(ride.firebaseId || ride.id);
            console.log('âœ… Zeige Popup fÃ¼r Fahrt:', ride.firebaseId || ride.id);
            
            const content = `
                <div style="background: #f3f4f6; padding: 12px; border-radius: 10px; margin-bottom: 12px;">
                    ${ride.customerName ? `
                    <div style="background: #dbeafe; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                        <div style="font-size: 16px; font-weight: 600; color: #1e3a8a;">
                            ğŸ’¾ ${ride.customerName}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 8px;">
                        <span style="font-size: 11px; color: #666;">ğŸ“</span>
                        <span style="font-size: 14px; font-weight: 500;">${ride.pickup}</span>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <span style="font-size: 11px; color: #666;">ğŸ¯</span>
                        <span style="font-size: 14px; font-weight: 500;">${ride.destination}</span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                        <div>
                            <span style="font-size: 11px; color: #666;">â°</span>
                            <span style="font-size: 14px; font-weight: 600;">${ride.pickupTime || 'Sofort'}</span>
                        </div>
                        <div>
                            <span style="font-size: 14px; font-weight: 700; color: #10b981;">ğŸ’° ${ride.price}â‚¬</span>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button onclick="rejectRide('${ride.firebaseId || ride.id}')" style="
                        padding: 14px;
                        background: white;
                        color: #ef4444;
                        border: 2px solid #ef4444;
                        border-radius: 10px;
                        font-size: 14px;
                        font-weight: 700;
                        cursor: pointer;
                    ">
                        ğŸ’¾ Nein
                    </button>
                    <button onclick="acceptRideFromFullscreen('${ride.firebaseId || ride.id}')" style="
                        padding: 14px;
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        font-size: 14px;
                        font-weight: 700;
                        cursor: pointer;
                    ">
                        âœ… Ja
                    </button>
                </div>
            `;
            
            document.getElementById('new-ride-fullscreen-content').innerHTML = content;
            document.getElementById('new-ride-fullscreen').style.display = 'block';
            
            // ğŸ“³ WIEDERKEHRENDE VIBRATION BIS REAKTION!
            startRepeatingVibration();
        }
        
        // ğŸ†• v5.26.14h: POPUP-DEDUPLIZIERUNG
        const shownRidePopups = new Set(); // Merke bereits gezeigte Fahrten
        
        // ğŸ“³ VIBRATIONS-SYSTEM
        let vibrationInterval = null;
        let vibrationCount = 0;
        
        function startRepeatingVibration() {
            // Stoppe alte Vibration falls vorhanden
            stopRepeatingVibration();
            
            vibrationCount = 0;
            
            // Sofort erste Vibration
            doVibration();
            
            // Wiederhole alle 3 Sekunden, maximal 10 Mal
            vibrationInterval = setInterval(() => {
                vibrationCount++;
                
                if (vibrationCount >= 10) {
                    stopRepeatingVibration();
                    return;
                }
                
                doVibration();
            }, 3000); // Alle 3 Sekunden
        }
        
        function doVibration() {
            if (navigator.vibrate) {
                // Kurz-Lang-Kurz-Lang-Kurz Pattern
                navigator.vibrate([200, 100, 400, 100, 200]);
            }
        }
        
        function stopRepeatingVibration() {
            if (vibrationInterval) {
                clearInterval(vibrationInterval);
                vibrationInterval = null;
            }
            vibrationCount = 0;
        }
        
        function closeNewRideFullscreen() {
            stopRepeatingVibration(); // Stoppe Vibration!
            document.getElementById('new-ride-fullscreen').style.display = 'none';
        }
        
        async function acceptRideFromFullscreen(rideId) {
            stopRepeatingVibration(); // Stoppe Vibration!
            closeNewRideFullscreen();
            // Nutze existierende acceptRide Funktion
            await acceptRide(rideId);
        }
        
        async function rejectRide(rideId) {
            if (!confirm('Auftrag wirklich ablehnen?\n\nDer Auftrag bleibt im System und kann anderen Fahrern zugewiesen werden.')) {
                return;
            }
            
            stopRepeatingVibration(); // Stoppe Vibration!
            
            try {
                const ride = rides.find(r => (r.firebaseId || r.id) === rideId);
                if (!ride) {
                    alert('ğŸ’¾ Fahrt nicht gefunden!');
                    return;
                }
                
                // Update in Firebase
                const updates = {
                    status: 'rejected',
                    rejectedBy: currentVehicle,
                    rejectedAt: new Date().toISOString(),
                    rejectedByDriver: VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle
                };
                
                if (isFirebaseReady) {
                    await db.ref('rides/' + rideId).update(updates);
                    console.log('ğŸ’¾ Auftrag abgelehnt:', rideId);
                }
                
                // Update lokal
                Object.assign(ride, updates);
                saveRides();
                
                closeNewRideFullscreen();
                updateViews();
                
                alert('âœ… Auftrag abgelehnt!\n\nDer Auftrag bleibt im System fÃ¼r andere Fahrer.');
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Ablehnen:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }

        function playArrivalSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const beeps = [0, 0.15, 0.3];
                
                beeps.forEach((time) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime + time);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + time + 0.1);
                    
                    oscillator.start(audioContext.currentTime + time);
                    oscillator.stop(audioContext.currentTime + time + 0.1);
                });
            } catch (e) {
                console.error('Sound Fehler:', e);
            }
        }

        // HISTORY
        function saveToHistory(ride) {
            try {
                let history = JSON.parse(localStorage.getItem('ride-history') || '[]');
                
                if (!history.find(r => r.id === ride.id)) {
                    history.unshift({
                        id: ride.id,
                        customerName: ride.customerName,
                        pickup: ride.pickup,
                        destination: ride.destination,
                        pickupLat: ride.pickupCoords?.lat,
                        pickupLon: ride.pickupCoords?.lon,
                        destLat: ride.destCoords?.lat,
                        destLon: ride.destCoords?.lon,
                        vehicle: ride.vehicle,
                        price: ride.price,
                        distance: ride.distance,
                        time: ride.time,
                        completedAt: new Date().toLocaleString('de-DE')
                    });
                    
                    if (history.length > 50) history = history.slice(0, 50);
                    localStorage.setItem('ride-history', JSON.stringify(history));
                }
            } catch (e) {
                console.error('Fehler beim Speichern der Historie:', e);
            }
        }

        // ğŸ”„ ROUTE UMDREHEN
        function reverseRoute(pickup, destination, pickupLat, pickupLon, destLat, destLon) {
            // Tausche Abholort und Zielort
            document.getElementById('pickup').value = destination;
            document.getElementById('destination').value = pickup;
            
            // Tausche Koordinaten
            if (destLat && destLon) {
                pickupCoords = { lat: parseFloat(destLat), lon: parseFloat(destLon) };
            }
            if (pickupLat && pickupLon) {
                destCoords = { lat: parseFloat(pickupLat), lon: parseFloat(pickupLon) };
            }
            
            // Wechsle zur Fahrgast-Ansicht
            switchView('passenger');
            
            // Zeige BestÃ¤tigung
            const banner = document.createElement('div');
            banner.style.cssText = 'background:#667eea;color:white;padding:15px;border-radius:8px;margin-bottom:15px;text-align:center;';
            banner.innerHTML = 'ğŸ”„ <strong>Route wurde umgedreht!</strong><br><span style="font-size:13px;">ÃœberprÃ¼fe die Adressen und berechne den Preis.</span>';
            
            const bookingForm = document.getElementById('booking-form');
            bookingForm.insertBefore(banner, bookingForm.firstChild);
            setTimeout(() => banner.remove(), 4000);
        }

        // ğŸ“‹ NOCHMAL BUCHEN
        function bookAgain(pickup, destination, pickupLat, pickupLon, destLat, destLon) {
            // FÃ¼lle Felder aus
            document.getElementById('pickup').value = pickup;
            document.getElementById('destination').value = destination;
            
            // Setze Koordinaten
            if (pickupLat && pickupLon) {
                pickupCoords = { lat: parseFloat(pickupLat), lon: parseFloat(pickupLon) };
            }
            if (destLat && destLon) {
                destCoords = { lat: parseFloat(destLat), lon: parseFloat(destLon) };
            }
            
            // Wechsle zur Fahrgast-Ansicht
            switchView('passenger');
            
            // Zeige BestÃ¤tigung
            const banner = document.createElement('div');
            banner.style.cssText = 'background:#10b981;color:white;padding:15px;border-radius:8px;margin-bottom:15px;text-align:center;';
            banner.innerHTML = 'ğŸ“‹ <strong>Route wurde geladen!</strong><br><span style="font-size:13px;">ÃœberprÃ¼fe die Adressen und berechne den Preis.</span>';
            
            const bookingForm = document.getElementById('booking-form');
            bookingForm.insertBefore(banner, bookingForm.firstChild);
            setTimeout(() => banner.remove(), 4000);
        }

        // â­ ALS FAVORIT SPEICHERN
        function addToFavorites(pickup, destination, pickupLat, pickupLon, destLat, destLon) {
            try {
                let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
                
                // PrÃ¼fe ob bereits vorhanden
                const exists = favorites.some(f => 
                    f.pickup === pickup && f.destination === destination
                );
                
                if (exists) {
                    alert('â­ Diese Route ist bereits in deinen Favoriten!');
                    return;
                }
                
                // FÃ¼ge zu Favoriten hinzu
                favorites.push({
                    pickup: pickup,
                    destination: destination,
                    pickupLat: pickupLat,
                    pickupLon: pickupLon,
                    destLat: destLat,
                    destLon: destLon,
                    addedAt: Date.now()
                });
                
                localStorage.setItem('favorites', JSON.stringify(favorites));
                
                alert('â­ Favorit gespeichert!\n\nDiese Route findest du jetzt in deinen Favoriten.');
                
                console.log('â­ Favorit gespeichert:', { pickup, destination });
            } catch (e) {
                console.error('ğŸ’¾ Fehler beim Speichern des Favoriten:', e);
                alert('ğŸ’¾ Fehler beim Speichern');
            }
        }

        // ğŸ”— MAP-NULL-CHECK-FIX-LINK KOPIEREN
        // ğŸ†• v5.30.4: Tracking-Link teilen (optional)
        function shareTrackingLink(link) {
            // Kopiere Link
            navigator.clipboard.writeText(link).then(() => {
                showNotification('âœ… Link kopiert! Du kannst ihn jetzt teilen.', 'success');
            }).catch(() => {
                // Fallback fÃ¼r Ã¤ltere Browser
                const input = document.createElement('input');
                input.value = link;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                showNotification('âœ… Link kopiert!', 'success');
            });
        }
        
        // ğŸ†• v5.32.4: Tracking-Link direkt Ã¶ffnen
        function openTrackingLink(link) {
            window.open(link, '_blank');
        }
        
        // ALTE FUNKTION (bleibt fÃ¼r RÃ¼ckwÃ¤rts-KompatibilitÃ¤t)
        function copyTrackingLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                alert('âœ… Link kopiert!\n\nDu kannst diesen Link speichern oder per WhatsApp teilen.');
            }).catch(() => {
                // Fallback fÃ¼r Ã¤ltere Browser
                const input = document.createElement('input');
                input.value = link;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                alert('âœ… Link kopiert!');
            });
        }
        
        function shareViaWhatsApp(link) {
            const message = `ğŸš• Dein Taxi kannst du hier live verfolgen:\n\n${link}\n\nFunk Taxi Heringsdorf`;
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }
        
        async function closeRide() {
            // ğŸ†• Setze Fahrt auf "completed" in Firebase damit sie nicht wieder auftaucht!
            if (myCurrentRide && myCurrentRide.firebaseId && isFirebaseReady) {
                try {
                    await updateRide(myCurrentRide.firebaseId, {
                        status: 'completed',
                        completedAt: Date.now()
                    });
                    console.log('âœ… Fahrt auf completed gesetzt');
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim SchlieÃŸen:', error);
                }
            }
            
            localStorage.removeItem('myCurrentRideId');
            myCurrentRide = null;
            
            // ğŸ†• v5.49.2: Modal verstecken!
            hideRideStatusModal();
            
            document.getElementById('booking-form').style.display = 'block';
            
            // ğŸ†• FORMULAR KOMPLETT ZURÃœCKSETZEN
            resetBookingForm();
            
            document.getElementById('confirm').innerHTML = '<div class="alert-success">âœ“ Fahrt wurde in Ihrem Verlauf gespeichert</div>';
            setTimeout(() => document.getElementById('confirm').innerHTML = '', 3000);
        }
        
        // ğŸ†• v5.49.2: Hilfsfunktion zum Verstecken des Modals
        function hideRideStatusModal() {
            const container = document.getElementById('ride-status-container');
            container.innerHTML = '';
            container.style.display = 'none';
        }
        
        function closeFutureRide(rideId) {
            // ğŸ†• v5.32.5n: ALLES lÃ¶schen - KOMPLETT wie Abbrechen!
            console.log('âœ… OK - LÃ¶sche ALLE Felder im Fahrgast-Bereich');
            
            // ğŸ†• v5.49.2: Modal verstecken!
            hideRideStatusModal();
            
            // 1. Card schlieÃŸen
            localStorage.removeItem('myCurrentRideId');
            myCurrentRide = null;
            document.getElementById('booking-form').style.display = 'block';
            
            // 2. ALLE Eingabefelder leeren
            document.getElementById('customer-name').value = '';
            document.getElementById('customer-phone').value = '';
            document.getElementById('pickup').value = '';
            document.getElementById('destination').value = '';
            document.getElementById('passengers').value = '1';
            
            // ğŸ†• v5.49.6: Confirmation-Felder verstecken!
            const pickupConf = document.getElementById('pickup-confirmation');
            const destConf = document.getElementById('destination-confirmation');
            if (pickupConf) pickupConf.style.display = 'none';
            if (destConf) destConf.style.display = 'none';
            
            // 3. VORBESTELL-FELDER leeren
            document.getElementById('custom-date').value = '';
            document.getElementById('custom-hour').value = '00';
            document.getElementById('custom-minute').value = '00';
            
            // 4. Karte verstecken
            const routeMap = document.getElementById('route-map');
            if (routeMap) routeMap.style.display = 'none';
            
            // 5. Preis verstecken
            document.getElementById('price-display').innerHTML = '';
            
            // 6. Taxi buchen Button verstecken
            document.getElementById('book-btn').style.display = 'none';
            
            // ğŸ†• v5.90.526: Freie Zeiten Button verstecken
            const slotsBtn = document.getElementById('show-slots-btn');
            if (slotsBtn) slotsBtn.style.display = 'none';
            
            // 7. VerfÃ¼gbare Taxis verstecken
            document.getElementById('available-taxis-display').innerHTML = '';
            
            // 8. Button zurÃ¼ck zu "Preis berechnen"
            const priceBtn = document.getElementById('price-btn');
            priceBtn.innerHTML = 'ğŸ’° Preis berechnen';
            priceBtn.classList.remove('btn-danger');
            priceBtn.classList.add('btn-primary');
            
            // 9. Status zurÃ¼cksetzen
            priceCalculated = false;
            window.currentPrice = null;
            window.currentDistance = null;
            window.currentDuration = null;
            pickupCoords = null;
            destCoords = null;
            
            // 10. ZurÃ¼ck zu SOFORT-Modus
            selectRideType('sofort');
            
            // 11. Verlauf aktualisieren
            updateHistoryView();
            
            console.log('âœ… ALLES gelÃ¶scht - Fahrgast-Bereich komplett zurÃ¼ckgesetzt!');
        }

        function loadHistory() {
            try {
                const history = JSON.parse(localStorage.getItem('ride-history') || '[]');
                const container = document.getElementById('history-list');
                
                if (history.length === 0) {
                    container.innerHTML = '<div style="padding:40px 20px;text-align:center;color:#999;">Noch keine Fahrten</div>';
                    return;
                }
                
                container.innerHTML = history.map(r => `
                    <div class="ride-card">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <strong style="color:#667eea;">#${r.id}</strong>
                            <span style="background:#d1fae5;padding:4px 8px;border-radius:12px;font-size:12px;color:#065f46;">Abgeschlossen</span>
                        </div>
                        ${r.customerName ? `<div style="font-size:15px;font-weight:600;margin-bottom:8px;">ğŸ’¾ ${r.customerName}</div>` : ''}
                        <div style="font-size:14px;color:#666;line-height:1.8;">
                            <strong>Von:</strong> ${r.pickup}<br>
                            <strong>Nach:</strong> ${r.destination}<br>
                            <strong>Fahrzeug:</strong> ${r.vehicle || 'Taxi'}<br>
                            <strong>Distanz:</strong> ${r.distance} km<br>
                            <strong>Preis:</strong> ${r.price}â‚¬<br>
                            <small style="opacity:0.7;">Abgeschlossen: ${r.completedAt || r.time}</small>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:15px;">
                            <button onclick="reverseRoute('${r.pickup.replace(/'/g, "\\'")}', '${r.destination.replace(/'/g, "\\'")}', ${r.pickupLat || 'null'}, ${r.pickupLon || 'null'}, ${r.destLat || 'null'}, ${r.destLon || 'null'})" 
                                style="padding:10px;border:2px solid #667eea;background:white;color:#667eea;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;">
                                ğŸ”„ Route umdrehen
                            </button>
                            <button onclick="bookAgain('${r.pickup.replace(/'/g, "\\'")}', '${r.destination.replace(/'/g, "\\'")}', ${r.pickupLat || 'null'}, ${r.pickupLon || 'null'}, ${r.destLat || 'null'}, ${r.destLon || 'null'})" 
                                style="padding:10px;border:2px solid #10b981;background:white;color:#10b981;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;">
                                ğŸ“‹ Nochmal buchen
                            </button>
                        </div>
                        <button onclick="addToFavorites('${r.pickup.replace(/'/g, "\\'")}', '${r.destination.replace(/'/g, "\\'")}', ${r.pickupLat || 'null'}, ${r.pickupLon || 'null'}, ${r.destLat || 'null'}, ${r.destLon || 'null'})" 
                            style="padding:10px;border:2px solid #f59e0b;background:white;color:#f59e0b;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;width:100%;margin-top:8px;">
                            â­ Als Favorit speichern
                        </button>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Fehler beim Laden der Historie:', e);
            }
        }

        // RIDE STATUS & MAP-NULL-CHECK-FIX
        // ğŸ†• v5.90.329: KOMPLETTES 5-PHASEN MAP-NULL-CHECK-FIX FÃœR FAHRGÃ„STE!
        let rideStatusListener = null; // Firebase Listener fÃ¼r Live-Updates
        let rideTrackingMap = null; // Karte fÃ¼r Live-Tracking
        let taxiMarkerTracking = null; // Taxi-Marker
        let customerMarkerTracking = null; // Kunden-Marker
        let trackingUpdateInterval = null; // Update-Interval
        
        function showRideStatus(ride) {
            console.log('ğŸ” v5.90.329: showRideStatus fÃ¼r Status:', ride.status);
            
            const container = document.getElementById('ride-status-container');
            
            // ğŸ”„ AKTIVIERE FIREBASE LISTENER fÃ¼r Live-Updates!
            startRideStatusListener(ride.firebaseId);
            
            // ğŸ“… CHECK: Ist die Fahrt in der Zukunft?
            const now = Date.now();
            const isFutureRide = ride.pickupTimestamp && ride.pickupTimestamp > now + (30 * 60000);
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // PHASE 0: VORBESTELLUNG (Zukunft)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (ride.status === 'vorbestellt' || (ride.status === 'new' && isFutureRide)) {
                showPhasePrebooked(ride, container);
                return;
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // PHASE 1: SUCHE FAHRER (new / assigned ohne Fahrer)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (ride.status === 'new' || (ride.status === 'assigned' && !ride.vehicleId)) {
                showPhaseSearching(ride, container);
                return;
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // PHASE 2: FAHRER GEFUNDEN (assigned mit vehicleId oder accepted)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if ((ride.status === 'assigned' && ride.vehicleId) || ride.status === 'accepted') {
                showPhaseDriverAssigned(ride, container);
                return;
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // PHASE 3: FAHRER UNTERWEGS (on_way)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (ride.status === 'on_way') {
                showPhaseDriverComing(ride, container);
                return;
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // PHASE 4: FAHRT LÃ„UFT (picked_up)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (ride.status === 'picked_up') {
                showPhaseDriving(ride, container);
                return;
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // PHASE 5: FERTIG (completed)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (ride.status === 'completed') {
                showPhaseCompleted(ride, container);
                return;
            }
        }
        
        // ğŸ”„ FIREBASE LISTENER fÃ¼r Live-Updates
        function startRideStatusListener(rideId) {
            // Stoppe alten Listener
            if (rideStatusListener) {
                rideStatusListener.off();
            }
            
            console.log('ğŸ”„ v5.90.329: Starte Live-Listener fÃ¼r Fahrt:', rideId);
            
            // HÃ¶re auf Ã„nderungen
            rideStatusListener = db.ref(`rides/${rideId}`);
            rideStatusListener.on('value', (snapshot) => {
                const ride = snapshot.val();
                if (!ride) {
                    console.log('âš ï¸ Fahrt nicht mehr in DB');
                    return;
                }
                
                ride.firebaseId = rideId; // Wichtig fÃ¼r andere Funktionen
                
                console.log('ğŸ”„ Status Update empfangen:', ride.status);
                
                // Update die Ansicht basierend auf neuem Status
                showRideStatus(ride);
            });
        }
        
        // ğŸ›‘ STOPPE LISTENER
        function stopRideStatusListener() {
            if (rideStatusListener) {
                rideStatusListener.off();
                rideStatusListener = null;
                console.log('ğŸ›‘ Live-Listener gestoppt');
            }
            
            // Stoppe Update-Interval
            if (trackingUpdateInterval) {
                clearInterval(trackingUpdateInterval);
                trackingUpdateInterval = null;
            }
            
            // Entferne Karte
            if (rideTrackingMap) {
                rideTrackingMap.remove();
                rideTrackingMap = null;
                taxiMarkerTracking = null;
                customerMarkerTracking = null;
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PHASE 0: VORBESTELLUNG
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showPhasePrebooked(ride, container) {
            const pickupDate = new Date(ride.pickupTimestamp);
            const formattedDate = pickupDate.toLocaleDateString('de-DE', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
            const formattedTime = pickupDate.toLocaleTimeString('de-DE', { 
                hour: '2-digit', minute: '2-digit' 
            });
            
            container.style.display = 'flex';
            container.style.alignItems = 'center';
            container.style.justifyContent = 'center';
            
            container.innerHTML = `
                <div class="ride-status-box" style="background:#e0f2fe;border:2px solid #0ea5e9;max-width:500px;width:100%;margin:auto;">
                    <div style="font-size: 48px; margin-bottom: 12px;">ğŸ“…</div>
                    <h3 style="font-size: 20px; margin-bottom: 12px;">Vorbestellung bestÃ¤tigt!</h3>
                    
                    <div style="margin-top: 16px; padding: 16px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                        <div style="font-size: 18px; font-weight: 600; color: #0c4a6e; margin-bottom: 8px;">
                            ğŸ• ${formattedDate}<br>um ${formattedTime} Uhr
                        </div>
                    </div>
                    
                    <div style="margin-top: 16px; font-size: 14px; color: #0c4a6e; text-align: left;">
                        <strong>ğŸ“ Von:</strong> ${ride.pickup}<br>
                        <strong>ğŸ¯ Nach:</strong> ${ride.destination}<br>
                        <strong>ğŸ’° Preis:</strong> ${ride.price}â‚¬
                    </div>
                    
                    <div style="margin-top: 16px; padding: 12px; background: #dcfce7; border-radius: 6px; font-size: 13px; color: #14822d;">
                        âœ… 15 Minuten vor der Abholung wird ein Fahrer zugewiesen.
                    </div>
                    
                    <div style="display:flex;gap:8px;margin-top:16px;">
                        <button onclick="closeFutureRide('${ride.firebaseId}')" 
                                style="flex:1;padding:12px;border:none;background:#10b981;color:white;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;">
                            âœ“ OK
                        </button>
                        <button onclick="cancelRideConfirm('${ride.firebaseId}')" 
                                style="flex:1;padding:12px;border:none;background:#ef4444;color:white;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;">
                            ğŸ’¾ Stornieren
                        </button>
                    </div>
                </div>
            `;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PHASE 1: SUCHE FAHRER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showPhaseSearching(ride, container) {
            const statusText = ride.status === 'assigned' ? 'Wird vermittelt...' : 'Suche Fahrer...';
            const statusIcon = ride.status === 'assigned' ? 'ğŸ”„' : 'ğŸ”';
            
            const createdTime = new Date(ride.createdAt || Date.now());
            const createdTimeStr = createdTime.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            
            container.style.display = 'flex';
            container.style.alignItems = 'center';
            container.style.justifyContent = 'center';
            
            container.innerHTML = `
                <div class="ride-status-box" style="background:#fef3c7;border:2px solid #f59e0b;max-width:500px;width:100%;margin:auto;">
                    <div style="font-size: 48px; margin-bottom: 12px;">${statusIcon}</div>
                    <h3 style="font-size: 20px; margin-bottom: 8px;">${statusText}</h3>
                    <p style="font-size: 14px; color: #92400e; margin: 8px 0;">Bitte haben Sie einen Moment Geduld...</p>
                    
                    <div style="background:#fffbeb;padding:16px;border-radius:8px;margin:16px 0;text-align:left;">
                        <div style="font-size:14px;line-height:1.8;color:#92400e;">
                            <strong>ğŸ“ Von:</strong> ${ride.pickup}<br>
                            <strong>ğŸ¯ Nach:</strong> ${ride.destination}<br>
                            <strong>ğŸ• Bestellt:</strong> ${createdTimeStr} Uhr<br>
                            <strong>ğŸ’° Preis:</strong> ${ride.price}â‚¬
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:8px;margin-top:16px;">
                        <button onclick="cancelRideConfirm('${ride.firebaseId}')" 
                                style="flex:1;padding:12px;border:none;background:#ef4444;color:white;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;">
                            ğŸ’¾ Abbrechen
                        </button>
                    </div>
                </div>
            `;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PHASE 2: FAHRER GEFUNDEN
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function showPhaseDriverAssigned(ride, container) {
            console.log('âœ… v5.90.329: Fahrer gefunden Phase!', ride.vehicleId);
            
            // Hole Fahrzeug-Daten
            let vehicleName = ride.vehicle || ride.assignedVehicleName || 'Taxi';
            let vehiclePlate = ride.vehiclePlate || '';
            let driverPhone = '';
            
            // Versuche Fahrzeug-Details zu laden
            if (ride.vehicleId) {
                try {
                    const vehicleSnap = await db.ref(`vehicles/${ride.vehicleId}`).once('value');
                    const vehicleData = vehicleSnap.val();
                    if (vehicleData) {
                        vehiclePlate = VEHICLES[ride.vehicleId]?.plate || vehiclePlate;
                        driverPhone = vehicleData.phone || '';
                    }
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim Laden des Fahrzeugs:', error);
                }
            }
            
            container.style.display = 'flex';
            container.style.alignItems = 'center';
            container.style.justifyContent = 'center';
            
            container.innerHTML = `
                <div class="ride-status-box" style="background:#dbeafe;border:2px solid #3b82f6;max-width:500px;width:100%;margin:auto;">
                    <div style="font-size: 48px; margin-bottom: 12px;">âœ…</div>
                    <h3 style="font-size: 20px; margin-bottom: 8px;">Fahrer gefunden!</h3>
                    <p style="font-size: 14px; color: #1e40af; margin: 8px 0;">Ihr Taxi ist auf dem Weg zu Ihnen</p>
                    
                    <div style="background:#eff6ff;padding:16px;border-radius:8px;margin:16px 0;">
                        <div style="font-size: 18px; font-weight: 700; color: #1e40af; margin-bottom: 8px;">
                            ğŸš— ${vehicleName}
                        </div>
                        ${vehiclePlate ? `<div style="font-size: 14px; color: #3b82f6; font-weight: 600;">ğŸš™ ${vehiclePlate}</div>` : ''}
                        <div style="font-size: 13px; color: #1e3a8a; margin-top: 12px;">
                            â±ï¸ Ankunft: ca. 5 Minuten
                        </div>
                    </div>
                    
                    <div style="text-align:left; font-size:14px; color:#1e3a8a; margin-bottom:16px;">
                        <strong>ğŸ“ Abholung:</strong> ${ride.pickup}<br>
                        <strong>ğŸ¯ Ziel:</strong> ${ride.destination}<br>
                        <strong>ğŸ’° Preis:</strong> ${ride.price}â‚¬
                    </div>
                    
                    <div style="display:flex;gap:8px;">
                        ${driverPhone ? `
                        <a href="tel:${driverPhone}" 
                           style="flex:1;padding:12px;background:#10b981;color:white;text-align:center;border-radius:6px;font-weight:600;font-size:14px;text-decoration:none;">
                            ğŸ’¾ Fahrer anrufen
                        </a>
                        ` : ''}
                        <button onclick="cancelRideConfirm('${ride.firebaseId}')" 
                                style="flex:1;padding:12px;border:none;background:#ef4444;color:white;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;">
                            ğŸ’¾ Abbrechen
                        </button>
                    </div>
                </div>
            `;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PHASE 3: FAHRER UNTERWEGS (MIT LIVE-KARTE!)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function showPhaseDriverComing(ride, container) {
            console.log('ğŸš— v5.90.329: Fahrer unterwegs Phase!');
            
            // PrÃ¼fe ob GPS-Daten vorhanden
            if (!ride.vehicleId || !ride.pickupCoords) {
                // Fallback ohne Karte
                showPhaseDriverAssigned(ride, container);
                return;
            }
            
            // Hole aktuelle Fahrer-Position
            const vehicleSnap = await db.ref(`vehicles/${ride.vehicleId}`).once('value');
            const vehicleData = vehicleSnap.val();
            
            if (!vehicleData || !vehicleData.lat || !vehicleData.lon) {
                showPhaseDriverAssigned(ride, container);
                return;
            }
            
            const driverLoc = { lat: vehicleData.lat, lon: vehicleData.lon };
            const customerLoc = ride.pickupCoords;
            
            // Berechne Route
            const route = await calculateRoute(driverLoc, customerLoc);
            const distanceKm = parseFloat(route.distance) || 0;
            const durationMin = parseInt(route.duration) || 0;
            
            const eta = new Date(Date.now() + durationMin * 60000);
            const etaTime = eta.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            
            // Hole Fahrzeug-Details
            const vehicleName = ride.vehicle || VEHICLES[ride.vehicleId]?.name || 'Taxi';
            const vehiclePlate = VEHICLES[ride.vehicleId]?.plate || '';
            const driverPhone = vehicleData.phone || '';
            
            container.style.display = 'block';
            
            container.innerHTML = `
                <div class="ride-status-box" style="background:#dcfce7;border:2px solid #10b981;max-width:600px;width:100%;margin:auto;">
                    <div style="font-size: 48px; margin-bottom: 12px;">ğŸš—</div>
                    <h3 style="font-size: 20px; margin-bottom: 8px;">${vehicleName} kommt!</h3>
                    
                    <div style="background:#f0fdf4;padding:16px;border-radius:8px;margin:16px 0;">
                        <div style="font-size: 16px; font-weight: 700; color: #065f46; margin-bottom: 8px;">
                            ğŸ“ ${distanceKm} km entfernt
                        </div>
                        <div style="font-size: 14px; color: #048257;">
                            â±ï¸ Ankunft: ca. ${durationMin} Min (${etaTime} Uhr)
                        </div>
                        ${vehiclePlate ? `<div style="font-size: 13px; color: #065f46; margin-top: 8px;">ğŸš™ ${vehiclePlate}</div>` : ''}
                    </div>
                    
                    <div id="ride-tracking-map" style="width:100%;height:300px;border-radius:8px;margin:16px 0;"></div>
                    
                    <div style="text-align:left; font-size:14px; color:#065f46; margin-bottom:16px;">
                        <strong>ğŸ“ Abholung:</strong> ${ride.pickup}<br>
                        <strong>ğŸ¯ Ziel:</strong> ${ride.destination}<br>
                        <strong>ğŸ’° Preis:</strong> ${ride.price}â‚¬
                    </div>
                    
                    <div style="display:flex;gap:8px;">
                        ${driverPhone ? `
                        <a href="tel:${driverPhone}" 
                           style="flex:1;padding:12px;background:#10b981;color:white;text-align:center;border-radius:6px;font-weight:600;font-size:14px;text-decoration:none;">
                            ğŸ’¾ Anrufen
                        </a>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // Initialisiere Karte
            initTrackingMap(driverLoc, customerLoc, ride.vehicleId);
        }
        
        // ğŸ—ºï¸ INITIALISIERE MAP-NULL-CHECK-FIX-KARTE
        function initTrackingMap(driverLoc, customerLoc, vehicleId) {
            // Warte kurz bis DOM bereit ist
            setTimeout(() => {
                const mapContainer = document.getElementById('ride-tracking-map');
                if (!mapContainer) return;
                
                // Entferne alte Karte
                if (rideTrackingMap) {
                    rideTrackingMap.remove();
                }
                
                // Erstelle Karte
                rideTrackingMap = L.map('ride-tracking-map').setView(
                    [driverLoc.lat, driverLoc.lon], 
                    14
                );
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap'
                }).addTo(rideTrackingMap);
                
                // Taxi-Marker
                const taxiIcon = L.divIcon({
                    html: 'ğŸš•',
                    className: 'taxi-marker',
                    iconSize: [30, 30]
                });
                taxiMarkerTracking = L.marker([driverLoc.lat, driverLoc.lon], { icon: taxiIcon })
                    .addTo(rideTrackingMap)
                    .bindPopup('Ihr Taxi');
                
                // Kunden-Marker
                const customerIcon = L.divIcon({
                    html: 'ğŸ“',
                    className: 'customer-marker',
                    iconSize: [30, 30]
                });
                customerMarkerTracking = L.marker([customerLoc.lat, customerLoc.lon], { icon: customerIcon })
                    .addTo(rideTrackingMap)
                    .bindPopup('Sie sind hier');
                
                // Zoom auf beide Punkte
                const bounds = L.latLngBounds([
                    [driverLoc.lat, driverLoc.lon],
                    [customerLoc.lat, customerLoc.lon]
                ]);
                rideTrackingMap.fitBounds(bounds, { padding: [50, 50] });
                
                // Starte Live-Updates (alle 5 Sek)
                if (trackingUpdateInterval) {
                    clearInterval(trackingUpdateInterval);
                }
                
                trackingUpdateInterval = setInterval(async () => {
                    const snap = await db.ref(`vehicles/${vehicleId}`).once('value');
                    const vehicle = snap.val();
                    if (vehicle && vehicle.lat && vehicle.lon) {
                        // Update Marker-Position
                        taxiMarkerTracking.setLatLng([vehicle.lat, vehicle.lon]);
                        
                        // Berechne neue Distanz
                        const newRoute = await calculateRoute(
                            { lat: vehicle.lat, lon: vehicle.lon },
                            customerLoc
                        );
                        
                        console.log('ğŸ”„ Position aktualisiert:', newRoute.distance, 'km');
                    }
                }, 5000); // Alle 5 Sekunden
            }, 100);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PHASE 4: FAHRT LÃ„UFT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showPhaseDriving(ride, container) {
            const vehicleName = ride.vehicle || 'Ihr Taxi';
            const vehiclePlate = ride.vehiclePlate || '';
            
            container.style.display = 'flex';
            container.style.alignItems = 'center';
            container.style.justifyContent = 'center';
            
            container.innerHTML = `
                <div class="ride-status-box" style="background:#fef3c7;border:2px solid #f59e0b;max-width:500px;width:100%;margin:auto;">
                    <div style="font-size: 48px; margin-bottom: 12px;">ğŸ¯</div>
                    <h3 style="font-size: 20px; margin-bottom: 8px;">Gute Fahrt!</h3>
                    <p style="font-size: 14px; color: #92400e; margin: 8px 0;">
                        ${vehicleName} bringt Sie zu Ihrem Ziel
                    </p>
                    
                    <div style="background:#fffbeb;padding:16px;border-radius:8px;margin:16px 0;text-align:left;">
                        ${vehiclePlate ? `<div style="font-size: 16px; color: #92400e; font-weight: 600; margin-bottom: 8px;">ğŸš™ ${vehiclePlate}</div>` : ''}
                        <div style="font-size:14px;line-height:1.8;color:#92400e;">
                            <strong>ğŸ“ Von:</strong> ${ride.pickup}<br>
                            <strong>ğŸ¯ Nach:</strong> ${ride.destination}<br>
                            ${ride.distance ? `<strong>ğŸ“ Strecke:</strong> ${ride.distance} km<br>` : ''}
                            <strong>ğŸ’° Preis:</strong> ${ride.price}â‚¬
                        </div>
                    </div>
                    
                    <div style="font-size: 13px; color: #92400e; padding: 12px; background: #fef9c3; border-radius: 6px;">
                        â±ï¸ Sie kommen gleich an!
                    </div>
                </div>
            `;
            
            // Sound abspielen (nur einmal)
            if (!window.lastPickedUpRide || window.lastPickedUpRide !== ride.firebaseId) {
                playArrivalSound();
                window.lastPickedUpRide = ride.firebaseId;
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PHASE 5: FERTIG
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showPhaseCompleted(ride, container) {
            console.log('âœ… v5.90.329: Fahrt abgeschlossen!');
            
            // Stoppe Listener
            stopRideStatusListener();
            
            const vehicleName = ride.vehicle || 'Taxi';
            const vehiclePlate = ride.vehiclePlate || '';
            
            container.style.display = 'flex';
            container.style.alignItems = 'center';
            container.style.justifyContent = 'center';
            
            container.innerHTML = `
                <div class="ride-status-box" style="background:#d1fae5;border:2px solid:#10b981;max-width:500px;width:100%;margin:auto;">
                    <div style="font-size: 56px; margin-bottom: 16px;">âœ…</div>
                    <h3 style="font-size: 22px; margin-bottom: 12px;">Fahrt abgeschlossen!</h3>
                    <p style="font-size: 16px; color: #065f46; margin: 12px 0;">
                        Vielen Dank fÃ¼r Ihre Fahrt! ğŸ‰
                    </p>
                    
                    <div style="background:#f0fdf4;padding:16px;border-radius:8px;margin:16px 0;text-align:left;">
                        <div style="font-size:14px;line-height:1.8;color:#065f46;">
                            <strong>ğŸš— Fahrzeug:</strong> ${vehicleName}${vehiclePlate ? ` (${vehiclePlate})` : ''}<br>
                            <strong>ğŸ“ Von:</strong> ${ride.pickup}<br>
                            <strong>ğŸ¯ Nach:</strong> ${ride.destination}<br>
                            ${ride.distance ? `<strong>ğŸ“ Strecke:</strong> ${ride.distance} km<br>` : ''}
                            <strong>ğŸ’° Preis:</strong> ${ride.price}â‚¬
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:8px;margin-top:16px;">
                        <button onclick="closeRide()" 
                                style="flex:1;padding:14px;border:none;background:#10b981;color:white;border-radius:6px;cursor:pointer;font-weight:700;font-size:15px;">
                            ğŸš• Neue Fahrt buchen
                        </button>
                    </div>
                    
                    <div style="margin-top:12px;font-size:12px;color:#065f46;">
                        (Automatisch in 10 Sekunden...)
                    </div>
                </div>
            `;
            
            // Speichere in Historie
            saveToHistory(ride);
            
            // Auto-Reset nach 10 Sekunden
            setTimeout(() => {
                console.log('â±ï¸ v5.90.329: Auto-Reset nach 10 Sekunden');
                closeRide();
            }, 10000);
        }
        
        // ğŸ†• v5.90.329: closeRide updated
        function closeRide() {
            stopRideStatusListener();
            
            const container = document.getElementById('ride-status-container');
            if (container) {
                container.style.display = 'none';
                container.innerHTML = '';
            }
            
            // Zeige Buchungs-Formular wieder
            const bookingForm = document.getElementById('booking-form');
            if (bookingForm) {
                bookingForm.style.display = 'block';
            }
            
            // Reset Formular
            resetBookingForm();
            
            console.log('âœ… v5.90.329: Ride geschlossen, Formular zurÃ¼ckgesetzt');
        }
        
        function closeFutureRide(rideId) {
            console.log('ğŸ“… SchlieÃŸe Vorbestellung:', rideId);
            closeRide();
        }
        
        // Alte updateRideTracking Funktion fÃ¼r KompatibilitÃ¤t
        async function updateRideTracking(ride) {
            // Weiterleitungan neue showPhaseDriverComing
            await showPhaseDriverComing(ride, document.getElementById('ride-status-container'));
        }
        
        function showRideStatus(ride) {
            const container = document.getElementById('ride-status-container');
            
            // ğŸ› DEBUG v5.39.3: Zeige was wir haben!
            console.log('ğŸ” showRideStatus aufgerufen mit:', {
                status: ride.status,
                pickupTimestamp: ride.pickupTimestamp,
                pickupTimestamp_type: typeof ride.pickupTimestamp,
                pickupTime: ride.pickupTime,
                firebaseId: ride.firebaseId
            });
            
            // ğŸ“… CHECK: Ist die Fahrt in der Zukunft?
            const now = Date.now();
            // Fahrer-Zuweisung beginnt 30 Min vor Abholung
            const isFutureRide = ride.pickupTimestamp && ride.pickupTimestamp > now + (30 * 60000); // 30 Min Vorlauf
            
            // ğŸ†• VORBESTELLT: Zeige Status fÃ¼r Vorbestellungen
            if (ride.status === 'vorbestellt') {
                const pickupDate = new Date(ride.pickupTimestamp);
                
                // ğŸ› DEBUG v5.39.3: PrÃ¼fe Date-Objekt
                console.log('ğŸ” pickupDate erstellt:', {
                    pickupDate: pickupDate,
                    toString: pickupDate.toString(),
                    isValidDate: pickupDate.toString() !== 'Invalid Date',
                    getTime: pickupDate.getTime()
                });
                
                const formattedDate = pickupDate.toLocaleDateString('de-DE', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                const formattedTime = pickupDate.toLocaleTimeString('de-DE', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                console.log('ğŸ” Formatiert:', {formattedDate, formattedTime});
                
                // ğŸ”§ v5.39.3: FALLBACK wenn pickupTimestamp invalid ist!
                let displayDate = formattedDate;
                let displayTime = formattedTime;
                
                if (pickupDate.toString() === 'Invalid Date') {
                    console.warn('âš ï¸ pickupTimestamp ist Invalid! Nutze pickupTime String als Fallback.');
                    // Fallback: Nutze den pickupTime String direkt
                    displayDate = ride.pickupTime || 'Datum unbekannt';
                    displayTime = '';
                } else {
                    displayDate = formattedDate;
                    displayTime = formattedTime;
                }
                
                // ğŸ”— Tracking-Link erstellen
                const trackingLink = `${window.location.origin}${window.location.pathname}?ride=${ride.firebaseId}`;
                
                // ğŸ†• v5.49.2: ZENTRIERTES MODAL!
                container.style.display = 'flex';
                container.style.alignItems = 'center';
                container.style.justifyContent = 'center';
                
                container.innerHTML = `
                    <div class="ride-status-box" style="background:#e0f2fe;border:2px solid #0ea5e9;max-width:500px;width:100%;margin:auto;">
                        <div style="font-size: 40px; margin-bottom: 8px;">ğŸ“…</div>
                        <h3 style="font-size: 18px; margin-bottom: 10px;">Vorbestellung bestÃ¤tigt!</h3>
                        <div style="margin-top: 12px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                            <div style="font-size: 16px; font-weight: 600; color: #0c4a6e; margin-bottom: 8px;">
                                ğŸ• ${displayDate}${displayTime ? `<br>um ${displayTime} Uhr` : ''}
                            </div>
                        </div>
                        <div style="margin-top: 12px; font-size: 13px; color: #0c4a6e;">
                            <strong>ğŸ“ Von:</strong> ${ride.pickup}<br>
                            <strong>ğŸ¯ Nach:</strong> ${ride.destination}<br>
                            <strong>ğŸ’° Preis:</strong> ${ride.price}â‚¬
                        </div>
                        
                        <div style="margin-top: 12px; padding: 10px; background: #dcfce7; border-radius: 6px; font-size: 12px; color: #14822d;">
                            âœ… 15 Minuten vor der Abholung wird ein Fahrer zugewiesen.
                        </div>
                        <div style="display:flex;gap:6px;margin-top:12px;">
                            <button onclick="closeFutureRide('${ride.firebaseId}')" style="flex:1;padding:10px;border:none;background:#10b981;color:white;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;">âœ“ OK</button>
                            <button onclick="shareTrackingLink('${trackingLink}')" style="flex:1;padding:10px;border:none;background:#3b82f6;color:white;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;">ğŸ”— Teilen</button>
                            <button onclick="cancelRideConfirm('${ride.firebaseId}')" style="flex:1;padding:10px;border:none;background:#ef4444;color:white;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;">ğŸ’¾</button>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Wenn Fahrt in der Zukunft und Status 'new', zeige Vormerkung
            if (ride.status === 'new' && isFutureRide) {
                const pickupDate = new Date(ride.pickupTimestamp);
                const formattedDate = pickupDate.toLocaleDateString('de-DE', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                const formattedTime = pickupDate.toLocaleTimeString('de-DE', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                // ğŸ”§ v5.39.3: FALLBACK wenn pickupTimestamp invalid ist!
                let displayDate2 = formattedDate;
                let displayTime2 = formattedTime;
                
                if (pickupDate.toString() === 'Invalid Date') {
                    console.warn('âš ï¸ pickupTimestamp ist Invalid (new)! Nutze pickupTime String als Fallback.');
                    displayDate2 = ride.pickupTime || 'Datum unbekannt';
                    displayTime2 = '';
                } else {
                    displayDate2 = formattedDate;
                    displayTime2 = formattedTime;
                }
                
                // ğŸ†• v5.49.2: ZENTRIERTES MODAL!
                container.style.display = 'flex';
                container.style.alignItems = 'center';
                container.style.justifyContent = 'center';
                
                container.innerHTML = `
                    <div class="ride-status-box" style="background:#e0f2fe;border:2px solid #0ea5e9;max-width:500px;width:100%;margin:auto;">
                        <div style="font-size: 40px; margin-bottom: 8px;">ğŸ“…</div>
                        <h3 style="font-size: 18px; margin-bottom: 10px;">Fahrt vorgemerkt!</h3>
                        <div style="margin-top: 12px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                            <div style="font-size: 16px; font-weight: 600; color: #0c4a6e; margin-bottom: 8px;">
                                ğŸ• ${displayDate2}${displayTime2 ? `<br>um ${displayTime2} Uhr` : ''}
                            </div>
                        </div>
                        <div style="margin-top: 12px; font-size: 13px; color: #0c4a6e;">
                            <strong>ğŸ“ Von:</strong> ${ride.pickup}<br>
                            <strong>ğŸ¯ Nach:</strong> ${ride.destination}<br>
                            <strong>ğŸ’° Preis:</strong> ${ride.price}â‚¬
                        </div>
                        <div style="margin-top: 12px; padding: 10px; background: #dcfce7; border-radius: 6px; font-size: 12px; color: #14822d;">
                            âœ… Du erhÃ¤ltst 30 Minuten vor der Abholung eine Benachrichtigung, wenn der Fahrer zugewiesen wurde.
                        </div>
                        <div style="display:flex;gap:6px;margin-top:12px;">
                            <button onclick="closeFutureRide('${ride.firebaseId}')" style="flex:1;padding:10px;border:none;background:#10b981;color:white;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;">âœ“ OK</button>
                            <button onclick="cancelRideConfirm('${ride.firebaseId}')" style="flex:1;padding:10px;border:none;background:#ef4444;color:white;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;">ğŸ’¾ Stornieren</button>
                        </div>
                    </div>
                `;
                return;
            }
            
            if (ride.status === 'completed') {
                // ğŸ†• v5.49.2: ZENTRIERTES MODAL!
                container.style.display = 'flex';
                container.style.alignItems = 'center';
                container.style.justifyContent = 'center';
                
                container.innerHTML = `
                    <div class="ride-status-box" style="background:#d1fae5;border:2px solid:#10b981;max-width:500px;width:100%;margin:auto;">
                        <div style="font-size: 40px; margin-bottom: 8px;">âœ…</div>
                        <h3 style="font-size: 18px; margin-bottom: 8px;">Fahrt abgeschlossen!</h3>
                        <p style="margin-top: 8px; font-size: 14px;">Vielen Dank fÃ¼r Ihre Fahrt</p>
                        <div style="margin-top: 12px; font-size: 13px; color: #065f46;">
                            <strong>Fahrzeug:</strong> ${ride.vehicle || 'Taxi'}${ride.vehiclePlate ? ` (ğŸš— ${ride.vehiclePlate})` : ''}<br>
                            <strong>Von:</strong> ${ride.pickup}<br>
                            <strong>Nach:</strong> ${ride.destination}<br>
                            <strong>Preis:</strong> ${ride.price}â‚¬
                        </div>
                        <button onclick="closeRide()" class="btn btn-primary" style="margin-top:15px;">âœ“ Neue Fahrt buchen</button>
                        <div style="margin-top:8px;font-size:11px;color:#666;">
                            (oder warte 5 Sekunden...)
                        </div>
                    </div>
                `;
                saveToHistory(ride);
                
                // ğŸ†• AUTO-CLOSE nach 5 Sekunden
                setTimeout(() => {
                    console.log('â±ï¸ Auto-Close nach 5 Sekunden');
                    closeRide();
                }, 5000);
                
                return;
            }
            
            if (ride.status === 'picked_up') {
                container.innerHTML = `
                    <div class="ride-status-box" style="background:#dcfce7;border:2px solid #10b981;">
                        <div style="font-size: 40px; margin-bottom: 8px;">ğŸš—</div>
                        <h3 style="font-size: 18px; margin-bottom: 8px;">Gute Fahrt!</h3>
                        <p style="margin-top: 8px; font-size: 14px; color: #048257;">
                            ${ride.vehicle || 'Ihr Taxi'}${ride.vehiclePlate ? ` (ğŸš— ${ride.vehiclePlate})` : ''} fÃ¤hrt Sie zu Ihrem Ziel
                        </p>
                        <div style="margin-top: 12px; font-size: 13px; color: #065f46;">
                            <strong>Von:</strong> ${ride.pickup}<br>
                            <strong>Nach:</strong> ${ride.destination}<br>
                            <strong>Distanz:</strong> ${ride.distance} km<br>
                            <strong>Preis:</strong> ${ride.price}â‚¬
                        </div>
                    </div>
                `;
                
                if (!window.lastPickedUpRide || window.lastPickedUpRide !== ride.id) {
                    playArrivalSound();
                    window.lastPickedUpRide = ride.id;
                }
                return;
            }
            
            if (ride.status === 'new' || ride.status === 'assigned') {
                // ğŸ”§ FIX: assigned Status genauso behandeln wie new - Fahrt wurde noch nicht akzeptiert!
                const statusText = ride.status === 'assigned' ? 'Wird vermittelt...' : 'Warte auf Fahrer...';
                const statusIcon = ride.status === 'assigned' ? 'ğŸ”„' : 'â³';
                
                // Formatiere Bestellzeit
                const createdTime = new Date(ride.createdAt || Date.now());
                const createdTimeStr = createdTime.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                
                // Formatiere Abholzeit
                let pickupTimeStr;
                const now = new Date();
                if (ride.pickupTimestamp) {
                    const pickupDate = new Date(ride.pickupTimestamp);
                    const isToday = pickupDate.toDateString() === now.toDateString();
                    
                    if (isToday) {
                        const time = pickupDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                        pickupTimeStr = `Heute ${time}`;
                    } else {
                        const date = pickupDate.toLocaleDateString('de-DE', { 
                            day: '2-digit', 
                            month: '2-digit',
                            year: '2-digit'
                        });
                        const time = pickupDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                        pickupTimeStr = `${date} ${time}`;
                    }
                } else {
                    pickupTimeStr = 'SOFORT';
                }
                
                // ğŸ”— Tracking-Link erstellen
                const trackingLink = `${window.location.origin}${window.location.pathname}?ride=${ride.firebaseId}`;
                
                container.innerHTML = `
                    <div class="ride-status-box" style="background:#fef3c7;border:2px solid #f59e0b;">
                        <div style="font-size: 40px; margin-bottom: 8px;">âœ…</div>
                        <h3 style="font-size: 18px; margin: 0 0 12px 0;">Fahrt bestellt!</h3>
                        
                        <div style="background:#fffbeb;padding:12px;border-radius:8px;margin-bottom:12px;text-align:left;">
                            <div style="font-size:13px;line-height:1.7;color:#92400e;">
                                <strong>ğŸ“ Von:</strong> ${ride.pickup}<br>
                                <strong>ğŸ¯ Nach:</strong> ${ride.destination}<br>
                                <strong>ğŸ• Bestellt:</strong> ${createdTimeStr} Uhr<br>
                                <strong>ğŸš• Abholung:</strong> ${pickupTimeStr}<br>
                                <strong>ğŸ’° Preis:</strong> ${ride.price}â‚¬
                            </div>
                        </div>
                        
                        <div style="font-size:28px;margin:12px 0;">${statusIcon}</div>
                        <p style="font-size:14px;color:#92400e;margin:8px 0;">${statusText}</p>
                        
                        <div style="display:flex;gap:6px;margin-top:12px;">
                            <button onclick="shareTrackingLink('${trackingLink}')" style="flex:1;padding:10px;border:none;background:#3b82f6;color:white;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;">ğŸ”— Teilen</button>
                            <button onclick="cancelRideConfirm('${ride.firebaseId}')" style="flex:1;padding:10px;border:none;background:#ef4444;color:white;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;">ğŸ’¾ Stornieren</button>
                        </div>
                    </div>
                `;
            } else if (ride.status === 'on_way' && ride.driverLocation) {
                // ğŸ†• v5.90.289: Fahrer ist unterwegs zum Kunden!
                updateRideTracking(ride);
            } else if ((ride.status === 'on_way' || ride.status === 'accepted') && !ride.driverLocation) {
                container.innerHTML = `
                    <div class="ride-status-box" style="background:#dbeafe;border:2px solid #3b82f6;">
                        <div style="font-size: 28px; margin-bottom: 6px;">âœ…</div>
                        <h3 style="font-size: 16px; margin: 6px 0;">${ride.vehicle || 'Fahrer'} hat angenommen!</h3>
                        <p style="margin-top: 6px; font-size: 13px;">Warte auf GPS-Position...</p>
                        <div style="margin-top: 10px; font-size: 12px;">
                            <strong>Fahrzeug:</strong> ${ride.vehicle}${ride.vehiclePlate ? ` (${ride.vehiclePlate})` : ''}<br>
                            <strong>Von:</strong> ${ride.pickup}<br>
                            <strong>Nach:</strong> ${ride.destination}<br>
                            <strong>Preis:</strong> ${ride.price}â‚¬
                        </div>
                        <div style="margin-top:12px;padding-top:10px;border-top:1px solid #e5e7eb;">
                            <button onclick="cancelRideConfirm('${ride.firebaseId}')" style="padding:5px 12px;border:1px solid #ef4444;background:white;color:#ef4444;border-radius:6px;cursor:pointer;font-size:11px;font-weight:500;">âš ï¸ Kostenpflichtig stornieren</button>
                        </div>
                    </div>
                `;
            }
        }

        async function updateRideTracking(ride) {
            const driverLoc = ride.driverLocation;
            
            // ğŸ›¡ï¸ PrÃ¼fe ob pickupCoords existiert
            if (!ride.pickupCoords || !ride.pickupCoords.lat || !ride.pickupCoords.lon) {
                console.warn('âš ï¸ Keine pickupCoords fÃ¼r Fahrt - zeige einfache Ansicht');
                const container = document.getElementById('ride-status-container');
                container.innerHTML = `
                    <div class="ride-status-box" style="background:#dbeafe;border:2px solid #3b82f6;">
                        <div style="font-size: 28px; margin-bottom: 6px;">ğŸš•</div>
                        <h3 style="font-size: 16px; margin: 6px 0;">${ride.vehicle || 'Fahrer'} ist unterwegs!</h3>
                        <p style="margin-top: 6px; font-size: 13px; color: #1e40af;">Der Fahrer kommt zu Ihnen.</p>
                        <div style="margin-top: 10px; font-size: 12px;">
                            <strong>Fahrzeug:</strong> ${ride.vehicle}${ride.vehiclePlate ? ` (${ride.vehiclePlate})` : ''}<br>
                            <strong>Von:</strong> ${ride.pickup}<br>
                            <strong>Nach:</strong> ${ride.destination}<br>
                            <strong>Preis:</strong> ${ride.price}â‚¬
                        </div>
                        <div style="margin-top:12px;padding-top:10px;border-top:1px solid #e5e7eb;">
                            <button onclick="cancelRideConfirm('${ride.firebaseId}')" style="padding:5px 12px;border:1px solid #ef4444;background:white;color:#ef4444;border-radius:6px;cursor:pointer;font-size:11px;font-weight:500;">âš ï¸ Kostenpflichtig stornieren</button>
                        </div>
                    </div>
                `;
                return;
            }
            
            const route = await calculateRoute(driverLoc, ride.pickupCoords);
            const distanceKm = route.distance;
            const durationMin = route.duration;
            
            const eta = new Date(Date.now() + durationMin * 60000);
            const etaTime = eta.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            
            let statusIcon = 'ğŸš•', statusText = ride.vehicle + ' ist unterwegs', statusClass = 'status-coming';
            let etaClass = 'green', progressColor = '#10b981', progress = 80;
            
            if (durationMin <= 2) {
                statusIcon = 'ğŸ¯';
                statusText = ride.vehicle + ' ist gleich da!';
                etaClass = 'green';
                progress = 95;
                if (lastSoundDistance > 2) {
                    playArrivalSound();
                    lastSoundDistance = durationMin;
                }
            } else if (durationMin <= 5) {
                etaClass = 'yellow';
                progressColor = '#f59e0b';
                progress = 60;
            } else {
                etaClass = 'red';
                progressColor = '#ef4444';
                progress = 30;
            }
            
            const container = document.getElementById('ride-status-container');
            
            // ğŸ†• PRÃœFE: Existiert die Karte schon? Dann nur Update!
            const existingMap = document.getElementById('passenger-tracking-map');
            if (existingMap && map) {
                // âœ… Karte existiert - nur Marker und Info aktualisieren
                console.log('ğŸ”„ Karte Update (Marker bewegen)');
                
                // Update Info-Box Elemente
                const statusBox = container.querySelector('.ride-status-box');
                if (statusBox) {
                    // Status Icon
                    const iconEl = statusBox.querySelector('div');
                    if (iconEl) iconEl.textContent = statusIcon;
                    
                    // Status Text
                    const h3El = statusBox.querySelector('h3');
                    if (h3El) h3El.textContent = statusText;
                    
                    // ETA Display
                    const etaEl = statusBox.querySelector('.eta-display');
                    if (etaEl) {
                        etaEl.innerHTML = `${distanceKm} km â€¢ ${durationMin} Min`;
                        etaEl.className = `eta-display ${etaClass}`;
                    }
                    
                    // Progress Bar
                    const progressEl = statusBox.querySelector('.progress-fill');
                    if (progressEl) {
                        progressEl.style.width = `${progress}%`;
                        progressEl.style.background = progressColor;
                    }
                }
                
                // Update Taxi-Marker Position
                if (taxiMarker) {
                    taxiMarker.setLatLng([driverLoc.lat, driverLoc.lon]);
                }
                
                // Update Route-Linie
                if (route.geometry && route.geometry.length > 0) {
                    const routeCoords = route.geometry.map(coord => [coord[1], coord[0]]);
                    if (window.passengerRouteLine) {
                        map.removeLayer(window.passengerRouteLine);
                    }
                    window.passengerRouteLine = L.polyline(routeCoords, {
                        color: '#3b82f6',
                        weight: 5,
                        opacity: 0.8
                    }).addTo(map);
                }
                
                return; // Fertig - keine neue Karte nÃ¶tig!
            }
            
            // ğŸ†• Karte existiert noch nicht - neu erstellen
            console.log('ğŸ—ºï¸ Erstelle neue Tracking-Karte');
            
            container.innerHTML = `
                <div class="ride-status-box ${statusClass}">
                    <div style="font-size: 28px; margin-bottom: 6px;">${statusIcon}</div>
                    <h3 style="font-size: 16px; margin: 6px 0;">${statusText}</h3>
                    <div class="eta-display ${etaClass}" style="font-size: 15px;">${distanceKm} km â€¢ ${durationMin} Min</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-bottom: 10px;">
                        Ankunft ca. ${etaTime} Uhr
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%; background: ${progressColor};"></div>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px;">
                        <strong>Fahrzeug:</strong> ${ride.vehicle}${ride.vehiclePlate ? ` (ğŸš— ${ride.vehiclePlate})` : ''}<br>
                        <strong>Von:</strong> ${ride.pickup}<br>
                        <strong>Nach:</strong> ${ride.destination}<br>
                        <strong>Preis:</strong> ${ride.price}â‚¬
                    </div>
                </div>
                <div id="passenger-tracking-map" style="width:100%;height:300px;margin-top:15px;border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,0.1);background:#e5e7eb;"></div>
                <div style="margin-top:12px;text-align:center;">
                    <button onclick="cancelRideConfirm('${ride.firebaseId}')" style="padding:5px 12px;border:1px solid #ef4444;background:white;color:#ef4444;border-radius:6px;cursor:pointer;font-size:11px;font-weight:500;">âš ï¸ Kostenpflichtig stornieren</button>
                </div>
            `;
            
            // ğŸ—ºï¸ Karte initialisieren mit try-catch
            try {
                const mapEl = document.getElementById('passenger-tracking-map');
                if (!mapEl) {
                    console.error('ğŸ’¾ Map Element nicht gefunden!');
                    return;
                }
                
                // Alte Karte entfernen falls vorhanden
                if (map) {
                    map.remove();
                    map = null;
                }
                
                setTimeout(() => {
                    try {
                        map = L.map('passenger-tracking-map').setView([driverLoc.lat, driverLoc.lon], 14);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: 'Â© OpenStreetMap'
                        }).addTo(map);
                        
                        // Taxi Marker
                        taxiMarker = L.marker([driverLoc.lat, driverLoc.lon]).addTo(map)
                            .bindPopup('ğŸš• ' + ride.vehicle).openPopup();
                        
                        // Abholort Marker
                        pickupMarker = L.marker([ride.pickupCoords.lat, ride.pickupCoords.lon]).addTo(map)
                            .bindPopup('ğŸ“ ' + ride.pickup);
                        
                        // Route-Linie zeichnen
                        if (route.geometry && route.geometry.length > 0) {
                            const routeCoords = route.geometry.map(coord => [coord[1], coord[0]]);
                            window.passengerRouteLine = L.polyline(routeCoords, {
                                color: '#3b82f6',
                                weight: 5,
                                opacity: 0.8
                            }).addTo(map);
                        }
                        
                        // Zoom auf beide Punkte
                        const bounds = L.latLngBounds(
                            [driverLoc.lat, driverLoc.lon],
                            [ride.pickupCoords.lat, ride.pickupCoords.lon]
                        );
                        map.fitBounds(bounds, { padding: [50, 50] });
                        
                        console.log('âœ… Tracking-Karte initialisiert');
                    } catch (mapError) {
                        console.error('ğŸ’¾ Karten-Fehler:', mapError);
                    }
                }, 200);
            } catch (error) {
                console.error('ğŸ’¾ Map Setup Fehler:', error);
            }
        }

        // ==========================================
        // DRIVER MAP FUNCTIONS
        // ==========================================
        // ğŸ†• v5.90.295: UBER-STYLE DRIVER MAP!
        let driverMapV295 = null;
        let driverMarkerV295 = null;
        let customerMarkerV295 = null;
        let routeLineV295 = null;
        
        function initDriverMapV295() {
            if (driverMapV295) return; // Schon initialisiert
            
            console.log('ğŸ—ºï¸ Initialisiere Uber-Style Driver Map...');
            
            driverMapV295 = L.map('driver-map', {
                zoomControl: false,
                attributionControl: false
            }).setView([53.9547, 14.1783], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(driverMapV295);
            
            // FÃ¼ge Zoom Controls rechts oben hinzu
            L.control.zoom({ position: 'topright' }).addTo(driverMapV295);
            
            console.log('âœ… Uber-Style Map initialisiert!');
        }
        
        async function updateDriverMapV295() {
            if (!driverMapV295) {
                initDriverMapV295();
            }
            
            // Hole aktuelle GPS Position
            if (!currentVehicle || !VEHICLES[currentVehicle]) return;
            
            const vehicle = VEHICLES[currentVehicle];
            if (!vehicle.lat || !vehicle.lon) return;
            
            // ğŸ†• v5.90.298: Hole aktive Fahrt!
            const myRides = rides.filter(r => r.vehicleId === currentVehicle);
            const activeRide = myRides.find(r => 
                r.status === 'on_way' || r.status === 'picked_up' || r.status === 'accepted'
            );
            
            // Update oder Erstelle Fahrer-Marker
            if (driverMarkerV295) {
                driverMarkerV295.setLatLng([vehicle.lat, vehicle.lon]);
            } else {
                const icon = L.divIcon({
                    html: '<div style="background: #10b981; width: 24px; height: 24px; border-radius: 50%; border: 4px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                    className: '',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });
                
                driverMarkerV295 = L.marker([vehicle.lat, vehicle.lon], { icon }).addTo(driverMapV295);
            }
            
            // ğŸ†• v5.90.298: Zeige Kunde + Route wenn aktive Fahrt!
            if (activeRide && activeRide.pickupCoords && activeRide.destCoords) {
                // Entscheide: Zum Abholort oder zum Ziel?
                let targetCoords, targetLabel, markerColor, routeColor;
                if (activeRide.status === 'picked_up') {
                    // Kunde drin â†’ Zum Ziel!
                    targetCoords = activeRide.destCoords;
                    targetLabel = 'ğŸ¯ ZIEL';
                    markerColor = '#10b981';
                    routeColor = '#10b981';  // ğŸ†• v5.90.525: GRÃœN!
                } else {
                    // Fahrt angenommen â†’ Zum Kunden!
                    targetCoords = activeRide.pickupCoords;
                    targetLabel = 'ğŸ“ KUNDE';
                    markerColor = '#ef4444';
                    routeColor = '#ef4444';  // ğŸ†• v5.90.525: ROT!
                }
                
                // Kunde-Marker
                if (customerMarkerV295) {
                    customerMarkerV295.setLatLng([targetCoords.lat, targetCoords.lon]);
                } else {
                    const customerIcon = L.divIcon({
                        html: `<div style="background: ${markerColor}; color: white; padding: 8px 12px; border-radius: 20px; font-weight: 900; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); white-space: nowrap;">${targetLabel}</div>`,
                        className: '',
                        iconSize: [100, 40],
                        iconAnchor: [50, 40]
                    });
                    customerMarkerV295 = L.marker([targetCoords.lat, targetCoords.lon], { icon: customerIcon }).addTo(driverMapV295);
                }
                
                // Route berechnen
                try {
                    const response = await fetch(
                        `https://router.project-osrm.org/route/v1/driving/${vehicle.lon},${vehicle.lat};${targetCoords.lon},${targetCoords.lat}?overview=full&geometries=geojson`
                    );
                    const data = await response.json();
                    
                    if (data.routes && data.routes.length > 0) {
                        const coords = data.routes[0].geometry.coordinates;
                        const latLngs = coords.map(c => [c[1], c[0]]);
                        
                        // Entferne alte Route
                        if (routeLineV295) {
                            driverMapV295.removeLayer(routeLineV295);
                        }
                        
                        // ğŸ†• v5.90.525: Route mit dynamischer Farbe!
                        routeLineV295 = L.polyline(latLngs, {
                            color: routeColor,  // ğŸ”´ ROT oder ğŸŸ¢ GRÃœN!
                            weight: 5,
                            opacity: 0.7
                        }).addTo(driverMapV295);
                        
                        // Zentriere Karte auf beide Punkte
                        const bounds = L.latLngBounds([
                            [vehicle.lat, vehicle.lon],
                            [targetCoords.lat, targetCoords.lon]
                        ]);
                        driverMapV295.fitBounds(bounds, { padding: [50, 50] });
                        
                        console.log('âœ… Route auf Karte gezeichnet!');
                    }
                } catch (error) {
                    console.error('ğŸ’¾ Route-Fehler:', error);
                }
                
            } else {
                // Keine aktive Fahrt â†’ Entferne Kunde-Marker + Route
                if (customerMarkerV295) {
                    driverMapV295.removeLayer(customerMarkerV295);
                    customerMarkerV295 = null;
                }
                if (routeLineV295) {
                    driverMapV295.removeLayer(routeLineV295);
                    routeLineV295 = null;
                }
                
                // Zentriere nur auf Fahrer
                driverMapV295.setView([vehicle.lat, vehicle.lon], 15);
            }
        }
        
        let driverMap = null;
        let driverMarker = null;
        let customerMarker = null;
        let routeLine = null;
        let driverMapUpdateInterval = null;

        async function initDriverMap(rideOrId) {
            // Kann entweder ride Objekt ODER rideId sein
            const rideId = (typeof rideOrId === 'string') ? rideOrId : (rideOrId.firebaseId || rideOrId.id);
            
            console.log('â„¹ï¸ Lade Fahrt-Info aus Firebase:', rideId);
            
            // LADE DIREKT AUS FIREBASE!
            const snapshot = await db.ref('rides/' + rideId).once('value');
            const ride = snapshot.val();
            
            if (!ride) {
                console.error('ğŸ’¾ Fahrt nicht in Firebase gefunden!');
                alert('ğŸ’¾ Fehler: Fahrt nicht gefunden!');
                return;
            }
            
            // FÃ¼ge firebaseId hinzu
            ride.firebaseId = rideId;
            
            console.log('âœ… Fahrt aus Firebase geladen:', ride);
            
            // ğŸ“‹ Update Info Box oben
            updateDriverInfoTop(ride);
            
            // Verstecke Ready-State, Zeige Info-Container
            // ğŸ†• v5.90.318: NULL-CHECK!
            const driverReady2 = document.getElementById('driver-ready');
            const routeInfo2 = document.getElementById('driver-route-info');
            
            if (driverReady2) driverReady2.style.display = 'none';
            if (routeInfo2) routeInfo2.style.display = 'block';
            
            // ğŸ’¾ KEINE KARTE! Nur Info-Anzeige
        }

        async function updateDriverRoute(ride) {
            const driver = drivers[currentVehicle];
            if (!driver || !driver.lat || !driver.lon || !driverMap) return;
            
            // FLEXIBEL: Navigation zum Abholort ODER zum Ziel!
            let targetCoords, targetLabel, routeTitle;
            if (ride.status === 'picked_up') {
                // Kunde ist drin â†’ Navigation zum ZIEL
                targetCoords = ride.destCoords;
                targetLabel = 'ğŸ¯ Ziel';
                routeTitle = 'ğŸ¯ Navigation zum Ziel';
            } else {
                // Fahrt angenommen â†’ Navigation zum ABHOLORT
                targetCoords = ride.pickupCoords;
                targetLabel = 'ğŸ“ Fahrgast';
                routeTitle = 'ğŸ“ Navigation zum Fahrgast';
            }
            
            // Update Titel
            document.getElementById('route-title').textContent = routeTitle;
            
            // Update Fahrer-Position
            if (driverMarker) {
                driverMarker.setLatLng([driver.lat, driver.lon]);
            }
            
            // Update Ziel-Marker
            if (customerMarker && ride.status === 'picked_up') {
                // Ã„ndere Marker zum Ziel
                customerMarker.setLatLng([targetCoords.lat, targetCoords.lon]);
                const destIcon = L.divIcon({
                    html: '<div style="background:#10b981;color:white;padding:8px 12px;border-radius:20px;font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,0.3);">ğŸ¯ Ziel</div>',
                    className: '',
                    iconSize: [100, 40]
                });
                customerMarker.setIcon(destIcon);
            }
            
            // Berechne Route
            const route = await calculateRoute(
                { lat: driver.lat, lon: driver.lon },
                { lat: targetCoords.lat, lon: targetCoords.lon }
            );
            
            // Update Info-Box
            document.getElementById('route-distance').textContent = route.distance;
            document.getElementById('route-duration').textContent = route.duration;
            
            const eta = new Date(Date.now() + route.duration * 60000);
            document.getElementById('route-eta').textContent = eta.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            
            // Hole detaillierte Route MIT TURN-BY-TURN ANWEISUNGEN!
            try {
                const response = await fetch(
                    `https://router.project-osrm.org/route/v1/driving/${driver.lon},${driver.lat};${targetCoords.lon},${targetCoords.lat}?overview=full&geometries=geojson&steps=true`
                );
                const data = await response.json();
                
                if (data.routes && data.routes.length > 0) {
                    const routeData = data.routes[0];
                    const coords = routeData.geometry.coordinates;
                    const latLngs = coords.map(c => [c[1], c[0]]);  // [lon,lat] â†’ [lat,lon]
                    
                    // Entferne alte Linie
                    if (routeLine) {
                        driverMap.removeLayer(routeLine);
                    }
                    
                    // Zeichne neue Route
                    routeLine = L.polyline(latLngs, {
                        color: '#667eea',
                        weight: 5,
                        opacity: 0.8
                    }).addTo(driverMap);
                    
                    // ğŸ¯ TURN-BY-TURN ANWEISUNGEN!
                    if (routeData.legs && routeData.legs[0].steps) {
                        const steps = routeData.legs[0].steps;
                        const currentStep = steps[0]; // NÃ¤chste Anweisung
                        
                        if (currentStep) {
                            updateTurnByTurnDisplay(currentStep);
                        }
                    }
                    
                    console.log('âœ… Route gezeichnet:', route.distance, 'km,', route.duration, 'min');
                }
            } catch (e) {
                console.error('ğŸ’¾ Route-Fehler:', e);
            }
        }

        function updateTurnByTurnDisplay(step) {
            const maneuver = step.maneuver;
            const distance = step.distance;
            const name = step.name || 'StraÃŸe';
            
            // Berechne Distanz in Metern
            const distanceMeters = Math.round(distance);
            const distanceText = distanceMeters >= 1000 
                ? `${(distanceMeters / 1000).toFixed(1)} km` 
                : `${distanceMeters} m`;
            
            // Bestimme Icon und Text basierend auf ManÃ¶ver-Typ
            let icon = 'â†‘';
            let instruction = 'Geradeaus weiter';
            
            const type = maneuver.type;
            const modifier = maneuver.modifier;
            
            if (type === 'turn') {
                if (modifier === 'left') {
                    icon = 'â†';
                    instruction = 'LINKS abbiegen';
                } else if (modifier === 'right') {
                    icon = 'â†’';
                    instruction = 'RECHTS abbiegen';
                } else if (modifier === 'slight left') {
                    icon = 'â†–';
                    instruction = 'Leicht links';
                } else if (modifier === 'slight right') {
                    icon = 'â†—';
                    instruction = 'Leicht rechts';
                } else if (modifier === 'sharp left') {
                    icon = 'â¬…';
                    instruction = 'SCHARF LINKS';
                } else if (modifier === 'sharp right') {
                    icon = 'â¡';
                    instruction = 'SCHARF RECHTS';
                }
            } else if (type === 'depart') {
                icon = 'ğŸš—';
                instruction = 'Losfahren';
            } else if (type === 'arrive') {
                icon = 'ğŸ¯';
                instruction = 'ZIEL ERREICHT!';
            } else if (type === 'roundabout') {
                icon = 'â­•';
                instruction = 'Kreisverkehr';
                if (modifier === 'left') instruction += ' - 3. Ausfahrt';
                else if (modifier === 'right') instruction += ' - 1. Ausfahrt';
                else instruction += ' - 2. Ausfahrt';
            } else if (type === 'merge') {
                icon = 'â¤´';
                instruction = 'EinfÃ¤deln';
            } else if (type === 'continue') {
                icon = 'â†‘';
                instruction = 'Weiter geradeaus';
            }
            
            // Update UI
            document.getElementById('turn-icon').textContent = icon;
            document.getElementById('turn-distance').textContent = distanceText;
            document.getElementById('turn-instruction').textContent = instruction;
            document.getElementById('turn-street').textContent = `auf ${name}`;
            
            // FÃ¤rbe Box basierend auf Distanz
            const turnBox = document.getElementById('turn-by-turn');
            if (distanceMeters < 50) {
                turnBox.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'; // ROT - JETZT!
            } else if (distanceMeters < 200) {
                turnBox.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'; // ORANGE - Gleich!
            } else {
                turnBox.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'; // BLAU - Normal
            }
            
            console.log(`ğŸ§­ NÃ¤chste Anweisung: ${instruction} in ${distanceText} auf ${name}`);
        }

        function closeDriverMap() {
            console.log('ğŸ—ºï¸ SchlieÃŸe Fahrer-Karte');
            
            // Stoppe Updates
            if (driverMapUpdateInterval) {
                clearInterval(driverMapUpdateInterval);
                driverMapUpdateInterval = null;
            }
            
            // Entferne Karte
            if (driverMap) {
                driverMap.remove();
                driverMap = null;
                driverMarker = null;
                customerMarker = null;
                routeLine = null;
            }
            
            // Verstecke Container, Zeige Ready
            // ğŸ†• v5.90.318: NULL-CHECK!
            const routeInfo3 = document.getElementById('driver-route-info');
            const driverReady3 = document.getElementById('driver-ready');
            
            if (routeInfo3) routeInfo3.style.display = 'none';
            if (driverReady3) driverReady3.style.display = 'block';
        }

        function openGoogleMapsNavigation(rideId, destination) {
            const ride = rides.find(r => r.firebaseId === rideId);
            if (!ride) {
                alert('ğŸ’¾ Fahrt nicht gefunden!');
                return;
            }
            
            let targetLat, targetLon, targetName;
            
            if (destination === 'pickup') {
                // Navigation zum Kunden (Abholort)
                targetLat = ride.pickupCoords.lat;
                targetLon = ride.pickupCoords.lon;
                targetName = ride.pickup;
            } else {
                // Navigation zum Ziel
                targetLat = ride.destCoords.lat;
                targetLon = ride.destCoords.lon;
                targetName = ride.destination;
            }
            
            // Google Maps URL fÃ¼r Navigation
            // FÃ¼r Mobile: google.navigation:q=lat,lon
            // FÃ¼r Desktop/Fallback: https://www.google.com/maps/dir/?api=1&destination=lat,lon
            
            const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
            let mapsUrl;
            
            if (isMobile) {
                // Mobile: Ã–ffne Google Maps App direkt mit Navigation
                mapsUrl = `google.navigation:q=${targetLat},${targetLon}`;
                
                // Fallback fÃ¼r iOS oder wenn Google Maps nicht installiert
                setTimeout(() => {
                    window.location.href = `https://www.google.com/maps/dir/?api=1&destination=${targetLat},${targetLon}&travelmode=driving`;
                }, 500);
            } else {
                // Desktop: Ã–ffne Google Maps im Browser
                mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${targetLat},${targetLon}&travelmode=driving`;
            }
            
            console.log('ğŸ—ºï¸ Ã–ffne Google Maps Navigation zu:', targetName);
            console.log('ğŸ“ Koordinaten:', targetLat, targetLon);
            
            // Ã–ffne Maps
            window.open(mapsUrl, '_blank');
            
            // BestÃ¤tigungsmeldung
            alert(`âœ… Google Maps Navigation gestartet!\n\nZiel: ${targetName}\n\nğŸ’¡ Tipp: Die Navigation Ã¶ffnet sich in der Google Maps App.`);
        }

        // ğŸ” LOGIN SYSTEM FUNCTIONS
        
        function showLoginModal() {
            document.getElementById('register-modal').style.display = 'none';
            document.getElementById('login-modal').style.display = 'block';
            // Reset auf E-Mail Tab
            switchLoginTab('email');
        }
        
        function closeLoginModal() {
            document.getElementById('login-modal').style.display = 'none';
            resetPhoneLogin();
        }
        
        // ğŸ“± TELEFON-LOGIN SYSTEM
        let recaptchaVerifier = null;
        let confirmationResult = null;
        
        function switchLoginTab(tab) {
            const emailTab = document.getElementById('login-tab-email');
            const phoneTab = document.getElementById('login-tab-phone');
            const emailSection = document.getElementById('login-email-section');
            const phoneSection = document.getElementById('login-phone-section');
            
            if (tab === 'email') {
                emailTab.style.background = '#667eea';
                emailTab.style.color = 'white';
                phoneTab.style.background = '#f3f4f6';
                phoneTab.style.color = '#333';
                emailSection.style.display = 'block';
                phoneSection.style.display = 'none';
            } else {
                phoneTab.style.background = '#10b981';
                phoneTab.style.color = 'white';
                emailTab.style.background = '#f3f4f6';
                emailTab.style.color = '#333';
                emailSection.style.display = 'none';
                phoneSection.style.display = 'block';
                
                // reCAPTCHA initialisieren wenn noch nicht geschehen
                initRecaptcha();
            }
        }
        
        function initRecaptcha() {
            if (recaptchaVerifier) {
                console.log('âœ… reCAPTCHA bereits initialisiert');
                return;
            }
            
            if (!auth) {
                console.error('ğŸ’¾ Firebase Auth nicht verfÃ¼gbar');
                return;
            }
            
            // Container prÃ¼fen - nutze den im Login-Modal
            const containerId = document.getElementById('login-recaptcha-container') ? 'login-recaptcha-container' : 'recaptcha-container';
            const container = document.getElementById(containerId);
            
            if (!container) {
                console.error('ğŸ’¾ reCAPTCHA Container nicht gefunden:', containerId);
                return;
            }
            
            try {
                console.log('ğŸ”„ Initialisiere invisible reCAPTCHA...');
                
                // Container leeren (falls vorher was drin war)
                container.innerHTML = '';
                
                recaptchaVerifier = new firebase.auth.RecaptchaVerifier(containerId, {
                    'size': 'invisible',  // UNSICHTBAR - lÃ¤uft im Hintergrund!
                    'callback': (response) => {
                        console.log('âœ… reCAPTCHA automatisch gelÃ¶st:', response);
                    },
                    'expired-callback': () => {
                        console.log('âš ï¸ reCAPTCHA abgelaufen - neu initialisieren');
                        recaptchaVerifier = null;
                        setTimeout(() => initRecaptcha(), 500);
                    },
                    'error-callback': (error) => {
                        console.error('ğŸ’¾ reCAPTCHA Error Callback:', error);
                        recaptchaVerifier = null;
                    }
                });
                
                // Render mit Error Handling
                recaptchaVerifier.render().then(widgetId => {
                    console.log('âœ… Invisible reCAPTCHA erfolgreich gerendert! Widget ID:', widgetId);
                }).catch(error => {
                    console.error('ğŸ’¾ reCAPTCHA Render Fehler:', error);
                    recaptchaVerifier = null;
                    
                    // Retry nach 1 Sekunde
                    setTimeout(() => {
                        console.log('ğŸ”„ Versuche reCAPTCHA erneut...');
                        initRecaptcha();
                    }, 1000);
                });
                
            } catch (error) {
                console.error('ğŸ’¾ reCAPTCHA Init Fehler:', error);
                recaptchaVerifier = null;
            }
        }
        
        async function sendPhoneCode() {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ“± SENDPHONECODE GESTARTET');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            const countryCode = document.getElementById('phone-country').value;
            const phoneNumber = document.getElementById('phone-number').value.trim().replace(/\s/g, '');
            
            console.log('ğŸ’¾ Telefonnummer:', countryCode, phoneNumber);
            
            if (!phoneNumber) {
                alert('ğŸ’¾ Bitte Telefonnummer eingeben!');
                return;
            }
            
            // Formatiere Telefonnummer
            const fullPhoneNumber = countryCode + (phoneNumber.startsWith('0') ? phoneNumber.slice(1) : phoneNumber);
            console.log('ğŸ’¾ VollstÃ¤ndige Nummer:', fullPhoneNumber);
            
            if (!auth) {
                alert('ğŸ’¾ Firebase Auth nicht verfÃ¼gbar');
                return;
            }
            
            // reCAPTCHA Check und Auto-Init
            if (!recaptchaVerifier) {
                console.log('âš ï¸ reCAPTCHA noch nicht bereit - initialisiere jetzt...');
                initRecaptcha();
                
                // Warte kurz bis reCAPTCHA bereit ist
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                if (!recaptchaVerifier) {
                    alert('ğŸ’¾ reCAPTCHA konnte nicht geladen werden!\n\nBitte lade die Seite neu (F5) und versuche es erneut.');
                    return;
                }
            }
            
            const btn = document.getElementById('send-code-btn');
            btn.disabled = true;
            btn.textContent = 'â³ Sende SMS...';
            
            // âœ… ZEIGE CODE-EINGABE SOFORT! (nicht erst nach SMS-Erfolg)
            console.log('âœ… Zeige Code-Eingabefeld SOFORT...');
            const step1 = document.getElementById('phone-step-1');
            const step2 = document.getElementById('phone-step-2');
            
            if (!step1 || !step2) {
                console.error('ğŸ’¾ FEHLER: phone-step-1 oder phone-step-2 nicht gefunden!');
                console.log('step1:', step1);
                console.log('step2:', step2);
                alert('ğŸ’¾ Fehler: UI-Elemente nicht gefunden. Bitte Seite neu laden.');
                btn.disabled = false;
                btn.textContent = 'ğŸ“² SMS-Code senden';
                return;
            }
            
            step1.style.display = 'none';
            step2.style.display = 'block';
            document.getElementById('phone-display').textContent = fullPhoneNumber;
            console.log('âœ… Code-Eingabefeld ist jetzt SICHTBAR!');
            
            try {
                console.log('ğŸ“¤ Starte SMS-Versand via Firebase...');
                confirmationResult = await auth.signInWithPhoneNumber(fullPhoneNumber, recaptchaVerifier);
                console.log('âœ… SMS ERFOLGREICH GESENDET an:', fullPhoneNumber);
                console.log('âœ… confirmationResult:', confirmationResult);
                
                // Fokus auf Code-Eingabe + Auto-Fill vorbereiten
                const codeInput = document.getElementById('phone-code');
                codeInput.value = ''; // Leere Feld
                codeInput.focus();
                console.log('âœ… Fokus auf Code-Eingabefeld gesetzt');
                
                // ğŸ¯ WEB OTP API - Automatisches SMS AusfÃ¼llen!
                if ('OTPCredential' in window) {
                    console.log('âœ… Web OTP API verfÃ¼gbar - aktiviere Auto-Fill');
                    navigator.credentials.get({
                        otp: { transport: ['sms'] },
                        signal: AbortSignal.timeout(60000) // 60 Sekunden timeout
                    }).then(otp => {
                        if (otp && otp.code) {
                            console.log('ğŸ‰ SMS-Code automatisch empfangen:', otp.code);
                            codeInput.value = otp.code;
                            alert('âœ… Code automatisch empfangen: ' + otp.code + '\n\nBitte auf "Code bestÃ¤tigen" klicken.');
                        }
                    }).catch(err => {
                        console.log('âš ï¸ Web OTP Fehler:', err.message);
                    });
                } else {
                    console.log('â„¹ï¸ Web OTP API nicht unterstÃ¼tzt - manuelles Eingeben nÃ¶tig');
                }
                
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('âœ… SENDPHONECODE ERFOLGREICH ABGESCHLOSSEN');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
            } catch (error) {
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.error('ğŸ’¾ SMS FEHLER!');
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.error('Error:', error);
                console.error('Error Code:', error.code);
                console.error('Error Message:', error.message);
                
                // Verstecke Code-Eingabe wieder bei Fehler
                step1.style.display = 'block';
                step2.style.display = 'none';
                
                btn.disabled = false;
                btn.textContent = 'ğŸ“² SMS-Code senden';
                
                if (error.code === 'auth/invalid-phone-number') {
                    alert('ğŸ’¾ UngÃ¼ltige Telefonnummer!\n\nBitte im Format "170 1234827" eingeben.');
                } else if (error.code === 'auth/too-many-requests') {
                    alert('ğŸ’¾ Zu viele Versuche!\n\nBitte warte einige Minuten.');
                } else if (error.code === 'auth/captcha-check-failed') {
                    alert('ğŸ’¾ reCAPTCHA fehlgeschlagen!\n\nBitte lade die Seite neu.');
                    resetPhoneLogin();
                } else {
                    alert('ğŸ’¾ Fehler beim SMS-Versand:\n\n' + error.message + '\n\nCode: ' + error.code + '\n\nBitte versuche es erneut oder lade die Seite neu.');
                }
                
                // reCAPTCHA zurÃ¼cksetzen
                if (recaptchaVerifier) {
                    try {
                        recaptchaVerifier.clear();
                    } catch (e) {}
                    recaptchaVerifier = null;
                }
                initRecaptcha();
            }
        }
        
        async function verifyPhoneCode() {
            const code = document.getElementById('phone-code').value.trim();
            
            if (!code || code.length !== 6) {
                alert('ğŸ’¾ Bitte 6-stelligen Code eingeben!');
                return;
            }
            
            if (!confirmationResult) {
                alert('ğŸ’¾ Keine SMS gesendet. Bitte neu starten.');
                resetPhoneLogin();
                return;
            }
            
            try {
                const result = await confirmationResult.confirm(code);
                console.log('âœ… Telefon-Login erfolgreich:', result.user.phoneNumber);
                
                // PrÃ¼fe ob User neu ist und Name braucht
                if (result.additionalUserInfo && result.additionalUserInfo.isNewUser) {
                    // Neuer User - frage nach Name
                    const name = prompt('Willkommen! Wie heiÃŸt du?');
                    if (name && result.user) {
                        await result.user.updateProfile({ displayName: name });
                        
                        // In Firebase speichern
                        if (isFirebaseReady) {
                            await db.ref('users/' + result.user.uid).update({
                                phone: result.user.phoneNumber,
                                displayName: name,
                                createdAt: Date.now()
                            });
                        }
                    }
                }
                
                closeLoginModal();
                
                // ğŸ†• v5.42.2: WICHTIG! Auth-Check + MenÃ¼-Update + User-Profile nach Login!
                setTimeout(() => {
                    checkPassengerAuth();
                    loadQuickLoginData();
                    updateMenuProfile();
                    updateUserProfile(); // ğŸ†• Versteckt "Anmelden" Button!
                }, 500);
                
                alert('âœ… Erfolgreich angemeldet!\n\nğŸ“± ' + result.user.phoneNumber);
                
            } catch (error) {
                console.error('ğŸ’¾ Code-Verifizierung Fehler:', error);
                
                if (error.code === 'auth/invalid-verification-code') {
                    alert('ğŸ’¾ Falscher Code!\n\nBitte prÃ¼fe die SMS und versuche es erneut.');
                } else if (error.code === 'auth/code-expired') {
                    alert('ğŸ’¾ Code abgelaufen!\n\nBitte fordere einen neuen Code an.');
                    resetPhoneLogin();
                } else {
                    alert('ğŸ’¾ Fehler: ' + error.message);
                }
            }
        }
        
        function resetPhoneLogin() {
            // ZurÃ¼ck zu Schritt 1
            document.getElementById('phone-step-1').style.display = 'block';
            document.getElementById('phone-step-2').style.display = 'none';
            document.getElementById('phone-number').value = '';
            document.getElementById('phone-code').value = '';
            
            const btn = document.getElementById('send-code-btn');
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'ğŸ“² SMS-Code senden';
            }
            
            // reCAPTCHA zurÃ¼cksetzen
            if (recaptchaVerifier) {
                try {
                    recaptchaVerifier.clear();
                } catch (e) {}
                recaptchaVerifier = null;
            }
            confirmationResult = null;
            
            // Container leeren und neu initialisieren
            const container = document.getElementById('recaptcha-container');
            if (container) {
                container.innerHTML = '';
            }
        }
        
        function showRegisterModal() {
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('register-modal').style.display = 'block';
        }
        
        function closeRegisterModal() {
            document.getElementById('register-modal').style.display = 'none';
        }
        
        async function loginWithGoogle() {
            if (!auth) {
                // Versuche Firebase Auth nochmal zu initialisieren
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    auth = firebase.auth();
                } else {
                    alert('ğŸ’¾ Firebase Auth ist nicht verfÃ¼gbar.\n\nBitte lade die Seite neu (Strg+F5) und versuche es nochmal.');
                    return;
                }
            }
            
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
                closeLoginModal();
            } catch (error) {
                console.error('Google Login Fehler:', error);
                if (error.code === 'auth/popup-blocked') {
                    alert('ğŸ’¾ Popup wurde blockiert!\n\nBitte erlaube Popups fÃ¼r diese Seite.');
                } else {
                    alert('ğŸ’¾ Google Login fehlgeschlagen: ' + error.message);
                }
            }
        }
        
        async function loginWithEmail() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                alert('Bitte E-Mail und Passwort eingeben');
                return;
            }
            
            if (!auth) {
                alert('Firebase Auth nicht verfÃ¼gbar');
                return;
            }
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                closeLoginModal();
            } catch (error) {
                console.error('Login Fehler:', error);
                alert('Login fehlgeschlagen: ' + error.message);
            }
        }
        
        async function registerWithEmail() {
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            if (!name || !email || !password) {
                alert('Bitte alle Felder ausfÃ¼llen');
                return;
            }
            
            if (!auth) {
                alert('Firebase Auth nicht verfÃ¼gbar');
                return;
            }
            
            try {
                const result = await auth.createUserWithEmailAndPassword(email, password);
                await result.user.updateProfile({ displayName: name });
                closeRegisterModal();
                alert('Registrierung erfolgreich! Willkommen, ' + name + '!');
            } catch (error) {
                console.error('Registrierung Fehler:', error);
                alert('Registrierung fehlgeschlagen: ' + error.message);
            }
        }
        
        async function logoutUser() {
            if (!auth || !currentUser) return;
            
            // ğŸ†• v5.20.3: Gespeicherten Online-Status lÃ¶schen bei Logout!
            if (currentUser.uid) {
                localStorage.setItem('lastOnlineStatus_' + currentUser.uid, 'false');
                console.log('ğŸ’¾ Online-Status auf FALSE gesetzt (Logout)');
            }
            
            // ğŸš— WICHTIG: Fahrzeug offline setzen VOR dem Logout!
            if (currentVehicle && isFirebaseReady && isOnline) {
                try {
                    const vehicleName = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle;
                    
                    // Fahrzeug offline setzen
                    await db.ref('vehicles/' + currentVehicle).update({
                        online: false,
                        lastOffline: Date.now()
                    });
                    
                    // Log-Eintrag
                    const userContact = currentUser ? (currentUser.email || currentUser.phoneNumber || 'Unbekannt') : 'Unbekannt';
                    logActivity('driver', 'offline', 
                        `Fahrer ${userContact} (${vehicleName}) ist jetzt OFFLINE (Logout)`, {
                        vehicle: currentVehicle,
                        driver: vehicleName,
                        email: userContact
                    });
                    
                    console.log('ğŸ“´ Fahrzeug offline gesetzt vor Logout:', currentVehicle);
                    
                    // GPS stoppen
                    stopDriverTracking();
                    
                    // Stoppe auch Standby
                    if (standbyIntervalId) {
                        clearInterval(standbyIntervalId);
                        standbyIntervalId = null;
                    }
                    gpsMode = 'off';
                    
                    isOnline = false;
                    
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim Offline-Setzen:', error);
                }
            }
            
            try {
                await auth.signOut();
                console.log('âœ… Logout erfolgreich');
            } catch (error) {
                console.error('ğŸ’¾ Logout-Fehler:', error);
                alert('Logout fehlgeschlagen: ' + error.message);
            }
        }
        
        // ğŸ†• Stammkunden-Daten lÃ¶schen
        function clearRegularCustomer() {
            if (confirm('Stammkunden-Daten lÃ¶schen?\n\nDeine gespeicherten Daten (Name, Adresse, Fahrten-Anzahl) werden entfernt.')) {
                localStorage.removeItem('regularCustomer');
                updateUserProfile();
                console.log('ğŸ—‘ï¸ Stammkunden-Daten gelÃ¶scht');
            }
        }
        
        // ğŸ” ROLLEN-SYSTEM
        // userRole ist jetzt global am Anfang deklariert!
        
        async function getUserRole(user) {
            // Admin per Email
            if (user.email === 'funktaxi.pw@gmail.com') {
                return 'admin';
            }
            
            // PrÃ¼fe Firebase fÃ¼r zugewiesene Rollen
            if (isFirebaseReady) {
                try {
                    // Erst normale User-Tabelle prÃ¼fen
                    const snapshot = await db.ref('users/' + user.uid).once('value');
                    const userData = snapshot.val();
                    if (userData && userData.role) {
                        return userData.role;
                    }
                    
                    // Dann vorregistrierte Mitarbeiter prÃ¼fen
                    const emailKey = user.email.replace(/\./g, '_').replace(/@/g, '_at_');
                    const preRegSnapshot = await db.ref('preRegisteredUsers/' + emailKey).once('value');
                    const preRegData = preRegSnapshot.val();
                    if (preRegData && preRegData.role) {
                        // Ãœbertrage Daten zum echten User
                        await db.ref('users/' + user.uid).update({
                            role: preRegData.role,
                            vehicle: preRegData.vehicle || '',
                            phone: preRegData.phone || '',
                            preRegisteredAt: preRegData.createdAt
                        });
                        console.log('âœ… Vorregistrierten Mitarbeiter aktiviert:', user.email, 'â†’', preRegData.role);
                        return preRegData.role;
                    }
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim Laden der Rolle:', error);
                }
            }
            
            return 'fahrgast'; // Standard
        }
        
        function applyRoleRestrictions(role) {
            console.log('ğŸ” Rolle anwenden:', role);
            userRole = role;
            
            const fahrgastBtn = document.getElementById('passenger-tab-btn');
            const verlaufBtn = document.getElementById('history-tab-btn');
            const fahrerBtn = document.getElementById('driver-tab-btn');
            const adminBtn = document.getElementById('admin-tab-btn');
            
            // Alle verstecken erstmal
            if (fahrgastBtn) fahrgastBtn.style.display = 'none';
            if (verlaufBtn) verlaufBtn.style.display = 'none';
            if (fahrerBtn) fahrerBtn.style.display = 'none';
            if (adminBtn) adminBtn.style.display = 'none';
            
            // Je nach Rolle anzeigen
            if (role === 'fahrgast') {
                // ğŸ”§ v5.90.101: ENTFERNE is-admin Klasse
                document.body.classList.remove('is-admin');
                
                // Fahrgast sieht: Fahrgast + Verlauf
                if (fahrgastBtn) fahrgastBtn.style.display = 'block';
                if (verlaufBtn) verlaufBtn.style.display = 'block'; // âœ… IMMER anzeigen!
                
                // ğŸ†• v5.56.0: KEIN CRM fÃ¼r Fahrgast!
                const crmSection = document.getElementById('crm-section');
                if (crmSection) crmSection.style.display = 'none';
                
                switchView('passenger');
            } else if (role === 'fahrer') {
                // ğŸ”§ v5.90.101: ENTFERNE is-admin Klasse
                document.body.classList.remove('is-admin');
                
                // ğŸ†• v5.90.525: Fahrer sieht NUR Fahrer-Tab!
                if (fahrerBtn) fahrerBtn.style.display = 'block';
                console.log('âœ… v5.90.525: Fahrer-Tab aktiviert - KEINE anderen Tabs!');
                
                // ğŸ†• v5.56.0: KEIN CRM fÃ¼r Fahrer!
                const crmSection = document.getElementById('crm-section');
                if (crmSection) crmSection.style.display = 'none';
                
                // ğŸ†• v5.90.525: Direkt zum Fahrer-Tab!
                switchView('driver');
                console.log('ğŸš— v5.90.525: Fahrer-View geladen - App optimiert!');
            } else if (role === 'admin') {
                // ğŸ”§ v5.90.101: SETZE is-admin Klasse - zeigt .admin-only Elemente!
                document.body.classList.add('is-admin');
                console.log('âœ… v5.90.101: is-admin Klasse gesetzt - Admin-Tabs jetzt sichtbar!');
                
                // Admin sieht: ALLES
                if (fahrgastBtn) fahrgastBtn.style.display = 'block';
                if (verlaufBtn) verlaufBtn.style.display = 'block';
                if (fahrerBtn) fahrerBtn.style.display = 'block';
                if (adminBtn) adminBtn.style.display = 'block';
                
                // ğŸ†• v5.56.0: CRM NUR FÃœR ADMIN!
                const crmSection = document.getElementById('crm-section');
                if (crmSection) crmSection.style.display = 'block';
                
                // ğŸ†• Starte Checker fÃ¼r offene Fahrten (nur fÃ¼r Admin)
                startOpenRideChecker();
                
                // ğŸ†• Starte Vorbestellungs-Aktivierer (aktiviert 15 Min vor Abholung)
                startPrebookingActivator();
                
                // ğŸ†• v5.83.0: Lade FritzBox Settings (v5.87.70: mit Fehlerbehandlung)
                if (typeof loadFritzBoxSettings === 'function') {
                    loadFritzBoxSettings();
                } else {
                    console.warn('âš ï¸ loadFritzBoxSettings noch nicht verfÃ¼gbar');
                }
                
                // ğŸ†• v5.88.0: Lade SMS Settings
                if (typeof loadSMSSettings === 'function') {
                    loadSMSSettings();
                    console.log('âœ… SMS-Einstellungen geladen');
                }
                
                // ğŸ†• v5.88.1: Lade 50/50 Settings
                if (typeof loadFiftyFiftySettings === 'function') {
                    loadFiftyFiftySettings();
                    console.log('âœ… 50/50-Einstellungen geladen');
                }
            } else {
                // ğŸ”§ v5.90.101: ENTFERNE is-admin Klasse
                document.body.classList.remove('is-admin');
                
                // ğŸ†• v5.26.14d: Nicht eingeloggt: Fahrgast + Verlauf BEIDE anzeigen!
                if (fahrgastBtn) fahrgastBtn.style.display = 'block';
                if (verlaufBtn) verlaufBtn.style.display = 'block'; // âœ… AUCH ohne Login!
                
                // ğŸ†• v5.56.0: KEIN CRM ohne Login!
                const crmSection = document.getElementById('crm-section');
                if (crmSection) crmSection.style.display = 'none';
                
                switchView('passenger');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.26.0: TELEFON-AUTHENTIFIZIERUNG
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let phoneConfirmationResult = null;
        let phoneRecaptchaVerifier = null;
        let phoneResendTimer = null;
        
        // PrÃ¼fe ob Fahrgast eingeloggt ist - zeige Login-Screen wenn nicht
        function checkPassengerAuth() {
            // ğŸ› v5.47.1: PRÃœFE OB FIREBASE READY IST!
            if (typeof firebase === 'undefined' || !firebase.apps || firebase.apps.length === 0) {
                console.log('âš ï¸ Firebase noch nicht bereit - Ã¼berspringe Auth-Check');
                debugLog('warn', 'âš ï¸ Firebase noch nicht bereit');
                return false;
            }
            
            const user = firebase.auth().currentUser;
            const authScreen = document.getElementById('phone-auth-screen');
            
            // Wenn User Ã¼ber Firebase Auth eingeloggt ist â†’ verstecke Login-Screen
            if (user) {
                console.log('âœ… Firebase User eingeloggt:', user.phoneNumber || user.email);
                if (authScreen) authScreen.style.display = 'none';
                return true;
            }
            
        // ğŸ†• PrÃ¼fe ob "Quick Login" (bekannter Kunde ohne Firebase Auth)
            const quickLoginPhone = localStorage.getItem('loggedInPhone');
            if (quickLoginPhone) {
                console.log('âœ… Quick-Login aktiv:', quickLoginPhone);
                if (authScreen) authScreen.style.display = 'none';
                
                // ğŸ†• v5.42.2: Quick-Login-Box ist DEAKTIVIERT - Avatar stattdessen!
                // Quick-Login Daten laden + MenÃ¼ aktualisieren
                loadQuickLoginData();
                updateMenuProfile();
                
                // âœ… FIX: Anmelden-Button verstecken wenn eingeloggt!
                const loginButton = document.querySelector('button[onclick="showLoginModal()"]');
                if (loginButton) {
                    loginButton.style.display = 'none';
                    console.log('âœ… Anmelden-Button ausgeblendet (User ist eingeloggt)');
                }
                
                // Telefon ins Formular Ã¼bernehmen falls leer
                const phoneField = document.getElementById('customer-phone');
                if (phoneField && !phoneField.value) phoneField.value = quickLoginPhone;
                
                const savedName = localStorage.getItem('loggedInUserName');
                const nameField = document.getElementById('customer-name');
                if (nameField && !nameField.value && savedName) nameField.value = savedName;
                
                return true;
            }
            
            // Kein User â†’ zeige Login-Screen nur fÃ¼r Fahrgast-Tab
            console.log('ğŸ”’ Kein User eingeloggt - zeige Login-Screen');
            
            // âœ… FIX: Anmelden-Button ANZEIGEN wenn nicht eingeloggt!
            const loginButton = document.querySelector('button[onclick="showLoginModal()"]');
            if (loginButton) {
                loginButton.style.display = 'inline-block';
                console.log('âœ… Anmelden-Button angezeigt (User nicht eingeloggt)');
            }
            
            if (authScreen && currentView === 'passenger') {
                authScreen.style.display = 'block';
                initAuthScreenRecaptcha();
            }
            return false;
        }
        
        // reCAPTCHA initialisieren fÃ¼r Auth-Screen (nÃ¶tig fÃ¼r Firebase Phone Auth)
        function initAuthScreenRecaptcha() {
            if (phoneRecaptchaVerifier) return;
            
            try {
                phoneRecaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                    'size': 'invisible',
                    'callback': (response) => {
                        console.log('âœ… Auth-Screen reCAPTCHA gelÃ¶st');
                    },
                    'expired-callback': () => {
                        console.log('âš ï¸ Auth-Screen reCAPTCHA abgelaufen');
                        phoneRecaptchaVerifier = null;
                    }
                });
                phoneRecaptchaVerifier.render();
                console.log('âœ… Auth-Screen reCAPTCHA initialisiert');
            } catch (error) {
                console.error('ğŸ’¾ Auth-Screen reCAPTCHA Fehler:', error);
            }
        }
        
        // PrÃ¼fe ob Kunde schon registriert ist und logge ein oder starte SMS-Verifizierung
        async function checkAndLogin() {
            const countryCode = document.getElementById('phone-country-code').value;
            const phoneNumber = document.getElementById('phone-number-input').value.trim();
            const errorDiv = document.getElementById('phone-auth-error');
            const loginBtn = document.getElementById('check-login-btn');
            
            // Validierung
            if (!phoneNumber || phoneNumber.length < 6) {
                errorDiv.textContent = 'ğŸ’¾ Bitte gÃ¼ltige Telefonnummer eingeben';
                errorDiv.style.display = 'block';
                return;
            }
            
            // FÃ¼hrende 0 entfernen
            const cleanNumber = phoneNumber.replace(/^0+/, '');
            const fullPhoneNumber = countryCode + cleanNumber;
            
            console.log('ğŸ” PrÃ¼fe Telefonnummer:', fullPhoneNumber);
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'â³ PrÃ¼fe...';
            errorDiv.style.display = 'none';
            
            try {
                // ğŸ†• v5.90.132: STRIKTE SUCHE - SICHERHEIT!
                // Telefonnummer MUSS exakt stimmen (Zwei-Faktor-Auth!)
                console.log('ğŸ” Suche Kunde mit exakter Telefonnummer:', fullPhoneNumber);
                
                const customersSnapshot = await db.ref('customers')
                    .orderByChild('phone')
                    .equalTo(fullPhoneNumber)
                    .once('value');
                
                let existingCustomer = null;
                let customerId = null;
                
                if (customersSnapshot.exists()) {
                    const customers = customersSnapshot.val();
                    customerId = Object.keys(customers)[0];
                    existingCustomer = customers[customerId];
                    console.log('âœ… Kunde gefunden Ã¼ber phone:', existingCustomer.name);
                }
                
                // ğŸ†• v5.90.132: Wenn nicht Ã¼ber phone gefunden, prÃ¼fe mobilePhone
                if (!existingCustomer) {
                    const mobileSnapshot = await db.ref('customers')
                        .orderByChild('mobilePhone')
                        .equalTo(fullPhoneNumber)
                        .once('value');
                    
                    if (mobileSnapshot.exists()) {
                        const customers = mobileSnapshot.val();
                        customerId = Object.keys(customers)[0];
                        existingCustomer = customers[customerId];
                        console.log('âœ… Kunde gefunden Ã¼ber mobilePhone:', existingCustomer.name);
                    }
                }
                
                if (existingCustomer) {
                    // âœ… BEKANNTER KUNDE - Direkt einloggen ohne SMS!
                    console.log('âœ… Bekannter Kunde gefunden!', existingCustomer);
                    
                    // ğŸ†• v5.74.0: FIX - Lade NAME aus customerData.name (nicht displayName!)
                    const customerName = existingCustomer.name || fullPhoneNumber;
                    
                    // Speichere als "eingeloggt"
                    localStorage.setItem('loggedInPhone', fullPhoneNumber);
                    localStorage.setItem('loggedInUserId', existingCustomer.uid || customerId);
                    localStorage.setItem('loggedInUserName', customerName);
                    
                    console.log('ğŸ’¾ Gespeichert:', {
                        phone: fullPhoneNumber,
                        name: customerName,
                        userId: existingCustomer.uid || customerId
                    });
                    
                    // Login-Screen verstecken
                    document.getElementById('phone-auth-screen').style.display = 'none';
                    
                    // ğŸ†• v5.74.0: FIX - UI KOMPLETT UPDATEN!
                    console.log('ğŸ”„ Aktualisiere UI...');
                    
                    // 1. Quick-Login Daten laden
                    loadQuickLoginData();
                    console.log('âœ… loadQuickLoginData() fertig');
                    
                    // 2. Login-Button updaten
                    updateLoginButton();
                    console.log('âœ… updateLoginButton() fertig');
                    
                    // 3. MenÃ¼ updaten
                    updateMenuProfile();
                    console.log('âœ… updateMenuProfile() fertig');
                    
                    // Log
                    logActivity('system', 'quick_login', `Schnell-Login: ${fullPhoneNumber}`, {
                        phone: fullPhoneNumber,
                        customerId: customerId,
                        name: customerName
                    });
                    
                    console.log('ğŸ‰ Schnell-Login erfolgreich!');
                    
                    // Success-Message
                    alert(`âœ… Willkommen zurÃ¼ck ${customerName}!\n\nDu kannst jetzt Taxis buchen.`);
                    
                } else {
                    // ğŸ†• NEUER KUNDE - SMS-Verifizierung nÃ¶tig
                    console.log('ğŸ†• Neuer Kunde - starte SMS-Verifizierung');
                    
                    // Wechsel zur SMS-Verifizierung
                    loginBtn.textContent = 'ğŸ“¤ SMS wird gesendet...';
                    await sendVerificationCode();
                }
                
            } catch (error) {
                console.error('ğŸ’¾ Login-Fehler:', error);
                
                // Bei Fehler: Fallback auf SMS-Verifizierung
                console.log('âš ï¸ Fallback auf SMS-Verifizierung');
                await sendVerificationCode();
            }
            
            loginBtn.disabled = false;
            loginBtn.textContent = 'ğŸ”“ Anmelden';
        }
        
        // SMS-Code anfordern
        async function sendVerificationCode() {
            const countryCode = document.getElementById('phone-country-code').value;
            const phoneNumber = document.getElementById('phone-number-input').value.trim();
            const errorDiv = document.getElementById('phone-auth-error');
            const sendBtn = document.getElementById('send-code-btn');
            
            // Validierung
            if (!phoneNumber || phoneNumber.length < 6) {
                errorDiv.textContent = 'ğŸ’¾ Bitte gÃ¼ltige Telefonnummer eingeben';
                errorDiv.style.display = 'block';
                return;
            }
            
            // FÃ¼hrende 0 entfernen
            const cleanNumber = phoneNumber.replace(/^0+/, '');
            const fullPhoneNumber = countryCode + cleanNumber;
            
            console.log('ğŸ“± Sende Code an:', fullPhoneNumber);
            
            sendBtn.disabled = true;
            sendBtn.textContent = 'â³ Sende...';
            errorDiv.style.display = 'none';
            
            try {
                // reCAPTCHA neu initialisieren falls nÃ¶tig
                if (!phoneRecaptchaVerifier) {
                    initAuthScreenRecaptcha();
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                phoneConfirmationResult = await firebase.auth().signInWithPhoneNumber(
                    fullPhoneNumber, 
                    phoneRecaptchaVerifier
                );
                
                console.log('âœ… SMS gesendet!');
                
                // Wechsel zu Schritt 2
                document.getElementById('phone-step-1').style.display = 'none';
                document.getElementById('phone-step-2').style.display = 'block';
                document.getElementById('phone-sent-to').textContent = 'Code gesendet an ' + fullPhoneNumber;
                
                // Fokus auf erstes Code-Feld
                document.getElementById('code-1').focus();
                
                // Resend-Timer starten
                startResendTimer();
                
            } catch (error) {
                console.error('ğŸ’¾ SMS Fehler:', error);
                
                let errorMessage = 'ğŸ’¾ Fehler beim Senden der SMS';
                if (error.code === 'auth/invalid-phone-number') {
                    errorMessage = 'ğŸ’¾ UngÃ¼ltige Telefonnummer';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'ğŸ’¾ Zu viele Versuche. Bitte spÃ¤ter erneut versuchen.';
                } else if (error.code === 'auth/captcha-check-failed') {
                    errorMessage = 'ğŸ’¾ SicherheitsprÃ¼fung fehlgeschlagen. Bitte neu laden.';
                    phoneRecaptchaVerifier = null;
                }
                
                errorDiv.textContent = errorMessage;
                errorDiv.style.display = 'block';
                
                sendBtn.disabled = false;
                sendBtn.textContent = 'ğŸ“¤ SMS-Code anfordern';
            }
        }
        
        // Code-Eingabe: automatisch zum nÃ¤chsten Feld
        function moveToNext(current, nextId) {
            if (current.value.length === 1) {
                const nextInput = document.getElementById(nextId);
                if (nextInput) nextInput.focus();
            }
        }
        
        // Automatisch verifizieren wenn alle 6 Ziffern eingegeben
        function verifyCodeAuto() {
            const code = getEnteredCode();
            if (code.length === 6) {
                verifyCode();
            }
        }
        
        // Eingegebenen Code auslesen
        function getEnteredCode() {
            let code = '';
            for (let i = 1; i <= 6; i++) {
                code += document.getElementById('code-' + i).value;
            }
            return code;
        }
        
        // Code verifizieren
        async function verifyCode() {
            const code = getEnteredCode();
            const errorDiv = document.getElementById('phone-auth-error');
            const verifyBtn = document.getElementById('verify-code-btn');
            
            if (code.length !== 6) {
                errorDiv.textContent = 'ğŸ’¾ Bitte 6-stelligen Code eingeben';
                errorDiv.style.display = 'block';
                return;
            }
            
            verifyBtn.disabled = true;
            verifyBtn.textContent = 'â³ PrÃ¼fe...';
            errorDiv.style.display = 'none';
            
            try {
                const result = await phoneConfirmationResult.confirm(code);
                console.log('âœ… Telefon verifiziert!', result.user);
                
                const userPhone = result.user.phoneNumber;
                const userId = result.user.uid;
                
                // ğŸ†• v5.66.0: PrÃ¼fe ob User NEU ist
                const isNewUser = result.additionalUserInfo?.isNewUser || false;
                console.log('ğŸ†• Neuer User?', isNewUser);
                
                // Speichere in localStorage
                localStorage.setItem('loggedInPhone', userPhone);
                localStorage.setItem('loggedInUserId', userId);
                
                // ğŸ†• v5.72.0: SOFORT UI VORBEREITEN!
                console.log('ğŸ”„ SchlieÃŸe Login-Modal...');
                
                // Modal KOMPLETT schlieÃŸen
                const authScreen = document.getElementById('phone-auth-screen');
                if (authScreen) {
                    authScreen.style.display = 'none';
                }
                
                // Login-Modal auch schlieÃŸen falls offen
                const loginModal = document.getElementById('login-modal');
                if (loginModal) {
                    loginModal.style.display = 'none';
                }
                
                // ğŸ†• v5.90.133: KRITISCHER FIX!
                // PrÃ¼fe ZUERST ob Kunde bereits im CRM existiert (per phone ODER mobilePhone)!
                console.log('ğŸ” v5.90.133: PrÃ¼fe ob Kunde bereits im CRM existiert...');
                
                let existingCustomer = null;
                let existingCustomerId = null;
                
                try {
                    // Suche in phone
                    const phoneSnapshot = await db.ref('customers').orderByChild('phone').equalTo(userPhone).once('value');
                    if (phoneSnapshot.exists()) {
                        const customers = phoneSnapshot.val();
                        existingCustomerId = Object.keys(customers)[0];
                        existingCustomer = customers[existingCustomerId];
                        console.log('âœ… Kunde gefunden in phone:', existingCustomer.name);
                    }
                    
                    // Wenn nicht gefunden, suche in mobilePhone
                    if (!existingCustomer) {
                        const mobileSnapshot = await db.ref('customers').orderByChild('mobilePhone').equalTo(userPhone).once('value');
                        if (mobileSnapshot.exists()) {
                            const customers = mobileSnapshot.val();
                            existingCustomerId = Object.keys(customers)[0];
                            existingCustomer = customers[existingCustomerId];
                            console.log('âœ… Kunde gefunden in mobilePhone:', existingCustomer.name);
                        }
                    }
                } catch (err) {
                    console.error('âš ï¸ Fehler bei CRM-Suche:', err);
                }
                
                if (existingCustomer) {
                    // âœ… KUNDE EXISTIERT BEREITS IM CRM!
                    console.log('ğŸ¯ v5.90.133: Kunde existiert bereits im CRM:', existingCustomer.name);
                    console.log('ğŸ’¾ VerknÃ¼pfe mit Firebase Auth UID:', userId);
                    
                    // Speichere Name
                    localStorage.setItem('loggedInUserName', existingCustomer.name);
                    
                    // Speichere Adresse falls vorhanden
                    if (existingCustomer.address) {
                        localStorage.setItem('loggedInUserAddress', existingCustomer.address);
                    }
                    
                    // ğŸ†• v5.90.133: VerknÃ¼pfe CRM-Kunde mit Firebase Auth UID!
                    try {
                        await db.ref(`customers/${existingCustomerId}`).update({
                            uid: userId,
                            lastLogin: Date.now()
                        });
                        console.log('âœ… CRM-Kunde mit Firebase Auth verknÃ¼pft!');
                    } catch (err) {
                        console.error('âš ï¸ Fehler beim VerknÃ¼pfen:', err);
                    }
                    
                    console.log('ğŸ‰ Login erfolgreich als:', existingCustomer.name);
                    
                } else {
                    // ğŸ’¾ KUNDE EXISTIERT NICHT IM CRM
                    console.log('ğŸ†• v5.90.133: Kunde nicht im CRM gefunden');
                    
                    // ğŸ†• v5.72.0: NAME-HANDLING!
                    if (isNewUser) {
                        console.log('ğŸ¯ Neuer User â†’ frage nach Namen');
                        
                        // SOFORT Name abfragen (KEIN setTimeout!)
                        const userName = prompt('ğŸ‘‹ Willkommen!\n\nWie heiÃŸen Sie?');
                        
                        if (userName && userName.trim()) {
                            const trimmedName = userName.trim();
                            localStorage.setItem('loggedInUserName', trimmedName);
                            console.log('ğŸ’¾ Name gespeichert:', trimmedName);
                            
                            // In Firebase speichern
                            try {
                                const existing = await db.ref('customers').orderByChild('uid').equalTo(userId).once('value');
                                if (!existing.exists()) {
                                    await db.ref('customers').push({
                                        name: trimmedName,
                                        phone: userPhone,
                                        uid: userId,
                                        createdAt: Date.now(),
                                        totalRides: 0,
                                        totalRevenue: 0,
                                        source: 'phone-auth'
                                    });
                                    console.log('âœ… Kunde in Firebase erstellt');
                                }
                            } catch (err) {
                                console.error('âš ï¸ Firebase-Fehler:', err);
                            }
                        } else {
                            console.log('âš ï¸ Kein Name â†’ verwende Telefon');
                            localStorage.setItem('loggedInUserName', userPhone);
                        }
                    } else {
                        // BESTEHENDER USER â†’ Name aus Firebase laden
                        console.log('ğŸ’¾ Bestehender User â†’ lade Name aus Firebase');
                        console.log('ğŸ’¾ Suche Kunde mit Telefon:', userPhone);
                        
                        try {
                            // ğŸ†• v5.73.1: Suche nach TELEFON statt UID (robuster!)
                            const snapshot = await db.ref('customers').orderByChild('phone').equalTo(userPhone).once('value');
                            if (snapshot.exists()) {
                                const customerData = Object.values(snapshot.val())[0];
                                if (customerData.name) {
                                    localStorage.setItem('loggedInUserName', customerData.name);
                                    console.log('âœ… Name aus Firebase geladen:', customerData.name);
                                    
                                    // ğŸ†• v5.73.1: Speichere auch Adresse falls vorhanden
                                    if (customerData.address) {
                                        localStorage.setItem('loggedInUserAddress', customerData.address);
                                        console.log('âœ… Adresse aus Firebase geladen:', customerData.address);
                                    }
                                } else {
                                    console.log('âš ï¸ Kein Name in Firebase â†’ verwende Telefon');
                                    localStorage.setItem('loggedInUserName', userPhone);
                                }
                            } else {
                                console.log('âš ï¸ Kunde nicht in Firebase â†’ verwende Telefon');
                                localStorage.setItem('loggedInUserName', userPhone);
                            }
                        } catch (err) {
                            console.error('âš ï¸ Firebase-Fehler:', err);
                            localStorage.setItem('loggedInUserName', userPhone);
                        }
                    }
                }
                
                // ğŸ†• v5.72.0: JETZT ALLES UPDATEN!
                console.log('ğŸ”„ Aktualisiere UI...');
                
                // 1. Quick-Login Daten laden
                loadQuickLoginData();
                console.log('âœ… loadQuickLoginData() fertig');
                
                // 2. Login-Button updaten
                updateLoginButton();
                console.log('âœ… updateLoginButton() fertig');
                
                // 3. MenÃ¼ updaten
                updateMenuProfile();
                console.log('âœ… updateMenuProfile() fertig');
                
                // 4. Success-Message
                const displayName = localStorage.getItem('loggedInUserName') || userPhone;
                alert(`âœ… Willkommen ${displayName}!\n\nDu kannst jetzt Taxis buchen.`);
                
                console.log('ğŸ‰ Login komplett!');
                
            } catch (error) {
                console.error('ğŸ’¾ Code-Fehler:', error);
                
                let errorMessage = 'ğŸ’¾ Falscher Code';
                if (error.code === 'auth/invalid-verification-code') {
                    errorMessage = 'ğŸ’¾ Falscher Code. Bitte erneut versuchen.';
                } else if (error.code === 'auth/code-expired') {
                    errorMessage = 'ğŸ’¾ Code abgelaufen. Bitte neuen Code anfordern.';
                }
                
                errorDiv.textContent = errorMessage;
                errorDiv.style.display = 'block';
                
                // Code-Felder leeren
                for (let i = 1; i <= 6; i++) {
                    document.getElementById('code-' + i).value = '';
                }
                document.getElementById('code-1').focus();
                
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'âœ… BestÃ¤tigen';
            }
        }
        
        // ZurÃ¼ck zu Schritt 1
        function goBackToPhone() {
            document.getElementById('phone-step-1').style.display = 'block';
            document.getElementById('phone-step-2').style.display = 'none';
            document.getElementById('phone-auth-error').style.display = 'none';
            document.getElementById('send-code-btn').disabled = false;
            document.getElementById('send-code-btn').textContent = 'ğŸ“¤ SMS-Code anfordern';
            
            // Code-Felder leeren
            for (let i = 1; i <= 6; i++) {
                document.getElementById('code-' + i).value = '';
            }
            
            // Timer stoppen
            if (phoneResendTimer) {
                clearInterval(phoneResendTimer);
            }
        }
        
        // ğŸ†• v5.75.0: E-MAIL LOGIN IM AUTH SCREEN
        function showEmailLoginInAuthScreen() {
            document.getElementById('phone-step-1').style.display = 'none';
            document.getElementById('email-login-section').style.display = 'block';
        }
        
        function showPhoneLoginInAuthScreen() {
            document.getElementById('email-login-section').style.display = 'none';
            document.getElementById('phone-step-1').style.display = 'block';
        }
        
        async function loginWithGoogleFromAuthScreen() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                
                // ğŸ†• v5.87.51: ERZWINGE Account-Auswahl!
                provider.setCustomParameters({
                    prompt: 'select_account'  // Zeigt IMMER Account-Auswahl!
                });
                
                const result = await auth.signInWithPopup(provider);
                
                console.log('âœ… Google Login erfolgreich:', result.user.email);
                
                // Auth Screen schlieÃŸen
                document.getElementById('phone-auth-screen').style.display = 'none';
                
                // UI updaten
                setTimeout(() => {
                    checkPassengerAuth();
                    loadQuickLoginData();
                    updateMenuProfile();
                    updateUserProfile();
                }, 500);
                
                alert('âœ… Erfolgreich angemeldet!\n\nğŸ“§ ' + result.user.email);
                
            } catch (error) {
                console.error('ğŸ’¾ Google Login Fehler:', error);
                alert('ğŸ’¾ Login fehlgeschlagen: ' + error.message);
            }
        }
        
        async function loginWithEmailFromAuthScreen() {
            const email = document.getElementById('email-login-input').value.trim();
            const password = document.getElementById('email-password-input').value;
            
            if (!email || !password) {
                alert('ğŸ’¾ Bitte E-Mail und Passwort eingeben!');
                return;
            }
            
            try {
                const result = await auth.signInWithEmailAndPassword(email, password);
                
                console.log('âœ… E-Mail Login erfolgreich:', result.user.email);
                
                // Auth Screen schlieÃŸen
                document.getElementById('phone-auth-screen').style.display = 'none';
                
                // Felder leeren
                document.getElementById('email-login-input').value = '';
                document.getElementById('email-password-input').value = '';
                
                // UI updaten
                setTimeout(() => {
                    checkPassengerAuth();
                    loadQuickLoginData();
                    updateMenuProfile();
                    updateUserProfile();
                }, 500);
                
                alert('âœ… Erfolgreich angemeldet!\n\nğŸ“§ ' + result.user.email);
                
            } catch (error) {
                console.error('ğŸ’¾ E-Mail Login Fehler:', error);
                
                let errorMessage = 'ğŸ’¾ Login fehlgeschlagen';
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'ğŸ’¾ Benutzer nicht gefunden';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'ğŸ’¾ Falsches Passwort';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'ğŸ’¾ UngÃ¼ltige E-Mail Adresse';
                }
                
                alert(errorMessage);
            }
        }
        
        // Resend-Timer (60 Sekunden warten)
        function startResendTimer() {
            let seconds = 60;
            const timerDiv = document.getElementById('resend-timer');
            
            if (phoneResendTimer) clearInterval(phoneResendTimer);
            
            phoneResendTimer = setInterval(() => {
                seconds--;
                if (seconds > 0) {
                    timerDiv.textContent = `Neuen Code anfordern in ${seconds}s`;
                } else {
                    clearInterval(phoneResendTimer);
                    timerDiv.innerHTML = '<button onclick="goBackToPhone()" style="background:none;border:none;color:#667eea;cursor:pointer;text-decoration:underline;">ğŸ“¤ Neuen Code anfordern</button>';
                }
            }, 1000);
        }
        
        // ğŸ†• v5.26.12: Quick-Login Profil bearbeiten
        function showQuickLoginProfile() {
            console.log('âœï¸ Ã–ffne Quick-Login Profil...');
            
            // Lade gespeicherte Daten
            const phone = localStorage.getItem('loggedInPhone') || '';
            const name = localStorage.getItem('loggedInUserName') || '';
            const address = localStorage.getItem('loggedInUserAddress') || '';
            const billingName = localStorage.getItem('loggedInBillingName') || '';
            const billingStreet = localStorage.getItem('loggedInBillingStreet') || '';
            const billingZip = localStorage.getItem('loggedInBillingZip') || '';
            const billingCity = localStorage.getItem('loggedInBillingCity') || '';
            
            // ğŸ†• v5.72.2: DEBUGGING!
            console.log('ğŸ“‹ Geladene Daten aus localStorage:');
            console.log('  - Telefon:', phone);
            console.log('  - Name:', name || 'ğŸ’¾ LEER!');
            console.log('  - Adresse:', address || '(leer)');
            console.log('  - Rechnungsname:', billingName || '(leer)');
            
            if (!name) {
                console.error('âš ï¸ PROBLEM: loggedInUserName ist LEER!');
                console.log('ğŸ’¡ Alle localStorage Keys:');
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    console.log(`   - ${key} = ${localStorage.getItem(key)}`);
                }
            }
            
            // ğŸ†• v5.68.0: Lade auch Koordinaten
            const addressLat = localStorage.getItem('loggedInUserAddressLat');
            const addressLng = localStorage.getItem('loggedInUserAddressLng');
            if (addressLat && addressLng) {
                profileAddressCoords = {
                    lat: parseFloat(addressLat),
                    lon: parseFloat(addressLng)
                };
                console.log('ğŸ“ Gespeicherte Koordinaten geladen:', profileAddressCoords);
            } else {
                profileAddressCoords = null;
            }
            
            // Erstelle Modal
            const modal = document.createElement('div');
            modal.id = 'quick-login-profile-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;width:100%;max-width:400px;max-height:90vh;overflow-y:auto;">
                    <h3 style="margin:0 0 15px 0;">âœï¸ Meine Daten bearbeiten</h3>
                    
                    <div style="display:flex;flex-direction:column;gap:12px;">
                        <!-- Name -->
                        <div>
                            <label style="display:block;font-size:12px;color:#666;margin-bottom:4px;font-weight:600;">ğŸ’¾ Name</label>
                            <input type="text" id="quick-profile-name" value="${name}" placeholder="Max Mustermann" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;box-sizing:border-box;font-size:14px;">
                        </div>
                        
                        <!-- Telefon (nicht editierbar) -->
                        <div>
                            <label style="display:block;font-size:12px;color:#666;margin-bottom:4px;font-weight:600;">ğŸ“± Telefonnummer</label>
                            <input type="tel" value="${phone}" disabled style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;background:#f3f4f6;color:#666;box-sizing:border-box;font-size:14px;">
                            <div style="font-size:11px;color:#999;margin-top:4px;">Telefonnummer kann nicht geÃ¤ndert werden</div>
                        </div>
                        
                        <!-- Abholadresse -->
                        <div style="position:relative;">
                            <label style="display:block;font-size:12px;color:#666;margin-bottom:4px;font-weight:600;">ğŸ“ Standard-Abholadresse</label>
                            <input type="text" id="quick-profile-address" value="${address}" placeholder="z.B. Bahnhof Heringsdorf" 
                                oninput="handleProfileAddressInput()" 
                                style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;box-sizing:border-box;font-size:14px;">
                            <div id="profile-address-dropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:white;border:2px solid #e0e0e0;border-radius:8px;max-height:200px;overflow-y:auto;z-index:1000;margin-top:4px;box-shadow:0 4px 12px rgba(0,0,0,0.1);"></div>
                            <div style="font-size:11px;color:#999;margin-top:4px;">Wird automatisch als Abholort verwendet</div>
                        </div>
                        
                        <!-- Rechnungsadresse Header -->
                        <div style="margin-top:10px;padding-top:15px;border-top:1px solid #e5e7eb;">
                            <div style="font-size:13px;font-weight:600;color:#374151;margin-bottom:8px;">ğŸ§¾ Rechnungsadresse (optional)</div>
                        </div>
                        
                        <!-- Rechnungsname -->
                        <div>
                            <label style="display:block;font-size:12px;color:#666;margin-bottom:4px;font-weight:600;">Name / Firma</label>
                            <input type="text" id="quick-profile-billing-name" value="${billingName}" placeholder="Max Mustermann oder Firma GmbH" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;box-sizing:border-box;font-size:14px;">
                        </div>
                        
                        <!-- RechnungsstraÃŸe -->
                        <div>
                            <label style="display:block;font-size:12px;color:#666;margin-bottom:4px;font-weight:600;">StraÃŸe + Hausnummer</label>
                            <input type="text" id="quick-profile-billing-street" value="${billingStreet}" placeholder="MusterstraÃŸe 123" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;box-sizing:border-box;font-size:14px;">
                        </div>
                        
                        <!-- PLZ + Ort -->
                        <div style="display:flex;gap:10px;">
                            <div style="width:100px;">
                                <label style="display:block;font-size:12px;color:#666;margin-bottom:4px;font-weight:600;">PLZ</label>
                                <input type="text" id="quick-profile-billing-zip" value="${billingZip}" placeholder="17424" maxlength="5" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;box-sizing:border-box;font-size:14px;">
                            </div>
                            <div style="flex:1;">
                                <label style="display:block;font-size:12px;color:#666;margin-bottom:4px;font-weight:600;">Ort</label>
                                <input type="text" id="quick-profile-billing-city" value="${billingCity}" placeholder="Heringsdorf" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;box-sizing:border-box;font-size:14px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Buttons -->
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button onclick="closeQuickProfileModal()" style="flex:1;padding:12px;background:#e5e7eb;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                            ğŸ’¾ Abbrechen
                        </button>
                        <button onclick="saveQuickLoginProfile()" style="flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                            ğŸ’¾ Speichern
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Fokus auf Name-Feld
            setTimeout(() => {
                document.getElementById('quick-profile-name')?.focus();
            }, 100);
        }
        
        // ğŸ†• v5.68.0: Autocomplete fÃ¼r Standard-Abholadresse im Profil
        let profileAddressCoords = null;
        let profileAddressDebounce = null;
        
        function handleProfileAddressInput() {
            const input = document.getElementById('quick-profile-address');
            const dropdown = document.getElementById('profile-address-dropdown');
            if (!input || !dropdown) return;
            
            const query = input.value.trim();
            
            // Kein Query â†’ verstecke Dropdown
            if (!query || query.length < 3) {
                dropdown.style.display = 'none';
                profileAddressCoords = null;
                return;
            }
            
            // Debounce: Warte 300ms nach letzter Eingabe
            clearTimeout(profileAddressDebounce);
            profileAddressDebounce = setTimeout(async () => {
                try {
                    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=de&viewbox=10.6,54.7,14.4,53.1&bounded=1&limit=5`;
                    const response = await fetch(url);
                    const results = await response.json();
                    
                    if (results.length === 0) {
                        dropdown.innerHTML = '<div style="padding:12px;color:#999;">Keine Ergebnisse gefunden</div>';
                        dropdown.style.display = 'block';
                        return;
                    }
                    
                    dropdown.innerHTML = results.map(r => `
                        <div onclick="selectProfileAddress('${r.display_name.replace(/'/g, "\\'")}', ${r.lat}, ${r.lon})" 
                            style="padding:12px;cursor:pointer;border-bottom:1px solid #f0f0f0;"
                            onmouseover="this.style.background='#f3f4f6'"
                            onmouseout="this.style.background='white'">
                            ğŸ“ ${r.display_name}
                        </div>
                    `).join('');
                    dropdown.style.display = 'block';
                    
                } catch (error) {
                    console.error('Autocomplete Fehler:', error);
                }
            }, 300);
        }
        
        function selectProfileAddress(address, lat, lon) {
            const input = document.getElementById('quick-profile-address');
            const dropdown = document.getElementById('profile-address-dropdown');
            
            if (input) input.value = address;
            if (dropdown) dropdown.style.display = 'none';
            
            // Speichere Koordinaten temporÃ¤r
            profileAddressCoords = { lat, lon };
            console.log('âœ… Profil-Adresse gewÃ¤hlt:', address, profileAddressCoords);
        }
        
        function closeQuickProfileModal() {
            const modal = document.getElementById('quick-login-profile-modal');
            if (modal) modal.remove();
        }
        
        function saveQuickLoginProfile() {
            console.log('ğŸ’¾ Speichere Quick-Login Profil...');
            
            // Lese Daten aus Formular
            const name = document.getElementById('quick-profile-name')?.value.trim() || '';
            const address = document.getElementById('quick-profile-address')?.value.trim() || '';
            const billingName = document.getElementById('quick-profile-billing-name')?.value.trim() || '';
            const billingStreet = document.getElementById('quick-profile-billing-street')?.value.trim() || '';
            const billingZip = document.getElementById('quick-profile-billing-zip')?.value.trim() || '';
            const billingCity = document.getElementById('quick-profile-billing-city')?.value.trim() || '';
            
            // ğŸ†• v5.72.2: DEBUGGING!
            console.log('ğŸ“ Werte aus Formular:');
            console.log('  - Name:', name || 'ğŸ’¾ LEER!');
            console.log('  - Adresse:', address || '(leer)');
            
            // Validierung
            if (!name) {
                console.error('ğŸ’¾ VALIDIERUNG FEHLGESCHLAGEN: Name ist leer!');
                alert('ğŸ’¾ Bitte Name eingeben!');
                return;
            }
            
            // Speichere in localStorage
            console.log('ğŸ’¾ Speichere in localStorage...');
            localStorage.setItem('loggedInUserName', name);
            console.log('âœ… loggedInUserName gespeichert:', localStorage.getItem('loggedInUserName'));
            if (address) {
                localStorage.setItem('loggedInUserAddress', address);
                // ğŸ†• v5.68.0: Speichere auch Koordinaten wenn vorhanden!
                if (profileAddressCoords) {
                    localStorage.setItem('loggedInUserAddressLat', String(profileAddressCoords.lat));
                    localStorage.setItem('loggedInUserAddressLng', String(profileAddressCoords.lon));
                    console.log('âœ… Koordinaten gespeichert:', profileAddressCoords);
                }
            }
            if (billingName) localStorage.setItem('loggedInBillingName', billingName);
            if (billingStreet) localStorage.setItem('loggedInBillingStreet', billingStreet);
            if (billingZip) localStorage.setItem('loggedInBillingZip', billingZip);
            if (billingCity) localStorage.setItem('loggedInBillingCity', billingCity);
            
            console.log('âœ… Profil gespeichert:', { name, address, billingName, billingStreet, billingZip, billingCity });
            
            // Reset coords
            profileAddressCoords = null;
            
            // ğŸ†• v5.42.1: Lade Quick-Login Daten neu + aktualisiere MenÃ¼!
            loadQuickLoginData();
            
            // SchlieÃŸe Modal
            closeQuickProfileModal();
            
            // Zeige Erfolg
            alert('âœ… Profil gespeichert!\n\nğŸ’¾ ' + name + (address ? '\nğŸ“ ' + address : ''));
            
            // Aktualisiere Formularfelder falls leer
            const nameField = document.getElementById('customer-name');
            if (nameField && !nameField.value) nameField.value = name;
            
            const addressField = document.getElementById('pickup-location');
            if (addressField && !addressField.value && address) addressField.value = address;
        }
        
        // ğŸ†• Quick-Login Logout
        function logoutQuickLogin() {
            if (!confirm('Wirklich abmelden?')) return;
            
            console.log('ğŸšª Quick-Login Logout wird ausgefÃ¼hrt...');
            
            // Quick-Login Daten lÃ¶schen
            localStorage.removeItem('loggedInPhone');
            localStorage.removeItem('loggedInUserId');
            localStorage.removeItem('loggedInUserName');
            
            console.log('âœ… Quick-Login Daten gelÃ¶scht');
            
            // ğŸ†• v5.45.6: SEITE NEU LADEN damit alles sauber ist!
            console.log('ğŸ”„ Lade Seite neu...');
            location.reload();
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function onUserLoggedIn(user) {
            console.log('ğŸ’¾ User eingeloggt:', user.email || user.phoneNumber);
            currentUser = user;
            
            // ğŸ†• v5.26.0: Login-Screen verstecken
            const authScreen = document.getElementById('phone-auth-screen');
            if (authScreen) authScreen.style.display = 'none';
            
            // ğŸ§¹ CLEANUP: Alte Fahrzeuge dieses Users offline setzen
            if (isFirebaseReady) {
                try {
                    const driversSnapshot = await db.ref('vehicles').once('value');
                    const driversData = driversSnapshot.val() || {};
                    
                    for (const vehicleId in driversData) {
                        const driver = driversData[vehicleId];
                        // PrÃ¼fe ob dieses Fahrzeug dem aktuellen User gehÃ¶rt
                        if (driver && driver.online && 
                            (driver.userId === user.uid || driver.userEmail === (user.email || user.phoneNumber))) {
                            
                            console.log('ğŸ§¹ Altes Fahrzeug gefunden:', vehicleId, '- setze offline');
                            await db.ref('vehicles/' + vehicleId).update({
                                online: false,
                                lastOffline: Date.now()
                            });
                            
                            const vehicleName = VEHICLES[vehicleId] ? VEHICLES[vehicleId].name : vehicleId;
                            const userContact = user.email || user.phoneNumber || 'Unbekannt';
                            logActivity('driver', 'offline', 
                                `Fahrer ${userContact} (${vehicleName}) ist jetzt OFFLINE (Neuer Login)`, {
                                vehicle: vehicleId,
                                driver: vehicleName,
                                email: userContact
                            });
                        }
                    }
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim Cleanup alter Fahrzeuge:', error);
                }
            }
            
            // ğŸ” Rolle laden und anwenden
            const role = await getUserRole(user);
            
            // ğŸ†• v5.90.312: Rolle zu currentUser hinzufÃ¼gen!
            if (currentUser) {
                currentUser.role = role;
                console.log('ğŸ­ v5.90.312: Rolle gesetzt:', role);
            }
            
            applyRoleRestrictions(role);
            
            // ğŸ†• v5.90.525: OPTIMIERTER FIREBASE LISTENER FÃœR FAHRER!
            if (role === 'driver') {
                console.log('ğŸš— v5.90.525: Fahrer-Login erkannt - optimiere Firebase Listener!');
                
                // ğŸ†• v5.90.542: STELLE FAHRER-STATUS WIEDER HER!
                setTimeout(() => {
                    restoreDriverState();
                }, 2000); // Warte 2 Sek bis Firebase ready
                
                // Warte bis Fahrzeug gewÃ¤hlt wurde
                const waitForVehicle = setInterval(() => {
                    if (currentVehicle) {
                        clearInterval(waitForVehicle);
                        console.log('ğŸš— v5.90.525: Fahrzeug gewÃ¤hlt:', currentVehicle);
                        
                        // Stoppe den globalen Listener (lÃ¤dt ALLE Fahrten)
                        db.ref('rides').off('value');
                        console.log('ğŸ›‘ v5.90.525: Globaler Rides-Listener gestoppt');
                        
                        // Starte optimierten Listener NUR fÃ¼r dieses Fahrzeug!
                        db.ref('rides')
                            .orderByChild('vehicleId')
                            .equalTo(currentVehicle)
                            .on('value', (s) => {
                                console.log('ğŸ”„ v5.90.525: Optimierter Fahrer-Listener - nur meine Fahrten!');
                                
                                // Nur Fahrten fÃ¼r MEIN Fahrzeug laden!
                                rides = [];
                                s.forEach(c => {
                                    const r = c.val();
                                    r.firebaseId = c.key;
                                    rides.push(r);
                                });
                                
                                console.log(`âœ… v5.90.525: ${rides.length} Fahrten geladen (nur fÃ¼r ${currentVehicle})`);
                                
                                // Update Driver View
                                if (currentView === 'driver') {
                                    updateDriverView();
                                }
                            });
                        
                        console.log('âœ… v5.90.525: Optimierter Firebase Listener gestartet!');
                    }
                }, 500);
            }
            
            // ğŸ†• v5.33.6: Update Tab-Visibility nach Rolle
            updateAdminTabsVisibility();
            
            // ğŸ“œ PROTOKOLL: Login (mit App-Version)
            logActivity('system', 'login', `Login: ${user.email || user.phoneNumber} (${role || 'Fahrgast'})`, {
                email: user.email || '',
                phone: user.phoneNumber || '',
                role: role || 'Fahrgast',
                appVersion: APP_VERSION,
                appBuild: APP_BUILD
            });
            
            // ğŸ“± User in Firebase speichern - IMMER, auch wenn Admin nicht online!
            if (isFirebaseReady) {
                try {
                    // Erst prÃ¼fen ob User schon existiert
                    const userSnapshot = await db.ref('users/' + user.uid).once('value');
                    const existingUser = userSnapshot.val();
                    
                    // Update-Daten vorbereiten
                    const updateData = {
                        lastLogin: Date.now(),
                        displayName: user.displayName || existingUser?.displayName || '',
                    };
                    
                    // E-Mail hinzufÃ¼gen wenn vorhanden
                    if (user.email) {
                        updateData.email = user.email;
                    }
                    
                    // Telefonnummer hinzufÃ¼gen wenn vorhanden
                    if (user.phoneNumber) {
                        updateData.phone = user.phoneNumber;
                    }
                    
                    // Provider-Info (Google, Email, Phone)
                    if (user.providerData && user.providerData[0]) {
                        updateData.providerId = user.providerData[0].providerId;
                    }
                    
                    // createdAt NUR setzen wenn User neu ist
                    if (!existingUser) {
                        updateData.createdAt = Date.now();
                        updateData.role = 'fahrgast'; // Standard-Rolle
                        console.log('ğŸ†• Neuer User wird angelegt:', user.uid);
                    }
                    
                    await db.ref('users/' + user.uid).update(updateData);
                    console.log('ğŸ“± User-Daten gespeichert:', updateData);
                    
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim Speichern der User-Daten:', error);
                }
            }
            
            updateUserProfile();
            
            // ğŸ“ FÃ¼lle Name-Feld NUR wenn NICHT fÃ¼r Kunden gebucht wird
            const nameField = document.getElementById('customer-name');
            if (nameField && user.displayName && !currentBookingCustomerId) {
                nameField.value = user.displayName;
            }
            
            // ğŸ’¾ Lade "Mein Profil" fÃ¼r eingeloggte Kunden
            loadMyProfile();
            
            // ğŸ†• v5.42.1: Lade auch Quick-Login Daten (fÃ¼r Phone-Login)
            loadQuickLoginData();
            
            // ğŸ†• v5.73.1: Wenn Phone-Login UND kein Name in localStorage â†’ aus Firebase laden!
            if (user.phoneNumber && !localStorage.getItem('loggedInUserName')) {
                console.log('ğŸ’¾ Phone-Login OHNE Namen â†’ lade aus Firebase...');
                db.ref('customers').orderByChild('phone').equalTo(user.phoneNumber).once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        const customerData = Object.values(snapshot.val())[0];
                        if (customerData.name) {
                            localStorage.setItem('loggedInUserName', customerData.name);
                            console.log('âœ… Name nachgeladen:', customerData.name);
                            
                            // UI aktualisieren!
                            loadQuickLoginData();
                            updateLoginButton();
                            updateMenuProfile();
                        }
                    } else {
                        console.log('âš ï¸ Kein Kunde in Firebase gefunden');
                    }
                }).catch(err => {
                    console.error('ğŸ’¾ Fehler beim Laden des Namens:', err);
                });
            }
            
            // ğŸ†• v5.19.0: Lade Telegram-ID fÃ¼r diesen User
            loadDriverTelegramId();
            
            // ğŸ†• v5.20.1: Lade gespeichertes Fahrzeug
            loadSavedVehicle();
            
            // ğŸ†• v5.87.70: Update Login-Button nach Login!
            updateLoginButton();
            
            // ğŸ†• v5.90.227: Lade Anruf-Favoriten!
            loadCallFavorites();
            updateCallFavoritesFAB();
            
            // ğŸ†• v5.90.582: ROLE-BASED AUTO-SWITCH!
            setTimeout(() => {
                console.log('ğŸ¯ v5.90.584: Role-Based View Switch:', role);
                
                // ğŸ”§ v5.90.584: DEUTSCH + ENGLISCH! Firebase kann beides haben!
                if (role === 'driver' || role === 'fahrer') {
                    console.log('ğŸš— v5.90.584: Fahrer-Login â†’ Wechsle zu Driver-View (GESPERRT!)');
                    switchView('driver');
                    
                    // ğŸ”’ Verstecke andere Tabs fÃ¼r Fahrer!
                    const tabBar = document.getElementById('main-tab-bar');
                    if (tabBar) {
                        // Verstecke alle Tabs auÃŸer Driver
                        const allTabs = tabBar.querySelectorAll('.view-btn, .admin-tab-btn');
                        allTabs.forEach(btn => {
                            const isDriverBtn = btn.getAttribute('onclick')?.includes('driver');
                            if (!isDriverBtn) {
                                btn.style.display = 'none';
                            }
                        });
                        console.log('ğŸ”’ v5.90.584: Andere Tabs fÃ¼r Fahrer ausgeblendet!');
                    }
                } else if (role === 'admin') {
                    console.log('ğŸ‘¨â€ğŸ’¼ v5.90.584: Admin-Login â†’ Lade letzten Tab');
                    const lastTab = localStorage.getItem('lastActiveTab') || 'admin';
                    switchView(lastTab);
                } else {
                    console.log('ğŸ‘¤ v5.90.584: Passenger-Login â†’ Passenger-View');
                    switchView('passenger');
                }
            }, 500);
        }
        
        function onUserLoggedOut() {
            // ğŸ†• v5.21.0: Stack Trace um zu sehen WOHER der Logout kommt
            console.log('ğŸ’¾ onUserLoggedOut aufgerufen');
            console.trace('ğŸ“ Logout Stack Trace:');
            
            // ğŸ“œ PROTOKOLL: Logout (vor dem ZurÃ¼cksetzen!)
            if (currentUser) {
                logActivity('system', 'logout', `ğŸ” Logout: ${currentUser.email}`, {
                    email: currentUser.email,
                    reason: 'auth_state_changed'
                });
            } else {
                // User war schon null - unerwarteter Logout!
                logActivity('system', 'logout', `âš ï¸ Unerwarteter Logout (User war bereits null)`, {
                    reason: 'unexpected'
                });
            }
            
            console.log('ğŸ’¾ User ausgeloggt');
            currentUser = null;
            userRole = 'fahrgast';
            myProfileData = null;
            quickLoginData = null; // ğŸ†• v5.42.1
            
            // ğŸ’¾ "Mein Profil" Box ausblenden
            const profileBox = document.getElementById('my-profile-box');
            if (profileBox) profileBox.style.display = 'none';
            
            // ğŸ” Nur Fahrgast-Tab fÃ¼r nicht eingeloggte User
            applyRoleRestrictions(null); // null = nicht eingeloggt
            
            updateUserProfile();
        }
        
        // ğŸ†• v5.70.0: updateLoginButton ist Alias fÃ¼r updateUserProfile
        function updateLoginButton() {
            updateUserProfile();
        }
        
        function updateUserProfile() {
            const header = document.querySelector('.header');
            if (!header) {
                console.warn('âš ï¸ Header element not found yet');
                return;
            }
            
            let profileBox = document.getElementById('user-profile-box');
            
            if (currentUser) {
                // User ist eingeloggt - zeige Profil + Stammkunden-Info
                const initial = (currentUser.displayName || currentUser.email || currentUser.phoneNumber || '?').charAt(0).toUpperCase();
                const displayName = currentUser.displayName || (currentUser.email ? currentUser.email.split('@')[0] : currentUser.phoneNumber) || 'Unbekannt';
                
                // ğŸ†• v5.88.6: Zeige Telefon ODER E-Mail (nicht "null"!)
                const subInfo = currentUser.email || currentUser.phoneNumber;
                
                // Lade Stammkunden-Daten
                const regularCustomer = JSON.parse(localStorage.getItem('regularCustomer') || 'null');
                
                if (!profileBox) {
                    profileBox = document.createElement('div');
                    profileBox.id = 'user-profile-box';
                    profileBox.className = 'user-profile';
                    header.appendChild(profileBox);
                }
                
                // Stammkunden-Info
                let customerStats = '';
                if (regularCustomer && regularCustomer.rideCount > 0) {
                    customerStats = `<div style="font-size: 9px; opacity: 0.8; margin-top: 2px;">ğŸš• ${regularCustomer.rideCount} Fahrt${regularCustomer.rideCount > 1 ? 'en' : ''} Â· ğŸ“ ${regularCustomer.favoritePickup ? regularCustomer.favoritePickup.substring(0, 20) + (regularCustomer.favoritePickup.length > 20 ? '...' : '') : 'Keine Adresse'}</div>`;
                }
                
                profileBox.innerHTML = `
                    <div class="user-avatar">${initial}</div>
                    <div class="user-info">
                        <div style="font-weight: 600; font-size: 11px;">${displayName}</div>
                        <div style="font-size: 9px; opacity: 0.75;">${subInfo}</div>
                        ${customerStats}
                    </div>
                    <button class="btn-logout" onclick="logoutUser()">Aus</button>
                `;
            } else {
                // ğŸ†• v5.42.2: PrÃ¼fe auch Quick-Login!
                const quickLoginPhone = localStorage.getItem('loggedInPhone');
                const quickLoginName = localStorage.getItem('loggedInUserName');
                
                if (quickLoginPhone) {
                    // Quick-Login User ist eingeloggt â†’ Zeige Profil + LOGOUT!
                    if (!profileBox) {
                        profileBox = document.createElement('div');
                        profileBox.id = 'user-profile-box';
                        profileBox.className = 'user-profile';  // âœ… Nutze user-profile Style!
                        header.appendChild(profileBox);
                    }
                    
                    // ğŸ†• v5.70.0: Zeige NAME statt "Telefon-Login"!
                    const phoneDisplay = quickLoginPhone.substring(0, 6) + '***';
                    const nameDisplay = quickLoginName || phoneDisplay;
                    const initial = quickLoginName ? quickLoginName.charAt(0).toUpperCase() : 'ğŸ“±';
                    
                    profileBox.innerHTML = `
                        <div class="user-avatar">${initial}</div>
                        <div class="user-info">
                            <div style="font-weight: 600; font-size: 11px;">${nameDisplay}</div>
                            <div style="font-size: 9px; opacity: 0.75;">${phoneDisplay}</div>
                        </div>
                        <button class="btn-logout" onclick="logoutQuickLogin()">Aus</button>
                    `;
                } else {
                    // User ist nicht eingeloggt - zeige nur Anmelden Button
                    if (!profileBox) {
                        profileBox = document.createElement('div');
                        profileBox.id = 'user-profile-box';
                        header.appendChild(profileBox);
                    }
                    
                    profileBox.className = '';
                    profileBox.style.marginTop = '15px';
                    profileBox.innerHTML = `
                        <button class="btn btn-primary" onclick="showLoginModal()" style="padding: 10px 20px; font-size: 13px;">
                            ğŸ” Anmelden / Registrieren
                        </button>
                    `;
                }
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.26.13: POI / FAVORITEN-ORTE MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Lade gespeicherte Orte beim Start
        function loadSavedLocations() {
            const locations = JSON.parse(localStorage.getItem('savedLocations') || '[]');
            
            // Pickup Orte
            const pickupContainer = document.getElementById('pickup-saved-locations');
            if (locations.length > 0) {
                pickupContainer.style.display = 'flex';
                pickupContainer.style.flexWrap = 'wrap';
                pickupContainer.style.gap = '6px';
                pickupContainer.innerHTML = locations.map(loc => `
                    <button onclick="useSavedLocation('pickup', '${loc.address.replace(/'/g, "\\'")}', ${loc.lat || 'null'}, ${loc.lon || 'null'})" 
                        style="padding:8px 12px;background:#dbeafe;border:2px solid #3b82f6;color:#1e40af;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:4px;">
                        ${loc.icon} ${loc.name}
                    </button>
                `).join('') + `
                    <button onclick="manageLocations()" 
                        style="padding:8px 12px;background:#f3f4f6;border:2px solid #d1d5db;color:#6b7280;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;">
                        âš™ï¸ Verwalten
                    </button>
                `;
            } else {
                pickupContainer.style.display = 'none';
            }
            
            // Destination Orte
            const destContainer = document.getElementById('destination-saved-locations');
            if (locations.length > 0) {
                destContainer.style.display = 'flex';
                destContainer.style.flexWrap = 'wrap';
                destContainer.style.gap = '6px';
                destContainer.innerHTML = locations.map(loc => `
                    <button onclick="useSavedLocation('destination', '${loc.address.replace(/'/g, "\\'")}', ${loc.lat || 'null'}, ${loc.lon || 'null'})" 
                        style="padding:8px 12px;background:#fef3c7;border:2px solid #f59e0b;color:#92400e;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:4px;">
                        ${loc.icon} ${loc.name}
                    </button>
                `).join('') + `
                    <button onclick="manageLocations()" 
                        style="padding:8px 12px;background:#f3f4f6;border:2px solid #d1d5db;color:#6b7280;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;">
                        âš™ï¸ Verwalten
                    </button>
                `;
            } else {
                destContainer.style.display = 'none';
            }
        }
        
        // Ort speichern
        function saveLocationPOI(field) {
            const fieldElement = document.getElementById(field);
            const address = fieldElement.value.trim();
            
            if (!address) {
                alert('ğŸ’¾ Bitte erst einen Ort eingeben!');
                fieldElement.focus();
                return;
            }
            
            // Modal fÃ¼r Namen & Icon
            const modal = document.createElement('div');
            modal.id = 'location-save-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;width:100%;max-width:400px;">
                    <h3 style="margin:0 0 15px 0;">â­ Ort speichern</h3>
                    
                    <div style="font-size:13px;color:#666;margin-bottom:10px;">
                        <strong>Adresse:</strong><br>
                        ${address}
                    </div>
                    
                    <div style="margin:15px 0;">
                        <label style="display:block;font-size:12px;color:#666;margin-bottom:5px;font-weight:600;">Name (z.B. "Zuhause", "Arbeit")</label>
                        <input type="text" id="location-name" placeholder="Zuhause" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;box-sizing:border-box;font-size:14px;">
                    </div>
                    
                    <div style="margin:15px 0;">
                        <label style="display:block;font-size:12px;color:#666;margin-bottom:5px;font-weight:600;">Icon auswÃ¤hlen</label>
                        <div id="icon-selector" style="display:flex;flex-wrap:wrap;gap:8px;">
                            ${['ğŸ ', 'ğŸ’¼', 'ğŸš‰', 'ğŸ¨', 'ğŸ½ï¸', 'ğŸ¥', 'âœˆï¸', 'ğŸ–ï¸', 'â›ª', 'ğŸ›ï¸', 'ğŸ­', 'ğŸª', 'ğŸ’’', 'ğŸ“', 'ğŸ‹ï¸'].map(icon => `
                                <button onclick="selectIcon('${icon}')" data-icon="${icon}" 
                                    style="width:44px;height:44px;font-size:24px;border:2px solid #e5e7eb;background:white;border-radius:8px;cursor:pointer;">
                                    ${icon}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button onclick="closeLocationModal()" style="flex:1;padding:12px;background:#e5e7eb;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                            Abbrechen
                        </button>
                        <button onclick="saveLocationConfirm('${address.replace(/'/g, "\\'")}', '${field}')" style="flex:1;padding:12px;background:#f59e0b;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                            ğŸ’¾ Speichern
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('location-name').focus();
            
            // WÃ¤hle erstes Icon automatisch
            window.selectedLocationIcon = 'ğŸ ';
            document.querySelector('[data-icon="ğŸ "]').style.background = '#dbeafe';
            document.querySelector('[data-icon="ğŸ "]').style.borderColor = '#3b82f6';
        }
        
        function selectIcon(icon) {
            window.selectedLocationIcon = icon;
            // Reset alle Icons
            document.querySelectorAll('[data-icon]').forEach(btn => {
                btn.style.background = 'white';
                btn.style.borderColor = '#e5e7eb';
            });
            // Markiere gewÃ¤hltes Icon
            document.querySelector(`[data-icon="${icon}"]`).style.background = '#dbeafe';
            document.querySelector(`[data-icon="${icon}"]`).style.borderColor = '#3b82f6';
        }
        
        function closeLocationModal() {
            // SchlieÃŸe POI-Modals mit ID
            const modalById = document.getElementById('location-save-modal') || document.getElementById('location-manage-modal');
            if (modalById) {
                modalById.remove();
                console.log('âœ… Modal geschlossen (per ID)');
                return;
            }
            
            // Fallback: Suche alle Modals
            const allModals = document.querySelectorAll('[style*="position:fixed"][style*="z-index:9999"]');
            allModals.forEach(modal => {
                if (modal.innerHTML.includes('Ort speichern') || 
                    modal.innerHTML.includes('Orte verwalten') ||
                    modal.innerHTML.includes('Icon auswÃ¤hlen')) {
                    modal.remove();
                    console.log('âœ… Modal geschlossen (per Content-Match)');
                }
            });
        }
        
        function saveLocationConfirm(address, field) {
            const name = document.getElementById('location-name').value.trim();
            
            if (!name) {
                alert('ğŸ’¾ Bitte einen Namen eingeben!');
                return;
            }
            
            const locations = JSON.parse(localStorage.getItem('savedLocations') || '[]');
            
            // PrÃ¼fe ob Ort schon existiert
            if (locations.some(loc => loc.address === address)) {
                alert('âš ï¸ Dieser Ort ist bereits gespeichert!');
                return;
            }
            
            // ğŸ†• v5.26.14h: Hole Koordinaten aus dem entsprechenden Feld!
            let coords = null;
            if (field === 'pickup' && pickupCoords) {
                coords = { lat: pickupCoords.lat, lon: pickupCoords.lon };
            } else if (field === 'destination' && destCoords) {
                coords = { lat: destCoords.lat, lon: destCoords.lon };
            }
            
            // Speichere neuen Ort MIT KOORDINATEN!
            locations.push({
                name,
                address,
                icon: window.selectedLocationIcon || 'ğŸ“',
                createdAt: Date.now(),
                lat: coords ? coords.lat : null,
                lon: coords ? coords.lon : null
            });
            
            localStorage.setItem('savedLocations', JSON.stringify(locations));
            
            console.log('âœ… Ort gespeichert:', { name, address, icon: window.selectedLocationIcon, coords });
            
            closeLocationModal();
            loadSavedLocations();
            
            alert('âœ… Ort gespeichert!\n\n' + window.selectedLocationIcon + ' ' + name + '\n' + address);
        }
        
        function useSavedLocation(field, address, lat, lon) {
            console.log('ğŸ¯ useSavedLocation aufgerufen:', { field, address, lat, lon });
            
            // âœ… Schreibe Adresse ins Feld
            document.getElementById(field).value = address;
            console.log('âœ… Adresse ins Feld geschrieben');
            
            // ğŸ†• v5.45.5: Bessere PrÃ¼fung - auch String "null" abfangen!
            const hasCoords = (lat !== null && lat !== 'null' && lat !== undefined) && 
                            (lon !== null && lon !== 'null' && lon !== undefined);
            
            console.log('ğŸ” Koordinaten-PrÃ¼fung:', { hasCoords, lat, lon });
            
            if (hasCoords) {
                // âœ… KOORDINATEN VORHANDEN
                const coords = { lat: parseFloat(lat), lon: parseFloat(lon) };
                
                // ğŸ¯ v5.45.5: DIREKT SETZEN (wie v5.42.5) + Overlay zeigen!
                if (field === 'pickup') {
                    pickupCoords = coords;
                    pickupConfirmed = true;  // âœ… SOFORT SETZEN!
                    console.log('âœ… Pickup: Koordinaten + confirmed DIREKT gesetzt:', pickupCoords);
                    
                    // ğŸ†• v5.30.0: NUR bei "Sofort" â†’ Taxis laden!
                    if (currentRideType === 'sofort') {
                        const display = document.getElementById('available-taxis-display');
                        if (display) {
                            display.innerHTML = `
                                <div style="padding:20px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:12px;text-align:center;margin-top:10px;">
                                    <div style="font-size:20px;margin-bottom:10px;">ğŸ“</div>
                                    <div style="font-weight:600;font-size:16px;margin-bottom:5px;">Position wird geladen...</div>
                                    <div style="font-size:13px;opacity:0.9;">ğŸ” Suche verfÃ¼gbare Taxis in der NÃ¤he...</div>
                                </div>
                            `;
                            setTimeout(() => { showAvailableTaxis(); }, 1000);
                        }
                    }
                } else {
                    destCoords = coords;
                    destinationConfirmed = true;  // âœ… SOFORT SETZEN!
                    console.log('âœ… Destination: Koordinaten + confirmed DIREKT gesetzt:', destCoords);
                }
                
                // ğŸ¯ DANN Overlay zur BestÃ¤tigung zeigen
                console.log('ğŸ“ Ã–ffne BestÃ¤tigungs-Overlay...');
                showSingleAddressInOverlay(field, address, coords.lat, coords.lon, address);
                
            } else {
                // âš ï¸ KEINE Koordinaten gespeichert - hole sie via Forward Geocoding!
                console.log('âš ï¸ Keine Koordinaten gespeichert - hole via Geocoding:', address);
                
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.length > 0) {
                            const coords = { 
                                lat: parseFloat(data[0].lat), 
                                lon: parseFloat(data[0].lon) 
                            };
                            console.log('âœ… Koordinaten via Geocoding gefunden:', coords);
                            
                            // ğŸ¯ DIREKT SETZEN!
                            if (field === 'pickup') {
                                pickupCoords = coords;
                                pickupConfirmed = true;
                                console.log('âœ… Pickup via Geocoding gesetzt');
                            } else {
                                destCoords = coords;
                                destinationConfirmed = true;
                                console.log('âœ… Destination via Geocoding gesetzt');
                            }
                            
                            // Zeige im Overlay
                            showSingleAddressInOverlay(field, address, coords.lat, coords.lon, address);
                        } else {
                            console.error('ğŸ’¾ Keine Koordinaten gefunden fÃ¼r:', address);
                            alert('âš ï¸ Adresse nicht gefunden!\n\nBitte Favorit neu speichern.');
                        }
                    })
                    .catch(error => {
                        console.error('ğŸ’¾ Geocoding-Fehler:', error);
                        alert('ğŸ’¾ Fehler beim Laden!\n\nBitte Favorit neu speichern.');
                    });
            }
            
            console.log('âœ… Gespeicherter Ort verwendet:', address);
        }
        
        function manageLocations() {
            const locations = JSON.parse(localStorage.getItem('savedLocations') || '[]');
            
            if (locations.length === 0) {
                alert('ğŸ“ Keine gespeicherten Orte vorhanden.');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'location-manage-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;overflow-y:auto;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;width:100%;max-width:400px;max-height:90vh;overflow-y:auto;">
                    <h3 style="margin:0 0 15px 0;">âš™ï¸ Orte verwalten</h3>
                    
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        ${locations.map((loc, index) => `
                            <div style="padding:12px;background:#f9fafb;border-radius:8px;display:flex;justify-content:space-between;align-items:center;">
                                <div style="flex:1;">
                                    <div style="font-weight:600;margin-bottom:4px;">${loc.icon} ${loc.name}</div>
                                    <div style="font-size:12px;color:#666;">${loc.address}</div>
                                </div>
                                <button onclick="deleteSavedLocation(${index})" style="padding:8px 12px;background:#fee2e2;border:2px solid #ef4444;color:#991b1b;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    
                    <button onclick="closeLocationModal()" style="width:100%;margin-top:15px;padding:12px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                        SchlieÃŸen
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function deleteSavedLocation(index) {
            if (!confirm('ğŸ—‘ï¸ Ort wirklich lÃ¶schen?')) return;
            
            const locations = JSON.parse(localStorage.getItem('savedLocations') || '[]');
            locations.splice(index, 1);
            localStorage.setItem('savedLocations', JSON.stringify(locations));
            
            console.log('ğŸ—‘ï¸ Ort gelÃ¶scht');
            
            closeLocationModal();
            loadSavedLocations();
            
            alert('âœ… Ort gelÃ¶scht!');
        }
        
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.27.0: KALENDER-SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let currentCalendarView = 'day'; // ğŸ†• v5.90.64: Start in Tag-Ansicht!
        let currentCalendarDate = new Date(); // Aktuelles Datum im Kalender
        
        function switchCalendarView(view) {
            currentCalendarView = view;
            
            // Update Button-Styling
            ['month', 'week', 'day', 'timeline'].forEach(v => {
                const btn = document.getElementById('cal-' + v + '-btn');
                if (btn) {
                    if (v === view) {
                        if (v === 'timeline') {
                            btn.style.background = '#10b981';
                            btn.style.color = 'white';
                            btn.style.borderColor = '#10b981';
                        } else {
                            btn.style.background = '#667eea';
                            btn.style.color = 'white';
                            btn.style.borderColor = '#667eea';
                        }
                    } else {
                        btn.style.background = 'white';
                        if (v === 'timeline') {
                            btn.style.color = '#10b981';
                            btn.style.borderColor = '#10b981';
                        } else {
                            btn.style.color = '#667eea';
                            btn.style.borderColor = '#667eea';
                        }
                    }
                }
            });
            
            renderCalendar();
        }
        
        function previousPeriod() {
            if (currentCalendarView === 'month') {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            } else if (currentCalendarView === 'week') {
                currentCalendarDate.setDate(currentCalendarDate.getDate() - 7);
            } else {
                currentCalendarDate.setDate(currentCalendarDate.getDate() - 1);
            }
            renderCalendar();
        }
        
        function nextPeriod() {
            if (currentCalendarView === 'month') {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            } else if (currentCalendarView === 'week') {
                currentCalendarDate.setDate(currentCalendarDate.getDate() + 7);
            } else {
                currentCalendarDate.setDate(currentCalendarDate.getDate() + 1);
            }
            renderCalendar();
        }
        
        // ğŸ†• v5.88.27: SPRINGE ZU DATUM
        function jumpToDate(dateStr) {
            if (!dateStr) return;
            const newDate = new Date(dateStr + 'T12:00:00');
            if (isNaN(newDate.getTime())) {
                console.error('ğŸ’¾ UngÃ¼ltiges Datum:', dateStr);
                return;
            }
            currentCalendarDate = newDate;
            console.log('ğŸ“… Springe zu Datum:', dateStr);
            renderCalendar();
            
            // Ã–ffne Kalender falls geschlossen
            const content = document.getElementById('calendar-content');
            if (content && content.style.display === 'none') {
                toggleAdminSection('calendar');
            }
        }
        
        function jumpToToday() {
            currentCalendarDate = new Date();
            const dateInput = document.getElementById('calendar-jump-date');
            if (dateInput) {
                dateInput.value = getLocalDateString();  // ğŸ”§ v5.90.353: LOKAL!
            }
            console.log('ğŸ“… Springe zu Heute');
            
            // Rendere Kalender
            renderCalendar().then(() => {
                // ğŸ†• v5.90.290: Scrolle zur aktuellen/nÃ¤chsten Fahrt!
                setTimeout(() => {
                    scrollToCurrentRide();
                }, 500); // Warte bis Kalender gerendert ist
            });
        }
        
        // ğŸ†• v5.90.290: SCROLLE ZUR AKTUELLEN/NÃ„CHSTEN FAHRT
        function scrollToCurrentRide() {
            const now = Date.now();
            const allRideDivs = document.querySelectorAll('[data-ride-time]');
            
            if (allRideDivs.length === 0) {
                console.log('ğŸ“… Keine Fahrten heute');
                return;
            }
            
            // Finde die nÃ¤chste Fahrt (jetzt oder in der Zukunft)
            let nextRide = null;
            let nextRideTime = Infinity;
            
            allRideDivs.forEach(div => {
                const rideTime = parseInt(div.getAttribute('data-ride-time'));
                
                // Finde die nÃ¤chste Fahrt (entweder aktuell laufend oder in Zukunft)
                if (rideTime >= now - (2 * 60 * 60 * 1000)) { // 2 Stunden Puffer fÃ¼r laufende Fahrten
                    if (rideTime < nextRideTime) {
                        nextRideTime = rideTime;
                        nextRide = div;
                    }
                }
            });
            
            // Fallback: Wenn keine zukÃ¼nftige Fahrt, nimm die letzte Fahrt des Tages
            if (!nextRide && allRideDivs.length > 0) {
                nextRide = allRideDivs[allRideDivs.length - 1];
                console.log('ğŸ“… Keine zukÃ¼nftige Fahrt - scrolle zur letzten Fahrt');
            }
            
            if (nextRide) {
                console.log('ğŸ“… Scrolle zu Fahrt:', nextRide.getAttribute('data-ride-id'));
                
                // Highlight-Effekt
                nextRide.style.transition = 'all 0.5s';
                nextRide.style.background = '#fef3c7'; // Gelb highlighten
                nextRide.style.boxShadow = '0 8px 16px rgba(251, 191, 36, 0.4)';
                
                // Scrolle sanft zur Fahrt
                nextRide.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center'
                });
                
                // Entferne Highlight nach 2 Sekunden
                setTimeout(() => {
                    nextRide.style.background = 'white';
                    nextRide.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                }, 2000);
            }
        }
        
        function getRideColor(status, ride = null) {
            // ğŸ†• v5.77.0: Hotel-Kalender Farbe hat PrioritÃ¤t!
            if (ride && ride.hotelCalendarColor) {
                return ride.hotelCalendarColor;
            }
            
            const statusMap = {
                'completed': '#10b981',      // GrÃ¼n
                'abgeschlossen': '#10b981',
                'cancelled': '#ef4444',      // Rot
                'storniert': '#ef4444',
                'vorbestellt': '#f59e0b',    // Gelb/Orange
                'new': '#f59e0b',
                'accepted': '#3b82f6',       // Blau
                'picked_up': '#3b82f6',
                'akzeptiert': '#3b82f6',
                'unterwegs': '#3b82f6'
            };
            return statusMap[status] || '#9ca3af';
        }
        
        async function renderCalendar() {
            console.log('ğŸ“… Rendere Kalender:', currentCalendarView, currentCalendarDate);
            
            let allRides = [];
            let allVehicles = []; // ğŸ†• v5.52.2: FÃ¼r Fahrzeug-Namen!
            
            // ğŸ”¥ v5.41.0: Admin-Kalender zeigt NUR Firebase!
            // KEIN localStorage-Merge fÃ¼r Admin!
            if (isFirebaseReady && currentUser) {
                try {
                    // ğŸ†• v5.52.2: Lade Fahrzeuge fÃ¼r Name+Kennzeichen
                    const vehiclesSnapshot = await db.ref('vehicles').once('value');
                    if (vehiclesSnapshot.exists()) {
                        vehiclesSnapshot.forEach(child => {
                            const v = child.val();
                            v.id = child.key;
                            allVehicles.push(v);
                        });
                        console.log('ğŸš— Fahrzeuge fÃ¼r Kalender geladen:', allVehicles.length);
                    }
                    
                    // FÃ¼r Admin: Lade ALLE Fahrten aus Firebase (einzige Quelle der Wahrheit!)
                    const snapshot = await db.ref('rides').once('value');
                    if (snapshot.exists()) {
                        const firebaseRides = [];
                        snapshot.forEach(childSnapshot => {
                            const ride = childSnapshot.val();
                            ride.firebaseId = childSnapshot.key;
                            ride.id = ride.id || childSnapshot.key; // Fallback
                            firebaseRides.push(ride);
                        });
                        
                        console.log(`ğŸ“… Kalender: ${firebaseRides.length} Fahrten aus Firebase geladen`);
                        
                        // ğŸ†• v5.49.1: FILTERE STORNIERTE FAHRTEN RAUS!
                        // Nur echte Fahrten zÃ¤hlen fÃ¼r Statistik!
                        // ğŸ†• v5.90.151: SCHEDULED HINZUGEFÃœGT (fÃ¼r AI-Buchungen!)
                        // ğŸ†• v5.90.219: RIDES OHNE STATUS = 'new' (Fix fÃ¼r fehlenden Status!)
                        const validStatuses = ['completed', 'new', 'assigned', 'accepted', 'scheduled', 'vorbestellt', 'in_progress', '']; // '' = kein Status = neue Buchung
                        allRides = firebaseRides.filter(ride => {
                            const status = (ride.status || '').toLowerCase();
                            // Cancelled/Storniert ausschlieÃŸen
                            if (status.includes('cancel') || status.includes('storn')) {
                                return false;
                            }
                            return validStatuses.includes(status);
                        });
                        
                        console.log(`ğŸ“± Schichtplan: ${allRides.length} gÃ¼ltige Fahrten (${firebaseRides.length - allRides.length} stornierte gefiltert)`);
                        
                        // Admin: NUR Firebase! KEIN Merge mit localStorage!
                        
                        console.log('ğŸ“± Admin-Kalender: NUR Firebase-Fahrten:', allRides.length);
                    }
                } catch (e) {
                    console.error('ğŸ’¾ Fehler beim Laden der Firebase-Fahrten:', e);
                }
            }
            
            // ğŸ†• v5.52.2: Mache allVehicles verfÃ¼gbar fÃ¼r render-Funktionen
            window.calendarVehicles = allVehicles;
            
            if (currentCalendarView === 'month') {
                renderMonthView(allRides);
            } else if (currentCalendarView === 'week') {
                renderWeekView(allRides);
            } else if (currentCalendarView === 'timeline') {
                renderVehicleTimeline(allRides);
            } else {
                renderDayView(allRides);
            }
        }
        
        // ğŸ†• v5.29.0: Analysiere Tag und erkenne Hot-Spots
        function analyzeDayCapacity(rides) {
            const total = rides.length;
            
            // Gruppiere nach Stunden
            const hourly = {};
            rides.forEach(r => {
                const timestamp = r.pickupTimestamp || r.createdAt || 0;
                const date = new Date(timestamp);
                const hour = date.getHours();
                if (!hourly[hour]) hourly[hour] = [];
                hourly[hour].push(r);
            });
            
            // Finde Hot Spots (3+ Fahrten zur gleichen Stunde)
            const hotSpots = [];
            Object.keys(hourly).forEach(hour => {
                if (hourly[hour].length >= 3) {
                    hotSpots.push({
                        hour: parseInt(hour),
                        count: hourly[hour].length,
                        level: hourly[hour].length >= 4 ? 'red' : 'yellow'
                    });
                }
            });
            
            // Gesamte Farb-Level Logik
            let level = 'green';
            let bgColor = '#f0fdf4';
            let borderColor = '#86efac';
            let textColor = '#166534';
            let emoji = 'âœ…';
            
            if (total >= 6) {
                level = 'red';
                bgColor = '#fef2f2';
                borderColor = '#fca5a5';
                textColor = '#991b1b';
                emoji = 'ğŸ”¥';
            } else if (total >= 4) {
                level = 'yellow';
                bgColor = '#fef3c7';
                borderColor = '#fcd34d';
                textColor = '#92400e';
                emoji = 'âš ï¸';
            }
            
            return {
                total,
                level,
                bgColor,
                borderColor,
                textColor,
                emoji,
                hotSpots,
                hourly
            };
        }
        
        function renderMonthView(allRides) {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            // Update Titel
            const monthNames = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            document.getElementById('calendar-period-title').textContent = `${monthNames[month]} ${year}`;
            
            // Erster und letzter Tag des Monats
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            // Starte am Montag (0=So, 1=Mo, ...)
            const startDayOfWeek = (firstDay.getDay() + 6) % 7; // Montag = 0
            
            // Gruppiere Fahrten nach Datum
            const ridesByDate = {};
            allRides.forEach(ride => {
                // ğŸ”§ v5.29.1: FÃœR KALENDER: Nutze pickupTimestamp (Abholzeit) statt createdAt!
                const rideDate = new Date(ride.pickupTimestamp || ride.createdAt || 0);
                if (rideDate.getMonth() === month && rideDate.getFullYear() === year) {
                    const day = rideDate.getDate();
                    if (!ridesByDate[day]) ridesByDate[day] = [];
                    ridesByDate[day].push(ride);
                }
            });
            
            // Erstelle Kalender-Grid
            let html = `
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 10px;">
                    <div style="text-align: center; font-weight: 600; padding: 8px; color: #6b7280; font-size: 13px;">Mo</div>
                    <div style="text-align: center; font-weight: 600; padding: 8px; color: #6b7280; font-size: 13px;">Di</div>
                    <div style="text-align: center; font-weight: 600; padding: 8px; color: #6b7280; font-size: 13px;">Mi</div>
                    <div style="text-align: center; font-weight: 600; padding: 8px; color: #6b7280; font-size: 13px;">Do</div>
                    <div style="text-align: center; font-weight: 600; padding: 8px; color: #6b7280; font-size: 13px;">Fr</div>
                    <div style="text-align: center; font-weight: 600; padding: 8px; color: #6b7280; font-size: 13px;">Sa</div>
                    <div style="text-align: center; font-weight: 600; padding: 8px; color: #6b7280; font-size: 13px;">So</div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;">
            `;
            
            // Leere Zellen vor dem 1. des Monats
            for (let i = 0; i < startDayOfWeek; i++) {
                html += `<div style="background: #f9fafb; padding: 12px; border-radius: 6px; min-height: 60px;"></div>`;
            }
            
            // Tage des Monats
            for (let day = 1; day <= daysInMonth; day++) {
                const rides = ridesByDate[day] || [];
                const today = new Date();
                const isToday = (day === today.getDate() && month === today.getMonth() && year === today.getFullYear());
                
                // ğŸ†• v5.29.0: Hot-Spot Analyse
                const analysis = analyzeDayCapacity(rides);
                
                // Farbige Punkte fÃ¼r Status
                let statusDots = '';
                const statusCounts = {};
                rides.forEach(r => {
                    const color = getRideColor(r.status, r);
                    statusCounts[color] = (statusCounts[color] || 0) + 1;
                });
                
                Object.entries(statusCounts).forEach(([color, count]) => {
                    statusDots += `<div style="width: 6px; height: 6px; background: ${color}; border-radius: 50%; display: inline-block; margin: 0 1px;" title="${count} Fahrten"></div>`;
                });
                
                // ğŸ†• v5.29.0: Hot-Spot Indikator
                let hotSpotBadge = '';
                if (analysis.hotSpots.length > 0) {
                    const worst = analysis.hotSpots.reduce((a, b) => a.count > b.count ? a : b);
                    hotSpotBadge = `
                        <div style="background:${worst.level === 'red' ? '#fca5a5' : '#fcd34d'};color:#1f2937;font-size:10px;font-weight:700;padding:2px 4px;border-radius:4px;margin-top:2px;">
                            ğŸ”¥ ${worst.hour}:00
                        </div>
                    `;
                }
                
                html += `
                    <div onclick="showDayDetails(${day}, ${month}, ${year})" style="
                        background: ${isToday ? '#dbeafe' : (rides.length > 0 ? analysis.bgColor : 'white')};
                        border: 2px solid ${isToday ? '#3b82f6' : (rides.length > 0 ? analysis.borderColor : '#e5e7eb')};
                        padding: 8px;
                        border-radius: 6px;
                        min-height: 70px;
                        cursor: ${rides.length > 0 ? 'pointer' : 'default'};
                        transition: all 0.2s;
                        position: relative;
                    " ${rides.length > 0 ? 'onmouseenter="this.style.transform=\'scale(1.02)\'" onmouseleave="this.style.transform=\'scale(1)\'"' : ''}>
                        <div style="font-weight: ${isToday ? '700' : '600'}; color: ${isToday ? '#1e40af' : (rides.length > 0 ? analysis.textColor : '#374151')}; margin-bottom: 4px; font-size: 14px;">
                            ${day} ${rides.length > 0 ? analysis.emoji : ''}
                        </div>
                        ${rides.length > 0 ? `
                            <div style="font-size: 12px; color: ${analysis.textColor}; font-weight: 600; margin-bottom: 4px;">
                                ${rides.length} Fahrt${rides.length > 1 ? 'en' : ''}
                            </div>
                            <div style="text-align: center; margin-bottom: 2px;">${statusDots}</div>
                            ${hotSpotBadge}
                        ` : ''}
                    </div>
                `;
            }
            
            html += `</div>`;
            
            document.getElementById('calendar-container').innerHTML = html;
            
            // Statistik
            updateCalendarStats(allRides, 'Monat');
        }
        
        function renderWeekView(allRides) {
            // Aktueller Montag
            const current = new Date(currentCalendarDate);
            const day = current.getDay();
            const diff = current.getDate() - day + (day === 0 ? -6 : 1); // Montag
            const monday = new Date(current.setDate(diff));
            
            // Update Titel
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            const monthNames = ['Jan', 'Feb', 'MÃ¤r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
            document.getElementById('calendar-period-title').textContent = 
                `${monday.getDate()}. ${monthNames[monday.getMonth()]} - ${sunday.getDate()}. ${monthNames[sunday.getMonth()]} ${sunday.getFullYear()}`;
            
            // Gruppiere Fahrten nach Tag
            const ridesByDay = {};
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                // ğŸ”§ v5.30.6: LOKALE ZEIT statt UTC (konsistent mit MonthView/DayView)
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                ridesByDay[key] = {
                    date: new Date(date),
                    rides: []
                };
            }
            
            allRides.forEach(ride => {
                // ğŸ”§ v5.29.1: FÃœR KALENDER: Nutze pickupTimestamp (Abholzeit) statt createdAt!
                const rideDate = new Date(ride.pickupTimestamp || ride.createdAt || 0);
                // ğŸ”§ v5.30.6: LOKALE ZEIT statt UTC (konsistent mit MonthView/DayView)
                const key = `${rideDate.getFullYear()}-${String(rideDate.getMonth() + 1).padStart(2, '0')}-${String(rideDate.getDate()).padStart(2, '0')}`;
                if (ridesByDay[key]) {
                    ridesByDay[key].rides.push(ride);
                }
            });
            
            // Erstelle Wochenansicht
            let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
            
            const dayNames = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];
            Object.entries(ridesByDay).forEach(([key, data], index) => {
                const rides = data.rides;
                const date = data.date;
                const today = new Date();
                const isToday = date.toDateString() === today.toDateString();
                
                html += `
                    <div onclick="showDayDetails(${date.getDate()}, ${date.getMonth()}, ${date.getFullYear()})" style="
                        background: ${isToday ? '#dbeafe' : 'white'};
                        border: ${isToday ? '2px solid #3b82f6' : '1px solid #e5e7eb'};
                        padding: 15px;
                        border-radius: 8px;
                        cursor: pointer;
                        transition: all 0.2s;
                    " onmouseenter="this.style.background='#f0f9ff'" onmouseleave="this.style.background='${isToday ? '#dbeafe' : 'white'}'">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div>
                                <div style="font-weight: 700; font-size: 16px; color: #1f2937;">${dayNames[index]}</div>
                                <div style="font-size: 13px; color: #6b7280;">${date.getDate()}. ${monthNames[date.getMonth()]}</div>
                            </div>
                            <div style="font-size: 20px; font-weight: 700; color: #667eea;">
                                ${rides.length}
                            </div>
                        </div>
                        ${rides.length > 0 ? `
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                ${rides.map(r => `
                                    <div style="display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: ${getRideColor(r.status, r)}20; border-radius: 4px;">
                                        <div style="width: 8px; height: 8px; background: ${getRideColor(r.status, r)}; border-radius: 50%;"></div>
                                        <span style="font-size: 12px; color: #374151;">${r.price || 0}â‚¬</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<div style="font-size: 13px; color: #9ca3af;">Keine Fahrten</div>'}
                    </div>
                `;
            });
            
            html += '</div>';
            
            document.getElementById('calendar-container').innerHTML = html;
            updateCalendarStats(Object.values(ridesByDay).flatMap(d => d.rides), 'Woche');
        }
        
        function renderDayView(allRides) {
            const date = new Date(currentCalendarDate);
            
            // Update Titel
            const dayNames = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
            const monthNames = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            document.getElementById('calendar-period-title').textContent = 
                `${dayNames[date.getDay()]}, ${date.getDate()}. ${monthNames[date.getMonth()]} ${date.getFullYear()}`;
            
            // Filtere Fahrten fÃ¼r diesen Tag
            const dayRides = allRides.filter(ride => {
                // ğŸ”§ v5.29.1: FÃœR KALENDER: Nutze pickupTimestamp (Abholzeit) statt createdAt!
                const rideDate = new Date(ride.pickupTimestamp || ride.createdAt || 0);
                return rideDate.toDateString() === date.toDateString();
            }).sort((a, b) => {
                // ğŸ”§ v5.29.1: Sortiere nach Abholzeit
                const timeA = a.pickupTimestamp || a.createdAt || 0;
                const timeB = b.pickupTimestamp || b.createdAt || 0;
                return timeA - timeB;
            });
            
            // ğŸ†• v5.29.0: Analysiere Tag
            const analysis = analyzeDayCapacity(dayRides);
            
            // Erstelle Tagesansicht
            let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';
            
            // ğŸ†• v5.69.0: Quick-Booking Box ZUERST (oben)!
            const today = new Date(currentCalendarDate);
            const dateStr = getLocalDateString(today);  // ğŸ”§ v5.90.353: LOKAL!
            
            html += `
                <div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; box-shadow: 0 4px 12px rgba(102,126,234,0.3);">
                    <div style="color:white;font-weight:700;font-size:16px;margin-bottom:15px;display:flex;align-items:center;gap:8px;">
                        âš¡ Neue Fahrt buchen
                    </div>
                    
                    <!-- Datum + Zeit Auswahl -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
                        <div>
                            <label style="display:block;font-size:11px;color:rgba(255,255,255,0.8);margin-bottom:6px;font-weight:600;">ğŸ“… Datum</label>
                            <input type="date" id="admin-quick-date" value="${dateStr}" 
                                onchange="updateAdminQuickWeekday()"
                                style="width:100%;padding:12px;border:none;border-radius:10px;font-size:14px;font-weight:600;">
                        </div>
                        <div>
                            <label style="display:block;font-size:11px;color:rgba(255,255,255,0.8);margin-bottom:6px;font-weight:600;">â° Uhrzeit</label>
                            <input type="time" id="admin-quick-time" value="09:00"
                                style="width:100%;padding:12px;border:none;border-radius:10px;font-size:14px;font-weight:600;">
                        </div>
                    </div>
                    
                    <!-- Wochentag-Anzeige (unsichtbar fÃ¼r updateAdminQuickWeekday) -->
                    <div id="admin-quick-weekday" style="display:none;"></div>
                    
                    <!-- Button -->
                    <button onclick="openQuickBookingFromAdmin()" style="
                        width:100%;
                        padding:14px;
                        background:white;
                        color:#667eea;
                        border:none;
                        border-radius:10px;
                        font-weight:700;
                        cursor:pointer;
                        font-size:15px;
                        box-shadow:0 2px 8px rgba(0,0,0,0.1);
                        transition:all 0.2s;
                    " onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                        ğŸš€ Schnellbuchung Ã¶ffnen
                    </button>
                </div>
            `;
            
            if (dayRides.length === 0) {
                html += `
                    <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“…</div>
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 5px;">Keine Fahrten</div>
                        <div style="font-size: 14px;">An diesem Tag gab es keine Fahrten</div>
                    </div>
                `;
            } else {
                // ğŸ†• v5.29.0: ZEITFENSTER-ÃœBERSICHT
                html += `
                    <div style="background:${analysis.bgColor};border:2px solid ${analysis.borderColor};padding:20px;border-radius:12px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                            <div>
                                <div style="font-size:28px;margin-bottom:5px;">${analysis.emoji}</div>
                                <div style="font-weight:700;font-size:20px;color:${analysis.textColor};">
                                    ${dayRides.length} Fahrt${dayRides.length > 1 ? 'en' : ''}
                                </div>
                                <div style="font-size:13px;color:${analysis.textColor};opacity:0.8;">
                                    ${analysis.level === 'red' ? 'VIELE FAHRTEN!' : (analysis.level === 'yellow' ? 'KÃ¶nnte eng werden' : 'Entspannte Auslastung')}
                                </div>
                            </div>
                        </div>
                        
                        ${analysis.hotSpots.length > 0 ? `
                            <div style="background:white;padding:12px;border-radius:8px;margin-top:15px;">
                                <div style="font-weight:600;font-size:14px;color:#991b1b;margin-bottom:10px;">
                                    âš ï¸ Hot-Spots erkannt:
                                </div>
                                ${analysis.hotSpots.map(hs => `
                                    <div style="padding:8px;background:${hs.level === 'red' ? '#fef2f2' : '#fef3c7'};border-radius:6px;margin-bottom:6px;">
                                        <div style="font-weight:600;color:#1f2937;">
                                            ğŸ”¥ ${hs.hour}:00 Uhr - ${hs.count} Fahrten
                                        </div>
                                        <div style="font-size:12px;color:#6b7280;margin-top:2px;">
                                            ${hs.level === 'red' ? 'Sehr hohe Auslastung!' : 'ErhÃ¶hte Auslastung'}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <!-- ZEITFENSTER-BALKEN -->
                        <div style="margin-top:15px;">
                            <div style="font-weight:600;font-size:13px;color:${analysis.textColor};margin-bottom:10px;">
                                ğŸ“± Zeitliche Verteilung:
                            </div>
                            ${Object.keys(analysis.hourly).sort((a, b) => a - b).map(hour => {
                                const count = analysis.hourly[hour].length;
                                const percent = Math.round((count / dayRides.length) * 100);
                                const barColor = count >= 4 ? '#ef4444' : (count >= 3 ? '#f59e0b' : '#10b981');
                                
                                return `
                                    <div style="margin-bottom:8px;">
                                        <div style="display:flex;justify-content:space-between;font-size:12px;color:#4b5563;margin-bottom:4px;">
                                            <span>${hour}:00 - ${parseInt(hour)+1}:00</span>
                                            <span style="font-weight:600;">${count} Fahrt${count > 1 ? 'en' : ''} (${percent}%)</span>
                                        </div>
                                        <div style="background:#e5e7eb;height:8px;border-radius:4px;overflow:hidden;">
                                            <div style="background:${barColor};height:100%;width:${percent}%;transition:width 0.3s;"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
                
                // FAHRT-LISTE
                html += '<div style="font-weight:600;font-size:15px;color:#1f2937;padding:0 5px 10px 5px;">ğŸ“‹ Alle Fahrten:</div>';
                
                dayRides.forEach(ride => {
                    // ğŸ”§ v5.29.1: FÃœR KALENDER: Zeige Abholzeit, nicht Buchungszeit!
                    const time = new Date(ride.pickupTimestamp || ride.createdAt || 0);
                    const timeStr = time.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    const color = getRideColor(ride.status, ride);
                    
                    const statusText = {
                        'completed': 'Abgeschlossen',
                        'abgeschlossen': 'Abgeschlossen',
                        'cancelled': 'Storniert',
                        'storniert': 'Storniert',
                        'vorbestellt': 'Vorbestellt',
                        'new': 'Neu',
                        'accepted': 'Akzeptiert',
                        'picked_up': 'Unterwegs'
                    }[ride.status] || ride.status;
                    
                    html += `
                        <div data-ride-time="${ride.pickupTimestamp || ride.createdAt || 0}" 
                             data-ride-id="${ride.firebaseId || ride.id}"
                             style="
                            background: white;
                            border-left: 4px solid ${color};
                            padding: 15px;
                            border-radius: 8px;
                            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                            transition: all 0.2s;
                        " onmouseenter="this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'" onmouseleave="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">>
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div style="font-weight: 700; font-size: 18px; color: ${color};">${timeStr}</div>
                                <div style="padding: 4px 10px; background: ${color}20; color: ${color}; border-radius: 6px; font-size: 12px; font-weight: 600;">
                                    ${statusText}
                                </div>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <div style="font-size: 13px; color: #6b7280; margin-bottom: 2px;">ğŸ“ Von:</div>
                                <div style="font-weight: 600; color: #1f2937;">${ride.pickup || 'Unbekannt'}</div>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <div style="font-size: 13px; color: #6b7280; margin-bottom: 2px;">ğŸ¯ Nach:</div>
                                <div style="font-weight: 600; color: #1f2937;">${ride.destination || 'Unbekannt'}</div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid #e5e7eb;">
                                <div style="display:flex;flex-direction:column;gap:4px;">
                                    ${ride.customerName ? `<div style="font-size: 13px; color: #6b7280;">ğŸ’¾ ${ride.customerName}</div>` : '<div></div>'}
                                    ${(() => {
                                        // ğŸ†• v5.90.525: FAHRTDAUER ANZEIGEN!
                                        let durationMin = 30; // Fallback
                                        if (ride.duration) {
                                            durationMin = parseInt(ride.duration);
                                        } else if (ride.distance) {
                                            durationMin = Math.ceil(parseFloat(ride.distance) * 1.5);
                                        } else if (ride.price) {
                                            durationMin = Math.max(10, Math.round(parseFloat(ride.price) * 0.75));
                                        }
                                        
                                        const pickupTime = new Date(ride.pickupTimestamp || ride.createdAt || 0);
                                        const freeTime = new Date(pickupTime.getTime() + durationMin * 60000);
                                        const freeTimeStr = freeTime.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                                        
                                        return `<div style="font-size: 12px; color: #10b981; font-weight: 600;">
                                            â±ï¸ ~${durationMin} Min â†’ Frei ab ${freeTimeStr}
                                        </div>`;
                                    })()}
                                </div>
                                <div style="font-weight: 700; font-size: 16px; color: #667eea;">ğŸ’° ${ride.price || 0}â‚¬</div>
                            </div>
                            
                            ${ride.invoiceNumber ? `
                                <div style="margin-top: 8px; padding: 10px 12px; background: #d1fae5; border-left: 3px solid #10b981; border-radius: 6px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 12px; color: #048257; font-weight: 600;">
                                            ğŸ“± Rechnung: ${ride.invoiceNumber}${ride.invoiceAmount ? ' Â· ' + ride.invoiceAmount.toFixed(2) + 'â‚¬' : ''}
                                        </span>
                                        <button onclick="event.stopPropagation(); shareRideInvoiceViaWhatsApp('${ride.firebaseId || ride.id}')" 
                                                style="padding: 4px 10px; background: #25D366; color: white; border: none; border-radius: 4px; font-size: 11px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                            ğŸ“¤ WhatsApp
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${(() => {
                                // ğŸ†• v5.52.2: FAHRZEUG MIT NAME + KENNZEICHEN!
                                let vehicleHtml = '';
                                
                                if (ride.vehicleId || ride.assignedVehicle) {
                                    // Fahrzeug ist zugewiesen
                                    const vehicleId = ride.vehicleId || ride.assignedVehicle;
                                    
                                    // ğŸ†• v5.52.2: Lade Fahrzeug-Details aus vehicles
                                    let vehicleDisplay = vehicleId;
                                    const vehicle = (window.calendarVehicles || []).find(v => v.id === vehicleId);
                                    if (vehicle) {
                                        vehicleDisplay = `${vehicle.name || vehicleId}${vehicle.plate ? ` (${vehicle.plate})` : ''}`;
                                    }
                                    
                                    vehicleHtml = `
                                        <div style="margin-top: 10px; padding: 8px 12px; background: #d1fae5; border: 2px solid #10b981; border-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <div style="font-size: 18px;">ğŸš—</div>
                                                <div>
                                                    <div style="font-weight: 600; font-size: 13px; color: #048257;">${vehicleDisplay}</div>
                                                    ${ride.driverName ? `<div style="font-size: 11px; color: #059669;">ğŸ’¾ ${ride.driverName}</div>` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                } else if (ride.status === 'vorbestellt' || ride.status === 'new' || ride.status === 'pending') {
                                    // Keine Zuweisung - Button anzeigen
                                    vehicleHtml = `
                                        <div style="margin-top: 10px; padding: 8px 12px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <div style="font-size: 16px;">âš ï¸</div>
                                                <div style="font-weight: 600; font-size: 12px; color: #92400e;">Nicht zugewiesen</div>
                                            </div>
                                            <button onclick="event.stopPropagation(); openVehicleAssignmentModal('${ride.firebaseId || ride.id}')" 
                                                    style="padding: 6px 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                                                ğŸš• Zuweisen
                                            </button>
                                        </div>
                                    `;
                                }
                                
                                return vehicleHtml;
                            })()}
                            
                            ${(() => {
                                // ğŸ†• v5.90.48: MAP-NULL-CHECK-FIX-LINK ANZEIGEN!
                                // Link wird jetzt IMMER sofort erstellt bei Fahrzeug-Zuweisung
                                if (ride.trackingLink) {
                                    return `
                                        <div style="margin-top: 10px; padding: 12px; background: #dcfce7; border: 2px solid #10b981; border-radius: 8px;">
                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                                <div style="font-size: 18px;">ğŸ“</div>
                                                <div style="font-weight: 600; font-size: 13px; color: #048257;">Live-Tracking verfÃ¼gbar</div>
                                            </div>
                                            <div style="display: flex; gap: 6px;">
                                                <a href="${ride.trackingLink}" target="_blank" 
                                                   style="flex: 1; padding: 8px 12px; background: #10b981; color: white; text-align: center; border-radius: 6px; font-size: 12px; font-weight: 600; text-decoration: none; display: block;"
                                                   onclick="event.stopPropagation();">
                                                    ğŸš• Taxi Tracken
                                                </a>
                                                <button onclick="event.stopPropagation(); navigator.clipboard.writeText('${ride.trackingLink}'); alert('âœ… Link kopiert!');" 
                                                        style="padding: 8px 12px; background: #059669; color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">
                                                    ğŸ“‹ Link kopieren
                                                </button>
                                            </div>
                                            <div style="font-size: 10px; color: #059669; margin-top: 6px; word-break: break-all;">${ride.trackingLink}</div>
                                        </div>
                                    `;
                                } else if (ride.vehicleId || ride.assignedVehicle) {
                                    // Fahrzeug zugewiesen aber noch kein Link
                                    return `
                                        <div style="margin-top: 10px; padding: 12px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px;">
                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                                                <div style="font-size: 18px;">â°</div>
                                                <div style="font-weight: 600; font-size: 12px; color: #92400e;">
                                                    Tracking-Link wird erstellt...
                                                </div>
                                            </div>
                                            <button onclick="event.stopPropagation(); createSingleTrackingLink('${ride.firebaseId || ride.id}', '${ride.vehicleId || ride.assignedVehicle}')" 
                                                    style="width: 100%; padding: 10px; background: #f59e0b; color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                                    onmouseover="this.style.background='#d97706'" onmouseout="this.style.background='#f59e0b'">
                                                ğŸ”— Jetzt Link erstellen
                                            </button>
                                        </div>
                                    `;
                                }
                                return '';
                            })()}
                            
                            <!-- ğŸ†• BEARBEITEN/RECHNUNG/KOPIEREN/LÃ–SCHEN Buttons -->
                            <div style="margin-top: 10px; display: flex; gap: 6px; justify-content: flex-end; padding-top: 8px; border-top: 1px solid #e5e7eb; flex-wrap: wrap;">
                                <button onclick="event.stopPropagation(); editRide('${ride.firebaseId || ride.id}')" 
                                        style="padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                        onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                                    âœï¸ Bearbeiten
                                </button>
                                
                                <!-- ğŸ†• v5.90.149: CRM BUTTON IM KALENDER! -->
                                <button onclick="event.stopPropagation(); openCustomerEditFromCalendar('${ride.customerId || ''}', '${(ride.customerName || '').replace(/'/g, "\\'")}', '${ride.firebaseId || ride.id}')" 
                                        style="padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                        onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                                    ğŸ’¾ CRM
                                </button>
                                
                                ${ride.status !== 'completed' && ride.status !== 'abgeschlossen' && ride.status !== 'cancelled' && ride.status !== 'storniert' ? `
                                <button onclick="event.stopPropagation(); completeRideWithPrice('${ride.firebaseId || ride.id}')" 
                                        style="padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                        onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                                    âœ… AbschlieÃŸen
                                </button>
                                ` : ''}
                                <button onclick="event.stopPropagation(); openInvoiceModal('${ride.firebaseId || ride.id}')" 
                                        style="padding: 6px 12px; background: #8b5cf6; color: white; border: none; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                        onmouseover="this.style.background='#7c3aed'" onmouseout="this.style.background='#8b5cf6'">
                                    ğŸ“± Rechnung
                                </button>
                                <button onclick="event.stopPropagation(); openNoShowInvoiceModal('${ride.firebaseId || ride.id}')" 
                                        style="padding: 6px 12px; background: ${ride.status === 'abgesagt' || ride.status === 'nicht erschienen' ? '#f59e0b' : '#6b7280'}; color: white; border: none; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                        onmouseover="this.style.background='${ride.status === 'abgesagt' || ride.status === 'nicht erschienen' ? '#d97706' : '#4b5563'}'" onmouseout="this.style.background='${ride.status === 'abgesagt' || ride.status === 'nicht erschienen' ? '#f59e0b' : '#6b7280'}'">
                                    ğŸ“ NoShow
                                </button>
                                <button onclick="event.stopPropagation(); copyRideFromCalendar('${ride.firebaseId || ride.id}')" 
                                        style="padding: 6px 12px; background: #8b5cf6; color: white; border: none; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                        onmouseover="this.style.background='#7c3aed'" onmouseout="this.style.background='#8b5cf6'">
                                    ğŸ“‹ Kopieren
                                </button>
                                <button onclick="event.stopPropagation(); deleteRideFromCalendar('${ride.firebaseId || ride.id}')" 
                                        style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                        onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                                    ğŸ—‘ï¸ LÃ¶schen
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            
            
            html += '</div>';
            
            document.getElementById('calendar-container').innerHTML = html;
            updateCalendarStats(dayRides, 'Tag');
        }
        
        // ğŸ†• v5.67.0: Wochentag fÃ¼r Admin Quick Booking aktualisieren
        function updateAdminQuickWeekday() {
            const dateInput = document.getElementById('admin-quick-date');
            const weekdayDisplay = document.getElementById('admin-quick-weekday');
            
            if (!dateInput || !weekdayDisplay) return;
            
            const dateValue = dateInput.value;
            if (!dateValue) return;
            
            const date = new Date(dateValue + 'T12:00:00');
            const weekdays = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
            const months = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            
            const weekday = weekdays[date.getDay()];
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            
            weekdayDisplay.innerHTML = `<strong>${weekday}</strong>, ${day}. ${month} ${year}`;
        }
        
        // ğŸ†• v5.67.0: Schnellbuchung aus Admin-Bereich Ã¶ffnen
        function openQuickBookingFromAdmin() {
            const dateInput = document.getElementById('admin-quick-date');
            const timeInput = document.getElementById('admin-quick-time');
            
            if (!dateInput || !timeInput) {
                console.error('ğŸ’¾ Datum/Zeit Felder nicht gefunden!');
                return;
            }
            
            const dateValue = dateInput.value;
            const timeValue = timeInput.value;
            
            if (!dateValue || !timeValue) {
                alert('ğŸ’¾ Bitte Datum und Uhrzeit auswÃ¤hlen!');
                return;
            }
            
            // Kombiniere zu ISO-String
            const datetime = `${dateValue}T${timeValue}:00`;
            const date = new Date(datetime);
            
            console.log('âš¡ Ã–ffne Schnellbuchung fÃ¼r:', datetime);
            
            // Nutze bestehende Funktion
            setQuickBookingPanelTime(date.toISOString());
        }
        
        function updateCalendarStats(rides, period) {
            const completed = rides.filter(r => r.status === 'completed' || r.status === 'abgeschlossen');
            const cancelled = rides.filter(r => r.status === 'cancelled' || r.status === 'storniert');
            
            // ğŸ”§ v5.29.2: FIX - Stelle sicher dass totalRevenue eine Zahl ist!
            const totalRevenue = completed.reduce((sum, r) => {
                const price = parseFloat(r.price) || 0;
                return sum + price;
            }, 0);
            
            document.getElementById('calendar-stats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div>
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">${period} - Gesamt</div>
                        <div style="font-size: 24px; font-weight: 700;">${rides.length}</div>
                        <div style="font-size: 12px; opacity: 0.8;">Fahrten</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">Umsatz</div>
                        <div style="font-size: 24px; font-weight: 700;">${totalRevenue.toFixed(2)}â‚¬</div>
                        <div style="font-size: 12px; opacity: 0.8;">${completed.length} abgeschlossen</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">âœ… Erfolgreich</div>
                        <div style="font-size: 20px; font-weight: 700;">${completed.length}</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">ğŸ’¾ Storniert</div>
                        <div style="font-size: 20px; font-weight: 700;">${cancelled.length}</div>
                    </div>
                </div>
            `;
        }
        
        function showDayDetails(day, month, year) {
            currentCalendarDate = new Date(year, month, day);
            currentCalendarView = 'day';
            switchCalendarView('day');
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸš—â±ï¸ v5.32.5: FAHRZEUG-TIMELINE MIT ÃœBERLAPPUNGS-ERKENNUNG
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function renderVehicleTimeline(allRides) {
            const date = new Date(currentCalendarDate);
            
            // Update Titel
            const dayNames = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
            const monthNames = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            document.getElementById('calendar-period-title').textContent = 
                `Timeline: ${dayNames[date.getDay()]}, ${date.getDate()}. ${monthNames[date.getMonth()]} ${date.getFullYear()}`;
            
            // Filtere Fahrten fÃ¼r diesen Tag
            const dayRides = allRides.filter(ride => {
                const rideDate = new Date(ride.pickupTimestamp || ride.createdAt || 0);
                const isSameDay = rideDate.toDateString() === date.toDateString();
                
                // ğŸ†• v5.32.5c: NUR AKTIVE FAHRTEN in Timeline!
                const activeStatuses = ['new', 'accepted', 'picked_up', 'assigned', 'vorbestellt'];
                const isActive = activeStatuses.includes(ride.status);
                
                return isSameDay && isActive;
            }).sort((a, b) => {
                const timeA = a.pickupTimestamp || a.createdAt || 0;
                const timeB = b.pickupTimestamp || b.createdAt || 0;
                return timeA - timeB;
            });
            
            // Gruppiere Fahrten nach Fahrzeug
            const vehicleRides = {};
            dayRides.forEach(ride => {
                const vehicleId = ride.vehicleId || ride.assignedVehicle || 'Nicht zugewiesen';
                if (!vehicleRides[vehicleId]) {
                    vehicleRides[vehicleId] = [];
                }
                vehicleRides[vehicleId].push(ride);
            });
            
            let html = '<div style="display: flex; flex-direction: column; gap: 20px;">';
            
            // Header mit Infos
            html += `
                <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(16,185,129,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <div style="font-size: 28px; margin-bottom: 8px;">ğŸš—â±ï¸</div>
                            <div style="font-weight: 700; font-size: 22px; margin-bottom: 6px;">Fahrzeug-Timeline</div>
                            <div style="font-size: 14px; opacity: 0.95;">
                                Ãœbersicht: Fahrzeuge, Zeitfenster & Ãœberlappungen
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 32px; font-weight: 700; margin-bottom: 4px;">
                                ${Object.keys(vehicleRides).length}
                            </div>
                            <div style="font-size: 13px; opacity: 0.9;">
                                Fahrzeug${Object.keys(vehicleRides).length !== 1 ? 'e' : ''} im Einsatz
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ğŸ†• v5.32.5c: Info - Nur aktive Fahrten
            html += `
                <div style="background: #dbeafe; border: 2px solid #3b82f6; padding: 12px 16px; border-radius: 10px; display: flex; align-items: center; gap: 12px;">
                    <div style="font-size: 20px;">â„¹ï¸</div>
                    <div style="font-size: 13px; color: #1e40af;">
                        <strong>Timeline zeigt nur aktive Fahrten:</strong> Neu, Akzeptiert, Unterwegs, Zugewiesen, Vorbestellt
                        <br>
                        <span style="font-size: 12px; opacity: 0.8;">Abgeschlossene und stornierte Fahrten werden nicht angezeigt.</span>
                    </div>
                </div>
            `;
            
            if (dayRides.length === 0) {
                html += `
                    <div style="text-align: center; padding: 80px 20px; color: #9ca3af;">
                        <div style="font-size: 64px; margin-bottom: 15px;">ğŸ“…</div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #6b7280;">
                            Keine aktiven Fahrten an diesem Tag
                        </div>
                        <div style="font-size: 14px;">
                            WÃ¤hle einen anderen Tag oder prÃ¼fe abgeschlossene Fahrten in der Tagesansicht
                        </div>
                    </div>
                `;
            } else {
                // Legende
                html += `
                    <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #e5e7eb;">
                        <div style="font-weight: 700; font-size: 14px; color: #1f2937; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 18px;">ğŸ“±</span>
                            <span>Legende</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 13px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 30px; height: 12px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 3px;"></div>
                                <span>Fahrt aktiv</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 30px; height: 12px; background: #d1d5db; border-radius: 3px;"></div>
                                <span>Freie Zeit</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 30px; height: 12px; background: repeating-linear-gradient(45deg, #ef4444, #ef4444 10px, #fca5a5 10px, #fca5a5 20px); border-radius: 3px;"></div>
                                <span>âš ï¸ Ãœberlappung!</span>
                            </div>
                        </div>
                    </div>
                `;
                
                // Timeline fÃ¼r jedes Fahrzeug
                Object.keys(vehicleRides).sort().forEach(vehicleId => {
                    const rides = vehicleRides[vehicleId];
                    
                    // Erkenne Ãœberlappungen fÃ¼r dieses Fahrzeug
                    const conflicts = detectTimeConflicts(rides);
                    
                    html += `
                        <div style="background: white; border: 2px solid ${vehicleId === 'Nicht zugewiesen' ? '#f59e0b' : '#10b981'}; border-radius: 12px; padding: 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #f3f4f6;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="font-size: 32px;">${vehicleId === 'Nicht zugewiesen' ? 'âš ï¸' : 'ğŸš—'}</div>
                                    <div>
                                        <div style="font-weight: 700; font-size: 18px; color: #1f2937;">
                                            ${vehicleId}
                                        </div>
                                        <div style="font-size: 13px; color: #6b7280;">
                                            ${rides.length} Fahrt${rides.length !== 1 ? 'en' : ''} heute
                                        </div>
                                    </div>
                                </div>
                                ${conflicts.length > 0 ? `
                                    <div style="background: #fef2f2; border: 2px solid #ef4444; padding: 8px 12px; border-radius: 8px;">
                                        <div style="font-weight: 700; font-size: 14px; color: #991b1b;">
                                            âš ï¸ ${conflicts.length} Konflikt${conflicts.length !== 1 ? 'e' : ''}!
                                        </div>
                                    </div>
                                ` : `
                                    <div style="background: #f0fdf4; border: 2px solid #10b981; padding: 8px 12px; border-radius: 8px;">
                                        <div style="font-weight: 600; font-size: 13px; color: #048257;">
                                            âœ… Keine Konflikte
                                        </div>
                                    </div>
                                `}
                            </div>
                            
                            <!-- Timeline-Balken -->
                            <div style="margin-bottom: 16px;">
                                ${generateTimelineBar(rides, conflicts)}
                            </div>
                            
                            <!-- Fahrten-Liste -->
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                ${rides.map((ride, idx) => {
                                    const time = new Date(ride.pickupTimestamp || ride.createdAt || 0);
                                    const timeStr = time.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                                    const isConflict = conflicts.some(c => c.includes(idx));
                                    
                                    // ğŸ†• v5.90.525: NUTZE ECHTE DURATION AUS FIREBASE!
                                    // Nicht mehr: price Ã— 2 (war falsch!)
                                    let estimatedMinutes = 30; // Fallback
                                    
                                    if (ride.duration) {
                                        // 1. PrioritÃ¤t: Gespeicherte Duration
                                        estimatedMinutes = parseInt(ride.duration);
                                    } else if (ride.distance) {
                                        // 2. PrioritÃ¤t: Berechnung aus Distanz (1 km â‰ˆ 1.5 Min)
                                        estimatedMinutes = Math.ceil(parseFloat(ride.distance) * 1.5);
                                    } else if (ride.price) {
                                        // 3. Fallback: SchÃ¤tzung aus Preis (aber realistisch!)
                                        // Annahme: 2â‚¬/km, 40km/h â†’ 1â‚¬ â‰ˆ 0.75 Min
                                        const price = parseFloat(ride.price);
                                        estimatedMinutes = Math.max(10, Math.round(price * 0.75));
                                    }
                                    
                                    const endTime = new Date(time.getTime() + estimatedMinutes * 60000);
                                    const endTimeStr = endTime.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                                    
                                    return `
                                        <div onclick="viewRideDetails('${ride.firebaseId || ride.id}')" style="
                                            background: ${isConflict ? 'linear-gradient(135deg, #fef2f2, #fee2e2)' : '#f9fafb'};
                                            border-left: 4px solid ${isConflict ? '#ef4444' : '#10b981'};
                                            padding: 12px 14px;
                                            border-radius: 8px;
                                            cursor: pointer;
                                            transition: all 0.2s;
                                            ${isConflict ? 'border: 2px solid #ef4444;' : ''}
                                        " onmouseenter="this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)'" 
                                           onmouseleave="this.style.boxShadow='none'">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                                <div style="font-weight: 700; font-size: 15px; color: ${isConflict ? '#991b1b' : '#1f2937'};">
                                                    ${isConflict ? 'âš ï¸ ' : ''}${timeStr} - ${endTimeStr}
                                                    <span style="font-size: 11px; color: #6b7280; font-weight: 500; margin-left: 6px;">
                                                        (~${estimatedMinutes} Min)
                                                    </span>
                                                </div>
                                                <div style="font-weight: 700; font-size: 14px; color: #667eea;">
                                                    ğŸ’° ${ride.price || 0}â‚¬
                                                </div>
                                            </div>
                                            <div style="font-size: 12px; color: #4b5563; margin-bottom: 4px;">
                                                ğŸ“ ${ride.pickup || 'Unbekannt'}
                                            </div>
                                            <div style="font-size: 12px; color: #4b5563;">
                                                ğŸ¯ ${ride.destination || 'Unbekannt'}
                                            </div>
                                            ${isConflict ? `
                                                <div style="margin-top: 8px; padding: 6px 10px; background: #fef2f2; border: 1px solid #ef4444; border-radius: 6px; font-size: 11px; color: #991b1b; font-weight: 600;">
                                                    âš ï¸ WARNUNG: Ãœberschneidet sich mit anderer Fahrt!
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            
            document.getElementById('calendar-container').innerHTML = html;
            updateCalendarStats(dayRides, 'Tag');
        }
        
        // Hilfsfunktion: Erkenne Zeitkonflikte
        function detectTimeConflicts(rides) {
            const conflicts = [];
            
            for (let i = 0; i < rides.length; i++) {
                const ride1 = rides[i];
                const time1 = ride1.pickupTimestamp || ride1.createdAt || 0;
                const price1 = parseFloat(ride1.price) || 0;
                const duration1 = price1 > 0 ? Math.max(15, Math.round(price1 * 2)) : 30;
                const end1 = time1 + (duration1 * 60000);
                
                for (let j = i + 1; j < rides.length; j++) {
                    const ride2 = rides[j];
                    const time2 = ride2.pickupTimestamp || ride2.createdAt || 0;
                    
                    // PrÃ¼fe Ãœberlappung
                    if (time2 < end1) {
                        conflicts.push([i, j]);
                    }
                }
            }
            
            return conflicts;
        }
        
        // Hilfsfunktion: Generiere Timeline-Balken
        function generateTimelineBar(rides, conflicts) {
            if (rides.length === 0) return '';
            
            // Finde Zeitspanne (06:00 - 24:00 Uhr)
            const startHour = 6;
            const endHour = 24;
            const totalMinutes = (endHour - startHour) * 60;
            
            let html = '<div style="position: relative; height: 40px; background: #f3f4f6; border-radius: 8px; overflow: hidden;">';
            
            // Zeitmarkierungen
            html += '<div style="position: absolute; top: 0; left: 0; right: 0; height: 100%; display: flex; justify-content: space-between; padding: 0 4px;">';
            for (let h = startHour; h <= endHour; h += 3) {
                html += `
                    <div style="font-size: 9px; color: #9ca3af; padding-top: 2px;">
                        ${h}:00
                    </div>
                `;
            }
            html += '</div>';
            
            // Fahrten-Balken
            rides.forEach((ride, idx) => {
                const time = new Date(ride.pickupTimestamp || ride.createdAt || 0);
                const hour = time.getHours();
                const minute = time.getMinutes();
                const startMinute = (hour - startHour) * 60 + minute;
                
                const price = parseFloat(ride.price) || 0;
                const duration = price > 0 ? Math.max(15, Math.round(price * 2)) : 30;
                
                const leftPercent = (startMinute / totalMinutes) * 100;
                const widthPercent = (duration / totalMinutes) * 100;
                
                const isConflict = conflicts.some(c => c.includes(idx));
                
                html += `
                    <div style="
                        position: absolute;
                        left: ${leftPercent}%;
                        width: ${widthPercent}%;
                        top: 50%;
                        transform: translateY(-50%);
                        height: 24px;
                        background: ${isConflict ? 'repeating-linear-gradient(45deg, #ef4444, #ef4444 10px, #fca5a5 10px, #fca5a5 20px)' : 'linear-gradient(135deg, #667eea, #764ba2)'};
                        border-radius: 6px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        ${isConflict ? 'border: 2px solid #991b1b; z-index: 10;' : ''}
                    "></div>
                `;
            });
            
            html += '</div>';
            
            return html;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸš• v5.32.5: FAHRZEUG-ZUWEISUNG
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let currentRideForAssignment = null;
        
        async function openVehicleAssignmentModal(rideId) {
            currentRideForAssignment = rideId;
            console.log('ğŸš• Ã–ffne Fahrzeug-Zuweisung fÃ¼r Ride:', rideId);
            
            document.getElementById('vehicle-assignment-modal').style.display = 'flex';
            await loadOnlineVehiclesForAssignment(rideId);
        }
        
        function closeVehicleAssignmentModal() {
            document.getElementById('vehicle-assignment-modal').style.display = 'none';
            currentRideForAssignment = null;
        }
        
        async function loadOnlineVehiclesForAssignment(rideId) {
            const content = document.getElementById('vehicle-assignment-content');
            content.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px 20px;">ğŸ”„ Lade Fahrzeuge...</p>';
            
            try {
                // ğŸ†• v5.52.1: Lade ALLE Fahrzeuge aus Verwaltung + Fahrer-Status
                const [vehiclesSnapshot, driversSnapshot, rideSnapshot] = await Promise.all([
                    db.ref('vehicles').once('value'),
                    db.ref('vehicles').once('value'),
                    db.ref('rides/' + rideId).once('value')
                ]);
                
                const allVehicles = vehiclesSnapshot.val() || {};
                const drivers = driversSnapshot.val() || {};
                const ride = rideSnapshot.val();
                
                if (!ride) {
                    content.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 40px 20px;">ğŸ’¾ Fahrt nicht gefunden!</p>';
                    return;
                }
                
                let html = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; color: white;">
                        <div style="font-size: 16px; font-weight: 700; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">ğŸ“‹</span>
                            <span>Fahrt-Details</span>
                        </div>
                        
                        <div style="display: grid; gap: 12px;">
                            <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">ğŸ“ Von:</div>
                                <div style="font-weight: 600; font-size: 15px;">${ride.pickup || 'Unbekannt'}</div>
                            </div>
                            
                            <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">ğŸ¯ Nach:</div>
                                <div style="font-weight: 600; font-size: 15px;">${ride.destination || 'Unbekannt'}</div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">ğŸ• Abholung:</div>
                                    <div style="font-weight: 600; font-size: 14px;">${ride.pickupTime || 'Sofort'}</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">ğŸ’° Preis:</div>
                                    <div style="font-weight: 700; font-size: 16px;">${ride.price || 0}â‚¬</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h4 style="margin: 0 0 15px 0; color: #1f2937; font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px;">ğŸš—</span>
                        <span>VerfÃ¼gbare Fahrzeuge</span>
                    </h4>
                `;
                
                // ğŸ†• v5.52.1: Sammle Fahrzeuge mit Online-Status
                const onlineVehicles = [];
                const offlineVehicles = [];
                
                // ğŸ†• v5.90.357: PrÃ¼fe direkt in drivers (=vehicles) nach online status!
                const onlineVehicleIds = new Set();
                
                for (const [vehicleId, vehicle] of Object.entries(drivers)) {
                    // PrÃ¼fe GPS-Alter (max 2 Min)
                    const isOnline = vehicle.online && 
                                   vehicle.timestamp && 
                                   (Date.now() - vehicle.timestamp) < 120000;
                    
                    if (isOnline) {
                        onlineVehicleIds.add(vehicleId);
                    }
                }
                
                // Sortiere Fahrzeuge nach Online/Offline
                for (const [vehicleId, vehicle] of Object.entries(allVehicles)) {
                    const isOnline = onlineVehicleIds.has(vehicleId);
                    const vehicleData = {
                        id: vehicleId,
                        name: vehicle.name || vehicleId,
                        plate: vehicle.plate || 'Kein Kennzeichen',
                        online: isOnline,
                        gpsData: drivers[vehicleId] || null  // GPS-Daten aus drivers (=vehicles)
                    };
                    
                    if (isOnline) {
                        onlineVehicles.push(vehicleData);
                    } else {
                        offlineVehicles.push(vehicleData);
                    }
                }
                
                // Sortiere alphabetisch
                onlineVehicles.sort((a, b) => a.name.localeCompare(b.name));
                offlineVehicles.sort((a, b) => a.name.localeCompare(b.name));
                
                // ğŸŸ¢ ONLINE FAHRZEUGE
                if (onlineVehicles.length > 0) {
                    onlineVehicles.forEach(vehicle => {
                        const gps = vehicle.gpsData;  // GPS aus drivers (=vehicles)
                        const lastUpdate = gps && gps.timestamp ? new Date(gps.timestamp).toLocaleTimeString('de-DE') : 'k.A.';
                        const hasGPS = gps && gps.lat && gps.lon;
                        
                        html += `
                            <div style="border: 3px solid #10b981; border-radius: 12px; padding: 16px; margin-bottom: 12px; background: linear-gradient(to right, #d1fae5, #f0fdf4); transition: all 0.3s; cursor: pointer;"
                                 onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(16,185,129,0.3)';"
                                 onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <div style="font-weight: 700; font-size: 18px; color: #1f2937; display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 24px;">ğŸš—</span>
                                        <div>
                                            <div>${vehicle.name}</div>
                                            <div style="font-size: 13px; font-weight: 600; color: #059669;">ğŸš™ ${vehicle.plate}</div>
                                        </div>
                                    </div>
                                    <div style="background: #10b981; color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; letter-spacing: 0.5px;">
                                        ğŸŸ¢ ONLINE
                                    </div>
                                </div>
                                
                                ${hasGPS ? `
                                    <div style="font-size: 12px; color: #059669; margin-bottom: 6px; display: flex; align-items: center; gap: 6px;">
                                        <span>ğŸ“</span>
                                        <span>${gps.lat.toFixed(4)}, ${gps.lon.toFixed(4)}</span>
                                    </div>
                                ` : ''}
                                
                                <div style="font-size: 12px; color: #048257; margin-bottom: 14px; display: flex; align-items: center; gap: 6px;">
                                    <span>ğŸ•</span>
                                    <span>Letztes Update: ${lastUpdate}</span>
                                </div>
                                
                                <button onclick="assignVehicleToRide('${rideId}', '${vehicle.id}')" 
                                        style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(102,126,234,0.3);"
                                        onmouseenter="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(102,126,234,0.5)';"
                                        onmouseleave="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(102,126,234,0.3)';">
                                    âœ… Dieses Fahrzeug zuweisen
                                </button>
                            </div>
                        `;
                    });
                } else {
                    html += `
                        <div style="background: linear-gradient(135deg, #fef3c7, #fef9c3); border: 3px solid #f59e0b; border-radius: 12px; padding: 25px; text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">âš ï¸</div>
                            <div style="color: #92400e; font-weight: 700; font-size: 16px; margin-bottom: 6px;">
                                Keine Fahrzeuge online!
                            </div>
                            <div style="color: #78350f; font-size: 13px;">
                                Du kannst trotzdem ein OFFLINE-Fahrzeug fÃ¼r die Planung zuweisen.
                            </div>
                        </div>
                    `;
                }
                
                // âšª OFFLINE FAHRZEUGE (auch zuweisbar!)
                if (offlineVehicles.length > 0) {
                    html += `
                        <h4 style="margin: 20px 0 12px 0; color: #6b7280; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 18px;">âšª</span>
                            <span>Offline Fahrzeuge (trotzdem zuweisbar)</span>
                        </h4>
                    `;
                    
                    offlineVehicles.forEach(vehicle => {
                        html += `
                            <div style="border: 2px solid #d1d5db; border-radius: 8px; padding: 14px; margin-bottom: 8px; background: #f9fafb; transition: all 0.3s; cursor: pointer;"
                                 onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';"
                                 onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <div style="font-weight: 600; font-size: 15px; color: #6b7280; display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 20px;">ğŸš—</span>
                                        <div>
                                            <div>${vehicle.name}</div>
                                            <div style="font-size: 12px; font-weight: 600; color: #9ca3af;">ğŸš™ ${vehicle.plate}</div>
                                        </div>
                                    </div>
                                    <div style="background: #9ca3af; color: white; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">
                                        âšª OFFLINE
                                    </div>
                                </div>
                                
                                <button onclick="assignVehicleToRide('${rideId}', '${vehicle.id}')" 
                                        style="width: 100%; padding: 10px; background: linear-gradient(135deg, #9ca3af, #6b7280); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s;"
                                        onmouseenter="this.style.transform='scale(1.02)';"
                                        onmouseleave="this.style.transform='scale(1)';">
                                    ğŸ“‹ FÃ¼r Planung zuweisen
                                </button>
                            </div>
                        `;
                    });
                }
                
                content.innerHTML = html;
                console.log('ğŸš— Fahrzeuge geladen:', onlineVehicles.length, 'online,', offlineVehicles.length, 'offline');
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der Fahrzeuge:', error);
                content.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 40px 20px;">ğŸ’¾ Fehler beim Laden der Fahrzeuge!</p>';
            }
        }
        
        async function assignVehicleToRide(rideId, vehicleId) {
            console.log('ğŸš• assignVehicleToRide (Kalender):', vehicleId, 'â†’ Ride:', rideId);
            
            try {
                // ğŸ†• v5.63.6: NUTZE ZENTRALE FUNKTION!
                const result = await assignVehicleUnified(rideId, vehicleId, {
                    source: 'Admin Kalender',
                    sendTelegram: false, // Kalender sendet kein Telegram
                    updateViews: true,
                    includeAssignedVehicle: true // Kalender nutzt auch assignedVehicle
                });
                
                closeVehicleAssignmentModal();
                
                alert(`âœ… Fahrzeug ${result.vehicleName}${result.vehiclePlate ? ' (' + result.vehiclePlate + ')' : ''} erfolgreich zugewiesen!`);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Zuweisen:', error);
                alert('ğŸ’¾ Fehler beim Zuweisen des Fahrzeugs!');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // EVENT LISTENERS
        window.addEventListener('DOMContentLoaded', () => {
            // ğŸ› v5.47.1: Initiales Log im Floating Debug Panel!
            debugLog('info', 'ğŸš€ Funk Taxi App gestartet!');
            debugLog('info', `ğŸ“¦ Version: 5.90.367 - MAP CRASH GEFIXT!`);
            debugLog('info', 'ğŸ› Floating Debug Panel aktiv!');
            
            // ğŸ†• v5.90.644: Setze Mindestdatum auf HEUTE + setze initial heutiges Datum
            const dateInput = document.getElementById('custom-date');
            if (dateInput) {
                const today = new Date();
                const minDate = today.getFullYear() + '-' + 
                               String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(today.getDate()).padStart(2, '0');
                dateInput.setAttribute('min', minDate);
                dateInput.value = minDate; // ğŸ†• Setze auch initial!
                console.log('ğŸ“… v5.90.644: Mindestdatum gesetzt:', minDate);
                console.log('ğŸ“… v5.90.644: Initial-Datum gesetzt:', minDate);
            }
            
            // ğŸ†• v5.38.5: Debug-Icon initialisieren
            const debugIcon = document.getElementById('debug-icon');
            if (debugIcon) {
                debugIcon.textContent = debugMode ? 'ğŸŸ¢' : 'ğŸ›';
                if (debugMode) {
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    console.log('ğŸŸ¢ DEBUG-MODUS ist AKTIV (aus localStorage)');
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                }
            }
            
            // ğŸ†• v5.34.1: schedule-view zur Liste hinzugefÃ¼gt!
            console.log('ğŸ¬ Initialisiere Views...');
            debugLog('info', 'ğŸ¬ Initialisiere Views...');
            const allViews = ['passenger-view', 'schedule-view', 'history-view', 'driver-view', 'admin-view', 'shift-plan-view', 'debug-view', 'ai-assistant-view'];
            allViews.forEach(viewId => {
                const viewEl = document.getElementById(viewId);
                if (viewEl) {
                    if (viewId === 'passenger-view') {
                        viewEl.style.display = 'block';
                        console.log('âœ… passenger-view sichtbar');
                    } else {
                        viewEl.style.display = 'none';
                        console.log('ğŸš« ' + viewId + ' versteckt');
                    }
                }
            });
            
            // ğŸ” STARTSEITE: Nur Fahrgast anzeigen (bis Login)
            applyRoleRestrictions(null); // null = nicht eingeloggt
            
            // ğŸ†• v5.26.13: Lade gespeicherte Orte
            loadSavedLocations();
            
            // ğŸ†• v5.28.0: Update Anti-Betrugs Badge
            updateAntiFraudBadge();
            
            // ğŸ†• v5.31.5: Lade Admin-Alarm Einstellung
            const disableAlarm = localStorage.getItem('disableAdminAlarm') === 'true';
            const alarmCheckbox = document.getElementById('disable-admin-alarm');
            if (alarmCheckbox) {
                alarmCheckbox.checked = disableAlarm;
            }
            
            // ğŸ¤– v5.32.5h: Lade Auto-Booking Einstellung
            loadAutoBookingSettings();
            
            // ğŸ†• v5.90.277: GPS-BUTTON CLICK HANDLER!
            const gpsIndicator = document.getElementById('gps-indicator');
            if (gpsIndicator) {
                gpsIndicator.style.cursor = 'pointer';
                gpsIndicator.title = 'Klicken um GPS zu aktivieren';
                
                gpsIndicator.addEventListener('click', () => {
                    console.log('ğŸ“ GPS-Button geklickt!');
                    
                    // PrÃ¼fe ob bereits tracking lÃ¤uft
                    if (watchId) {
                        // GPS lÃ¤uft â†’ Stoppe es
                        console.log('ğŸ›‘ Stoppe GPS...');
                        if (watchId) {
                            navigator.geolocation.clearWatch(watchId);
                            watchId = null;
                        }
                        
                        const gpsDot = document.getElementById('gps-dot');
                        const gpsStatus = document.getElementById('gps-status');
                        if (gpsDot) gpsDot.classList.remove('online');
                        if (gpsStatus) gpsStatus.textContent = 'ğŸ“ GPS Off';
                        
                        alert('âœ… GPS gestoppt!');
                    } else {
                        // GPS aus â†’ Starte es!
                        console.log('ğŸš€ Starte GPS...');
                        
                        // PrÃ¼fe ob Fahrzeug gewÃ¤hlt
                        if (!currentVehicle) {
                            alert('ğŸ’¾ Bitte zuerst Fahrzeug wÃ¤hlen!');
                            return;
                        }
                        
                        // Starte GPS Tracking
                        const gpsStatus = document.getElementById('gps-status');
                        if (gpsStatus) gpsStatus.textContent = 'ğŸ“ GPS Suche...';
                        
                        // Nutze getCurrentPosition fÃ¼r sofortige Position
                        navigator.geolocation.getCurrentPosition(
                            (pos) => {
                                console.log('âœ… GPS Position erhalten!', pos.coords);
                                const gpsDot = document.getElementById('gps-dot');
                                const gpsStatus = document.getElementById('gps-status');
                                if (gpsDot) gpsDot.classList.add('online');
                                if (gpsStatus) gpsStatus.textContent = 'ğŸ“ GPS On';
                                
                                // Speichere in Firebase (wenn Fahrzeug gewÃ¤hlt)
                                if (currentVehicle && isFirebaseReady) {
                                    db.ref(`vehicles/${currentVehicle}`).update({
                                        lat: pos.coords.latitude,
                                        lon: pos.coords.longitude,
                                        lastUpdate: Date.now(),
                                        online: true
                                    });
                                }
                                
                                // Starte watchPosition fÃ¼r kontinuierliche Updates
                                startDriverTracking(null);
                                
                                alert('âœ… GPS aktiviert!\n\nğŸ“ Position: ' + 
                                      pos.coords.latitude.toFixed(6) + ', ' + 
                                      pos.coords.longitude.toFixed(6));
                            },
                            (err) => {
                                console.error('ğŸ’¾ GPS Fehler:', err);
                                const gpsStatus = document.getElementById('gps-status');
                                if (gpsStatus) gpsStatus.textContent = 'ğŸ“ GPS Error';
                                
                                let errorMsg = 'GPS Fehler: ';
                                if (err.code === 1) errorMsg += 'Berechtigung verweigert';
                                else if (err.code === 2) errorMsg += 'Position nicht verfÃ¼gbar';
                                else if (err.code === 3) errorMsg += 'Timeout';
                                else errorMsg += err.message;
                                
                                alert('ğŸ’¾ ' + errorMsg);
                            },
                            {
                                enableHighAccuracy: true,
                                timeout: 10000,
                                maximumAge: 0
                            }
                        );
                    }
                });
                
                console.log('âœ… GPS-Button Click-Handler registriert!');
            }
            
            // ğŸ†• MAP-NULL-CHECK-FIX-LINK: PrÃ¼fe ob ?ride=XXX in URL
            const urlParams = new URLSearchParams(window.location.search);
            const trackingRideId = urlParams.get('ride');
            if (trackingRideId) {
                console.log('ğŸ”— Tracking-Link erkannt:', trackingRideId);
                // Warte auf Firebase, dann lade Fahrt
                // NICHT sofort localStorage setzen - listenToMyRide entscheidet!
                setTimeout(() => {
                    if (isFirebaseReady) {
                        // PrÃ¼fe erst ob Fahrt noch aktiv ist
                        db.ref('rides/' + trackingRideId).once('value').then(snapshot => {
                            const ride = snapshot.val();
                            if (ride && ride.status !== 'completed' && ride.status !== 'storniert') {
                                // Fahrt ist aktiv - speichern und anzeigen
                                localStorage.setItem('myCurrentRideId', trackingRideId);
                                listenToMyRide(trackingRideId);
                                document.getElementById('booking-form').style.display = 'none';
                            } else {
                                // Fahrt ist beendet - Formular anzeigen
                                console.log('â„¹ï¸ Tracking-Link: Fahrt ist bereits beendet');
                                localStorage.removeItem('myCurrentRideId');
                                document.getElementById('booking-form').style.display = 'block';
                                document.getElementById('ride-status-container').innerHTML = '';
                                // URL Parameter entfernen
                                window.history.replaceState({}, '', window.location.pathname);
                            }
                        });
                    }
                }, 1500);
            } else {
                // ğŸ†• v5.30.3: KEINE Tracking-Link, aber vielleicht gespeicherte Fahrt?
                // PrÃ¼fe localStorage('myCurrentRideId') beim App-Start!
                console.log('ğŸ” PrÃ¼fe auf gespeicherte aktive Fahrt...');
                setTimeout(() => {
                    const savedRideId = localStorage.getItem('myCurrentRideId');
                    if (savedRideId && isFirebaseReady) {
                        console.log('ğŸ“² Gespeicherte Fahrt gefunden:', savedRideId);
                        // PrÃ¼fe ob Fahrt noch aktiv ist
                        db.ref('rides/' + savedRideId).once('value').then(snapshot => {
                            const ride = snapshot.val();
                            if (ride) {
                                ride.firebaseId = savedRideId;
                                
                                // ğŸ†• v5.50.9: ADMIN-SCHUTZ! Admin-Fahrten NICHT in Passenger-View anzeigen!
                                if (ride.bookedBy === 'admin') {
                                    console.log('ğŸ›¡ï¸ ADMIN-FAHRT ignoriert in Passenger-View!');
                                    console.log('   Diese Fahrt wurde vom Admin erstellt und darf hier nicht storniert werden!');
                                    localStorage.removeItem('myCurrentRideId');
                                    document.getElementById('booking-form').style.display = 'block';
                                    document.getElementById('ride-status-container').innerHTML = '';
                                    return;
                                }
                                
                                // PrÃ¼fe Status
                                const endedStatuses = ['storniert', 'completed', 'cancelled', 'cancelled_pending_driver'];
                                if (endedStatuses.includes(ride.status)) {
                                    console.log('âœ… Gespeicherte Fahrt ist beendet:', ride.status);
                                    localStorage.removeItem('myCurrentRideId');
                                    document.getElementById('booking-form').style.display = 'block';
                                    document.getElementById('ride-status-container').innerHTML = '';
                                } else {
                                    console.log('ğŸš• Gespeicherte Fahrt ist aktiv! Starte Listener...');
                                    myCurrentRide = ride;
                                    document.getElementById('booking-form').style.display = 'none';
                                    showRideStatus(ride);
                                    listenToMyRide(savedRideId); // âœ… LISTENER NEU STARTEN!
                                }
                            } else {
                                // Fahrt existiert nicht mehr
                                console.log('âš ï¸ Gespeicherte Fahrt existiert nicht mehr');
                                localStorage.removeItem('myCurrentRideId');
                                document.getElementById('booking-form').style.display = 'block';
                                document.getElementById('ride-status-container').innerHTML = '';
                            }
                        }).catch(error => {
                            console.error('ğŸ’¾ Fehler beim Laden der gespeicherten Fahrt:', error);
                            localStorage.removeItem('myCurrentRideId');
                        });
                    } else if (!savedRideId) {
                        console.log('â„¹ï¸ Keine gespeicherte Fahrt gefunden');
                    }
                }, 1500);
            }
            
            // ğŸ› Globaler Error Handler fÃ¼r besseres Debugging
            window.addEventListener('error', (e) => {
                console.error('ğŸ’¾ FEHLER:', {
                    message: e.message,
                    filename: e.filename,
                    lineno: e.lineno,
                    colno: e.colno,
                    error: e.error
                });
            });
            
            setupAutocomplete();
            
            // ğŸ†• BUTTON-LOGIK: Verstecke "Taxi buchen" wenn Felder geÃ¤ndert werden
            const pickupField = document.getElementById('pickup');
            const destField = document.getElementById('destination');
            const bookBtn = document.getElementById('book-btn');
            
            function hideBookButton() {
                if (bookBtn) {
                    bookBtn.style.display = 'none';
                    bookBtn.style.visibility = 'hidden';
                    console.log('ğŸ”’ "Taxi buchen" versteckt (Felder geÃ¤ndert)');
                }
                
                // ğŸ†• v5.49.8: AUCH Preis + Route verstecken!
                const priceDisplay = document.getElementById('price-display');
                if (priceDisplay) {
                    priceDisplay.innerHTML = '';
                    priceDisplay.style.display = 'none';
                }
                
                const routeMap = document.getElementById('route-map');
                if (routeMap) {
                    routeMap.style.display = 'none';
                }
                
                // Preis-Button zurÃ¼cksetzen
                const priceBtn = document.getElementById('price-btn');
                if (priceBtn) {
                    priceBtn.innerHTML = 'ğŸ’° Preis berechnen';
                    priceBtn.classList.remove('btn-danger');
                    priceBtn.classList.add('btn-primary');
                }
                
                // Status zurÃ¼cksetzen
                priceCalculated = false;
                window.currentPrice = null;
                window.currentDistance = null;
                window.currentDuration = null;
                pickupCoords = null;
                destCoords = null;
                
                console.log('ğŸ”„ Preis + Route zurÃ¼ckgesetzt (Felder geÃ¤ndert)');
            }
            
            if (pickupField) {
                pickupField.addEventListener('input', hideBookButton);
            }
            if (destField) {
                destField.addEventListener('input', hideBookButton);
            }
            
            // ğŸ”” PUSH DEAKTIVIERT - Telegram Ã¼bernimmt!
            // if ('Notification' in window && Notification.permission !== 'granted') {
            //     document.getElementById('static-notification-banner').style.display = 'block';
            // }
            
            // ğŸ”” Service Worker DEAKTIVIERT - Telegram Ã¼bernimmt!
            // initServiceWorker();
            
            // ğŸŒŸ Stammkunden-Daten laden
            loadRegularCustomer();
            
            // ğŸ’° Pricing Settings laden
            loadPricingSettings();
            
            // ğŸ”„ VERSION-CHECK lÃ¤uft jetzt automatisch im <head>!
            // âœ… v5.10.0: Auto-Update ENTFERNT - stabiler ohne!
            
            // ğŸ“± Telegram Updates prÃ¼fen (nur fÃ¼r Admins, alle 60 Sek)
            if (userRole === 'admin') {
                checkTelegramUpdates();
                setInterval(checkTelegramUpdates, 60000); // Alle 60 Sekunden
            }
            
            // ğŸ” Zeige Login-Button (wird von Auth Observer aktualisiert)
            try {
                updateUserProfile();
            } catch (error) {
                console.error('ğŸ’¾ updateUserProfile Fehler:', error);
            }
            
            setTimeout(() => { 
                if (firebaseLoaded && typeof firebase !== 'undefined') initApp(true); 
                else initApp(false); 
                
                // ğŸš— Lade gespeichertes Fahrzeug
                loadSavedVehicle();
            }, 100);
            
            setInterval(() => { 
                if (pickupCoords) showAvailableTaxis(); 
                if (myCurrentRide && myCurrentRide.status === 'accepted') showRideStatus(myCurrentRide);
                
                // ğŸ”§ Wake Lock alle 30 Sek. prÃ¼fen und neu aktivieren
                if (isOnline && wakeLock === null) {
                    console.log('ğŸ”„ Wake Lock reaktivieren...');
                    requestWakeLock();
                }
            }, 30000);
            
            // ğŸ¯ Live-Update fÃ¼r Assignment-Countdown (jede Sekunde)
            setInterval(() => {
                if (currentView === 'driver') {
                    updateViews(); // Aktualisiert Countdown-Timer
                }
            }, 1000);
            
            // ğŸ†• v5.86.14: BACKUP-SYSTEM initialisieren
            initBackupDB().then(() => {
                console.log('ğŸ”½ Backup-System bereit');
                
                // Erstes Backup nach 5 Minuten
                setTimeout(createAutoBackup, 5 * 60 * 1000);
                
                // Dann alle 4 Stunden
                backupTimer = setInterval(createAutoBackup, BACKUP_INTERVAL);
                console.log('â° Auto-Backup alle 4h aktiviert');
            }).catch(error => {
                console.error('ğŸ’¾ Backup-System Fehler:', error);
            });
            
            // ğŸ†• v5.87.26: LOG-STORAGE initialisieren
            initLogDB().then(() => {
                console.log('ğŸ“ Log-Storage bereit - INSTANT LOGGING aktiv!');
                
                // Cleanup alte Logs alle 5 Minuten
                setInterval(() => {
                    cleanOldLogs();
                }, 5 * 60 * 1000);
                console.log('â° Auto-Cleanup alle 5 Min aktiviert (Logs Ã¤lter als 24h)');
            }).catch(error => {
                console.error('ğŸ’¾ Log-Storage Fehler:', error);
            });
            
            // ğŸ“± PAGE VISIBILITY: GPS stoppen wenn App geschlossen/im Hintergrund
            document.addEventListener('visibilitychange', () => {
                console.log('ğŸ‘ï¸ Visibility changed:', document.hidden ? 'HIDDEN' : 'VISIBLE');
                
                if (document.hidden) {
                    // App im Hintergrund oder geschlossen
                    console.log('ğŸ“± App geht in Hintergrund...');
                    
                    // ğŸ†• v5.21.2: Logging im Live-Log!
                    logActivity('system', 'visibility', `ğŸ“± App geht in Hintergrund - User: ${currentUser?.email || 'nicht eingeloggt'}`, {
                        isOnline: isOnline,
                        vehicle: currentVehicle,
                        gpsMode: gpsMode
                    });
                    
                    if (watchId && currentVehicle) {
                        console.log('â¸ï¸ Pausiere GPS (App im Hintergrund)');
                        // GPS lÃ¤uft weiter, aber Wake Lock freigeben
                        if (wakeLock) {
                            wakeLock.release();
                            wakeLock = null;
                            console.log('âš ï¸ Wake Lock freigegeben (Hintergrund)');
                        }
                    }
                } else {
                    // App wieder sichtbar
                    console.log('ğŸ“± App wieder sichtbar');
                    
                    // ğŸ†• v5.21.1: Auth-Status prÃ¼fen und loggen!
                    if (auth && auth.currentUser) {
                        console.log('âœ… User noch eingeloggt:', auth.currentUser.email);
                        logActivity('system', 'visibility', `ğŸ“± App wieder aktiv - User: ${auth.currentUser.email}`, {
                            isOnline: isOnline,
                            vehicle: currentVehicle,
                            gpsMode: gpsMode
                        });
                    } else if (auth) {
                        console.log('âš ï¸ User ist NICHT mehr eingeloggt!');
                        logActivity('system', 'visibility', `âš ï¸ App wieder aktiv - KEIN USER!`, {
                            wasOnline: isOnline,
                            vehicle: currentVehicle
                        });
                        
                        // Versuche Session wiederherzustellen
                        console.log('ğŸ”„ Versuche Auth-Session wiederherzustellen...');
                    }
                    
                    // ğŸ†• v5.21.3: PrÃ¼fe ECHTEN Status in Firebase!
                    // Problem: isOnline ist noch true, aber Firebase sagt offline
                    if (currentUser && currentVehicle && isFirebaseReady) {
                        const savedOnline = localStorage.getItem('lastOnlineStatus_' + currentUser.uid);
                        
                        // PrÃ¼fe Firebase-Status
                        db.ref('vehicles/' + currentVehicle).once('value').then(snapshot => {
                            const driverData = snapshot.val();
                            const firebaseOnline = driverData && driverData.online === true;
                            
                            console.log('ğŸ” Status-Check: localStorage=' + savedOnline + ', JS=' + isOnline + ', Firebase=' + firebaseOnline);
                            
                            // Wenn localStorage sagt online, aber Firebase sagt offline â†’ wiederherstellen!
                            if (savedOnline === 'true' && !firebaseOnline) {
                                console.log('ğŸ”„ Firebase offline aber sollte online sein â†’ Restore!');
                                
                                // Status wiederherstellen
                                isOnline = true;
                                const toggle = document.getElementById('online-toggle');
                                if (toggle) toggle.checked = true;
                                
                                // In Firebase wieder online setzen
                                const userContact = currentUser.email || currentUser.phoneNumber || 'Unbekannt';
                                const vehicleName = VEHICLES[currentVehicle]?.name || currentVehicle;
                                
                                db.ref('vehicles/' + currentVehicle).update({
                                    online: true,
                                    userId: currentUser.uid,
                                    userEmail: userContact,
                                    lastOnline: Date.now()
                                }).then(() => {
                                    console.log('âœ… Fahrer wieder ONLINE in Firebase!');
                                    
                                    // Protokoll
                                    logActivity('driver', 'online', 
                                        `Fahrer ${userContact} (${vehicleName}) ist jetzt ONLINE (Visibility-Restore)`, {
                                        vehicle: currentVehicle,
                                        driver: vehicleName,
                                        email: userContact,
                                        reason: 'visibility_restore'
                                    });
                                });
                                
                                // GPS neu starten
                                if (gpsMode === 'standby' || gpsMode === 'off') {
                                    startStandbyTracking();
                                }
                            } else if (firebaseOnline && !isOnline) {
                                // Firebase sagt online, aber JS sagt offline â†’ JS korrigieren
                                console.log('ğŸ”„ JS offline aber Firebase online â†’ korrigiere JS');
                                isOnline = true;
                                const toggle = document.getElementById('online-toggle');
                                if (toggle) toggle.checked = true;
                            }
                        }).catch(err => {
                            console.error('ğŸ’¾ Firebase Status-Check Fehler:', err);
                        });
                    }
                    
                    // ğŸ†• v5.21.6: GPS prÃ¼fen und ggf. neu starten
                    if (isOnline && currentVehicle) {
                        console.log('ğŸ”„ App aufgewacht - prÃ¼fe GPS...');
                        console.log('   watchId:', watchId, ', standbyIntervalId:', standbyIntervalId, ', gpsMode:', gpsMode);
                        
                        // PrÃ¼fe ob GPS/Standby noch lÃ¤uft
                        if (standbyIntervalId || watchId) {
                            // GPS lÃ¤uft noch! Nur Position aktualisieren
                            console.log('âœ… GPS/Standby lÃ¤uft noch - hole aktuelle Position');
                            getStandbyPosition();
                        } else {
                            // GPS wurde vom Browser gestoppt - neu starten!
                            console.log('âš ï¸ GPS/Standby wurde gestoppt - starte neu!');
                            startStandbyTracking();
                        }
                    }
                    
                    // Wake Lock reaktivieren
                    if (isOnline && !wakeLock) {
                        requestWakeLock();
                    }
                    
                    // Synchronisiere Toggle-State
                    syncToggleState();
                }
            });
            
            // ğŸšª BEFOREUNLOAD: Nur loggen, NICHT GPS stoppen!
            // ğŸ†• v5.21.6: GPS weiterlaufen lassen im Hintergrund
            // Der Browser stoppt es sowieso wenn er will, aber vielleicht
            // lÃ¤uft es noch 5-10 Minuten weiter und sendet Positionen!
            window.addEventListener('beforeunload', () => {
                console.log('ğŸšª App geht in Hintergrund - GPS lÃ¤uft weiter!');
                
                // ğŸ“œ PROTOKOLL: Nur loggen
                if (currentVehicle && isOnline) {
                    const vehicleName = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle;
                    const userContact = currentUser ? (currentUser.email || currentUser.phoneNumber || 'Unbekannt') : 'Unbekannt';
                    
                    logActivity('system', 'background', 
                        `ğŸ“± App-Wechsel: ${userContact} (${vehicleName}) - GPS lÃ¤uft weiter`, {
                        vehicle: currentVehicle,
                        driver: vehicleName,
                        email: userContact,
                        reason: 'beforeunload',
                        gpsMode: gpsMode,
                        watchId: watchId ? 'aktiv' : 'inaktiv'
                    });
                }
                
                // ğŸ†• v5.21.6: GPS NICHT stoppen!
                // Lass es weiterlaufen - der Browser entscheidet wann es stoppt
                console.log('â„¹ï¸ GPS bleibt aktiv (watchId:', watchId, ', gpsMode:', gpsMode, ')');
                
                // Wake Lock freigeben (das mÃ¼ssen wir)
                if (wakeLock) {
                    wakeLock.release();
                    console.log('âš ï¸ Wake Lock freigegeben');
                }
            });
            
            // ğŸ†• v5.21.6: GPS-HEALTH-CHECK alle 5 Minuten
            // PrÃ¼ft ob GPS noch sendet und startet es ggf. neu
            setInterval(() => {
                if (!isOnline || !currentVehicle || !currentUser) return;
                
                const now = Date.now();
                const timeSinceLastGps = lastGPSUpdate ? (now - lastGPSUpdate) / 1000 / 60 : 999; // in Minuten
                
                console.log(`ğŸ” GPS-Health-Check: Letzte GPS-Sendung vor ${timeSinceLastGps.toFixed(1)} Min`);
                console.log(`   standbyIntervalId: ${standbyIntervalId ? 'aktiv' : 'INAKTIV'}, watchId: ${watchId ? 'aktiv' : 'inaktiv'}`);
                
                // Wenn GPS lÃ¤nger als 4 Minuten nicht gesendet hat ODER kein Interval lÃ¤uft â†’ neu starten!
                if (timeSinceLastGps > 4 || (!standbyIntervalId && !watchId)) {
                    console.log('âš ï¸ GPS-Problem erkannt! Starte neu...');
                    
                    logActivity('gps', 'restart', 
                        `ğŸ”„ GPS-Neustart: ${!standbyIntervalId ? 'Interval gestoppt' : 'Position ' + timeSinceLastGps.toFixed(0) + ' Min alt'}`, {
                        vehicle: currentVehicle,
                        lastGps: lastGPSUpdate,
                        timeSinceLastGps: timeSinceLastGps.toFixed(1),
                        standbyActive: !!standbyIntervalId,
                        watchActive: !!watchId
                    });
                    
                    // GPS komplett neu starten
                    if (watchId) {
                        navigator.geolocation.clearWatch(watchId);
                        watchId = null;
                    }
                    if (standbyIntervalId) {
                        clearInterval(standbyIntervalId);
                        standbyIntervalId = null;
                    }
                    
                    // Standby-Tracking neu starten
                    startStandbyTracking();
                    console.log('âœ… GPS neu gestartet!');
                } else {
                    console.log('âœ… GPS OK - lÃ¤uft normal');
                }
            }, 5 * 60 * 1000); // Alle 5 Minuten
            
            // ğŸ“… VORBESTELLUNGS-CHECK: PrÃ¼fe alle 60 Sek. ob Vorbestellungen aktiviert werden mÃ¼ssen
            setInterval(async () => {
                if (!isFirebaseReady) return;
                
                try {
                    const snapshot = await db.ref('rides').orderByChild('status').equalTo('vorbestellt').once('value');
                    if (!snapshot.exists()) return;
                    
                    const now = Date.now();
                    snapshot.forEach(async (childSnapshot) => {
                        const ride = childSnapshot.val();
                        const rideId = childSnapshot.key;
                        
                        // ğŸ›¡ï¸ SICHERHEITS-CHECKS: Verhindere doppelte Aktivierung
                        
                        // Check 1: Wurde schon aktiviert?
                        if (ride.activatedAt) {
                            console.log('â­ï¸ Vorbestellung bereits aktiviert, Ã¼berspringe:', rideId);
                            return;
                        }
                        
                        // Check 2: Status wirklich "vorbestellt"?
                        if (ride.status !== 'vorbestellt') {
                            console.log('â­ï¸ Status nicht mehr "vorbestellt", Ã¼berspringe:', rideId, ride.status);
                            return;
                        }
                        
                        // Check 3: Nicht completed/cancelled?
                        if (ride.status === 'completed' || ride.status === 'cancelled' || ride.status === 'storniert' || ride.status === 'abgeschlossen') {
                            console.log('â­ï¸ Fahrt bereits abgeschlossen, Ã¼berspringe:', rideId);
                            return;
                        }
                        
                        // PrÃ¼fe ob Abholzeit in â‰¤ 15 Min
                        if (ride.pickupTimestamp) {
                            const minutesUntilPickup = (ride.pickupTimestamp - now) / (1000 * 60);
                            
                            if (minutesUntilPickup <= 15 && minutesUntilPickup > 0) {
                                console.log('ğŸ“… Vorbestellung wird aktiviert:', rideId, 'noch', minutesUntilPickup.toFixed(1), 'Min');
                                
                                // Status auf "new" setzen â†’ Fahrer bekommen Benachrichtigung
                                await db.ref('rides/' + rideId).update({
                                    status: 'new',
                                    activatedAt: Date.now()
                                });
                                
                                // ğŸ¯ STARTE AUTO-ASSIGNMENT fÃ¼r aktivierte Vorbestellung
                                const updatedRide = { ...ride, status: 'new', firebaseId: rideId };
                                startAutoAssignment(rideId, updatedRide);
                                console.log('ğŸ¯ Auto-Assignment gestartet fÃ¼r aktivierte Vorbestellung:', rideId);
                            } else if (minutesUntilPickup <= 0) {
                                console.log('â° Vorbestellung ist Ã¼berfÃ¤llig:', rideId, 'war vor', Math.abs(minutesUntilPickup).toFixed(1), 'Min');
                            }
                        }
                    });
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim Vorbestellungs-Check:', error);
                }
            }, 60000); // Alle 60 Sekunden
            
            // ğŸ†• v5.21.6: GPS-WATCHDOG - PrÃ¼ft alle 5 Min ob GPS noch funktioniert
            setInterval(() => {
                // Nur fÃ¼r Online-Fahrer relevant
                if (!isOnline || !currentVehicle || currentView !== 'driver') return;
                
                console.log('ğŸ” GPS-Watchdog: PrÃ¼fe GPS-Status... (watchId:', watchId, ', gpsMode:', gpsMode, ')');
                
                // Wenn GPS aus ist aber Fahrer online â†’ neu starten!
                if (!watchId) {
                    console.log('âš ï¸ GPS-Watchdog: GPS ist aus - starte neu!');
                    startStandbyTracking();
                    
                    logActivity('gps', 'watchdog', 
                        `ğŸ”„ GPS-Watchdog: GPS war aus, wurde neu gestartet`, {
                        vehicle: currentVehicle,
                        gpsMode: gpsMode
                    });
                } else {
                    // GPS lÃ¤uft - hole aktuelle Position
                    console.log('âœ… GPS-Watchdog: GPS lÃ¤uft - aktualisiere Position');
                    getStandbyPosition();
                }
                
                // PrÃ¼fe auch ob letzte Position zu alt ist
                if (currentVehicle && isFirebaseReady) {
                    db.ref('vehicles/' + currentVehicle + '/timestamp').once('value').then(snapshot => {
                        const lastTimestamp = snapshot.val();
                        if (lastTimestamp) {
                            const ageMinutes = (Date.now() - lastTimestamp) / (1000 * 60);
                            console.log('ğŸ“± GPS-Watchdog: Letzte Position ist', ageMinutes.toFixed(1), 'Min alt');
                            
                            if (ageMinutes > 5) {
                                console.log('âš ï¸ GPS ist zu alt! Erzwinge neue Position...');
                                // Erzwinge neue Position
                                navigator.geolocation.getCurrentPosition(
                                    (pos) => {
                                        if (typeof handleGPSPosition === 'function') {
                                            handleGPSPosition(pos, null);
                                        }
                                        console.log('âœ… Neue Position erzwungen!');
                                    },
                                    (err) => {
                                        console.error('ğŸ’¾ GPS-Fehler:', err.message);
                                    },
                                    { enableHighAccuracy: false, timeout: 10000, maximumAge: 0 }
                                );
                            }
                        }
                    });
                }
            }, 5 * 60 * 1000); // Alle 5 Minuten
            
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    console.log('ğŸ“± App wieder sichtbar - prÃ¼fe Wake Lock');
                    if (isOnline && (wakeLock === null || wakeLock.released)) {
                        console.log('ğŸ”„ Reaktiviere Wake Lock');
                        requestWakeLock();
                    }
                    // GPS-Position auch neu senden wenn Fahrer online
                    if (isOnline && currentView === 'driver' && watchId) {
                        navigator.geolocation.getCurrentPosition((pos) => {
                            if (typeof handleGPSPosition === 'function') {
                                handleGPSPosition(pos, null);
                            }
                        });
                    }
                }
            });
            
            // ğŸ“± ZusÃ¤tzliche Wake Lock Reaktivierung bei User-Interaktion
            ['focus', 'touchstart', 'click'].forEach(eventType => {
                document.addEventListener(eventType, () => {
                    if (isOnline && currentView === 'driver' && (wakeLock === null || wakeLock.released)) {
                        console.log('ğŸ‘† User-Interaktion erkannt - reaktiviere Wake Lock');
                        requestWakeLock();
                    }
                }, { once: false, passive: true });
            });
        });
        
        // ğŸ†• v5.39.8: AGGRESSIVE VIEW-BEREINIGUNG - Mehrfach ausfÃ¼hren!
        window.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ v5.42.5: View-Bereinigung aktiv...');
            
            function forcePassengerViewOnly() {
                // Verstecke ALLE Views brutal!
                const allViews = ['passenger-view', 'schedule-view', 'history-view', 'driver-view', 'admin-view', 'shift-plan-view', 'debug-view', 'ai-assistant-view'];
                allViews.forEach(viewId => {
                    const viewEl = document.getElementById(viewId);
                    if (viewEl) {
                        viewEl.style.display = 'none';
                        viewEl.style.visibility = 'hidden';
                        viewEl.classList.remove('active');
                    }
                });
                
                // Zeige NUR passenger-view
                const passengerView = document.getElementById('passenger-view');
                if (passengerView) {
                    passengerView.style.display = 'block';
                    passengerView.style.visibility = 'visible';
                    passengerView.classList.add('active');
                    console.log('âœ… Passenger-View erzwungen');
                }
                
                // Setze passenger tab als aktiv
                const passengerTab = document.querySelector('.admin-tab-btn[data-view="passenger"]');
                if (passengerTab) {
                    passengerTab.classList.add('active');
                }
            }
            
            // MEHRFACH ausfÃ¼hren um SICHER zu sein!
            forcePassengerViewOnly(); // Sofort
            setTimeout(forcePassengerViewOnly, 100); // Nach 100ms
            setTimeout(forcePassengerViewOnly, 500); // Nach 500ms
            setTimeout(forcePassengerViewOnly, 1000); // Nach 1s
            setTimeout(forcePassengerViewOnly, 2000); // Nach 2s
            
            console.log('ğŸ”’ View-Lock aktiviert - Passenger-View erzwungen!');
        });
        
        // ğŸ†• v5.33.4: VIEW-GUARD - Ãœberwacht dass nur aktive View sichtbar ist!
        setInterval(() => {
            const allViews = ['passenger-view', 'schedule-view', 'history-view', 'driver-view', 'admin-view', 'shift-plan-view', 'debug-view', 'ai-assistant-view'];
            
            allViews.forEach(viewId => {
                const viewEl = document.getElementById(viewId);
                if (!viewEl) return;
                
                // PrÃ¼fe ob View sichtbar ist obwohl sie nicht aktiv ist
                const isVisible = window.getComputedStyle(viewEl).display !== 'none';
                const isActive = viewEl.classList.contains('active');
                
                if (isVisible && !isActive) {
                    // View ist sichtbar aber nicht aktiv - VERSTECKEN!
                    console.warn('âš ï¸ View-Guard: Verstecke inaktive View:', viewId);
                    viewEl.style.display = 'none';
                    viewEl.style.visibility = 'hidden';
                }
            });
        }, 2000); // Alle 2 Sekunden prÃ¼fen
    </script>
    <!-- ğŸ” LOGIN MODAL -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ğŸ” Anmelden</div>
            
            <!-- Tab-Auswahl -->
            <div style="display:flex;margin-bottom:15px;border-radius:8px;overflow:hidden;border:2px solid #e0e0e0;">
                <button id="login-tab-email" onclick="switchLoginTab('email')" style="flex:1;padding:10px;border:none;background:#667eea;color:white;font-weight:600;cursor:pointer;">
                    âœ‰ï¸ E-Mail
                </button>
                <button id="login-tab-phone" onclick="switchLoginTab('phone')" style="flex:1;padding:10px;border:none;background:#f3f4f6;color:#333;font-weight:600;cursor:pointer;">
                    ğŸ“± Telefon
                </button>
            </div>
            
            <!-- E-Mail Login -->
            <div id="login-email-section">
                <button class="modal-btn btn-google" onclick="loginWithGoogle()">
                    <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Mit Google anmelden
                </button>
                
                <div class="modal-divider">oder</div>
                
                <input type="email" id="login-email" class="modal-input" placeholder="E-Mail">
                <input type="password" id="login-password" class="modal-input" placeholder="Passwort">
                
                <button class="modal-btn btn-primary-modal" onclick="loginWithEmail()">Anmelden</button>
                
                <div class="modal-link" onclick="showRegisterModal()">Noch kein Konto? Jetzt registrieren</div>
            </div>
            
            <!-- ğŸ“± Telefon Login (NEU!) -->
            <div id="login-phone-section" style="display:none;">
                <div style="text-align:center;margin-bottom:15px;">
                    <div style="font-size:40px;margin-bottom:5px;">ğŸ“±</div>
                    <div style="color:#666;font-size:13px;">Melde dich mit deiner Telefonnummer an.<br>Du erhÃ¤ltst einen SMS-Code.</div>
                </div>
                
                <!-- Schritt 1: Telefonnummer -->
                <div id="phone-step-1">
                    <div style="display:flex;gap:8px;margin-bottom:10px;">
                        <select id="phone-country" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
                            <option value="+49">ğŸ‡©ğŸ‡ª +49</option>
                            <option value="+43">ğŸ‡¦ğŸ‡¹ +43</option>
                            <option value="+41">ğŸ‡¨ğŸ‡­ +41</option>
                        </select>
                        <input type="tel" id="phone-number" class="modal-input" placeholder="170 1234827" 
                               onblur="addCountryCode(this)"
                               style="flex:1;margin:0;">
                    </div>
                    
                    <!-- reCAPTCHA Container (invisible - lÃ¤uft im Hintergrund) -->
                    <div id="login-recaptcha-container"></div>
                    
                    <button id="send-code-btn" class="modal-btn btn-primary-modal" onclick="sendPhoneCode()" style="background:#10b981;">
                        ğŸ“² SMS-Code senden
                    </button>
                </div>
                
                <!-- Schritt 2: Code eingeben -->
                <div id="phone-step-2" style="display:none;">
                    <div style="text-align:center;margin-bottom:15px;">
                        <div style="color:#666;font-size:13px;">SMS-Code wurde gesendet an:</div>
                        <div style="font-weight:600;" id="phone-display"></div>
                    </div>
                    
                    <input type="text" id="phone-code" class="modal-input" placeholder="6-stelliger Code" maxlength="6" style="text-align:center;font-size:20px;letter-spacing:8px;" autocomplete="one-time-code" inputmode="numeric" pattern="[0-9]*">
                    
                    <button class="modal-btn btn-primary-modal" onclick="verifyPhoneCode()" style="background:#10b981;">
                        âœ… Code bestÃ¤tigen
                    </button>
                    
                    <div class="modal-link" onclick="resetPhoneLogin()">â† Andere Nummer verwenden</div>
                </div>
            </div>
            
            <div class="modal-link" onclick="closeLoginModal()">Abbrechen</div>
        </div>
    </div>
    
    <!-- ğŸ“ REGISTER MODAL -->
    <div id="register-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ğŸ“ Registrieren</div>
            
            <input type="text" id="register-name" class="modal-input" placeholder="Name">
            <input type="email" id="register-email" class="modal-input" placeholder="E-Mail">
            <input type="password" id="register-password" class="modal-input" placeholder="Passwort">
            
            <button class="modal-btn btn-primary-modal" onclick="registerWithEmail()">Registrieren</button>
            
            <div class="modal-link" onclick="showLoginModal()">Bereits ein Konto? Anmelden</div>
            <div class="modal-link" onclick="closeRegisterModal()">Abbrechen</div>
        </div>
    </div>

    <!-- ğŸš• v5.32.5: FAHRZEUG-ZUWEISUNG MODAL -->
    <div id="vehicle-assignment-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 550px; max-height: 85vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e5e7eb;">
                <h3 style="margin: 0; color: #1f2937; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 28px;">ğŸš•</span>
                    <span>Fahrzeug zuweisen</span>
                </h3>
                <button onclick="closeVehicleAssignmentModal()" 
                        style="background: none; border: none; font-size: 32px; cursor: pointer; color: #9ca3af; line-height: 1; padding: 0; transition: color 0.2s;"
                        onmouseenter="this.style.color='#ef4444'" 
                        onmouseleave="this.style.color='#9ca3af'">
                    Ã—
                </button>
            </div>
            
            <div id="vehicle-assignment-content">
                <!-- Wird dynamisch gefÃ¼llt -->
            </div>
        </div>
    </div>

    <!-- ğŸ“± v5.87.21: External JavaScript ENTFERNT (Dateien fehlen!) -->
    <!-- <script src="improved-gps-tracking.js"></script> -->
    <!-- <script src="driver-settings-manager.js"></script> -->

    <!-- ğŸ“… VORBESTELL-ÃœBERSICHTS-MODAL -->
    <div id="preorder-summary-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="color: #10b981;">
                ğŸ“… Vorbestellung bestÃ¤tigt
            </div>
            
            <div id="preorder-summary-content" style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <!-- Wird dynamisch gefÃ¼llt -->
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="closePreorderSummary()" class="modal-btn" style="flex: 1; background: #10b981; color: white;">
                    âœ… OK
                </button>
                <button onclick="editPreorder()" class="modal-btn" style="flex: 1; background: #3b82f6; color: white;">
                    âœï¸ Bearbeiten
                </button>
            </div>
        </div>
    </div>

    <!-- ğŸ¤– AUTO-BOOKING MODAL: ALTERNATIV-VORSCHLÃ„GE -->
    <div id="auto-booking-modal" class="modal" onclick="if(event.target === this) closeAutoBookingModal()">
        <div class="modal-content" style="max-width: 450px; position: relative;" onclick="event.stopPropagation()">
            <!-- ğŸ”§ v5.39.8: X-BUTTON OBEN RECHTS! -->
            <button onclick="closeAutoBookingModal()" style="
                position: absolute;
                top: 10px;
                right: 10px;
                background: transparent;
                border: none;
                font-size: 24px;
                color: #6b7280;
                cursor: pointer;
                padding: 5px 10px;
                line-height: 1;
                z-index: 10;
            " title="SchlieÃŸen">Ã—</button>
            
            <div class="modal-header" style="color: #f59e0b;">
                âš ï¸ Zeitslot belegt
            </div>
            
            <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
                <div style="font-weight: 600; color: #92400e; margin-bottom: 5px;">
                    ğŸ• <span id="requested-time-display"></span> ist bereits belegt
                </div>
                <div style="font-size: 13px; color: #78350f;">
                    Ein anderes Taxi ist zu dieser Zeit unterwegs
                </div>
            </div>
            
            <div style="font-weight: 600; font-size: 16px; margin-bottom: 15px; color: #1f2937;">
                ğŸ’¡ Alternative Zeiten:
            </div>
            
            <div id="alternative-times-container" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
                <!-- Wird dynamisch gefÃ¼llt -->
            </div>
            
            <!-- ğŸ’¾ v5.32.5i: TELEFON-OPTION -->
            <div style="margin: 20px 0; padding: 15px 0; border-top: 2px solid #e5e7eb; border-bottom: 2px solid #e5e7eb;">
                <div style="text-align: center; margin-bottom: 12px;">
                    <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">
                        â“ Keine Zeit passend?
                    </div>
                    <div style="font-weight: 600; font-size: 15px; color: #1f2937; margin-bottom: 12px;">
                        Rufen Sie uns an:
                    </div>
                    <a href="tel:038378" 
                       style="display: inline-block; padding: 15px 30px; background: linear-gradient(135deg, #10b981, #059669); color: white; text-decoration: none; border-radius: 12px; font-weight: 700; font-size: 20px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); transition: all 0.2s;"
                       onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 16px rgba(16, 185, 129, 0.4)'"
                       onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'">
                        ğŸ’¾ 038378 / 1234
                    </a>
                    <div style="font-size: 12px; color: #6b7280; margin-top: 8px;">
                        Wir helfen Ihnen gerne weiter!
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: center;">
                <!-- ğŸ†• v5.39.9: TROTZDEM BUCHEN Option! -->
                <button onclick="bookOriginalTimeAnyway()" class="modal-btn" style="
                    padding: 12px 24px;
                    background: linear-gradient(135deg, #f59e0b, #d97706);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s;
                " 
                onmouseover="this.style.transform='scale(1.05)'"
                onmouseout="this.style.transform='scale(1)'">
                    âš¡ Trotzdem buchen
                </button>
                <button onclick="closeAutoBookingModal()" class="modal-btn" style="
                    padding: 12px 24px;
                    background: #6b7280;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 15px;
                    cursor: pointer;
                ">
                    ğŸ’¾ Abbrechen
                </button>
                <button onclick="showCustomTimeSelection()" class="modal-btn" style="
                    padding: 12px 24px;
                    background: #3b82f6;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 15px;
                    cursor: pointer;
                ">
                    âœï¸ Andere Zeit
                </button>
            </div>
        </div>
    </div>

    <!-- ğŸ†• v5.38.5: DEBUG-TOGGLE BUTTON (Footer - diskret) -->
    <div id="debug-toggle-footer" style="
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 50;
    ">
        <button onclick="toggleDebugMode()" style="
            background: rgba(0,0,0,0.6);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 10px;
            cursor: pointer;
            font-weight: 600;
            backdrop-filter: blur(10px);
        ">
            <span id="debug-icon">ğŸ›</span> Debug
        </button>
    </div>

    <!-- ğŸ” DEBUG LOGGER - v5.39.7 - Ans Ende verschoben! -->
    <script>
        // Warte auf DOM Ready bevor Console-Interceptor startet
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ” DEBUG MONITOR wird initialisiert...');
            
            // ğŸ†• v5.39.9: Lade gespeicherte Debug-Logs aus localStorage!
            const savedLogs = localStorage.getItem('debugLogs');
            const savedPaused = localStorage.getItem('debugPaused');
            
            // Debug Logger Variablen (global)
            window.debugLogs = savedLogs ? JSON.parse(savedLogs) : [];
            window.debugPaused = savedPaused === 'true'; // Lade Status
            window.debugCounts = { total: 0, info: 0, warn: 0, error: 0 };
            
            // ZÃ¤hle wiederhergestellte Logs
            if (window.debugLogs.length > 0) {
                window.debugLogs.forEach(log => {
                    window.debugCounts.total++;
                    window.debugCounts[log.type] = (window.debugCounts[log.type] || 0) + 1;
                });
                console.log(`ğŸ“¦ ${window.debugLogs.length} Debug-Logs wiederhergestellt aus localStorage`);
            }
            
            const originalLog = console.log;
            const originalWarn = console.warn;
            const originalError = console.error;
            
            // Interceptor-Funktion
            function addDebugLog(type, args) {
                const timestamp = new Date().toLocaleTimeString('de-DE', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    fractionalSecondDigits: 3
                });
                
                const message = Array.from(args).map(arg => {
                    if (typeof arg === 'object') {
                        try {
                            return JSON.stringify(arg, null, 2);
                        } catch(e) {
                            return String(arg);
                        }
                    }
                    return String(arg);
                }).join(' ');
                
                const logEntry = {
                    timestamp,
                    type,
                    message,
                    time: Date.now()
                };
                
                window.debugLogs.push(logEntry);
                window.debugCounts.total++;
                window.debugCounts[type]++;
                
                // ğŸ†• v5.87.30: INSTANT Log-Speicherung in IndexedDB
                if (window.logDB) {
                    try {
                        const transaction = window.logDB.transaction(['logs'], 'readwrite');
                        const store = transaction.objectStore('logs');
                        const logWithDate = {
                            ...logEntry,
                            date: new Date(logEntry.timestamp).toISOString().split('T')[0]
                        };
                        store.put(logWithDate);
                    } catch (e) {
                        // Stille Fehler - nicht in Console loggen (wÃ¼rde Loop erzeugen)
                    }
                }
                
                // ğŸ†• v5.39.9: Speichere in localStorage (max 500 Logs)
                if (window.debugLogs.length > 500) {
                    window.debugLogs = window.debugLogs.slice(-500); // Behalte nur letzte 500
                }
                try {
                    localStorage.setItem('debugLogs', JSON.stringify(window.debugLogs));
                } catch (e) {
                    // localStorage voll? LÃ¶sche Ã¤lteste Logs
                    if (e.name === 'QuotaExceededError') {
                        window.debugLogs = window.debugLogs.slice(-250);
                        localStorage.setItem('debugLogs', JSON.stringify(window.debugLogs));
                    }
                }
                
                // Update UI wenn im Debug-View
                const debugView = document.getElementById('debug-view');
                if (!window.debugPaused && debugView && debugView.style.display !== 'none') {
                    updateDebugUI(logEntry);
                }
            }
            
            // Override console methods
            console.log = function(...args) {
                addDebugLog('info', args);
                originalLog.apply(console, args);
            };
            
            console.warn = function(...args) {
                addDebugLog('warn', args);
                originalWarn.apply(console, args);
            };
            
            console.error = function(...args) {
                addDebugLog('error', args);
                originalError.apply(console, args);
            };
            
            // Update UI
            function updateDebugUI(logEntry) {
                const container = document.getElementById('debug-log-container');
                if (!container) return;
                
                // Clear "Warte auf Logs" message
                if (window.debugLogs.length === 1) {
                    container.innerHTML = '';
                }
                
                const colors = {
                    info: '#10b981',
                    warn: '#f59e0b',
                    error: '#ef4444'
                };
                
                const icons = {
                    info: 'âœ…',
                    warn: 'âš ï¸',
                    error: 'ğŸ’¾'
                };
                
                const logDiv = document.createElement('div');
                logDiv.style.cssText = `
                    padding: 10px;
                    border-bottom: 1px solid #374151;
                    margin-bottom: 5px;
                `;
                logDiv.className = 'debug-log-entry';
                logDiv.setAttribute('data-type', logEntry.type);
                
                logDiv.innerHTML = `
                    <div style="display: flex; gap: 10px; align-items: flex-start;">
                        <span style="color: #9ca3af; font-size: 11px; white-space: nowrap;">${logEntry.timestamp}</span>
                        <span style="color: ${colors[logEntry.type]}; font-weight: bold;">${icons[logEntry.type]}</span>
                        <div style="flex: 1; word-break: break-all;">
                            <pre style="margin: 0; white-space: pre-wrap; font-family: inherit;">${escapeHtml(logEntry.message)}</pre>
                        </div>
                    </div>
                `;
                
                container.appendChild(logDiv);
                
                // Auto-scroll
                container.scrollTop = container.scrollHeight;
                
                // Update counts
                updateCounts();
            }
            
            // Helper: Escape HTML
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Toggle Pause (global)
            window.toggleDebugPause = function() {
                window.debugPaused = !window.debugPaused;
                // ğŸ†• v5.39.9: Speichere Status in localStorage
                localStorage.setItem('debugPaused', window.debugPaused);
                
                const btn = document.getElementById('debug-pause-btn');
                if (window.debugPaused) {
                    btn.textContent = 'â¸ Paused';
                    btn.style.background = '#f59e0b';
                } else {
                    btn.textContent = 'â— Recording';
                    btn.style.background = '#10b981';
                    // Refresh all logs
                    refreshDebugUI();
                }
            };
            
            // Clear Logs (global)
            window.clearDebugLogs = function() {
                if (!confirm('Alle Logs lÃ¶schen?')) return;
                window.debugLogs = [];
                window.debugCounts = { total: 0, info: 0, warn: 0, error: 0 };
                // ğŸ†• v5.39.9: LÃ¶sche auch aus localStorage
                localStorage.removeItem('debugLogs');
                
                const container = document.getElementById('debug-log-container');
                if (container) {
                    container.innerHTML = '<div style="color: #9ca3af; text-align: center; padding: 40px 20px;">ğŸ“ Logs gelÃ¶scht - warte auf neue Logs...</div>';
                }
                updateCounts();
            };
            
            // Copy All Logs (global)
            window.copyDebugLogs = function() {
                const text = window.debugLogs.map(log => {
                    return `[${log.timestamp}] [${log.type.toUpperCase()}] ${log.message}`;
                }).join('\n');
                
                navigator.clipboard.writeText(text).then(() => {
                    alert('âœ… ' + window.debugLogs.length + ' Logs in Zwischenablage kopiert!');
                }).catch(() => {
                    // Fallback
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    alert('âœ… ' + window.debugLogs.length + ' Logs kopiert!');
                });
            };
            
            // Export Logs (global)
            window.exportDebugLogs = function() {
                const text = window.debugLogs.map(log => {
                    return `[${log.timestamp}] [${log.type.toUpperCase()}] ${log.message}`;
                }).join('\n');
                
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `debug-logs-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('âœ… Logs exportiert: ' + window.debugLogs.length + ' EintrÃ¤ge');
            };
            
            // Filter Logs (global)
            window.filterDebugLogs = function() {
                const filterInput = document.getElementById('debug-filter');
                if (!filterInput) return;
                const filter = filterInput.value.toLowerCase();
                const entries = document.querySelectorAll('.debug-log-entry');
                
                entries.forEach(entry => {
                    const text = entry.textContent.toLowerCase();
                    entry.style.display = text.includes(filter) ? 'block' : 'none';
                });
            };
            
            // Refresh UI
            function refreshDebugUI() {
                const container = document.getElementById('debug-log-container');
                if (!container) return;
                container.innerHTML = '';
                window.debugLogs.forEach(log => updateDebugUI(log));
            }
            
            // Update Counts
            function updateCounts() {
                const totalEl = document.getElementById('debug-count-total');
                const infoEl = document.getElementById('debug-count-info');
                const warnEl = document.getElementById('debug-count-warn');
                const errorEl = document.getElementById('debug-count-error');
                
                if (totalEl) totalEl.textContent = window.debugCounts.total;
                if (infoEl) infoEl.textContent = window.debugCounts.info;
                if (warnEl) warnEl.textContent = window.debugCounts.warn;
                if (errorEl) errorEl.textContent = window.debugCounts.error;
            }
            
            // ğŸ†• v5.39.8: Lade ALLE Logs in UI (fÃ¼r View-Wechsel!)
            window.reloadDebugUI = function() {
                console.log('ğŸ”„ Lade Debug-UI neu mit', window.debugLogs.length, 'Logs');
                
                const container = document.getElementById('debug-log-container');
                if (!container) {
                    console.warn('âš ï¸ Debug-Container nicht gefunden!');
                    return;
                }
                
                // Leere Container
                container.innerHTML = '';
                
                // ZÃ¤hler zurÃ¼cksetzen
                window.debugCounts = { total: 0, info: 0, warn: 0, error: 0 };
                
                // Alle Logs neu rendern
                if (window.debugLogs.length === 0) {
                    container.innerHTML = '<div style="color: #9ca3af; text-align: center; padding: 40px 20px;">ğŸ“ Keine Logs vorhanden - warte auf neue Logs...</div>';
                } else {
                    window.debugLogs.forEach(log => {
                        updateDebugUI(log);
                        // ZÃ¤hler neu zÃ¤hlen
                        window.debugCounts.total++;
                        window.debugCounts[log.type]++;
                    });
                }
                
                // Update ZÃ¤hler
                updateCounts();
                
                console.log('âœ… Debug-UI geladen:', window.debugCounts);
            };
            
            // ğŸ†• v5.39.9: Setze Button-Status beim Laden
            const pauseBtn = document.getElementById('debug-pause-btn');
            if (pauseBtn) {
                if (window.debugPaused) {
                    pauseBtn.textContent = 'â¸ Paused';
                    pauseBtn.style.background = '#f59e0b';
                } else {
                    pauseBtn.textContent = 'â— Recording';
                    pauseBtn.style.background = '#10b981';
                }
            }
            
            // ğŸ†• v5.39.9: Zeige wiederhergestellte Logs an
            if (window.debugLogs.length > 0) {
                refreshDebugUI();
                updateCounts();
            }
            
            console.log(`âœ… DEBUG MONITOR bereit (${window.debugPaused ? 'pausiert' : 'recording'} - ${window.debugLogs.length} Logs geladen)`);
            
            // ğŸ” v5.90.0: TAB-BUTTON CLICK LOGGER!
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ” Installiere Tab-Button Click Logger...');
            
            // Warte kurz bis Buttons geladen sind
            setTimeout(() => {
                const tabButtons = document.querySelectorAll('.admin-tab-btn');
                console.log(`ğŸ“± Gefunden: ${tabButtons.length} Tab-Buttons`);
                
                tabButtons.forEach((btn, index) => {
                    // Capture-Phase Event Listener (fÃ¤ngt Event GANZ FRÃœH ab!)
                    btn.addEventListener('click', function(event) {
                        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                        console.log(`ğŸ–±ï¸ TAB-BUTTON #${index} GEKLICKT!`);
                        console.log('ğŸ“ Button Text:', this.textContent.trim().substring(0, 30));
                        console.log('ğŸ¯ data-view:', this.dataset.view);
                        console.log('ğŸ¯ data-tab-id:', this.dataset.tabId);
                        console.log('ğŸ”— onclick Attribut:', this.getAttribute('onclick'));
                        console.log('ğŸ‘ï¸ display:', window.getComputedStyle(this).display);
                        console.log('ğŸ‘ï¸ visibility:', window.getComputedStyle(this).visibility);
                        console.log('ğŸ“¦ Klasse:', this.className);
                        console.log('ğŸ• Zeit:', new Date().toLocaleTimeString('de-DE'));
                        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    }, true); // true = capture phase!
                    
                    console.log(`  âœ… Logger installiert fÃ¼r Button #${index}: ${btn.textContent.trim().substring(0, 20)}`);
                });
                
                console.log('âœ… Tab-Button Click Logger aktiv!');
            }, 2000); // 2 Sekunden warten
            
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ› v5.46.4: FLOATING DEBUG PANEL (NUR ADMIN!)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Variablen sind bereits oben als Stubs deklariert, hier nur zurÃ¼cksetzen falls nÃ¶tig
        // debugPanelLogs, debugFilter, debugPanelMinimized, isDebugPanelOpen bereits definiert
        
        // Admin-Check (Phone-Login)
        function checkAdminAccess() {
            const userPhone = localStorage.getItem('userPhone');
            
            // ğŸ’¾ v5.46.7: DEBUG - Zeige gespeicherte Nummer!
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ’¾ ADMIN-CHECK:');
            console.log('   Gespeicherte Nummer:', userPhone);
            
            if (!userPhone) {
                console.log('   ğŸ’¾ Keine Telefonnummer gefunden!');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                return false;
            }
            
            // ğŸ” Admin-Nummern (alle Varianten!)
            const adminNumbers = [
                '822751',           // Nur letzte 6 Stellen
                '3837822751',       // Ohne Vorwahl
                '038378822751',     // Mit 0
                '493837822751',     // Mit 49
                '+493837822751',    // Mit +49
                '+4938378822751',   // Mit +49 (falls doppelt)
            ];
            
            // Normalisiere Nummer (entferne Leerzeichen, +, -)
            const normalizedPhone = userPhone.replace(/[\s\-\+]/g, '');
            console.log('   Normalisiert:', normalizedPhone);
            
            // PrÃ¼fe ob Nummer endet mit einer Admin-Nummer
            const isAdmin = adminNumbers.some(num => normalizedPhone.endsWith(num));
            
            if (isAdmin) {
                console.log('   âœ… ADMIN ERKANNT!');
            } else {
                console.log('   ğŸ’¾ KEIN ADMIN!');
                console.log('   Erwartete Endungen:', adminNumbers.join(', '));
            }
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            return isAdmin;
        }
        
        // Zeige KÃ¤fer-Button nur fÃ¼r Admin
        setTimeout(() => {
            if (checkAdminAccess()) {
                const btn = document.getElementById('debug-toggle-btn');
                if (btn) {
                    btn.style.display = 'block';
                    console.log('ğŸ› Debug-Button aktiviert (Admin erkannt)');
                }
            }
        }, 2000);
        
        // Toggle Debug Panel
        function toggleDebugPanel() {
            const panel = document.getElementById('debug-panel');
            if (panel.style.display === 'none' || !panel.style.display) {
                panel.style.display = 'block';
                isDebugPanelOpen = true;
                
                // ğŸ› v5.47.1: LADE ALLE bisherigen Logs ins Panel!
                const container = document.getElementById('debug-logs-container');
                if (container) {
                    container.innerHTML = ''; // Erst leeren
                    
                    // FÃ¼ge alle Logs hinzu
                    debugPanelLogs.forEach(log => {
                        addLogToPanel(log);
                    });
                    
                    console.log(`ğŸ› Debug Panel geÃ¶ffnet - ${debugPanelLogs.length} Logs geladen`);
                }
                
                debugLog('info', 'ğŸ› Debug Panel geÃ¶ffnet');
            } else {
                panel.style.display = 'none';
                isDebugPanelOpen = false;
            }
        }
        
        // Minimiere Panel
        function minimizeDebugPanel() {
            const content = document.getElementById('debug-content');
            debugPanelMinimized = !debugPanelMinimized;
            if (debugPanelMinimized) {
                content.style.display = 'none';
            } else {
                content.style.display = 'block';
            }
        }
        
        // SchlieÃŸe Panel
        function closeDebugPanel() {
            const panel = document.getElementById('debug-panel');
            panel.style.display = 'none';
            isDebugPanelOpen = false;
        }
        
        // Kopiere alle Logs
        function copyDebugLogs() {
            let text = 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
            text += 'ğŸ› FUNK TAXI DEBUG LOGS\n';
            text += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
            
            debugPanelLogs.forEach(log => {
                text += `[${log.time}] ${log.type.toUpperCase()}: ${log.message}\n`;
            });
            
            text += '\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
            text += `Total: ${debugPanelLogs.length} Logs\n`;
            text += `Version: 5.46.4\n`;
            text += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
            
            navigator.clipboard.writeText(text).then(() => {
                alert('ğŸ“‹ Logs in Zwischenablage kopiert!\n\n' + 
                      'Du kannst sie jetzt an Claude schicken! ğŸ˜Š');
            }).catch(err => {
                console.error('ğŸ’¾ Kopieren fehlgeschlagen:', err);
                alert('ğŸ’¾ Kopieren fehlgeschlagen!\n\nBitte Ã¶ffne F12 â†’ Console und kopiere manuell.');
            });
        }
        
        // LÃ¶sche Logs
        function clearDebugLogs() {
            debugPanelLogs = [];
            const container = document.getElementById('debug-logs-container');
            container.innerHTML = '<div style="color: #6b7280; font-size: 10px;">Logs gelÃ¶scht...</div>';
        }
        
        // Setze Filter
        function setDebugFilter(filter) {
            debugFilter = filter;
            
            // Update Button-Styles
            const allBtn = document.getElementById('debug-filter-all');
            const warnBtn = document.getElementById('debug-filter-warn');
            const errorBtn = document.getElementById('debug-filter-error');
            
            // Reset alle
            allBtn.style.border = '1px solid #10b981';
            allBtn.style.background = 'white';
            warnBtn.style.border = '1px solid #f59e0b';
            warnBtn.style.background = 'white';
            errorBtn.style.border = '1px solid #ef4444';
            errorBtn.style.background = 'white';
            
            // Aktiviere gewÃ¤hlten
            if (filter === 'all') {
                allBtn.style.border = '2px solid #10b981';
                allBtn.style.background = '#d1fae5';
            } else if (filter === 'warn') {
                warnBtn.style.border = '2px solid #f59e0b';
                warnBtn.style.background = '#fef3c7';
            } else if (filter === 'error') {
                errorBtn.style.border = '2px solid #ef4444';
                errorBtn.style.background = '#fee2e2';
            }
            
            // Refresh Display
            refreshDebugPanel();
        }
        
        // Haupt-Logging Funktion
        function debugLog(type, message) {
            // ğŸ› v5.47.0: LOGS FÃœR ALLE! (Admin-Check entfernt)
            
            const time = new Date().toLocaleTimeString('de-DE');
            const log = { time, type, message };
            
            debugPanelLogs.push(log);
            
            // Limit auf 500 Logs
            if (debugPanelLogs.length > 500) {
                debugPanelLogs.shift();
            }
            
            // Wenn Panel offen, zeige sofort
            if (isDebugPanelOpen) {
                addLogToPanel(log);
            }
            
            // Auch in Console loggen
            const icon = type === 'error' ? 'ğŸ’¾' : type === 'warn' ? 'âš ï¸' : 'âœ…';
            console.log(`${icon} [DEBUG] ${message}`);
        }
        
        // FÃ¼ge Log zu Panel hinzu
        function addLogToPanel(log) {
            // PrÃ¼fe Filter
            if (debugFilter !== 'all') {
                if (debugFilter === 'warn' && log.type !== 'warn') return;
                if (debugFilter === 'error' && log.type !== 'error') return;
            }
            
            const container = document.getElementById('debug-logs-container');
            if (!container) return;
            
            const color = log.type === 'error' ? '#ef4444' : 
                         log.type === 'warn' ? '#f59e0b' : 
                         '#10b981';
            
            const icon = log.type === 'error' ? 'ğŸ’¾' : 
                        log.type === 'warn' ? 'âš ï¸' : 
                        'âœ…';
            
            const div = document.createElement('div');
            div.style.marginBottom = '4px';
            div.style.color = color;
            div.innerHTML = `<span style="color:#6b7280;">[${log.time}]</span> ${icon} ${log.message}`;
            
            container.appendChild(div);
            
            // Auto-Scroll
            container.scrollTop = container.scrollHeight;
        }
        
        // Refresh Panel (bei Filter-Ã„nderung)
        function refreshDebugPanel() {
            const container = document.getElementById('debug-logs-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            debugPanelLogs.forEach(log => {
                addLogToPanel(log);
            });
        }
        
        // Panel verschiebbar machen
        document.addEventListener('DOMContentLoaded', () => {
            const panel = document.getElementById('debug-panel');
            const header = document.getElementById('debug-header');
            
            if (!panel || !header) return;
            
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            
            header.addEventListener('mousedown', (e) => {
                isDragging = true;
                initialX = e.clientX - panel.offsetLeft;
                initialY = e.clientY - panel.offsetTop;
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
                
                panel.style.left = currentX + 'px';
                panel.style.top = currentY + 'px';
                panel.style.right = 'auto'; // Remove right positioning
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
        });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ› INTEGRATION: Debug Logs in kritischen Funktionen
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Hook in book() Funktion
        const originalBook = window.book;
        if (originalBook) {
            window.book = async function() {
                debugLog('info', 'ğŸ“ Buchung gestartet');
                debugLog('info', `autoBookingEnabled: ${autoBookingEnabled}`);
                debugLog('info', `currentRideType: ${currentRideType}`);
                try {
                    const result = await originalBook.apply(this, arguments);
                    debugLog('info', 'âœ… Buchung erfolgreich');
                    return result;
                } catch (error) {
                    debugLog('error', `ğŸ’¾ Buchung fehlgeschlagen: ${error.message}`);
                    throw error;
                }
            };
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ¤– AI-ASSISTENT FUNKTIONEN (v5.62.0)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function analyzeBookingRequest() {
            // ğŸ†• v5.86.19: NULL-CHECK!
            const inputElement = document.getElementById('ai-input-text');
            
            if (!inputElement) {
                console.error('ğŸ’¾ AI-Input-Text Element nicht gefunden!');
                alert('ğŸ’¾ Fehler: Textarea nicht gefunden! Bitte Seite neu laden.');
                return;
            }
            
            const inputText = inputElement.value.trim();
            
            if (!inputText) {
                alert('ğŸ’¾ Bitte Text eingeben!');
                return;
            }
            
            // Zeige Loading
            const loadingEl = document.getElementById('ai-loading');
            const resultsEl = document.getElementById('ai-results');
            const analyzeBtn = document.getElementById('ai-analyze-btn');
            
            if (loadingEl) loadingEl.style.display = 'block';
            if (resultsEl) resultsEl.style.display = 'none';
            if (analyzeBtn) {
                analyzeBtn.disabled = true;
                analyzeBtn.style.opacity = '0.5';
            }
            
            console.log('ğŸ¤– Starte AI-Analyse...');
            
            try {
                // ğŸ¤– CLAUDE API CALL
                // ğŸ†• v5.63.2: CORS-Proxy fÃ¼r Browser-Zugriff + API-Key aus localStorage
                const apiKey = localStorage.getItem('anthropic_api_key');
                
                if (!apiKey) {
                    throw new Error('API-Key nicht konfiguriert! Bitte in Tab "ğŸ“¬ Anfragen" API-Key speichern.');
                }
                
                // ğŸŒ CORS-Proxy (temporÃ¤r fÃ¼r Tests - v5.64.0 wird Cloud Functions nutzen)
                const response = await fetch('https://corsproxy.io/?' + encodeURIComponent('https://api.anthropic.com/v1/messages'), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: `Du bist ein Taxi-Buchungs-Assistent fÃ¼r "Funk Taxi Heringsdorf". Analysiere folgende Nachricht und extrahiere die Buchungsdaten.

NACHRICHT:
${inputText}

HEUTE IST: ${new Date().toLocaleDateString('de-DE')} (${['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'][new Date().getDay()]})

WICHTIG:
- Datum/Zeit: Wenn "morgen" â†’ berechne morgiges Datum (heute ist ${new Date().toLocaleDateString('de-DE')})
- Wenn "heute" â†’ heutiges Datum
- Wenn nur Uhrzeit â†’ heute + Uhrzeit
- Wenn kein Datum/Zeit angegeben â†’ setze null
- Orte: Extrahiere ERSTE Adresse als pickup, LETZTE Adresse als destination
- Zwischenziele: Alle Adressen ZWISCHEN Start und Ziel â†’ schreibe in "notes"
- Besondere WÃ¼nsche: Kindersitz, Rollstuhl, GepÃ¤ck â†’ schreibe in "notes"
- Wenn Orte fehlen â†’ setze null
- Telefon: Im Format +49... (normalisiere deutsche Nummern)
- Name: Extrahiere wenn vorhanden, sonst null

WENN WICHTIGE DATEN FEHLEN:
- Setze fehlende Felder auf null
- Liste alle fehlenden PFLICHTFELDER in "missing" Array
- Generiere eine freundliche Nachfrage in "question"

PFLICHTFELDER: pickup, destination, datetime

ANTWORTE NUR MIT JSON (keine ErklÃ¤rungen, keine Markdown-Backticks):
{
  "datetime": "YYYY-MM-DDTHH:MM oder null",
  "pickup": "Abholort oder null",
  "destination": "Zielort oder null", 
  "passengers": 1,
  "name": "Name oder null",
  "phone": "+49... oder null",
  "notes": "Zwischenstopps, besondere WÃ¼nsche oder null",
  "missing": ["pickup", "destination"] oder [],
  "question": "Freundliche Nachfrage oder null"
}`
                        }]
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API-Fehler: ' + response.status);
                }
                
                const data = await response.json();
                console.log('ğŸ¤– API Response:', data);
                
                // Extrahiere JSON aus Antwort
                const textContent = data.content.find(c => c.type === 'text')?.text || '';
                console.log('ğŸ¤– Text Content:', textContent);
                
                // Parse JSON (entferne eventuelle Markdown-Backticks)
                let jsonText = textContent.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                const bookingData = JSON.parse(jsonText);
                
                console.log('ğŸ¤– Geparste Daten:', bookingData);
                
                // Zeige Ergebnisse
                displayAIResults(bookingData);
                
            } catch (error) {
                console.error('ğŸ’¾ AI-Analyse Fehler:', error);
                alert('ğŸ’¾ Fehler bei der Analyse: ' + error.message);
            } finally {
                // Verstecke Loading - mit null-checks!
                const loadingEl = document.getElementById('ai-loading');
                const analyzeBtn = document.getElementById('ai-analyze-btn');
                
                if (loadingEl) loadingEl.style.display = 'none';
                if (analyzeBtn) {
                    analyzeBtn.disabled = false;
                    analyzeBtn.style.opacity = '1';
                }
            }
        }
        
        // ğŸ†• v5.64.4: NACHFRAGE BEANTWORTEN
        async function analyzeFollowUpAnswer() {
            // ğŸ†• v5.86.19: NULL-CHECKS!
            const followUpEl = document.getElementById('ai-followup-answer');
            const originalEl = document.getElementById('ai-input-text');
            
            if (!followUpEl) {
                alert('ğŸ’¾ Fehler: Antwort-Feld nicht gefunden! Bitte Seite neu laden.');
                return;
            }
            
            const followUpText = followUpEl.value.trim();
            
            if (!followUpText) {
                alert('ğŸ’¾ Bitte Antwort eingeben!');
                return;
            }
            
            // Hole ursprÃ¼ngliche Nachricht
            const originalText = originalEl ? originalEl.value.trim() : '';
            
            // Hole aktuelle Formular-Daten (was schon erkannt wurde) - mit null-checks!
            const currentData = {
                datetime: document.getElementById('ai-booking-datetime')?.value || null,
                pickup: document.getElementById('ai-booking-pickup')?.value || null,
                destination: document.getElementById('ai-booking-destination')?.value || null,
                passengers: document.getElementById('ai-booking-passengers')?.value || 1,
                name: document.getElementById('ai-booking-name')?.value || null,
                phone: document.getElementById('ai-booking-phone')?.value || null
            };
            
            console.log('ğŸ”„ Analysiere Nachfrage-Antwort...');
            console.log('ğŸ“ UrsprÃ¼ngliche Nachricht:', originalText);
            console.log('ğŸ’¬ Antwort:', followUpText);
            console.log('ğŸ“± Aktuelle Daten:', currentData);
            
            // Zeige Loading
            const loadingEl = document.getElementById('ai-loading');
            if (loadingEl) loadingEl.style.display = 'block';
            
            const answerBtn = event.target;
            if (answerBtn) {
                answerBtn.disabled = true;
                answerBtn.style.opacity = '0.5';
            }
            
            try {
                const apiKey = localStorage.getItem('anthropic_api_key');
                
                if (!apiKey) {
                    throw new Error('API-Key nicht konfiguriert!');
                }
                
                const response = await fetch('https://corsproxy.io/?' + encodeURIComponent('https://api.anthropic.com/v1/messages'), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: `Du bist Taxi-Assistent. Ein Fahrgast hat unvollstÃ¤ndige Buchungsdaten gesendet, du hast nachgefragt, und jetzt hat er geantwortet.

URSPRÃœNGLICHE NACHRICHT:
"${originalText}"

BEREITS ERKANNTE DATEN:
${JSON.stringify(currentData, null, 2)}

ANTWORT DES FAHRGASTS:
"${followUpText}"

HEUTE IST: ${new Date().toLocaleDateString('de-DE')} (${['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'][new Date().getDay()]})

AUFGABE:
1. Analysiere die ANTWORT und extrahiere die fehlenden Informationen
2. MERGE mit den bereits erkannten Daten (Ã¼berschreibe NUR was neu angegeben wurde!)
3. Wenn immer noch Daten fehlen â†’ setze "missing" Array und "question"

ANTWORTE NUR MIT JSON (keine ErklÃ¤rungen):
{
  "datetime": "YYYY-MM-DDTHH:MM oder null",
  "pickup": "Abholort oder null",
  "destination": "Zielort oder null",
  "passengers": 1,
  "name": "Name oder null",
  "phone": "+49... oder null",
  "missing": [] oder ["field"],
  "question": "Weitere Nachfrage oder null"
}`
                        }]
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API-Fehler: ' + response.status);
                }
                
                const data = await response.json();
                const textContent = data.content.find(c => c.type === 'text')?.text || '';
                let jsonText = textContent.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                const updatedData = JSON.parse(jsonText);
                
                console.log('âœ… Aktualisierte Daten:', updatedData);
                
                // Zeige aktualisierte Ergebnisse
                displayAIResults(updatedData);
                
                // Success Toast
                const toast = document.createElement('div');
                toast.style.cssText = 'position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:15px 20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:99999;font-weight:600;';
                toast.innerHTML = 'âœ… Antwort analysiert!';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            } finally {
                document.getElementById('ai-loading').style.display = 'none';
                if (answerBtn) {
                    answerBtn.disabled = false;
                    answerBtn.style.opacity = '1';
                }
            }
        }
        
        function displayAIResults(data) {
            // ğŸ†• v5.86.16: WENN ALLE PFLICHTFELDER DA â†’ Ã–FFNE SCHNELLBUCHUNGS-MODAL!
            const hasMissing = data.missing && data.missing.length > 0;
            
            if (!hasMissing && data.pickup && data.destination && data.datetime) {
                // Alle Pflichtfelder vorhanden â†’ Ã–ffne Modal sofort!
                console.log('âœ… Alle Daten vollstÃ¤ndig â†’ Ã–ffne Schnellbuchungs-Modal!');
                
                // ğŸ†• v5.88.12: ERST Modal Ã¶ffnen, DANN Felder fÃ¼llen!
                openQuickBookingModal();
                
                // Kurz warten bis Modal gerendert ist
                setTimeout(() => {
                    // Splitte datetime in date und time
                    const [date, time] = data.datetime.split('T');
                    
                    // FÃ¼lle Quick-Booking Modal Felder aus (mit NULL-Checks!)
                    const dateEl = document.getElementById('quick-booking-date');
                    const timeEl = document.getElementById('quick-booking-time');
                    const pickupEl = document.getElementById('quick-booking-pickup');
                    const destEl = document.getElementById('quick-booking-destination');
                    const passengersEl = document.getElementById('quick-booking-passengers');
                    const notesEl = document.getElementById('quick-booking-notes');
                    const vehicleEl = document.getElementById('quick-booking-vehicle');
                    const customerEl = document.getElementById('quick-booking-customer');
                    const searchField = document.getElementById('quick-booking-customer-search');
                    
                    if (dateEl) dateEl.value = date;
                    if (timeEl) timeEl.value = time;
                    if (pickupEl) pickupEl.value = data.pickup;
                    if (destEl) destEl.value = data.destination;
                    if (passengersEl) passengersEl.value = data.passengers || 1;
                    if (notesEl) notesEl.value = data.notes && data.notes !== 'null' ? data.notes : '';
                    if (vehicleEl) vehicleEl.value = '';
                    if (customerEl) customerEl.value = '';
                    
                    // Kunde: Setze Suchfeld mit Name (wenn vorhanden)
                    if (searchField && data.name) {
                        searchField.value = data.name;
                    }
                    
                    // Telefonnummer fÃ¼r spÃ¤ter speichern
                    if (data.phone) {
                        window.aiBookingPhone = data.phone;
                    }
                    
                    // Geocode Adressen und speichere Koordinaten
                    (async () => {
                        try {
                            console.log('ğŸ” Geocode Adressen...');
                            
                            // Geocode Pickup
                            const pickupCoords = await geocode(data.pickup);
                            if (pickupCoords) {
                                window.qbPickupCoords = pickupCoords;
                                console.log('âœ… Pickup-Coords:', pickupCoords);
                            }
                            
                            // Geocode Destination
                            const destCoords = await geocode(data.destination);
                            if (destCoords) {
                                window.qbDestCoords = destCoords;
                                console.log('âœ… Dest-Coords:', destCoords);
                            }
                            
                        } catch (error) {
                            console.warn('âš ï¸ Geocoding-Fehler:', error);
                        }
                    })();
                    
                    console.log('âœ… Quick-Booking Modal gefÃ¼llt!');
                }, 100); // 100ms warten
                
                // Verstecke AI-Results
                const aiResults = document.getElementById('ai-results');
                if (aiResults) aiResults.style.display = 'none';
                
                return; // Fertig!
            }
            
            // FALLBACK: Fehlende Daten â†’ Zeige alte Anzeige
            // Zeige Results-Section
            document.getElementById('ai-results').style.display = 'block';
            
            let resultHTML = '';
            
            // Zeige Warning bei fehlenden Daten
            if (hasMissing) {
                const missingLabels = {
                    'pickup': 'Abholort',
                    'destination': 'Zielort',
                    'datetime': 'Datum/Zeit',
                    'name': 'Name',
                    'phone': 'Telefon'
                };
                
                const missingList = data.missing.map(field => missingLabels[field] || field).join(', ');
                
                resultHTML += `
                    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 24px;">âš ï¸</span>
                            <strong style="color: #856404;">UnvollstÃ¤ndige Daten!</strong>
                        </div>
                        <div style="color: #856404; margin-bottom: 10px;">
                            <strong>Es fehlt:</strong> ${missingList}
                        </div>
                        ${data.question ? `
                        <div style="background: white; border-radius: 6px; padding: 12px; border-left: 4px solid #ffc107; margin-bottom: 15px;">
                            <strong style="color: #856404;">ğŸ’¬ Nachfrage an Fahrgast:</strong><br>
                            <span style="color: #333; font-size: 15px;">"${data.question}"</span>
                        </div>
                        ` : ''}
                        
                        <!-- ğŸ†• v5.64.4: ANTWORT-FELD FÃœR PATRICK -->
                        <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 8px; padding: 15px; margin-top: 15px;">
                            <div style="font-weight: 600; color: #1565c0; margin-bottom: 10px;">
                                ğŸ’¬ Antwort vom Fahrgast (oder du fÃ¼llst manuell aus):
                            </div>
                            <textarea 
                                id="ai-followup-answer" 
                                placeholder='z.B.: "Von Bahnhof Heringsdorf, nach Ahlbeck, morgen 14 Uhr"'
                                style="width: 100%; padding: 12px; border: 2px solid #2196f3; border-radius: 6px; font-size: 14px; min-height: 80px; font-family: inherit; resize: vertical;"
                            ></textarea>
                            <button 
                                onclick="analyzeFollowUpAnswer()" 
                                style="
                                    margin-top: 10px;
                                    width: 100%;
                                    padding: 12px;
                                    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
                                    color: white;
                                    border: none;
                                    border-radius: 6px;
                                    font-weight: 600;
                                    cursor: pointer;
                                    font-size: 14px;
                                ">
                                ğŸ”„ Antwort analysieren
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // Zeige erkannte Daten
            resultHTML += `
                <div style="background: ${hasMissing ? '#f8f9fa' : 'white'}; border: 2px solid ${hasMissing ? '#dee2e6' : '#28a745'}; border-radius: 8px; padding: 15px;">
                    ${!hasMissing ? '<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;"><span style="font-size: 24px;">âœ…</span><strong style="color: #28a745;">Analyse erfolgreich!</strong></div>' : ''}
                    <div style="display: grid; gap: 8px;">
                        <div><strong>ğŸ“… Datum/Zeit:</strong> ${data.datetime ? formatDateTimeForDisplay(data.datetime) : '<span style="color: #dc3545;">ğŸ’¾ Fehlt</span>'}</div>
                        <div><strong>ğŸ“ Abholort:</strong> ${data.pickup || '<span style="color: #dc3545;">ğŸ’¾ Fehlt</span>'}</div>
                        <div><strong>ğŸ¯ Zielort:</strong> ${data.destination || '<span style="color: #dc3545;">ğŸ’¾ Fehlt</span>'}</div>
                        <div><strong>ğŸ‘¥ Personen:</strong> ${data.passengers || 1}</div>
                        <div><strong>ğŸ’¾ Name:</strong> ${data.name || '<span style="color: #999;">(nicht angegeben)</span>'}</div>
                        <div><strong>ğŸ’¾ Telefon:</strong> ${data.phone || '<span style="color: #999;">(nicht angegeben)</span>'}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('ai-analysis-result').innerHTML = resultHTML;
            
            // FÃ¼lle Formular (mit NULL-Check!)
            const datetimeEl = document.getElementById('ai-booking-datetime');
            const pickupEl = document.getElementById('ai-booking-pickup');
            const destEl = document.getElementById('ai-booking-destination');
            const passengersEl = document.getElementById('ai-booking-passengers');
            const nameEl = document.getElementById('ai-booking-name');
            const phoneEl = document.getElementById('ai-booking-phone');
            const notesEl = document.getElementById('ai-booking-notes');
            
            if (datetimeEl) datetimeEl.value = data.datetime || '';
            if (pickupEl) pickupEl.value = data.pickup || '';
            if (destEl) destEl.value = data.destination || '';
            if (passengersEl) passengersEl.value = data.passengers || 1;
            if (nameEl) nameEl.value = data.name || '';
            if (phoneEl) phoneEl.value = data.phone || '';
            if (notesEl) notesEl.value = data.notes && data.notes !== 'null' ? data.notes : '';
            
            // Auto-Preis berechnen (nur wenn Orte vorhanden)
            if (data.pickup && data.destination) {
                calculateAIPrice();
            } else {
                document.getElementById('ai-booking-price').textContent = '-- â‚¬';
            }
        }
        
        function formatDateTimeForDisplay(isoString) {
            if (!isoString) return '(nicht angegeben)';
            const date = new Date(isoString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}.${month}.${year} um ${hours}:${minutes} Uhr`;
        }
        
        
        // ğŸ¤– v5.64.33: Calculate Distance mit Geocoding fÃ¼r AI-Assistant
        async function calculateDistance(pickupAddress, destinationAddress) {
            try {
                // Geocode Abholort
                const pickupCoords = await geocode(pickupAddress);
                if (!pickupCoords) {
                    console.error('ğŸ’¾ Abholort nicht gefunden:', pickupAddress);
                    return null;
                }
                
                // Geocode Zielort
                const destCoords = await geocode(destinationAddress);
                if (!destCoords) {
                    console.error('ğŸ’¾ Zielort nicht gefunden:', destinationAddress);
                    return null;
                }
                
                // Berechne Route
                const route = await calculateRoute(pickupCoords, destCoords);
                
                if (!route || !route.distance) {
                    return null;
                }
                
                // Berechne Preis (mit aktuellem Zeitstempel fÃ¼r Tag/Nacht-Tarif)
                const pricing = calculatePrice(parseFloat(route.distance), Date.now());
                
                return {
                    distance: route.distance,
                    duration: route.duration,
                    price: pricing.total,
                    pickupCoords: pickupCoords,
                    destCoords: destCoords
                };
            } catch (error) {
                console.error('ğŸ’¾ Fehler bei calculateDistance:', error);
                return null;
            }
        }
        
        async function calculateAIPrice() {
            const pickup = document.getElementById('ai-booking-pickup').value.trim();
            const destination = document.getElementById('ai-booking-destination').value.trim();
            
            if (!pickup || !destination) {
                document.getElementById('ai-booking-price').textContent = '-- â‚¬';
                return;
            }
            
            try {
                // PrÃ¼fe ob Coords bereits vorhanden (aus Autocomplete)
                let result;
                if (window.aiBookingPickupCoords && window.aiBookingDestCoords) {
                    console.log('âœ… Verwende gespeicherte Coords aus Autocomplete');
                    // Berechne Route direkt mit Coords
                    const route = await calculateRoute(window.aiBookingPickupCoords, window.aiBookingDestCoords);
                    if (route && route.distance) {
                        const pricing = calculatePrice(parseFloat(route.distance), Date.now());
                        result = {
                            distance: route.distance,
                            duration: route.duration,
                            price: pricing.total,
                            pickupCoords: window.aiBookingPickupCoords,
                            destCoords: window.aiBookingDestCoords
                        };
                    }
                } else {
                    console.log('ğŸ” Keine Coords vorhanden, starte Geocoding...');
                    // Nutze calculateDistance mit Geocoding
                    result = await calculateDistance(pickup, destination);
                    
                    // ğŸ†• v5.86.22: SPEICHERE COORDS fÃ¼r spÃ¤tere Buchung!
                    if (result && result.pickupCoords && result.destCoords) {
                        window.aiBookingPickupCoords = result.pickupCoords;
                        window.aiBookingDestCoords = result.destCoords;
                        console.log('âœ… Coords gespeichert fÃ¼r Buchung:', {
                            pickup: window.aiBookingPickupCoords,
                            dest: window.aiBookingDestCoords
                        });
                    }
                }
                
                if (result && result.price) {
                    document.getElementById('ai-booking-price').textContent = parseFloat(result.price).toFixed(2) + ' â‚¬';
                } else {
                    document.getElementById('ai-booking-price').textContent = 'ğŸ’¾ Preis konnte nicht berechnet werden';
                }
            } catch (error) {
                console.error('Preis-Berechnung Fehler:', error);
                document.getElementById('ai-booking-price').textContent = 'ğŸ’¾ Fehler';
            }
        }
        
        // ğŸ†• v5.90.150: DIREKT BUCHEN AUS AI-ASSISTENT!
        async function createAndSubmitBookingFromAI() {
            console.log('ğŸ¤– v5.90.150: Direkt buchen aus AI-Assistent!');
            
            // Hole AI-Daten
            const datetimeEl = document.getElementById('ai-booking-datetime');
            const pickupEl = document.getElementById('ai-booking-pickup');
            const destEl = document.getElementById('ai-booking-destination');
            const passengersEl = document.getElementById('ai-booking-passengers');
            const nameEl = document.getElementById('ai-booking-name');
            const phoneEl = document.getElementById('ai-booking-phone');
            const notesEl = document.getElementById('ai-booking-notes');
            const priceEl = document.getElementById('ai-booking-price');
            
            if (!datetimeEl || !pickupEl || !destEl) {
                alert('ğŸ’¾ Fehler: Formular-Elemente nicht gefunden!');
                return;
            }
            
            const datetime = datetimeEl.value;
            const pickup = pickupEl.value.trim();
            const destination = destEl.value.trim();
            const passengers = parseInt(passengersEl?.value) || 1;
            const name = nameEl?.value.trim() || '';
            const phone = phoneEl?.value.trim() || '';
            const notes = notesEl?.value.trim() || '';
            const priceText = priceEl?.textContent || '-- â‚¬';
            
            // Validierung
            if (!datetime || !pickup || !destination) {
                alert('ğŸ’¾ Bitte alle Pflichtfelder ausfÃ¼llen!');
                return;
            }
            
            if (!name || !phone) {
                alert('ğŸ’¾ Bitte Name und Telefon angeben!');
                return;
            }
            
            if (!priceText || priceText.includes('ğŸ’¾') || priceText === '-- â‚¬') {
                alert('ğŸ’¾ Bitte erst Preis berechnen!');
                return;
            }
            
            // Parse Preis
            const price = parseFloat(priceText.replace('â‚¬', '').replace(',', '.').trim());
            
            // Parse datetime
            const [date, time] = datetime.split('T');
            const pickupTimestamp = new Date(datetime).getTime();
            
            console.log('ğŸ“ Erstelle Buchung:', {name, phone, pickup, destination, price, datetime});
            
            try {
                // 1. PrÃ¼fe/Erstelle Kunde
                let customerId = null;
                let customer = null;
                
                // Suche ob Kunde existiert
                const snapshot = await db.ref('customers').orderByChild('phone').equalTo(phone).once('value');
                
                if (snapshot.exists()) {
                    // Kunde existiert
                    snapshot.forEach(child => {
                        if (!customerId) {
                            customerId = child.key;
                            customer = child.val();
                        }
                    });
                    console.log('âœ… Bestehender Kunde gefunden:', customerId);
                } else {
                    // Erstelle neuen Kunden
                    const newCustomerRef = db.ref('customers').push();
                    customerId = newCustomerRef.key;
                    
                    customer = {
                        name: name,
                        phone: phone,
                        address: pickup, // Abholort als Adresse
                        email: '',
                        createdAt: Date.now(),
                        lastRide: pickupTimestamp
                    };
                    
                    await newCustomerRef.set(customer);
                    console.log('âœ… Neuer Kunde erstellt:', customerId);
                }
                
                // 2. Erstelle Fahrt
                const rideRef = db.ref('rides').push();
                const rideId = rideRef.key;
                
                const ride = {
                    customerName: name,
                    customerId: customerId,
                    phone: phone,
                    pickup: pickup,
                    destination: destination,
                    pickupTimestamp: pickupTimestamp,
                    date: date,
                    time: time,
                    passengers: passengers,
                    price: price,
                    notes: notes,
                    status: 'scheduled',
                    createdAt: Date.now(),
                    createdBy: currentUser?.email || 'AI-Assistent',
                    source: 'ai-assistant'
                };
                
                // Koordinaten hinzufÃ¼gen falls vorhanden
                if (window.aiBookingPickupCoords) {
                    ride.pickupCoords = window.aiBookingPickupCoords;
                }
                if (window.aiBookingDestCoords) {
                    ride.destCoords = window.aiBookingDestCoords;
                }
                
                await rideRef.set(ride);
                console.log('âœ… Fahrt erstellt:', rideId);
                
                // 3. Success!
                showToast('âœ… Buchung erfolgreich im Kalender eingetragen!', 'success');
                
                // 4. Reset AI-Assistent
                clearAIAssistant();
                
                // 5. Wechsle zum Kalender
                setTimeout(() => {
                    switchView('calendar');
                }, 1000);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Buchen:', error);
                alert('ğŸ’¾ Fehler beim Buchen: ' + error.message);
            }
        }
        
        async function createBookingFromAI() {
            // Hole AI-Daten (mit NULL-Checks!)
            const datetimeEl = document.getElementById('ai-booking-datetime');
            const pickupEl = document.getElementById('ai-booking-pickup');
            const destEl = document.getElementById('ai-booking-destination');
            const passengersEl = document.getElementById('ai-booking-passengers');
            const nameEl = document.getElementById('ai-booking-name');
            const phoneEl = document.getElementById('ai-booking-phone');
            const notesEl = document.getElementById('ai-booking-notes');
            const priceEl = document.getElementById('ai-booking-price');
            
            if (!datetimeEl || !pickupEl || !destEl) {
                alert('ğŸ’¾ Fehler: Formular-Elemente nicht gefunden! Bitte Seite neu laden.');
                return;
            }
            
            const datetime = datetimeEl.value;
            const pickup = pickupEl.value.trim();
            const destination = destEl.value.trim();
            const passengers = parseInt(passengersEl?.value) || 1;
            const name = nameEl?.value.trim() || '';
            const phone = phoneEl?.value.trim() || '';
            const notes = notesEl?.value.trim() || '';
            const priceText = priceEl?.textContent || '-- â‚¬';
            
            // Validierung
            if (!datetime || !pickup || !destination) {
                alert('ğŸ’¾ Bitte alle Pflichtfelder ausfÃ¼llen!');
                return;
            }
            
            if (!name || !phone) {
                alert('ğŸ’¾ Bitte Name und Telefon angeben!');
                return;
            }
            
            if (!priceText || priceText.includes('ğŸ’¾') || priceText === '-- â‚¬') {
                alert('ğŸ’¾ Bitte erst Preis berechnen!');
                return;
            }
            
            console.log('ğŸ¤– AI-Buchung Ã¶ffnet Schnellbuchungs-Modal...');
            
            try {
                // ğŸ†• v5.86.23: Ã–FFNE MODAL STATT DIREKT ZU BUCHEN!
                
                // 1. Ã–ffne Schnellbuchungs-Modal
                await openQuickBookingModal();
                
                // 2. Warte bis Modal existiert
                const dateField = await waitForElement('quick-booking-date');
                
                if (!dateField) {
                    alert('ğŸ’¾ Fehler: Schnellbuchungs-Modal konnte nicht geladen werden!');
                    return;
                }
                
                // 3. FÃ¼lle alle Felder aus
                
                // Splitte datetime in date und time
                const [date, time] = datetime.split('T');
                document.getElementById('quick-booking-date').value = date;
                document.getElementById('quick-booking-time').value = time;
                
                // FÃ¼lle Adressfelder
                document.getElementById('quick-booking-pickup').value = pickup;
                document.getElementById('quick-booking-destination').value = destination;
                
                // Koordinaten Ã¼bertragen
                if (window.aiBookingPickupCoords) {
                    window.qbPickupCoords = window.aiBookingPickupCoords;
                    console.log('âœ… AI Pickup-Coords Ã¼bertragen:', window.qbPickupCoords);
                }
                if (window.aiBookingDestCoords) {
                    window.qbDestCoords = window.aiBookingDestCoords;
                    console.log('âœ… AI Dest-Coords Ã¼bertragen:', window.qbDestCoords);
                }
                
                // Weitere Felder
                document.getElementById('quick-booking-passengers').value = passengers;
                document.getElementById('quick-booking-notes').value = notes;
                document.getElementById('quick-booking-vehicle').value = ''; // Kein Fahrzeug vorgewÃ¤hlt
                
                // Kunde: Setze Suchfeld mit Name
                const searchField = document.getElementById('quick-booking-customer-search');
                if (searchField) {
                    searchField.value = name;
                }
                
                // Wichtig: customerId leer lassen, damit neuer Kunde erstellt wird
                document.getElementById('quick-booking-customer').value = '';
                
                // Speichere Telefonnummer fÃ¼r spÃ¤ter (submitQuickBooking wird sie nutzen)
                window.aiBookingPhone = phone;
                
                // 4. Zeige Success-Message
                showToast('ğŸ“‹ Daten Ã¼bernommen! PrÃ¼fe und klicke "Buchen"', 'success');
                
                console.log('âœ… Schnellbuchungs-Modal mit AI-Daten gefÃ¼llt!');
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Ã–ffnen des Modals:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        function clearAIAssistant() {
            // ğŸ†• v5.88.15: KOMPLETT RESET - alles lÃ¶schen!
            
            // Textarea leeren
            const inputText = document.getElementById('ai-input-text');
            if (inputText) inputText.value = '';
            
            // Screenshot-Preview lÃ¶schen
            const screenshotPreview = document.getElementById('ai-screenshot-preview');
            if (screenshotPreview) {
                screenshotPreview.style.display = 'none';
                screenshotPreview.innerHTML = '';
            }
            
            // Screenshot-Input zurÃ¼cksetzen
            const screenshotInput = document.getElementById('ai-screenshot-input');
            if (screenshotInput) screenshotInput.value = '';
            
            // Analyse-Ergebnisse verstecken
            const results = document.getElementById('ai-results');
            if (results) results.style.display = 'none';
            
            const analysisResult = document.getElementById('ai-analysis-result');
            if (analysisResult) analysisResult.innerHTML = '';
            
            // Alle Formular-Felder leeren
            const datetime = document.getElementById('ai-booking-datetime');
            const pickup = document.getElementById('ai-booking-pickup');
            const destination = document.getElementById('ai-booking-destination');
            const passengers = document.getElementById('ai-booking-passengers');
            const name = document.getElementById('ai-booking-name');
            const phone = document.getElementById('ai-booking-phone');
            const notes = document.getElementById('ai-booking-notes');
            const price = document.getElementById('ai-booking-price');
            
            if (datetime) datetime.value = '';
            if (pickup) pickup.value = '';
            if (destination) destination.value = '';
            if (passengers) passengers.value = '1';
            if (name) name.value = '';
            if (phone) phone.value = '';
            if (notes) notes.value = '';
            if (price) price.textContent = '-- â‚¬';
            
            // Globale AI-Variablen zurÃ¼cksetzen
            window.aiBookingPhone = null;
            
            // Loading-Anzeige verstecken
            const loading = document.getElementById('ai-loading');
            if (loading) loading.style.display = 'none';
            
            // Analyze-Button wieder aktivieren
            const analyzeBtn = document.getElementById('ai-analyze-btn');
            if (analyzeBtn) {
                analyzeBtn.disabled = false;
                analyzeBtn.style.opacity = '1';
            }
            
            console.log('ğŸ—‘ï¸ AI-Assistent komplett zurÃ¼ckgesetzt!');
            showToast('âœ… AI-Assistent zurÃ¼ckgesetzt!');
        }
        
        function loadAIExample(exampleNum) {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toLocaleDateString('de-DE');
            
            const examples = {
                1: `Guten Tag,

ich mÃ¶chte ein Taxi fÃ¼r morgen (${tomorrowStr}) um 14:30 Uhr buchen.

Abholung: Bahnhof Heringsdorf
Ziel: Strandhotel Ahlbeck
2 Personen

Mit freundlichen GrÃ¼ÃŸen
Maria Schmidt
+49 170 1234827`,
                2: `Hi, brauche Taxi am 15.12. um 10:00 Uhr

Flughafen abholen
Nach: Hotel Kaiserhof, Bansin
4 Personen mit GepÃ¤ck

Peter Hansen
Tel: +49 175 9876543`
            };
            
            document.getElementById('ai-input-text').value = examples[exampleNum] || '';
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.63.0: BUCHUNGSANFRAGEN-SYSTEM (Telegram-Bot fÃ¼r FahrgÃ¤ste)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // API-Key speichern
        function saveAnthropicAPIKey() {
            const apiKey = document.getElementById('anthropic-api-key').value.trim();
            
            if (!apiKey) {
                alert('ğŸ’¾ Bitte API-Key eingeben!');
                return;
            }
            
            if (!apiKey.startsWith('sk-ant-api')) {
                alert('ğŸ’¾ UngÃ¼ltiger API-Key!\n\nAnthrop API-Keys beginnen mit: sk-ant-api03-...');
                return;
            }
            
            // Speichere in localStorage
            localStorage.setItem('anthropic_api_key', apiKey);
            
            // Update Status
            updateAPIKeyStatus();
            
            alert('âœ… API-Key gespeichert!\n\nDu kannst jetzt Telegram-Nachrichten analysieren lassen.');
            
            console.log('âœ… Anthropic API-Key gespeichert');
        }
        
        // ğŸ†• v5.64.7: API-KEY ANZEIGEN/VERSTECKEN
        function toggleAPIKeyVisibility() {
            const keyInput = document.getElementById('anthropic-api-key');
            const toggleBtn = document.getElementById('toggle-key-btn');
            
            if (keyInput.type === 'password') {
                keyInput.type = 'text';
                toggleBtn.textContent = 'ğŸ™ˆ'; // "Verstecken"
                console.log('ğŸ‘ï¸ API-Key angezeigt');
            } else {
                keyInput.type = 'password';
                toggleBtn.textContent = 'ğŸ‘ï¸'; // "Anzeigen"
                console.log('ğŸ™ˆ API-Key versteckt');
            }
        }
        
        // ğŸ†• v5.64.7: API-KEY KOPIEREN
        function copyAPIKey() {
            const apiKey = localStorage.getItem('anthropic_api_key');
            
            if (!apiKey) {
                alert('ğŸ’¾ Kein API-Key gespeichert!');
                return;
            }
            
            // In Zwischenablage kopieren
            navigator.clipboard.writeText(apiKey).then(() => {
                // Success Toast
                const toast = document.createElement('div');
                toast.style.cssText = 'position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:15px 20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:99999;font-weight:600;';
                toast.innerHTML = 'âœ… API-Key kopiert!';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
                
                console.log('ğŸ“‹ API-Key in Zwischenablage kopiert');
            }).catch(err => {
                console.error('ğŸ’¾ Kopieren fehlgeschlagen:', err);
                
                // Fallback: Manuell in Alert zeigen
                alert('ğŸ’¾ Automatisches Kopieren fehlgeschlagen!\n\nKey:\n' + apiKey + '\n\n(Manuell kopieren)');
            });
        }
        
        // API-Key Status anzeigen
        function updateAPIKeyStatus() {
            const apiKey = localStorage.getItem('anthropic_api_key');
            const statusText = document.getElementById('api-key-status-text');
            const keyInput = document.getElementById('anthropic-api-key');
            
            if (apiKey) {
                statusText.textContent = 'âœ… Konfiguriert';
                statusText.style.color = '#10b981';
                keyInput.value = apiKey;
            } else {
                statusText.textContent = 'ğŸ’¾ Nicht konfiguriert';
                statusText.style.color = '#ef4444';
            }
        }
        
        // Telegram-Nachricht testen
        async function testTelegramMessage() {
            const message = document.getElementById('test-telegram-message').value.trim();
            const resultDiv = document.getElementById('test-result');
            const testBtn = document.getElementById('test-telegram-btn');
            
            if (!message) {
                alert('ğŸ’¾ Bitte Nachricht eingeben!');
                return;
            }
            
            // PrÃ¼fe API-Key
            const apiKey = localStorage.getItem('anthropic_api_key');
            if (!apiKey) {
                alert('ğŸ’¾ Bitte zuerst API-Key konfigurieren!');
                return;
            }
            
            // Zeige Loading
            testBtn.disabled = true;
            testBtn.textContent = 'ğŸ”„ Analysiere...';
            testBtn.style.opacity = '0.5';
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div style="background: #f9fafb; border-radius: 8px; padding: 20px; text-align: center;">
                    <div style="font-size: 32px; margin-bottom: 10px; animation: pulse 1.5s infinite;">ğŸ¤–</div>
                    <div style="font-size: 14px; color: #6b7280; font-weight: 600;">Claude analysiert die Nachricht...</div>
                </div>
            `;
            
            try {
                console.log('ğŸ¤– Starte Nachrichtenanalyse...');
                
                // Claude API Call
                // ğŸŒ CORS-Proxy (temporÃ¤r fÃ¼r Tests - v5.64.0 wird Cloud Functions nutzen)
                const response = await fetch('https://corsproxy.io/?' + encodeURIComponent('https://api.anthropic.com/v1/messages'), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: `Du bist ein Taxi-Buchungs-Assistent fÃ¼r "Funk Taxi Heringsdorf". Analysiere folgende Nachricht und extrahiere die Buchungsdaten.

NACHRICHT:
${message}

HEUTE IST: ${new Date().toLocaleDateString('de-DE')} (${['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'][new Date().getDay()]})

WICHTIG:
- Datum/Zeit: Wenn "morgen" â†’ berechne morgiges Datum (heute ist ${new Date().toLocaleDateString('de-DE')})
- Wenn "heute" â†’ heutiges Datum
- Wenn nur Uhrzeit â†’ heute + Uhrzeit
- Wenn kein Datum/Zeit angegeben â†’ setze null
- Orte: Extrahiere ERSTE Adresse als pickup, LETZTE Adresse als destination
- Zwischenziele: Alle Adressen ZWISCHEN Start und Ziel â†’ schreibe in "notes"
- Besondere WÃ¼nsche: Kindersitz, Rollstuhl, GepÃ¤ck â†’ schreibe in "notes"
- Wenn Orte fehlen â†’ setze null
- Telefon: Im Format +49... (normalisiere deutsche Nummern)
- Name: Extrahiere wenn vorhanden, sonst null

WENN WICHTIGE DATEN FEHLEN:
- Setze fehlende Felder auf null
- Liste alle fehlenden PFLICHTFELDER in "missing" Array
- Generiere eine freundliche Nachfrage in "question"

PFLICHTFELDER: pickup, destination, datetime

ANTWORTE NUR MIT JSON (keine ErklÃ¤rungen, keine Markdown-Backticks):
{
  "datetime": "YYYY-MM-DDTHH:MM oder null",
  "pickup": "Abholort oder null",
  "destination": "Zielort oder null",
  "passengers": 1,
  "name": "Name oder null",
  "phone": "+49... oder null",
  "notes": "Zwischenstopps, besondere WÃ¼nsche oder null",
  "missing": ["pickup", "destination"] oder [],
  "question": "Freundliche Nachfrage oder null"
}`
                        }]
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API-Fehler: ${response.status} - ${errorData.error?.message || 'Unbekannt'}`);
                }
                
                const data = await response.json();
                console.log('ğŸ¤– API Response:', data);
                
                // Extrahiere JSON aus Antwort
                const textContent = data.content.find(c => c.type === 'text')?.text || '';
                console.log('ğŸ¤– Text Content:', textContent);
                
                // Parse JSON (entferne eventuelle Markdown-Backticks)
                let jsonText = textContent.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                const bookingData = JSON.parse(jsonText);
                
                console.log('ğŸ¤– Geparste Daten:', bookingData);
                
                // Zeige Ergebnis
                displayTestResult(bookingData, message);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler bei Analyse:', error);
                
                resultDiv.innerHTML = `
                    <div style="background: #fef2f2; border: 2px solid #fecaca; border-radius: 8px; padding: 20px;">
                        <div style="font-size: 16px; font-weight: 700; color: #991b1b; margin-bottom: 10px;">
                            ğŸ’¾ Fehler bei der Analyse
                        </div>
                        <div style="font-size: 14px; color: #7f1d1d;">
                            ${error.message}
                        </div>
                        ${error.message.includes('401') ? `
                            <div style="margin-top: 10px; padding: 10px; background: #fef3c7; border-radius: 6px; font-size: 12px; color: #92400e;">
                                ğŸ’¡ <strong>Tipp:</strong> API-Key Ã¼berprÃ¼fen und neu speichern
                            </div>
                        ` : ''}
                    </div>
                `;
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'ğŸ” Nachricht analysieren';
                testBtn.style.opacity = '1';
            }
        }
        
        // Test-Ergebnis anzeigen
        // Globale Variable fÃ¼r Test-Buchungsdaten
        let currentTestBookingData = null;
        
        function displayTestResult(data, originalMessage) {
            const resultDiv = document.getElementById('test-result');
            
            // Speichere Daten global fÃ¼r Button
            currentTestBookingData = data;
            
            // PrÃ¼fe ob wichtige Daten fehlen
            const hasMissing = data.missing && data.missing.length > 0;
            
            let html = '';
            
            // Zeige Warning bei fehlenden Daten
            if (hasMissing) {
                const missingLabels = {
                    'pickup': 'Abholort',
                    'destination': 'Zielort',
                    'datetime': 'Datum/Zeit',
                    'name': 'Name',
                    'phone': 'Telefon'
                };
                
                const missingList = data.missing.map(field => missingLabels[field] || field).join(', ');
                
                html += `
                    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <div style="font-size: 16px; font-weight: 700; color: #856404; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">âš ï¸</span>
                            UnvollstÃ¤ndige Daten!
                        </div>
                        
                        <div style="color: #856404; margin-bottom: 15px;">
                            <strong>Es fehlt:</strong> ${missingList}
                        </div>
                        
                        ${data.question ? `
                        <div style="background: white; border-radius: 6px; padding: 15px; border-left: 4px solid #ffc107; margin-bottom: 15px;">
                            <div style="font-size: 13px; font-weight: 600; color: #856404; margin-bottom: 8px;">
                                ğŸ’¬ Empfohlene Nachfrage an Fahrgast:
                            </div>
                            <div style="font-size: 15px; color: #333;">
                                "${data.question}"
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="padding: 12px; background: #fef3c7; border-radius: 6px; border: 1px solid #fbbf24;">
                            <div style="font-size: 13px; font-weight: 600; color: #78350f; margin-bottom: 8px;">
                                ğŸ’¡ Was erkannt wurde:
                            </div>
                            <div style="display: grid; gap: 8px; font-size: 13px; color: #78350f;">
                                ${data.datetime ? `<div>ğŸ“… Datum/Zeit: ${new Date(data.datetime).toLocaleString('de-DE')}</div>` : '<div>ğŸ’¾ Datum/Zeit: Nicht angegeben</div>'}
                                ${data.pickup ? `<div>ğŸ“ Von: ${data.pickup}</div>` : '<div>ğŸ’¾ Von: Nicht angegeben</div>'}
                                ${data.destination ? `<div>ğŸ¯ Nach: ${data.destination}</div>` : '<div>ğŸ’¾ Nach: Nicht angegeben</div>'}
                                ${data.passengers ? `<div>ğŸ‘¥ Personen: ${data.passengers}</div>` : ''}
                                ${data.name ? `<div>ğŸ’¾ Name: ${data.name}</div>` : ''}
                                ${data.phone ? `<div>ğŸ’¾ Telefon: ${data.phone}</div>` : ''}
                                ${data.notes && data.notes !== 'null' ? `<div>ğŸ“ Notizen: ${data.notes}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Parse datetime
                const datetime = new Date(data.datetime);
                const dateStr = datetime.toLocaleDateString('de-DE', { 
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const timeStr = datetime.toLocaleTimeString('de-DE', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                html += `
                    <div style="background: #f0fdf4; border: 2px solid #86efac; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <div style="font-size: 16px; font-weight: 700; color: #065f46; margin-bottom: 15px;">
                            âœ… Analyse erfolgreich!
                        </div>
                        
                        <div style="display: grid; gap: 12px;">
                            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 8px;">
                                <div style="font-weight: 600; color: #048257;">ğŸ“… Datum:</div>
                                <div>${dateStr}</div>
                            </div>
                            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 8px;">
                                <div style="font-weight: 600; color: #048257;">ğŸ• Uhrzeit:</div>
                                <div>${timeStr} Uhr</div>
                            </div>
                            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 8px;">
                                <div style="font-weight: 600; color: #048257;">ğŸ“ Von:</div>
                                <div>${data.pickup}</div>
                            </div>
                            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 8px;">
                                <div style="font-weight: 600; color: #048257;">ğŸ¯ Nach:</div>
                                <div>${data.destination}</div>
                            </div>
                            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 8px;">
                                <div style="font-weight: 600; color: #048257;">ğŸ‘¥ Personen:</div>
                                <div>${data.passengers}</div>
                            </div>
                            ${data.name ? `
                                <div style="display: grid; grid-template-columns: 120px 1fr; gap: 8px;">
                                    <div style="font-weight: 600; color: #048257;">ğŸ’¾ Name:</div>
                                    <div>${data.name}</div>
                                </div>
                            ` : ''}
                            ${data.phone ? `
                                <div style="display: grid; grid-template-columns: 120px 1fr; gap: 8px;">
                                    <div style="font-weight: 600; color: #048257;">ğŸ’¾ Telefon:</div>
                                    <div>${data.phone}</div>
                                </div>
                            ` : ''}
                            ${data.notes && data.notes !== 'null' ? `
                                <div style="display: grid; grid-template-columns: 120px 1fr; gap: 8px;">
                                    <div style="font-weight: 600; color: #048257;">ğŸ“ Notizen:</div>
                                    <div>${data.notes}</div>
                                </div>
                            ` : ''}
                        </div>
                `;
            }
            
            // UrsprÃ¼ngliche Nachricht (immer anzeigen)
            html += `
                        <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 6px; border: 1px solid ${hasMissing ? '#fbbf24' : '#d1fae5'};">
                            <div style="font-size: 13px; font-weight: 600; color: ${hasMissing ? '#78350f' : '#065f46'}; margin-bottom: 8px;">
                                ğŸ’¬ UrsprÃ¼ngliche Nachricht:
                            </div>
                            <div style="font-size: 12px; color: ${hasMissing ? '#78350f' : '#048257'}; white-space: pre-wrap; font-family: monospace;">
                                ${originalMessage}
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            ${!hasMissing ? `
                            <button onclick="createBookingFromTest()" style="
                                flex: 1;
                                padding: 12px;
                                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                                color: white;
                                border: none;
                                border-radius: 8px;
                                font-size: 14px;
                                font-weight: 700;
                                cursor: pointer;
                            ">
                                âœ… Buchung erstellen
                            </button>
                            ` : `
                            <div style="flex: 1; padding: 12px; background: #f3f4f6; color: #6b7280; border: 2px dashed #d1d5db; border-radius: 8px; font-size: 13px; text-align: center;">
                                âš ï¸ Buchung nicht mÃ¶glich - es fehlen wichtige Daten
                            </div>
                            `}
                            <button onclick="document.getElementById('test-result').style.display='none'" style="
                                padding: 12px 20px;
                                background: #f3f4f6;
                                color: #6b7280;
                                border: none;
                                border-radius: 8px;
                                font-size: 14px;
                                font-weight: 600;
                                cursor: pointer;
                            ">
                                SchlieÃŸen
                            </button>
                        </div>
                    </div>
            `;
            
            resultDiv.innerHTML = html;
        }
        
        // Buchung aus Test erstellen
        async function createBookingFromTest() {
            const data = currentTestBookingData;
            if (!data) {
                console.error('Keine Buchungsdaten verfÃ¼gbar!');
                return;
            }
            
            // Validierung
            if (!data.datetime || !data.pickup || !data.destination) {
                alert('ğŸ’¾ Bitte alle Pflichtfelder ausfÃ¼llen!');
                return;
            }
            
            if (!data.name || !data.phone) {
                alert('ğŸ’¾ Bitte Name und Telefon angeben!');
                return;
            }
            
            // Confirm-Nachricht zusammenbauen
            let confirmMsg = 'âœ… Buchung erstellen?\n\n';
            confirmMsg += 'ğŸ“… ' + new Date(data.datetime).toLocaleString('de-DE') + '\n';
            confirmMsg += 'ğŸ“ ' + data.pickup + ' â†’ ' + data.destination + '\n';
            confirmMsg += 'ğŸ‘¥ ' + data.passengers + ' Person(en)';
            
            if (data.notes && data.notes !== 'null') {
                confirmMsg += '\nğŸ“ ' + data.notes;
            }
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            try {
                // Berechne Distanz
                const distanceResult = await calculateDistance(data.pickup, data.destination);
                
                if (!distanceResult) {
                    throw new Error('Distanz konnte nicht berechnet werden');
                }
                
                // Erstelle Ride-Objekt
                const rideId = 'ride_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const rideData = {
                    id: rideId,
                    customerId: 'ai_customer_' + Date.now(),
                    customerName: data.name,
                    customerPhone: data.phone,
                    pickup: data.pickup,
                    destination: data.destination,
                    datetime: data.datetime,
                    passengers: data.passengers,
                    price: distanceResult.price || 0,
                    distance: distanceResult.distance || 0,
                    duration: distanceResult.duration || 0,
                    notes: data.notes || null,
                    status: 'vorbestellt',
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser ? currentUser.uid : 'ai_assistant',
                    bookingType: 'ai_assistant'
                };
                
                console.log('ğŸ¤– Erstelle Buchung:', rideData);
                
                // Speichere in Firebase
                await db.ref('rides/' + rideId).set(rideData);
                
                alert('âœ… Buchung erfolgreich erstellt!');
                
                // Wechsle zu Fahrplan
                switchView('fahrplan');
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Erstellen der Buchung:', error);
                alert('ğŸ’¾ Fehler beim Erstellen der Buchung:\n\n' + error.message);
            }
        }
        
        // Beim Laden der View: API-Key Status prÃ¼fen
        document.addEventListener('DOMContentLoaded', () => {
            // Update API-Key Status wenn View gewechselt wird
            const originalSwitchView = window.switchView;
            window.switchView = function(view) {
                originalSwitchView(view);
                if (view === 'booking-requests') {
                    updateAPIKeyStatus();
                }
            };
        });
        
        // ğŸ†• v5.86.18: ENTER-KEY FÃœR SUCHE
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('ride-id-search');
            if (searchInput) {
                searchInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault(); // Verhindere Form-Submit
                        intelligentSearch();
                    }
                });
                console.log('âœ… Enter-Key fÃ¼r Suche aktiviert');
            }
        });
        
        // ğŸ†• v5.90.135: TOUCH-EVENTS FÃœR ZEIT-BUTTONS (MOBILE FIX!)
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ”§ v5.90.135: Installiere Touch-Events fÃ¼r Zeit-Buttons...');
            
            // Zeit-Display Button
            const timeDisplayBtn = document.getElementById('time-display-btn');
            if (timeDisplayBtn) {
                timeDisplayBtn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    console.log('ğŸ‘† Zeit-Display Button Touch!');
                    openTimeKeypadForBooking();
                });
                console.log('âœ… Touch-Events fÃ¼r time-display-btn hinzugefÃ¼gt');
            } else {
                console.log('âš ï¸ time-display-btn nicht gefunden');
            }
            
            // Suche auch andere Zeit-Buttons
            const timeButtons = document.querySelectorAll('button[onclick*="openTimeKeypad"]');
            console.log(`ğŸ” Gefunden: ${timeButtons.length} Zeit-Buttons`);
            timeButtons.forEach((btn, index) => {
                btn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    console.log(`ğŸ‘† Zeit-Button ${index} Touch!`);
                    openTimeKeypadForBooking();
                });
            });
            console.log('âœ… Touch-Events fÃ¼r alle Zeit-Buttons installiert');
        });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ’¾ FRITZBOX CALL POPUP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // ğŸ†• v5.87.67: CallPopup Listener mit MASSIVEM DEBUG-LOGGING!
        function initCallPopupListener() {
            console.log('ğŸ” initCallPopupListener() aufgerufen!');
            console.log('ğŸ” isFirebaseReady:', isFirebaseReady);
            console.log('ğŸ” db:', typeof db);
            
            if (!isFirebaseReady) {
                console.error('ğŸ’¾ Firebase not ready for CallPopup listener');
                return;
            }
            
            console.log('ğŸ’¾ Initialisiere CallPopup Listener...');
            console.log('ğŸ’¾ Registriere Firebase Listener auf: callPopup');
            
            db.ref('callPopup').on('value', snapshot => {
                console.log('ğŸ”¥ FIREBASE EVENT GETRIGGERT!');
                console.log('ğŸ”¥ snapshot:', snapshot);
                
                const data = snapshot.val();
                console.log('ğŸ”¥ data:', data);
                
                if (!data) {
                    console.log('âš ï¸ Keine Daten in callPopup (null)');
                    return;
                }
                
                console.log('ğŸ’¾ ANRUF EMPFANGEN!', data);
                console.log('ğŸ’¾ Rufe showCallPopup() auf...');
                
                // Zeige Popup
                try {
                    showCallPopup(data);
                    console.log('âœ… showCallPopup() erfolgreich!');
                } catch (err) {
                    console.error('ğŸ’¾ Fehler in showCallPopup():', err);
                }
                
                // ğŸ†• v5.87.64: AUTO-DELETE nach 2 Sekunden (wie in alter funktionierender Version!)
                // Damit wird verhindert dass beim Page-Reload alte Anrufe nochmal angezeigt werden
                console.log('â±ï¸ Auto-Delete in 2 Sekunden...');
                setTimeout(() => {
                    db.ref('callPopup').remove();
                    console.log('ğŸ—‘ï¸ callPopup gelÃ¶scht!');
                }, 2000);
            });
            
            console.log('âœ… CallPopup Listener aktiv');
        }
        
        // ğŸ†• v5.87.68: TEST-LOG - Funktion wurde definiert!
        console.log('âœ… initCallPopupListener() Funktion definiert! (v5.87.68)');
        
        function showCallPopup(data) {
            console.log('ğŸ¯ showCallPopup() gestartet!');
            console.log('ğŸ¯ data:', data);
            
            const { type, caller, called, timestamp, customer, lastRides } = data;
            console.log('ğŸ¯ type:', type);
            console.log('ğŸ¯ caller:', caller);
            console.log('ğŸ¯ customer:', customer);
            
            // Erstelle Popup HTML
            let popupHTML = `
                <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s;" id="call-popup">
                    <div style="background:white;border-radius:16px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.4);animation:slideUp 0.3s;">
                        
                        <!-- Header -->
                        <div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;border-radius:16px 16px 0 0;">
                            <div style="display:flex;align-items:center;justify-content:space-between;">
                                <div style="display:flex;align-items:center;gap:12px;">
                                    <div style="font-size:40px;">ğŸ’¾</div>
                                    <div>
                                        <div style="font-size:24px;font-weight:700;">Eingehender Anruf</div>
                                        <div style="font-size:14px;opacity:0.9;">${new Date(timestamp).toLocaleString('de-DE')}</div>
                                    </div>
                                </div>
                                <button onclick="closeCallPopup()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:40px;height:40px;border-radius:50%;cursor:pointer;font-size:24px;display:flex;align-items:center;justify-content:center;">Ã—</button>
                            </div>
                        </div>
                        
                        <!-- Body -->
                        <div style="padding:24px;">
                            <div style="margin-bottom:20px;padding:16px;background:#f3f4f6;border-radius:12px;">
                                <div style="font-size:14px;color:#6b7280;margin-bottom:4px;">Anrufer</div>
                                <div style="font-size:24px;font-weight:700;color:#1f2937;">${caller}</div>
                            </div>
            `;
            
            if (type === 'existing' && customer) {
                // BEKANNTER KUNDE
                popupHTML += `
                    <div style="background:#d1fae5;padding:16px;border-radius:12px;margin-bottom:20px;border:2px solid #10b981;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                            <span style="font-size:24px;">âœ…</span>
                            <span style="font-size:18px;font-weight:700;color:#065f46;">Bekannter Kunde</span>
                        </div>
                        
                        <div style="margin-bottom:12px;">
                            <div style="font-size:24px;font-weight:700;color:#048257;">${customer.name || 'Kein Name'}</div>
                            ${customer.address ? `<div style="font-size:14px;color:#065f46;margin-top:4px;">ğŸ“ ${customer.address}</div>` : ''}
                            ${customer.email ? `<div style="font-size:14px;color:#065f46;margin-top:4px;">ğŸ“§ ${customer.email}</div>` : ''}
                        </div>
                        
                        ${lastRides && lastRides.length > 0 ? `
                            <div style="margin-top:16px;padding-top:16px;border-top:2px solid #10b981;">
                                <div style="font-weight:600;color:#065f46;margin-bottom:8px;">ğŸš• Letzte Fahrten:</div>
                                ${lastRides.slice(0, 3).map(ride => `
                                    <div style="background:white;padding:8px;border-radius:6px;margin-bottom:6px;font-size:13px;">
                                        <div style="font-weight:600;">${ride.pickup || 'Unbekannt'} â†’ ${ride.destination || 'Unbekannt'}</div>
                                        <div style="color:#6b7280;font-size:12px;">${new Date(ride.timestamp).toLocaleDateString('de-DE')}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Buttons -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                        <button onclick="callCustomer('${caller}')" style="background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;padding:16px;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(59,130,246,0.3);">
                            ğŸ’¾ ZurÃ¼ckrufen
                        </button>
                        <button onclick="openQuickBookingWithCustomer('${customer.id}')" style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:16px;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(16,185,129,0.3);">
                            ğŸš• Neue Fahrt buchen
                        </button>
                    </div>
                    <button onclick="closeCallPopup()" style="width:100%;background:#f3f4f6;color:#1f2937;padding:16px;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;margin-top:12px;">
                        SchlieÃŸen
                    </button>
                `;
            } else {
                // NEUER KUNDE
                popupHTML += `
                    <div style="background:#fef3c7;padding:16px;border-radius:12px;margin-bottom:20px;border:2px solid #f59e0b;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                            <span style="font-size:24px;">âš ï¸</span>
                            <span style="font-size:18px;font-weight:700;color:#92400e;">Neuer Kunde</span>
                        </div>
                        <div style="color:#92400e;">Diese Nummer ist noch nicht in der Datenbank.</div>
                    </div>
                    
                    <!-- Kunde erfassen -->
                    <div style="background:#f9fafb;padding:16px;border-radius:12px;margin-bottom:20px;">
                        <div style="font-weight:600;margin-bottom:12px;color:#1f2937;">Kundendaten erfassen:</div>
                        
                        <div style="margin-bottom:12px;">
                            <label style="display:block;font-size:14px;color:#6b7280;margin-bottom:4px;">Name</label>
                            <input type="text" id="new-customer-name" placeholder="Max Mustermann" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;">
                        </div>
                        
                        <div style="margin-bottom:12px;">
                            <label style="display:block;font-size:14px;color:#6b7280;margin-bottom:4px;">Adresse</label>
                            <input type="text" id="new-customer-address" placeholder="MusterstraÃŸe 1, 17424 Heringsdorf" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;">
                        </div>
                        
                        <div style="margin-bottom:12px;">
                            <label style="display:block;font-size:14px;color:#6b7280;margin-bottom:4px;">E-Mail (optional)</label>
                            <input type="email" id="new-customer-email" placeholder="max@example.com" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;">
                        </div>
                    </div>
                    
                    <!-- Buttons -->
                    <div style="display:flex;gap:12px;flex-wrap:wrap;">
                        <button onclick="saveNewCustomerAndBook('${caller}')" style="flex:1;min-width:140px;background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:16px;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(245,158,11,0.3);">
                            ğŸ’¾ Speichern & Fahrt buchen
                        </button>
                        <button onclick="quickBookFromCall('${caller}')" style="flex:1;min-width:140px;background:linear-gradient(135deg,#10b981,#059669);color:white;padding:16px;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(16,185,129,0.3);">
                            âš¡ Schnellbuchung
                        </button>
                        <button onclick="closeCallPopup()" style="flex:1;min-width:140px;background:#f3f4f6;color:#1f2937;padding:16px;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;">
                            SpÃ¤ter
                        </button>
                    </div>
                `;
            }
            
            popupHTML += `
                        </div>
                    </div>
                </div>
                
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideUp {
                        from { transform: translateY(50px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                    
                    @keyframes slideIn {
                        from { transform: translateX(400px); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(400px); opacity: 0; }
                    }
                </style>
            `;
            
            // FÃ¼ge Popup ins DOM ein
            const existingPopup = document.getElementById('call-popup');
            if (existingPopup) existingPopup.remove();
            
            document.body.insertAdjacentHTML('beforeend', popupHTML);
            
            // Sound abspielen (optional)
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGGS56+mcTgwOUKXh8LhlHAU5kdPyynkrBSR3yO/ekj8JFFyx6OmnUxMJQ5/e8rxrIAUrlM/ y2Yg1Bxhju+rqm0wLDU+k4O+7aRsFOZDT8sp4KgUjdsju35NAChNYr+jprFQUCj+c3vC6aB8FKpHP8tmINQcXYrvo7aVPDAxPo+Duu2gaBTiPz/LKdyoEI3bI7+CSQAoTVq3n7axUFAk9mt7wuWgfBSmRz/HajDQHF2K7+eetShALPp/d8cxwJwUdhcXy146RQQoRUarnr6pTEQo7mN3wuGYeCCWPz/HajDQHFl+65+OkSxALO5zd8ctwJwUdhsTy156QQQoQT6nm8KlRFA');
                audio.volume = 0.3;
                audio.play().catch(() => {}); // Ignore errors
            } catch (e) {}
            
            console.log('âœ… CallPopup angezeigt!');
        }
        
        function closeCallPopup() {
            const popup = document.getElementById('call-popup');
            if (popup) popup.remove();
            
            // âœ… v5.84.0: LÃ¶sche Firebase Event
            db.ref('callPopup').remove();
            console.log('âœ… CallPopup Event gelÃ¶scht');
        }
        
        // ğŸ†• v5.88.25: SCHNELLBUCHUNG DIREKT VOM ANRUF
        async function quickBookFromCall(phone) {
            console.log('âš¡ Schnellbuchung von Anruf:', phone);
            
            // Popup schlieÃŸen
            closeCallPopup();
            
            // Hole Name aus Eingabefeld falls vorhanden
            const nameInput = document.getElementById('new-customer-name');
            const guestName = nameInput ? nameInput.value.trim() : '';
            
            // Erstelle temporÃ¤ren Kunden mit der Telefonnummer
            const tempCustomer = {
                name: guestName || 'Neuer Kunde',
                phone: phone,
                isNew: true
            };
            
            // Ã–ffne Schnellbuchung mit diesem Kunden
            await openQuickBookingModal(tempCustomer);
            
            // Wenn Gastname eingegeben wurde, fÃ¼lle es ins Gastname-Feld
            setTimeout(() => {
                if (guestName) {
                    const guestNameField = document.getElementById('quick-booking-guest-name');
                    if (guestNameField) {
                        guestNameField.value = guestName;
                        console.log('âœ… Gastname Ã¼bertragen:', guestName);
                    }
                }
                
                // Fokus auf Abholort setzen fÃ¼r schnelle Eingabe
                const pickupField = document.getElementById('quick-booking-pickup');
                if (pickupField) {
                    pickupField.focus();
                }
            }, 300);
            
            console.log('âœ… Schnellbuchung geÃ¶ffnet mit Telefon:', phone);
        }
        
        // ğŸ†• v5.83.0: FRITZBOX CLICK-TO-CALL (aus Firebase Settings)
        
        // FritzBox Config (wird aus Firebase geladen)
        let FRITZBOX_CONFIG = {
            enabled: false,
            host: 'fritz.box',
            port: 49000,
            username: '',
            password: '',
            phone: '**610',
            protocol: 'http'
        };
        
        // Lade FritzBox Settings aus Firebase
        async function loadFritzBoxSettings() {
            try {
                const snapshot = await db.ref('settings/fritzbox').once('value');
                
                if (!snapshot.exists()) {
                    // ğŸ†• v5.83.1: ERSTES MAL! Auto-Init mit Patricks Daten!
                    console.log('ğŸ“ Keine Settings gefunden â†’ Auto-Init!');
                    
                    const defaultSettings = {
                        enabled: true,
                        host: 'fritz.box',
                        port: 49000,
                        username: 'fritz8845',
                        password: '1vo@12052010',
                        phone: '**610',
                        protocol: 'http'
                    };
                    
                    // Speichere in Firebase
                    await db.ref('settings/fritzbox').set(defaultSettings);
                    console.log('âœ… FritzBox Settings automatisch initialisiert!');
                    
                    FRITZBOX_CONFIG = defaultSettings;
                    updateFritzBoxSettingsUI();
                    
                    return;
                }
                
                // Lade existierende Settings
                const settings = snapshot.val();
                
                if (settings) {
                    FRITZBOX_CONFIG = {
                        enabled: settings.enabled || false,
                        host: settings.host || 'fritz.box',
                        port: settings.port || 49000,
                        username: settings.username || '',
                        password: settings.password || '',
                        phone: settings.phone || '**610',
                        protocol: settings.protocol || 'http'
                    };
                    
                    console.log('âœ… FritzBox Settings geladen:', {
                        ...FRITZBOX_CONFIG,
                        password: '***'  // Passwort nicht loggen
                    });
                    
                    // Update UI (falls Settings-Tab geÃ¶ffnet)
                    updateFritzBoxSettingsUI();
                }
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der FritzBox Settings:', error);
            }
        }
        
        // Speichere FritzBox Settings in Firebase
        async function saveFritzBoxSettings() {
            try {
                const settings = {
                    enabled: document.getElementById('fritzbox-enabled').checked,
                    host: document.getElementById('fritzbox-host').value || 'fritz.box',
                    port: parseInt(document.getElementById('fritzbox-port').value) || 49000,
                    username: document.getElementById('fritzbox-username').value || '',
                    password: document.getElementById('fritzbox-password').value || '',
                    phone: document.getElementById('fritzbox-phone').value || '**610',
                    protocol: 'http'
                };
                
                // Speichere in Firebase
                await db.ref('settings/fritzbox').set(settings);
                
                // Update lokale Config
                FRITZBOX_CONFIG = settings;
                
                console.log('âœ… FritzBox Settings gespeichert!');
                alert('âœ… Einstellungen gespeichert!\n\nClick-to-Call ist jetzt ' + 
                      (settings.enabled ? 'aktiviert' : 'deaktiviert') + '.');
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Speichern:', error);
                alert('ğŸ’¾ Fehler beim Speichern der FritzBox-Einstellungen!');
            }
        }
        
        // ğŸ†• v5.88.0: 50/50 TAXI-TICKET MV FUNKTIONEN
        
        // Speichere 50/50 Einstellungen
        function saveFiftyFiftySettings() {
            const enabled = document.getElementById('fifty-fifty-system-enabled')?.checked || false;
            localStorage.setItem('fiftyFiftyEnabled', enabled ? 'true' : 'false');
            console.log('ğŸ« 50/50 System:', enabled ? 'AKTIVIERT' : 'DEAKTIVIERT');
            
            // Sofort UI aktualisieren
            checkFiftyFiftyAvailability();
            
            // ğŸ†• v5.88.5: Toast-Meldung
            showToast(enabled ? 'âœ… 50/50 Ticket aktiviert!' : 'ğŸ’¾ 50/50 Ticket deaktiviert!');
        }
        
        // Lade 50/50 Einstellungen
        function loadFiftyFiftySettings() {
            const checkbox = document.getElementById('fifty-fifty-system-enabled');
            if (checkbox) {
                checkbox.checked = localStorage.getItem('fiftyFiftyEnabled') === 'true';
            }
        }
        
        // PrÃ¼ft ob 50/50 System aktiviert ist
        function isFiftyFiftySystemEnabled() {
            return localStorage.getItem('fiftyFiftyEnabled') === 'true';
        }
        
        // PrÃ¼ft ob 50/50 gerade gÃ¼ltig ist (Fr/Sa 20-08 Uhr + Feiertage)
        function isFiftyFiftyTime() {
            const now = new Date();
            const day = now.getDay(); // 0=So, 5=Fr, 6=Sa
            const hour = now.getHours();
            
            // Silvester Sonderregel: 31.12. 20:00 bis 01.01. 12:00
            const month = now.getMonth(); // 0=Jan, 11=Dez
            const date = now.getDate();
            
            // 31.12. ab 20 Uhr
            if (month === 11 && date === 31 && hour >= 20) return true;
            // 01.01. bis 12 Uhr
            if (month === 0 && date === 1 && hour < 12) return true;
            
            // Freitag 20-24 Uhr
            if (day === 5 && hour >= 20) return true;
            // Samstag 0-8 Uhr
            if (day === 6 && hour < 8) return true;
            // Samstag 20-24 Uhr
            if (day === 6 && hour >= 20) return true;
            // Sonntag 0-8 Uhr
            if (day === 0 && hour < 8) return true;
            
            // Feiertage prÃ¼fen
            if (isFiftyFiftyHoliday(now, hour)) return true;
            
            return false;
        }
        
        // PrÃ¼ft ob Feiertag (Bund + MV) 
        function isFiftyFiftyHoliday(date, hour) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const day = date.getDate();
            
            // Feste Feiertage (Monat 0-basiert)
            const fixedHolidays = [
                { m: 0, d: 1 },    // Neujahr
                { m: 2, d: 8 },    // ğŸ†• Internationaler Frauentag (MV seit 2023!)
                { m: 4, d: 1 },    // Tag der Arbeit
                { m: 9, d: 3 },    // Tag der Deutschen Einheit
                { m: 9, d: 31 },   // Reformationstag (MV!)
                { m: 11, d: 25 },  // 1. Weihnachtstag
                { m: 11, d: 26 },  // 2. Weihnachtstag
            ];
            
            // Bewegliche Feiertage berechnen (Ostern-basiert)
            const easter = calculateEaster(year);
            const movingHolidays = [
                addDays(easter, -2),   // Karfreitag
                addDays(easter, 1),    // Ostermontag
                addDays(easter, 39),   // Christi Himmelfahrt
                addDays(easter, 50),   // Pfingstmontag
            ];
            
            // PrÃ¼fe ob HEUTE ein Feiertag ist (dann gilt 20-08 Uhr)
            const isHolidayToday = fixedHolidays.some(h => h.m === month && h.d === day) ||
                                   movingHolidays.some(h => h.getMonth() === month && h.getDate() === day);
            
            if (isHolidayToday && hour >= 20) return true;
            
            // PrÃ¼fe ob GESTERN ein Feiertag war (dann gilt bis 08 Uhr)
            const yesterday = new Date(date);
            yesterday.setDate(yesterday.getDate() - 1);
            const yMonth = yesterday.getMonth();
            const yDay = yesterday.getDate();
            
            const wasHolidayYesterday = fixedHolidays.some(h => h.m === yMonth && h.d === yDay) ||
                                        movingHolidays.some(h => h.getMonth() === yMonth && h.getDate() === yDay);
            
            if (wasHolidayYesterday && hour < 8) return true;
            
            // PrÃ¼fe ob MORGEN ein Feiertag ist (dann gilt Vorabend ab 20 Uhr)
            const tomorrow = new Date(date);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tMonth = tomorrow.getMonth();
            const tDay = tomorrow.getDate();
            
            const isHolidayTomorrow = fixedHolidays.some(h => h.m === tMonth && h.d === tDay) ||
                                      movingHolidays.some(h => h.getMonth() === tMonth && h.getDate() === tDay);
            
            if (isHolidayTomorrow && hour >= 20) return true;
            
            return false;
        }
        
        // Berechne Ostersonntag (Gauss-Algorithmus)
        function calculateEaster(year) {
            const a = year % 19;
            const b = Math.floor(year / 100);
            const c = year % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const month = Math.floor((h + l - 7 * m + 114) / 31) - 1;
            const day = ((h + l - 7 * m + 114) % 31) + 1;
            return new Date(year, month, day);
        }
        
        // Hilfsfunktion: Tage addieren
        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }
        
        // Zeigt 50/50 Section wenn Zeitfenster passt UND System aktiviert ist
        function checkFiftyFiftyAvailability() {
            const section = document.getElementById('fifty-fifty-section');
            if (section) {
                // PrÃ¼fe ob System aktiviert UND Zeitfenster passt
                if (isFiftyFiftySystemEnabled() && isFiftyFiftyTime()) {
                    section.style.display = 'block';
                    console.log('ğŸ« 50/50 Ticket verfÃ¼gbar (System AN + Fr/Sa 20-08 Uhr)');
                } else {
                    section.style.display = 'none';
                    // Reset wenn nicht verfÃ¼gbar
                    const checkbox = document.getElementById('fifty-fifty-enabled');
                    if (checkbox) checkbox.checked = false;
                    
                    if (!isFiftyFiftySystemEnabled()) {
                        console.log('ğŸ« 50/50 Ticket: System DEAKTIVIERT');
                    } else {
                        console.log('ğŸ« 50/50 Ticket: AuÃŸerhalb Zeitfenster');
                    }
                }
            }
        }
        
        // Toggle 50/50 Details
        function toggleFiftyFifty() {
            const checkbox = document.getElementById('fifty-fifty-enabled');
            const details = document.getElementById('fifty-fifty-details');
            
            if (checkbox && details) {
                details.style.display = checkbox.checked ? 'block' : 'none';
                
                if (checkbox.checked) {
                    // PrÃ¼fe sofort wenn Geburtsdatum schon eingegeben
                    validateFiftyFifty();
                } else {
                    // Reset Preis-Anzeige
                    updatePriceWithFiftyFifty(false);
                }
            }
        }
        
        // Validiert Alter fÃ¼r 50/50
        function validateFiftyFifty() {
            const birthdateInput = document.getElementById('fifty-fifty-birthdate');
            const statusDiv = document.getElementById('fifty-fifty-status');
            
            if (!birthdateInput || !birthdateInput.value) {
                statusDiv.innerHTML = 'âš ï¸ Bitte Geburtsdatum eingeben';
                statusDiv.style.background = '#fef3c7';
                statusDiv.style.color = '#92400e';
                updatePriceWithFiftyFifty(false);
                return false;
            }
            
            const birthdate = new Date(birthdateInput.value);
            const today = new Date();
            let age = today.getFullYear() - birthdate.getFullYear();
            const monthDiff = today.getMonth() - birthdate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthdate.getDate())) {
                age--;
            }
            
            if (age >= 16 && age <= 25) {
                statusDiv.innerHTML = 'âœ… Berechtigt! Du bist ' + age + ' Jahre alt - Preis wird halbiert!';
                statusDiv.style.background = '#d1fae5';
                statusDiv.style.color = '#065f46';
                updatePriceWithFiftyFifty(true);
                return true;
            } else if (age < 16) {
                statusDiv.innerHTML = 'ğŸ’¾ Du bist ' + age + ' Jahre - Mindestalter ist 16 Jahre';
                statusDiv.style.background = '#fee2e2';
                statusDiv.style.color = '#991b1b';
                updatePriceWithFiftyFifty(false);
                return false;
            } else {
                statusDiv.innerHTML = 'ğŸ’¾ Du bist ' + age + ' Jahre - HÃ¶chstalter ist 25 Jahre';
                statusDiv.style.background = '#fee2e2';
                statusDiv.style.color = '#991b1b';
                updatePriceWithFiftyFifty(false);
                return false;
            }
        }
        
        // Aktualisiert Preisanzeige mit 50/50
        function updatePriceWithFiftyFifty(enabled) {
            const priceDisplay = document.getElementById('calculated-price');
            if (!priceDisplay) return;
            
            const originalPrice = window.currentPrice || 0;
            
            if (enabled && originalPrice > 0) {
                const halfPrice = (originalPrice / 2).toFixed(2);
                priceDisplay.innerHTML = `
                    <span style="text-decoration:line-through;color:#9ca3af;font-size:16px;">${originalPrice.toFixed(2)}â‚¬</span>
                    <span style="color:#059669;font-weight:700;font-size:24px;margin-left:10px;">${halfPrice}â‚¬</span>
                    <span style="background:#fbbf24;color:#78350f;padding:2px 8px;border-radius:12px;font-size:11px;margin-left:8px;">50/50 ğŸ«</span>
                `;
                window.fiftyFiftyActive = true;
                window.fiftyFiftyPrice = parseFloat(halfPrice);
            } else {
                if (originalPrice > 0) {
                    priceDisplay.innerHTML = originalPrice.toFixed(2) + 'â‚¬';
                }
                window.fiftyFiftyActive = false;
                window.fiftyFiftyPrice = null;
            }
        }
        
        // PrÃ¼fe 50/50 alle 5 Minuten (falls sich Zeit Ã¤ndert)
        setInterval(checkFiftyFiftyAvailability, 5 * 60 * 1000);
        
        // Initial prÃ¼fen wenn Seite lÃ¤dt
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(checkFiftyFiftyAvailability, 2000);
            // Setze Default-Datumsbereich fÃ¼r Export (aktueller Monat)
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            
            const fromInput = document.getElementById('fifty-fifty-export-from');
            const toInput = document.getElementById('fifty-fifty-export-to');
            if (fromInput) fromInput.value = getLocalDateString(firstDay);  // ğŸ”§ v5.90.353: LOKAL!
            if (toInput) toInput.value = getLocalDateString(lastDay);  // ğŸ”§ v5.90.353: LOKAL!
            
            // Lade Stats nach kurzer VerzÃ¶gerung
            setTimeout(loadFiftyFiftyStats, 3000);
            
            // ğŸ†• v5.90.24: WHATSAPP-STYLE ZEIT AKTIVIEREN
            setTimeout(setupWhatsAppTimeInputs, 1000);
        });
        
        // ğŸ†• v5.90.24: WHATSAPP-STYLE ZEIT - MINUTEN AUF :00 BEI STUNDEN-WECHSEL
        function setupWhatsAppTimeInputs() {
            const timeInputs = document.querySelectorAll('input[type="time"], input[type="datetime-local"]');
            
            timeInputs.forEach(input => {
                // Verhindere doppelte Listener
                if (input.dataset.whatsappTime) return;
                input.dataset.whatsappTime = 'true';
                
                let lastHour = null;
                
                input.addEventListener('input', function(e) {
                    const value = this.value;
                    if (!value) return;
                    
                    let currentHour, currentMinute;
                    
                    if (this.type === 'datetime-local') {
                        const parts = value.split('T');
                        if (parts.length === 2) {
                            const timePart = parts[1];
                            [currentHour, currentMinute] = timePart.split(':');
                        }
                    } else if (this.type === 'time') {
                        [currentHour, currentMinute] = value.split(':');
                    }
                    
                    // Wenn Stunde geÃ¤ndert â†’ Minuten auf :00
                    if (lastHour !== null && currentHour !== lastHour) {
                        console.log('â° Stunde geÃ¤ndert:', lastHour, 'â†’', currentHour, 'â†’ Setze :00');
                        
                        if (this.type === 'datetime-local') {
                            const datePart = value.split('T')[0];
                            this.value = `${datePart}T${currentHour}:00`;
                        } else if (this.type === 'time') {
                            this.value = `${currentHour}:00`;
                        }
                    }
                    
                    lastHour = currentHour;
                });
                
                input.addEventListener('focus', function() {
                    const value = this.value;
                    if (!value) return;
                    
                    if (this.type === 'datetime-local') {
                        const parts = value.split('T');
                        if (parts.length === 2) {
                            lastHour = parts[1].split(':')[0];
                        }
                    } else if (this.type === 'time') {
                        lastHour = value.split(':')[0];
                    }
                });
            });
            
            console.log('âœ… WhatsApp-Style Zeit aktiviert fÃ¼r', timeInputs.length, 'Inputs');
        }
        
        // Reaktiviere wenn DOM sich Ã¤ndert (z.B. Modals) - THROTTLED!
        let timeObserverTimeout = null;
        const timeObserver = new MutationObserver(() => {
            // Throttle: Nur alle 500ms
            if (timeObserverTimeout) return;
            timeObserverTimeout = setTimeout(() => {
                setupWhatsAppTimeInputs();
                timeObserverTimeout = null;
            }, 500);
        });
        timeObserver.observe(document.body, { childList: true, subtree: true });
        
        // Lade 50/50 Statistik
        async function loadFiftyFiftyStats() {
            const statsDiv = document.getElementById('fifty-fifty-stats');
            if (!statsDiv) return;
            
            // Check ob Firebase bereit ist
            if (!db || typeof isFirebaseReady === 'undefined' || !isFirebaseReady) {
                console.log('âš ï¸ Firebase nicht bereit fÃ¼r 50/50 Stats');
                return;
            }
            
            try {
                const snapshot = await db.ref('rides').orderByChild('fiftyFifty/enabled').equalTo(true).once('value');
                const rides = snapshot.val() || {};
                
                let totalRides = 0;
                let totalLandMV = 0;
                
                Object.values(rides).forEach(ride => {
                    if (ride.fiftyFifty && ride.fiftyFifty.enabled) {
                        totalRides++;
                        totalLandMV += parseFloat(ride.fiftyFifty.landMVAnteil || 0);
                    }
                });
                
                statsDiv.innerHTML = `
                    ğŸ“± <strong>${totalRides}</strong> Fahrten mit 50/50 Ticket<br>
                    ğŸ’° <strong>${totalLandMV.toFixed(2)}â‚¬</strong> Erstattung vom Land MV
                `;
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der 50/50 Stats:', error);
                statsDiv.innerHTML = 'ğŸ’¾ Fehler beim Laden';
            }
        }
        
        // Export 50/50 Abrechnung als CSV
        async function exportFiftyFiftyReport() {
            if (!isFirebaseReady) {
                alert('ğŸ’¾ Firebase nicht verbunden!');
                return;
            }
            
            const fromDate = document.getElementById('fifty-fifty-export-from')?.value;
            const toDate = document.getElementById('fifty-fifty-export-to')?.value;
            
            if (!fromDate || !toDate) {
                alert('ğŸ’¾ Bitte Zeitraum auswÃ¤hlen!');
                return;
            }
            
            const fromTimestamp = new Date(fromDate).getTime();
            const toTimestamp = new Date(toDate + 'T23:59:59').getTime();
            
            try {
                const snapshot = await db.ref('rides').once('value');
                const allRides = snapshot.val() || {};
                
                // Filtere 50/50 Fahrten im Zeitraum
                const fiftyFiftyRides = [];
                
                Object.entries(allRides).forEach(([id, ride]) => {
                    if (ride.fiftyFifty && ride.fiftyFifty.enabled) {
                        const rideTime = ride.pickupTimestamp || ride.createdAt;
                        if (rideTime >= fromTimestamp && rideTime <= toTimestamp) {
                            fiftyFiftyRides.push({ id, ...ride });
                        }
                    }
                });
                
                if (fiftyFiftyRides.length === 0) {
                    alert('â„¹ï¸ Keine 50/50 Fahrten im gewÃ¤hlten Zeitraum gefunden.');
                    return;
                }
                
                // Erstelle CSV
                let csv = 'Datum;Uhrzeit;Kunde;Geburtsdatum;Von;Nach;Strecke (km);Gesamtpreis;Kunde zahlte;Erstattung Land MV\n';
                
                let totalErstattung = 0;
                
                fiftyFiftyRides.forEach(ride => {
                    const date = new Date(ride.pickupTimestamp || ride.createdAt);
                    const dateStr = date.toLocaleDateString('de-DE');
                    const timeStr = date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    const birthdate = ride.fiftyFifty.birthdate || '';
                    const originalPrice = parseFloat(ride.fiftyFifty.originalPrice || 0).toFixed(2);
                    const discountedPrice = parseFloat(ride.fiftyFifty.discountedPrice || 0).toFixed(2);
                    const landMVAnteil = parseFloat(ride.fiftyFifty.landMVAnteil || 0).toFixed(2);
                    
                    totalErstattung += parseFloat(landMVAnteil);
                    
                    csv += `${dateStr};${timeStr};${ride.customerName || 'Unbekannt'};${birthdate};${ride.pickup || ''};${ride.destination || ''};${ride.distance || ''};${originalPrice}â‚¬;${discountedPrice}â‚¬;${landMVAnteil}â‚¬\n`;
                });
                
                csv += '\n';
                csv += `;;;;;;;;;SUMME ERSTATTUNG:;${totalErstattung.toFixed(2)}â‚¬\n`;
                csv += '\n';
                csv += `Funk Taxi Heringsdorf - 50/50 Abrechnung ${fromDate} bis ${toDate}\n`;
                csv += `Erstellt am: ${new Date().toLocaleString('de-DE')}\n`;
                
                // Download
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `50-50-Abrechnung_${fromDate}_bis_${toDate}.csv`;
                link.click();
                URL.revokeObjectURL(url);
                
                alert(`âœ… Export erfolgreich!\n\nğŸ“± ${fiftyFiftyRides.length} Fahrten\nğŸ’° ${totalErstattung.toFixed(2)}â‚¬ Erstattung\n\nDatei wurde heruntergeladen.`);
                
            } catch (error) {
                console.error('ğŸ’¾ Export-Fehler:', error);
                alert('ğŸ’¾ Fehler beim Export: ' + error.message);
            }
        }
        
        // ğŸ†• v5.87.94: SMS EINSTELLUNGEN - SEPARAT SCHALTBAR
        function saveSMSSettings() {
            const bookingEnabled = document.getElementById('sms-booking-enabled')?.checked || false;
            const trackingEnabled = document.getElementById('sms-tracking-enabled')?.checked || false;
            
            // ğŸ†• v5.88.9: Speichere in FIREBASE statt localStorage!
            if (isFirebaseReady) {
                db.ref('settings/sms').set({
                    bookingEnabled: bookingEnabled,
                    trackingEnabled: trackingEnabled,
                    updatedAt: Date.now()
                }).then(() => {
                    console.log('ğŸ“± SMS in Firebase gespeichert - Buchung:', bookingEnabled, '| Tracking:', trackingEnabled);
                    showToast('âœ… SMS-Einstellungen gespeichert!');
                }).catch(err => {
                    console.error('ğŸ’¾ SMS-Speichern Fehler:', err);
                    showToast('ğŸ’¾ Fehler beim Speichern!');
                });
            } else {
                console.error('ğŸ’¾ Firebase nicht bereit');
                showToast('ğŸ’¾ Firebase nicht verbunden!');
            }
        }
        
        // ğŸ†• v5.88.9: Lade SMS Settings aus FIREBASE
        function loadSMSSettings() {
            if (!isFirebaseReady) {
                console.log('âš ï¸ Firebase nicht bereit fÃ¼r SMS-Settings');
                return;
            }
            
            db.ref('settings/sms').once('value').then(snapshot => {
                const settings = snapshot.val() || {};
                const bookingCheckbox = document.getElementById('sms-booking-enabled');
                const trackingCheckbox = document.getElementById('sms-tracking-enabled');
                
                if (bookingCheckbox) {
                    bookingCheckbox.checked = settings.bookingEnabled === true;
                }
                if (trackingCheckbox) {
                    trackingCheckbox.checked = settings.trackingEnabled === true;
                }
                console.log('ğŸ“± SMS-Settings aus Firebase geladen:', settings);
            }).catch(err => {
                console.error('ğŸ’¾ SMS-Settings laden Fehler:', err);
            });
        }
        
        // Test: BuchungsbestÃ¤tigung
        async function testSMSBooking() {
            const testPhone = prompt('ğŸ“± Test BUCHUNGS-SMS senden an:\n\n(Format: 0171xxxxxxx)');
            if (!testPhone) return;
            
            let formattedPhone = testPhone.replace(/[\s\-\/\(\)]/g, '');
            if (formattedPhone.startsWith('0')) {
                formattedPhone = '49' + formattedPhone.substring(1);
            } else if (formattedPhone.startsWith('+')) {
                formattedPhone = formattedPhone.substring(1);
            }
            
            const testMessage = 'âœ… Taxi bestÃ¤tigt!\n24.12. 14:00\nStrandstr. 5 â†’ Bahnhof\n15â‚¬\nFunk Taxi 038378/22022';
            
            await sendTestSMS(formattedPhone, testMessage, 'Buchung');
        }
        
        // Test: Tracking-SMS
        async function testSMSTracking() {
            const testPhone = prompt('ğŸ“± Test MAP-NULL-CHECK-FIX-SMS senden an:\n\n(Format: 0171xxxxxxx)');
            if (!testPhone) return;
            
            let formattedPhone = testPhone.replace(/[\s\-\/\(\)]/g, '');
            if (formattedPhone.startsWith('0')) {
                formattedPhone = '49' + formattedPhone.substring(1);
            } else if (formattedPhone.startsWith('+')) {
                formattedPhone = formattedPhone.substring(1);
            }
            
            const trackingLink = window.location.origin + window.location.pathname + '?ride=TEST123';
            const testMessage = 'ğŸš• Ihr Taxi ist unterwegs!\nAnkunft in ca. 5 Min.\nLive verfolgen:\n' + trackingLink;
            
            await sendTestSMS(formattedPhone, testMessage, 'Tracking');
        }
        
        // ğŸ†• v5.87.99: INTELLIGENTER TEST - sendet was aktiviert ist!
        async function testSMSActive() {
            const bookingEnabled = document.getElementById('sms-booking-enabled')?.checked;
            const trackingEnabled = document.getElementById('sms-tracking-enabled')?.checked;
            
            if (!bookingEnabled && !trackingEnabled) {
                alert('âš ï¸ Keine SMS-Option aktiviert!\n\nBitte erst eine Option anhaken:\nâ€¢ âœ… BuchungsbestÃ¤tigung\nâ€¢ ğŸš• Fahrer unterwegs + Tracking');
                return;
            }
            
            // Frage nach Telefonnummer
            const testPhone = prompt('ğŸ“± Test-SMS senden an:\n\n(Format: 0171xxxxxxx)');
            if (!testPhone) return;
            
            let formattedPhone = testPhone.replace(/[\s\-\/\(\)]/g, '');
            if (formattedPhone.startsWith('0')) {
                formattedPhone = '49' + formattedPhone.substring(1);
            } else if (formattedPhone.startsWith('+')) {
                formattedPhone = formattedPhone.substring(1);
            }
            
            let sentCount = 0;
            let results = [];
            
            // Sende Buchungs-SMS wenn aktiviert
            if (bookingEnabled) {
                const bookingMessage = 'âœ… Taxi bestÃ¤tigt!\n24.12. 14:00\nStrandstr. 5 â†’ Bahnhof\n15â‚¬\nFunk Taxi 038378/22022';
                const success = await sendTestSMSSilent(formattedPhone, bookingMessage);
                results.push(success ? 'âœ… Buchungs-SMS gesendet' : 'ğŸ’¾ Buchungs-SMS fehlgeschlagen');
                if (success) sentCount++;
            }
            
            // Sende Tracking-SMS wenn aktiviert
            if (trackingEnabled) {
                const trackingLink = window.location.origin + window.location.pathname + '?ride=TEST123';
                const trackingMessage = 'ğŸš• Ihr Taxi ist unterwegs!\nAnkunft in ca. 5 Min.\nLive verfolgen:\n' + trackingLink;
                const success = await sendTestSMSSilent(formattedPhone, trackingMessage);
                results.push(success ? 'âœ… Tracking-SMS gesendet' : 'ğŸ’¾ Tracking-SMS fehlgeschlagen');
                if (success) sentCount++;
            }
            
            // Zeige Ergebnis
            alert('ğŸ“± Test-Ergebnis:\n\n' + results.join('\n') + '\n\nNummer: ' + formattedPhone + '\n\nPrÃ¼fe dein Handy!');
        }
        
        // Stille Test-SMS (ohne eigenes Alert)
        async function sendTestSMSSilent(phone, message) {
            try {
                const response = await fetch(SMS_PROXY_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    body: JSON.stringify({
                        to: phone,
                        text: message,
                        from: SMS_SENDER
                    })
                });
                
                const text = await response.text();
                console.log('ğŸ“± Test-SMS:', text);
                return response.ok;
            } catch (error) {
                console.error('ğŸ’¾ SMS Fehler:', error);
                return false;
            }
        }
        
        // Generische Test-SMS Funktion (legacy, wird noch von altem Code verwendet)
        async function sendTestSMS(phone, message, type) {
            try {
                const response = await fetch(SMS_PROXY_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    body: JSON.stringify({
                        to: phone,
                        text: message,
                        from: SMS_SENDER
                    })
                });
                
                const text = await response.text();
                let data;
                try { data = JSON.parse(text); } catch(e) { data = { raw: text }; }
                console.log('ğŸ“± Test-SMS (' + type + '):', data);
                
                if (response.ok) {
                    alert('âœ… ' + type + '-SMS gesendet!\n\nNummer: ' + phone + '\n\nPrÃ¼fe dein Handy!');
                } else {
                    alert('ğŸ’¾ SMS Fehler!\n\n' + JSON.stringify(data));
                }
            } catch (error) {
                console.error('ğŸ’¾ SMS Fehler:', error);
                alert('ğŸ’¾ Fehler beim Senden:\n\n' + error.message);
            }
        }
        
        // Update UI mit aktuellen Settings
        function updateFritzBoxSettingsUI() {
            const enabled = document.getElementById('fritzbox-enabled');
            const host = document.getElementById('fritzbox-host');
            const port = document.getElementById('fritzbox-port');
            const username = document.getElementById('fritzbox-username');
            const password = document.getElementById('fritzbox-password');
            const phone = document.getElementById('fritzbox-phone');
            
            if (enabled) enabled.checked = FRITZBOX_CONFIG.enabled;
            if (host) host.value = FRITZBOX_CONFIG.host;
            if (port) port.value = FRITZBOX_CONFIG.port;
            if (username) username.value = FRITZBOX_CONFIG.username;
            if (password) password.value = FRITZBOX_CONFIG.password;
            if (phone) phone.value = FRITZBOX_CONFIG.phone;
        }
        
        // Rufe Kunde an (Click-to-Call)
        async function callCustomer(phoneNumber) {
            // ğŸ†• v5.90.186: DIREKT TEL: LINK - KEIN AUTO-DIAL!
            // Plus (+) bleibt erhalten, MicroSIP/Softphone Ã¼bernimmt!
            
            console.log('ğŸ’¾ Ã–ffne Telefon-App mit:', phoneNumber);
            
            // Direkt tel: Link Ã¶ffnen (MicroSIP/Zoiper Ã¼bernimmt automatisch!)
            window.location.href = `tel:${phoneNumber}`;
        }
        
        // FritzBox TR-064 API: Nummer wÃ¤hlen
        async function fritzboxDialNumber(phoneNumber) {
            const config = FRITZBOX_CONFIG;
            
            // Bereinige Telefonnummer (entferne Leerzeichen, +, -, etc.)
            const cleanNumber = phoneNumber.replace(/[\s\-\+\(\)]/g, '');
            
            console.log('ğŸ’¾ FritzBox wÃ¤hlt:', cleanNumber, 'von', config.phone);
            
            // TR-064 SOAP Request
            const soapAction = 'urn:dslforum-org:service:X_VoIP:1#X_AVM-DE_DialNumber';
            const soapBody = `<?xml version="1.0" encoding="utf-8"?>
<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/">
    <s:Body>
        <u:X_AVM-DE_DialNumber xmlns:u="urn:dslforum-org:service:X_VoIP:1">
            <NewX_AVM-DE_PhoneNumber>${cleanNumber}</NewX_AVM-DE_PhoneNumber>
        </u:X_AVM-DE_DialNumber>
    </s:Body>
</s:Envelope>`;
            
            try {
                // WICHTIG: Da wir Cross-Origin Requests machen mÃ¼ssen,
                // funktioniert das nur wenn die FritzBox CORS erlaubt
                // oder wenn wir einen Proxy verwenden.
                
                // OPTION 1: Direct (nur wenn CORS aktiviert)
                const url = `${config.protocol}://${config.host}:${config.port}/upnp/control/x_voip`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/xml; charset=utf-8',
                        'SOAPAction': soapAction
                    },
                    body: soapBody,
                    credentials: 'include'
                });
                
                if (response.ok) {
                    console.log('âœ… FritzBox Anruf erfolgreich!');
                    return true;
                } else {
                    console.error('ğŸ’¾ FritzBox Response:', response.status, response.statusText);
                    return false;
                }
                
            } catch (error) {
                console.error('ğŸ’¾ FritzBox API Fehler:', error);
                
                // Fallback: Ã–ffne tel: Link (funktioniert auf Smartphone)
                if (confirm('ğŸ’¾ FritzBox nicht erreichbar.\n\nTelefon-App Ã¶ffnen stattdessen?')) {
                    window.location.href = `tel:${cleanNumber}`;
                }
                
                return false;
            }
        }
        
        function openQuickBookingWithCustomer(customerId) {
            console.log('ğŸš• Ã–ffne Schnellbuchung fÃ¼r Kunde:', customerId);
            
            // âœ… v5.84.0: LÃ¶sche callPopup Event SOFORT!
            db.ref('callPopup').remove();
            
            // Lade Kundendaten
            db.ref('customers/' + customerId).once('value').then(snapshot => {
                const customer = snapshot.val();
                if (!customer) {
                    alert('ğŸ’¾ Kunde nicht gefunden!');
                    return;
                }
                
                console.log('âœ… Kunde geladen:', customer.name);
                
                // SchlieÃŸe Popup
                closeCallPopup();
                
                // Wechsle zu Admin-Bereich
                switchView('admin');
                
                // Warte kurz, dann Ã¶ffne Schnellbuchungs-Modal
                setTimeout(() => {
                    // FÃ¼ge ID zum Customer-Objekt hinzu
                    customer.id = customerId;
                    
                    // Ã–ffne das Schnellbuchungs-Modal mit vorausgefÃ¼llten Kundendaten
                    openQuickBookingModal(customer);
                    
                    console.log('âœ… Schnellbuchungs-Modal geÃ¶ffnet fÃ¼r:', customer.name);
                }, 500);
                
            }).catch(err => {
                console.error('ğŸ’¾ Fehler beim Laden des Kunden:', err);
                alert('ğŸ’¾ Fehler beim Laden der Kundendaten!');
            });
        }
        
        // ğŸ†• v5.73.0: Schnellbuchung mit Telefonnummer (fÃ¼r neue Kunden)
        function openQuickBookingWithPhone(phone) {
            console.log('ğŸš• Ã–ffne Schnellbuchung fÃ¼r neue Nummer:', phone);
            
            // Erstelle temporÃ¤res Kunden-Objekt mit nur Telefon
            const tempCustomer = {
                id: 'new',
                name: '',  // LEER - wird eingegeben!
                phone: phone,
                address: '',
                email: '',
                isNew: true  // Marker dass Kunde neu ist
            };
            
            // FÃ¼ge temporÃ¤ren Kunden zu allCustomers hinzu damit er gefunden wird
            const existingTempIndex = allCustomers.findIndex(c => c.id === 'new');
            if (existingTempIndex >= 0) {
                allCustomers[existingTempIndex] = tempCustomer;
            } else {
                allCustomers.push(tempCustomer);
            }
            console.log('âœ… TemporÃ¤rer Kunde in allCustomers');
            
            // SchlieÃŸe Popup falls offen
            const popup = document.getElementById('call-notification-popup');
            if (popup) {
                popup.style.display = 'none';
            }
            
            // Wechsle zu Admin-Bereich
            switchView('admin');
            
            // Warte kurz, dann Ã¶ffne Schnellbuchungs-Modal
            setTimeout(() => {
                // Ã–ffne das Schnellbuchungs-Modal
                openQuickBookingModal(tempCustomer);
                
                console.log('âœ… Schnellbuchungs-Modal geÃ¶ffnet fÃ¼r neue Nummer:', phone);
            }, 500);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // âš™ï¸ EINSTELLUNGEN: MWST-SÃ„TZE + ZAHLUNGSARTEN
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // ğŸ†• v5.87.86: LADE MWST-SÃ„TZE
        async function loadVatRates() {
            console.log('ğŸ’¶ Lade MwSt-SÃ¤tze...');
            
            if (!isFirebaseReady) {
                console.error('ğŸ’¾ Firebase nicht bereit!');
                return;
            }
            
            try {
                const snapshot = await db.ref('settings/vatRates').once('value');
                const container = document.getElementById('vat-rates-list');
                
                if (!container) return;
                
                if (!snapshot.exists()) {
                    // STANDARD-SÃ„TZE ANLEGEN
                    await db.ref('settings/vatRates').set({
                        vat_1: { rate: 7, name: 'ErmÃ¤ÃŸigt (Taxi)', default: true, order: 1 },
                        vat_2: { rate: 19, name: 'Normal', default: false, order: 2 },
                        vat_3: { rate: 0, name: 'Keine MwSt', default: false, order: 3 }
                    });
                    console.log('âœ… Standard MwSt-SÃ¤tze angelegt!');
                    loadVatRates(); // Neu laden
                    return;
                }
                
                const rates = [];
                snapshot.forEach(child => {
                    rates.push({ id: child.key, ...child.val() });
                });
                
                // Sortieren nach Order
                rates.sort((a, b) => (a.order || 0) - (b.order || 0));
                
                container.innerHTML = rates.map(rate => `
                    <div style="display:flex;align-items:center;justify-content:space-between;background:white;padding:10px;border-radius:6px;border:${rate.default ? '2px solid #8b5cf6' : '1px solid #e5e7eb'};">
                        <div style="display:flex;align-items:center;gap:10px;">
                            ${rate.default ? '<span style="color:#8b5cf6;font-weight:700;">â­</span>' : ''}
                            <div>
                                <div style="font-weight:600;color:#1f2937;">${rate.rate}%</div>
                                <div style="font-size:12px;color:#6b7280;">${rate.name}</div>
                            </div>
                        </div>
                        <div style="display:flex;gap:6px;">
                            ${!rate.default ? `<button onclick="setDefaultVatRate('${rate.id}')" style="padding:6px 10px;background:#f3f4f6;color:#6b7280;border:none;border-radius:4px;cursor:pointer;font-size:11px;" title="Als Standard markieren">â­</button>` : ''}
                            <button onclick="editVatRate('${rate.id}', ${rate.rate}, '${rate.name}')" style="padding:6px 10px;background:#f3f4f6;color:#6b7280;border:none;border-radius:4px;cursor:pointer;font-size:11px;">âœï¸</button>
                            <button onclick="deleteVatRate('${rate.id}')" style="padding:6px 10px;background:#fee;color:#ef4444;border:none;border-radius:4px;cursor:pointer;font-size:11px;">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `).join('');
                
                console.log(`âœ… ${rates.length} MwSt-SÃ¤tze geladen`);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der MwSt-SÃ¤tze:', error);
            }
        }
        
        // ğŸ†• v5.87.86: LADE ZAHLUNGSARTEN
        async function loadPaymentMethods() {
            console.log('ğŸ’³ Lade Zahlungsarten...');
            
            if (!isFirebaseReady) {
                console.error('ğŸ’¾ Firebase nicht bereit!');
                return;
            }
            
            try {
                const snapshot = await db.ref('settings/paymentMethods').once('value');
                const container = document.getElementById('payment-methods-list');
                
                if (!container) return;
                
                if (!snapshot.exists()) {
                    // STANDARD-ZAHLUNGSARTEN ANLEGEN
                    await db.ref('settings/paymentMethods').set({
                        pm_1: { name: 'Bar', icon: 'ğŸ’µ', order: 1 },
                        pm_2: { name: 'Ãœberweisung', icon: 'ğŸ¦', order: 2 },
                        pm_3: { name: 'Lastschrift', icon: 'ğŸ’³', order: 3 },
                        pm_4: { name: 'PayPal', icon: 'ğŸ’°', order: 4 },
                        pm_5: { name: 'Kreditkarte', icon: 'ğŸ’³', order: 5 },
                        pm_6: { name: 'Rechnung', icon: 'ğŸ“±', order: 6 }
                    });
                    console.log('âœ… Standard Zahlungsarten angelegt!');
                    loadPaymentMethods(); // Neu laden
                    return;
                }
                
                const methods = [];
                snapshot.forEach(child => {
                    methods.push({ id: child.key, ...child.val() });
                });
                
                // Sortieren nach Order
                methods.sort((a, b) => (a.order || 0) - (b.order || 0));
                
                container.innerHTML = methods.map(method => `
                    <div style="display:flex;align-items:center;justify-content:space-between;background:white;padding:10px;border-radius:6px;border:1px solid #e5e7eb;">
                        <div style="display:flex;align-items:center;gap:10px;">
                            <span style="font-size:20px;">${method.icon || 'ğŸ’³'}</span>
                            <div style="font-weight:600;color:#1f2937;">${method.name}</div>
                        </div>
                        <div style="display:flex;gap:6px;">
                            <button onclick="editPaymentMethod('${method.id}', '${method.name}', '${method.icon || ''}')" style="padding:6px 10px;background:#f3f4f6;color:#6b7280;border:none;border-radius:4px;cursor:pointer;font-size:11px;">âœï¸</button>
                            <button onclick="deletePaymentMethod('${method.id}')" style="padding:6px 10px;background:#fee;color:#ef4444;border:none;border-radius:4px;cursor:pointer;font-size:11px;">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `).join('');
                
                console.log(`âœ… ${methods.length} Zahlungsarten geladen`);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der Zahlungsarten:', error);
            }
        }
        
        // ğŸ†• v5.87.86: Ã–FFNE MWST-SATZ HINZUFÃœGEN MODAL
        function openAddVatRateModal() {
            const modal = document.createElement('div');
            modal.id = 'vat-rate-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:10001;display:flex;align-items:center;justify-content:center;padding:20px;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;max-width:400px;width:100%;">
                    <h3 style="margin:0 0 15px 0;color:#1f2937;">â• Neuer MwSt-Satz</h3>
                    
                    <div style="margin-bottom:12px;">
                        <label style="display:block;font-weight:600;margin-bottom:6px;color:#374151;">Prozentsatz: <span style="color:#ef4444;">*</span></label>
                        <input type="number" id="vat-rate-value" step="0.01" min="0" max="100" placeholder="z.B. 7 oder 19" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;">
                    </div>
                    
                    <div style="margin-bottom:12px;">
                        <label style="display:block;font-weight:600;margin-bottom:6px;color:#374151;">Bezeichnung: <span style="color:#ef4444;">*</span></label>
                        <input type="text" id="vat-rate-name" placeholder="z.B. ErmÃ¤ÃŸigt (Taxi)" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;">
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <input type="checkbox" id="vat-rate-default" style="width:18px;height:18px;cursor:pointer;">
                            <span style="font-weight:600;color:#374151;">Als Standard markieren</span>
                        </label>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                        <button onclick="closeVatRateModal()" style="padding:14px;background:#f3f4f6;color:#6b7280;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                            Abbrechen
                        </button>
                        <button onclick="saveVatRate()" style="padding:14px;background:#8b5cf6;color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px;">
                            ğŸ’¾ Speichern
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            setTimeout(() => {
                document.getElementById('vat-rate-value').focus();
            }, 100);
        }
        
        // ğŸ†• v5.87.86: SPEICHERE MWST-SATZ
        async function saveVatRate(editId = null) {
            const value = parseFloat(document.getElementById('vat-rate-value').value);
            const name = document.getElementById('vat-rate-name').value.trim();
            const isDefault = document.getElementById('vat-rate-default').checked;
            
            if (!value && value !== 0) {
                alert('ğŸ’¾ Bitte Prozentsatz eingeben!');
                return;
            }
            
            if (!name) {
                alert('ğŸ’¾ Bitte Bezeichnung eingeben!');
                return;
            }
            
            try {
                const id = editId || 'vat_' + Date.now();
                
                // Wenn als Standard markiert, andere entfernen
                if (isDefault) {
                    const snapshot = await db.ref('settings/vatRates').once('value');
                    snapshot.forEach(child => {
                        db.ref(`settings/vatRates/${child.key}/default`).set(false);
                    });
                }
                
                // Speichere Satz
                await db.ref(`settings/vatRates/${id}`).set({
                    rate: value,
                    name: name,
                    default: isDefault,
                    order: Date.now()
                });
                
                console.log('âœ… MwSt-Satz gespeichert!');
                
                closeVatRateModal();
                loadVatRates();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Speichern:', error);
                alert('ğŸ’¾ Fehler beim Speichern!');
            }
        }
        
        // ğŸ†• v5.87.86: SETZE STANDARD MWST-SATZ
        async function setDefaultVatRate(id) {
            try {
                // Alle auf false setzen
                const snapshot = await db.ref('settings/vatRates').once('value');
                snapshot.forEach(child => {
                    db.ref(`settings/vatRates/${child.key}/default`).set(false);
                });
                
                // Diesen auf true
                await db.ref(`settings/vatRates/${id}/default`).set(true);
                
                console.log('âœ… Standard MwSt-Satz gesetzt!');
                loadVatRates();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
            }
        }
        
        // ğŸ†• v5.87.86: BEARBEITE MWST-SATZ
        function editVatRate(id, rate, name) {
            openAddVatRateModal();
            setTimeout(() => {
                document.getElementById('vat-rate-value').value = rate;
                document.getElementById('vat-rate-name').value = name;
                
                const saveBtn = document.querySelector('#vat-rate-modal button:last-child');
                saveBtn.onclick = () => saveVatRate(id);
            }, 100);
        }
        
        // ğŸ†• v5.87.86: LÃ–SCHE MWST-SATZ
        async function deleteVatRate(id) {
            if (!confirm('MwSt-Satz wirklich lÃ¶schen?')) return;
            
            try {
                await db.ref(`settings/vatRates/${id}`).remove();
                console.log('âœ… MwSt-Satz gelÃ¶scht!');
                loadVatRates();
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
            }
        }
        
        // ğŸ†• v5.87.86: SCHLIEÃŸE MWST-MODAL
        function closeVatRateModal() {
            const modal = document.getElementById('vat-rate-modal');
            if (modal) modal.remove();
        }
        
        // ğŸ†• v5.87.86: Ã–FFNE ZAHLUNGSART HINZUFÃœGEN MODAL
        function openAddPaymentMethodModal() {
            const modal = document.createElement('div');
            modal.id = 'payment-method-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:10001;display:flex;align-items:center;justify-content:center;padding:20px;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;max-width:400px;width:100%;">
                    <h3 style="margin:0 0 15px 0;color:#1f2937;">â• Neue Zahlungsart</h3>
                    
                    <div style="margin-bottom:12px;">
                        <label style="display:block;font-weight:600;margin-bottom:6px;color:#374151;">Name: <span style="color:#ef4444;">*</span></label>
                        <input type="text" id="payment-method-name" placeholder="z.B. Bar, Ãœberweisung" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box;">
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block;font-weight:600;margin-bottom:6px;color:#374151;">Icon (Emoji):</label>
                        <input type="text" id="payment-method-icon" placeholder="z.B. ğŸ’µ ğŸ¦ ğŸ’³" maxlength="2" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:24px;box-sizing:border-box;text-align:center;">
                        <div style="font-size:11px;color:#6b7280;margin-top:4px;">Tipp: Kopiere ein Emoji von https://emojipedia.org</div>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                        <button onclick="closePaymentMethodModal()" style="padding:14px;background:#f3f4f6;color:#6b7280;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                            Abbrechen
                        </button>
                        <button onclick="savePaymentMethod()" style="padding:14px;background:#f59e0b;color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px;">
                            ğŸ’¾ Speichern
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            setTimeout(() => {
                document.getElementById('payment-method-name').focus();
            }, 100);
        }
        
        // ğŸ†• v5.87.86: SPEICHERE ZAHLUNGSART
        async function savePaymentMethod(editId = null) {
            const name = document.getElementById('payment-method-name').value.trim();
            const icon = document.getElementById('payment-method-icon').value.trim();
            
            if (!name) {
                alert('ğŸ’¾ Bitte Namen eingeben!');
                return;
            }
            
            try {
                const id = editId || 'pm_' + Date.now();
                
                await db.ref(`settings/paymentMethods/${id}`).set({
                    name: name,
                    icon: icon || 'ğŸ’³',
                    order: Date.now()
                });
                
                console.log('âœ… Zahlungsart gespeichert!');
                
                closePaymentMethodModal();
                loadPaymentMethods();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Speichern:', error);
                alert('ğŸ’¾ Fehler beim Speichern!');
            }
        }
        
        // ğŸ†• v5.87.86: BEARBEITE ZAHLUNGSART
        function editPaymentMethod(id, name, icon) {
            openAddPaymentMethodModal();
            setTimeout(() => {
                document.getElementById('payment-method-name').value = name;
                document.getElementById('payment-method-icon').value = icon;
                
                const saveBtn = document.querySelector('#payment-method-modal button:last-child');
                saveBtn.onclick = () => savePaymentMethod(id);
            }, 100);
        }
        
        // ğŸ†• v5.87.86: LÃ–SCHE ZAHLUNGSART
        async function deletePaymentMethod(id) {
            if (!confirm('Zahlungsart wirklich lÃ¶schen?')) return;
            
            try {
                await db.ref(`settings/paymentMethods/${id}`).remove();
                console.log('âœ… Zahlungsart gelÃ¶scht!');
                loadPaymentMethods();
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
            }
        }
        
        // ğŸ†• v5.87.86: SCHLIEÃŸE ZAHLUNGSART-MODAL
        function closePaymentMethodModal() {
            const modal = document.getElementById('payment-method-modal');
            if (modal) modal.remove();
        }
        
        // â­ POI LOADING FUNKTION
        async function loadPOIs() {
            console.log('â­ Lade POIs aus Firebase...');
            
            if (!isFirebaseReady) {
                console.error('ğŸ’¾ Firebase nicht bereit!');
                return;
            }
            
            try {
                const snapshot = await db.ref('pois').once('value');
                allPOIs = [];
                
                snapshot.forEach(child => {
                    allPOIs.push({
                        id: child.key,
                        ...child.val()
                    });
                });
                
                console.log(`âœ… ${allPOIs.length} POIs geladen`);
                renderPOIList();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der POIs:', error);
            }
        }
        
        function renderPOIList() {
            const container = document.getElementById('poi-list-container');
            if (!container) {
                console.log('ğŸ’¾ POI-Container nicht gefunden!');
                return;
            }
            
            console.log('ğŸ¨ Rendere POI-Liste mit', allPOIs.length, 'EintrÃ¤gen');
            
            if (allPOIs.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;padding:40px;color:#6b7280;">
                        <div style="font-size:48px;margin-bottom:10px;">â­</div>
                        <div style="font-weight:600;margin-bottom:5px;">Noch keine Favoriten-Ziele</div>
                        <div style="font-size:13px;">Klicke auf "â• Neues Ziel" um ein Favoriten-Ziel hinzuzufÃ¼gen</div>
                    </div>
                `;
                return;
            }
            
            try {
                container.innerHTML = `
                    <div style="display:grid;gap:10px;">
                        ${allPOIs.map(poi => {
                            const lat = poi.lat ? poi.lat.toFixed(6) : '?';
                            const lon = poi.lon ? poi.lon.toFixed(6) : '?';
                            const safeName = (poi.name || 'Unbenannt').replace(/'/g, "\\'");
                            return `
                            <div style="background:#fef3c7;border:2px solid #f59e0b;border-radius:12px;padding:14px;transition:all 0.3s;" 
                                 onmouseover="this.style.boxShadow='0 4px 12px rgba(245,158,11,0.3)'"
                                 onmouseout="this.style.boxShadow='none'">
                                <div style="display:flex;justify-content:space-between;align-items:start;">
                                    <div style="flex:1;">
                                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                                            <div style="font-size:20px;">â­</div>
                                            <div style="font-weight:700;font-size:16px;color:#92400e;">${poi.name || 'Unbenannt'}</div>
                                        </div>
                                        <div style="font-size:13px;color:#78350f;margin-left:28px;">
                                            ğŸ“ ${poi.address || 'Keine Adresse'}
                                        </div>
                                        <div style="font-size:11px;color:#a16207;margin-left:28px;margin-top:4px;">
                                            ğŸ“ ${lat}, ${lon}
                                        </div>
                                    </div>
                                    <div style="display:flex;flex-direction:column;gap:6px;">
                                        <button onclick="editPOI('${poi.id}')" 
                                                style="padding:8px 12px;background:#3b82f6;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:12px;white-space:nowrap;">
                                            âœï¸ Bearbeiten
                                        </button>
                                        <button onclick="deletePOI('${poi.id}', '${safeName}')" 
                                                style="padding:8px 12px;background:#ef4444;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:12px;white-space:nowrap;">
                                            ğŸ—‘ï¸ LÃ¶schen
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                `;
                console.log('âœ… POI-Liste gerendert!');
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Rendern der POI-Liste:', error);
                container.innerHTML = `<div style="padding:20px;color:red;">Fehler: ${error.message}</div>`;
            }
        }
        
        function openAddPOIModal() {
            const modal = document.createElement('div');
            modal.id = 'add-poi-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;';
            
            modal.innerHTML = `
                <div style="background:white;border-radius:16px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                    <!-- Header -->
                    <div style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:20px;border-radius:16px 16px 0 0;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div style="display:flex;align-items:center;gap:10px;">
                                <div style="font-size:32px;">â­</div>
                                <h3 style="margin:0;font-size:20px;">Neues Favoriten-Ziel</h3>
                            </div>
                            <button onclick="document.getElementById('add-poi-modal').remove()" 
                                    style="background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:20px;">
                                âœ•
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div style="padding:20px;">
                        <div style="margin-bottom:15px;">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:#1f2937;font-size:14px;">â­ Name des Ziels</label>
                            <input type="text" id="poi-name" placeholder="z.B. Bahnhof Heringsdorf"
                                   style="width:100%;padding:12px;border:2px solid #fbbf24;border-radius:8px;font-size:14px;box-sizing:border-box;">
                        </div>
                        
                        <div style="margin-bottom:15px;">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:#1f2937;font-size:14px;">ğŸ“ Adresse</label>
                            <div style="position:relative;display:flex;gap:8px;">
                                <input type="text" id="poi-address" placeholder="Adresse eingeben..."
                                       oninput="searchPOIAddress()"
                                       style="flex:1;padding:12px;border:2px solid #fbbf24;border-radius:8px;font-size:14px;box-sizing:border-box;">
                                <button onclick="openUniversalMapPicker('poi-address', 'ğŸ“ POI-Adresse auf Karte wÃ¤hlen', (data) => { document.getElementById('poi-lat').value = data.lat; document.getElementById('poi-lon').value = data.lon; })" style="background:#10b981;color:white;border:none;border-radius:8px;padding:12px 16px;cursor:pointer;font-size:16px;flex-shrink:0;" title="Auf Karte wÃ¤hlen">
                                    ğŸ—ºï¸
                                </button>
                                <div id="poi-address-dropdown" style="display:none;position:absolute;top:100%;left:0;right:60px;background:white;border:2px solid #fbbf24;border-radius:8px;margin-top:4px;max-height:300px;overflow-y:auto;z-index:10000;box-shadow:0 8px 24px rgba(0,0,0,0.15);"></div>
                            </div>
                            <div style="font-size:12px;color:#6b7280;margin-top:6px;">
                                ğŸ’¡ Tippe die Adresse oder wÃ¤hle auf der Karte ğŸ—ºï¸
                            </div>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px;">
                            <div>
                                <label style="display:block;font-weight:600;margin-bottom:8px;color:#1f2937;font-size:14px;">ğŸ“ Latitude</label>
                                <input type="text" id="poi-lat" readonly
                                       style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;background:#f9fafb;box-sizing:border-box;">
                            </div>
                            <div>
                                <label style="display:block;font-weight:600;margin-bottom:8px;color:#1f2937;font-size:14px;">ğŸ“ Longitude</label>
                                <input type="text" id="poi-lon" readonly
                                       style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;background:#f9fafb;box-sizing:border-box;">
                            </div>
                        </div>
                        
                        <div style="background:#fef3c7;padding:12px;border-radius:8px;margin-bottom:15px;border-left:4px solid #f59e0b;">
                            <div style="font-size:12px;color:#78350f;">
                                <strong>â„¹ï¸ Hinweis:</strong> Koordinaten werden automatisch gesetzt wenn du eine Adresse aus dem Dropdown wÃ¤hlst
                            </div>
                        </div>
                        
                        <div style="display:flex;gap:10px;">
                            <button onclick="document.getElementById('add-poi-modal').remove()" 
                                    style="flex:1;padding:12px;background:#e5e7eb;color:#1f2937;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                                Abbrechen
                            </button>
                            <button onclick="savePOI()" 
                                    style="flex:1;padding:12px;background:#f59e0b;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                                â­ Speichern
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        let poiAddressTimeout = null;
        
        async function searchPOIAddress() {
            const input = document.getElementById('poi-address');
            const dropdown = document.getElementById('poi-address-dropdown');
            const query = input.value.trim();
            
            if (query.length < 6) {
                dropdown.style.display = 'none';
                return;
            }
            
            clearTimeout(poiAddressTimeout);
            poiAddressTimeout = setTimeout(async () => {
                try {
                    // ğŸ†• v5.88.14: Konvertiere deutsche Namen zu polnischen!
                    const searchQuery = convertGermanToPolish(query);
                    console.log('ğŸ” POI-Suche:', query, 'â†’', searchQuery);
                    
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?` +
                        `format=json&` +
                        `q=${encodeURIComponent(searchQuery)}&` +
                        `countrycodes=de&viewbox=10.6,54.7,14.4,53.1&bounded=1&` +
                        `limit=10&` +
                        `addressdetails=1&` +
                        `accept-language=de,pl,en`,
                        {
                            headers: {
                                'Accept-Language': 'de,pl,en'
                            }
                        }
                    );
                    
                    const results = await response.json();
                    
                    if (results.length === 0) {
                        dropdown.innerHTML = '<div style="padding:12px;text-align:center;color:#999;">Keine Ergebnisse gefunden</div>';
                        dropdown.style.display = 'block';
                        return;
                    }
                    
                    dropdown.innerHTML = results.map(r => {
                        // ğŸ†• v5.90.111: KURZE Formatierung - NUR StraÃŸe, PLZ, Ort (KEIN Landkreis/Bundesland!)
                        let displayText = '';
                        if (r.address) {
                            // StraÃŸe + Hausnummer
                            if (r.address.road) displayText += r.address.road + ' ';
                            if (r.address.house_number) displayText += r.address.house_number + ', ';
                            
                            // PLZ + Ort
                            if (r.address.postcode) displayText += r.address.postcode + ' ';
                            if (r.address.village || r.address.town || r.address.city) {
                                displayText += (r.address.village || r.address.town || r.address.city);
                            }
                        }
                        
                        // Fallback: Nur erste 3 Teile (StraÃŸe, Ort, PLZ - OHNE Landkreis/Bundesland)
                        if (!displayText.trim() && r.display_name) {
                            const parts = r.display_name.split(',').slice(0, 3);
                            displayText = parts.join(',').trim();
                        }
                        
                        // Letzter Fallback
                        if (!displayText.trim()) {
                            displayText = 'Unbekannte Adresse';
                        }
                        
                        // Encode address object as JSON for onclick
                        const addressJson = JSON.stringify(r.address || {}).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        
                        return `
                            <div onclick="selectPOIAddress('${displayText.replace(/'/g, "\\'")}', ${r.lat}, ${r.lon}, '${displayText.replace(/'/g, "\\'")}', '${addressJson}')" 
                                 style="padding:12px;cursor:pointer;border-bottom:1px solid #f3f4f6;transition:background 0.2s;"
                                 onmouseover="this.style.background='#fef3c7'"
                                 onmouseout="this.style.background='white'">
                                <div style="font-weight:600;color:#92400e;font-size:14px;">ğŸ“ ${displayText}</div>
                            </div>
                        `;
                    }).join('');
                    
                    dropdown.style.display = 'block';
                    
                } catch (error) {
                    console.error('ğŸ’¾ Adresssuche Fehler:', error);
                }
            }, 300);
        }
        
        function selectPOIAddress(formattedAddress, lat, lon, fullAddress, addressJsonStr) {
            // ğŸ†• v5.90.72: Nutze formatierte Adresse MIT PLZ!
            document.getElementById('poi-address').value = formattedAddress;
            document.getElementById('poi-lat').value = lat;
            document.getElementById('poi-lon').value = lon;
            document.getElementById('poi-address-dropdown').style.display = 'none';
            
            console.log('âœ… POI Adresse ausgewÃ¤hlt:', formattedAddress);
        }
        
        // ğŸ†• v5.86.32: KÃ¼rze Nominatim-Adressen fÃ¼r bessere Lesbarkeit
        function shortenAddress(fullAddress) {
            // Nominatim Format: "GebÃ¤ude, Ort1, Ort2, Stadt, Landkreis, Bundesland, PLZ, Land"
            const parts = fullAddress.split(',').map(p => p.trim());
            
            if (parts.length <= 2) {
                // Schon kurz genug
                return fullAddress;
            }
            
            // Finde PLZ (5 Ziffern)
            let plz = '';
            let plzIndex = -1;
            for (let i = 0; i < parts.length; i++) {
                if (/^\d{5}$/.test(parts[i])) {
                    plz = parts[i];
                    plzIndex = i;
                    break;
                }
            }
            
            // Nimm erstes Teil (GebÃ¤ude/StraÃŸe) und Stadt mit PLZ
            const firstPart = parts[0]; // GebÃ¤ude/StraÃŸe
            
            if (plz && plzIndex > 0) {
                // Finde Hauptstadt (meist vor PLZ)
                const cityIndex = Math.max(0, plzIndex - 3); // 3 Teile vor PLZ
                const city = parts[cityIndex];
                return `${firstPart}, ${plz} ${city}`;
            }
            
            // Fallback: Nimm erste 3 Teile
            return parts.slice(0, 3).join(', ');
        }
        
        async function savePOI() {
            const name = document.getElementById('poi-name').value.trim();
            const address = document.getElementById('poi-address').value.trim();
            const lat = parseFloat(document.getElementById('poi-lat').value);
            const lon = parseFloat(document.getElementById('poi-lon').value);
            
            if (!name) {
                alert('ğŸ’¾ Bitte Name eingeben!');
                return;
            }
            
            if (!address) {
                alert('ğŸ’¾ Bitte Adresse eingeben!');
                return;
            }
            
            if (!lat || !lon) {
                alert('ğŸ’¾ Bitte Adresse aus Dropdown wÃ¤hlen (fÃ¼r Koordinaten)!');
                return;
            }
            
            try {
                console.log('ğŸ’¾ Speichere POI...');
                
                await db.ref('pois').push({
                    name,
                    address,
                    lat,
                    lon,
                    created: Date.now()
                });
                
                console.log('âœ… POI gespeichert!');
                
                // Modal schlieÃŸen
                document.getElementById('add-poi-modal').remove();
                
                // Liste neu laden
                await loadPOIs();
                
                showToast('â­ Favoriten-Ziel gespeichert!', 'success');
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Speichern:', error);
                alert('ğŸ’¾ Fehler beim Speichern: ' + error.message);
            }
        }
        
        async function deletePOI(id, name) {
            if (!confirm(`ğŸ—‘ï¸ Favoriten-Ziel "${name}" wirklich lÃ¶schen?`)) {
                return;
            }
            
            try {
                await db.ref('pois/' + id).remove();
                console.log('âœ… POI gelÃ¶scht!');
                
                await loadPOIs();
                showToast('ğŸ—‘ï¸ Favoriten-Ziel gelÃ¶scht!', 'success');
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim LÃ¶schen:', error);
                alert('ğŸ’¾ Fehler beim LÃ¶schen: ' + error.message);
            }
        }
        
        function editPOI(id) {
            const poi = allPOIs.find(p => p.id === id);
            if (!poi) return;
            
            const modal = document.createElement('div');
            modal.id = 'edit-poi-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;';
            
            modal.innerHTML = `
                <div style="background:white;border-radius:16px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                    <div style="background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;padding:20px;border-radius:16px 16px 0 0;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div style="display:flex;align-items:center;gap:10px;">
                                <div style="font-size:32px;">âœï¸</div>
                                <h3 style="margin:0;font-size:20px;">Favoriten-Ziel bearbeiten</h3>
                            </div>
                            <button onclick="document.getElementById('edit-poi-modal').remove()" 
                                    style="background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:20px;">
                                âœ•
                            </button>
                        </div>
                    </div>
                    
                    <div style="padding:20px;">
                        <div style="margin-bottom:15px;">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:#1f2937;font-size:14px;">â­ Name</label>
                            <input type="text" id="edit-poi-name" value="${poi.name.replace(/"/g, '&quot;')}"
                                   style="width:100%;padding:12px;border:2px solid #3b82f6;border-radius:8px;font-size:14px;box-sizing:border-box;">
                        </div>
                        
                        <div style="margin-bottom:15px;">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:#1f2937;font-size:14px;">ğŸ“ Adresse</label>
                            <div style="position:relative;display:flex;gap:8px;">
                                <input type="text" id="edit-poi-address" value="${poi.address.replace(/"/g, '&quot;')}"
                                       oninput="searchEditPOIAddress()"
                                       style="flex:1;padding:12px;border:2px solid #3b82f6;border-radius:8px;font-size:14px;box-sizing:border-box;">
                                <button onclick="openUniversalMapPicker('edit-poi-address', 'ğŸ“ POI-Adresse bearbeiten', (data) => { document.getElementById('edit-poi-lat').value = data.lat; document.getElementById('edit-poi-lon').value = data.lon; })" style="background:#10b981;color:white;border:none;border-radius:8px;padding:12px 16px;cursor:pointer;font-size:16px;flex-shrink:0;" title="Auf Karte wÃ¤hlen">
                                    ğŸ—ºï¸
                                </button>
                                <div id="edit-poi-address-dropdown" style="display:none;position:absolute;top:100%;left:0;right:60px;background:white;border:2px solid #3b82f6;border-radius:8px;margin-top:4px;max-height:300px;overflow-y:auto;z-index:10000;box-shadow:0 8px 24px rgba(0,0,0,0.15);"></div>
                            </div>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px;">
                            <div>
                                <label style="display:block;font-weight:600;margin-bottom:8px;color:#1f2937;font-size:14px;">ğŸ“ Latitude</label>
                                <input type="text" id="edit-poi-lat" value="${poi.lat}" readonly
                                       style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;background:#f9fafb;box-sizing:border-box;">
                            </div>
                            <div>
                                <label style="display:block;font-weight:600;margin-bottom:8px;color:#1f2937;font-size:14px;">ğŸ“ Longitude</label>
                                <input type="text" id="edit-poi-lon" value="${poi.lon}" readonly
                                       style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;background:#f9fafb;box-sizing:border-box;">
                            </div>
                        </div>
                        
                        <div style="display:flex;gap:10px;">
                            <button onclick="document.getElementById('edit-poi-modal').remove()" 
                                    style="flex:1;padding:12px;background:#e5e7eb;color:#1f2937;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                                Abbrechen
                            </button>
                            <button onclick="updatePOI('${id}')" 
                                    style="flex:1;padding:12px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                                ğŸ’¾ Speichern
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        let editPoiAddressTimeout = null;
        async function searchEditPOIAddress() {
            const input = document.getElementById('edit-poi-address');
            const dropdown = document.getElementById('edit-poi-address-dropdown');
            const query = input.value.trim();
            
            if (query.length < 6) {
                dropdown.style.display = 'none';
                return;
            }
            
            clearTimeout(editPoiAddressTimeout);
            editPoiAddressTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?` +
                        `format=json&` +
                        `q=${encodeURIComponent(query)}&` +
                        `countrycodes=de&viewbox=10.6,54.7,14.4,53.1&bounded=1&` +
                        `limit=10&` +
                        `addressdetails=1`
                    );
                    
                    const results = await response.json();
                    
                    if (results.length === 0) {
                        dropdown.innerHTML = '<div style="padding:12px;text-align:center;color:#999;">Keine Ergebnisse</div>';
                        dropdown.style.display = 'block';
                        return;
                    }
                    
                    dropdown.innerHTML = results.map(r => {
                        // ğŸ†• v5.90.111: KURZE Formatierung - NUR StraÃŸe, PLZ, Ort (KEIN Landkreis/Bundesland!)
                        let displayText = '';
                        if (r.address) {
                            // StraÃŸe + Hausnummer
                            if (r.address.road) displayText += r.address.road + ' ';
                            if (r.address.house_number) displayText += r.address.house_number + ', ';
                            
                            // PLZ + Ort
                            if (r.address.postcode) displayText += r.address.postcode + ' ';
                            if (r.address.village || r.address.town || r.address.city) {
                                displayText += (r.address.village || r.address.town || r.address.city);
                            }
                        }
                        
                        // Fallback: Nur erste 3 Teile (StraÃŸe, Ort, PLZ - OHNE Landkreis/Bundesland)
                        if (!displayText.trim() && r.display_name) {
                            const parts = r.display_name.split(',').slice(0, 3);
                            displayText = parts.join(',').trim();
                        }
                        
                        // Letzter Fallback
                        if (!displayText.trim()) {
                            displayText = 'Unbekannte Adresse';
                        }
                        
                        return `
                            <div onclick="selectEditPOIAddress('${displayText.replace(/'/g, "\\'")}', ${r.lat}, ${r.lon}, '${displayText.replace(/'/g, "\\'")}' )" 
                                 style="padding:12px;cursor:pointer;border-bottom:1px solid #f3f4f6;"
                                 onmouseover="this.style.background='#dbeafe'"
                                 onmouseout="this.style.background='white'">
                                <div style="font-weight:600;color:#1e40af;font-size:14px;">ğŸ“ ${displayText}</div>
                            </div>
                        `;
                    }).join('');
                    
                    dropdown.style.display = 'block';
                    
                } catch (error) {
                    console.error('ğŸ’¾ Adresssuche Fehler:', error);
                }
            }, 300);
        }
        
        function selectEditPOIAddress(formattedAddress, lat, lon, fullAddress) {
            // ğŸ†• v5.90.72: Nutze formatierte Adresse MIT PLZ!
            document.getElementById('edit-poi-address').value = formattedAddress;
            document.getElementById('edit-poi-lat').value = lat;
            document.getElementById('edit-poi-lon').value = lon;
            document.getElementById('edit-poi-address-dropdown').style.display = 'none';
            
            console.log('âœ… Edit POI Adresse ausgewÃ¤hlt:', formattedAddress);
        }
        
        async function updatePOI(id) {
            const name = document.getElementById('edit-poi-name').value.trim();
            const address = document.getElementById('edit-poi-address').value.trim();
            const lat = parseFloat(document.getElementById('edit-poi-lat').value);
            const lon = parseFloat(document.getElementById('edit-poi-lon').value);
            
            if (!name || !address || !lat || !lon) {
                alert('ğŸ’¾ Bitte alle Felder ausfÃ¼llen!');
                return;
            }
            
            try {
                await db.ref('pois/' + id).update({
                    name,
                    address,
                    lat,
                    lon,
                    updated: Date.now()
                });
                
                console.log('âœ… POI aktualisiert!');
                
                document.getElementById('edit-poi-modal').remove();
                await loadPOIs();
                
                showToast('âœ… Favoriten-Ziel aktualisiert!', 'success');
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Aktualisieren:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        async function saveNewCustomerAndBook(phone) {
            const name = document.getElementById('new-customer-name').value.trim();
            const address = document.getElementById('new-customer-address').value.trim();
            const email = document.getElementById('new-customer-email').value.trim();
            
            if (!name) {
                alert('ğŸ’¾ Bitte Name eingeben!');
                return;
            }
            
            try {
                console.log('ğŸ’¾ Speichere neuen Kunden...');
                
                // Speichere Kunde in Firebase
                const newCustomerRef = db.ref('customers').push();
                await newCustomerRef.set({
                    name: name,
                    phone: phone,
                    address: address || '',
                    email: email || '',
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    createdBy: 'call-popup'
                });
                
                console.log('âœ… Neuer Kunde gespeichert:', newCustomerRef.key);
                
                // WICHTIG: Popup KOMPLETT schlieÃŸen BEVOR Modal Ã¶ffnet!
                closeCallPopup();
                console.log('ğŸšª CallPopup geschlossen');
                
                // Warte 500ms damit Popup-Overlay sicher weg ist
                setTimeout(() => {
                    console.log('ğŸš• Ã–ffne Schnellbuchung...');
                    // Ã–ffne Schnellbuchung mit diesem Kunden
                    openQuickBookingWithCustomer(newCustomerRef.key);
                }, 500);
                
            } catch (err) {
                console.error('ğŸ’¾ Fehler beim Speichern:', err);
                alert('ğŸ’¾ Fehler: ' + err.message);
            }
        }
        
        // ğŸ†• v5.77.0: HOTEL-KALENDER VERWALTUNG
        
        let selectedHotelColor = '#f97316';
        let hotelCalendars = {};
        
        // Lade Hotel-Kalender aus Firebase
        async function loadHotelCalendars() {
            console.log('ğŸ¨ Lade Hotel-Kalender...');
            
            try {
                const snapshot = await db.ref('hotelCalendars').once('value');
                hotelCalendars = snapshot.val() || {};
                
                const count = Object.keys(hotelCalendars).length;
                console.log(`âœ… ${count} Hotel-Kalender geladen`);
                
                // Update Badge
                const badge = document.getElementById('hotel-calendar-count');
                if (badge) badge.textContent = count;
                
                // Render Liste
                renderHotelCalendarList();
                
                // ğŸ†• v5.87.24: AUTO-SYNC STARTEN!
                startHotelCalendarAutoSync();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der Hotel-Kalender:', error);
            }
        }
        
        // ğŸ†• v5.87.24: AUTO-SYNC TIMER
        let hotelCalendarSyncInterval = null;
        let autoSyncStarted = false; // Flag um Doppel-Start zu verhindern
        
        function startHotelCalendarAutoSync() {
            // Verhindere Doppel-Start
            if (autoSyncStarted) {
                console.log('â¸ï¸ Auto-Sync bereits gestartet - Ã¼berspringe');
                return;
            }
            
            // Clear alter Timer (falls vorhanden)
            if (hotelCalendarSyncInterval) {
                clearInterval(hotelCalendarSyncInterval);
            }
            
            console.log('ğŸ”„ Starte Hotel-Kalender Auto-Sync (alle 15 Minuten)...');
            autoSyncStarted = true;
            
            // Sofort einmal syncen
            syncAllHotelCalendars();
            
            // Dann alle 15 Minuten
            hotelCalendarSyncInterval = setInterval(() => {
                console.log('â° Auto-Sync Timer ausgelÃ¶st...');
                syncAllHotelCalendars();
            }, 15 * 60 * 1000); // 15 Minuten
        }
        
        async function syncAllHotelCalendars() {
            console.log('ğŸ”„ Sync ALLE Hotel-Kalender...');
            
            const calendars = Object.entries(hotelCalendars);
            if (calendars.length === 0) {
                console.log('â¸ï¸ Keine Hotel-Kalender zum Syncen');
                return;
            }
            
            for (const [id, cal] of calendars) {
                if (!cal.enabled) {
                    console.log(`â¸ï¸ Ãœberspringe ${cal.name} (pausiert)`);
                    continue;
                }
                
                // Unterscheide Type
                if (cal.type === 'google_calendar_oauth') {
                    await syncGoogleCalendarEvents(id);
                } else {
                    await syncHotelCalendar(id); // iCal
                }
            }
            
            console.log('âœ… Sync aller Hotel-Kalender abgeschlossen');
        }
        
        // ğŸ†• v5.87.41: KOMPLETT NEUE VIEW - Alles in einem!
        function renderHotelCalendarList() {
            const container = document.getElementById('hotel-calendar-list');
            if (!container) return;
            
            const calendars = Object.entries(hotelCalendars);
            
            if (calendars.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;padding:40px;color:#6b7280;">
                        <div style="font-size:48px;margin-bottom:10px;">ğŸ“…</div>
                        <div style="font-weight:600;margin-bottom:6px;">Noch keine Hotel-Kalender</div>
                        <div style="font-size:13px;">Klicke auf "HinzufÃ¼gen" um einen Hotel-Kalender zu verbinden</div>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display:flex;flex-direction:column;gap:16px;">';
            
            calendars.forEach(([id, cal]) => {
                const isExpanded = currentHotelCalendarId === id;
                
                html += `
                    <div style="background:white;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);padding:16px;border-left:4px solid ${cal.color || '#f59e0b'};">
                        <!-- HEADER mit Expand-Button -->
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:${isExpanded ? '16px' : '0'};">
                            <div style="flex:1;">
                                <div style="font-weight:700;font-size:18px;color:#1f2937;margin-bottom:4px;">
                                    ğŸ¨ ${cal.name}
                                </div>
                                <div style="font-size:13px;color:#6b7280;">
                                    ${cal.enabled ? 'âœ… Aktiv' : 'â¸ï¸ Pausiert'} â€¢ Letzte Sync: ${cal.lastSync ? new Date(cal.lastSync).toLocaleString('de-DE') : 'Nie'}
                                </div>
                            </div>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <button onclick="deleteHotelCalendar('${id}')" style="padding:8px 12px;background:#ef4444;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:12px;">
                                    ğŸ—‘ï¸
                                </button>
                                <button onclick="toggleHotelExpand('${id}')" style="padding:10px 16px;background:${isExpanded ? '#3b82f6' : '#6b7280'};color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                                    ${isExpanded ? 'â–¼ Zuklappen' : 'â–¶ Ã–ffnen'}
                                </button>
                            </div>
                        </div>
                        
                        <!-- EXPANDABLE CONTENT -->
                        <div id="hotel-content-${id}" style="display:${isExpanded ? 'block' : 'none'};">
                            <!-- BUTTONS - ğŸ†• v5.87.55: 2 Reihen Layout + Preise Button -->
                            <div style="display:grid;grid-template-columns:${cal.type === 'google_calendar_oauth' ? '1fr 1fr 1fr' : '1fr 1fr'};gap:8px;margin-bottom:8px;">
                                <button id="sync-btn-${id}" onclick="quickSyncHotel('${id}')" style="padding:12px;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                                    ğŸ”„ Sync
                                </button>
                                ${cal.type === 'google_calendar_oauth' ? `
                                <button onclick="renewHotelToken('${id}')" style="padding:12px;background:linear-gradient(135deg,#f59e0b,#d97706);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                                    ğŸ”‘ Token
                                </button>
                                ` : ''}
                                <button onclick="editHotelPricing('${id}')" style="padding:12px;background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                                    ğŸ’° Preise
                                </button>
                            </div>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px;">
                                <button onclick="createHotelInvoice('${id}')" style="padding:12px;background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                                    ğŸ“± Rechnung
                                </button>
                                <button onclick="deleteOnlyHotelEvents('${id}')" style="padding:12px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                                    ğŸ—‘ï¸ LÃ¶schen
                                </button>
                            </div>
                            
                            <!-- EVENTS LISTE -->
                            <div id="hotel-events-${id}" style="max-height:500px;overflow-y:auto;background:#f9fafb;border-radius:8px;padding:12px;">
                                <div style="text-align:center;color:#9ca3af;padding:20px;">
                                    Lade Events...
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // Lade Events fÃ¼r expandierte Hotels
            if (currentHotelCalendarId) {
                loadHotelEvents(currentHotelCalendarId);
            }
        }
        
        // ğŸ†• v5.87.41: Toggle Expand/Collapse
        function toggleHotelExpand(calendarId) {
            if (currentHotelCalendarId === calendarId) {
                currentHotelCalendarId = null;
            } else {
                currentHotelCalendarId = calendarId;
            }
            renderHotelCalendarList();
        }
        
        // ğŸ†• v5.87.41: Lade Events fÃ¼r ein Hotel
        async function loadHotelEvents(calendarId) {
            const container = document.getElementById(`hotel-events-${calendarId}`);
            if (!container) return;
            
            container.innerHTML = '<div style="text-align:center;color:#9ca3af;padding:20px;">â³ Lade Events...</div>';
            
            try {
                // Lade Fahrten fÃ¼r dieses Hotel
                const ridesSnap = await db.ref('rides')
                    .orderByChild('hotelCalendarId')
                    .equalTo(calendarId)
                    .once('value');
                
                const rides = ridesSnap.val() || {};
                const ridesList = Object.entries(rides)
                    .map(([id, ride]) => ({ id, ...ride }))
                    .sort((a, b) => new Date(a.pickupTime) - new Date(b.pickupTime));
                
                if (ridesList.length === 0) {
                    container.innerHTML = `
                        <div style="text-align:center;color:#9ca3af;padding:30px;">
                            <div style="font-size:32px;margin-bottom:8px;">ğŸ“…</div>
                            <div style="font-weight:600;margin-bottom:4px;">Keine Events</div>
                            <div style="font-size:13px;">Klicke auf "ğŸ”„ Jetzt Syncen"</div>
                        </div>
                    `;
                    return;
                }
                
                // Gruppiere nach Datum
                const groupedByDate = {};
                ridesList.forEach(ride => {
                    const date = new Date(ride.pickupTime).toLocaleDateString('de-DE', { 
                        weekday: 'short', 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric' 
                    });
                    if (!groupedByDate[date]) groupedByDate[date] = [];
                    groupedByDate[date].push(ride);
                });
                
                // Render Events
                let html = '';
                Object.entries(groupedByDate).forEach(([date, rides]) => {
                    html += `
                        <div style="background:white;border-radius:8px;padding:12px;margin-bottom:12px;">
                            <div style="font-weight:700;color:#1f2937;margin-bottom:8px;font-size:14px;">
                                ğŸ“… ${date}
                            </div>
                    `;
                    
                    rides.forEach(ride => {
                        const time = new Date(ride.pickupTime).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                        const hasNotes = ride.notes && ride.notes.trim().length > 0;
                        
                        html += `
                            <div style="background:#f9fafb;border-radius:6px;padding:10px;margin-bottom:6px;border-left:3px solid ${ride.hotelCalendarColor || '#f59e0b'};">
                                <div style="display:flex;align-items:start;gap:12px;margin-bottom:${hasNotes ? '8px' : '0'};">
                                    <!-- ğŸ†• v5.87.45: UHRZEIT LINKS -->
                                    <div style="flex-shrink:0;text-align:center;min-width:50px;">
                                        <div style="font-weight:700;color:#1f2937;font-size:16px;">
                                            ${time}
                                        </div>
                                        <div style="font-size:10px;color:${ride.status === 'confirmed' ? '#10b981' : '#f59e0b'};font-weight:600;margin-top:2px;">
                                            ${ride.status === 'confirmed' ? 'âœ“' : 'â—‹'}
                                        </div>
                                    </div>
                                    
                                    <!-- EVENT DETAILS -->
                                    <div style="flex:1;min-width:0;">
                                        <div style="font-weight:600;color:#1f2937;font-size:14px;margin-bottom:4px;word-wrap:break-word;overflow-wrap:break-word;">
                                            ${ride.customerName || 'Unbekannt'}
                                        </div>
                                        <div style="font-size:12px;color:#6b7280;margin-bottom:2px;">
                                            ğŸ“ ${ride.pickup || '?'} â†’ ${ride.destination || '?'}
                                        </div>
                                        <div style="font-size:12px;color:#6b7280;">
                                            ğŸ‘¥ ${ride.persons || 1} Person${ride.persons > 1 ? 'en' : ''}
                                        </div>
                                    </div>
                                </div>
                                ${hasNotes ? `
                                    <div style="padding:8px;background:white;border-radius:4px;border-left:2px solid #3b82f6;font-size:12px;color:#4b5563;word-wrap:break-word;overflow-wrap:break-word;margin-left:62px;">
                                        ğŸ“ ${ride.notes}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden:', error);
                container.innerHTML = `
                    <div style="text-align:center;color:#ef4444;padding:20px;">
                        ğŸ’¾ Fehler: ${error.message}
                    </div>
                `;
            }
        }
        
        // ğŸ†• v5.87.41: Quick Sync mit Auto-Reload
        async function quickSyncHotel(calendarId) {
            const container = document.getElementById(`hotel-events-${calendarId}`);
            const syncBtn = document.getElementById(`sync-btn-${calendarId}`);
            
            // ğŸ†• v5.87.53: LOADING STATE im Button!
            if (syncBtn) {
                syncBtn.disabled = true;
                syncBtn.style.opacity = '0.6';
                syncBtn.style.cursor = 'not-allowed';
                syncBtn.innerHTML = 'â³ LÃ¤dt...';
            }
            
            if (container) {
                container.innerHTML = '<div style="text-align:center;color:#3b82f6;padding:20px;font-weight:600;">â³ Synchronisiere mit Google Kalender...</div>';
            }
            
            try {
                // Lade Hotel
                const hotelSnap = await db.ref(`hotelCalendars/${calendarId}`).once('value');
                const calendar = hotelSnap.val();
                
                if (!calendar) {
                    alert('ğŸ’¾ Hotel nicht gefunden!');
                    return;
                }
                
                // Sync
                console.log('ğŸ”„ Quick-Sync startet:', calendar.name);
                await syncGoogleCalendarEvents(calendarId, calendar);
                console.log('âœ… Quick-Sync abgeschlossen');
                
                // Reload Events
                await loadHotelEvents(calendarId);
                
                // ğŸ†• v5.87.53: SUCCESS MESSAGE Ã¼ber Events!
                const eventsContainer = document.getElementById(`hotel-events-${calendarId}`);
                if (eventsContainer && !eventsContainer.innerHTML.includes('Keine Events')) {
                    // ZÃ¤hle Events
                    const ridesSnap = await db.ref('rides')
                        .orderByChild('hotelCalendarId')
                        .equalTo(calendarId)
                        .once('value');
                    const count = ridesSnap.val() ? Object.keys(ridesSnap.val()).length : 0;
                    
                    // Success Message ÃœBER Events
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = 'background:linear-gradient(135deg,#10b981,#059669);color:white;padding:12px;border-radius:8px;margin-bottom:16px;text-align:center;font-weight:600;font-size:14px;';
                    successMsg.innerHTML = `âœ… ${count} Event${count !== 1 ? 's' : ''} geladen!`;
                    eventsContainer.insertBefore(successMsg, eventsContainer.firstChild);
                    
                    // Nach 5 Sekunden ausblenden
                    setTimeout(() => {
                        successMsg.style.transition = 'opacity 0.5s';
                        successMsg.style.opacity = '0';
                        setTimeout(() => successMsg.remove(), 500);
                    }, 5000);
                }
                
            } catch (error) {
                console.error('ğŸ’¾ Quick-Sync Fehler:', error);
                if (container) {
                    container.innerHTML = `
                        <div style="text-align:center;color:#ef4444;padding:20px;font-weight:600;">
                            ğŸ’¾ Sync Fehler: ${error.message || 'Unbekannter Fehler'}
                        </div>
                    `;
                }
            } finally {
                // ğŸ†• v5.87.53: Button wieder aktivieren!
                if (syncBtn) {
                    syncBtn.disabled = false;
                    syncBtn.style.opacity = '1';
                    syncBtn.style.cursor = 'pointer';
                    syncBtn.innerHTML = 'ğŸ”„ Sync';
                }
            }
        }
        
        // ğŸ“… v5.87.23: GOOGLE CALENDAR OAUTH INTEGRATION
        
        // ğŸ†• v5.87.24: MULTI-HOTEL OAUTH
        // Jedes Hotel hat eigenen OAuth Token!
        let currentHotelOAuthFlow = null; // TemporÃ¤r wÃ¤hrend OAuth
        let googleCalendarsList = [];
        
        // ğŸ†• v5.87.24: NEUES HOTEL MIT GOOGLE VERBINDEN
        async function addNewHotelWithOAuth() {
            const hotelName = prompt('ğŸ¨ Hotel-Name eingeben:');
            if (!hotelName || !hotelName.trim()) {
                return;
            }
            
            await connectGoogleCalendarForHotel(hotelName.trim());
        }
        
        // ğŸ†• v5.87.42: AUTO-REFRESH TOKEN SYSTEM
        async function refreshGoogleToken(calendarId) {
            console.log('ğŸ”„ Starte Token Refresh fÃ¼r:', calendarId);
            
            try {
                // Lade Hotel mit altem Token
                const hotelSnap = await db.ref(`hotelCalendars/${calendarId}`).once('value');
                const hotel = hotelSnap.val();
                
                if (!hotel || !hotel.refreshToken) {
                    console.error('ğŸ’¾ Kein Refresh Token vorhanden!');
                    console.warn('âš ï¸ Hotel muss neu verbunden werden um Refresh Token zu erhalten');
                    throw new Error('Kein Refresh Token - bitte Hotel neu verbinden');
                }
                
                console.log('ğŸ”‘ Nutze Refresh Token fÃ¼r neues Access Token...');
                
                // WICHTIG: Firebase nutzt OAuth 2.0 unter der Haube
                // Wir mÃ¼ssen den Token direkt Ã¼ber Firebase neu authentifizieren
                
                // TemporÃ¤rer Re-Login mit Refresh Token
                const credential = firebase.auth.GoogleAuthProvider.credential(
                    null, // ID Token
                    hotel.refreshToken // Refresh Token
                );
                
                // Speichere aktuellen User
                const currentAuthUser = auth.currentUser;
                const wasLoggedIn = !!currentAuthUser;
                const previousEmail = currentAuthUser ? currentAuthUser.email : null;
                
                console.log('ğŸ”„ FÃ¼hre temporÃ¤ren Re-Auth durch...');
                
                // Re-authenticate
                const userCredential = await auth.signInWithCredential(credential);
                
                // Hole frisches Access Token
                const newAccessToken = await userCredential.user.getIdToken(true);
                
                console.log('âœ… Neues Access Token erhalten!');
                
                // Speichere neues Token in Firebase
                await db.ref(`hotelCalendars/${calendarId}`).update({
                    accessToken: newAccessToken,
                    tokenExpiry: Date.now() + (3600 * 1000), // 1 Stunde
                    lastTokenRefresh: Date.now()
                });
                
                console.log('ğŸ’¾ Neues Token gespeichert');
                
                // Logout vom temporÃ¤ren Auth
                await auth.signOut();
                
                // Re-Login als vorheriger User (falls eingeloggt)
                if (wasLoggedIn && previousEmail && currentUser) {
                    console.log(`ğŸ”„ Re-Login als: ${previousEmail}`);
                    // User sollte automatisch wieder eingeloggt werden durch Firebase Persistence
                }
                
                // Update lokales Hotel-Objekt
                if (hotelCalendars[calendarId]) {
                    hotelCalendars[calendarId].accessToken = newAccessToken;
                    hotelCalendars[calendarId].tokenExpiry = Date.now() + (3600 * 1000);
                }
                
                return newAccessToken;
                
            } catch (error) {
                console.error('ğŸ’¾ Token Refresh Fehler:', error);
                console.error('ğŸ“‹ Details:', {
                    message: error.message,
                    code: error.code,
                    name: error.name
                });
                throw new Error('Token Refresh fehlgeschlagen - bitte Hotel neu verbinden');
            }
        }
        
        // ğŸ†• v5.87.49: TOKEN ERNEUERN fÃ¼r bestehenden Kalender!
        async function renewHotelToken(calendarId) {
            console.log('ğŸ”‘ Starte Token-Erneuerung fÃ¼r Kalender:', calendarId);
            
            try {
                // Hole bestehende Hotel-Daten
                const hotelSnap = await db.ref(`hotelCalendars/${calendarId}`).once('value');
                const hotel = hotelSnap.val();
                
                if (!hotel) {
                    alert('ğŸ’¾ Hotel nicht gefunden!');
                    return;
                }
                
                const confirmed = confirm(
                    `ğŸ”‘ Token erneuern\n\n` +
                    `Hotel: ${hotel.name}\n\n` +
                    `Ich Ã¶ffne jetzt Google Login um neue Zugangsdaten zu holen.\n\n` +
                    `Der Kalender bleibt bestehen, nur die Verbindung wird erneuert!\n\n` +
                    `Fortfahren?`
                );
                
                if (!confirmed) return;
                
                console.log(`ğŸ” Starte OAuth fÃ¼r: ${hotel.name}`);
                
                // Speichere aktuellen Admin-User
                const savedAdminUser = currentUser;
                
                // WICHTIG: Logout von Firebase Auth damit OAuth sauber funktioniert
                await auth.signOut();
                console.log('ğŸšª Firebase Auth Logout (fÃ¼r OAuth)');
                
                // OAuth Provider mit RICHTIGEN Scopes!
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('https://www.googleapis.com/auth/calendar.readonly');
                provider.addScope('https://www.googleapis.com/auth/calendar.events.readonly');
                
                // ğŸ†• v5.87.42: WICHTIG fÃ¼r Refresh Token!
                provider.setCustomParameters({
                    'access_type': 'offline',
                    'prompt': 'consent'  // Erzwingt Consent Screen = Refresh Token!
                });
                
                console.log('ğŸ” Ã–ffne Google Login...');
                
                // OAuth Login
                const result = await auth.signInWithPopup(provider);
                const credential = result.credential;
                const accessToken = credential.accessToken;
                const refreshToken = result.user.refreshToken;
                
                console.log('âœ… OAuth erfolgreich!');
                console.log('ğŸ”‘ Access Token erhalten:', accessToken ? 'Ja' : 'Nein');
                console.log('ğŸ”‘ Refresh Token erhalten:', refreshToken ? 'Ja' : 'Nein');
                
                // Hole Kalender-Liste
                const calendarsResponse = await fetch(
                    'https://www.googleapis.com/calendar/v3/users/me/calendarList',
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );
                
                if (!calendarsResponse.ok) {
                    throw new Error('Kalender-Liste konnte nicht geladen werden');
                }
                
                const calendarsData = await calendarsResponse.json();
                const calendars = calendarsData.items || [];
                
                console.log(`ğŸ“… ${calendars.length} Kalender gefunden`);
                
                // Zeige Kalender-Auswahl
                const calendarChoices = calendars.map((cal, i) => 
                    `${i + 1}. ${cal.summary} (${cal.id})`
                ).join('\n');
                
                const choice = prompt(
                    `ğŸ“… Welcher Kalender?\n\n${calendarChoices}\n\nGib die Nummer ein:`
                );
                
                if (!choice) {
                    await auth.signOut();
                    if (savedAdminUser) {
                        await auth.signInWithEmailAndPassword(savedAdminUser.email, 'dummy');
                    }
                    return;
                }
                
                const selectedIndex = parseInt(choice) - 1;
                if (selectedIndex < 0 || selectedIndex >= calendars.length) {
                    alert('ğŸ’¾ UngÃ¼ltige Auswahl!');
                    return;
                }
                
                const selectedCalendar = calendars[selectedIndex];
                
                console.log('âœ… Kalender gewÃ¤hlt:', selectedCalendar.summary);
                
                // UPDATE bestehenden Kalender mit neuen Tokens!
                await db.ref(`hotelCalendars/${calendarId}`).update({
                    googleCalendarId: selectedCalendar.id,
                    googleCalendarName: selectedCalendar.summary,
                    accessToken: accessToken,
                    refreshToken: refreshToken || null,
                    tokenExpiry: Date.now() + (3600 * 1000), // 1 Stunde
                    lastSync: Date.now(),
                    lastTokenRefresh: Date.now()
                });
                
                console.log('âœ… Token erneuert in Firebase!');
                
                // Update lokales Objekt
                if (hotelCalendars[calendarId]) {
                    hotelCalendars[calendarId].googleCalendarId = selectedCalendar.id;
                    hotelCalendars[calendarId].googleCalendarName = selectedCalendar.summary;
                    hotelCalendars[calendarId].accessToken = accessToken;
                    hotelCalendars[calendarId].refreshToken = refreshToken || null;
                    hotelCalendars[calendarId].tokenExpiry = Date.now() + (3600 * 1000);
                    hotelCalendars[calendarId].lastTokenRefresh = Date.now();
                }
                
                // ğŸ†• v5.87.50: SOFORTIGER Logout + Login-Screen
                console.log('âœ… Token erneuert - starte Logout...');
                
                alert(
                    `âœ… Token erneuert!\n\n` +
                    `Hotel: ${hotel.name}\n` +
                    `Kalender: ${selectedCalendar.summary}\n\n` +
                    `Refresh Token: ${refreshToken ? 'Ja (6+ Monate gÃ¼ltig!)' : 'Nein'}\n\n` +
                    `âš ï¸ WICHTIG:\n` +
                    `Ich mache jetzt LOGOUT und du musst dich\n` +
                    `mit deinem ADMIN-ACCOUNT wieder einloggen!\n\n` +
                    `Klicke OK fÃ¼r Logout...`
                );
                
                // SOFORTIGER Logout
                await auth.signOut();
                console.log('ğŸšª Logout durchgefÃ¼hrt');
                
                // LÃ¶sche lokale Daten
                currentUser = null;
                localStorage.removeItem('lastUser');
                
                // Zeige Login-Screen
                switchView('auth');
                
                // Info-Message auf Login-Screen
                setTimeout(() => {
                    const infoDiv = document.createElement('div');
                    infoDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: linear-gradient(135deg, #f59e0b, #d97706);
                        color: white;
                        padding: 20px;
                        border-radius: 12px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 999999;
                        font-weight: 600;
                        text-align: center;
                        max-width: 400px;
                    `;
                    infoDiv.innerHTML = `
                        âš ï¸ TOKEN ERNEUERT!<br><br>
                        Bitte jetzt mit<br>
                        <strong>ADMIN-ACCOUNT</strong><br>
                        einloggen!
                    `;
                    document.body.appendChild(infoDiv);
                    
                    setTimeout(() => {
                        infoDiv.remove();
                    }, 10000); // 10 Sekunden
                }, 500);
                
                // Reload Hotels (nach Login)
                renderHotelCalendarList();
                
            } catch (error) {
                console.error('ğŸ’¾ Token-Erneuerung fehlgeschlagen:', error);
                alert(`ğŸ’¾ Fehler: ${error.message}`);
            }
        }
        
        // ğŸ†• v5.87.55: PREIS-REGELN PRO HOTEL
        
        // Feiertage fÃ¼r Mecklenburg-Vorpommern
        function getHolidaysMV(year) {
            const holidays = [];
            
            // Feste Feiertage
            holidays.push(`${year}-01-01`); // Neujahr
            holidays.push(`${year}-05-01`); // Tag der Arbeit
            holidays.push(`${year}-10-03`); // Tag der Deutschen Einheit
            holidays.push(`${year}-10-31`); // Reformationstag (MV!)
            holidays.push(`${year}-12-25`); // 1. Weihnachtsfeiertag
            holidays.push(`${year}-12-26`); // 2. Weihnachtsfeiertag
            
            // Bewegliche Feiertage (Ostern-basiert) - vereinfacht fÃ¼r 2025
            if (year === 2025) {
                holidays.push('2025-04-18'); // Karfreitag
                holidays.push('2025-04-21'); // Ostermontag
                holidays.push('2025-05-29'); // Christi Himmelfahrt
                holidays.push('2025-06-09'); // Pfingstmontag
            }
            // FÃ¼r andere Jahre mÃ¼ssten wir Osterdatum berechnen
            
            return holidays;
        }
        
        // PrÃ¼fe ob Datum ein Feiertag ist
        function isHoliday(date) {
            const year = date.getFullYear();
            const dateStr = getLocalDateString(date);  // ğŸ”§ v5.90.353: LOKAL!
            const holidays = getHolidaysMV(year);
            return holidays.includes(dateStr);
        }
        
        // Ermittle Tag-Typ (weekday/saturday/sunday)
        function getDayType(date) {
            const day = date.getDay(); // 0=Sonntag, 6=Samstag
            
            if (isHoliday(date)) return 'sunday'; // Feiertag = wie Sonntag
            if (day === 0) return 'sunday';
            if (day === 6) return 'saturday';
            return 'weekday';
        }
        
        // Erkenne Ziel-Typ
        function detectDestinationType(destination) {
            if (!destination) return 'sonstiges';
            
            const dest = destination.toLowerCase();
            
            // Bahnhof
            if (dest.includes('bahnhof') || dest.includes('bhf')) {
                return 'bahnhof';
            }
            
            // Flughafen
            if (dest.includes('flughafen') || dest.includes('flgh') || dest.includes('airport')) {
                return 'flughafen';
            }
            
            return 'sonstiges';
        }
        
        // Ã–ffne Preis-Dialog
        async function editHotelPricing(calendarId) {
            try {
                // Lade Hotel
                const hotelSnap = await db.ref(`hotelCalendars/${calendarId}`).once('value');
                const hotel = hotelSnap.val();
                
                if (!hotel) {
                    alert('ğŸ’¾ Hotel nicht gefunden!');
                    return;
                }
                
                // Standard-Preise wenn noch keine vorhanden
                const pricing = hotel.pricingRules || {
                    bahnhof: { weekday: 8.00, saturday: 9.00, sunday: 10.00 },
                    flughafen: { weekday: 45.00, saturday: 50.00, sunday: 55.00 },
                    sonstiges: { weekday: 20.00, saturday: 25.00, sunday: 30.00 }
                };
                
                // Erstelle Dialog
                const dialog = document.createElement('div');
                dialog.id = 'pricing-dialog';
                dialog.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 99999;
                `;
                
                dialog.innerHTML = `
                    <div style="
                        background: white;
                        border-radius: 16px;
                        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
                        max-width: 500px;
                        width: 90%;
                        max-height: 90vh;
                        overflow-y: auto;
                    ">
                        <!-- HEADER -->
                        <div style="
                            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
                            color: white;
                            padding: 20px;
                            border-radius: 16px 16px 0 0;
                        ">
                            <div style="font-size: 24px; font-weight: 700; margin-bottom: 4px;">
                                ğŸ’° Preis-Regeln
                            </div>
                            <div style="font-size: 14px; opacity: 0.9;">
                                ${hotel.name}
                            </div>
                        </div>
                        
                        <!-- CONTENT -->
                        <div style="padding: 24px;">
                            <!-- ğŸ†• v5.87.65: BAHNHOF VEREINFACHT - NUR 2 FELDER -->
                            <div style="margin-bottom: 24px;">
                                <div style="font-size: 16px; font-weight: 700; color: #1f2937; margin-bottom: 12px;">
                                    ğŸš‚ Bahnhof (wird automatisch erkannt wenn "bahnhof" im Text)
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div>
                                        <label style="font-size: 12px; color: #6b7280; font-weight: 600; display: block; margin-bottom: 4px;">
                                            Mo-Sa
                                        </label>
                                        <input type="number" id="price-bahnhof-weekday" value="${pricing.bahnhof.weekday.toFixed(2)}" step="0.01" min="0" style="
                                            width: 100%;
                                            padding: 10px;
                                            border: 2px solid #e5e7eb;
                                            border-radius: 8px;
                                            font-size: 16px;
                                            font-weight: 600;
                                        ">
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: #6b7280; font-weight: 600; display: block; margin-bottom: 4px;">
                                            So/Feiertag
                                        </label>
                                        <input type="number" id="price-bahnhof-sunday" value="${pricing.bahnhof.sunday.toFixed(2)}" step="0.01" min="0" style="
                                            width: 100%;
                                            padding: 10px;
                                            border: 2px solid #e5e7eb;
                                            border-radius: 8px;
                                            font-size: 16px;
                                            font-weight: 600;
                                        ">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ğŸ†• v5.87.65: FLUGHAFEN VEREINFACHT - NUR 1 FELD -->
                            <div style="margin-bottom: 24px;">
                                <div style="font-size: 16px; font-weight: 700; color: #1f2937; margin-bottom: 12px;">
                                    âœˆï¸ Flughafen
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #6b7280; font-weight: 600; display: block; margin-bottom: 4px;">
                                        Alle Tage
                                    </label>
                                    <input type="number" id="price-flughafen-weekday" value="${pricing.flughafen.weekday.toFixed(2)}" step="0.01" min="0" style="
                                        width: 100%;
                                        padding: 10px;
                                        border: 2px solid #e5e7eb;
                                        border-radius: 8px;
                                        font-size: 16px;
                                        font-weight: 600;
                                    ">
                                </div>
                            </div>
                            
                            <!-- ğŸ†• v5.87.65: Sonstiges entfernt - nicht benÃ¶tigt! -->
                            
                            <!-- INFO -->
                            <div style="
                                background: #eff6ff;
                                border-left: 3px solid #3b82f6;
                                padding: 12px;
                                border-radius: 8px;
                                margin-bottom: 20px;
                            ">
                                <div style="font-size: 12px; color: #1e40af; line-height: 1.5;">
                                    â„¹ï¸ Diese Preise werden automatisch bei der Rechnungserstellung verwendet.
                                    Feiertage in MV werden wie Sonntage behandelt.
                                </div>
                            </div>
                            
                            <!-- BUTTONS -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <button onclick="closePricingDialog()" style="
                                    padding: 14px;
                                    background: #e5e7eb;
                                    color: #1f2937;
                                    border: none;
                                    border-radius: 8px;
                                    font-weight: 600;
                                    cursor: pointer;
                                    font-size: 14px;
                                ">
                                    ğŸ’¾ Abbrechen
                                </button>
                                <button onclick="saveHotelPricing('${calendarId}')" style="
                                    padding: 14px;
                                    background: linear-gradient(135deg, #10b981, #059669);
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    font-weight: 600;
                                    cursor: pointer;
                                    font-size: 14px;
                                ">
                                    âœ… Speichern
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(dialog);
                
                // Focus erstes Feld
                setTimeout(() => {
                    document.getElementById('price-bahnhof-weekday')?.focus();
                }, 100);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Ã–ffnen:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // SchlieÃŸe Dialog
        function closePricingDialog() {
            const dialog = document.getElementById('pricing-dialog');
            if (dialog) dialog.remove();
        }
        
        // ğŸ†• v5.87.65: Speichere vereinfachte Preis-Regeln
        async function saveHotelPricing(calendarId) {
            try {
                // ğŸ†• v5.87.65: VEREINFACHT!
                // Bahnhof: Mo-Sa + So/Feiertag
                // Flughafen: Alle Tage gleich
                const bahnhofWeekday = parseFloat(document.getElementById('price-bahnhof-weekday').value) || 0;
                const bahnhofSunday = parseFloat(document.getElementById('price-bahnhof-sunday').value) || 0;
                const flughafen = parseFloat(document.getElementById('price-flughafen-weekday').value) || 0;
                
                const pricingRules = {
                    bahnhof: {
                        weekday: bahnhofWeekday,    // Mo-Sa
                        saturday: bahnhofWeekday,   // Gleich wie Mo-Sa!
                        sunday: bahnhofSunday       // So/Feiertag
                    },
                    flughafen: {
                        weekday: flughafen,   // Alle Tage gleich
                        saturday: flughafen,  // Alle Tage gleich
                        sunday: flughafen     // Alle Tage gleich
                    },
                    sonstiges: {
                        weekday: 0,   // Nicht mehr verwendet
                        saturday: 0,  // Nicht mehr verwendet
                        sunday: 0     // Nicht mehr verwendet
                    }
                };
                
                console.log('ğŸ’¾ Speichere Preis-Regeln:', pricingRules);
                
                // Speichere in Firebase
                await db.ref(`hotelCalendars/${calendarId}/pricingRules`).set(pricingRules);
                
                console.log('âœ… Preis-Regeln gespeichert!');
                
                // SchlieÃŸe Dialog
                closePricingDialog();
                
                // Success Message
                const successMsg = document.createElement('div');
                successMsg.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #10b981, #059669);
                    color: white;
                    padding: 16px 24px;
                    border-radius: 12px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    z-index: 999999;
                    font-weight: 600;
                `;
                successMsg.textContent = 'âœ… Preis-Regeln gespeichert!';
                document.body.appendChild(successMsg);
                
                setTimeout(() => {
                    successMsg.style.transition = 'opacity 0.5s';
                    successMsg.style.opacity = '0';
                    setTimeout(() => successMsg.remove(), 500);
                }, 3000);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Speichern:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // ğŸ†• v5.87.24: Verbinde EINZELNES Hotel mit Google Calendar (OAuth)
        async function connectGoogleCalendarForHotel(hotelName) {
            try {
                console.log(`ğŸ” Starte Google Calendar OAuth fÃ¼r Hotel: ${hotelName}...`);
                
                // ğŸ†• v5.87.24: ADMIN-USER SPEICHERN!
                const savedAdminUser = currentUser;
                const savedAdminEmail = savedAdminUser ? savedAdminUser.email : null;
                
                if (!savedAdminUser) {
                    alert('ğŸ’¾ Fehler: Nicht eingeloggt!\n\nBitte logge dich zuerst ein.');
                    return;
                }
                
                console.log(`ğŸ’¾ Speichere Admin-User: ${savedAdminEmail}`);
                
                // Info fÃ¼r User
                const confirmed = confirm(
                    `ğŸ” Google Login fÃ¼r Hotel: ${hotelName}\n\n` +
                    `Schritt 1: Hotel-Account Login\n` +
                    `â†’ Melde dich mit HOTEL-Account an\n` +
                    `   (z.B. hotel-seebruecke@gmail.com)\n\n` +
                    `Schritt 2: Admin-Login wiederherstellen\n` +
                    `â†’ Melde dich wieder mit DEINEM Account an\n` +
                    `   (${savedAdminEmail})\n\n` +
                    `âš ï¸ Du musst zweimal auf "Zulassen" klicken!\n\n` +
                    `Fortfahren?`
                );
                
                if (!confirmed) {
                    console.log('â¸ï¸ Abgebrochen');
                    return;
                }
                
                // Firebase OAuth fÃ¼r Hotel-Account
                const hotelProvider = new firebase.auth.GoogleAuthProvider();
                hotelProvider.addScope('https://www.googleapis.com/auth/calendar.readonly');
                hotelProvider.addScope('https://www.googleapis.com/auth/calendar.events.readonly');
                
                // ğŸ†• v5.87.42: Fordere Refresh Token an!
                hotelProvider.setCustomParameters({
                    'access_type': 'offline',
                    'prompt': 'consent'
                });
                
                console.log('ğŸ” Schritt 1/2: Hotel-Account Login...');
                console.log('âš ï¸ WICHTIG: WÃ¤hle den HOTEL-Account aus!');
                console.log('ğŸ”„ Fordere Refresh Token an (offline access)...');
                
                // TemporÃ¤rer Login mit Hotel-Account
                const hotelResult = await auth.signInWithPopup(hotelProvider);
                
                // Access Token holen
                const credential = hotelResult.credential;
                const accessToken = credential.accessToken;
                const hotelGoogleEmail = hotelResult.user.email;
                
                console.log('âœ… Hotel OAuth erfolgreich!');
                console.log(`ğŸ“§ Hotel-Account: ${hotelGoogleEmail}`);
                console.log('ğŸ”‘ Access Token erhalten');
                
                // Speichere temporÃ¤r fÃ¼r Kalender-Auswahl
                currentHotelOAuthFlow = {
                    hotelName: hotelName,
                    googleEmail: hotelGoogleEmail,
                    accessToken: accessToken,
                    refreshToken: credential.refreshToken || null
                };
                
                // Logout vom Hotel-Account
                console.log('ğŸ”„ Logout vom Hotel-Account...');
                await auth.signOut();
                
                // Re-Login als Admin
                console.log(`ğŸ” Schritt 2/2: Admin-Login wiederherstellen...`);
                console.log(`âš ï¸ WICHTIG: WÃ¤hle DEINEN Account aus: ${savedAdminEmail}`);
                
                const adminProvider = new firebase.auth.GoogleAuthProvider();
                adminProvider.setCustomParameters({
                    login_hint: savedAdminEmail,
                    prompt: 'select_account' // Zeige Account-Auswahl
                });
                
                try {
                    const adminResult = await auth.signInWithPopup(adminProvider);
                    console.log(`âœ… Wieder eingeloggt als Admin: ${adminResult.user.email}`);
                    
                    // PrÃ¼fe ob richtiger Account
                    if (adminResult.user.email !== savedAdminEmail) {
                        console.warn(`âš ï¸ Falscher Account! Erwartet: ${savedAdminEmail}, Bekommen: ${adminResult.user.email}`);
                        alert(`âš ï¸ Du hast dich mit einem anderen Account angemeldet!\n\nErwartet: ${savedAdminEmail}\nAngemeldet: ${adminResult.user.email}\n\nBitte logge dich manuell mit dem richtigen Admin-Account ein.`);
                    }
                    
                } catch (reLoginError) {
                    console.error('ğŸ’¾ Admin Re-Login fehlgeschlagen:', reLoginError);
                    alert(`ğŸ’¾ Fehler beim ZurÃ¼ck-Einloggen!\n\nBitte logge dich manuell wieder als Admin ein:\n${savedAdminEmail}`);
                    return;
                }
                
                // Lade Kalender-Liste VON HOTEL-ACCOUNT (mit gespeichertem Token!)
                await loadGoogleCalendarsForHotel(accessToken);
                
                // Zeige Kalender-Auswahl Modal
                showGoogleCalendarSelectionModal();
                
            } catch (error) {
                console.error('ğŸ’¾ Google Calendar OAuth Fehler:', error);
                
                if (error.code === 'auth/popup-blocked') {
                    alert('ğŸ’¾ Popup wurde blockiert!\n\nBitte erlaube Popups fÃ¼r diese Seite und versuche es nochmal.');
                } else if (error.code === 'auth/cancelled-popup-request') {
                    console.log('â¸ï¸ OAuth abgebrochen');
                } else if (error.code === 'auth/user-mismatch') {
                    alert('ğŸ’¾ Account-Fehler!\n\nDu hast dich mit einem anderen Account angemeldet als vorher.\n\nBitte melde dich mit dem HOTEL-Account an!');
                } else {
                    alert('ğŸ’¾ Verbindung fehlgeschlagen:\n\n' + error.message + '\n\nBitte aktiviere zuerst die Google Calendar API in der Google Cloud Console.');
                }
            }
        }
        
        // ğŸ†• v5.87.24: Lade Kalender-Liste FÃœR SPEZIFISCHES HOTEL
        async function loadGoogleCalendarsForHotel(accessToken) {
            try {
                console.log('ğŸ“… Lade Google Kalender-Liste...');
                
                const response = await fetch('https://www.googleapis.com/calendar/v3/users/me/calendarList', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                googleCalendarsList = data.items || [];
                
                console.log(`âœ… ${googleCalendarsList.length} Kalender gefunden`);
                googleCalendarsList.forEach(cal => {
                    console.log(`  ğŸ“… ${cal.summary} (${cal.id})`);
                });
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der Kalender:', error);
                alert('ğŸ’¾ Kalender konnten nicht geladen werden:\n\n' + error.message);
                throw error;
            }
        }
        
        // Verbinde mit Google Calendar (OAuth) - ALTE FUNKTION FÃœR RÃœCKWÃ„RTS-KOMPATIBILITÃ„T
        async function connectGoogleCalendar() {
            // Leite um zur neuen Multi-Hotel Funktion
            await addNewHotelWithOAuth();
        }
        
        // Lade Google Kalender-Liste
        // ğŸ†• v5.87.24: Alte Funktion - jetzt Dummy fÃ¼r RÃ¼ckwÃ¤rts-KompatibilitÃ¤t
        async function loadGoogleCalendars() {
            console.log('âš ï¸ loadGoogleCalendars() ist deprecated - verwende loadGoogleCalendarsForHotel(accessToken)');
            return [];
        }
        
        // Zeige Kalender-Auswahl Modal
        function showGoogleCalendarSelectionModal() {
            if (!currentHotelOAuthFlow) {
                alert('ğŸ’¾ Fehler: Keine OAuth-Daten vorhanden!');
                return;
            }
            
            let html = `
                <div id="google-calendar-modal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;">
                    <div style="background:white;border-radius:16px;padding:24px;max-width:600px;width:90%;max-height:80vh;overflow:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                        <h3 style="margin:0 0 8px 0;color:#1f2937;font-size:20px;">ğŸ“… Kalender auswÃ¤hlen</h3>
                        <div style="margin:0 0 20px 0;padding:12px;background:#f0fdf4;border:2px solid #10b981;border-radius:8px;">
                            <div style="font-weight:600;color:#048257;margin-bottom:4px;">ğŸ¨ ${currentHotelOAuthFlow.hotelName}</div>
                            <div style="font-size:13px;color:#059669;">ğŸ“§ ${currentHotelOAuthFlow.googleEmail}</div>
                        </div>
                        <p style="margin:0 0 16px 0;color:#6b7280;font-size:14px;">WÃ¤hle den Hotel-Kalender aus:</p>
                        
                        <div style="max-height:400px;overflow-y:auto;margin-bottom:20px;">
            `;
            
            googleCalendarsList.forEach(calendar => {
                html += `
                    <div onclick="selectSingleCalendar('${calendar.id}')" 
                         id="cal-${calendar.id.replace(/[^a-zA-Z0-9]/g, '_')}" 
                         style="padding:12px;border:2px solid #e5e7eb;border-radius:8px;margin-bottom:8px;cursor:pointer;display:flex;align-items:center;gap:12px;transition:all 0.2s;">
                        <div style="width:24px;height:24px;border:2px solid #cbd5e1;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;background:white;">
                            <span class="check-icon" style="display:none;color:#10b981;font-weight:bold;font-size:16px;">â—</span>
                        </div>
                        <div style="flex:1;">
                            <div style="font-weight:600;color:#1f2937;margin-bottom:2px;">${calendar.summary}</div>
                            <div style="font-size:12px;color:#6b7280;">${calendar.id}</div>
                        </div>
                        <div style="width:20px;height:20px;border-radius:4px;background:${calendar.backgroundColor || '#3b82f6'};flex-shrink:0;"></div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                        
                        <div style="display:flex;gap:12px;">
                            <button onclick="saveSelectedGoogleCalendars()" style="flex:1;padding:14px;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:15px;">
                                âœ… Speichern
                            </button>
                            <button onclick="closeGoogleCalendarModal()" style="flex:1;padding:14px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:15px;">
                                ğŸ’¾ Abbrechen
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        // ğŸ†• v5.87.24: Single Calendar Selection (nur EIN Kalender pro Hotel!)
        window.selectSingleCalendar = function(calendarId) {
            // Deselect all
            document.querySelectorAll('#google-calendar-modal [id^="cal-"]').forEach(el => {
                el.classList.remove('selected');
                el.style.border = '2px solid #e5e7eb';
                el.style.background = 'white';
                el.querySelector('.check-icon').style.display = 'none';
                el.querySelector('.check-icon').parentElement.style.background = 'white';
                el.querySelector('.check-icon').parentElement.style.borderColor = '#cbd5e1';
            });
            
            // Select this one
            const elementId = 'cal-' + calendarId.replace(/[^a-zA-Z0-9]/g, '_');
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.classList.add('selected');
            element.style.border = '2px solid #10b981';
            element.style.background = '#f0fdf4';
            element.querySelector('.check-icon').style.display = 'block';
            element.querySelector('.check-icon').parentElement.style.background = '#10b981';
            element.querySelector('.check-icon').parentElement.style.borderColor = '#10b981';
        };
        
        // Toggle Kalender-Auswahl - DEPRECATED, nutze selectSingleCalendar
        window.toggleCalendarSelection = function(calendarId) {
            selectSingleCalendar(calendarId);
        };
        
        // ğŸ†• v5.87.24: Speichere Hotel mit Google Calendar
        window.saveSelectedGoogleCalendars = async function() {
            if (!currentHotelOAuthFlow) {
                alert('ğŸ’¾ Fehler: Keine OAuth-Daten vorhanden!');
                return;
            }
            
            const selectedElements = document.querySelectorAll('#google-calendar-modal .selected');
            
            if (selectedElements.length === 0) {
                alert('ğŸ’¾ Bitte wÃ¤hle einen Kalender aus!');
                return;
            }
            
            if (selectedElements.length > 1) {
                alert('âš ï¸ Bitte wÃ¤hle nur EINEN Kalender pro Hotel aus!');
                return;
            }
            
            const element = selectedElements[0];
            const calendarId = element.id.replace('cal-', '').replace(/_/g, '.');
            const calendar = googleCalendarsList.find(c => c.id.replace(/[^a-zA-Z0-9]/g, '_') === calendarId.replace(/[^a-zA-Z0-9]/g, '_'));
            
            if (!calendar) {
                alert('ğŸ’¾ Kalender nicht gefunden!');
                return;
            }
            
            console.log(`ğŸ’¾ Speichere Hotel: ${currentHotelOAuthFlow.hotelName}`);
            console.log(`ğŸ“… Kalender: ${calendar.summary}`);
            console.log(`ğŸ“§ Account: ${currentHotelOAuthFlow.googleEmail}`);
            
            // Speichere in Firebase mit ALLEN Hotel-Daten
            const hotelKey = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const hotelData = {
                // Hotel-Info
                name: currentHotelOAuthFlow.hotelName,
                type: 'google_calendar_oauth',
                
                // Google Account Info
                googleEmail: currentHotelOAuthFlow.googleEmail,
                googleCalendarId: calendar.id,
                googleCalendarName: calendar.summary,
                
                // OAuth Tokens
                accessToken: currentHotelOAuthFlow.accessToken,
                refreshToken: currentHotelOAuthFlow.refreshToken,
                tokenExpiry: Date.now() + (3600 * 1000), // 1 Stunde
                
                // Display
                color: calendar.backgroundColor || '#3b82f6',
                enabled: true,
                
                // Timestamps
                createdAt: Date.now(),
                createdBy: currentUser ? currentUser.email : 'unknown',
                lastSync: null
            };
            
            try {
                await db.ref(`hotelCalendars/${hotelKey}`).set(hotelData);
                console.log(`âœ… Hotel gespeichert mit Key: ${hotelKey}`);
                
                // Modal schlieÃŸen
                closeGoogleCalendarModal();
                
                // OAuth Flow zurÃ¼cksetzen
                currentHotelOAuthFlow = null;
                
                // Liste neu laden
                await loadHotelCalendars();
                
                alert(`âœ… Hotel "${hotelData.name}" erfolgreich verbunden!\n\nğŸ“… Kalender: ${calendar.summary}\nğŸ“§ Account: ${hotelData.googleEmail}\n\nğŸ”„ Automatischer Sync startet jetzt.`);
                
                // Starte ersten Sync
                await syncGoogleCalendarEvents(hotelKey);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Speichern:', error);
                alert('ğŸ’¾ Fehler beim Speichern:\n\n' + error.message);
            }
        };
        
        // SchlieÃŸe Modal
        window.closeGoogleCalendarModal = function() {
            const modal = document.getElementById('google-calendar-modal');
            if (modal) modal.remove();
        };
        
        // Sync Google Calendar Events (via API)
        async function syncGoogleCalendarEvents(calendarKey) {
            const calendar = hotelCalendars[calendarKey];
            
            // ğŸ†• v5.87.24: UnterstÃ¼tze beide Types
            if (!calendar || (calendar.type !== 'google_calendar' && calendar.type !== 'google_calendar_oauth')) {
                console.log('â¸ï¸ Kein Google Calendar:', calendarKey);
                return;
            }
            
            if (!calendar.enabled) {
                console.log('â¸ï¸ Kalender pausiert:', calendar.name);
                return;
            }
            
            console.log('ğŸ”„ Synchronisiere Google Calendar:', calendar.name);
            if (calendar.googleEmail) {
                console.log(`ğŸ“§ Account: ${calendar.googleEmail}`);
            }
            
            try {
                // ğŸ†• v5.90.537: Zeitfilter 2 JAHRE zurÃ¼ck (fÃ¼r Oktober/Dezember 2024!)
                const twoYearsAgo = new Date();
                twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
                const timeMin = twoYearsAgo.toISOString();
                
                console.log(`ğŸ• Lade Events ab: ${twoYearsAgo.toLocaleDateString('de-DE')} (2 Jahre zurÃ¼ck)`);
                
                // ğŸ†• v5.87.42: Funktion fÃ¼r API Call (mit Auto-Retry)
                const fetchEvents = async (accessToken, retryCount = 0) => {
                    const response = await fetch(
                        `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendar.googleCalendarId)}/events?` +
                        `timeMin=${encodeURIComponent(timeMin)}&` +
                        `maxResults=200&` +
                        `singleEvents=true&` +
                        `orderBy=startTime`,
                        {
                            headers: {
                                'Authorization': `Bearer ${accessToken}`
                            }
                        }
                    );
                    
                    // ğŸ†• v5.87.42: Auto-Refresh bei 401
                    if (response.status === 401 && retryCount === 0) {
                        console.log('ğŸ’¾ 401 Unauthorized - Token abgelaufen!');
                        console.log('ğŸ”„ Starte automatischen Token Refresh...');
                        
                        try {
                            // Refresh Token
                            const newToken = await refreshGoogleToken(calendarKey);
                            
                            // Retry mit neuem Token
                            console.log('ğŸ”„ Retry mit neuem Token...');
                            return await fetchEvents(newToken, 1);
                            
                        } catch (refreshError) {
                            console.error('ğŸ’¾ Token Refresh fehlgeschlagen:', refreshError);
                            throw new Error('Token Refresh fehlgeschlagen - bitte Hotel neu verbinden');
                        }
                    }
                    
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }
                    
                    return response;
                };
                
                // Lade Events via Calendar API (mit Auto-Retry)
                const response = await fetchEvents(calendar.accessToken);
                
                const data = await response.json();
                const events = data.items || [];
                
                console.log(`ğŸ“… ${events.length} Events gefunden`);
                
                let importedCount = 0;
                let skippedCount = 0;
                
                for (const event of events) {
                    // Parse Event
                    const startTime = event.start.dateTime || event.start.date;
                    const endTime = event.end.dateTime || event.end.date;
                    const summary = event.summary || 'Unbekannt';
                    const description = event.description || '';
                    const location = event.location || '';
                    
                    // PrÃ¼fe ob schon importiert
                    const eventUID = event.id;
                    const existingCheck = await db.ref('rides')
                        .orderByChild('hotelCalendarEventUID')
                        .equalTo(`${calendarKey}_${eventUID}`)
                        .once('value');
                    
                    if (existingCheck.exists()) {
                        skippedCount++;
                        continue;
                    }
                    
                    // ğŸ†• v5.87.35: Parse Event-Titel intelligent
                    // ğŸ†• v5.87.39: EINFACHER Parser - zeige ALLES erstmal!
                    function parseEventTitle(title, desc) {
                        const result = {
                            customerName: '',
                            persons: 1,
                            pickup: '',
                            destination: '',
                            notes: ''
                        };
                        
                        // Extrahiere Personen (1pax, 2 Pax, etc.)
                        const paxMatch = title.match(/(\d+)\s*pax/i);
                        if (paxMatch) {
                            result.persons = parseInt(paxMatch[1]);
                        }
                        
                        // Extrahiere Route: "X zum Y" oder "X nach Y"
                        let routeMatch = title.match(/^(.*?)\s+(?:zum?|nach)\s+(.+?)(?:\s+\d+pax|$)/i);
                        
                        if (routeMatch) {
                            let pickup = routeMatch[1].trim();
                            let dest = routeMatch[2].trim();
                            
                            // Hotel-Mapping
                            if (pickup.toLowerCase().includes('hotel')) {
                                result.pickup = calendar.name;
                            } else if (pickup.toUpperCase().includes('BHF') || pickup.toLowerCase().includes('bahnhof')) {
                                result.pickup = 'Bahnhof Heringsdorf';
                            } else if (pickup.toLowerCase().includes('flughafen')) {
                                result.pickup = 'Flughafen';
                            } else {
                                result.pickup = pickup;
                            }
                            
                            // Destination
                            if (dest.toLowerCase().includes('hotel')) {
                                result.destination = calendar.name;
                            } else if (dest.toUpperCase().includes('BHF') || dest.toLowerCase().includes('bahnhof')) {
                                result.destination = 'Bahnhof Heringsdorf';
                            } else if (dest.toLowerCase().includes('flughafen')) {
                                result.destination = 'Flughafen';
                            } else {
                                result.destination = dest;
                            }
                        }
                        
                        // ğŸ†• v5.87.43: CUSTOMER NAME = NUR TITEL (nicht mehr mit Description)
                        result.customerName = title;
                        
                        // ğŸ†• v5.87.43: NOTES = DESCRIPTION SEPARAT
                        if (desc && desc.trim()) {
                            result.notes = desc.trim();
                        }
                        
                        return result;
                    }
                    
                    const parsed = parseEventTitle(summary, description);
                    
                    console.log('ğŸ” Parse Event:', summary);
                    if (description && description.trim()) {
                        console.log('  â†’ Description:', description.trim());
                    }
                    console.log('  â†’ Name:', parsed.customerName);
                    if (parsed.notes) {
                        console.log('  â†’ Notes:', parsed.notes);
                    }
                    console.log('  â†’ Personen:', parsed.persons);
                    console.log('  â†’ Von:', parsed.pickup);
                    console.log('  â†’ Nach:', parsed.destination);
                    
                    // Erstelle Fahrt
                    const rideData = {
                        source: 'google_calendar',
                        hotelCalendarId: calendarKey,
                        hotelCalendarName: calendar.name,
                        hotelCalendarColor: calendar.color,
                        hotelCalendarEventUID: `${calendarKey}_${eventUID}`,
                        
                        customerName: parsed.customerName || summary,
                        persons: parsed.persons,
                        pickup: parsed.pickup || location || calendar.name,
                        destination: parsed.destination || description || '',
                        pickupTime: startTime,
                        
                        status: 'pending',
                        timestamp: Date.now(),
                        createdBy: 'google_calendar_sync',
                        notes: parsed.notes || description || ''
                    };
                    
                    // Speichere
                    await db.ref('rides').push(rideData);
                    importedCount++;
                }
                
                console.log(`âœ… ${importedCount} Events importiert, ${skippedCount} Ã¼bersprungen`);
                
                // ğŸ†• v5.87.25: Update lastSync Timestamp
                await db.ref(`hotelCalendars/${calendarKey}/lastSync`).set(Date.now());
                console.log('âœ… Sync-Timestamp aktualisiert');
                
            } catch (error) {
                console.error(`ğŸ’¾ Sync Fehler fÃ¼r ${calendar.name}:`, error);
                console.error('ğŸ’¾ Error Details:', {
                    message: error.message || 'Keine Message',
                    stack: error.stack || 'Kein Stack',
                    name: error.name || 'Kein Name',
                    full: JSON.stringify(error, Object.getOwnPropertyNames(error))
                });
                
                // Zeige Fehler wenn Token abgelaufen
                if (error.message && (error.message.includes('401') || error.message.includes('403'))) {
                    console.error('ğŸ’¾ Token abgelaufen! Bitte neu verbinden.');
                }
                
                // Throw error weiter damit quickSyncHotel es catchen kann
                throw error;
            }
        }
        
        // Zeige Add-Form
        function showAddHotelCalendarForm() {
            const form = document.getElementById('add-hotel-calendar-form');
            if (form) {
                form.style.display = 'block';
                // Reset
                document.getElementById('new-hotel-name').value = '';
                document.getElementById('new-hotel-ical-url').value = '';
                selectedHotelColor = '#f97316';
                updateColorButtonSelection();
            }
        }
        
        // Cancel Add
        function cancelAddHotelCalendar() {
            const form = document.getElementById('add-hotel-calendar-form');
            if (form) form.style.display = 'none';
        }
        
        // Farbe auswÃ¤hlen
        function selectHotelColor(color) {
            selectedHotelColor = color;
            document.getElementById('new-hotel-color').value = color;
            updateColorButtonSelection();
        }
        
        function updateColorButtonSelection() {
            document.querySelectorAll('.color-btn').forEach(btn => {
                const btnColor = btn.getAttribute('data-color');
                if (btnColor === selectedHotelColor) {
                    btn.style.border = '3px solid #1f2937';
                    btn.style.transform = 'scale(1.1)';
                } else {
                    btn.style.border = '3px solid #e5e7eb';
                    btn.style.transform = 'scale(1)';
                }
            });
        }
        
        // Speichere neuen Hotel-Kalender
        async function saveHotelCalendar() {
            const name = document.getElementById('new-hotel-name').value.trim();
            const icalUrl = document.getElementById('new-hotel-ical-url').value.trim();
            const color = selectedHotelColor;
            
            // Validierung Name
            if (!name) {
                alert('ğŸ’¾ Bitte Hotel-Namen eingeben!');
                return;
            }
            
            // ğŸ†• v5.87.57: Wenn KEIN iCal-URL â†’ OAuth Flow starten!
            if (!icalUrl) {
                console.log('ğŸ” Kein iCal-URL â†’ Starte OAuth Flow fÃ¼r:', name);
                
                // SchlieÃŸe Dialog
                const dialog = document.getElementById('add-hotel-dialog');
                if (dialog) dialog.remove();
                
                // Starte OAuth fÃ¼r dieses Hotel
                await connectGoogleCalendarForHotel(name);
                return;
            }
            
            // Alt: Mit iCal-URL
            if (!icalUrl.startsWith('http')) {
                alert('ğŸ’¾ Bitte gÃ¼ltige iCal URL eingeben (oder leer lassen fÃ¼r OAuth)!');
                return;
            }
            
            console.log('ğŸ’¾ Speichere Hotel-Kalender (iCal):', name);
            
            try {
                const calendarData = {
                    name: name,
                    icalUrl: icalUrl,
                    color: color,
                    enabled: true,
                    createdAt: Date.now(),
                    lastSync: null
                };
                
                // Speichere in Firebase
                const newRef = await db.ref('hotelCalendars').push(calendarData);
                console.log('âœ… Hotel-Kalender gespeichert:', newRef.key);
                
                // Log
                logActivity('admin', 'hotel_calendar_added', `Hotel-Kalender hinzugefÃ¼gt: ${name}`, {
                    calendarId: newRef.key,
                    name: name
                });
                
                // Form schlieÃŸen
                cancelAddHotelCalendar();
                
                // Neu laden
                await loadHotelCalendars();
                
                // Sofort syncen
                alert('âœ… Hotel-Kalender hinzugefÃ¼gt!\n\nSynchronisation startet...');
                await syncHotelCalendar(newRef.key);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Speichern:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // LÃ¶sche Hotel-Kalender
        async function deleteHotelCalendar(calendarId) {
            const calendar = hotelCalendars[calendarId];
            if (!calendar) return;
            
            const confirmed = confirm(`Hotel-Kalender lÃ¶schen?\n\n${calendar.name}\n\nAlle importierten Fahrten bleiben erhalten.`);
            if (!confirmed) return;
            
            console.log('ğŸ—‘ï¸ LÃ¶sche Hotel-Kalender:', calendarId);
            
            try {
                await db.ref(`hotelCalendars/${calendarId}`).remove();
                console.log('âœ… GelÃ¶scht');
                
                logActivity('admin', 'hotel_calendar_deleted', `Hotel-Kalender gelÃ¶scht: ${calendar.name}`, {
                    calendarId: calendarId
                });
                
                await loadHotelCalendars();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim LÃ¶schen:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // Toggle Enable/Disable
        async function toggleHotelCalendarEnabled(calendarId) {
            const calendar = hotelCalendars[calendarId];
            if (!calendar) return;
            
            const newState = !calendar.enabled;
            console.log(`${newState ? 'â–¶ï¸' : 'â¸ï¸'} ${newState ? 'Aktiviere' : 'Pausiere'} Hotel-Kalender:`, calendarId);
            
            try {
                await db.ref(`hotelCalendars/${calendarId}/enabled`).set(newState);
                console.log('âœ… Status geÃ¤ndert');
                
                await loadHotelCalendars();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // ğŸ†• ICAL PARSER - Parst Google Calendar .ics Dateien
        function parseICalendar(icsText) {
            console.log('ğŸ“± Parse iCal Daten...');
            
            const events = [];
            const lines = icsText.split('\n').map(line => line.trim());
            
            let currentEvent = null;
            let currentField = null;
            let currentValue = '';
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // Zeilen-Fortsetzung (startet mit Leerzeichen)
                if (line.startsWith(' ') && currentField) {
                    currentValue += line.substring(1);
                    continue;
                }
                
                // Speichere vorheriges Feld
                if (currentField && currentEvent) {
                    currentEvent[currentField] = currentValue;
                }
                
                currentField = null;
                currentValue = '';
                
                // Neues Event beginnt
                if (line === 'BEGIN:VEVENT') {
                    currentEvent = {};
                    continue;
                }
                
                // Event endet
                if (line === 'END:VEVENT') {
                    if (currentEvent) {
                        events.push(currentEvent);
                    }
                    currentEvent = null;
                    continue;
                }
                
                // Feld parsen
                if (currentEvent && line.includes(':')) {
                    const colonIndex = line.indexOf(':');
                    const field = line.substring(0, colonIndex);
                    const value = line.substring(colonIndex + 1);
                    
                    // Feld-Namen normalisieren (ohne Parameter)
                    const fieldName = field.split(';')[0];
                    
                    currentField = fieldName;
                    currentValue = value;
                }
            }
            
            console.log(`âœ… ${events.length} Events geparst`);
            return events;
        }
        
        // Konvertiere iCal DateTime zu ISO
        function icalDateToISO(icalDate) {
            // Format: 20241220T140000Z oder 20241220T140000
            if (!icalDate) return null;
            
            const cleanDate = icalDate.replace(/[^0-9TZ]/g, '');
            
            // YYYYMMDDTHHMMSS
            if (cleanDate.length >= 15) {
                const year = cleanDate.substring(0, 4);
                const month = cleanDate.substring(4, 6);
                const day = cleanDate.substring(6, 8);
                const hour = cleanDate.substring(9, 11);
                const minute = cleanDate.substring(11, 13);
                const second = cleanDate.substring(13, 15) || '00';
                
                return `${year}-${month}-${day}T${hour}:${minute}:${second}`;
            }
            
            return null;
        }
        
        // ğŸ”„ SYNC HOTEL CALENDAR - LÃ¤dt .ics und erstellt Fahrten
        // ğŸ†• v5.87.40: EINFACHER SYNC - ruft direkt die Auto-Sync Funktion auf
        // ğŸ†• v5.87.38: NOTFALL - NUR LÃ–SCHEN (ohne Import)
        async function deleteOnlyHotelEvents(calendarId) {
            if (!confirm('âš ï¸ NOTFALL-OPTION!\n\nLÃ¶scht ALLE Hotel-Events OHNE neuen Import.\n\nNur fÃ¼r Notfall wenn Import crasht!\n\nBist du sicher?')) {
                return;
            }
            
            try {
                // Lade Hotel-Info
                const hotelSnap = await db.ref(`hotelCalendars/${calendarId}`).once('value');
                const hotel = hotelSnap.val();
                
                if (!hotel) {
                    alert('ğŸ’¾ Hotel nicht gefunden!');
                    return;
                }
                
                // Progress-Dialog
                const progressDiv = document.createElement('div');
                progressDiv.id = 'delete-progress';
                progressDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.3);z-index:999999;min-width:400px;';
                progressDiv.innerHTML = `
                    <h3 style="margin:0 0 20px 0;font-size:20px;font-weight:700;">ğŸ—‘ï¸ LÃ¶sche Events...</h3>
                    <div style="margin-bottom:20px;">
                        <div style="font-size:14px;color:#6b7280;margin-bottom:8px;">
                            <span id="del-status">Vorbereitung...</span>
                        </div>
                        <div style="background:#e5e7eb;border-radius:8px;height:24px;overflow:hidden;">
                            <div id="del-bar" style="background:linear-gradient(90deg,#f59e0b,#d97706);height:100%;width:0%;transition:width 0.3s;"></div>
                        </div>
                        <div style="font-size:12px;color:#9ca3af;margin-top:8px;">
                            <span id="del-detail"></span>
                        </div>
                    </div>
                `;
                document.body.appendChild(progressDiv);
                
                function updateProgress(status, percent, detail = '') {
                    document.getElementById('del-status').textContent = status;
                    document.getElementById('del-bar').style.width = percent + '%';
                    document.getElementById('del-detail').textContent = detail;
                }
                
                updateProgress('Lade Events...', 5);
                await new Promise(r => setTimeout(r, 100));
                
                // Lade alle Events
                const ridesSnap = await db.ref('rides')
                    .orderByChild('hotelCalendarId')
                    .equalTo(calendarId)
                    .once('value');
                
                const ridesToDelete = ridesSnap.val() || {};
                const rideIds = Object.keys(ridesToDelete);
                const deleteCount = rideIds.length;
                
                console.log(`ğŸ—‘ï¸ ${deleteCount} Events gefunden`);
                updateProgress(`LÃ¶sche ${deleteCount} Events...`, 10);
                await new Promise(r => setTimeout(r, 500));
                
                // LÃ¶sche in Batches
                const BATCH_SIZE = 20;
                const deleteBatches = [];
                for (let i = 0; i < rideIds.length; i += BATCH_SIZE) {
                    deleteBatches.push(rideIds.slice(i, i + BATCH_SIZE));
                }
                
                let deletedSoFar = 0;
                for (let i = 0; i < deleteBatches.length; i++) {
                    const batch = deleteBatches[i];
                    
                    await Promise.all(batch.map(rideId => 
                        db.ref(`rides/${rideId}`).remove()
                    ));
                    
                    deletedSoFar += batch.length;
                    const progress = 10 + (deletedSoFar / deleteCount * 80);
                    
                    updateProgress(
                        `LÃ¶sche Events... ${deletedSoFar}/${deleteCount}`,
                        progress,
                        `Batch ${i+1}/${deleteBatches.length}`
                    );
                    
                    console.log(`ğŸ—‘ï¸ Batch ${i+1}: ${batch.length} gelÃ¶scht`);
                    await new Promise(r => setTimeout(r, 200));
                }
                
                progressDiv.remove();
                
                alert(`âœ… Fertig!\n\n${deleteCount} Events gelÃ¶scht.\n\nJetzt kannst du manuell neu importieren mit [ğŸ”„ Browser-Sync]`);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                const prog = document.getElementById('delete-progress');
                if (prog) prog.remove();
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // ğŸ†• v5.87.37: NEU IMPORTIEREN mit BATCH-Processing
        async function reimportHotelCalendar(calendarId) {
            if (!confirm('âš ï¸ ACHTUNG!\n\nDies wird ALLE importierten Events fÃ¼r diesen Hotel-Kalender lÃ¶schen und neu importieren.\n\nBist du sicher?')) {
                return;
            }
            
            try {
                console.log('ğŸ”„ Starte Neu-Import fÃ¼r:', calendarId);
                
                // Lade Hotel-Info
                const hotelSnap = await db.ref(`hotelCalendars/${calendarId}`).once('value');
                const hotel = hotelSnap.val();
                
                if (!hotel) {
                    alert('ğŸ’¾ Hotel nicht gefunden!');
                    return;
                }
                
                // Erstelle Progress-Dialog
                const progressDiv = document.createElement('div');
                progressDiv.id = 'reimport-progress';
                progressDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.3);z-index:999999;min-width:400px;';
                progressDiv.innerHTML = `
                    <h3 style="margin:0 0 20px 0;font-size:20px;font-weight:700;">ğŸ”„ Neu-Import lÃ¤uft...</h3>
                    <div style="margin-bottom:20px;">
                        <div style="font-size:14px;color:#6b7280;margin-bottom:8px;">
                            <span id="progress-status">Vorbereitung...</span>
                        </div>
                        <div style="background:#e5e7eb;border-radius:8px;height:24px;overflow:hidden;">
                            <div id="progress-bar" style="background:linear-gradient(90deg,#3b82f6,#2563eb);height:100%;width:0%;transition:width 0.3s;"></div>
                        </div>
                        <div style="font-size:12px;color:#9ca3af;margin-top:8px;">
                            <span id="progress-detail"></span>
                        </div>
                    </div>
                    <div style="font-size:13px;color:#9ca3af;text-align:center;">
                        â³ Bitte warten... Firefox bleibt stabil!
                    </div>
                `;
                document.body.appendChild(progressDiv);
                
                function updateProgress(status, percent, detail = '') {
                    document.getElementById('progress-status').textContent = status;
                    document.getElementById('progress-bar').style.width = percent + '%';
                    document.getElementById('progress-detail').textContent = detail;
                }
                
                updateProgress('Lade alte Events...', 5);
                await new Promise(r => setTimeout(r, 100));
                
                // 1. Lade alle Events mit dieser hotelCalendarId
                const ridesSnap = await db.ref('rides')
                    .orderByChild('hotelCalendarId')
                    .equalTo(calendarId)
                    .once('value');
                
                const ridesToDelete = ridesSnap.val() || {};
                const rideIds = Object.keys(ridesToDelete);
                const deleteCount = rideIds.length;
                
                console.log(`ğŸ—‘ï¸ ${deleteCount} alte Events gefunden`);
                updateProgress(`LÃ¶sche ${deleteCount} Events...`, 10, 'Batch-Delete startet...');
                await new Promise(r => setTimeout(r, 500));
                
                // 2. LÃ¶sche in Batches von 20
                const BATCH_SIZE = 20;
                const deleteBatches = [];
                for (let i = 0; i < rideIds.length; i += BATCH_SIZE) {
                    deleteBatches.push(rideIds.slice(i, i + BATCH_SIZE));
                }
                
                let deletedSoFar = 0;
                for (let i = 0; i < deleteBatches.length; i++) {
                    const batch = deleteBatches[i];
                    
                    // LÃ¶sche Batch
                    await Promise.all(batch.map(rideId => 
                        db.ref(`rides/${rideId}`).remove()
                    ));
                    
                    deletedSoFar += batch.length;
                    const deleteProgress = 10 + (deletedSoFar / deleteCount * 40); // 10-50%
                    
                    updateProgress(
                        `LÃ¶sche Events... ${deletedSoFar}/${deleteCount}`,
                        deleteProgress,
                        `Batch ${i+1}/${deleteBatches.length} abgeschlossen`
                    );
                    
                    console.log(`ğŸ—‘ï¸ Batch ${i+1}/${deleteBatches.length}: ${batch.length} Events gelÃ¶scht`);
                    
                    // Kleine Pause zwischen Batches
                    await new Promise(r => setTimeout(r, 200));
                }
                
                console.log(`âœ… Alle ${deleteCount} Events gelÃ¶scht`);
                updateProgress('Events gelÃ¶scht!', 50, `${deleteCount} alte Events entfernt`);
                await new Promise(r => setTimeout(r, 800));
                
                // 3. Sync neu (mit Original-Funktion aber ohne Alert)
                updateProgress('Importiere neue Events...', 55, 'Verbinde mit Google Calendar...');
                await new Promise(r => setTimeout(r, 500));
                
                // Rufe Original-Sync auf
                console.log('ğŸ”„ Starte Neu-Import mit Parser...');
                
                // Entferne Progress temporÃ¤r
                progressDiv.remove();
                
                // Sync
                await syncHotelCalendar(calendarId);
                
                // Success!
                alert(`âœ… Neu-Import abgeschlossen!\n\n${deleteCount} alte Events gelÃ¶scht.\nNeue Events mit verbessertem Parser importiert!`);
                
                // Wenn Kalender gerade offen: Neu laden
                if (currentHotelCalendarId === calendarId) {
                    showHotelCalendar(calendarId);
                }
                
            } catch (error) {
                console.error('ğŸ’¾ Neu-Import Fehler:', error);
                
                // Entferne Progress
                const prog = document.getElementById('reimport-progress');
                if (prog) prog.remove();
                
                alert('ğŸ’¾ Fehler beim Neu-Import: ' + error.message);
            }
        }
        
        async function syncHotelCalendar(calendarId) {
            const calendar = hotelCalendars[calendarId];
            if (!calendar) {
                console.error('ğŸ’¾ Kalender nicht gefunden:', calendarId);
                return;
            }
            
            if (!calendar.enabled) {
                console.log('â¸ï¸ Kalender pausiert:', calendar.name);
                return;
            }
            
            console.log('ğŸ”„ Synchronisiere Hotel-Kalender:', calendar.name);
            
            // ğŸ†• v5.87.23: Unterscheide zwischen Google Calendar und iCal
            if (calendar.type === 'google_calendar') {
                // Google Calendar via API
                await syncGoogleCalendarEvents(calendarId);
                return;
            }
            
            // Alte iCal Methode
            try {
                // ğŸ†• v5.85.0: FIREBASE CLOUD FUNCTION (kein CORS Problem!)
                console.log('ğŸ“¥ Rufe Cloud Function auf...');
                
                const cloudFunctionUrl = 'https://europe-west1-funk-taxi-heringsdorf.cloudfunctions.net/fetchIcal';
                
                const response = await fetch(`${cloudFunctionUrl}?url=${encodeURIComponent(calendar.icalUrl)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Cloud Function Fehler: HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Unbekannter Fehler');
                }
                
                const icsText = data.icsText;
                console.log(`âœ… ${icsText.length} Zeichen von Cloud Function geladen`);
                
                // Parse iCal
                const events = parseICalendar(icsText);
                console.log(`ğŸ“… ${events.length} Events gefunden`);
                
                // Konvertiere zu Fahrten
                let importedCount = 0;
                let skippedCount = 0;
                
                for (const event of events) {
                    // ğŸ†• v5.78.1: NUR NÃ„CHSTE 30 TAGE!
                    const startTime = icalDateToISO(event.DTSTART);
                    if (!startTime) {
                        skippedCount++;
                        continue;
                    }
                    
                    const eventDate = new Date(startTime);
                    // ğŸ†• v5.87.22: KEINE FILTER! Importiere ALLES (alt + neu)
                    // const now = new Date();
                    // ğŸ›¡ï¸ FILTER 1: Nur Events ab heute - DEAKTIVIERT!
                    // if (eventDate < now) {
                    //     skippedCount++;
                    //     continue;
                    // }
                    
                    // ğŸ›¡ï¸ FILTER 2: Nur nÃ¤chste 30 Tage - DEAKTIVIERT!
                    // const maxDate = new Date();
                    // maxDate.setDate(maxDate.getDate() + 30);
                    // if (eventDate > maxDate) {
                    //     skippedCount++;
                    //     console.log(`â­ï¸ Event Ã¼bersprungen (zu weit in Zukunft): ${event.SUMMARY || 'Unbekannt'} am ${startTime}`);
                    //     continue;
                    // }
                    
                    console.log(`âœ… Event wird importiert: ${event.SUMMARY || 'Unbekannt'} am ${startTime}`);
                    
                    // PrÃ¼fe ob schon importiert (anhand UID + Kalender)
                    const eventUID = event.UID || '';
                    const existingCheck = await db.ref('rides')
                        .orderByChild('hotelCalendarEventUID')
                        .equalTo(`${calendarId}_${eventUID}`)
                        .once('value');
                    
                    if (existingCheck.exists()) {
                        // Schon importiert
                        skippedCount++;
                        continue;
                    }
                    
                    // Erstelle Fahrt
                    const summary = event.SUMMARY || 'Hotel-Buchung';
                    const description = event.DESCRIPTION || '';
                    const location = event.LOCATION || '';
                    
                    const endTime = icalDateToISO(event.DTEND) || startTime;
                    
                    // Fahrt-Daten
                    const rideData = {
                        // Quelle
                        hotelCalendarId: calendarId,
                        hotelCalendarName: calendar.name,
                        hotelCalendarEventUID: `${calendarId}_${eventUID}`,
                        hotelCalendarColor: calendar.color,
                        
                        // Zeit
                        pickupTime: startTime,
                        createdAt: Date.now(),
                        
                        // Kunde (Hotel)
                        customerName: calendar.name,
                        customerPhone: 'Hotel-Import',
                        customerId: `hotel_${calendarId}`,
                        
                        // Gast
                        guestName: summary,
                        
                        // Locations
                        pickup: location || calendar.name,
                        destination: description.substring(0, 100) || 'Siehe Event-Details',
                        
                        // Status
                        status: 'open',
                        preBooked: true,
                        
                        // Meta
                        notes: `ğŸ“… Importiert aus ${calendar.name}\n\n${description}`,
                        source: 'hotel_calendar_import'
                    };
                    
                    // Speichere in Firebase
                    await db.ref('rides').push(rideData);
                    importedCount++;
                    
                    console.log(`âœ… Importiert: ${summary} am ${startTime}`);
                }
                
                // Update lastSync
                await db.ref(`hotelCalendars/${calendarId}/lastSync`).set(Date.now());
                
                console.log(`âœ… Sync abgeschlossen: ${importedCount} neu, ${skippedCount} Ã¼bersprungen`);
                
                // Log
                logActivity('system', 'hotel_calendar_synced', `Hotel-Kalender synchronisiert: ${calendar.name}`, {
                    calendarId: calendarId,
                    imported: importedCount,
                    skipped: skippedCount
                });
                
                // Reload Liste
                await loadHotelCalendars();
                
                // Reload Kalender falls sichtbar
                if (currentView === 'admin' && document.getElementById('calendar-content').style.display !== 'none') {
                    await loadCalendarRides(currentCalendarYear, currentCalendarMonth);
                }
                
                alert(`âœ… Synchronisation abgeschlossen!\n\n${importedCount} neue Fahrten importiert\n${skippedCount} Ã¼bersprungen`);
                
            } catch (error) {
                console.error('ğŸ’¾ Sync-Fehler:', error);
                alert(`ğŸ’¾ Synchronisation fehlgeschlagen!\n\n${error.message}\n\nPrÃ¼fe die iCal URL.`);
            }
        }
        
        // ğŸ†• v5.80.0: CLOUD-SYNC (via Firebase Cloud Function)
        
        // Cloud Function URL
        const CLOUD_FUNCTION_URL = 'https://europe-west1-funk-taxi-heringsdorf.cloudfunctions.net/syncHotelCalendarsManual';
        
        async function cloudSyncHotelCalendar(calendarId) {
            const calendar = hotelCalendars[calendarId];
            if (!calendar) return;
            
            if (CLOUD_FUNCTION_URL === 'NACH_DEPLOY_EINTRAGEN') {
                alert('âš ï¸ Cloud Function noch nicht deployt!\n\nBitte erst Cloud Function deployen und URL hier eintragen.\n\nSiehe DEPLOY_ANLEITUNG.md');
                return;
            }
            
            console.log('â˜ï¸ Starte Cloud-Sync:', calendar.name);
            
            const confirmed = confirm(`â˜ï¸ Cloud-Sync starten?\n\n${calendar.name}\n\nDie Cloud Function lÃ¤dt den Kalender direkt auf dem Server (kein CORS-Problem!)`);
            if (!confirmed) return;
            
            try {
                // Zeige Loading
                alert('â˜ï¸ Cloud-Sync lÃ¤uft...\n\nBitte warten (kann 10-30 Sek dauern)');
                
                // Rufe Cloud Function auf
                const response = await fetch(CLOUD_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                console.log('âœ… Cloud-Sync Result:', result);
                
                if (result.success) {
                    const totalImported = result.totalImported || 0;
                    const totalSkipped = result.totalSkipped || 0;
                    
                    alert(`âœ… Cloud-Sync erfolgreich!\n\n${totalImported} Fahrten importiert\n${totalSkipped} Ã¼bersprungen`);
                    
                    // Reload Kalender
                    await loadHotelCalendars();
                } else {
                    throw new Error(result.error || 'Unbekannter Fehler');
                }
                
            } catch (error) {
                console.error('ğŸ’¾ Cloud-Sync Fehler:', error);
                alert('ğŸ’¾ Cloud-Sync fehlgeschlagen!\n\n' + error.message + '\n\nPrÃ¼fe:\n- Ist Cloud Function deployt?\n- Ist URL korrekt?\n- Siehe Browser Console (F12)');
            }
        }
        
        // Auto-Sync beim Init
        async function initHotelCalendars() {
            await loadHotelCalendars();
        }
        
        // ğŸ†• v5.78.0: HOTEL-RECHNUNGEN
        
        let currentInvoiceRides = [];
        let currentInvoiceHotel = null;
        let currentInvoiceMonth = null;
        
        // Init Hotel-Rechnungen
        async function initHotelInvoices() {
            console.log('ğŸ“± Initialisiere Hotel-Rechnungen...');
            
            // Lade Hotels fÃ¼r Dropdown
            await loadHotelCalendars();
            
            // FÃ¼lle Hotel-Dropdown
            const hotelSelect = document.getElementById('invoice-hotel-select');
            if (hotelSelect) {
                hotelSelect.innerHTML = '<option value="">Alle Hotels</option>';
                
                // Hotels aus hotelCalendars
                if (hotelCalendars) {
                    Object.entries(hotelCalendars).forEach(([id, hotel]) => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = hotel.name;
                        hotelSelect.appendChild(option);
                    });
                }
            }
            
            // Setze aktuellen Monat als Default
            const monthInput = document.getElementById('invoice-month-select');
            if (monthInput) {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                monthInput.value = `${year}-${month}`;
            }
            
            // Lade Historie
            await loadInvoiceHistory();
        }
        
        // Lade Fahrten fÃ¼r gewÃ¤hltes Hotel + Monat
        async function loadInvoiceRides() {
            const hotelId = document.getElementById('invoice-hotel-select').value;
            const monthValue = document.getElementById('invoice-month-select').value;
            const container = document.getElementById('invoice-rides-container');
            const statsDiv = document.getElementById('invoice-stats');
            const createBtn = document.getElementById('invoice-create-button');
            
            if (!monthValue) {
                alert('âš ï¸ Bitte wÃ¤hle einen Monat!');
                return;
            }
            
            console.log('ğŸ”„ Lade Rechnungs-Fahrten:', hotelId || 'Alle Hotels', monthValue);
            
            // ğŸ†• v5.87.53: LOADING STATE!
            if (container) {
                container.innerHTML = `
                    <div style="text-align:center;padding:40px;color:#3b82f6;">
                        <div style="font-size:48px;margin-bottom:10px;">â³</div>
                        <div style="font-weight:600;margin-bottom:6px;font-size:16px;">Lade Fahrten...</div>
                        <div style="font-size:13px;">Bitte warten...</div>
                    </div>
                `;
            }
            if (statsDiv) statsDiv.style.display = 'none';
            if (createBtn) {
                createBtn.disabled = true;
                createBtn.style.opacity = '0.5';
            }
            
            // Parse Monat
            const [year, month] = monthValue.split('-');
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0, 23, 59, 59);
            
            currentInvoiceMonth = monthValue;
            currentInvoiceHotel = hotelId ? hotelCalendars[hotelId] : null;
            
            try {
                // Lade Hotel-Info und Preis-Regeln
                let pricingRules = null;
                if (hotelId && hotelCalendars[hotelId]) {
                    pricingRules = hotelCalendars[hotelId].pricingRules || null;
                    if (pricingRules) {
                        console.log('ğŸ’° Preis-Regeln geladen:', pricingRules);
                    } else {
                        console.log('âš ï¸ Keine Preis-Regeln fÃ¼r dieses Hotel');
                    }
                }
                
                // Lade alle Fahrten aus Firebase
                const snapshot = await db.ref('rides').once('value');
                const allRides = [];
                
                snapshot.forEach(child => {
                    const ride = child.val();
                    ride.id = child.key;
                    
                    // Filter: Nur Hotel-Fahrten (haben hotelCalendarId)
                    if (!ride.hotelCalendarId) return;
                    
                    // Filter: GewÃ¤hltes Hotel (wenn ausgewÃ¤hlt)
                    if (hotelId && ride.hotelCalendarId !== hotelId) return;
                    
                    // Filter: Monat
                    const rideDate = new Date(ride.pickupTime || ride.createdAt);
                    if (rideDate < startDate || rideDate > endDate) return;
                    
                    // ğŸ†• v5.87.56: AUTO-FILL PREISE!
                    if (pricingRules && (ride.price === undefined || ride.price === 0 || ride.price === null)) {
                        // Ermittle Tag-Typ
                        const dayType = getDayType(rideDate);
                        
                        // Ermittle Ziel-Typ
                        const destType = detectDestinationType(ride.destination);
                        
                        // Hole Preis aus Regeln
                        if (pricingRules[destType] && pricingRules[destType][dayType] !== undefined) {
                            ride.price = pricingRules[destType][dayType];
                            ride.priceAutoFilled = true; // Markierung dass Auto-Fill
                            console.log(`ğŸ’° Auto-Fill: ${ride.customerName} â†’ ${destType} (${dayType}) = ${ride.price}â‚¬`);
                        }
                    }
                    
                    // PrÃ¼fe priceOverride (wenn manuell auf 0 gesetzt)
                    if (ride.priceOverride !== undefined) {
                        ride.price = ride.priceOverride;
                    }
                    
                    allRides.push(ride);
                });
                
                // Sortiere nach Datum
                allRides.sort((a, b) => {
                    const dateA = new Date(a.pickupTime || a.createdAt);
                    const dateB = new Date(b.pickupTime || b.createdAt);
                    return dateA - dateB;
                });
                
                currentInvoiceRides = allRides;
                
                console.log(`âœ… ${allRides.length} Fahrten gefunden`);
                
                // Render
                renderInvoiceRides();
                
                // ğŸ†• v5.87.53: SUCCESS MESSAGE!
                if (allRides.length > 0 && container) {
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = 'background:linear-gradient(135deg,#10b981,#059669);color:white;padding:12px;border-radius:8px;margin-bottom:16px;text-align:center;font-weight:600;font-size:14px;';
                    successMsg.innerHTML = `âœ… ${allRides.length} Fahrt${allRides.length !== 1 ? 'en' : ''} fÃ¼r ${new Date(monthValue + '-01').toLocaleDateString('de-DE', { month: 'long', year: 'numeric' })} geladen!`;
                    container.insertBefore(successMsg, container.firstChild);
                    
                    // Nach 5 Sekunden ausblenden
                    setTimeout(() => {
                        successMsg.style.transition = 'opacity 0.5s';
                        successMsg.style.opacity = '0';
                        setTimeout(() => successMsg.remove(), 500);
                    }, 5000);
                }
                
                // Button wieder aktivieren
                if (createBtn && allRides.length > 0) {
                    createBtn.disabled = false;
                    createBtn.style.opacity = '1';
                }
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden:', error);
                if (container) {
                    container.innerHTML = `
                        <div style="text-align:center;padding:40px;color:#ef4444;">
                            <div style="font-size:48px;margin-bottom:10px;">ğŸ’¾</div>
                            <div style="font-weight:600;margin-bottom:6px;">Fehler beim Laden</div>
                            <div style="font-size:13px;">${error.message}</div>
                        </div>
                    `;
                }
            }
        }
        
        // ğŸ†• v5.87.56: Tracking fÃ¼r ausgewÃ¤hlte Zeilen
        let selectedInvoiceRides = new Set();
        
        // Render Fahrten-Tabelle
        function renderInvoiceRides() {
            const container = document.getElementById('invoice-rides-container');
            const statsDiv = document.getElementById('invoice-stats');
            const createBtn = document.getElementById('invoice-create-button');
            
            if (!container) return;
            
            if (currentInvoiceRides.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;padding:40px;color:#6b7280;">
                        <div style="font-size:48px;margin-bottom:10px;">ğŸ“­</div>
                        <div style="font-weight:600;margin-bottom:6px;">Keine Fahrten gefunden</div>
                        <div style="font-size:13px;">FÃ¼r diesen Zeitraum gibt es keine Hotel-Fahrten</div>
                    </div>
                `;
                statsDiv.style.display = 'none';
                createBtn.style.display = 'none';
                return;
            }
            
            // Berechne Summe
            let totalAmount = 0;
            currentInvoiceRides.forEach(ride => {
                totalAmount += parseFloat(ride.price || 0);
            });
            
            // Stats
            const hotelName = currentInvoiceHotel ? currentInvoiceHotel.name : 'Alle Hotels';
            const monthName = new Date(currentInvoiceMonth + '-01').toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
            
            statsDiv.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;">
                    <div>
                        <div style="font-size:13px;opacity:0.9;margin-bottom:4px;">ğŸ¨ ${hotelName}</div>
                        <div style="font-size:20px;font-weight:700;">${monthName}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:13px;opacity:0.9;margin-bottom:4px;">Fahrten</div>
                        <div style="font-size:24px;font-weight:700;">${currentInvoiceRides.length}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:13px;opacity:0.9;margin-bottom:4px;">Gesamt (Netto)</div>
                        <div style="font-size:28px;font-weight:700;">${totalAmount.toFixed(2)}â‚¬</div>
                    </div>
                </div>
            `;
            statsDiv.style.display = 'block';
            
            // ğŸ†• v5.87.56: Multi-Select Button (erscheint nur wenn Auswahl)
            const selectedCount = selectedInvoiceRides.size;
            let multiButtonHtml = '';
            if (selectedCount > 0) {
                multiButtonHtml = `
                    <div id="multi-toggle-button" style="
                        position: sticky;
                        top: 0;
                        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
                        color: white;
                        padding: 12px 16px;
                        border-radius: 8px;
                        margin-bottom: 12px;
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        box-shadow: 0 4px 12px rgba(139,92,246,0.3);
                        z-index: 10;
                    ">
                        <div style="font-weight: 600;">
                            ${selectedCount} Fahrt${selectedCount !== 1 ? 'en' : ''} ausgewÃ¤hlt
                        </div>
                        <button onclick="toggleMultiplePrices()" style="
                            padding: 8px 16px;
                            background: white;
                            color: #8b5cf6;
                            border: none;
                            border-radius: 6px;
                            font-weight: 700;
                            cursor: pointer;
                            font-size: 13px;
                        ">
                            ğŸ’°â†’0 Auf 0â‚¬ setzen
                        </button>
                    </div>
                `;
            }
            
            // Tabelle
            let html = multiButtonHtml + `
                <div style="overflow-x:auto;border:2px solid #e5e7eb;border-radius:8px;">
                    <table style="width:100%;border-collapse:collapse;font-size:13px;">
                        <thead>
                            <tr style="background:#f9fafb;">
                                <th style="padding:12px;text-align:center;font-weight:700;color:#374151;border-bottom:2px solid #e5e7eb;width:40px;">
                                    <input type="checkbox" id="select-all-rides" onchange="toggleAllRides(this)" style="cursor:pointer;width:16px;height:16px;">
                                </th>
                                <th style="padding:12px;text-align:left;font-weight:700;color:#374151;border-bottom:2px solid #e5e7eb;">Nr</th>
                                <th style="padding:12px;text-align:left;font-weight:700;color:#374151;border-bottom:2px solid #e5e7eb;">Datum</th>
                                <th style="padding:12px;text-align:left;font-weight:700;color:#374151;border-bottom:2px solid #e5e7eb;">Zeit</th>
                                <th style="padding:12px;text-align:left;font-weight:700;color:#374151;border-bottom:2px solid #e5e7eb;">Gast</th>
                                <th style="padding:12px;text-align:left;font-weight:700;color:#374151;border-bottom:2px solid #e5e7eb;">Von</th>
                                <th style="padding:12px;text-align:left;font-weight:700;color:#374151;border-bottom:2px solid #e5e7eb;">Nach</th>
                                <th style="padding:12px;text-align:right;font-weight:700;color:#374151;border-bottom:2px solid #e5e7eb;">Preis</th>
                                <th style="padding:12px;text-align:center;font-weight:700;color:#374151;border-bottom:2px solid #e5e7eb;width:60px;">ğŸ’°</th>
                                <th style="padding:12px;text-align:center;font-weight:700;color:#374151;border-bottom:2px solid #e5e7eb;width:60px;">âœï¸</th>
                                <th style="padding:12px;text-align:center;font-weight:700;color:#374151;border-bottom:2px solid #e5e7eb;width:60px;">ğŸ—‘ï¸</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            currentInvoiceRides.forEach((ride, index) => {
                const date = new Date(ride.pickupTime || ride.createdAt);
                const dateStr = date.toLocaleDateString('de-DE');
                const timeStr = date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                const price = parseFloat(ride.price || 0);
                const priceStr = price.toFixed(2);
                
                // ğŸ†• v5.87.56: Ermittle Tag-Typ fÃ¼r Farbcodierung
                const dayType = getDayType(date);
                let rowBg = '#ffffff';
                let dayIndicator = '';
                
                if (dayType === 'saturday') {
                    rowBg = '#fef3c7'; // Gelb
                    dayIndicator = '<span style="color:#f59e0b;font-weight:700;">Sa</span>';
                } else if (dayType === 'sunday') {
                    rowBg = '#fee2e2'; // Rot
                    dayIndicator = '<span style="color:#ef4444;font-weight:700;">So</span>';
                    if (isHoliday(date)) {
                        dayIndicator = '<span style="color:#ef4444;font-weight:700;">Fei</span>';
                    }
                }
                
                // ğŸ†• v5.87.57: NUR durchstreichen wenn MANUELL auf 0â‚¬ gesetzt!
                const isManuallyZero = (ride.priceOverride === 0 && ride.originalPrice !== undefined);
                if (isManuallyZero) {
                    rowBg = '#f3f4f6'; // Grau nur fÃ¼r manuell 0â‚¬
                }
                
                const isSelected = selectedInvoiceRides.has(ride.id);
                
                html += `
                    <tr style="border-bottom:1px solid #e5e7eb;background:${rowBg};${isManuallyZero ? 'opacity:0.7;' : ''}">
                        <td style="padding:10px;text-align:center;">
                            <input type="checkbox" 
                                   class="ride-checkbox" 
                                   data-ride-id="${ride.id}" 
                                   ${isSelected ? 'checked' : ''}
                                   onchange="toggleRideSelection('${ride.id}')" 
                                   style="cursor:pointer;width:16px;height:16px;">
                        </td>
                        <td style="padding:10px;color:#6b7280;">${index + 1}</td>
                        <td style="padding:10px;color:#1f2937;font-weight:600;">${dateStr} ${dayIndicator}</td>
                        <td style="padding:10px;color:#6b7280;">${timeStr}</td>
                        <td style="padding:10px;color:#1f2937;${isManuallyZero ? 'text-decoration:line-through;' : ''}">${ride.guestName || ride.customerName || '-'}</td>
                        <td style="padding:10px;color:#6b7280;font-size:12px;">${ride.pickup || '-'}</td>
                        <td style="padding:10px;color:#6b7280;font-size:12px;">${ride.destination || '-'}</td>
                        <td style="padding:10px;text-align:right;font-weight:700;color:${isManuallyZero ? '#9ca3af' : '#10b981'};">${priceStr}â‚¬</td>
                        <td style="padding:10px;text-align:center;">
                            <button onclick="toggleSinglePrice('${ride.id}')" style="
                                padding:6px 12px;
                                background:${isManuallyZero ? '#e5e7eb' : 'linear-gradient(135deg,#10b981,#059669)'};
                                color:${isManuallyZero ? '#6b7280' : 'white'};
                                border:none;
                                border-radius:6px;
                                font-weight:700;
                                cursor:pointer;
                                font-size:12px;
                            ">
                                ${isManuallyZero ? '0' : 'ğŸ’°'}
                            </button>
                        </td>
                        <td style="padding:10px;text-align:center;">
                            <button onclick="editInvoiceRide('${ride.id}')" style="
                                padding:6px 12px;
                                background:linear-gradient(135deg,#3b82f6,#2563eb);
                                color:white;
                                border:none;
                                border-radius:6px;
                                font-weight:700;
                                cursor:pointer;
                                font-size:12px;
                            ">
                                âœï¸
                            </button>
                        </td>
                        <td style="padding:10px;text-align:center;">
                            <button onclick="deleteInvoiceRide('${ride.id}')" style="
                                padding:6px 12px;
                                background:linear-gradient(135deg,#ef4444,#dc2626);
                                color:white;
                                border:none;
                                border-radius:6px;
                                font-weight:700;
                                cursor:pointer;
                                font-size:12px;
                            ">
                                ğŸ—‘ï¸
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                        <tfoot>
                            <tr style="background:#10b981;color:white;">
                                <td colspan="7" style="padding:12px;font-weight:700;font-size:14px;">GESAMT (Netto)</td>
                                <td style="padding:12px;text-align:right;font-weight:700;font-size:16px;">${totalAmount.toFixed(2)}â‚¬</td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            createBtn.style.display = 'block';
        }
        
        // ğŸ†• v5.87.59: EDIT Fahrt im Dialog
        async function editInvoiceRide(rideId) {
            try {
                const ride = currentInvoiceRides.find(r => r.id === rideId);
                if (!ride) {
                    alert('ğŸ’¾ Fahrt nicht gefunden!');
                    return;
                }
                
                // Erstelle Edit-Dialog
                const dialog = document.createElement('div');
                dialog.id = 'edit-ride-dialog';
                dialog.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 99999;
                `;
                
                const date = new Date(ride.pickupTime || ride.createdAt);
                const dateStr = getLocalDateString(date);  // ğŸ”§ v5.90.353: LOKAL!
                const timeStr = date.toTimeString().slice(0, 5);
                
                dialog.innerHTML = `
                    <div style="
                        background: white;
                        border-radius: 16px;
                        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
                        max-width: 600px;
                        width: 90%;
                        max-height: 90vh;
                        overflow-y: auto;
                    ">
                        <!-- HEADER -->
                        <div style="
                            background: linear-gradient(135deg, #3b82f6, #2563eb);
                            color: white;
                            padding: 20px;
                            border-radius: 16px 16px 0 0;
                        ">
                            <div style="font-size: 24px; font-weight: 700; margin-bottom: 4px;">
                                âœï¸ Fahrt bearbeiten
                            </div>
                            <div style="font-size: 14px; opacity: 0.9;">
                                ${ride.hotelName || 'Hotel-Fahrt'}
                            </div>
                        </div>
                        
                        <!-- CONTENT -->
                        <div style="padding: 24px;">
                            ${ride.hotelCalendarId ? `
                            <div style="
                                background: #fef3c7;
                                border-left: 3px solid #f59e0b;
                                padding: 12px;
                                border-radius: 8px;
                                margin-bottom: 20px;
                            ">
                                <div style="font-size: 12px; color: #92400e; line-height: 1.5;">
                                    âš ï¸ <strong>Hotel-Fahrt:</strong> Ã„nderungen hier betreffen NUR die Rechnung,
                                    nicht den Hotel-Kalender!
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- DATUM -->
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-weight: 600; font-size: 13px; color: #374151; margin-bottom: 6px;">
                                    ğŸ“… Datum
                                </label>
                                <input type="date" id="edit-date" value="${dateStr}" style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 2px solid #e5e7eb;
                                    border-radius: 8px;
                                    font-size: 14px;
                                ">
                            </div>
                            
                            <!-- ZEIT -->
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-weight: 600; font-size: 13px; color: #374151; margin-bottom: 6px;">
                                    ğŸ• Zeit
                                </label>
                                <input type="time" id="edit-time" value="${timeStr}" style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 2px solid #e5e7eb;
                                    border-radius: 8px;
                                    font-size: 14px;
                                ">
                            </div>
                            
                            <!-- GAST -->
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-weight: 600; font-size: 13px; color: #374151; margin-bottom: 6px;">
                                    ğŸ’¾ Gast / Kunde
                                </label>
                                <input type="text" id="edit-guest" value="${ride.guestName || ride.customerName || ''}" style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 2px solid #e5e7eb;
                                    border-radius: 8px;
                                    font-size: 14px;
                                ">
                            </div>
                            
                            <!-- VON -->
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-weight: 600; font-size: 13px; color: #374151; margin-bottom: 6px;">
                                    ğŸ“ Von
                                </label>
                                <input type="text" id="edit-pickup" value="${ride.pickup || ''}" style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 2px solid #e5e7eb;
                                    border-radius: 8px;
                                    font-size: 14px;
                                ">
                            </div>
                            
                            <!-- NACH -->
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-weight: 600; font-size: 13px; color: #374151; margin-bottom: 6px;">
                                    ğŸ¯ Nach
                                </label>
                                <input type="text" id="edit-destination" value="${ride.destination || ''}" style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 2px solid #e5e7eb;
                                    border-radius: 8px;
                                    font-size: 14px;
                                ">
                            </div>
                            
                            <!-- PREIS -->
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-weight: 600; font-size: 13px; color: #374151; margin-bottom: 6px;">
                                    ğŸ’° Preis (â‚¬)
                                </label>
                                <input type="number" id="edit-price" value="${ride.price || 0}" step="0.01" min="0" style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 2px solid #e5e7eb;
                                    border-radius: 8px;
                                    font-size: 14px;
                                    font-weight: 600;
                                ">
                            </div>
                            
                            <!-- BUTTONS -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 24px;">
                                <button onclick="closeEditDialog()" style="
                                    padding: 14px;
                                    background: #e5e7eb;
                                    color: #1f2937;
                                    border: none;
                                    border-radius: 8px;
                                    font-weight: 600;
                                    cursor: pointer;
                                    font-size: 14px;
                                ">
                                    ğŸ’¾ Abbrechen
                                </button>
                                <button onclick="saveEditedInvoiceRide('${rideId}')" style="
                                    padding: 14px;
                                    background: linear-gradient(135deg, #10b981, #059669);
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    font-weight: 600;
                                    cursor: pointer;
                                    font-size: 14px;
                                ">
                                    âœ… Speichern
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(dialog);
                
                // Focus erstes Feld
                setTimeout(() => document.getElementById('edit-guest')?.focus(), 100);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Edit-Dialog:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // SchlieÃŸe Edit-Dialog
        function closeEditDialog() {
            const dialog = document.getElementById('edit-ride-dialog');
            if (dialog) dialog.remove();
        }
        
        // Speichere bearbeitete Fahrt (Hotel-Rechnungen)
        // ğŸ†• v5.87.91: Umbenannt zu saveEditedInvoiceRide um Konflikt zu vermeiden!
        async function saveEditedInvoiceRide(rideId) {
            try {
                // Lese Werte
                const dateValue = document.getElementById('edit-date').value;
                const timeValue = document.getElementById('edit-time').value;
                const guest = document.getElementById('edit-guest').value.trim();
                const pickup = document.getElementById('edit-pickup').value.trim();
                const destination = document.getElementById('edit-destination').value.trim();
                const price = parseFloat(document.getElementById('edit-price').value) || 0;
                
                // Validierung
                if (!guest || !pickup || !destination) {
                    alert('ğŸ’¾ Bitte alle Felder ausfÃ¼llen!');
                    return;
                }
                
                // Kombiniere Datum + Zeit
                const pickupTime = new Date(`${dateValue}T${timeValue}`).getTime();
                
                // Update in Firebase
                await db.ref(`rides/${rideId}`).update({
                    guestName: guest,
                    customerName: guest,
                    pickup: pickup,
                    destination: destination,
                    price: price,
                    pickupTime: pickupTime,
                    updatedAt: Date.now()
                });
                
                console.log('âœ… Fahrt gespeichert!');
                
                // SchlieÃŸe Dialog
                closeEditDialog();
                
                // Neu laden
                await loadInvoiceRides();
                
                // Success Message
                const successMsg = document.createElement('div');
                successMsg.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #10b981, #059669);
                    color: white;
                    padding: 16px 24px;
                    border-radius: 12px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    z-index: 999999;
                    font-weight: 600;
                `;
                successMsg.textContent = 'âœ… Fahrt gespeichert!';
                document.body.appendChild(successMsg);
                
                setTimeout(() => {
                    successMsg.style.transition = 'opacity 0.5s';
                    successMsg.style.opacity = '0';
                    setTimeout(() => successMsg.remove(), 500);
                }, 3000);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Speichern:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // ğŸ†• v5.87.59: DELETE Fahrt mit Warnung
        async function deleteInvoiceRide(rideId) {
            try {
                const ride = currentInvoiceRides.find(r => r.id === rideId);
                if (!ride) {
                    alert('ğŸ’¾ Fahrt nicht gefunden!');
                    return;
                }
                
                // WARNUNG fÃ¼r Hotel-Fahrten
                let confirmMsg = 'ğŸ—‘ï¸ Fahrt wirklich lÃ¶schen?\n\n' +
                    `ğŸ’¾ Gast: ${ride.guestName || ride.customerName || '?'}\n` +
                    `ğŸ“ Von: ${ride.pickup || '?'}\n` +
                    `ğŸ¯ Nach: ${ride.destination || '?'}\n` +
                    `ğŸ’° Preis: ${ride.price || 0}â‚¬\n\n`;
                
                if (ride.hotelCalendarId) {
                    confirmMsg += `âš ï¸ ACHTUNG: HOTEL-FAHRT!\n` +
                        `ğŸ¨ Hotel: ${ride.hotelName || 'Unbekannt'}\n\n` +
                        `Diese Fahrt wurde vom Hotel-Kalender importiert.\n` +
                        `Das Hotel wird NICHT automatisch informiert!\n\n` +
                        `Trotzdem lÃ¶schen?`;
                }
                
                if (!confirm(confirmMsg)) {
                    return;
                }
                
                // LÃ¶sche in Firebase
                await db.ref(`rides/${rideId}`).remove();
                
                console.log('ğŸ—‘ï¸ Fahrt gelÃ¶scht:', rideId);
                
                // Neu laden
                await loadInvoiceRides();
                
                // Success Message
                const successMsg = document.createElement('div');
                successMsg.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #ef4444, #dc2626);
                    color: white;
                    padding: 16px 24px;
                    border-radius: 12px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    z-index: 999999;
                    font-weight: 600;
                `;
                successMsg.textContent = 'ğŸ—‘ï¸ Fahrt gelÃ¶scht!';
                document.body.appendChild(successMsg);
                
                setTimeout(() => {
                    successMsg.style.transition = 'opacity 0.5s';
                    successMsg.style.opacity = '0';
                    setTimeout(() => successMsg.remove(), 500);
                }, 3000);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim LÃ¶schen:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // ğŸ†• v5.87.56: Toggle einzelne Zeile
        function toggleRideSelection(rideId) {
            if (selectedInvoiceRides.has(rideId)) {
                selectedInvoiceRides.delete(rideId);
            } else {
                selectedInvoiceRides.add(rideId);
            }
            renderInvoiceRides();
        }
        
        // ğŸ†• v5.87.56: Toggle alle Zeilen
        function toggleAllRides(checkbox) {
            if (checkbox.checked) {
                currentInvoiceRides.forEach(ride => selectedInvoiceRides.add(ride.id));
            } else {
                selectedInvoiceRides.clear();
            }
            renderInvoiceRides();
        }
        
        // ğŸ†• v5.87.56: Toggle Preis fÃ¼r einzelne Zeile
        async function toggleSinglePrice(rideId) {
            try {
                const ride = currentInvoiceRides.find(r => r.id === rideId);
                if (!ride) return;
                
                const currentPrice = parseFloat(ride.price || 0);
                const newPrice = currentPrice === 0 ? (ride.originalPrice || 0) : 0;
                
                // Speichere Original-Preis beim ersten Mal
                if (ride.originalPrice === undefined && currentPrice > 0) {
                    ride.originalPrice = currentPrice;
                }
                
                // Update in Firebase
                await db.ref(`rides/${rideId}`).update({
                    priceOverride: newPrice,
                    originalPrice: ride.originalPrice || currentPrice
                });
                
                // Update lokal
                ride.price = newPrice;
                ride.priceOverride = newPrice;
                
                console.log(`ğŸ’° Preis geÃ¤ndert: ${ride.customerName} â†’ ${newPrice}â‚¬`);
                
                // Re-render
                renderInvoiceRides();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Toggle:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // ğŸ†• v5.87.56: Toggle Preis fÃ¼r mehrere Zeilen
        async function toggleMultiplePrices() {
            if (selectedInvoiceRides.size === 0) return;
            
            const count = selectedInvoiceRides.size;
            if (!confirm(`${count} Fahrt${count !== 1 ? 'en' : ''} auf 0â‚¬ setzen?`)) return;
            
            try {
                const updates = [];
                
                for (const rideId of selectedInvoiceRides) {
                    const ride = currentInvoiceRides.find(r => r.id === rideId);
                    if (!ride) continue;
                    
                    const currentPrice = parseFloat(ride.price || 0);
                    
                    // Nur auf 0 setzen, nicht zurÃ¼ck
                    if (currentPrice > 0) {
                        // Speichere Original
                        if (ride.originalPrice === undefined) {
                            ride.originalPrice = currentPrice;
                        }
                        
                        updates.push(
                            db.ref(`rides/${rideId}`).update({
                                priceOverride: 0,
                                originalPrice: ride.originalPrice || currentPrice
                            })
                        );
                        
                        ride.price = 0;
                        ride.priceOverride = 0;
                    }
                }
                
                await Promise.all(updates);
                
                console.log(`âœ… ${updates.length} Preise auf 0â‚¬ gesetzt`);
                
                // Auswahl zurÃ¼cksetzen
                selectedInvoiceRides.clear();
                
                // Re-render
                renderInvoiceRides();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Multi-Toggle:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // Erstelle PDF-Rechnung
        // ğŸ†• v5.87.88: NEUE RECHNUNGS-GENERIERUNG MIT GRUPPIERUNG!
        async function createHotelInvoicePDF() {
            if (currentInvoiceRides.length === 0) {
                alert('ğŸ’¾ Keine Fahrten zum Abrechnen!');
                return;
            }
            
            if (!currentInvoiceHotel) {
                alert('ğŸ’¾ Bitte wÃ¤hle ein spezifisches Hotel aus (nicht "Alle Hotels")!');
                return;
            }
            
            console.log('ğŸ“± Erstelle PDF-Rechnung (v5.87.88 - GRUPPIERT)...');
            
            try {
                // ğŸ†• LADE MWST-SATZ AUS EINSTELLUNGEN
                let vatRate = 19; // Default
                try {
                    const vatSnapshot = await db.ref('settings/vatRates').orderByChild('default').equalTo(true).once('value');
                    if (vatSnapshot.exists()) {
                        vatSnapshot.forEach(child => {
                            vatRate = child.val().rate;
                        });
                    }
                    console.log(`ğŸ“± MwSt-Satz: ${vatRate}%`);
                } catch (e) {
                    console.warn('âš ï¸ Konnte MwSt-Satz nicht laden, verwende 19%');
                }
                
                // ğŸ†• GRUPPIERE FAHRTEN NACH TARIF
                const groups = {
                    bahnhof_normal: { name: 'Kaiserhof zum Bahnhof Normal', rides: [], price: 8.00, description: 'Kaiserhof zum Bahnhof oder zurÃ¼ck' },
                    bahnhof_sonntag: { name: 'Kaiserhof zum Bahnhof Feiertag/Sonntag', rides: [], price: 9.00, description: 'Kaiserhof zum Bahnhof oder zurÃ¼ck' },
                    flughafen: { name: 'Kaiserhof zum Flughafen', rides: [], price: 35.00, description: 'Kaiserhof zum Flughafen Hin oder zurÃ¼ck' }
                };
                
                // Sortiere Fahrten in Gruppen
                currentInvoiceRides.forEach(ride => {
                    const price = parseFloat(ride.price || 0);
                    const pickupDate = new Date(ride.pickupTime || ride.createdAt);
                    const dayOfWeek = pickupDate.getDay(); // 0 = Sonntag
                    
                    // PrÃ¼fe ob Bahnhof-Fahrt
                    const isBahnhof = (ride.pickup || '').toLowerCase().includes('bahnhof') || 
                                      (ride.destination || '').toLowerCase().includes('bahnhof');
                    
                    // PrÃ¼fe ob Flughafen-Fahrt
                    const isFlughafen = (ride.pickup || '').toLowerCase().includes('flughafen') || 
                                        (ride.destination || '').toLowerCase().includes('flughafen');
                    
                    if (isFlughafen) {
                        groups.flughafen.rides.push(ride);
                    } else if (isBahnhof) {
                        // Sonntag oder 9â‚¬ Preis = Sonntag-Tarif
                        if (dayOfWeek === 0 || price >= 9) {
                            groups.bahnhof_sonntag.rides.push(ride);
                        } else {
                            groups.bahnhof_normal.rides.push(ride);
                        }
                    } else {
                        // Default: Bahnhof Normal
                        groups.bahnhof_normal.rides.push(ride);
                    }
                });
                
                // Berechne Summen
                let nettoTotal = 0;
                const positions = [];
                let posNr = 1;
                
                Object.keys(groups).forEach(key => {
                    const group = groups[key];
                    if (group.rides.length > 0) {
                        const amount = group.rides.length;
                        const total = amount * group.price;
                        nettoTotal += total;
                        
                        positions.push({
                            nr: posNr++,
                            name: group.name,
                            description: group.description,
                            amount: amount,
                            unit: 'Transfer',
                            price: group.price,
                            vatRate: vatRate,
                            total: total
                        });
                    }
                });
                
                const mwstAmount = nettoTotal * (vatRate / 100);
                const bruttoTotal = nettoTotal + mwstAmount;
                
                // Rechnungsnummer generieren
                const now = new Date();
                const monthStr = String(now.getMonth() + 1).padStart(2, '0');
                const yearStr = String(now.getFullYear());
                const hotelShort = currentInvoiceHotel.name.replace(/\s+/g, '-').toUpperCase().substring(0, 20);
                const invoiceNr = `RE${Math.floor(1000 + Math.random() * 9000)}`;
                
                // Erstelle PDF mit jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // ğŸ“± LAYOUT WIE VORLAGE RE1213
                let y = 20;
                
                // HEADER RECHTS
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Rechnungsnr.:', 140, y);
                doc.setFont('helvetica', 'normal');
                doc.text(invoiceNr, 175, y);
                y += 5;
                
                doc.setFont('helvetica', 'bold');
                doc.text('Kundennr.:', 140, y);
                doc.setFont('helvetica', 'normal');
                doc.text('10008', 175, y);
                y += 5;
                
                doc.setFont('helvetica', 'bold');
                doc.text('Datum:', 140, y);
                doc.setFont('helvetica', 'normal');
                doc.text(new Date().toLocaleDateString('de-DE'), 175, y);
                y += 5;
                
                // Lieferzeitraum
                const monthName = new Date(currentInvoiceMonth + '-01').toLocaleDateString('de-DE', { month: '2-digit', year: 'numeric' });
                const firstDay = `01.${monthName}`;
                const lastDay = new Date(new Date(currentInvoiceMonth + '-01').getFullYear(), 
                                         new Date(currentInvoiceMonth + '-01').getMonth() + 1, 
                                         0).toLocaleDateString('de-DE');
                
                doc.setFont('helvetica', 'bold');
                doc.text('Lieferzeitraum:', 140, y);
                doc.setFont('helvetica', 'normal');
                doc.text(firstDay, 175, y);
                y += 5;
                doc.text('bis ' + lastDay, 175, y);
                
                // TITEL
                y = 40;
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Rechnung', 20, y);
                
                // ABSENDER (LINKS)
                y = 55;
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('Taxiunternehmen Patrick Wydra', 20, y);
                y += 5;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.text('Amselring 10', 20, y);
                y += 5;
                doc.text('17424 Ostseebad Heringsdorf', 20, y);
                y += 5;
                doc.text('Tel.: Festnetz: 038378/22022', 20, y);
                
                // EMPFÃ„NGER
                y = 90;
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.text(currentInvoiceHotel.name || 'Hotel', 20, y);
                y += 5;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                // Hier kÃ¶nnten Hotel-Adressen aus Firebase kommen
                doc.text('August-Bebel-Str. 55', 20, y);
                y += 5;
                doc.text('18055 Rostock', 20, y);
                
                // TEXT
                y = 115;
                doc.setFontSize(10);
                doc.text('Unsere Lieferungen/Leistungen stellen wir Ihnen wie folgt in Rechnung.', 20, y);
                
                // TABELLE HEADER
                y = 130;
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                doc.text('Pos.', 20, y);
                doc.text('Bezeichnung', 35, y);
                doc.text('Menge', 120, y);
                doc.text('Einheit', 140, y);
                doc.text('Einzel â‚¬', 160, y);
                doc.text('USt. %', 180, y);
                doc.text('Gesamt â‚¬', 195, y, { align: 'right' });
                
                // LINIE
                doc.line(20, y + 2, 195, y + 2);
                y += 8;
                
                // POSITIONEN
                doc.setFont('helvetica', 'normal');
                positions.forEach(pos => {
                    // Position Nummer
                    doc.text(String(pos.nr), 20, y);
                    
                    // Bezeichnung (Mehrzeilig)
                    doc.setFont('helvetica', 'bold');
                    doc.text(pos.name, 35, y);
                    y += 4;
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    doc.text(pos.description, 35, y);
                    doc.setFontSize(9);
                    y -= 4;
                    
                    // Menge, Einheit, Preis
                    doc.text(String(pos.amount), 120, y);
                    doc.text(pos.unit, 140, y);
                    doc.text(pos.price.toFixed(2), 160, y);
                    doc.text(pos.vatRate.toFixed(2), 180, y);
                    doc.text(pos.total.toFixed(2), 195, y, { align: 'right' });
                    
                    y += 8;
                });
                
                // GESAMTBETRAG
                y += 5;
                doc.line(20, y, 195, y);
                y += 7;
                
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.text('Gesamtbetrag*', 140, y);
                doc.text(bruttoTotal.toFixed(2), 195, y, { align: 'right' });
                
                // MWST-TEXT
                y += 10;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                const mwstText = `* Im Gesamtbetrag von ${bruttoTotal.toFixed(2)} â‚¬ (Netto: ${nettoTotal.toFixed(2)} â‚¬) sind USt ${vatRate} % (${mwstAmount.toFixed(2)} â‚¬) enthalten.`;
                doc.text(mwstText, 20, y);
                
                // ZAHLUNGSHINWEIS
                y += 10;
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.text('Zahlbar innerhalb 14 Tagen nach Rechnungserhalt', 20, y);
                
                // DANKESCHÃ–N
                y += 8;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.text('Vielen Dank fÃ¼r die gute Zusammenarbeit.', 20, y);
                
                // FOOTER (UNTEN)
                y = 270;
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                
                // Bank-Daten
                doc.text('Taxiunternehmen Patrick Wydra', 20, y);
                doc.text('Volksbank Vorpommern', 100, y);
                y += 4;
                doc.text('Amselring 10', 20, y);
                doc.text('IBAN: DE16 1309 1054 0001 5524 90', 100, y);
                y += 4;
                doc.text('17424 Ostseebad Heringsdorf', 20, y);
                doc.text('BIC: GENODEF1HST', 100, y);
                y += 4;
                doc.text('Tel.: Festnetz: 038378/22022', 20, y);
                doc.text('Steuernummer: 084 289/01178', 100, y);
                y += 4;
                doc.text('', 20, y);
                doc.text('IK: 601318664', 100, y);
                
                // Speichere PDF
                const filename = `Rechnung_${invoiceNr}_${monthStr}_${yearStr}.pdf`;
                doc.save(filename);
                
                console.log('âœ… PDF erstellt:', filename);
                
                // Speichere Rechnung in Firebase
                const invoiceData = {
                    invoiceNr: invoiceNr,
                    hotelId: currentInvoiceHotel ? Object.keys(hotelCalendars).find(k => hotelCalendars[k] === currentInvoiceHotel) : null,
                    hotelName: currentInvoiceHotel.name,
                    month: currentInvoiceMonth,
                    ridesCount: currentInvoiceRides.length,
                    positions: positions,
                    netto: nettoTotal,
                    mwst: mwstAmount,
                    vatRate: vatRate,
                    brutto: bruttoTotal,
                    status: 'open',
                    createdAt: Date.now(),
                    rideIds: currentInvoiceRides.map(r => r.id)
                };
                
                await db.ref('hotelInvoices').push(invoiceData);
                console.log('âœ… Rechnung in Firebase gespeichert');
                
                // Log
                logActivity('admin', 'hotel_invoice_created', `Rechnung erstellt: ${invoiceNr}`, {
                    hotel: currentInvoiceHotel.name,
                    rides: currentInvoiceRides.length,
                    total: bruttoTotal
                });
                
                // Reload Historie
                await loadInvoiceHistory();
                
                alert(`âœ… Rechnung erstellt!\n\n${invoiceNr}\n${positions.length} Positionen\n${currentInvoiceRides.length} Fahrten\n${bruttoTotal.toFixed(2)}â‚¬\n\nPDF wurde heruntergeladen.`);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim PDF-Erstellen:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // Lade Rechnungs-Historie
        async function loadInvoiceHistory() {
            console.log('ğŸ“‹ Lade Rechnungs-Historie...');
            
            const container = document.getElementById('invoice-history-list');
            if (!container) return;
            
            try {
                const snapshot = await db.ref('hotelInvoices').orderByChild('createdAt').once('value');
                const invoices = [];
                
                snapshot.forEach(child => {
                    const invoice = child.val();
                    invoice.id = child.key;
                    invoices.push(invoice);
                });
                
                // Neueste zuerst
                invoices.reverse();
                
                // Update Badge
                const badge = document.getElementById('hotel-invoices-count');
                if (badge) badge.textContent = invoices.length;
                
                if (invoices.length === 0) {
                    container.innerHTML = `
                        <div style="text-align:center;padding:20px;color:#6b7280;font-size:13px;">
                            Noch keine Rechnungen erstellt
                        </div>
                    `;
                    return;
                }
                
                let html = '<div style="display:flex;flex-direction:column;gap:10px;">';
                
                invoices.forEach(invoice => {
                    const createdDate = new Date(invoice.createdAt).toLocaleDateString('de-DE');
                    const statusColor = invoice.status === 'paid' ? '#10b981' : '#ef4444';
                    const statusText = invoice.status === 'paid' ? 'âœ… Bezahlt' : 'â³ Offen';
                    
                    html += `
                        <div style="background:white;border:2px solid #e5e7eb;border-radius:8px;padding:12px;">
                            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
                                <div>
                                    <div style="font-weight:700;font-size:14px;color:#1f2937;margin-bottom:4px;">
                                        ${invoice.invoiceNr}
                                    </div>
                                    <div style="font-size:12px;color:#6b7280;">
                                        ğŸ¨ ${invoice.hotelName} â€¢ ${invoice.ridesCount} Fahrten
                                    </div>
                                </div>
                                <div style="text-align:right;">
                                    <div style="font-weight:700;font-size:16px;color:#10b981;margin-bottom:4px;">
                                        ${(invoice.brutto || 0).toFixed(2)}â‚¬
                                    </div>
                                    <div style="font-size:11px;padding:3px 8px;background:${statusColor};color:white;border-radius:4px;font-weight:600;">
                                        ${statusText}
                                    </div>
                                </div>
                            </div>
                            <div style="font-size:11px;color:#9ca3af;margin-bottom:8px;">
                                Erstellt: ${createdDate}
                            </div>
                            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                                ${invoice.status === 'open' ? `
                                    <button onclick="markInvoicePaid('${invoice.id}')" style="flex:1;padding:8px;background:#10b981;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:12px;">
                                        âœ… Als bezahlt markieren
                                    </button>
                                ` : `
                                    <button onclick="markInvoiceOpen('${invoice.id}')" style="flex:1;padding:8px;background:#f59e0b;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:12px;">
                                        â†©ï¸ Wieder Ã¶ffnen
                                    </button>
                                `}
                                
                                <!-- ğŸ†• v5.90.128: VERSAND-BUTTONS -->
                                <button onclick="sendInvoiceViaEmail('${invoice.id}')" style="flex:1;padding:8px;background:#3b82f6;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;gap:4px;">
                                    ğŸ“§ E-Mail
                                </button>
                                <button onclick="sendInvoiceViaWhatsApp('${invoice.id}')" style="flex:1;padding:8px;background:#25d366;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;gap:4px;">
                                    ğŸ“± WhatsApp
                                </button>
                                
                                <button onclick="deleteInvoice('${invoice.id}')" style="padding:8px 12px;background:#ef4444;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:12px;">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
                console.log(`âœ… ${invoices.length} Rechnungen geladen`);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der Historie:', error);
            }
        }
        
        // Markiere Rechnung als bezahlt
        async function markInvoicePaid(invoiceId) {
            try {
                await db.ref(`hotelInvoices/${invoiceId}/status`).set('paid');
                await db.ref(`hotelInvoices/${invoiceId}/paidAt`).set(Date.now());
                console.log('âœ… Rechnung als bezahlt markiert');
                await loadInvoiceHistory();
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // Markiere Rechnung als offen
        async function markInvoiceOpen(invoiceId) {
            try {
                await db.ref(`hotelInvoices/${invoiceId}/status`).set('open');
                await db.ref(`hotelInvoices/${invoiceId}/paidAt`).remove();
                console.log('âœ… Rechnung wieder geÃ¶ffnet');
                await loadInvoiceHistory();
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // LÃ¶sche Rechnung
        async function deleteInvoice(invoiceId) {
            const confirmed = confirm('Rechnung wirklich lÃ¶schen?\n\nDie Fahrten bleiben erhalten.');
            if (!confirmed) return;
            
            try {
                await db.ref(`hotelInvoices/${invoiceId}`).remove();
                console.log('âœ… Rechnung gelÃ¶scht');
                await loadInvoiceHistory();
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler: ' + error.message);
            }
        }
        
        // ğŸ†• v5.90.128: HOTEL-RECHNUNG PER E-MAIL VERSENDEN
        async function sendInvoiceViaEmail(invoiceId) {
            console.log('ğŸ“§ Versende Hotel-Rechnung per E-Mail:', invoiceId);
            
            try {
                // Lade Rechnung
                const snapshot = await db.ref(`hotelInvoices/${invoiceId}`).once('value');
                const invoice = snapshot.val();
                
                if (!invoice) {
                    alert('ğŸ’¾ Rechnung nicht gefunden!');
                    return;
                }
                
                // PrÃ¼fe ob Hotel eine E-Mail hat
                if (!invoice.hotelEmail && !invoice.hotelCustomerId) {
                    alert('ğŸ’¾ Keine E-Mail-Adresse fÃ¼r dieses Hotel hinterlegt!\n\nBitte E-Mail-Adresse im Hotel-Kontakt hinzufÃ¼gen.');
                    return;
                }
                
                // Hole Hotel-Daten wenn nur CustomerId vorhanden
                let hotelEmail = invoice.hotelEmail;
                if (!hotelEmail && invoice.hotelCustomerId) {
                    const customerSnapshot = await db.ref(`customers/${invoice.hotelCustomerId}`).once('value');
                    const customer = customerSnapshot.val();
                    hotelEmail = customer?.email;
                }
                
                if (!hotelEmail) {
                    alert('ğŸ’¾ Keine E-Mail-Adresse gefunden!');
                    return;
                }
                
                // Erstelle E-Mail mit PDF
                const subject = `Rechnung ${invoice.invoiceNr} - ${invoice.hotelName}`;
                const body = `Sehr geehrte Damen und Herren,\n\nanbei erhalten Sie die Rechnung ${invoice.invoiceNr} fÃ¼r den Zeitraum ${invoice.period || ''}.\n\n` +
                             `Hotel: ${invoice.hotelName}\n` +
                             `Fahrten: ${invoice.ridesCount}\n` +
                             `Betrag: ${(invoice.brutto || 0).toFixed(2)}â‚¬\n\n` +
                             `Mit freundlichen GrÃ¼ÃŸen\n` +
                             `Ihr Taxi-Team`;
                
                // Ã–ffne E-Mail-Programm
                const mailtoLink = `mailto:${hotelEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.open(mailtoLink, '_blank');
                
                console.log('âœ… E-Mail-Programm geÃ¶ffnet');
                alert('ğŸ“§ E-Mail-Programm geÃ¶ffnet!\n\nBitte hÃ¤ngen Sie die PDF-Rechnung manuell an.');
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler beim Versenden: ' + error.message);
            }
        }
        
        // ğŸ†• v5.90.128: HOTEL-RECHNUNG PER WHATSAPP VERSENDEN
        async function sendInvoiceViaWhatsApp(invoiceId) {
            console.log('ğŸ“± Versende Hotel-Rechnung per WhatsApp:', invoiceId);
            
            try {
                // Lade Rechnung
                const snapshot = await db.ref(`hotelInvoices/${invoiceId}`).once('value');
                const invoice = snapshot.val();
                
                if (!invoice) {
                    alert('ğŸ’¾ Rechnung nicht gefunden!');
                    return;
                }
                
                // PrÃ¼fe ob Hotel eine Handynummer hat
                if (!invoice.hotelPhone && !invoice.hotelCustomerId) {
                    alert('ğŸ’¾ Keine Telefonnummer fÃ¼r dieses Hotel hinterlegt!\n\nBitte Telefonnummer im Hotel-Kontakt hinzufÃ¼gen.');
                    return;
                }
                
                // Hole Hotel-Daten wenn nur CustomerId vorhanden
                let hotelPhone = invoice.hotelPhone;
                if (!hotelPhone && invoice.hotelCustomerId) {
                    const customerSnapshot = await db.ref(`customers/${invoice.hotelCustomerId}`).once('value');
                    const customer = customerSnapshot.val();
                    hotelPhone = customer?.mobilePhone || customer?.phone;
                }
                
                if (!hotelPhone) {
                    alert('ğŸ’¾ Keine Telefonnummer gefunden!');
                    return;
                }
                
                // Bereinige Telefonnummer
                const cleanPhone = hotelPhone.replace(/[^0-9+]/g, '');
                
                // Erstelle WhatsApp-Nachricht
                const message = `Hallo ${invoice.hotelName},\n\n` +
                               `anbei die Rechnung ${invoice.invoiceNr}:\n\n` +
                               `ğŸ“… Zeitraum: ${invoice.period || ''}\n` +
                               `ğŸš• Fahrten: ${invoice.ridesCount}\n` +
                               `ğŸ’° Betrag: ${(invoice.brutto || 0).toFixed(2)}â‚¬\n\n` +
                               `Mit freundlichen GrÃ¼ÃŸen`;
                
                // Ã–ffne WhatsApp
                const whatsappLink = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
                window.open(whatsappLink, '_blank');
                
                console.log('âœ… WhatsApp geÃ¶ffnet');
                alert('ğŸ“± WhatsApp geÃ¶ffnet!\n\nBitte senden Sie die PDF-Rechnung als Datei-Anhang.');
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler beim Versenden: ' + error.message);
            }
        }
        
        // ğŸ†• v5.90.128: EINZEL-RECHNUNG PER E-MAIL VERSENDEN
        async function sendSingleInvoiceViaEmail(invoiceId) {
            console.log('ğŸ“§ Versende Einzel-Rechnung per E-Mail:', invoiceId);
            
            try {
                // Lade Rechnung
                const snapshot = await db.ref(`invoices/${invoiceId}`).once('value');
                const invoice = snapshot.val();
                
                if (!invoice) {
                    alert('ğŸ’¾ Rechnung nicht gefunden!');
                    return;
                }
                
                // PrÃ¼fe ob Kunde eine E-Mail hat
                let customerEmail = invoice.customerEmail;
                console.log('ğŸ“§ v5.90.152: E-Mail aus Rechnung:', customerEmail);
                console.log('ğŸ“§ v5.90.152: Customer ID:', invoice.customerId);
                
                if (!customerEmail && invoice.customerId) {
                    console.log('ğŸ” Lade Kunde aus Firebase:', invoice.customerId);
                    const customerSnapshot = await db.ref(`customers/${invoice.customerId}`).once('value');
                    const customer = customerSnapshot.val();
                    customerEmail = customer?.email;
                    console.log('ğŸ“§ E-Mail vom Kunden geladen:', customerEmail);
                }
                
                if (!customerEmail || customerEmail.trim() === '') {
                    console.error('ğŸ’¾ Keine E-Mail gefunden!');
                    console.error('   Invoice Customer Email:', invoice.customerEmail);
                    console.error('   Invoice Customer ID:', invoice.customerId);
                    console.error('   Invoice Customer Name:', invoice.customerName);
                    alert('ğŸ’¾ Keine E-Mail-Adresse fÃ¼r diesen Kunden hinterlegt!\n\nBitte E-Mail-Adresse im CRM hinzufÃ¼gen.\n\nğŸ’¡ Tipp: Nutze den "âœï¸ CRM" Button in der Rechnungs-Liste!');
                    return;
                }
                
                console.log('âœ… E-Mail gefunden:', customerEmail);
                
                // Erstelle E-Mail mit PDF
                const subject = `Rechnung ${invoice.invoiceNumber || invoice.id} - Taxi Heringsdorf`;
                const body = `Sehr geehrte/r ${invoice.customerName || 'Kunde'},\n\n` +
                             `anbei erhalten Sie Ihre Rechnung ${invoice.invoiceNumber || invoice.id}.\n\n` +
                             `Betrag: ${(invoice.totalGross || 0).toFixed(2)}â‚¬\n` +
                             `Status: ${invoice.status === 'bezahlt' ? 'Bezahlt' : 'Offen'}\n\n` +
                             `Vielen Dank fÃ¼r Ihr Vertrauen!\n\n` +
                             `Mit freundlichen GrÃ¼ÃŸen\n` +
                             `Ihr Taxi-Team`;
                
                // Ã–ffne E-Mail-Programm
                const mailtoLink = `mailto:${customerEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.open(mailtoLink, '_blank');
                
                console.log('âœ… E-Mail-Programm geÃ¶ffnet');
                alert('ğŸ“§ E-Mail-Programm geÃ¶ffnet!\n\nBitte hÃ¤ngen Sie die PDF-Rechnung manuell an.');
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler beim Versenden: ' + error.message);
            }
        }
        
        // ğŸ†• v5.79.0: .ICS DATEI UPLOAD & REVIEW
        
        let currentIcsRides = [];
        let currentIcsHotelName = '';
        let currentIcsCalendarId = '';  // v5.81.0: Hotel-Kalender ID
        let currentEditingIcsIndex = -1;
        
        // ğŸ†• v5.82.0: Filter-State
        let icsFilterYear = '';
        let icsFilterMonth = '';
        let icsAllRides = [];  // Alle Fahrten (ungefiltert)
        let icsFilteredRides = [];  // Gefilterte Fahrten
        
        // ğŸ†• v5.81.0: .ics Upload fÃ¼r spezifisches Hotel
        function uploadIcsForHotel(calendarId) {
            const calendar = hotelCalendars[calendarId];
            if (!calendar) {
                alert('ğŸ’¾ Hotel nicht gefunden!');
                return;
            }
            
            console.log('ğŸ“¤ .ics Upload fÃ¼r:', calendar.name);
            
            // Speichere Kalender-ID
            currentIcsCalendarId = calendarId;
            currentIcsHotelName = calendar.name;
            
            // Ã–ffne File-Dialog
            document.getElementById('ics-file-input').click();
        }
        
        // ğŸ†• v5.82.0: Filter anwenden
        function applyIcsFilter() {
            icsFilterYear = document.getElementById('ics-filter-year').value;
            icsFilterMonth = document.getElementById('ics-filter-month').value;
            
            console.log('ğŸ” Filter:', icsFilterYear || 'Alle Jahre', icsFilterMonth || 'Alle Monate');
            
            // Filtere Fahrten
            icsFilteredRides = icsAllRides.filter(ride => {
                const rideYear = ride.date.getFullYear().toString();
                const rideMonth = (ride.date.getMonth() + 1).toString();
                
                if (icsFilterYear && rideYear !== icsFilterYear) return false;
                if (icsFilterMonth && rideMonth !== icsFilterMonth) return false;
                
                return true;
            });
            
            // Aktualisiere currentIcsRides fÃ¼r die Tabelle
            currentIcsRides = icsFilteredRides;
            
            // Update Stats
            const stats = document.getElementById('ics-filter-stats');
            if (stats) {
                stats.textContent = `Gesamt: ${icsAllRides.length} Fahrten | Angezeigt: ${icsFilteredRides.length} Fahrten`;
            }
            
            // Render Tabelle
            renderIcsReviewTable();
            
            console.log(`âœ… ${icsFilteredRides.length} von ${icsAllRides.length} Fahrten angezeigt`);
        }
        
        // ğŸ†• v5.82.0: Filter zurÃ¼cksetzen
        function resetIcsFilter() {
            document.getElementById('ics-filter-year').value = '';
            document.getElementById('ics-filter-month').value = '';
            applyIcsFilter();
        }
        
        // ğŸ†• v5.82.0: Initialisiere Filter-Dropdowns
        function initIcsFilter() {
            // Ermittle Jahre aus Fahrten
            const years = new Set();
            icsAllRides.forEach(ride => {
                years.add(ride.date.getFullYear());
            });
            
            // Sortiere Jahre absteigend
            const sortedYears = Array.from(years).sort((a, b) => b - a);
            
            // FÃ¼lle Jahr-Dropdown
            const yearSelect = document.getElementById('ics-filter-year');
            if (yearSelect) {
                yearSelect.innerHTML = '<option value="">Alle Jahre</option>';
                sortedYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                });
                
                // v5.82.2: Setze NEUESTES Jahr aus Fahrten als Default
                if (sortedYears.length > 0) {
                    const newestYear = sortedYears[0]; // Bereits absteigend sortiert
                    yearSelect.value = newestYear;
                    
                    // v5.82.2: Monat auf "Alle Monate" lassen!
                    // (Statt neuesten Monat zu suchen, zeigen wir ALLE Fahrten vom neuesten Jahr)
                    const monthSelect = document.getElementById('ics-filter-month');
                    if (monthSelect) {
                        monthSelect.value = ""; // ALLE Monate
                    }
                    
                    console.log(`âœ… Filter-Default: ${newestYear} (alle Monate)`);
                }
            }
            
            // Wende Filter an
            applyIcsFilter();
        }
        
        // Upload .ics Datei
        async function handleIcsFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('ğŸ“¤ Lade .ics Datei:', file.name);
            
            try {
                // Datei lesen
                const text = await file.text();
                console.log(`âœ… ${text.length} Zeichen geladen`);
                
                // Parse iCal
                const events = parseICalendar(text);
                console.log(`ğŸ“… ${events.length} Events gefunden`);
                
                if (events.length === 0) {
                    alert('ğŸ’¾ Keine Events in der .ics Datei gefunden!');
                    return;
                }
                
                // Konvertiere zu Fahrten
                const rides = [];
                
                for (const event of events) {
                    const startTime = icalDateToISO(event.DTSTART);
                    if (!startTime) continue;
                    
                    const eventDate = new Date(startTime);
                    
                    // v5.81.1: KEIN Zeitfilter mehr! Alle Events werden importiert!
                    // Der Benutzer kann in der Review-Tabelle selbst auswÃ¤hlen welche er will.
                    
                    // Fahrt erstellen
                    const ride = {
                        date: eventDate,
                        time: eventDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }),
                        guest: event.SUMMARY || 'Unbekannt',
                        from: event.LOCATION || '',
                        to: event.DESCRIPTION ? event.DESCRIPTION.substring(0, 50) : '',
                        price: 8.00, // Standard-Preis
                        selected: true,
                        uid: event.UID || `event_${Date.now()}_${Math.random()}`
                    };
                    
                    // PrÃ¼fe Sonntag/Feiertag
                    const dayOfWeek = eventDate.getDay();
                    ride.isSunday = (dayOfWeek === 0);
                    ride.isSaturday = (dayOfWeek === 6);
                    
                    // Feiertag prÃ¼fen (einfache Liste)
                    ride.isHoliday = isGermanHoliday(eventDate);
                    
                    // Sonntag/Feiertag â†’ 9â‚¬
                    if (ride.isSunday || ride.isHoliday) {
                        ride.price = 9.00;
                    }
                    
                    rides.push(ride);
                }
                
                // v5.82.0: Speichere ALLE Fahrten (ungefiltert)
                icsAllRides = rides;
                currentIcsRides = rides;
                
                // v5.81.0: Hotel-Name kommt jetzt von uploadIcsForHotel()
                // (currentIcsHotelName und currentIcsCalendarId sind schon gesetzt)
                
                console.log(`âœ… ${rides.length} Fahrten vorbereitet`);
                
                // Zeige Hotel-Name und Datei in UI
                document.getElementById('ics-hotel-name').textContent = currentIcsHotelName;
                document.getElementById('ics-file-name').textContent = file.name;
                
                // v5.82.0: Initialisiere Filter (setzt Default: aktuelles Jahr + Monat)
                initIcsFilter();
                
                // Zeige Review-Container
                document.getElementById('ics-review-container').style.display = 'block';
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der .ics Datei:', error);
                alert('ğŸ’¾ Fehler beim Lesen der Datei:\n\n' + error.message);
            }
            
            // Reset file input
            event.target.value = '';
        }
        
        // PrÃ¼fe ob Feiertag (Deutschland, einfache Version)
        function isGermanHoliday(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            
            // Feste Feiertage
            const holidays = [
                [1, 1],   // Neujahr
                [5, 1],   // Tag der Arbeit
                [10, 3],  // Tag der Deutschen Einheit
                [12, 25], // 1. Weihnachtstag
                [12, 26]  // 2. Weihnachtstag
            ];
            
            for (const [m, d] of holidays) {
                if (month === m && day === d) return true;
            }
            
            return false;
        }
        
        // Render Review-Tabelle
        function renderIcsReviewTable() {
            const container = document.getElementById('ics-rides-table');
            if (!container) return;
            
            let html = `
                <table style="width:100%;border-collapse:collapse;font-size:13px;">
                    <thead>
                        <tr style="background:#f9fafb;">
                            <th style="padding:10px;text-align:center;font-weight:700;color:#374151;border-bottom:2px solid #e5e7eb;width:40px;">âœ“</th>
                            <th style="padding:10px;text-align:left;font-weight:700;color:#374151;border-bottom:2px solid #e5e7eb;">Datum</th>
                            <th style="padding:10px;text-align:left;font-weight:700;color:#374151;border-bottom:2px solid #e5e7eb;">Zeit</th>
                            <th style="padding:10px;text-align:left;font-weight:700;color:#374151;border-bottom:2px solid #e5e7eb;">Gast</th>
                            <th style="padding:10px;text-align:left;font-weight:700;color:#374151;border-bottom:2px solid #e5e7eb;">Von</th>
                            <th style="padding:10px;text-align:left;font-weight:700;color:#374151;border-bottom:2px solid #e5e7eb;">Nach</th>
                            <th style="padding:10px;text-align:right;font-weight:700;color:#374151;border-bottom:2px solid #e5e7eb;">Preis</th>
                            <th style="padding:10px;text-align:center;font-weight:700;color:#374151;border-bottom:2px solid #e5e7eb;">Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            currentIcsRides.forEach((ride, index) => {
                const dateStr = ride.date.toLocaleDateString('de-DE');
                const dayOfWeek = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'][ride.date.getDay()];
                
                let dateLabel = `${dateStr} (${dayOfWeek})`;
                let dateStyle = '';
                
                if (ride.isSunday) {
                    dateLabel += ' ğŸ”´';
                    dateStyle = 'background:#fef2f2;';
                } else if (ride.isSaturday) {
                    dateStyle = 'background:#fffbeb;';
                }
                
                if (ride.isHoliday) {
                    dateLabel += ' ğŸ„';
                    dateStyle = 'background:#fef2f2;';
                }
                
                const rowBg = index % 2 === 0 ? 'background:white;' : 'background:#f9fafb;';
                
                html += `
                    <tr style="border-bottom:1px solid #e5e7eb;${rowBg}${dateStyle}">
                        <td style="padding:10px;text-align:center;">
                            <input type="checkbox" ${ride.selected ? 'checked' : ''} onchange="toggleIcsRideSelection(${index})" style="width:18px;height:18px;cursor:pointer;">
                        </td>
                        <td style="padding:10px;color:#1f2937;font-weight:600;font-size:12px;">${dateLabel}</td>
                        <td style="padding:10px;color:#6b7280;">${ride.time}</td>
                        <td style="padding:10px;color:#1f2937;">${ride.guest}</td>
                        <td style="padding:10px;color:#6b7280;font-size:12px;">${ride.from || '-'}</td>
                        <td style="padding:10px;color:#6b7280;font-size:12px;">${ride.to || '-'}</td>
                        <td style="padding:10px;text-align:right;font-weight:700;color:#10b981;">${ride.price.toFixed(2)}â‚¬</td>
                        <td style="padding:10px;text-align:center;">
                            <button onclick="editIcsRide(${index})" style="padding:4px 8px;background:#3b82f6;color:white;border:none;border-radius:4px;cursor:pointer;margin-right:4px;font-size:11px;">
                                âœï¸
                            </button>
                            <button onclick="deleteIcsRide(${index})" style="padding:4px 8px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px;">
                                ğŸ—‘ï¸
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
            updateIcsSelectionInfo();
        }
        
        // Toggle Auswahl
        function toggleIcsRideSelection(index) {
            currentIcsRides[index].selected = !currentIcsRides[index].selected;
            updateIcsSelectionInfo();
        }
        
        // Alle auswÃ¤hlen
        function selectAllIcsRides() {
            currentIcsRides.forEach(ride => ride.selected = true);
            renderIcsReviewTable();
        }
        
        // Alle abwÃ¤hlen
        function deselectAllIcsRides() {
            currentIcsRides.forEach(ride => ride.selected = false);
            renderIcsReviewTable();
        }
        
        // Update Selection Info
        function updateIcsSelectionInfo() {
            const selected = currentIcsRides.filter(r => r.selected);
            const total = selected.reduce((sum, r) => sum + r.price, 0);
            
            const info = document.getElementById('ics-selection-info');
            if (info) {
                info.innerHTML = `
                    AusgewÃ¤hlt: <strong>${selected.length} von ${currentIcsRides.length}</strong> | 
                    Summe: <strong>${total.toFixed(2)}â‚¬</strong>
                `;
            }
        }
        
        // Bearbeiten
        function editIcsRide(index) {
            currentEditingIcsIndex = index;
            const ride = currentIcsRides[index];
            
            document.getElementById('edit-ics-guest').value = ride.guest;
            document.getElementById('edit-ics-from').value = ride.from;
            document.getElementById('edit-ics-to').value = ride.to;
            document.getElementById('edit-ics-price').value = ride.price.toFixed(2);
            
            document.getElementById('edit-ics-ride-modal').style.display = 'block';
        }
        
        // Speichere Edit
        function saveIcsRideEdit() {
            if (currentEditingIcsIndex === -1) return;
            
            const ride = currentIcsRides[currentEditingIcsIndex];
            ride.guest = document.getElementById('edit-ics-guest').value;
            ride.from = document.getElementById('edit-ics-from').value;
            ride.to = document.getElementById('edit-ics-to').value;
            ride.price = parseFloat(document.getElementById('edit-ics-price').value);
            
            closeEditIcsRideModal();
            renderIcsReviewTable();
        }
        
        // SchlieÃŸe Edit-Modal
        function closeEditIcsRideModal() {
            document.getElementById('edit-ics-ride-modal').style.display = 'none';
            currentEditingIcsIndex = -1;
        }
        
        // LÃ¶schen
        function deleteIcsRide(index) {
            const confirmed = confirm('Fahrt wirklich lÃ¶schen?');
            if (!confirmed) return;
            
            currentIcsRides.splice(index, 1);
            renderIcsReviewTable();
        }
        
        // SchlieÃŸe Review
        function closeIcsReview() {
            const confirmed = confirm('Import abbrechen?\n\nAlle Ã„nderungen gehen verloren.');
            if (!confirmed) return;
            
            currentIcsRides = [];
            currentIcsHotelName = '';
            currentIcsCalendarId = '';
            icsAllRides = [];  // v5.82.0
            icsFilteredRides = [];  // v5.82.0
            icsFilterYear = '';  // v5.82.0
            icsFilterMonth = '';  // v5.82.0
            document.getElementById('ics-review-container').style.display = 'none';
        }
        
        // BestÃ¤tige Import & Erstelle Rechnung
        async function confirmIcsImport() {
            const selected = currentIcsRides.filter(r => r.selected);
            
            if (selected.length === 0) {
                alert('ğŸ’¾ Bitte wÃ¤hle mindestens eine Fahrt aus!');
                return;
            }
            
            console.log(`âœ… Importiere ${selected.length} Fahrten...`);
            
            try {
                // Speichere in Firebase
                const rideRefs = [];
                
                for (const ride of selected) {
                    const rideData = {
                        // v5.81.0: Hotel-Kalender ID (WICHTIG!)
                        hotelCalendarId: currentIcsCalendarId,
                        hotelCalendarName: currentIcsHotelName,
                        customerId: `ics_import_${Date.now()}`,
                        
                        // Zeit
                        pickupTime: ride.date.toISOString(),
                        createdAt: Date.now(),
                        
                        // Kunde
                        customerName: currentIcsHotelName,
                        customerPhone: 'ICS-Import',
                        
                        // Gast
                        guestName: ride.guest,
                        
                        // Locations
                        pickup: ride.from || currentIcsHotelName,
                        destination: ride.to || '',
                        
                        // Preis
                        price: ride.price,
                        
                        // Status
                        status: 'open',
                        preBooked: true,
                        
                        // Meta
                        notes: `ğŸ“¤ Importiert aus .ics Datei\nHotel: ${currentIcsHotelName}`,
                        source: 'ics_file_import'
                    };
                    
                    const ref = await db.ref('rides').push(rideData);
                    rideRefs.push(ref.key);
                }
                
                console.log(`âœ… ${selected.length} Fahrten in Firebase gespeichert`);
                
                // Log
                logActivity('admin', 'ics_import', `${selected.length} Fahrten aus .ics importiert`, {
                    hotel: currentIcsHotelName,
                    count: selected.length
                });
                
                // Berechne Summen fÃ¼r Rechnung
                const netto = selected.reduce((sum, r) => sum + r.price, 0);
                const mwst = netto * 0.19;
                const brutto = netto + mwst;
                
                // Erstelle Rechnung
                const monthYear = selected[0].date.toLocaleDateString('de-DE', { year: 'numeric', month: '2-digit' }).replace('.', '');
                const invoiceNr = `${monthYear}-${currentIcsHotelName.replace(/\s+/g, '-').toUpperCase()}`;
                
                const invoiceData = {
                    invoiceNr: invoiceNr,
                    hotelName: currentIcsHotelName,
                    month: `${selected[0].date.getFullYear()}-${String(selected[0].date.getMonth() + 1).padStart(2, '0')}`,
                    ridesCount: selected.length,
                    netto: netto,
                    mwst: mwst,
                    brutto: brutto,
                    status: 'open',
                    createdAt: Date.now(),
                    rideIds: rideRefs,
                    source: 'ics_import'
                };
                
                await db.ref('hotelInvoices').push(invoiceData);
                console.log('âœ… Rechnung erstellt:', invoiceNr);
                
                // SchlieÃŸe Review
                document.getElementById('ics-review-container').style.display = 'none';
                currentIcsRides = [];
                currentIcsHotelName = '';
                currentIcsCalendarId = '';
                
                // Reload Hotel-Liste
                await initHotelInvoices();
                
                // Success
                alert(`âœ… Import erfolgreich!\n\n${selected.length} Fahrten importiert\nRechnung ${invoiceNr} erstellt\n\nDu kannst jetzt die PDF erstellen!`);
                
            } catch (error) {
                console.error('ğŸ’¾ Import-Fehler:', error);
                alert('ğŸ’¾ Fehler beim Import:\n\n' + error.message);
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.84.0: CSV IMPORT FÃœR HOTEL-KALENDER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Globale Variablen fÃ¼r CSV
        let currentCsvRides = [];
        let currentCsvHotelName = '';
        let currentCsvCalendarId = '';
        
        // ğŸ†• v5.84.0: CSV Import Dialog zeigen
        function showCSVImportDialog() {
            console.log('ğŸ“± Ã–ffne CSV Import Dialog...');
            
            // PrÃ¼fe ob Hotel-Kalender existieren
            const hotelIds = Object.keys(hotelCalendars || {});
            if (hotelIds.length === 0) {
                alert('âš ï¸ Bitte zuerst einen Hotel-Kalender anlegen!\n\nGehe zu "Hotel-Kalender" und klicke "Neuen Hotel-Kalender hinzufÃ¼gen".');
                return;
            }
            
            // Erstelle Hotel-Auswahl Dialog
            let hotelsHTML = '<div style="max-height:300px;overflow-y:auto;">';
            hotelIds.forEach(id => {
                const hotel = hotelCalendars[id];
                hotelsHTML += `
                    <button onclick="uploadCsvForHotel('${id}')" style="width:100%;padding:16px;margin-bottom:10px;background:white;border:2px solid #e5e7eb;border-radius:8px;cursor:pointer;text-align:left;transition:all 0.2s;" onmouseover="this.style.borderColor='#10b981';this.style.background='#f0fdf4';" onmouseout="this.style.borderColor='#e5e7eb';this.style.background='white';">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <div style="width:12px;height:12px;border-radius:50%;background:${hotel.color};"></div>
                            <div style="flex:1;">
                                <div style="font-weight:700;font-size:15px;color:#1f2937;">${hotel.name}</div>
                                <div style="font-size:12px;color:#6b7280;">CSV Datei hochladen</div>
                            </div>
                            <div style="font-size:20px;">ğŸ“±</div>
                        </div>
                    </button>
                `;
            });
            hotelsHTML += '</div>';
            
            // Zeige Modal
            const modal = document.createElement('div');
            modal.id = 'csv-import-dialog';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;padding:20px;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:0;width:100%;max-width:600px;max-height:80vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                    <!-- Header -->
                    <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:20px;border-radius:12px 12px 0 0;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <h3 style="margin:0;font-size:20px;font-weight:700;">ğŸ“± CSV Import (Calengoo)</h3>
                            <button onclick="document.getElementById('csv-import-dialog').remove()" style="background:none;border:none;color:white;font-size:28px;cursor:pointer;line-height:1;padding:0;">Ã—</button>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div style="padding:20px;overflow-y:auto;">
                        <div style="background:#ecfdf5;border:2px solid #10b981;border-radius:8px;padding:12px;margin-bottom:20px;">
                            <div style="font-weight:700;margin-bottom:8px;color:#065f46;">â„¹ï¸ Hinweis:</div>
                            <ul style="margin:0;padding-left:20px;color:#065f46;font-size:13px;">
                                <li>CSV muss Calengoo-Format haben (Semikolon-getrennt)</li>
                                <li>Spalten: Start date;Start time;End date;End time;Title;Description;</li>
                                <li>Fahrten werden automatisch geparst</li>
                                <li>Du kannst die Fahrten vor dem Import nochmal prÃ¼fen</li>
                            </ul>
                        </div>
                        
                        <div style="font-weight:700;margin-bottom:12px;color:#1f2937;">WÃ¤hle Hotel-Kalender:</div>
                        ${hotelsHTML}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log('âœ… CSV Import Dialog gezeigt');
        }
        
        // CSV Upload triggern
        function uploadCsvForHotel(calendarId) {
            console.log('ğŸ“± CSV Upload fÃ¼r Hotel-Kalender:', calendarId);
            
            // SchlieÃŸe Dialog
            const dialog = document.getElementById('csv-import-dialog');
            if (dialog) dialog.remove();
            
            // Lade Hotel-Infos
            db.ref('hotelCalendars/' + calendarId).once('value').then(snapshot => {
                const calendar = snapshot.val();
                if (!calendar) {
                    alert('ğŸ’¾ Kalender nicht gefunden!');
                    return;
                }
                
                // âš ï¸ v5.85.3: WARNUNG - Zeige Kalender-Namen!
                const confirmed = confirm(`ğŸ“± CSV Import starten?\n\nğŸ¯ Kalender: ${calendar.name}\n\nâš ï¸ WICHTIG:\n- Alle Fahrten werden diesem Kalender zugeordnet!\n- Bitte prÃ¼fe den Kalender-Namen!\n\nFortfahren?`);
                
                if (!confirmed) {
                    console.log('ğŸ’¾ CSV Import abgebrochen');
                    return;
                }
                
                currentCsvCalendarId = calendarId;
                currentCsvHotelName = calendar.name;
                
                console.log('âœ… Hotel geladen:', currentCsvHotelName, '(ID:', calendarId, ')');
                
                // Trigger File Input
                const input = document.getElementById('csv-file-input');
                input.click();
            });
        }
        
        // CSV Datei verarbeiten
        async function handleCsvFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('ğŸ“± CSV Datei hochgeladen:', file.name);
            
            try {
                // Lese Datei
                const text = await file.text();
                console.log('ğŸ“± CSV Text gelesen, LÃ¤nge:', text.length);
                
                // Parse CSV
                const rides = parseCsvToRides(text);
                console.log('âœ… CSV geparst:', rides.length, 'Fahrten');
                
                if (rides.length === 0) {
                    alert('ğŸ’¾ Keine Fahrten in CSV gefunden!');
                    return;
                }
                
                // Speichere fÃ¼r Review
                currentCsvRides = rides.map(r => ({...r, selected: true}));
                
                // Zeige Review
                showCsvReview();
                
            } catch (error) {
                console.error('ğŸ’¾ CSV Parse Fehler:', error);
                alert('ğŸ’¾ Fehler beim Lesen der CSV:\n\n' + error.message);
            }
            
            // Reset Input
            event.target.value = '';
        }
        
        // CSV Parser - Calengoo Format
        function parseCsvToRides(csvText) {
            const rides = [];
            const lines = csvText.split('\n').filter(line => line.trim());
            
            console.log('ğŸ“± Parse CSV, Zeilen:', lines.length);
            
            // Skip Header (erste Zeile)
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue;
                
                try {
                    // Split by Semicolon
                    const parts = line.split(';').map(p => p.trim());
                    
                    if (parts.length < 5) {
                        console.warn('âš ï¸ Zeile Ã¼bersprungen (zu wenig Spalten):', line);
                        continue;
                    }
                    
                    const [startDate, startTime, endDate, endTime, title, description] = parts;
                    
                    // Parse Datum: DD.MM.YY
                    const dateParts = startDate.split('.');
                    if (dateParts.length !== 3) {
                        console.warn('âš ï¸ UngÃ¼ltiges Datum:', startDate);
                        continue;
                    }
                    
                    const day = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]) - 1; // JS Monate sind 0-based
                    let year = parseInt(dateParts[2]);
                    
                    // 2-stelliges Jahr zu 4-stellig
                    if (year < 100) {
                        year += 2000;
                    }
                    
                    // Parse Zeit: HH:MM
                    const timeParts = startTime.split(':');
                    const hours = parseInt(timeParts[0] || 0);
                    const minutes = parseInt(timeParts[1] || 0);
                    
                    // Erstelle Date Objekt
                    const date = new Date(year, month, day, hours, minutes);
                    
                    // ğŸ› v5.85.3: DEBUG LOGGING
                    console.log('ğŸ“… Datum geparst:', {
                        original: startDate,
                        parsed: {year, month: month+1, day, hours, minutes},
                        date: date.toISOString(),
                        display: date.toLocaleDateString('de-DE')
                    });
                    
                    // Parse Title - Extrahiere Infos
                    // Format: "11.00 Uhr , 2 PAx vom Hotel zum BHF, Fam Eichberg"
                    const titleLower = title.toLowerCase();
                    
                    // Personenzahl extrahieren
                    let passengers = 2; // Default
                    const paxMatch = title.match(/(\d+)\s*pax/i);
                    if (paxMatch) {
                        passengers = parseInt(paxMatch[1]);
                    }
                    
                    // Route extrahieren
                    let from = '';
                    let to = '';
                    
                    // ğŸ†• v5.84.2: NUR aus Title extrahieren, NICHT currentCsvHotelName verwenden!
                    if (titleLower.includes('vom hotel') || titleLower.includes('hotel -') || titleLower.includes('hotel zum')) {
                        from = 'Hotel';  // Generisch
                        if (titleLower.includes('bhf') || titleLower.includes('bahnhof')) {
                            to = 'Bahnhof Heringsdorf';
                        } else {
                            to = 'Ziel';  // Generisch
                        }
                    } else if (titleLower.includes('vom bhf') || titleLower.includes('bahnhof') || titleLower.includes('bhf -') || titleLower.includes('bhf.')) {
                        from = 'Bahnhof Heringsdorf';
                        if (titleLower.includes('hotel')) {
                            to = 'Hotel';  // Generisch
                        } else {
                            to = 'Ziel';  // Generisch
                        }
                    }
                    
                    // Fallback wenn nicht erkannt - kompletten Title nehmen
                    if (!from && !to) {
                        // Speichere kompletten Title fÃ¼r manuelle Bearbeitung
                        from = title;
                        to = '';
                    }
                    
                    // Gast-Name extrahieren (letzter Teil nach Komma)
                    let guest = '';
                    const guestMatch = title.match(/,\s*([^,]+)$/);
                    if (guestMatch) {
                        guest = guestMatch[1].trim();
                        // Entferne "Fam." / "Frau" / "Herr"
                        guest = guest.replace(/^(Fam\.?|Frau|Herr)\s*/i, '');
                    }
                    
                    // Preis berechnen (Standard 25â‚¬)
                    const price = 25.00;
                    
                    rides.push({
                        date: date,
                        from: from,
                        to: to,
                        guest: guest || 'Gast',
                        passengers: passengers,
                        price: price,
                        originalTitle: title
                    });
                    
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim Parsen von Zeile:', line, error);
                }
            }
            
            console.log('âœ… CSV geparst:', rides.length, 'Fahrten');
            return rides;
        }
        
        // Zeige CSV Review Modal
        function showCsvReview() {
            const container = document.getElementById('ics-review-container');
            if (!container) {
                console.error('ğŸ’¾ ICS Review Container nicht gefunden!');
                return;
            }
            
            container.innerHTML = `
                <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;padding:20px;overflow-y:auto;">
                    <div style="background:white;border-radius:12px;max-width:1200px;width:100%;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.4);">
                        
                        <!-- Header -->
                        <div style="padding:20px;background:linear-gradient(135deg,#10b981,#059669);color:white;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <h3 style="margin:0;font-size:20px;font-weight:700;">ğŸ“± CSV Import - ${currentCsvHotelName}</h3>
                                <div style="font-size:14px;opacity:0.9;margin-top:4px;">${currentCsvRides.length} Fahrten gefunden</div>
                            </div>
                            <button onclick="closeCsvReview()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:40px;height:40px;border-radius:50%;cursor:pointer;font-size:24px;">Ã—</button>
                        </div>
                        
                        <!-- Content -->
                        <div style="padding:20px;overflow-y:auto;flex:1;">
                            <div id="csv-review-table"></div>
                        </div>
                        
                        <!-- Actions -->
                        <div style="padding:20px;border-top:2px solid #e5e7eb;display:flex;gap:12px;">
                            <button onclick="closeCsvReview()" style="flex:1;padding:14px;background:#f3f4f6;color:#6b7280;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                                Abbrechen
                            </button>
                            <button onclick="confirmCsvImport()" style="flex:1;padding:14px;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;box-shadow:0 2px 8px rgba(16,185,129,0.3);">
                                âœ… ${currentCsvRides.length} Fahrten importieren & Rechnung erstellen
                            </button>
                        </div>
                        
                    </div>
                </div>
            `;
            
            container.style.display = 'block';
            renderCsvReviewTable();
        }
        
        // Rendere CSV Review Tabelle
        function renderCsvReviewTable() {
            const table = document.getElementById('csv-review-table');
            if (!table) return;
            
            const selected = currentCsvRides.filter(r => r.selected).length;
            
            let html = `
                <div style="background:#f0fdf4;padding:12px;border-radius:8px;margin-bottom:16px;border:2px solid #10b981;">
                    <div style="font-weight:600;color:#065f46;">
                        âœ… ${selected} von ${currentCsvRides.length} Fahrten ausgewÃ¤hlt
                    </div>
                    <div style="font-size:13px;color:#065f46;margin-top:4px;">
                        Alle Fahrten werden in eine Rechnung zusammengefasst
                    </div>
                </div>
                
                <div style="overflow-x:auto;">
                    <table style="width:100%;border-collapse:collapse;">
                        <thead>
                            <tr style="background:#f3f4f6;">
                                <th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;">
                                    <input type="checkbox" ${selected === currentCsvRides.length ? 'checked' : ''} onchange="toggleAllCsvRides(this.checked)" style="cursor:pointer;">
                                </th>
                                <th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;">Datum & Zeit</th>
                                <th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;">Von</th>
                                <th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;">Nach</th>
                                <th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;">Gast</th>
                                <th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;">Personen</th>
                                <th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;">Preis</th>
                                <th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;min-width:200px;">ğŸ“ Original Title</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            currentCsvRides.forEach((ride, index) => {
                const dateStr = ride.date.toLocaleDateString('de-DE', {weekday: 'short', day: '2-digit', month: '2-digit', year: 'numeric'});
                const timeStr = ride.date.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
                
                html += `
                    <tr style="border-bottom:1px solid #e5e7eb;${ride.selected ? 'background:#f0fdf4;' : ''}">
                        <td style="padding:12px;">
                            <input type="checkbox" ${ride.selected ? 'checked' : ''} onchange="toggleCsvRide(${index}, this.checked)" style="cursor:pointer;">
                        </td>
                        <td style="padding:12px;">
                            <div style="font-weight:600;">${dateStr}</div>
                            <div style="font-size:13px;color:#6b7280;">${timeStr} Uhr</div>
                        </td>
                        <td style="padding:12px;">${ride.from || '-'}</td>
                        <td style="padding:12px;">${ride.to || '-'}</td>
                        <td style="padding:12px;">${ride.guest || '-'}</td>
                        <td style="padding:12px;">${ride.passengers} Pers.</td>
                        <td style="padding:12px;font-weight:600;">${ride.price.toFixed(2)}â‚¬</td>
                        <td style="padding:12px;font-size:12px;color:#6b7280;font-family:monospace;">${ride.originalTitle || '-'}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            table.innerHTML = html;
        }
        
        // Toggle einzelne CSV Fahrt
        function toggleCsvRide(index, checked) {
            currentCsvRides[index].selected = checked;
            renderCsvReviewTable();
        }
        
        // Toggle alle CSV Fahrten
        function toggleAllCsvRides(checked) {
            currentCsvRides.forEach(r => r.selected = checked);
            renderCsvReviewTable();
        }
        
        // SchlieÃŸe CSV Review
        function closeCsvReview() {
            const confirmed = confirm('Import abbrechen?\n\nAlle Ã„nderungen gehen verloren.');
            if (!confirmed) return;
            
            currentCsvRides = [];
            currentCsvHotelName = '';
            currentCsvCalendarId = '';
            document.getElementById('ics-review-container').style.display = 'none';
        }
        
        // BestÃ¤tige CSV Import & Erstelle Rechnung
        async function confirmCsvImport() {
            const selected = currentCsvRides.filter(r => r.selected);
            
            if (selected.length === 0) {
                alert('ğŸ’¾ Bitte wÃ¤hle mindestens eine Fahrt aus!');
                return;
            }
            
            console.log(`âœ… Importiere ${selected.length} Fahrten aus CSV...`);
            
            try {
                // Speichere in Firebase
                const rideRefs = [];
                
                for (const ride of selected) {
                    const rideData = {
                        // Hotel-Kalender ID
                        hotelCalendarId: currentCsvCalendarId,
                        hotelCalendarName: currentCsvHotelName,
                        customerId: `csv_import_${Date.now()}`,
                        
                        // Zeit - BEIDE FELDER!
                        pickupTimestamp: ride.date.getTime(), // âœ… FÃœR KALENDER (Zahl!)
                        pickupTime: ride.date.toISOString(),  // âœ… FÃœR ANZEIGE (String)
                        createdAt: Date.now(),
                        
                        // Kunde
                        customerName: currentCsvHotelName,
                        customerPhone: 'CSV-Import',
                        
                        // Gast
                        guestName: ride.guest,
                        
                        // Locations
                        pickup: ride.from || currentCsvHotelName,
                        destination: ride.to || 'Bahnhof Heringsdorf',
                        
                        // Details
                        passengers: ride.passengers,
                        price: ride.price,
                        
                        // Status
                        status: 'completed',
                        preBooked: true,
                        
                        // Meta
                        notes: `ğŸ“± Importiert aus CSV\nHotel: ${currentCsvHotelName}\nOriginal: ${ride.originalTitle}`,
                        source: 'csv-import'
                    };
                    
                    // ğŸ› v5.85.3: DEBUG LOGGING
                    console.log('ğŸ’¾ Speichere Fahrt:', {
                        date: ride.date.toLocaleDateString('de-DE'),
                        time: ride.date.toLocaleTimeString('de-DE'),
                        pickupTimestamp: rideData.pickupTimestamp,
                        pickupTime: rideData.pickupTime,
                        guest: rideData.guestName,
                        hotel: rideData.hotelCalendarName
                    });
                    
                    const ref = db.ref('rides').push();
                    await ref.set(rideData);
                    rideRefs.push(ref.key);
                    
                    console.log('âœ… Fahrt importiert:', ref.key);
                }
                
                // Erstelle Rechnung
                const invoiceNr = `CSV-${Date.now()}`;
                const invoiceData = {
                    invoiceNr: invoiceNr,
                    hotelName: currentCsvHotelName,
                    hotelCalendarId: currentCsvCalendarId,
                    rides: rideRefs,
                    createdAt: Date.now(),
                    status: 'draft',
                    source: 'csv-import'
                };
                
                await db.ref('hotelInvoices').push(invoiceData);
                console.log('âœ… Rechnung erstellt:', invoiceNr);
                
                // SchlieÃŸe Review
                document.getElementById('ics-review-container').style.display = 'none';
                currentCsvRides = [];
                currentCsvHotelName = '';
                currentCsvCalendarId = '';
                
                // Reload Hotel-Liste
                await initHotelInvoices();
                
                // Success
                alert(`âœ… CSV Import erfolgreich!\n\n${selected.length} Fahrten importiert\nRechnung ${invoiceNr} erstellt\n\nDu kannst jetzt die PDF erstellen!`);
                
            } catch (error) {
                console.error('ğŸ’¾ Import-Fehler:', error);
                alert('ğŸ’¾ Fehler beim CSV Import:\n\n' + error.message);
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.86.0: HOTEL-KALENDER VIEWS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Globale Variable fÃ¼r aktuellen Hotel-Kalender
        let currentHotelCalendarId = null;
        let currentHotelCalendarName = null;
        
        // ğŸ¨ LADE HOTEL-KALENDER LISTE
        async function loadHotelCalendarList() {
            console.log('ğŸ¨ Lade Hotel-Kalender Liste...');
            
            const container = document.getElementById('hotel-list-container');
            if (!container) {
                console.error('ğŸ’¾ Hotel-Liste Container nicht gefunden!');
                return;
            }
            
            // Verstecke Einzelkalender
            document.getElementById('hotel-single-calendar-container').style.display = 'none';
            container.style.display = 'block';
            
            try {
                // Lade Hotel-Kalender aus Firebase
                const snapshot = await db.ref('hotelCalendars').once('value');
                const hotels = snapshot.val() || {};
                
                const hotelList = Object.entries(hotels).map(([id, data]) => ({
                    id,
                    ...data
                }));
                
                console.log('âœ… Hotels geladen:', hotelList.length);
                
                // ZÃ¤hle Fahrten pro Hotel
                const ridesSnapshot = await db.ref('rides').once('value');
                const rides = ridesSnapshot.val() || {};
                
                const hotelRideCounts = {};
                Object.values(rides).forEach(ride => {
                    if (ride.hotelCalendarId) {
                        hotelRideCounts[ride.hotelCalendarId] = (hotelRideCounts[ride.hotelCalendarId] || 0) + 1;
                    }
                });
                
                // Rendere Liste
                if (hotelList.length === 0) {
                    container.innerHTML = `
                        <div style="padding:40px;text-align:center;">
                            <div style="font-size:48px;margin-bottom:20px;">ğŸ¨</div>
                            <h2 style="color:#6b7280;margin-bottom:10px;">Keine Hotel-Kalender</h2>
                            <p style="color:#9ca3af;margin-bottom:30px;">Es wurden noch keine Hotel-Kalender angelegt.</p>
                            <button onclick="alert('Hotel-Kalender kÃ¶nnen im Admin-Tab angelegt werden.')" style="padding:12px 24px;background:linear-gradient(135deg,#f59e0b,#d97706);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                                â• Neuen Hotel-Kalender anlegen
                            </button>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <div style="padding:20px;">
                        <h2 style="margin:0 0 20px 0;display:flex;align-items:center;gap:10px;">
                            <span>ğŸ¨</span>
                            <span>Hotel-Kalender</span>
                        </h2>
                        
                        <div style="display:grid;gap:15px;">
                `;
                
                hotelList.forEach(hotel => {
                    const rideCount = hotelRideCounts[hotel.id] || 0;
                    const lastSync = hotel.lastSync ? new Date(hotel.lastSync).toLocaleString('de-DE') : 'Nie';
                    const isActive = hotel.active !== false;
                    
                    html += `
                        <div style="background:white;border:2px solid ${isActive ? '#f59e0b' : '#e5e7eb'};border-radius:12px;padding:20px;cursor:pointer;transition:all 0.2s;" 
                             onclick="showHotelCalendar('${hotel.id}')"
                             onmouseover="this.style.borderColor='#f59e0b';this.style.background='#fffbeb';"
                             onmouseout="this.style.borderColor='${isActive ? '#f59e0b' : '#e5e7eb'}';this.style.background='white';">
                            
                            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
                                <div>
                                    <h3 style="margin:0 0 8px 0;font-size:18px;font-weight:700;color:#1f2937;">
                                        ğŸ¨ ${hotel.name || 'Unbenannt'}
                                    </h3>
                                    <div style="font-size:13px;color:#6b7280;">
                                        ${isActive ? 'âœ… Aktiv' : 'â¸ï¸ Pausiert'} â€¢ Letzte Sync: ${lastSync}
                                    </div>
                                </div>
                                <div style="background:#f59e0b;color:white;padding:8px 16px;border-radius:20px;font-weight:700;font-size:14px;">
                                    ${rideCount} Fahrten
                                </div>
                            </div>
                            
                            ${hotel.googleCalendarUrl ? `
                                <div style="font-size:12px;color:#9ca3af;margin-top:8px;padding-top:8px;border-top:1px solid #e5e7eb;">
                                    ğŸ“… Google Calendar verbunden
                                </div>
                            ` : ''}
                            
                            <div style="margin-top:15px;display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                                <button onclick="event.stopPropagation();showHotelCalendar('${hotel.id}')" style="padding:10px;background:linear-gradient(135deg,#f59e0b,#d97706);color:white;border:none;border-radius:6px;font-weight:600;font-size:13px;cursor:pointer;">
                                    ğŸ“… Kalender Ã¶ffnen
                                </button>
                                <button onclick="event.stopPropagation();syncGoogleCalendarEvents('${hotel.id}')" style="padding:10px;background:#3b82f6;color:white;border:none;border-radius:6px;font-weight:600;font-size:13px;cursor:pointer;">
                                    ğŸ”„ Sync
                                </button>
                            </div>
                            <div style="margin-top:8px;">
                                <button onclick="event.stopPropagation();uploadCsvForHotel('${hotel.id}')" style="width:100%;padding:10px;background:white;color:#f59e0b;border:2px solid #f59e0b;border-radius:6px;font-weight:600;font-size:13px;cursor:pointer;">
                                    ğŸ“± CSV importieren
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        
                        <div style="margin-top:30px;padding:20px;background:#f0fdf4;border:2px solid #10b981;border-radius:12px;">
                            <div style="font-weight:700;color:#065f46;margin-bottom:8px;">ğŸ’¡ Tipp:</div>
                            <div style="font-size:13px;color:#065f46;">
                                Klicke auf einen Hotel-Kalender, um alle Fahrten von diesem Hotel anzuzeigen. 
                                Hotel-Fahrten sind durch den LÃ¶schschutz vor automatischer Stornierung geschÃ¼tzt.
                            </div>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der Hotel-Liste:', error);
                container.innerHTML = `
                    <div style="padding:40px;text-align:center;">
                        <div style="font-size:48px;margin-bottom:20px;">ğŸ’¾</div>
                        <h2 style="color:#dc2626;margin-bottom:10px;">Fehler</h2>
                        <p style="color:#6b7280;">${error.message}</p>
                    </div>
                `;
            }
        }
        
        // ğŸ“… ZEIGE EINZELNEN HOTEL-KALENDER
        async function showHotelCalendar(hotelId) {
            console.log('ğŸ“… Ã–ffne Hotel-Kalender:', hotelId);
            
            const container = document.getElementById('hotel-single-calendar-container');
            if (!container) {
                console.error('ğŸ’¾ Hotel-Kalender Container nicht gefunden!');
                return;
            }
            
            // Verstecke Liste, zeige Einzelkalender
            document.getElementById('hotel-list-container').style.display = 'none';
            container.style.display = 'block';
            
            console.log('ğŸ” DEBUG - Container-Visibility Check:');
            console.log('  hotel-list-container display:', document.getElementById('hotel-list-container').style.display);
            console.log('  hotel-single-calendar-container display:', container.style.display);
            console.log('  hotel-calendar-view display:', document.getElementById('hotel-calendar-view').style.display);
            
            try {
                // Lade Hotel-Infos
                const hotelSnapshot = await db.ref('hotelCalendars/' + hotelId).once('value');
                const hotel = hotelSnapshot.val();
                
                if (!hotel) {
                    alert('ğŸ’¾ Hotel nicht gefunden!');
                    backToHotelList();
                    return;
                }
                
                currentHotelCalendarId = hotelId;
                currentHotelCalendarName = hotel.name;
                
                // Lade Fahrten fÃ¼r dieses Hotel
                const ridesSnapshot = await db.ref('rides').once('value');
                const allRides = ridesSnapshot.val() || {};
                
                console.log('ğŸ” DEBUG - Total Rides in DB:', Object.keys(allRides).length);
                console.log('ğŸ” DEBUG - Suche Rides mit hotelCalendarId:', hotelId);
                
                // Count rides by hotelCalendarId
                const ridesByHotel = {};
                Object.entries(allRides).forEach(([id, ride]) => {
                    const hId = ride.hotelCalendarId || 'null';
                    ridesByHotel[hId] = (ridesByHotel[hId] || 0) + 1;
                });
                console.log('ğŸ” DEBUG - Rides grouped by hotel:', ridesByHotel);
                
                const hotelRides = Object.entries(allRides)
                    .filter(([id, ride]) => ride.hotelCalendarId === hotelId)
                    .map(([id, ride]) => ({ firebaseId: id, ...ride }))
                    .sort((a, b) => {
                        const timeA = a.pickupTimestamp || new Date(a.pickupTime).getTime() || 0;
                        const timeB = b.pickupTimestamp || new Date(b.pickupTime).getTime() || 0;
                        return timeA - timeB;
                    });
                
                console.log('âœ… Hotel-Fahrten geladen:', hotelRides.length);
                console.log('ğŸ” DEBUG - Erste 5 Fahrten:', hotelRides.slice(0, 5).map(r => ({
                    name: r.customerName,
                    pickup: r.pickup,
                    time: r.pickupTime,
                    status: r.status,
                    hotelId: r.hotelCalendarId
                })));
                
                // ğŸ†• v5.87.29: VOLLSTÃ„NDIGES DEBUG-LOG
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('ğŸ“± HOTEL-KALENDER DEBUG REPORT');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('Hotel ID:', hotelId);
                console.log('Hotel Name:', hotel.name);
                console.log('Total Rides gefunden:', hotelRides.length);
                console.log('');
                console.log('ğŸ” ALLE RIDES MIT DETAILS:');
                hotelRides.forEach((ride, index) => {
                    console.log(`\n--- Ride ${index + 1} ---`);
                    console.log('Customer:', ride.customerName);
                    console.log('Pickup:', ride.pickup);
                    console.log('pickupTime (raw):', ride.pickupTime);
                    console.log('pickupTimestamp:', ride.pickupTimestamp);
                    
                    // Versuche Date-Konvertierung
                    const pickupTime = ride.pickupTimestamp ? new Date(ride.pickupTimestamp) : 
                                       ride.pickupTime ? new Date(ride.pickupTime) : new Date();
                    console.log('pickupTime (converted):', pickupTime);
                    console.log('pickupTime (ISO):', pickupTime.toISOString());
                    console.log('pickupTime (DE):', pickupTime.toLocaleDateString('de-DE'));
                    console.log('Status:', ride.status);
                    console.log('Price:', ride.price);
                });
                console.log('');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
                // Gruppiere nach Datum
                const ridesByDate = {};
                hotelRides.forEach(ride => {
                    const pickupTime = ride.pickupTimestamp ? new Date(ride.pickupTimestamp) : 
                                       ride.pickupTime ? new Date(ride.pickupTime) : new Date();
                    const dateKey = pickupTime.toLocaleDateString('de-DE');
                    
                    if (!ridesByDate[dateKey]) {
                        ridesByDate[dateKey] = [];
                    }
                    ridesByDate[dateKey].push(ride);
                });
                
                console.log('ğŸ“… GRUPPIERUNG NACH DATUM:');
                console.log('Unique Dates:', Object.keys(ridesByDate).length);
                Object.keys(ridesByDate).forEach(dateKey => {
                    console.log(`  ${dateKey}: ${ridesByDate[dateKey].length} Fahrten`);
                });
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
                // Rendere Kalender
                let html = `
                    <div style="padding:20px;">
                        <!-- Header -->
                        <div style="display:flex;align-items:center;gap:15px;margin-bottom:20px;">
                            <button onclick="backToHotelList()" style="background:white;border:2px solid #e5e7eb;padding:10px 15px;border-radius:8px;cursor:pointer;font-weight:600;color:#6b7280;">
                                â† ZurÃ¼ck
                            </button>
                            <div style="flex:1;">
                                <h2 style="margin:0;font-size:20px;font-weight:700;color:#1f2937;">
                                    ğŸ¨ ${hotel.name}
                                </h2>
                                <div style="font-size:13px;color:#6b7280;margin-top:4px;">
                                    ${hotelRides.length} Fahrten insgesamt
                                </div>
                            </div>
                            <button onclick="createHotelInvoice('${hotelId}')" style="padding:12px 20px;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                                ğŸ“± Rechnung erstellen
                            </button>
                        </div>
                        
                        <!-- Fahrten nach Datum -->
                        <div style="display:grid;gap:20px;">
                `;
                
                const sortedDates = Object.keys(ridesByDate).sort((a, b) => {
                    return new Date(a.split('.').reverse().join('-')) - new Date(b.split('.').reverse().join('-'));
                });
                
                console.log('ğŸ” DEBUG - sortedDates.length:', sortedDates.length);
                console.log('ğŸ” DEBUG - Erste 5 sortierte Dates:', sortedDates.slice(0, 5));
                console.log('ğŸ” DEBUG - Letzte 5 sortierte Dates:', sortedDates.slice(-5));
                
                if (sortedDates.length === 0) {
                    html += `
                        <div style="padding:40px;text-align:center;background:#f9fafb;border-radius:12px;">
                            <div style="font-size:48px;margin-bottom:15px;">ğŸ“…</div>
                            <h3 style="color:#6b7280;margin:0 0 10px 0;">Keine Fahrten</h3>
                            <p style="color:#9ca3af;font-size:14px;">Es gibt noch keine Fahrten fÃ¼r diesen Hotel-Kalender.</p>
                        </div>
                    `;
                } else {
                    console.log('ğŸ” DEBUG - Starte HTML-Rendering fÃ¼r', sortedDates.length, 'Dates');
                    let renderedCount = 0;
                    
                    sortedDates.forEach(dateKey => {
                        renderedCount++;
                        const rides = ridesByDate[dateKey];
                        const totalPrice = rides.reduce((sum, r) => sum + (parseFloat(r.price) || 0), 0);
                        
                        if (renderedCount <= 5 || renderedCount > sortedDates.length - 5) {
                            console.log(`ğŸ” DEBUG - Rendering Date #${renderedCount}: ${dateKey} mit ${rides.length} Fahrten`);
                        }
                        
                        html += `
                            <div style="background:white;border:2px solid #f59e0b;border-radius:12px;overflow:hidden;">
                                <div style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:15px;">
                                    <div style="display:flex;justify-content:space-between;align-items:center;">
                                        <div>
                                            <div style="font-weight:700;font-size:16px;">${dateKey}</div>
                                            <div style="font-size:13px;opacity:0.9;">${rides.length} Fahrt${rides.length !== 1 ? 'en' : ''}</div>
                                        </div>
                                        <div style="text-align:right;">
                                            <div style="font-size:20px;font-weight:700;">${totalPrice.toFixed(2)}â‚¬</div>
                                            <div style="font-size:12px;opacity:0.9;">Gesamt</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="padding:15px;">
                                    <div style="display:grid;gap:10px;">
                        `;
                        
                        rides.forEach(ride => {
                            const pickupTime = ride.pickupTimestamp ? new Date(ride.pickupTimestamp) : 
                                               ride.pickupTime ? new Date(ride.pickupTime) : new Date();
                            const timeStr = pickupTime.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
                            
                            let statusColor = '#6b7280';
                            let statusIcon = 'â³';
                            let statusText = 'Offen';
                            
                            if (ride.status === 'completed') {
                                statusColor = '#10b981';
                                statusIcon = 'âœ…';
                                statusText = 'Abgeschlossen';
                            } else if (ride.status === 'cancelled') {
                                statusColor = '#ef4444';
                                statusIcon = 'ğŸ’¾';
                                statusText = 'Storniert';
                            } else if (ride.status === 'accepted' || ride.status === 'picked_up') {
                                statusColor = '#3b82f6';
                                statusIcon = 'ğŸš—';
                                statusText = 'Unterwegs';
                            }
                            
                            html += `
                                <div style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:12px;">
                                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
                                        <div>
                                            <div style="font-weight:700;font-size:15px;color:#1f2937;">
                                                ${timeStr} Uhr
                                            </div>
                                            <div style="font-size:13px;color:${statusColor};margin-top:4px;">
                                                ${statusIcon} ${statusText}
                                            </div>
                                        </div>
                                        <div style="text-align:right;">
                                            <div style="font-weight:700;font-size:16px;color:#1f2937;">
                                                ${(ride.price || 0).toFixed(2)}â‚¬
                                            </div>
                                            ${ride.passengers ? `<div style="font-size:12px;color:#6b7280;">${ride.passengers} Pers.</div>` : ''}
                                        </div>
                                    </div>
                                    
                                    <div style="font-size:13px;color:#6b7280;margin-top:8px;">
                                        ğŸ“ ${ride.pickup || '?'} â†’ ${ride.destination || '?'}
                                    </div>
                                    
                                    ${ride.guestName ? `
                                        <div style="font-size:12px;color:#6b7280;margin-top:4px;">
                                            ğŸ§³ ${ride.guestName}
                                        </div>
                                    ` : ''}
                                    
                                    ${ride.vehicle ? `
                                        <div style="font-size:12px;color:#6b7280;margin-top:4px;">
                                            ğŸš— ${ride.vehicle}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                        
                        html += `
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    console.log(`ğŸ” DEBUG - HTML-Rendering abgeschlossen: ${renderedCount} Dates gerendert`);
                }
                
                html += `
                        </div>
                    </div>
                `;
                
                console.log('ğŸ” DEBUG - Finaler HTML-String LÃ¤nge:', html.length, 'Zeichen');
                console.log('ğŸ” DEBUG - Setze container.innerHTML...');
                
                container.innerHTML = html;
                
                console.log('âœ… HTML ins DOM eingefÃ¼gt!');
                
                // ğŸ” v5.87.33: DOM-Check - wie viele Elemente sind wirklich da?
                setTimeout(() => {
                    const dateBlocks = container.querySelectorAll('div[style*="border:2px solid #f59e0b"]');
                    console.log('ğŸ” DEBUG - DOM-Check: Gefundene Datum-BlÃ¶cke im DOM:', dateBlocks.length);
                    console.log('ğŸ” DEBUG - Container HÃ¶he:', container.offsetHeight, 'px');
                    console.log('ğŸ” DEBUG - Container scrollHeight:', container.scrollHeight, 'px');
                    console.log('ğŸ” DEBUG - Container overflow:', window.getComputedStyle(container).overflow);
                    console.log('ğŸ” DEBUG - Container display:', window.getComputedStyle(container).display);
                    
                    // ğŸ†• v5.87.34: Check Parent-Container
                    let parent = container.parentElement;
                    let level = 1;
                    console.log('ğŸ” DEBUG - Parent-Container-Hierarchie:');
                    while (parent && level <= 5) {
                        const styles = window.getComputedStyle(parent);
                        console.log(`  Level ${level}: id="${parent.id}" class="${parent.className}"`);
                        console.log(`    â†’ overflow: ${styles.overflow}, overflow-y: ${styles.overflowY}`);
                        console.log(`    â†’ max-height: ${styles.maxHeight}, height: ${styles.height}`);
                        console.log(`    â†’ display: ${styles.display}, position: ${styles.position}`);
                        parent = parent.parentElement;
                        level++;
                    }
                    
                    if (dateBlocks.length !== sortedDates.length) {
                        console.error('ğŸ’¾ PROBLEM: Sollte', sortedDates.length, 'Datum-BlÃ¶cke haben, aber nur', dateBlocks.length, 'im DOM gefunden!');
                    }
                    
                    // Erste 3 BlÃ¶cke prÃ¼fen
                    dateBlocks.forEach((block, i) => {
                        if (i < 3) {
                            const display = window.getComputedStyle(block).display;
                            const visibility = window.getComputedStyle(block).visibility;
                            const height = block.offsetHeight;
                            console.log(`ğŸ” Block #${i+1}: display=${display}, visibility=${visibility}, height=${height}px`);
                        }
                    });
                }, 100);
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden des Hotel-Kalenders:', error);
                container.innerHTML = `
                    <div style="padding:40px;text-align:center;">
                        <div style="font-size:48px;margin-bottom:20px;">ğŸ’¾</div>
                        <h2 style="color:#dc2626;margin-bottom:10px;">Fehler</h2>
                        <p style="color:#6b7280;">${error.message}</p>
                        <button onclick="backToHotelList()" style="margin-top:20px;padding:12px 24px;background:#f3f4f6;border:none;border-radius:8px;cursor:pointer;font-weight:600;">
                            â† ZurÃ¼ck zur Liste
                        </button>
                    </div>
                `;
            }
        }
        
        // â† ZURÃœCK ZUR HOTEL-LISTE
        function backToHotelList() {
            console.log('â† ZurÃ¼ck zur Hotel-Liste');
            currentHotelCalendarId = null;
            currentHotelCalendarName = null;
            loadHotelCalendarList();
        }
        
        // ğŸ“± RECHNUNG FÃœR HOTEL ERSTELLEN
        // ğŸ†• v5.87.46: Direct-Zugriff auf Rechnung im Hotel-Kalender Tab
        async function createHotelInvoice(hotelId) {
            // Hole Hotel-Daten
            const hotelSnap = await db.ref(`hotelCalendars/${hotelId}`).once('value');
            const hotel = hotelSnap.val();
            
            if (!hotel) {
                alert('ğŸ’¾ Hotel nicht gefunden!');
                return;
            }
            
            const confirmed = confirm(
                `ğŸ“± Rechnung erstellen\n\n` +
                `Hotel: ${hotel.name}\n\n` +
                `Ich scrolle zur Rechnung-Section und wÃ¤hle das Hotel aus.\n\n` +
                `Fortfahren?`
            );
            
            if (!confirmed) return;
            
            // WÃ¤hle Hotel in Dropdown
            const hotelSelect = document.getElementById('invoice-hotel-select');
            if (hotelSelect) {
                hotelSelect.value = hotelId;
            }
            
            // Setze aktuellen Monat (falls noch nicht gesetzt)
            const monthInput = document.getElementById('invoice-month-select');
            if (monthInput && !monthInput.value) {
                const now = new Date();
                monthInput.value = now.toISOString().slice(0, 7);
            }
            
            // Scrolle zur Rechnung-Section
            setTimeout(() => {
                const invoiceSection = document.getElementById('invoice-rides-container');
                if (invoiceSection) {
                    invoiceSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Lade Fahrten automatisch
                    setTimeout(() => {
                        loadInvoiceRides();
                    }, 300);
                }
            }, 100);
        }
        
    </script>

    
    <!-- ğŸ†• v5.87.31: GLOBAL LOG-EXPORT BUTTON (immer sichtbar!) -->
    <button id="global-log-export-btn" onclick="exportStoredLogs()" style="
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 999999;
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        color: white;
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    " 
    onmouseover="this.style.transform='scale(1.1)';this.style.boxShadow='0 6px 20px rgba(139,92,246,0.6)'" 
    onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 4px 12px rgba(139,92,246,0.4)'"
    title="ğŸ“¥ Logs exportieren (Strg+Shift+L)">
        ğŸ“¥
    </button>
    
    <script>
        // ğŸ†• v5.87.31: Keyboard-Shortcut Strg+Shift+L
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'L') {
                e.preventDefault();
                exportStoredLogs();
            }
        });
        
        // ğŸ†• v5.87.31: Verstecke Button wenn im Debug-Tab
        function updateGlobalLogButton() {
            const btn = document.getElementById('global-log-export-btn');
            const debugView = document.getElementById('debug-view');
            if (btn && debugView) {
                // Verstecke wenn Debug-Tab offen (hat eigenen Button)
                btn.style.display = (debugView.style.display === 'none' || !debugView.style.display) ? 'flex' : 'none';
            }
        }
        
        // Update bei View-Wechsel
        const originalSwitchView = window.switchView;
        window.switchView = function(view) {
            originalSwitchView(view);
            updateGlobalLogButton();
        };
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ¯ v5.90.6: DRAG & DROP FÃœR TABS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let draggedTab = null;
        
        function initTabDragDrop() {
            console.log('ğŸ¯ Initialisiere Tab Drag & Drop...');
            
            const tabButtons = document.querySelectorAll('.admin-tab-btn[data-view]');
            
            tabButtons.forEach(tab => {
                tab.setAttribute('draggable', 'true');
                tab.style.cursor = 'grab';
                
                tab.addEventListener('dragstart', handleDragStart);
                tab.addEventListener('dragend', handleDragEnd);
                tab.addEventListener('dragover', handleDragOver);
                tab.addEventListener('drop', handleDrop);
                tab.addEventListener('dragenter', handleDragEnter);
                tab.addEventListener('dragleave', handleDragLeave);
            });
            
            loadTabOrder();
            console.log('âœ… Tab Drag & Drop aktiv!');
        }
        
        function handleDragStart(e) {
            draggedTab = this;
            this.style.opacity = '0.4';
            this.style.cursor = 'grabbing';
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            this.classList.add('dragging');
            console.log('ğŸ¯ Drag Start:', this.dataset.view);
        }
        
        function handleDragEnd(e) {
            this.style.opacity = '1';
            this.style.cursor = 'grab';
            this.classList.remove('dragging');
            document.querySelectorAll('.admin-tab-btn').forEach(tab => {
                tab.classList.remove('drag-over');
            });
            console.log('âœ… Drag End');
        }
        
        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        function handleDragEnter(e) {
            if (this !== draggedTab) {
                this.classList.add('drag-over');
            }
        }
        
        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }
        
        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            
            if (draggedTab !== this) {
                const container = this.parentNode;
                const allTabs = [...container.querySelectorAll('.admin-tab-btn[data-view]')];
                const draggedIndex = allTabs.indexOf(draggedTab);
                const targetIndex = allTabs.indexOf(this);
                
                if (draggedIndex < targetIndex) {
                    container.insertBefore(draggedTab, this.nextSibling);
                } else {
                    container.insertBefore(draggedTab, this);
                }
                
                saveTabOrder();
                console.log('ğŸ¯ Tab verschoben!');
                showToast('Tab-Reihenfolge gespeichert!', 'success');
            }
            
            return false;
        }
        
        function saveTabOrder() {
            const container = document.querySelector('.admin-tab-btn').parentNode;
            const tabs = [...container.querySelectorAll('.admin-tab-btn[data-view]')];
            const order = tabs.map(tab => tab.dataset.view);
            localStorage.setItem('tabOrder', JSON.stringify(order));
            console.log('ğŸ’¾ Tab-Reihenfolge gespeichert:', order);
        }
        
        let tabOrderLoaded = false; // ğŸ†• v5.90.26: Verhindere doppeltes Laden
        
        function loadTabOrder() {
            if (tabOrderLoaded) {
                console.log('â„¹ï¸ Tab-Reihenfolge bereits geladen - Ã¼berspringe');
                return;
            }
            
            const savedOrder = localStorage.getItem('tabOrder');
            if (!savedOrder) {
                console.log('â„¹ï¸ Keine gespeicherte Tab-Reihenfolge');
                return;
            }
            
            try {
                const order = JSON.parse(savedOrder);
                console.log('ğŸ“‚ Lade Tab-Reihenfolge:', order);
                
                const container = document.querySelector('.admin-tab-btn')?.parentNode;
                if (!container) {
                    console.log('âš ï¸ Tab-Container noch nicht bereit');
                    return;
                }
                
                const tabs = {};
                
                container.querySelectorAll('.admin-tab-btn[data-view]').forEach(tab => {
                    tabs[tab.dataset.view] = tab;
                });
                
                order.forEach(viewName => {
                    if (tabs[viewName]) {
                        container.appendChild(tabs[viewName]);
                    }
                });
                
                Object.keys(tabs).forEach(viewName => {
                    if (!order.includes(viewName)) {
                        container.appendChild(tabs[viewName]);
                    }
                });
                
                tabOrderLoaded = true; // ğŸ†• v5.90.26: Markiere als geladen
                console.log('âœ… Tab-Reihenfolge wiederhergestellt!');
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden der Tab-Reihenfolge:', error);
            }
        }
        
        function resetTabOrder() {
            if (confirm('Tab-Reihenfolge auf Standard zurÃ¼cksetzen?')) {
                localStorage.removeItem('tabOrder');
                location.reload();
                console.log('ğŸ”„ Tab-Reihenfolge zurÃ¼ckgesetzt!');
            }
        }
        
        // ğŸ†• v5.90.29: TAB-EINSTELLUNGEN - EINFACH UND KLAR!
        const ALL_TABS = [
            { id: 'express-booking', name: 'âš¡ Express-Booking', admin: true },
            { id: 'simulator', name: 'ğŸ® Simulator', admin: true },
            { id: 'passenger', name: 'ğŸš• Taxi buchen', admin: false },
            { id: 'schedule', name: 'ğŸ“… Termine', admin: false },
            { id: 'history', name: 'ğŸ“œ Verlauf', admin: false },
            { id: 'calendar', name: 'ğŸ“† Kalender', admin: true },
            { id: 'rechnung', name: 'ğŸ§¾ Rechnung', admin: true },
            { id: 'hotel-calendar', name: 'ğŸ¨ Hotel-Kalender', admin: true },
            { id: 'quick-booking', name: 'âš¡ Schnellbuchung', admin: true },
            { id: 'driver', name: 'ğŸš— Fahrer', admin: false },
            { id: 'crm', name: 'ğŸ‘¥ CRM', admin: true },
            { id: 'email-inbox', name: 'ğŸ“§ E-Mail', admin: true },
            { id: 'admin', name: 'âš™ï¸ Admin', admin: true },
            { id: 'fleet-overview', name: 'ğŸš— Fahrzeug-Ãœbersicht', admin: true },
            { id: 'shift-plan', name: 'ğŸ“‹ Schichtplan', admin: true },
            { id: 'system-diagnostics', name: 'ğŸ” System-Diagnose', admin: true },
            { id: 'live-monitor', name: 'ğŸ“Š Live-Monitor', admin: true },
            { id: 'debug', name: 'ğŸ› Debug', admin: true },
            { id: 'ai-assistant', name: 'ğŸ¤– AI-Assistent', admin: true },
            { id: 'booking-requests', name: 'ğŸ“¬ Anfragen', admin: true },
            { id: 'poi-management', name: 'ğŸ“ POI-Verwaltung', admin: true },
            { id: 'backup', name: 'ğŸ’¾ Backup', admin: true },
            { id: 'archive', name: 'ğŸ—„ï¸ Archiv', admin: true }
        ];
        
        // Initialisiere Tab-Einstellungen Panel
        async function initTabSettingsPanel() {
            const checkboxes = document.getElementById('tab-checkboxes');
            const select = document.getElementById('default-tab-select');
            
            if (!checkboxes || !select) return;
            
            // ğŸ†• v5.90.39: LADE VON FIREBASE!
            let saved = {};
            
            // Check ob Firebase und User bereit sind
            const user = firebase.auth().currentUser;
            
            if (user && db) {
                try {
                    const snapshot = await db.ref(`users/${user.uid}/tabSettings`).once('value');
                    if (snapshot.exists()) {
                        saved = snapshot.val();
                        console.log('âœ… Tab-Einstellungen fÃ¼r Panel von Firebase geladen:', saved);
                    } else {
                        console.log('â„¹ï¸ Keine Tab-Einstellungen in Firebase - nutze Defaults');
                    }
                } catch (error) {
                    console.error('ğŸ’¾ Fehler beim Laden:', error);
                }
            }
            
            // Fallback zu localStorage
            if (!saved.visible) {
                const localSaved = JSON.parse(localStorage.getItem('tabSettings') || '{}');
                saved = localSaved;
            }
            
            // Wenn immer noch nichts â†’ ALLE Tabs als Default
            const visible = saved.visible || ALL_TABS.map(t => t.id);
            const defaultTab = saved.default || 'passenger';
            
            // Checkboxen erstellen
            checkboxes.innerHTML = ALL_TABS.map(tab => `
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:white;border-radius:6px;border:1px solid #e5e7eb;">
                    <input type="checkbox" 
                           value="${tab.id}" 
                           ${visible.includes(tab.id) ? 'checked' : ''}
                           style="cursor:pointer;width:18px;height:18px;">
                    <span style="font-size:13px;">${tab.name}</span>
                </label>
            `).join('');
            
            // Dropdown fÃ¼llen
            select.innerHTML = ALL_TABS.map(tab => 
                `<option value="${tab.id}" ${tab.id === defaultTab ? 'selected' : ''}>${tab.name}</option>`
            ).join('');
            
            console.log('âœ… Tab-Einstellungen Panel initialisiert:', { visible, defaultTab });
        }
        
        // Speichere Tab-Einstellungen
        async function saveTabSettings() {
            const checkboxes = document.querySelectorAll('#tab-checkboxes input[type="checkbox"]');
            const defaultTab = document.getElementById('default-tab-select').value;
            
            const visible = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            if (visible.length === 0) {
                alert('âš ï¸ Du musst mindestens einen Tab auswÃ¤hlen!');
                return;
            }
            
            const settings = {
                visible: visible,
                default: defaultTab
            };
            
            // Speichere lokal
            localStorage.setItem('tabSettings', JSON.stringify(settings));
            
            // Speichere in Firebase (fÃ¼r alle GerÃ¤te)
            if (currentUser && db) {
                try {
                    await db.ref(`users/${currentUser.uid}/tabSettings`).set(settings);
                    console.log('âœ… Tab-Einstellungen in Firebase gespeichert');
                } catch (error) {
                    console.error('ğŸ’¾ Firebase Fehler:', error);
                }
            }
            
            alert('âœ… Tab-Einstellungen gespeichert!\n\nSeite wird neu geladen...');
            location.reload();
        }
        
        // Lade Tab-Einstellungen beim Start
        async function loadUserTabSettings() {
            let settings = null;
            
            // Versuche von Firebase zu laden
            if (currentUser && db) {
                try {
                    const snapshot = await db.ref(`users/${currentUser.uid}/tabSettings`).once('value');
                    if (snapshot.exists()) {
                        settings = snapshot.val();
                        localStorage.setItem('tabSettings', JSON.stringify(settings));
                        console.log('âœ… Tab-Einstellungen von Firebase geladen');
                    }
                } catch (error) {
                    console.log('â„¹ï¸ Keine Firebase Tab-Einstellungen');
                }
            }
            
            // Fallback: Von localStorage
            if (!settings) {
                settings = JSON.parse(localStorage.getItem('tabSettings') || 'null');
            }
            
            if (!settings) {
                console.log('â„¹ï¸ Keine Tab-Einstellungen - wende Admin-Regeln an');
                // ğŸ”§ v5.90.99: Auch ohne Settings â†’ Admin-Only Tabs verstecken!
                ALL_TABS.forEach(tab => {
                    const btn = document.querySelector(`.tab-toggleable[data-tab-id="${tab.id}"]`);
                    if (btn && tab.admin && userRole !== 'admin') {
                        btn.style.display = 'none';
                        console.log(`ğŸ”’ v5.90.99: Tab "${tab.name}" nur fÃ¼r Admin - versteckt fÃ¼r ${userRole || 'Gast'}`);
                    }
                });
                return;
            }
            
            // ğŸ”§ v5.90.99: ERZWINGE Admin-Only Tabs basierend auf userRole!
            ALL_TABS.forEach(tab => {
                const btn = document.querySelector(`.tab-toggleable[data-tab-id="${tab.id}"]`);
                if (btn) {
                    // Admin-Only Tab UND User ist NICHT Admin â†’ VERSTECKEN!
                    if (tab.admin && userRole !== 'admin') {
                        btn.style.display = 'none';
                        console.log(`ğŸ”’ v5.90.99: Tab "${tab.name}" nur fÃ¼r Admin - versteckt fÃ¼r ${userRole || 'Gast'}`);
                    } else if (settings.visible.includes(tab.id)) {
                        btn.style.display = '';
                    } else {
                        btn.style.display = 'none';
                    }
                }
            });
            
            // ğŸ†• v5.90.596: Aktiviere Standard-Tab (immer!)
            if (settings.default) {
                console.log(`ğŸ“‘ Wechsle zu Start-Tab: ${settings.default}`);
                setTimeout(() => switchView(settings.default), 500);
            }
            
            console.log('âœ… Tab-Einstellungen angewendet:', settings);
        }
        
        // ğŸ†• v5.90.40: ARCHIV-SYSTEM
        let allArchivedRides = [];
        let filteredArchivedRides = [];
        
        async function loadArchive() {
            console.log('ğŸ—„ï¸ Lade Archiv...');
            
            if (!isFirebaseReady) {
                alert('â³ Firebase nicht bereit!');
                return;
            }
            
            const timeFilter = document.getElementById('archive-time-filter').value;
            const now = Date.now();
            let startTime = 0;
            
            if (timeFilter === 'today') {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                startTime = today.getTime();
            } else if (timeFilter === 'week') {
                startTime = now - (7 * 24 * 60 * 60 * 1000);
            } else if (timeFilter === 'month') {
                startTime = now - (30 * 24 * 60 * 60 * 1000);
            }
            
            try {
                const snapshot = await db.ref('rides')
                    .orderByChild('status')
                    .equalTo('cancelled')
                    .once('value');
                
                allArchivedRides = [];
                
                snapshot.forEach(child => {
                    const ride = child.val();
                    const cancelledAt = ride.cancelledAt || ride.timestamp || 0;
                    
                    if (cancelledAt >= startTime) {
                        allArchivedRides.push({
                            id: child.key,
                            ...ride
                        });
                    }
                });
                
                // Sortiere nach LÃ¶sch-Datum (neueste zuerst)
                allArchivedRides.sort((a, b) => (b.cancelledAt || 0) - (a.cancelledAt || 0));
                
                console.log(`âœ… ${allArchivedRides.length} archivierte Fahrten geladen`);
                
                filterArchive();
                updateArchiveStats();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden:', error);
                document.getElementById('archive-list').innerHTML = `
                    <div style="text-align:center;padding:40px;color:#ef4444;">
                        ğŸ’¾ Fehler beim Laden: ${error.message}
                    </div>
                `;
            }
        }
        
        function filterArchive() {
            const reasonFilter = document.getElementById('archive-reason-filter').value;
            const searchTerm = document.getElementById('archive-search').value.toLowerCase();
            
            filteredArchivedRides = allArchivedRides.filter(ride => {
                // Grund-Filter
                if (reasonFilter !== 'all') {
                    const reason = ride.cancelledReason || '';
                    if (reasonFilter === 'auto24h' && !reason.includes('24h')) return false;
                    if (reasonFilter === 'autotime' && !reason.includes('Abholzeit') && !reason.includes('verpasst')) return false;
                    if (reasonFilter === 'manual' && reason.includes('Auto-Storno')) return false;
                    if (reasonFilter === 'other' && (reason.includes('Auto-Storno') || !reason)) return false;
                }
                
                // Such-Filter
                if (searchTerm) {
                    const searchable = `${ride.customerName || ''} ${ride.customerPhone || ''} ${ride.pickup || ''} ${ride.destination || ''}`.toLowerCase();
                    if (!searchable.includes(searchTerm)) return false;
                }
                
                return true;
            });
            
            displayArchive();
        }
        
        function displayArchive() {
            const container = document.getElementById('archive-list');
            
            if (filteredArchivedRides.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;padding:40px;color:#6b7280;">
                        ğŸ“­ Keine archivierten Fahrten gefunden
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredArchivedRides.map(ride => {
                const cancelledDate = ride.cancelledAt ? new Date(ride.cancelledAt) : null;
                const createdDate = ride.createdAt ? new Date(ride.createdAt) : null;
                const reason = ride.cancelledReason || 'Unbekannt';
                const isAuto = reason.includes('Auto-Storno');
                
                return `
                    <div style="background:white;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);border-left:4px solid ${isAuto ? '#dc2626' : '#f59e0b'};">
                        <!-- Header -->
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:15px;">
                            <div>
                                <div style="font-size:16px;font-weight:700;color:#1f2937;margin-bottom:4px;">
                                    ${isAuto ? 'ğŸ¤–' : 'ğŸ’¾'} ${reason}
                                </div>
                                <div style="font-size:13px;color:#6b7280;">
                                    â° GelÃ¶scht: ${cancelledDate ? cancelledDate.toLocaleString('de-DE') : 'Unbekannt'}
                                </div>
                            </div>
                            <div style="background:${isAuto ? '#fee2e2' : '#fef3c7'};color:${isAuto ? '#991b1b' : '#92400e'};padding:6px 12px;border-radius:6px;font-size:12px;font-weight:600;">
                                ${isAuto ? 'AUTO' : 'MANUELL'}
                            </div>
                        </div>
                        
                        <!-- Details -->
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:15px;">
                            <div>
                                <div style="font-size:11px;color:#6b7280;margin-bottom:4px;">KUNDE</div>
                                <div style="font-weight:600;color:#1f2937;">${ride.customerName || 'Unbekannt'}</div>
                                ${ride.customerPhone ? `<div style="font-size:12px;color:#6b7280;">${ride.customerPhone}</div>` : ''}
                            </div>
                            
                            <div>
                                <div style="font-size:11px;color:#6b7280;margin-bottom:4px;">ROUTE</div>
                                <div style="font-size:13px;color:#1f2937;">
                                    ğŸ“ ${ride.pickup || 'Start'}<br>
                                    ğŸ¯ ${ride.destination || 'Ziel'}
                                </div>
                            </div>
                            
                            <div>
                                <div style="font-size:11px;color:#6b7280;margin-bottom:4px;">PREIS</div>
                                <div style="font-weight:600;color:#1f2937;">
                                    ${ride.price ? ride.price + 'â‚¬' : 'ğŸ’¾ Nicht berechnet'}
                                </div>
                                ${ride.distance ? `<div style="font-size:12px;color:#6b7280;">${ride.distance} km</div>` : ''}
                            </div>
                            
                            <div>
                                <div style="font-size:11px;color:#6b7280;margin-bottom:4px;">ERSTELLT</div>
                                <div style="font-size:13px;color:#1f2937;">
                                    ${createdDate ? createdDate.toLocaleString('de-DE') : 'Unbekannt'}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Actions -->
                        <div style="display:flex;gap:10px;padding-top:15px;border-top:1px solid #e5e7eb;">
                            <button onclick="restoreRide('${ride.id}')" style="flex:1;padding:10px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                                ğŸ”„ Wiederherstellen
                            </button>
                            <button onclick="showRideDetails('${ride.id}')" style="flex:1;padding:10px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                                ğŸ“± Details
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateArchiveStats() {
            const stats = {
                total: allArchivedRides.length,
                auto24h: allArchivedRides.filter(r => r.cancelledReason?.includes('24h')).length,
                autoTime: allArchivedRides.filter(r => r.cancelledReason?.includes('Abholzeit')).length,
                manual: allArchivedRides.filter(r => !r.cancelledReason?.includes('Auto-Storno')).length,
                noPrice: allArchivedRides.filter(r => !r.price).length
            };
            
            document.getElementById('archive-stats').innerHTML = `
                <div style="background:white;padding:15px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                    <div style="font-size:28px;font-weight:700;color:#1f2937;">${stats.total}</div>
                    <div style="font-size:13px;color:#6b7280;margin-top:4px;">Gesamt storniert</div>
                </div>
                
                <div style="background:white;padding:15px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                    <div style="font-size:28px;font-weight:700;color:#dc2626;">${stats.auto24h}</div>
                    <div style="font-size:13px;color:#6b7280;margin-top:4px;">Auto: >24h alt</div>
                </div>
                
                <div style="background:white;padding:15px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                    <div style="font-size:28px;font-weight:700;color:#ea580c;">${stats.autoTime}</div>
                    <div style="font-size:13px;color:#6b7280;margin-top:4px;">Auto: Zeit verpasst</div>
                </div>
                
                <div style="background:white;padding:15px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                    <div style="font-size:28px;font-weight:700;color:#f59e0b;">${stats.manual}</div>
                    <div style="font-size:13px;color:#6b7280;margin-top:4px;">Manuell storniert</div>
                </div>
                
                <div style="background:white;padding:15px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                    <div style="font-size:28px;font-weight:700;color:#8b5cf6;">${stats.noPrice}</div>
                    <div style="font-size:13px;color:#6b7280;margin-top:4px;">Ohne Preis</div>
                </div>
            `;
        }
        
        async function restoreRide(rideId) {
            if (!confirm('âš ï¸ Fahrt wiederherstellen?\n\nDie Fahrt wird auf Status "new" gesetzt und erscheint wieder in der Liste.')) {
                return;
            }
            
            try {
                await db.ref(`rides/${rideId}`).update({
                    status: 'new',
                    cancelledReason: null,
                    cancelledAt: null,
                    autoCleanup: null,
                    restoredAt: Date.now(),
                    restoredBy: currentUser ? currentUser.email : 'unknown'
                });
                
                alert('âœ… Fahrt wiederhergestellt!\n\nDie Fahrt ist jetzt wieder aktiv.');
                
                // Neu laden
                loadArchive();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler:', error);
                alert('ğŸ’¾ Fehler beim Wiederherstellen: ' + error.message);
            }
        }
        
        // ğŸ†• v5.90.108: FAHRZEUG-ZUTEILUNGS-MODUS FUNKTIONEN!
        
        // Global variable fÃ¼r aktuellen Modus
        let assignmentMode = 'manual'; // 'manual' oder 'automatic'
        
        // Lade Modus aus Firebase
        async function loadAssignmentMode() {
            try {
                const snapshot = await db.ref('settings/assignmentMode').once('value');
                if (snapshot.exists()) {
                    assignmentMode = snapshot.val();
                    console.log('âœ… Assignment Mode geladen:', assignmentMode);
                } else {
                    // Standard: Manual
                    assignmentMode = 'manual';
                    console.log('â„¹ï¸ Assignment Mode: Standard (manual)');
                }
                
                // Update UI
                updateAssignmentModeUI();
                
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Laden des Assignment Mode:', error);
                assignmentMode = 'manual';
                updateAssignmentModeUI();
            }
        }
        
        // Speichere Modus in Firebase
        async function saveAssignmentMode(mode) {
            try {
                await db.ref('settings/assignmentMode').set(mode);
                console.log('âœ… Assignment Mode gespeichert:', mode);
                return true;
            } catch (error) {
                console.error('ğŸ’¾ Fehler beim Speichern:', error);
                return false;
            }
        }
        
        // Toggle Modus
        async function toggleAssignmentMode() {
            const toggle = document.getElementById('assignment-mode-toggle');
            const newMode = toggle.checked ? 'automatic' : 'manual';
            
            console.log('ğŸ”„ Wechsle Modus:', assignmentMode, 'â†’', newMode);
            
            // BestÃ¤tigungs-Dialog
            const confirmMsg = newMode === 'automatic' 
                ? 'ğŸ¤– Automatischer Modus aktivieren?\n\nDas System wird neue Fahrten automatisch dem nÃ¤chsten verfÃ¼gbaren Fahrzeug zuteilen.\n\nFortfahren?' 
                : 'ğŸ”§ Manueller Modus aktivieren?\n\nDu musst jede Fahrt selbst einem Fahrzeug zuteilen.\n\nFortfahren?';
            
            if (!confirm(confirmMsg)) {
                // Abbrechen â†’ Toggle zurÃ¼cksetzen
                toggle.checked = (assignmentMode === 'automatic');
                return;
            }
            
            // Speichere in Firebase
            const success = await saveAssignmentMode(newMode);
            
            if (success) {
                assignmentMode = newMode;
                updateAssignmentModeUI();
                
                // Success Message
                const successMsg = newMode === 'automatic' 
                    ? 'âœ… Automatischer Modus aktiviert!\n\nNeue Fahrten werden automatisch zugeteilt.' 
                    : 'âœ… Manueller Modus aktiviert!\n\nDu kannst jetzt Fahrten manuell zuteilen.';
                
                alert(successMsg);
                
                // ğŸ”” Wenn automatic â†’ starte Auto-Assignment
                if (newMode === 'automatic') {
                    startAutoAssignment();
                }
            } else {
                // Fehler â†’ Toggle zurÃ¼cksetzen
                toggle.checked = (assignmentMode === 'automatic');
                alert('ğŸ’¾ Fehler beim Speichern!\n\nBitte versuche es erneut.');
            }
        }
        
        // Update UI basierend auf Modus
        function updateAssignmentModeUI() {
            const banner = document.getElementById('assignment-mode-banner');
            const icon = document.getElementById('mode-icon');
            const title = document.getElementById('mode-title');
            const description = document.getElementById('mode-description');
            const infoBox = document.getElementById('mode-info-box');
            const toggle = document.getElementById('assignment-mode-toggle');
            const slider = document.getElementById('mode-slider');
            
            if (!banner) return; // Noch nicht geladen
            
            if (assignmentMode === 'automatic') {
                // AUTOMATISCHER MODUS
                banner.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                banner.style.borderColor = '#10b981';
                icon.textContent = 'ğŸ¤–';
                title.textContent = 'AUTOMATISCHER MODUS';
                description.textContent = 'System teilt Fahrten automatisch den Fahrzeugen zu';
                infoBox.innerHTML = 'âœ… Neue Fahrten werden automatisch dem nÃ¤chsten verfÃ¼gbaren Fahrzeug zugeteilt.';
                toggle.checked = true;
                
                // Slider Animation
                if (slider) {
                    slider.style.transform = 'translateX(40px)';
                }
                
            } else {
                // MANUELLER MODUS
                banner.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                banner.style.borderColor = '#f59e0b';
                icon.textContent = 'ğŸ”§';
                title.textContent = 'MANUELLER MODUS';
                description.textContent = 'Du teilst Fahrten manuell den Fahrzeugen zu';
                infoBox.innerHTML = 'â„¹ï¸ Im manuellen Modus musst du jede Fahrt selbst einem Fahrzeug zuteilen.';
                toggle.checked = false;
                
                // Slider Animation
                if (slider) {
                    slider.style.transform = 'translateX(0)';
                }
            }
            
            console.log('âœ… UI aktualisiert:', assignmentMode);
        }
        
        // ğŸ¤– Auto-Assignment Funktion (fÃ¼r spÃ¤ter)
        // ğŸ”§ v5.90.337: GELÃ–SCHT - Doppelte leere Funktion entfernt!
        // startAutoAssignment ist bereits in Zeile 21759 definiert!
        
        // ğŸ†• v5.90.544: WARTE AUF FIREBASE!
        async function waitForFirebase() {
            let attempts = 0;
            while (!isFirebaseReady && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            if (!isFirebaseReady) {
                console.error('ğŸ’¾ Firebase konnte nicht initialisiert werden nach 5s!');
                return false;
            }
            return true;
        }
        
        window.addEventListener('load', () => {
            setTimeout(async () => {
                // âœ… WARTE auf Firebase!
                if (await waitForFirebase()) {
                    initTabDragDrop();
                    initTabSettingsPanel();
                }
            }, 1000);
            
            // ğŸ†• v5.90.29: Tab-Einstellungen laden
            setTimeout(async () => {
                if (await waitForFirebase()) {
                    loadUserTabSettings();
                }
            }, 1500);
            
            // ğŸ†• v5.90.108: Assignment Mode laden
            setTimeout(async () => {
                if (await waitForFirebase()) {
                    loadAssignmentMode();
                }
            }, 2000);
        });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// v5.90.525: STATUS Ã„NDERN FÃœR ABGESCHLOSSENE FAHRTEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function changeRideStatus(rideId, currentStatus) {
    try {
        console.log('âš™ï¸ Ã„ndere Status fÃ¼r Fahrt:', rideId, '| Aktuell:', currentStatus);
        
        const snapshot = await db.ref(`rides/${rideId}`).once('value');
        const ride = snapshot.val();
        
        if (!ride) {
            alert('ğŸ’¾ Fahrt nicht gefunden!');
            return;
        }
        
        const statusOptions = [
            { value: 'new', label: 'ğŸ†• Neu', color: '#3b82f6' },
            { value: 'vorbestellt', label: 'ğŸ“… Vorbestellt', color: '#f59e0b' },
            { value: 'assigned', label: 'ğŸ“‹ Zugewiesen', color: '#f59e0b' },
            { value: 'accepted', label: 'âœ… Angenommen', color: '#10b981' },
            { value: 'on_way', label: 'ğŸš— Fahre zum Kunden', color: '#8b5cf6' },
            { value: 'picked_up', label: 'ğŸš• Fahre zum Ziel', color: '#8b5cf6' },
            { value: 'completed', label: 'âœ… Abgeschlossen', color: '#10b981' },
            { value: 'cancelled', label: 'ğŸ—‘ï¸ Storniert', color: '#ef4444' }
        ];
        
        const modal = document.createElement('div');
        modal.id = 'status-change-modal';
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:100000;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;';
        
        modal.innerHTML = `
            <div style="background:white;border-radius:16px;max-width:400px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.4);">
                <div style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:20px;border-radius:16px 16px 0 0;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="font-size:28px;margin-bottom:5px;">âš™ï¸</div>
                            <h3 style="margin:0;font-size:18px;">Status Ã¤ndern</h3>
                        </div>
                        <button onclick="this.closest('#status-change-modal').remove()" style="background:rgba(255,255,255,0.2);border:none;color:white;font-size:24px;width:32px;height:32px;border-radius:50%;cursor:pointer;">Ã—</button>
                    </div>
                </div>
                
                <div style="padding:20px;">
                    <div style="background:#fef3c7;border:2px solid #f59e0b;padding:15px;border-radius:10px;margin-bottom:20px;">
                        <div style="font-size:13px;color:#92400e;line-height:1.6;">
                            <strong>Fahrt:</strong> ${ride.customerName || 'Unbekannt'}<br>
                            <strong>Von:</strong> ${ride.pickup || 'N/A'}<br>
                            <strong>Nach:</strong> ${ride.destination || 'N/A'}
                        </div>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <div style="font-weight:600;margin-bottom:10px;color:#374151;">Neuer Status:</div>
                        <div style="display:grid;gap:10px;">
                            ${statusOptions.map(status => `
                                <button onclick="updateRideStatus('${rideId}', '${status.value}')" style="
                                    padding:15px;
                                    background:${status.value === currentStatus ? '#f3f4f6' : 'white'};
                                    border:2px solid ${status.color};
                                    border-radius:8px;
                                    cursor:pointer;
                                    text-align:left;
                                    font-weight:600;
                                " onmouseover="if('${status.value}' !== '${currentStatus}') this.style.background='${status.color}';this.style.color='white';" onmouseout="if('${status.value}' !== '${currentStatus}') {this.style.background='white';this.style.color='inherit';}">
                                    ${status.label}${status.value === currentStatus ? ' (aktuell)' : ''}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <button onclick="this.closest('#status-change-modal').remove()" style="width:100%;padding:12px;background:#e5e7eb;color:#374151;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                        Abbrechen
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('ğŸ’¾ Fehler:', error);
        alert('ğŸ’¾ Fehler: ' + error.message);
    }
}

async function updateRideStatus(rideId, newStatus) {
    try {
        console.log('ğŸ’¾ Aktualisiere Status:', rideId, 'â†’', newStatus);
        
        // ğŸ†• v5.90.525: Hole ALTE Fahrt-Daten!
        const rideSnapshot = await db.ref(`rides/${rideId}`).once('value');
        const ride = rideSnapshot.val();
        
        if (!ride) {
            alert('ğŸ’¾ Fahrt nicht gefunden!');
            return;
        }
        
        const oldVehicleId = ride.vehicleId;
        const oldStatus = ride.status;
        
        console.log('ğŸ“± Alter Status:', oldStatus, '| Neuer Status:', newStatus);
        console.log('ğŸš— Altes Fahrzeug:', oldVehicleId);
        
        // ğŸ†• v5.90.525: UPDATE-OBJEKT VORBEREITEN
        const updates = {
            status: newStatus,
            statusUpdatedAt: Date.now(),
            statusUpdatedBy: currentUser?.uid || 'admin'
        };
        
        // ğŸ”§ v5.90.525: EINFACHE REGEL!
        // Wenn Status auf new/vorbestellt/cancelled UND Fahrzeug ist zugeteilt â†’ FREIGEBEN!
        const shouldReleaseVehicle = (
            (newStatus === 'new' || newStatus === 'vorbestellt' || newStatus === 'cancelled') &&
            oldVehicleId
        );
        
        if (shouldReleaseVehicle) {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸš— FAHRZEUG WIRD FREIGEGEBEN!');
            console.log('   Grund: Status â†’ ', newStatus);
            console.log('   Fahrzeug:', oldVehicleId);
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            // Entferne ALLES aus Fahrt
            updates.vehicleId = null;
            updates.vehicle = null;
            updates.vehicleLabel = null;
            updates.assignedTo = null;
            updates.assignedVehicleName = null;
            updates.trackingLink = null; // âœ… Link lÃ¶schen!
            updates.assignedAt = null;
            updates.assignedBy = null;
            updates.assignedDistance = null;
            updates.drivingTimeToPickup = null;
            updates.estimatedArrivalAt = null;
            
            // âœ… Setze Fahrzeug auf FREI!
            await db.ref(`vehicles/${oldVehicleId}`).update({
                status: 'frei',
                currentRideId: null,
                lastUpdate: Date.now()
            });
            
            console.log('âœ… Fahrzeug', oldVehicleId, 'ist jetzt FREI!');
        }
        
        // âœ… UPDATE AUSFÃœHREN!
        await db.ref(`rides/${rideId}`).update(updates);
        
        console.log('âœ… Status aktualisiert!');
        
        const modal = document.getElementById('status-change-modal');
        if (modal) modal.remove();
        
        // ğŸ”„ Aktualisiere die richtige View
        if (currentView === 'schedule-view' || currentView === 'calendar') {
            renderCalendar();
        } else if (currentView === 'vehicle-overview-view' || currentView === 'fleet-overview') {
            if (typeof loadFleetOverviewStandalone === 'function') {
                loadFleetOverviewStandalone();
            }
        } else if (currentView === 'driver-view') {
            if (typeof updateDriverView === 'function') {
                updateDriverView();
            }
        }
        
        alert(`âœ… Status geÃ¤ndert zu: ${newStatus}${shouldReleaseVehicle ? '\nğŸš— Fahrzeug freigegeben!' : ''}`);
        
    } catch (error) {
        console.error('ğŸ’¾ Fehler:', error);
        alert('ğŸ’¾ Fehler: ' + error.message);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// v5.90.525: EXPORT-FUNKTIONEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function exportAllCustomersToVCF() {
    try {
        console.log('ğŸ“¥ Exportiere alle Kunden...');
        
        if (!isFirebaseReady) {
            alert('ğŸ’¾ Firebase nicht bereit!');
            return;
        }
        
        const snapshot = await db.ref('customers').once('value');
        
        if (!snapshot.exists()) {
            alert('ğŸ’¾ Keine Kunden vorhanden!');
            return;
        }
        
        const customers = [];
        snapshot.forEach(child => {
            const c = child.val();
            c.id = child.key;
            customers.push(c);
        });
        
        let vcfContent = '';
        
        customers.forEach(customer => {
            vcfContent += 'BEGIN:VCARD\nVERSION:3.0\n';
            vcfContent += `FN:${customer.name || 'Unbekannt'}\n`;
            vcfContent += `N:${customer.name || 'Unbekannt'};;;;\n`;
            
            if (customer.phone || customer.mobilePhone) {
                vcfContent += `TEL;TYPE=CELL:${customer.phone || customer.mobilePhone}\n`;
            }
            
            if (customer.email) vcfContent += `EMAIL:${customer.email}\n`;
            if (customer.address) vcfContent += `ADR;TYPE=HOME:;;${customer.address};;;;\n`;
            if (customer.notes) vcfContent += `NOTE:${customer.notes}\n`;
            
            vcfContent += 'END:VCARD\n';
        });
        
        const blob = new Blob([vcfContent], { type: 'text/vcard;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `funk-taxi-kunden-${new Date().toISOString().split('T')[0]}.vcf`;
        a.click();
        URL.revokeObjectURL(url);
        
        alert(`âœ… ${customers.length} Kunden exportiert!`);
        
    } catch (error) {
        console.error('ğŸ’¾ Fehler:', error);
        alert('ğŸ’¾ Fehler: ' + error.message);
    }
}

async function exportCustomerToVCF(customerId) {
    try {
        const snapshot = await db.ref(`customers/${customerId}`).once('value');
        const customer = snapshot.val();
        
        if (!customer) {
            alert('ğŸ’¾ Kunde nicht gefunden!');
            return;
        }
        
        let vcfContent = 'BEGIN:VCARD\nVERSION:3.0\n';
        vcfContent += `FN:${customer.name || 'Unbekannt'}\n`;
        vcfContent += `N:${customer.name || 'Unbekannt'};;;;\n`;
        
        if (customer.phone || customer.mobilePhone) {
            vcfContent += `TEL;TYPE=CELL:${customer.phone || customer.mobilePhone}\n`;
        }
        
        if (customer.email) vcfContent += `EMAIL:${customer.email}\n`;
        if (customer.address) vcfContent += `ADR;TYPE=HOME:;;${customer.address};;;;\n`;
        
        vcfContent += 'END:VCARD\n';
        
        const blob = new Blob([vcfContent], { type: 'text/vcard;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${customer.name || 'kunde'}.vcf`;
        a.click();
        URL.revokeObjectURL(url);
        
    } catch (error) {
        console.error('ğŸ’¾ Fehler:', error);
        alert('ğŸ’¾ Fehler: ' + error.message);
    }
}

console.log('âœ… v5.90.525: Status Ã¤ndern + Export-Funktionen geladen!');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ†• v5.90.548: EXPRESS-BOOKING SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let expressBookingMap = null;
let expressPickupPin = null;
let expressDestinationPin = null;
let expressRouteLine = null;
let expressPickupData = null;
let expressDestinationData = null;

function initExpressBooking() {
    console.log('âš¡ Initialisiere Express-Booking...');
    
    if (!expressBookingMap) {
        expressBookingMap = L.map('express-booking-map').setView([53.9547, 14.1783], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(expressBookingMap);
        
        // Klick-Handler
        expressBookingMap.on('click', handleExpressMapClick);
        
        console.log('âœ… Express-Booking Karte initialisiert!');
    } else {
        expressBookingMap.invalidateSize();
    }
}

// ğŸ†• v5.90.561: REVERSE GEOCODING (Koordinaten â†’ Adresse)
// ğŸ†• v5.90.599: Formatiere Adresse kurz
// ğŸ†• v5.90.600: Formatiere Adresse mit Name (wie CRM Karten-Picker)
function formatAddressShort(nominatimData) {
    if (!nominatimData || !nominatimData.address) {
        return {
            name: null,
            address: nominatimData?.display_name || 'Unbekannte Adresse'
        };
    }
    
    const addr = nominatimData.address;
    const parts = [];
    
    // ğŸ†• v5.90.600: Extrahiere NAME (POI, GeschÃ¤ft, Hotel, etc.)
    let name = null;
    if (addr.amenity) {
        name = addr.amenity;
    } else if (addr.tourism) {
        name = addr.tourism;
    } else if (addr.shop) {
        name = addr.shop;
    } else if (addr.building && addr.building !== 'yes') {
        name = addr.building;
    } else if (nominatimData.name) {
        name = nominatimData.name;
    }
    
    // StraÃŸe + Hausnummer
    if (addr.road) {
        if (addr.house_number) {
            parts.push(`${addr.road} ${addr.house_number}`);
        } else {
            parts.push(addr.road);
        }
    }
    
    // PLZ
    if (addr.postcode) {
        parts.push(addr.postcode);
    }
    
    // Ort (in dieser Reihenfolge)
    const city = addr.village || addr.town || addr.city || addr.municipality;
    if (city) {
        parts.push(city);
    }
    
    return {
        name: name,
        address: parts.join(', ') || nominatimData.display_name || 'Unbekannte Adresse'
    };
}


async function reverseGeocode(lat, lon) {
    try {
        const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`
        );
        
        if (!response.ok) {
            throw new Error('Nominatim API Fehler');
        }
        
        const data = await response.json();
        
        // ğŸ†• v5.90.599: Nutze formatAddressShort fÃ¼r kurze Adresse!
        return formatAddressShort(data);
        
    } catch (error) {
        console.error('âŒ Reverse Geocoding Fehler:', error);
        return `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
    }
}

async function handleExpressMapClick(e) {
    const lat = e.latlng.lat;
    const lon = e.latlng.lng;
    
    console.log('ğŸ“ Klick auf Karte:', lat, lon);
    
    // Modus: Single-Pin oder Doppel-Pin?
    // Wenn noch kein Pin â†’ Single-Pin-Modus
    if (!expressPickupPin) {
        await setSinglePin(lat, lon);
    }
    // Wenn schon Pin da â†’ Zweiter Pin fÃ¼r Route
    else if (expressPickupPin && !expressDestinationPin) {
        await setSecondPin(lat, lon);
    }
}

async function setSinglePin(lat, lon) {
    console.log('ğŸ“ v5.90.581: setSinglePin aufgerufen!', lat, lon);
    
    // Setze Pin
    expressPickupPin = L.marker([lat, lon], {
        icon: L.divIcon({
            className: 'custom-pin',
            html: '<div style="background:#8b5cf6;width:35px;height:35px;border-radius:50% 50% 50% 0;transform:rotate(-45deg);border:3px solid white;box-shadow:0 3px 10px rgba(0,0,0,0.4);"><div style="transform:rotate(45deg);font-size:18px;text-align:center;line-height:29px;">ğŸ“</div></div>',
            iconSize: [35, 35],
            iconAnchor: [17, 35]
        }),
        draggable: true
    }).addTo(expressBookingMap);
    
    console.log('âœ… Pin zur Karte hinzugefÃ¼gt');
    
    // Drag-Event
    expressPickupPin.on('dragend', async function(e) {
        const newPos = e.target.getLatLng();
        const addressData = await reverseGeocode(newPos.lat, newPos.lng);
        expressPickupData = { 
            lat: newPos.lat, 
            lon: newPos.lng, 
            name: addressData.name,
            address: addressData.address
        };
        updateExpressInfoPanel();
    });
    
    // Geocoding
    console.log('ğŸ” Starte Reverse Geocoding...');
    const addressData = await reverseGeocode(lat, lon);
    expressPickupData = { 
        lat, 
        lon, 
        name: addressData.name,
        address: addressData.address 
    };
    
    console.log('âœ… Pin gesetzt:', addressData.address);
    console.log('ğŸ“¦ expressPickupData:', expressPickupData);
    
    // Update Panel
    console.log('ğŸ”„ Rufe updateExpressInfoPanel() auf...');
    updateExpressInfoPanel();
    console.log('âœ… Panel sollte jetzt aktualisiert sein!');
}

async function setSecondPin(lat, lon) {
    // Zweiter Pin fÃ¼r Route
    expressDestinationPin = L.marker([lat, lon], {
        icon: L.divIcon({
            className: 'custom-pin',
            html: '<div style="background:#3b82f6;width:35px;height:35px;border-radius:50% 50% 50% 0;transform:rotate(-45deg);border:3px solid white;box-shadow:0 3px 10px rgba(0,0,0,0.4);"><div style="transform:rotate(45deg);font-size:18px;text-align:center;line-height:29px;">ğŸ¯</div></div>',
            iconSize: [35, 35],
            iconAnchor: [17, 35]
        }),
        draggable: true
    }).addTo(expressBookingMap);
    
    // Geocoding
    const addressData = await reverseGeocode(lat, lon);
    expressDestinationData = { 
        lat, 
        lon, 
        name: addressData.name,
        address: addressData.address 
    };
    
    console.log('âœ… Ziel gesetzt:', addressData.address);
    
    // Route berechnen
    await calculateExpressRoute();
    
    // Update Panel mit Route-Info
    updateExpressInfoPanelWithRoute();
}

function updateExpressInfoPanel() {
    console.log('ğŸ”„ v5.90.600: updateExpressInfoPanel START');
    const panel = document.getElementById('express-info-panel');
    const resetBtn = document.getElementById('express-reset-btn');
    
    console.log('ğŸ“¦ Panel Element:', panel ? 'GEFUNDEN' : 'NICHT GEFUNDEN');
    console.log('ğŸ“¦ Reset Button:', resetBtn ? 'GEFUNDEN' : 'NICHT GEFUNDEN');
    console.log('ğŸ“¦ expressPickupData:', expressPickupData);
    
    if (!expressPickupData) {
        console.log('âš ï¸ Kein Pickup Data - zeige Initial-Text');
        panel.innerHTML = `
            <div style="color:#6b7280;font-size:13px;text-align:center;padding:20px;">
                <p style="margin:0;">ğŸ“ Klicke auf die Karte um einen Standort zu wÃ¤hlen</p>
                <p style="margin:8px 0 0 0;font-size:12px;">Tipp: 2x klicken = Route berechnen</p>
            </div>
        `;
        resetBtn.style.display = 'none';
        return;
    }
    
    console.log('âœ… Pickup Data vorhanden - zeige Buttons!');
    console.log('ğŸ“ Name:', expressPickupData.name);
    console.log('ğŸ“ Adresse:', expressPickupData.address);
    
    // ğŸ†• v5.90.600: Baue Adress-Anzeige mit NAME (wenn vorhanden)
    let addressHTML = '';
    if (expressPickupData.name) {
        addressHTML = `
            <div style="font-weight:700;font-size:12px;margin-bottom:2px;">ğŸ™ï¸ ${expressPickupData.name}</div>
            <div style="font-size:11px;opacity:0.95;line-height:1.4;">${expressPickupData.address}</div>
        `;
    } else {
        addressHTML = `
            <div style="font-size:11px;opacity:0.95;line-height:1.4;">${expressPickupData.address}</div>
        `;
    }
    
    panel.innerHTML = `
        <div style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;padding:12px;border-radius:8px;margin-bottom:10px;">
            <div style="font-weight:700;font-size:13px;margin-bottom:4px;">ğŸ“ Standort gewÃ¤hlt:</div>
            ${addressHTML}
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px;">
            <button onclick="copyExpressAddress()" style="padding:8px;background:#10b981;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:11px;">
                ğŸ“‹ Kopieren
            </button>
            <button onclick="saveExpressPOI()" style="padding:8px;background:#f59e0b;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:11px;">
                â­ Als POI
            </button>
        </div>
        
        <button onclick="askBookingMode()" style="width:100%;padding:10px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:13px;box-shadow:0 2px 8px rgba(59,130,246,0.3);">
            ğŸš• Taxi buchen
        </button>
        
        <div style="margin-top:10px;padding:8px;background:#f3f4f6;border-radius:6px;font-size:11px;color:#6b7280;text-align:center;">
            ğŸ’¡ Oder klicke nochmal fÃ¼r Zielort
        </div>
    `;
    
    resetBtn.style.display = 'block';
    console.log('âœ… v5.90.600: Panel HTML gesetzt! Buttons sollten sichtbar sein!');
}

function updateExpressInfoPanelWithRoute() {
    const panel = document.getElementById('express-info-panel');
    
    // ğŸ†• v5.90.600: Baue Von/Nach mit NAME
    let fromHTML = expressPickupData.name 
        ? `<div>ğŸ™ï¸ ${expressPickupData.name}</div><div style="font-size:10px;opacity:0.9;">${expressPickupData.address.substring(0, 35)}...</div>`
        : `<div>${expressPickupData.address.substring(0, 40)}...</div>`;
        
    let toHTML = expressDestinationData.name
        ? `<div>ğŸ™ï¸ ${expressDestinationData.name}</div><div style="font-size:10px;opacity:0.9;">${expressDestinationData.address.substring(0, 35)}...</div>`
        : `<div>${expressDestinationData.address.substring(0, 40)}...</div>`;
    
    panel.innerHTML = `
        <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:12px;border-radius:8px;margin-bottom:8px;">
            <div style="font-weight:700;font-size:13px;margin-bottom:6px;">âœ… Route berechnet!</div>
            <div style="font-size:11px;opacity:0.95;line-height:1.4;">
                <div style="margin-bottom:4px;">ğŸ“ Von: ${fromHTML}</div>
                <div>ğŸ¯ Nach: ${toHTML}</div>
            </div>
        </div>
        
        <button onclick="bookExpressRoute()" style="width:100%;padding:12px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px;box-shadow:0 2px 8px rgba(59,130,246,0.3);">
            ğŸš• Route buchen
        </button>
    `;
}

function askBookingMode() {
    if (!expressPickupData) return;
    
    const choice = confirm('ğŸ“ Als ABHOLORT verwenden?\n\nOK = Abholort\nAbbrechen = Zielort');
    
    if (choice) {
        // Als Abholort
        localStorage.setItem('expressBookingPickup', JSON.stringify(expressPickupData));
    } else {
        // Als Zielort
        localStorage.setItem('expressBookingDestination', JSON.stringify(expressPickupData));
    }
    
    console.log('ğŸš• Ã–ffne Buchung:', choice ? 'Abholort' : 'Zielort');
    resetExpressBooking();
    switchView('passenger');
}

function bookExpressRoute() {
    if (!expressPickupData || !expressDestinationData) return;
    
    // Beide Adressen speichern
    localStorage.setItem('expressBookingPickup', JSON.stringify(expressPickupData));
    localStorage.setItem('expressBookingDestination', JSON.stringify(expressDestinationData));
    
    console.log('ğŸš• Route Ã¼bernommen!');
    resetExpressBooking();
    
    // Zu Taxi buchen wechseln (switchView lÃ¤dt die Daten automatisch!)
    switchView('passenger');
}

function copyExpressAddress() {
    if (!expressPickupData) return;
    
    let textToCopy = expressPickupData.address;
    if (expressPickupData.name) {
        textToCopy = `${expressPickupData.name}\n${expressPickupData.address}`;
    }
    
    navigator.clipboard.writeText(textToCopy).then(() => {
        alert('âœ… Adresse kopiert!\n\n' + textToCopy);
    }).catch(err => {
        const textarea = document.createElement('textarea');
        textarea.value = textToCopy;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        alert('âœ… Adresse kopiert!');
    });
    
    console.log('ğŸ“‹ Adresse kopiert:', textToCopy);
}

async function saveExpressPOI() {
    if (!expressPickupData || !currentUser || !db) {
        alert('âš ï¸ Bitte einloggen um POIs zu speichern!');
        return;
    }
    
    const name = prompt('â­ Name fÃ¼r POI:', expressPickupData.address.split(',')[0]);
    if (!name) return;
    
    try {
        const poiRef = db.ref('pois').push();
        await poiRef.set({
            name: name,
            address: expressPickupData.address,
            lat: expressPickupData.lat,
            lon: expressPickupData.lon,
            createdBy: currentUser.uid,
            createdAt: Date.now()
        });
        
        alert('âœ… POI gespeichert!\n\n' + name);
        console.log('â­ POI gespeichert:', name);
        
        resetExpressBooking();
        
    } catch (error) {
        console.error('Fehler:', error);
        alert('âŒ Fehler beim Speichern!');
    }
}

async function setExpressPickup(lat, lon) {
    console.log('ğŸ“ Setze Abholort:', lat, lon);
    
    // Entferne alten Pin
    if (expressPickupPin) {
        expressBookingMap.removeLayer(expressPickupPin);
    }
    
    // Erstelle grÃ¼nen Pin
    expressPickupPin = L.marker([lat, lon], {
        icon: L.divIcon({
            className: 'custom-pin',
            html: '<div style="background:#10b981;width:30px;height:30px;border-radius:50% 50% 50% 0;transform:rotate(-45deg);border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);"><div style="transform:rotate(45deg);font-size:16px;text-align:center;line-height:24px;">ğŸ“</div></div>',
            iconSize: [30, 30],
            iconAnchor: [15, 30]
        }),
        draggable: true
    }).addTo(expressBookingMap);
    
    // Geocoding
    const addressData = await reverseGeocode(lat, lon);
    expressPickupData = { 
        lat, 
        lon, 
        name: addressData.name,
        address: addressData.address 
    };
    
    console.log('âœ… Abholort:', addressData.address);
}

async function setExpressDestination(lat, lon) {
    console.log('ğŸ¯ Setze Zielort:', lat, lon);
    
    // Entferne alten Pin
    if (expressDestinationPin) {
        expressBookingMap.removeLayer(expressDestinationPin);
    }
    
    // Erstelle blauen Pin
    expressDestinationPin = L.marker([lat, lon], {
        icon: L.divIcon({
            className: 'custom-pin',
            html: '<div style="background:#3b82f6;width:30px;height:30px;border-radius:50% 50% 50% 0;transform:rotate(-45deg);border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);"><div style="transform:rotate(45deg);font-size:16px;text-align:center;line-height:24px;">ğŸ¯</div></div>',
            iconSize: [30, 30],
            iconAnchor: [15, 30]
        }),
        draggable: true
    }).addTo(expressBookingMap);
    
    // Geocoding
    const addressData = await reverseGeocode(lat, lon);
    expressDestinationData = { 
        lat, 
        lon, 
        name: addressData.name,
        address: addressData.address 
    };
    
    console.log('âœ… Zielort:', addressData.address);
}

async function calculateExpressRoute() {
    if (!expressPickupData || !expressDestinationData) return;
    
    console.log('ğŸ—ºï¸ Berechne Route...');
    
    try {
        const route = await calculateRoute(expressPickupData, expressDestinationData);
        
        if (route && route.geometry) {
            // Entferne alte Route
            if (expressRouteLine) {
                expressBookingMap.removeLayer(expressRouteLine);
            }
            
            // Zeichne neue Route
            const coords = route.geometry.map(coord => [coord[1], coord[0]]);
            expressRouteLine = L.polyline(coords, {
                color: '#f59e0b',
                weight: 4,
                opacity: 0.8
            }).addTo(expressBookingMap);
            
            // Zoom auf Route
            const bounds = L.latLngBounds([
                [expressPickupData.lat, expressPickupData.lon],
                [expressDestinationData.lat, expressDestinationData.lon]
            ]);
            expressBookingMap.fitBounds(bounds, { padding: [50, 50] });
        }
        
        console.log('âœ… Route berechnet:', route.distance, 'km,', route.duration, 'Min');
        
    } catch (error) {
        console.error('ğŸ’¾ Route-Fehler:', error);
    }
}

function showExpressBookingModal() {
    console.log('ğŸ’¾ Ã–ffne Buchungs-Modal...');
    alert('ğŸ‰ Modal kommt im nÃ¤chsten Update!\nğŸ“ Von: ' + expressPickupData.address + '\nğŸ¯ Nach: ' + expressDestinationData.address);
}

function resetExpressBooking() {
    console.log('ğŸ”„ ZurÃ¼cksetzen...');
    
    // Entferne Pins
    if (expressPickupPin) {
        expressBookingMap.removeLayer(expressPickupPin);
        expressPickupPin = null;
    }
    if (expressDestinationPin) {
        expressBookingMap.removeLayer(expressDestinationPin);
        expressDestinationPin = null;
    }
    if (expressRouteLine) {
        expressBookingMap.removeLayer(expressRouteLine);
        expressRouteLine = null;
    }
    
    // Reset Daten
    expressPickupData = null;
    expressDestinationData = null;
    
    // Reset UI
    document.getElementById('express-reset-btn').style.display = 'none';
    document.getElementById('express-info-panel').innerHTML = `
        <div style="color:#666;font-size:14px;line-height:1.6;">
            <p style="margin:0 0 10px 0;"><strong>ğŸ“ Schritt 1:</strong> Klicke auf die Karte um den Abholort zu setzen (grÃ¼ner Pin)</p>
            <p style="margin:0;"><strong>ğŸ¯ Schritt 2:</strong> Klicke nochmal um das Ziel zu setzen (blauer Pin)</p>
        </div>
    `;
    
    console.log('âœ… Express-Booking zurÃ¼ckgesetzt!');
}

console.log('âœ… v5.90.548: Express-Booking System geladen!');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ†• v5.90.556: PERFEKTER TAXI-SIMULATOR MIT OSRM + LIVE-BEWEGUNG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let simulatorMap = null;
let simVehicles = [];
let simRides = [];
let simTime = Date.now();
let simSpeed = 10;
let simRunning = false;
let simInterval = null;
let rideGenerationInterval = null;
let simEventLog = [];
let simRoutes = {}; // Store routes on map
let simMovementInterval = null;

const SIM_VEHICLE_SPEED_KMH = 50; // Durchschnittsgeschwindigkeit
const SIM_PICKUP_PAUSE_MS = 60000; // 1 Min Pause beim Abholen
const SIM_DROPOFF_PAUSE_MS = 30000; // 30 Sek beim Absetzen

function initSimulator() {
    console.log('ğŸ® v5.90.565: Initialisiere Simulator mit Usedom-Karte...');
    
    if (!simulatorMap) {
        // ğŸ†• v5.90.565: HÃ¶herer Zoom fÃ¼r Usedom (StraÃŸen + Hausnummern sichtbar!)
        simulatorMap = L.map('simulator-map').setView([53.9547, 14.1783], 14);
        
        // ğŸ†• v5.90.565: OpenStreetMap mit allen Details (StraÃŸen + Hausnummern)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap',
            maxZoom: 19,  // Sehr hoher Zoom mÃ¶glich!
            minZoom: 11   // Mindestens Usedom-Ãœbersicht
        }).addTo(simulatorMap);
        
        console.log('âœ… Simulator-Karte initialisiert (Usedom-Region mit StraÃŸen & Hausnummern)!');
    } else {
        simulatorMap.invalidateSize();
    }
    
    loadInitialVehicles();
    renderSimulator();
    logSimEvent('ğŸ® Simulator gestartet - Usedom-Karte mit OSRM-Routing aktiv');
}

// ğŸ†• v5.90.567: ECHTE USEDOM-ADRESSEN FÃœR SIMULATOR
const USEDOM_ADDRESSES = [
    { name: "Bahnhof Heringsdorf", address: "BahnhofstraÃŸe 2, 17424 Heringsdorf", lat: 53.9533, lon: 14.1633 },
    { name: "Bahnhof Ahlbeck", address: "BahnhofstraÃŸe 5, 17419 Ahlbeck", lat: 53.9461, lon: 14.1989 },
    { name: "Bahnhof Bansin", address: "BahnhofstraÃŸe 3, 17429 Bansin", lat: 53.9639, lon: 14.1442 },
    { name: "Bahnhof Zinnowitz", address: "BahnhofstraÃŸe 40, 17454 Zinnowitz", lat: 54.0933, lon: 13.9197 },
    { name: "SeebrÃ¼cke Heringsdorf", address: "Strandpromenade, 17424 Heringsdorf", lat: 53.9525, lon: 14.1592 },
    { name: "SeebrÃ¼cke Ahlbeck", address: "DÃ¼nenstraÃŸe, 17419 Ahlbeck", lat: 53.9444, lon: 14.1933 },
    { name: "SeebrÃ¼cke Bansin", address: "Strandpromenade, 17429 Bansin", lat: 53.9633, lon: 14.1433 },
    { name: "SeebrÃ¼cke Zinnowitz", address: "Strandpromenade, 17454 Zinnowitz", lat: 54.0947, lon: 13.9228 },
    { name: "Hotel Kaiserhof Heringsdorf", address: "KulmstraÃŸe 28, 17424 Heringsdorf", lat: 53.9558, lon: 14.1564 },
    { name: "Steigenberger Grandhotel", address: "LiehrstraÃŸe 11, 17424 Heringsdorf", lat: 53.9547, lon: 14.1583 },
    { name: "Hotel Ahlbecker Hof", address: "DÃ¼nenstraÃŸe 47, 17419 Ahlbeck", lat: 53.9472, lon: 14.1917 },
    { name: "Seetelhotel Ostseeresidenz Bansin", address: "Strandpromenade 5, 17429 Bansin", lat: 53.9628, lon: 14.1447 },
    { name: "Hotel Preussenhof Zinnowitz", address: "Neue StrandstraÃŸe 36, 17454 Zinnowitz", lat: 54.0939, lon: 13.9222 },
    { name: "Fischrestaurant Seeblick", address: "Strandpromenade 1, 17424 Heringsdorf", lat: 53.9519, lon: 14.1578 },
    { name: "CafÃ© Asgaard Ahlbeck", address: "DÃ¼nenstraÃŸe 41, 17419 Ahlbeck", lat: 53.9458, lon: 14.1928 },
    { name: "Restaurant SeebrÃ¼cke Bansin", address: "SeebrÃ¼ckenpromenade 2, 17429 Bansin", lat: 53.9631, lon: 14.1436 },
    { name: "OstseeTherme Usedom", address: "LindenstraÃŸe 60, 17429 Heringsdorf", lat: 53.9611, lon: 14.1519 },
    { name: "Edeka Heringsdorf", address: "DelbrÃ¼ckstraÃŸe 31, 17424 Heringsdorf", lat: 53.9592, lon: 14.1653 },
    { name: "Kaufland Heringsdorf", address: "DelbrÃ¼ckstraÃŸe 51, 17424 Heringsdorf", lat: 53.9603, lon: 14.1672 },
    { name: "Flughafen Heringsdorf", address: "Am Flughafen 1, 17424 Heringsdorf", lat: 53.8786, lon: 14.1522 },
    { name: "Bernsteintherme Zinnowitz", address: "DÃ¼nenstraÃŸe 8, 17454 Zinnowitz", lat: 54.0953, lon: 13.9211 }
];

// ğŸ†• v5.90.603: ECHTE STRASSEN AUS NOMINATIM!
async function getRandomAddressFromNominatim() {
    // ZufÃ¤llige Stadt auf Usedom wÃ¤hlen
    const cities = [
        'Heringsdorf', 'Ahlbeck', 'Bansin', 'Zinnowitz', 
        'Ãœckeritz', 'Loddin', 'Zempin', 'Koserow',
        'Karlshagen', 'Trassenheide', 'PeenemÃ¼nde'
    ];
    
    const city = cities[Math.floor(Math.random() * cities.length)];
    
    try {
        // Suche zufÃ¤llige StraÃŸe in dieser Stadt
        const response = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${city}+Usedom+Deutschland&addressdetails=1&limit=50`
        );
        
        if (!response.ok) throw new Error('Nominatim Fehler');
        
        const results = await response.json();
        
        // Filtere nur Ergebnisse mit StraÃŸen
        const streetResults = results.filter(r => 
            r.address && r.address.road && r.address.house_number
        );
        
        if (streetResults.length > 0) {
            const result = streetResults[Math.floor(Math.random() * streetResults.length)];
            const addr = result.address;
            
            const parts = [];
            if (addr.road && addr.house_number) {
                parts.push(`${addr.road} ${addr.house_number}`);
            }
            if (addr.postcode) parts.push(addr.postcode);
            const cityName = addr.village || addr.town || addr.city || city;
            if (cityName) parts.push(cityName);
            
            return {
                name: result.name || `${addr.road} ${addr.house_number}`,
                address: parts.join(', '),
                lat: parseFloat(result.lat),
                lon: parseFloat(result.lon)
            };
        }
    } catch (error) {
        console.warn('âš ï¸ Nominatim Fehler, nutze Fallback:', error);
    }
    
    // Fallback: Nutze USEDOM_ADDRESSES
    return getRandomAddress();
}

function getRandomAddress(excludeAddress = null) {
    let filtered = USEDOM_ADDRESSES;
    if (excludeAddress) {
        filtered = USEDOM_ADDRESSES.filter(a => a.address !== excludeAddress);
    }
    return filtered[Math.floor(Math.random() * filtered.length)];
}

function loadInitialVehicles() {
    simVehicles = [
        {
            id: 'sim-tesla',
            name: 'Tesla Model Y',
            lat: 53.9533,  // ğŸ”§ v5.90.560: Bahnhof Heringsdorf!
            lon: 14.1633,
            homeLat: 53.9533,  // ğŸ†• Home-Position
            homeLon: 14.1633,
            homeLocation: 'Bahnhof Heringsdorf',
            status: 'free',
            online: true,
            marker: null,
            currentRide: null,
            routeData: null
        },
        {
            id: 'sim-renault',
            name: 'Renault Traffic',
            lat: 53.9444,  // ğŸ”§ v5.90.560: SeebrÃ¼cke Ahlbeck!
            lon: 14.1933,
            homeLat: 53.9444,
            homeLon: 14.1933,
            homeLocation: 'SeebrÃ¼cke Ahlbeck',
            status: 'free',
            online: true,
            marker: null,
            currentRide: null,
            routeData: null
        },
        {
            id: 'sim-toyota',
            name: 'Toyota Prius',
            lat: 53.9633,  // ğŸ”§ v5.90.560: SeebrÃ¼cke Bansin!
            lon: 14.1433,
            homeLat: 53.9633,
            homeLon: 14.1433,
            homeLocation: 'SeebrÃ¼cke Bansin',
            status: 'free',
            online: true,
            marker: null,
            currentRide: null,
            routeData: null
        }
    ];
}

function renderSimulator() {
    updateSimTime();
    renderSimVehicles();
    renderSimRides();
    renderEventLog();
}

function updateSimTime() {
    const date = new Date(simTime);
    document.getElementById('sim-time').textContent = 
        `ğŸ• ${date.toLocaleDateString('de-DE')} ${date.toLocaleTimeString('de-DE')}`;
}

function renderSimVehicles() {
    const list = document.getElementById('sim-vehicles-list');
    if (!list) return;
    
    list.innerHTML = simVehicles.map(v => `
        <div style="padding:6px 8px;background:${v.online ? (v.status === 'busy' ? '#fef3c7' : '#d1fae5') : '#fee2e2'};border-radius:6px;margin-bottom:6px;border-left:3px solid ${v.online ? (v.status === 'busy' ? '#f59e0b' : '#10b981') : '#ef4444'};">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px;">
                <div style="font-weight:700;font-size:11px;">${v.online ? 'ğŸŸ¢' : 'ğŸ”´'} ${v.name}</div>
                <div style="font-size:9px;color:#6b7280;font-weight:600;text-transform:uppercase;">${
                    v.status === 'free' ? 'FREI' :
                    v.status === 'on_way' ? 'ANFAHRT' :
                    v.status === 'picked_up' ? 'BESETZT' : 'OFF'
                }</div>
            </div>
            ${v.currentRide ? `<div style="font-size:9px;color:#6b7280;margin-bottom:4px;">â†’ ${v.currentRide.customerName} ${v.currentRide.eta ? '(' + v.currentRide.eta + ')' : ''}</div>` : ''}
            ${v.homeLocation ? `<div style="font-size:8px;color:#9ca3af;margin-bottom:4px;">ğŸ  ${v.homeLocation}</div>` : ''}
            <div style="display:flex;flex-direction:column;gap:3px;">
                <div style="display:flex;gap:3px;">
                    <button onclick="toggleVehicleOnline('${v.id}')" style="flex:1;padding:3px;background:${v.online ? '#ef4444' : '#10b981'};color:white;border:none;border-radius:3px;font-size:9px;cursor:pointer;font-weight:600;">
                        ${v.online ? 'Off' : 'On'}
                    </button>
                    <button onclick="editSimVehicle('${v.id}')" style="flex:1;padding:3px;background:#8b5cf6;color:white;border:none;border-radius:3px;font-size:9px;cursor:pointer;font-weight:600;" title="Koordinaten editieren">
                        âœï¸
                    </button>
                    <button onclick="moveVehicleRandom('${v.id}')" style="flex:1;padding:3px;background:#3b82f6;color:white;border:none;border-radius:3px;font-size:9px;cursor:pointer;font-weight:600;" title="ZufÃ¤llige Position">
                        ğŸ“
                    </button>
                </div>
                <div style="display:flex;gap:3px;">
                    <button onclick="setSimVehicleHome('${v.id}')" style="flex:1;padding:3px;background:#f59e0b;color:white;border:none;border-radius:3px;font-size:9px;cursor:pointer;font-weight:600;" title="Home-Standort setzen">
                        ğŸ  Set
                    </button>
                    <button onclick="sendVehicleHome('${v.id}')" style="flex:1;padding:3px;background:#10b981;color:white;border:none;border-radius:3px;font-size:9px;cursor:pointer;font-weight:600;" title="ZurÃ¼ck zur Basis">
                        ğŸ  Go
                    </button>
                </div>
            </div>
        </div>
    `).join('');
    
    // Update Marker auf Karte
    simVehicles.forEach(v => {
        if (v.marker) {
            simulatorMap.removeLayer(v.marker);
        }
        
        if (v.online) {
            const color = v.status === 'free' ? '#10b981' : v.status === 'on_way' ? '#f59e0b' : '#ef4444';
            v.marker = L.marker([v.lat, v.lon], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background:${color};color:white;padding:3px 6px;border-radius:6px;font-weight:700;font-size:10px;white-space:nowrap;box-shadow:0 2px 6px rgba(0,0,0,0.4);">ğŸš— ${v.name}</div>`,
                    iconSize: [100, 24]
                })
            }).addTo(simulatorMap);
        }
    });
}

function renderSimRides() {
    const list = document.getElementById('sim-rides-list');
    if (!list) return;
    
    if (simRides.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#9ca3af;padding:15px;font-size:11px;">Keine Fahrten</div>';
        return;
    }
    
    list.innerHTML = simRides.map((r, i) => {
        const statusColor = {
            'new': '#9ca3af',
            'assigned': '#3b82f6',
            'on_way': '#f59e0b',
            'picked_up': '#8b5cf6',
            'completed': '#10b981'
        }[r.status] || '#6b7280';
        
        return `
        <div style="padding:6px 8px;background:#f9fafb;border-radius:6px;margin-bottom:6px;border-left:3px solid ${statusColor};">
            <div style="font-weight:700;font-size:10px;margin-bottom:2px;">
                ${new Date(r.pickupTime).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})} - ${r.customerName}
            </div>
            <div style="font-size:9px;color:#6b7280;margin-bottom:3px;">
                ${r.pickup} â†’ ${r.destination}
                ${r.distance && r.duration ? `<div style="color:#8b5cf6;font-weight:600;margin-top:2px;">ğŸ“ ${r.distance} km | â±ï¸ ${r.duration} Min</div>` : ''}
            </div>
            <div style="font-size:9px;display:flex;justify-content:space-between;align-items:center;">
                <span style="color:${statusColor};font-weight:600;">${
                    r.status === 'new' ? 'NEU' :
                    r.status === 'assigned' ? 'ZUGEWIESEN' :
                    r.status === 'on_way' ? 'ANFAHRT' :
                    r.status === 'picked_up' ? 'BESETZT' : 'FERTIG'
                }</span>
                ${r.vehicleId ? `<span style="color:#6b7280;">${simVehicles.find(v => v.id === r.vehicleId)?.name || '?'}</span>` : ''}
            </div>
            ${r.status !== 'completed' ? `
                <div style="display:flex;gap:3px;margin-top:4px;">
                    <button onclick="showRideOnMap(${i})" style="flex:1;padding:2px;background:#8b5cf6;color:white;border:none;border-radius:3px;font-size:8px;cursor:pointer;font-weight:600;">ğŸ—ºï¸ Route</button>
                    ${r.status === 'new' ? `<button onclick="runAutoAssignForRide(${i})" style="flex:1;padding:2px;background:#f59e0b;color:white;border:none;border-radius:3px;font-size:8px;cursor:pointer;font-weight:600;">ğŸ¯ Assign</button>` : ''}
                    <button onclick="completeSimRide(${i})" style="flex:1;padding:2px;background:#10b981;color:white;border:none;border-radius:3px;font-size:8px;cursor:pointer;font-weight:600;">âœ…</button>
                    <button onclick="cancelSimRide(${i})" style="flex:1;padding:2px;background:#ef4444;color:white;border:none;border-radius:3px;font-size:8px;cursor:pointer;font-weight:600;">âŒ</button>
                </div>
            ` : ''}
        </div>
    `;
    }).join('');
}

function renderEventLog() {
    const log = document.getElementById('sim-event-log');
    if (!log) return;
    
    const recent = simEventLog.slice(-30).reverse();
    log.innerHTML = recent.map(e => `<div style="margin-bottom:2px;padding:2px 0;">${e}</div>`).join('');
    log.scrollTop = 0;
}

function toggleSimulation() {
    simRunning = !simRunning;
    const btn = document.getElementById('sim-play-btn');
    const badge = document.getElementById('sim-status-badge');
    
    if (simRunning) {
        btn.textContent = 'â¸ Pause';
        btn.style.background = '#ef4444';
        badge.textContent = 'â–¶ LÃ¤uft (' + simSpeed + 'x)';
        badge.style.background = 'rgba(16,185,129,0.3)';
        startSimulationEngine();
        logSimEvent('â–¶ Simulation gestartet');
    } else {
        btn.textContent = 'â–¶ Start';
        btn.style.background = '#10b981';
        badge.textContent = 'â¸ Pausiert';
        badge.style.background = 'rgba(239,68,68,0.3)';
        stopSimulationEngine();
        logSimEvent('â¸ Simulation pausiert');
    }
}

function startSimulationEngine() {
    // Haupt-Simulations-Loop (1 Sek = simSpeed Sekunden)
    simInterval = setInterval(() => {
        simTime += simSpeed * 1000;
        updateSimTime();
        processSimRides();
        moveVehicles();
    }, 1000);
}

function stopSimulationEngine() {
    if (simInterval) {
        clearInterval(simInterval);
        simInterval = null;
    }
}

function moveVehicles() {
    simVehicles.forEach(v => {
        if (!v.routeData || !v.currentRide) return;
        
        // Bewege Fahrzeug auf Route
        const route = v.routeData.coords;
        const currentIdx = v.routeData.currentIndex || 0;
        
        if (currentIdx < route.length - 1) {
            v.routeData.currentIndex = currentIdx + 1;
            v.lat = route[currentIdx][1];
            v.lon = route[currentIdx][0];
            
            // ETA berechnen
            const remainingPoints = route.length - currentIdx;
            const etaMinutes = Math.ceil(remainingPoints * 0.1); // Grob
            v.currentRide.eta = etaMinutes + ' Min';
            
            renderSimVehicles();
        } else {
            // Ziel erreicht!
            handleVehicleArrival(v);
        }
    });
}

async function handleVehicleArrival(vehicle) {
    const ride = vehicle.currentRide;
    if (!ride) return;
    
    if (vehicle.status === 'on_way') {
        // Ankunft beim Kunden
        vehicle.status = 'picked_up';
        ride.status = 'picked_up';
        logSimEvent(`âœ… ${vehicle.name} hat ${ride.customerName} abgeholt`);
        
        // Route zum Ziel berechnen
        await calculateAndDrawRoute(vehicle, 
            {lat: ride.pickupLat, lon: ride.pickupLon},
            {lat: ride.destLat, lon: ride.destLon},
            '#8b5cf6' // Lila fÃ¼r Fahrt
        );
        
    } else if (vehicle.status === 'picked_up') {
        // Ankunft am Ziel
        completeRide(vehicle, ride);
    }
    
    renderSimulator();
}

function completeRide(vehicle, ride) {
    ride.status = 'completed';
    vehicle.status = 'free';
    vehicle.currentRide = null;
    vehicle.routeData = null;
    
    // Route von Karte entfernen
    if (simRoutes[vehicle.id]) {
        simulatorMap.removeLayer(simRoutes[vehicle.id]);
        delete simRoutes[vehicle.id];
    }
    
    logSimEvent(`ğŸ‰ ${vehicle.name} hat Fahrt abgeschlossen!`);
    
    // ğŸ†• v5.90.560: ZURÃœCK ZUR BASIS!
    returnVehicleToBase(vehicle);
    
    renderSimulator();
}

// ğŸ†• v5.90.560: FAHRZEUG ZURÃœCK ZUR BASIS FAHREN
async function returnVehicleToBase(vehicle) {
    if (!vehicle.homeLat || !vehicle.homeLon) {
        console.log('âš ï¸ Fahrzeug hat keine Home-Position:', vehicle.name);
        return;
    }
    
    logSimEvent(`ğŸ  ${vehicle.name} fÃ¤hrt zurÃ¼ck nach ${vehicle.homeLocation}`);
    
    // Berechne Route zur Basis
    await calculateAndDrawRoute(
        vehicle, 
        {lat: vehicle.lat, lon: vehicle.lon}, 
        {lat: vehicle.homeLat, lon: vehicle.homeLon}, 
        '#10b981'  // GrÃ¼n fÃ¼r RÃ¼ckfahrt
    );
}

async function calculateAndDrawRoute(vehicle, from, to, color) {
    try {
        const url = `https://router.project-osrm.org/route/v1/driving/${from.lon},${from.lat};${to.lon},${to.lat}?overview=full&geometries=geojson`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.routes && data.routes[0]) {
            const route = data.routes[0];
            const coords = route.geometry.coordinates;
            
            // Speichere Route-Daten
            vehicle.routeData = {
                coords: coords,
                currentIndex: 0,
                distance: (route.distance / 1000).toFixed(1),
                duration: Math.round(route.duration / 60)
            };
            
            // Zeichne Route auf Karte
            if (simRoutes[vehicle.id]) {
                simulatorMap.removeLayer(simRoutes[vehicle.id]);
            }
            
            const latLngs = coords.map(c => [c[1], c[0]]);
            simRoutes[vehicle.id] = L.polyline(latLngs, {
                color: color,
                weight: 4,
                opacity: 0.7
            }).addTo(simulatorMap);
            
            logSimEvent(`ğŸ“ ${vehicle.name}: ${vehicle.routeData.distance}km, ${vehicle.routeData.duration} Min`);
        }
    } catch (error) {
        console.error('OSRM Fehler:', error);
        logSimEvent(`âš ï¸ Route-Berechnung fehlgeschlagen`);
    }
}

async function processSimRides() {
    for (let i = 0; i < simRides.length; i++) {
        const ride = simRides[i];
        
        if (ride.status === 'new' && ride.pickupTime <= simTime) {
            // Auto-Assign
            await runAutoAssignForRide(i);
        }
    }
}

async function runAutoAssignForRide(rideIndex) {
    const ride = simRides[rideIndex];
    if (!ride) return;
    
    logSimEvent(`ğŸ¯ Auto-Assign fÃ¼r ${ride.customerName}...`);
    
    const panel = document.getElementById('auto-assign-panel');
    const content = document.getElementById('auto-assign-content');
    panel.style.display = 'block';
    
    let html = '';
    
    // Finde beste Fahrzeuge
    const availableVehicles = simVehicles.filter(v => v.online && v.status === 'free');
    
    if (availableVehicles.length === 0) {
        logSimEvent(`âš ï¸ Keine freien Fahrzeuge!`);
        content.innerHTML = '<div style="color:#ef4444;">âŒ Keine Fahrzeuge verfÃ¼gbar!</div>';
        setTimeout(() => panel.style.display = 'none', 3000);
        return;
    }
    
    // Berechne Scores mit OSRM
    for (const v of availableVehicles) {
        const dist = calculateDistance(v.lat, v.lon, ride.pickupLat, ride.pickupLon);
        
        // Versuche OSRM (aber nicht blockierend)
        let drivingTime = Math.round(dist * 1.5); // Fallback
        
        try {
            const url = `https://router.project-osrm.org/route/v1/driving/${v.lon},${v.lat};${ride.pickupLon},${ride.pickupLat}?overview=false`;
            const response = await fetch(url);
            const data = await response.json();
            if (data.routes && data.routes[0]) {
                drivingTime = Math.round(data.routes[0].duration / 60);
            }
        } catch (e) {}
        
        v.assignScore = {
            distance: dist,
            drivingTime: drivingTime,
            score: 100 - (dist * 10) - (drivingTime * 0.5)
        };
        
        html += `<div style="padding:4px;margin-bottom:4px;background:#f9fafb;border-radius:4px;">
            <strong>${v.name}</strong>: ${dist.toFixed(1)}km, ${drivingTime} Min, Score: ${v.assignScore.score.toFixed(0)}
        </div>`;
        
        logSimEvent(`  ğŸ“Š ${v.name}: ${dist.toFixed(1)}km, ${drivingTime} Min, Score: ${v.assignScore.score.toFixed(0)}`);
    }
    
    // Best Vehicle
    const best = availableVehicles.sort((a, b) => b.assignScore.score - a.assignScore.score)[0];
    
    ride.status = 'assigned';
    ride.vehicleId = best.id;
    best.status = 'on_way';
    best.currentRide = ride;
    
    // Route berechnen und zeichnen
    await calculateAndDrawRoute(best, 
        {lat: best.lat, lon: best.lon},
        {lat: ride.pickupLat, lon: ride.pickupLon},
        '#10b981' // GrÃ¼n fÃ¼r Anfahrt
    );
    
    html += `<div style="margin-top:8px;padding:6px;background:#d1fae5;border-radius:4px;color:#065f46;font-weight:700;">âœ… ${best.name} zugewiesen!</div>`;
    content.innerHTML = html;
    
    logSimEvent(`âœ… ${best.name} zugewiesen!`);
    
    setTimeout(() => panel.style.display = 'none', 5000);
    renderSimulator();
}

// ğŸ†• v5.90.603: Wrapper fÃ¼r onclick (kann nicht direkt async sein)
function addSimRideSync() {
    addSimRide().catch(err => console.error('Fehler beim Erstellen der Fahrt:', err));
}

async function addSimRide() {
    const now = simTime;
    const pickupTime = now + (Math.random() * 20 + 5) * 60 * 1000;
    
    // ğŸ†• v5.90.569: ECHTE KUNDENNAMEN
    const customers = ['Marion Schmidt', 'Klaus MÃ¼ller', 'Anna Weber', 'Peter Fischer', 'Maria Wagner', 'Hans Becker', 'Lisa Hoffmann', 'Tom Schulz', 'Sabine Koch', 'Frank Meyer'];
    
    // ğŸ†• v5.90.603: ECHTE STRASSEN AUS NOMINATIM!
    const pickupAddr = await getRandomAddressFromNominatim();
    await new Promise(resolve => setTimeout(resolve, 300)); // Rate-Limit
    const destAddr = await getRandomAddressFromNominatim();
    
    simRides.push({
        customerName: customers[Math.floor(Math.random() * customers.length)],
        pickup: pickupAddr.name,
        pickupAddress: pickupAddr.address,
        destination: destAddr.name,
        destAddress: destAddr.address,
        pickupTime: pickupTime,
        pickupLat: pickupAddr.lat,
        pickupLon: pickupAddr.lon,
        destLat: destAddr.lat,
        destLon: destAddr.lon,
        status: 'new',
        vehicleId: null,
        distance: null,
        duration: null
    });
    
    logSimEvent(`â• Neue Fahrt: ${simRides[simRides.length-1].customerName} | ${pickupAddr.name} â†’ ${destAddr.name} (${new Date(pickupTime).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})})`);
    renderSimulator();
}

let rideGenActive = false;

function toggleRideGeneration() {
    rideGenActive = !rideGenActive;
    const btn = document.getElementById('ride-gen-btn');
    
    if (rideGenActive) {
        btn.textContent = 'â¸ Auto-Gen Stop';
        btn.style.background = '#ef4444';
        startRideGeneration();
    } else {
        btn.textContent = 'â–¶ Auto-Gen Start';
        btn.style.background = '#8b5cf6';
        if (rideGenerationInterval) {
            clearInterval(rideGenerationInterval);
        }
    }
}

function startRideGeneration() {
    const ridesPerHour = parseInt(document.getElementById('rides-per-hour').value) || 5;
    const interval = 3600000 / ridesPerHour;
    
    if (rideGenerationInterval) clearInterval(rideGenerationInterval);
    
    rideGenerationInterval = setInterval(async () => {
        if (simRunning && rideGenActive) {
            await addSimRide();
        }
    }, interval / simSpeed);
    
    logSimEvent(`ğŸš€ Auto-Gen: ${ridesPerHour} Fahrten/h`);
}

function completeSimRide(index) {
    const ride = simRides[index];
    const vehicle = simVehicles.find(v => v.id === ride.vehicleId);
    if (vehicle) {
        completeRide(vehicle, ride);
    } else {
        ride.status = 'completed';
        renderSimulator();
    }
}

function cancelSimRide(index) {
    const ride = simRides[index];
    const vehicle = simVehicles.find(v => v.id === ride.vehicleId);
    if (vehicle) {
        vehicle.status = 'free';
        vehicle.currentRide = null;
    }
    simRides.splice(index, 1);
    renderSimulator();
}

// ğŸ†• v5.90.604: Fahrt auf Karte anzeigen mit Route!
let rideMarkers = []; // Pickup + Destination Marker
let rideRouteLine = null; // Route-Linie

async function showRideOnMap(index) {
    const ride = simRides[index];
    if (!ride || !simulatorMap) return;
    
    // Entferne alte Marker + Route
    rideMarkers.forEach(m => simulatorMap.removeLayer(m));
    rideMarkers = [];
    if (rideRouteLine) {
        simulatorMap.removeLayer(rideRouteLine);
        rideRouteLine = null;
    }
    
    // ğŸ“ PICKUP MARKER (GrÃ¼n)
    const pickupMarker = L.marker([ride.pickupLat, ride.pickupLon], {
        icon: L.divIcon({
            className: 'custom-pin',
            html: '<div style="background:#10b981;width:32px;height:32px;border-radius:50% 50% 50% 0;transform:rotate(-45deg);border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.4);"><div style="transform:rotate(45deg);font-size:18px;text-align:center;line-height:26px;">ğŸ“</div></div>',
            iconSize: [32, 32],
            iconAnchor: [16, 32]
        })
    }).addTo(simulatorMap);
    
    pickupMarker.bindPopup('<div style="font-weight:700;color:#10b981;margin-bottom:4px;">ğŸ“ ABHOLORT</div><div style="font-size:11px;">' + ride.pickup + '</div><div style="font-size:10px;color:#666;margin-top:2px;">' + ride.pickupAddress + '</div>');
    
    rideMarkers.push(pickupMarker);
    
    // ğŸ¯ DESTINATION MARKER (Blau)
    const destMarker = L.marker([ride.destLat, ride.destLon], {
        icon: L.divIcon({
            className: 'custom-pin',
            html: '<div style="background:#3b82f6;width:32px;height:32px;border-radius:50% 50% 50% 0;transform:rotate(-45deg);border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.4);"><div style="transform:rotate(45deg);font-size:18px;text-align:center;line-height:26px;">ğŸ¯</div></div>',
            iconSize: [32, 32],
            iconAnchor: [16, 32]
        })
    }).addTo(simulatorMap);
    
    destMarker.bindPopup('<div style="font-weight:700;color:#3b82f6;margin-bottom:4px;">ğŸ¯ ZIEL</div><div style="font-size:11px;">' + ride.destination + '</div><div style="font-size:10px;color:#666;margin-top:2px;">' + ride.destAddress + '</div>');
    
    rideMarkers.push(destMarker);
    
    // ğŸ—ºï¸ ROUTE BERECHNEN (OSRM)
    try {
        const url = 'https://router.project-osrm.org/route/v1/driving/' + 
                    ride.pickupLon + ',' + ride.pickupLat + ';' + 
                    ride.destLon + ',' + ride.destLat + 
                    '?overview=full&geometries=geojson';
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.routes && data.routes[0]) {
            const route = data.routes[0];
            const coords = route.geometry.coordinates.map(c => [c[1], c[0]]); // [lon,lat] â†’ [lat,lon]
            const distance = (route.distance / 1000).toFixed(1);
            const duration = Math.round(route.duration / 60);
            
            // ğŸ“ ROUTE-LINIE (Lila)
            rideRouteLine = L.polyline(coords, {
                color: '#8b5cf6',
                weight: 4,
                opacity: 0.7,
                dashArray: '10, 5'
            }).addTo(simulatorMap);
            
            // Info-Popup auf Route
            const midpoint = coords[Math.floor(coords.length / 2)];
            L.popup()
                .setLatLng(midpoint)
                .setContent('<div style="text-align:center;font-weight:700;color:#8b5cf6;">ğŸ—ºï¸ ROUTE</div><div style="font-size:11px;margin-top:4px;">ğŸ“ ' + distance + ' km</div><div style="font-size:11px;">â±ï¸ ' + duration + ' Min</div>')
                .openOn(simulatorMap);
            
            // Speichere Distance/Duration auf Ride
            ride.distance = parseFloat(distance);
            ride.duration = duration;
            
            logSimEvent('ğŸ—ºï¸ Route ' + ride.pickup + ' â†’ ' + ride.destination + ': ' + distance + ' km, ' + duration + ' Min');
        }
    } catch (error) {
        console.warn('Route-Berechnung fehlgeschlagen:', error);
        logSimEvent('âš ï¸ Route-Berechnung Fehler');
    }
    
    // Zoom auf Route
    const bounds = L.latLngBounds([
        [ride.pickupLat, ride.pickupLon],
        [ride.destLat, ride.destLon]
    ]);
    simulatorMap.fitBounds(bounds, { padding: [50, 50] });
    
    renderSimulator(); // Update Distanz/Dauer Anzeige
}

function runAutoAssignNow() {
    simRides.forEach((ride, i) => {
        if (ride.status === 'new') {
            setTimeout(() => runAutoAssignForRide(i), i * 1000);
        }
    });
}

function toggleVehicleOnline(vehicleId) {
    const vehicle = simVehicles.find(v => v.id === vehicleId);
    if (vehicle) {
        vehicle.online = !vehicle.online;
        if (!vehicle.online) {
            vehicle.status = 'offline';
            vehicle.currentRide = null;
        } else {
            vehicle.status = 'free';
        }
        logSimEvent(`${vehicle.online ? 'ğŸŸ¢' : 'ğŸ”´'} ${vehicle.name} ${vehicle.online ? 'online' : 'offline'}`);
        renderSimulator();
    }
}

function moveVehicleRandom(vehicleId) {
    const v = simVehicles.find(veh => veh.id === vehicleId);
    if (v) {
        v.lat = 53.9 + Math.random() * 0.08;
        v.lon = 14.1 + Math.random() * 0.15;
        logSimEvent(`ğŸ“ ${v.name} bewegt`);
        renderSimulator();
    }
}

// ğŸ†• v5.90.560: MANUELL NACH HAUSE SCHICKEN
// ğŸ†• v5.90.604: Home-Standort setzen
function setSimVehicleHome(vehicleId) {
    const v = simVehicles.find(vehicle => vehicle.id === vehicleId);
    if (!v) return;
    
    const coords = prompt('ğŸ  Home-Standort (Format: Lat,Lon):\n\nBeispiele:\n- Heringsdorf Bahnhof: 53.9533, 14.1633\n- Ahlbeck SeebrÃ¼cke: 53.9444, 14.1933\n- Bansin SeebrÃ¼cke: 53.9633, 14.1433', (v.homeLat && v.homeLon) ? v.homeLat + ', ' + v.homeLon : v.lat + ', ' + v.lon);
    
    if (!coords) return;
    
    const parts = coords.split(',').map(p => p.trim());
    if (parts.length !== 2) {
        alert('âŒ UngÃ¼ltiges Format! Nutze: Lat,Lon');
        return;
    }
    
    const lat = parseFloat(parts[0]);
    const lon = parseFloat(parts[1]);
    
    if (isNaN(lat) || isNaN(lon)) {
        alert('âŒ UngÃ¼ltige Koordinaten!');
        return;
    }
    
    const locationName = prompt('ğŸ  Name fÃ¼r Home-Standort:', v.homeLocation || 'Basis');
    
    v.homeLat = lat;
    v.homeLon = lon;
    v.homeLocation = locationName || 'Basis';
    
    logSimEvent('ğŸ  ' + v.name + ' Home â†’ ' + locationName + ' (' + lat.toFixed(4) + ', ' + lon.toFixed(4) + ')');
    renderSimulator();
}

function sendVehicleHome(vehicleId) {
    const vehicle = simVehicles.find(v => v.id === vehicleId);
    if (!vehicle) return;
    
    if (!vehicle.homeLat || !vehicle.homeLon) {
        alert('âŒ Fahrzeug hat keine Home-Position!');
        return;
    }
    
    if (vehicle.currentRide) {
        alert('âš ï¸ Fahrzeug ist gerade auf einer Fahrt!');
        return;
    }
    
    returnVehicleToBase(vehicle);
    renderSimulator();
}

function addSimVehicle() {
    const name = prompt('Fahrzeugname:', 'Taxi ' + (simVehicles.length + 1));
    if (!name) return;
    
    const startLat = 53.93 + Math.random() * 0.05;
    const startLon = 14.12 + Math.random() * 0.12;
    
    simVehicles.push({
        id: 'sim-' + Date.now(),
        name: name,
        lat: startLat,
        lon: startLon,
        homeLat: startLat,  // ğŸ†• v5.90.560: Home = Start!
        homeLon: startLon,
        homeLocation: 'Start-Position',
        status: 'free',
        online: true,
        marker: null,
        currentRide: null,
        routeData: null
    });
    
    logSimEvent(`â• Fahrzeug: ${name}`);
    renderSimulator();
}

function simRewind() {
    simTime -= 3600000;
    logSimEvent('â—€â—€ -1h');
    renderSimulator();
}

function simForward() {
    simTime += 3600000;
    logSimEvent('â–¶â–¶ +1h');
    renderSimulator();
}

function updateSimSpeed() {
    simSpeed = parseInt(document.getElementById('sim-speed').value);
    const badge = document.getElementById('sim-status-badge');
    if (simRunning) {
        badge.textContent = 'â–¶ LÃ¤uft (' + simSpeed + 'x)';
    }
    logSimEvent(`âš¡ Speed: ${simSpeed}x`);
}

function resetSimulation() {
    if (!confirm('Simulation zurÃ¼cksetzen?')) return;
    
    simTime = Date.now();
    simRides = [];
    simEventLog = [];
    
    // Clear routes
    Object.values(simRoutes).forEach(r => simulatorMap.removeLayer(r));
    simRoutes = {};
    
    loadInitialVehicles();
    

// ğŸ†• v5.90.565: FAHRZEUG-KOORDINATEN EDITIEREN
function editSimVehicle(vehicleId) {
    const v = simVehicles.find(vehicle => vehicle.id === vehicleId);
    if (!v) return;
    
    const coords = prompt(`Koordinaten fÃ¼r "${v.name}" (Format: Lat,Lon):\n\nBeispiele:\n- Heringsdorf Bahnhof: 53.9533, 14.1633\n- Ahlbeck SeebrÃ¼cke: 53.9444, 14.1933\n- Bansin SeebrÃ¼cke: 53.9633, 14.1433`, `${v.lat}, ${v.lon}`);
    
    if (!coords) return;
    
    const parts = coords.split(',').map(p => p.trim());
    if (parts.length !== 2) {
        alert('âŒ UngÃ¼ltiges Format! Nutze: Lat,Lon (z.B. 53.9547, 14.1783)');
        return;
    }
    
    const lat = parseFloat(parts[0]);
    const lon = parseFloat(parts[1]);
    
    if (isNaN(lat) || isNaN(lon) || lat < 53.8 || lat > 54.1 || lon < 13.9 || lon > 14.4) {
        alert('âŒ Koordinaten auÃŸerhalb von Usedom! (53.8-54.1 N, 13.9-14.4 E)');
        return;
    }
    
    v.lat = lat;
    v.lon = lon;
    v.homeLat = lat;
    v.homeLon = lon;
    
    logSimEvent(`âœï¸ ${v.name} â†’ ${lat.toFixed(4)}, ${lon.toFixed(4)}`);
    renderSimulator();
    
    if (simulatorMap && v.marker) {
        simulatorMap.setView([lat, lon], 16);
    }
}
    if (simRunning) toggleSimulation();
    if (rideGenerationInterval) clearInterval(rideGenerationInterval);
    rideGenActive = false;
    
    logSimEvent('ğŸ”„ Simulation zurÃ¼ckgesetzt');
    renderSimulator();
}

function createRushHourScenario() {
    logSimEvent('ğŸš¦ Rush Hour Szenario wird erstellt...');
    
    // Erstelle 10 Fahrten in den nÃ¤chsten 15 Minuten
    for (let i = 0; i < 10; i++) {
        setTimeout(async () => await addSimRide(), i * 500); // 500ms fÃ¼r Nominatim Rate-Limit
    }
    
    logSimEvent('âœ… 10 Fahrten erstellt!');
}

function exportSimulation() {
    const data = {
        time: simTime,
        vehicles: simVehicles.map(v => ({...v, marker: null, routeData: null})),
        rides: simRides
    };
    
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `simulation-${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    
    logSimEvent('ğŸ’¾ Szenario exportiert');
}

function clearSimLog() {
    simEventLog = [];
    renderEventLog();
}

function logSimEvent(message) {
    const time = new Date(simTime).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
    simEventLog.push(`[${time}] ${message}`);
    renderEventLog();
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

console.log('âœ… v5.90.556: Perfekter Taxi-Simulator mit OSRM geladen!');

// ğŸ†• v5.90.574: LÃ¶schen-Buttons fÃ¼r Abholort/Zielort
function toggleClearButton(fieldId) {
    const field = document.getElementById(fieldId);
    const btn = document.getElementById(`clear-${fieldId}-btn`);
    
    if (field && btn) {
        btn.style.display = field.value.trim() ? "block" : "none";
    }
}

function clearField(fieldId) {
    const field = document.getElementById(fieldId);
    if (field) {
        field.value = "";
        toggleClearButton(fieldId);
        field.focus();
        
        // ğŸ†• v5.90.580: Bei Waypoints auch Daten lÃ¶schen!
        if (fieldId.startsWith('waypoint-')) {
            const waypointId = parseInt(fieldId.split('-')[1]);
            const waypoint = waypoints.find(w => w.id === waypointId);
            if (waypoint) {
                waypoint.address = '';
                waypoint.coords = null;
                console.log('ğŸ—‘ï¸ v5.90.580: Waypoint gelÃ¶scht:', waypointId);
            }
        }
        
        // ğŸ†• v5.90.641: Nach LÃ¶schen Slot-Check aktualisieren!
        if (fieldId === 'pickup' || fieldId === 'destination') {
            triggerSlotCheck();
        }
    }
}
    </script>


<!-- ğŸ†• v5.90.206: SCHWEBENDES SCHNELLBUCHUNGS-MODAL -->
<div id="floating-quick-booking" style="display:none;position:fixed;top:80px;right:20px;width:380px;background:white;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.3);z-index:99999;max-height:calc(100vh - 100px);overflow-y:auto;">
    <!-- Header (DRAG & DROP!) -->
    <div id="fqb-header" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:15px;border-radius:12px 12px 0 0;cursor:move;user-select:none;display:flex;justify-content:space-between;align-items:center;">
        <div style="display:flex;align-items:center;gap:10px;">
            <span style="font-size:18px;">â‹®â‹®</span>
            <span style="font-weight:700;font-size:16px;">ğŸ’³ SCHNELLBUCHUNG</span>
        </div>
        <button onclick="closeFloatingQuickBooking()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:18px;font-weight:bold;">Ã—</button>
    </div>
    
    <!-- Content -->
    <div style="padding:20px;">
        <!-- Kunde -->
        <div style="margin-bottom:15px;">
            <label style="display:block;font-weight:600;margin-bottom:8px;color:#374151;">ğŸ’¾ Kunde</label>
            <div style="position:relative;">
                <input 
                    type="text" 
                    id="fqb-customer-search" 
                    placeholder="ğŸ” Name oder Telefon suchen..." 
                    oninput="liveSearchCustomers()"
                    style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;">
                
                <!-- ğŸ†• v5.90.208: DROPDOWN MIT KUNDEN -->
                <div id="fqb-customer-dropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:white;border:2px solid #3b82f6;border-radius:8px;max-height:200px;overflow-y:auto;z-index:1000;margin-top:4px;box-shadow:0 4px 12px rgba(0,0,0,0.15);"></div>
            </div>
            
            <div id="fqb-customer-info" style="display:none;margin-top:8px;padding:10px;background:#f0fdf4;border:2px solid #10b981;border-radius:8px;font-size:13px;"></div>
            <button id="fqb-new-customer-btn" onclick="createNewCustomerInBooking()" style="display:none;margin-top:8px;width:100%;padding:10px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                â• Neuer Kunde
            </button>
        </div>
        
        <!-- Abholort -->
        <div style="margin-bottom:15px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <label style="font-weight:600;color:#374151;">ğŸ“ Abholort</label>
                <button onclick="swapAddresses()" style="background:#f59e0b;color:white;border:none;border-radius:6px;padding:6px 12px;font-size:12px;font-weight:600;cursor:pointer;">
                    ğŸ”„ Tauschen
                </button>
            </div>
            <div style="position:relative;">
                <div id="fqb-pickup-display" style="padding:10px;background:#f9fafb;border:2px solid #e5e7eb;border-radius:8px;font-size:13px;color:#6b7280;">
                    Warte auf Karte...
                </div>
                <button id="fqb-pickup-clear" onclick="clearPickupAddress()" style="display:none;position:absolute;top:8px;right:8px;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;font-size:11px;cursor:pointer;">
                    ğŸ’¾
                </button>
            </div>
        </div>
        
        <!-- Zielort -->
        <div style="margin-bottom:15px;">
            <label style="display:block;font-weight:600;margin-bottom:8px;color:#374151;">ğŸ¯ Zielort</label>
            <div style="position:relative;">
                <div id="fqb-destination-display" style="padding:10px;background:#f9fafb;border:2px solid #e5e7eb;border-radius:8px;font-size:13px;color:#6b7280;">
                    Warte auf Karte...
                </div>
                <button id="fqb-destination-clear" onclick="clearDestinationAddress()" style="display:none;position:absolute;top:8px;right:8px;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;font-size:11px;cursor:pointer;">
                    ğŸ’¾
                </button>
            </div>
        </div>
        
        <!-- Distanz + Zeit -->
        <div id="fqb-route-info" style="display:none;margin-bottom:15px;display:flex;gap:10px;">
            <div style="flex:1;background:#f3f4f6;padding:8px;border-radius:6px;text-align:center;font-size:12px;">
                ğŸ“ <strong id="fqb-distance">-</strong> km
            </div>
            <div style="flex:1;background:#f3f4f6;padding:8px;border-radius:6px;text-align:center;font-size:12px;">
                â±ï¸ <strong id="fqb-duration">-</strong> Min
            </div>
        </div>
        
        <!-- Preis -->
        <div style="margin-bottom:15px;">
            <label style="display:block;font-weight:600;margin-bottom:8px;color:#374151;">ğŸ’° Preis</label>
            <div id="fqb-price-display" style="padding:12px;background:linear-gradient(135deg,#10b981,#059669);color:white;border-radius:8px;text-align:center;font-size:18px;font-weight:700;">
                -,-- â‚¬
            </div>
        </div>
        
        <!-- Datum -->
        <div style="margin-bottom:15px;">
            <label style="display:block;font-weight:600;margin-bottom:8px;color:#374151;">ğŸ“… Datum</label>
            <input type="date" id="fqb-date" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;">
        </div>
        
        <!-- Zeit -->
        <div style="margin-bottom:15px;">
            <label style="display:block;font-weight:600;margin-bottom:8px;color:#374151;">ğŸ• Uhrzeit</label>
            <div style="display:flex;gap:8px;margin-bottom:8px;">
                <button onclick="setFQBTimeNow()" style="flex:1;padding:10px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;">
                    JETZT
                </button>
                <button onclick="setFQBTimePlus30()" style="flex:1;padding:10px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;">
                    +30 MIN
                </button>
            </div>
            <!-- ğŸ†• v5.90.210: WHATSAPP-STYLE ZEIT! -->
            <div style="display:flex;gap:8px;align-items:center;">
                <input type="number" id="fqb-time-hours" min="0" max="23" placeholder="HH" class="whatsapp-time-input" style="width:60px;padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:16px;text-align:center;font-weight:600;">
                <span style="font-size:20px;font-weight:700;color:#6b7280;">:</span>
                <input type="number" id="fqb-time-minutes" min="0" max="59" placeholder="MM" class="whatsapp-time-input" style="width:60px;padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:16px;text-align:center;font-weight:600;">
            </div>
        </div>
        
        <!-- ğŸ†• v5.90.222: PERSONEN & FAHRZEUG -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px;">
            <div>
                <label style="display:block;font-weight:600;margin-bottom:8px;color:#374151;font-size:13px;">ğŸ‘¥ Personen</label>
                <select id="fqb-passengers" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:13px;box-sizing:border-box;">
                    <option value="1">1 Person</option>
                    <option value="2">2 Personen</option>
                    <option value="3">3 Personen</option>
                    <option value="4">4 Personen</option>
                    <option value="5">5+ Personen</option>
                </select>
            </div>
            <div>
                <label style="display:block;font-weight:600;margin-bottom:8px;color:#374151;font-size:13px;">ğŸš— Fahrzeug</label>
                <select id="fqb-vehicle" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:13px;box-sizing:border-box;">
                    <option value="">Automatisch</option>
                </select>
            </div>
        </div>
        
        <!-- ğŸ†• v5.90.222: PREIS-BERECHNUNG -->
        <div style="margin-bottom:15px;background:#dbeafe;border:2px solid #3b82f6;border-radius:8px;padding:10px;">
            <div style="font-weight:600;margin-bottom:6px;color:#1e40af;font-size:13px;">ğŸ’° Preis-Berechnung:</div>
            <div style="display:flex;flex-direction:column;gap:4px;">
                <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px;">
                    <input type="radio" name="fqb-price-mode" value="taxi" checked style="width:14px;height:14px;">
                    <span>ğŸš• Taxipreis berechnen</span>
                </label>
                <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px;">
                    <input type="radio" name="fqb-price-mode" value="medical" style="width:14px;height:14px;">
                    <span>ğŸš‘ Krankenfahrt (kein Preis)</span>
                </label>
            </div>
        </div>
        
        <!-- ğŸ†• v5.90.222: FAHRTDAUER -->
        <div style="margin-bottom:15px;background:#e0e7ff;border:2px solid #6366f1;border-radius:8px;padding:10px;">
            <div style="font-weight:600;margin-bottom:6px;color:#4338ca;font-size:13px;">â±ï¸ Fahrtdauer:</div>
            <div style="display:flex;flex-direction:column;gap:4px;">
                <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px;">
                    <input type="radio" name="fqb-duration-mode" value="auto" checked style="width:14px;height:14px;">
                    <span>ğŸ—ºï¸ Aus Distanz berechnen</span>
                </label>
                <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px;">
                    <input type="radio" name="fqb-duration-mode" value="fixed" style="width:14px;height:14px;">
                    <span>â±ï¸ Feste Zeit (15 Min)</span>
                </label>
            </div>
        </div>
        
        <!-- Notiz -->
        <div style="margin-bottom:15px;">
            <label style="display:block;font-weight:600;margin-bottom:8px;color:#374151;">ğŸ’¬ Notiz (optional)</label>
            <textarea id="fqb-notes" placeholder="z.B. 2 Personen, Kindersitz, Rollstuhl..." style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:13px;min-height:60px;resize:vertical;"></textarea>
        </div>
        
        <!-- Buchen Button -->
        <button onclick="submitFloatingQuickBooking()" style="width:100%;padding:15px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:16px;box-shadow:0 4px 12px rgba(102,126,234,0.4);">
            ğŸš• JETZT BUCHEN
        </button>
    </div>
</div>

<!-- ğŸ†• v5.90.227: ANRUF-FAVORITEN FLOATING BUTTON -->
<!-- ğŸ†• v5.90.259: TESLA-STYLE ANRUF-DROPDOWN! -->
<!-- ğŸ†• v5.90.297: Versteckt bei Fahrer! -->
<!-- ğŸ†• v5.90.525: KLEIN & RECHTS UNTEN! -->
<div id="call-favorites-fab" class="admin-only" style="position:fixed;bottom:20px;left:20px;z-index:9998;display:block;">
    <button id="tesla-call-btn" onclick="toggleTeslaCallDropdown()" style="
        width:65px;
        height:65px;
        background:linear-gradient(135deg,#10b981,#059669);
        color:white;
        border:none;
        border-radius:50%;
        box-shadow:0 4px 20px rgba(16,185,129,0.5);
        cursor:pointer;
        font-size:32px;
        display:flex;
        align-items:center;
        justify-content:center;
        transition:all 0.2s;
    " onmouseover="this.style.transform='scale(1.1)';this.style.boxShadow='0 6px 25px rgba(16,185,129,0.7)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 4px 20px rgba(16,185,129,0.5)'">
        ğŸ“±
    </button>
</div>

<!-- ğŸ†• v5.90.259: TESLA DROPDOWN (Ã¶ffnet nach OBEN!) -->
<div id="tesla-call-dropdown" style="
    display:none;
    position:fixed;
    bottom:95px;
    left:20px;
    width:240px;
    max-height:calc(100vh - 140px);
    background:white;
    border-radius:12px;
    border:2px solid #10b981;
    box-shadow:0 8px 32px rgba(0,0,0,0.3);
    z-index:9997;
    overflow:hidden;
    animation:slideUp 0.2s ease-out;
">
    <div id="tesla-call-list" style="padding:10px;max-height:400px;overflow-y:auto;">
        <!-- Wird dynamisch gefÃ¼llt -->
    </div>
</div>

<style>
@keyframes slideUp {
    from {
        transform:translateY(100%);
        opacity:0;
    }
    to {
        transform:translateY(0);
        opacity:1;
    }
}

/* Tesla Touch-Optimierung */
#tesla-call-dropdown * {
    -webkit-tap-highlight-color:transparent;
}
</style>

<!-- ğŸ†• v5.90.243: ANRUF-ZENTRALE MODAL -->
<div id="call-favorites-modal" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:450px;background:white;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.3);z-index:9999;max-height:90vh;overflow:hidden;">
    <!-- Header -->
    <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:20px;display:flex;justify-content:space-between;align-items:center;">
        <h3 style="margin:0;font-size:18px;font-weight:700;">ğŸ’¾ Anruf-Zentrale</h3>
        <button onclick="toggleCallFavorites()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:20px;font-weight:bold;">Ã—</button>
    </div>
    
    <!-- Content -->
    <div id="call-favorites-list" style="padding:15px;max-height:65vh;overflow-y:auto;">
        <!-- Wird dynamisch gefÃ¼llt -->
    </div>
    
    <!-- Add Button -->
    <div style="padding:15px;border-top:2px solid #e5e7eb;background:#f9fafb;display:flex;gap:10px;">
        <button onclick="addCallFavoriteFromCRM()" style="flex:1;padding:12px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;transition:all 0.2s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
            ğŸ‘¥ Aus CRM
        </button>
        <button onclick="addCallFavorite()" style="flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;transition:all 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
            â• Manuell
        </button></div>
</div>


<!-- ğŸ†• v5.90.531: VERSION FOOTER -->
<div style="position: fixed; bottom: 5px; right: 10px; z-index: 99999; pointer-events: none;">
    <div style="background: rgba(0,0,0,0.6); color: white; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 600; backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
        ğŸš¨ v5.90.659
    </div>
</div>

<script>
// ğŸ†• v5.90.592: Diagnose-Button hinzufÃ¼gen
function addDiagnosticButton() {
    const existingBtn = document.getElementById('diagnostic-btn');
    if (existingBtn) return;
    
    const btn = document.createElement('button');
    btn.id = 'diagnostic-btn';
    btn.innerHTML = 'ğŸ”';
    btn.title = 'Diagnose Ã¶ffnen';
    btn.style = `
        position: fixed;
        bottom: 80px;
        right: 10px;
        z-index: 9999;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        border: none;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(59,130,246,0.4);
        display: none;
    `;
    btn.onclick = () => showDiagnosticDashboard();
    document.body.appendChild(btn);
    
    // Zeige nur im Fahrer-View
    const observer = new MutationObserver(() => {
        const driverView = document.getElementById('driver-view');
        if (driverView && driverView.style.display !== 'none') {
            btn.style.display = 'block';
        } else {
            btn.style.display = 'none';
        }
    });
    
    observer.observe(document.body, { 
        childList: true, 
        subtree: true, 
        attributes: true, 
        attributeFilter: ['style'] 
    });
}

// FÃ¼ge Button hinzu sobald DOM ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', addDiagnosticButton);
} else {
    addDiagnosticButton();
}
</script>

</body>
</html>
