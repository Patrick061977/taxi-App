<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Funk Taxi Heringsdorf</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 22px; margin-bottom: 5px; }
        .sync-indicator { display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 11px; margin-top: 5px; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #f59e0b; }
        .sync-dot.online { background: #10b981; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .view-selector { display: flex; background: white; border-bottom: 2px solid #e0e0e0; position: sticky; top: 90px; z-index: 99; }
        .view-btn { flex: 1; padding: 15px; border: none; background: white; font-size: 14px; cursor: pointer; position: relative; }
        .view-btn.active { color: #667eea; border-bottom: 3px solid #667eea; }
        .view { display: none; padding: 15px; padding-bottom: 100px; }
        .view.active { display: block; }
        .input-group { margin-bottom: 15px; position: relative; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .input-group input, .input-group select { width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; }
        .autocomplete-dropdown { position: absolute; background: white; border: 2px solid #667eea; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; display: none; z-index: 1000; width: 100%; }
        .autocomplete-dropdown.show { display: block; }
        .autocomplete-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .autocomplete-item:hover { background: #f5f3ff; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 10px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .price-display { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #10b981; border-radius: 12px; padding: 20px; margin: 20px 0; text-align: center; }
        .price-display .price { font-size: 36px; font-weight: bold; color: #047857; }
        .available-taxis { background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 12px; padding: 15px; margin: 15px 0; }
        .available-taxis h3 { color: #1e40af; margin-bottom: 10px; }
        .taxi-item { background: white; padding: 12px; border-radius: 8px; margin: 8px 0; border-left: 4px solid #10b981; }
        .ride-card { background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .alert-success { background: #d1fae5; color: #065f46; border: 2px solid #10b981; }
        .alert-info { background: #dbeafe; color: #1e40af; border: 2px solid #3b82f6; }
        .online-toggle { background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .toggle-switch { position: relative; width: 60px; height: 30px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; border-radius: 30px; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; border-radius: 50%; transition: .4s; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(30px); }
        #map { height: 300px; border-radius: 12px; margin: 15px 0; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöï Funk Taxi Heringsdorf</h1>
        <p style="font-size: 11px; opacity: 0.8;">Version 2.4 - Live Taxis</p>
        <div class="sync-indicator">
            <div class="sync-dot" id="sync-dot"></div>
            <span id="sync-status">Starte...</span>
        </div>
    </div>

    <div class="view-selector">
        <button class="view-btn active" onclick="switchView('passenger')">Fahrgast</button>
        <button class="view-btn" onclick="switchView('driver')">Fahrer</button>
        <button class="view-btn" onclick="switchView('admin')">Admin</button>
    </div>

    <div id="passenger-view" class="view active">
        <h3 style="margin: 20px 0;">Neue Fahrt buchen</h3>
        
        <div id="available-taxis-display"></div>

        <div class="input-group">
            <label>üìç Abholort</label>
            <input type="text" id="pickup" placeholder="z.B. Bahnhof Heringsdorf">
            <div class="autocomplete-dropdown" id="pickup-dropdown"></div>
        </div>
        <div class="input-group">
            <label>üéØ Zielort</label>
            <input type="text" id="destination" placeholder="z.B. Seebr√ºcke Ahlbeck">
            <div class="autocomplete-dropdown" id="destination-dropdown"></div>
        </div>
        <div class="input-group">
            <label>üë• Personen</label>
            <select id="passengers">
                <option value="1">1 Person</option>
                <option value="2">2 Personen</option>
                <option value="3">3 Personen</option>
                <option value="4">4 Personen</option>
            </select>
        </div>
        <button class="btn btn-primary" onclick="calcPrice()">üí∞ Preis berechnen</button>
        <div id="price-result"></div>
        <button id="book-btn" class="btn btn-success" style="display: none;" onclick="book()">üöï JETZT BUCHEN</button>
        <div id="confirm"></div>
        <div id="passenger-map-container" style="display: none;">
            <h3>Dein Taxi</h3>
            <div id="map"></div>
            <div id="eta-info"></div>
        </div>
    </div>

    <div id="driver-view" class="view">
        <h3 style="margin: 20px 0;">Fahrer Dashboard</h3>
        
        <div class="online-toggle">
            <div>
                <strong id="online-status-text">Offline</strong><br>
                <small>GPS-Tracking</small>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" id="online-toggle" onchange="toggleOnline()">
                <span class="slider"></span>
            </label>
        </div>

        <div class="input-group">
            <label>üöó Fahrzeug</label>
            <select id="vehicle" onchange="setVehicle()">
                <option value="">-- W√§hlen --</option>
                <option value="Tesla Model 3 #1">Tesla Model 3 #1</option>
                <option value="Tesla Model 3 #2">Tesla Model 3 #2</option>
                <option value="Tesla Model Y #1">Tesla Model Y #1</option>
            </select>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card"><div style="font-size: 28px;" id="d-rides">0</div><div>Fahrten</div></div>
            <div class="stat-card"><div style="font-size: 28px;" id="d-money">0‚Ç¨</div><div>Verdienst</div></div>
        </div>
        
        <div id="driver-current-ride"></div>
        <h3>Neue Auftr√§ge</h3>
        <div id="new-rides"></div>
    </div>

    <div id="admin-view" class="view">
        <h3 style="margin: 20px 0;">Dashboard</h3>
        <div class="stats-grid">
            <div class="stat-card"><div style="font-size: 28px;" id="a-total">0</div><div>Fahrten</div></div>
            <div class="stat-card"><div style="font-size: 28px;" id="a-revenue">0‚Ç¨</div><div>Umsatz</div></div>
            <div class="stat-card"><div style="font-size: 28px;" id="a-pending">0</div><div>Offen</div></div>
            <div class="stat-card"><div style="font-size: 28px;" id="a-active">0</div><div>Aktiv</div></div>
        </div>
        <h3>Alle Fahrten</h3>
        <div id="all-rides"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let firebaseLoadTimeout, firebaseLoaded = false;
        firebaseLoadTimeout = setTimeout(() => { if (!firebaseLoaded) initApp(false); }, 5000);
    </script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js" onload="firebaseLoaded = true;" onerror="initApp(false);"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script>
        console.log('üöÄ Version 2.4 - Live Taxis');
        const TARIF = { grundgebuehr: 4.00, kmPreis: 2.20, nachtZuschlag: 0.20, sonntagZuschlag: 0.25, feiertagZuschlag: 0.50 };
        let db, isFirebaseReady = false, isConnected = false, currentVehicle = null, currentView = 'passenger', rides = [], drivers = {};
        let pickupCoords = null, destCoords = null, map = null, watchId = null, isOnline = false;

        function setupAutocomplete() {
            ['pickup', 'destination'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => handleAutocomplete(e.target, id + '-dropdown'));
            });
        }

        function handleAutocomplete(input, dropdownId) {
            const query = input.value.trim(), dropdown = document.getElementById(dropdownId);
            if (query.length < 3) { dropdown.classList.remove('show'); return; }
            dropdown.innerHTML = '<div style="padding:12px;">Suche...</div>';
            dropdown.classList.add('show');
            setTimeout(async () => {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&viewbox=13.7,53.9,14.2,54.1&bounded=1&limit=5`);
                    const results = await res.json();
                    if (results.length === 0) { dropdown.innerHTML = '<div style="padding:12px;">Keine Ergebnisse</div>'; return; }
                    dropdown.innerHTML = results.map(r => `<div class="autocomplete-item" onclick='selectLocation(${JSON.stringify(r)}, "${dropdownId}")'>${r.display_name.split(',').slice(0,2).join(',')}</div>`).join('');
                } catch (e) { dropdown.innerHTML = '<div style="padding:12px;">Fehler</div>'; }
            }, 500);
        }

        function selectLocation(loc, dropdownId) {
            const inputId = dropdownId.replace('-dropdown', '');
            document.getElementById(inputId).value = loc.display_name.split(',').slice(0,2).join(',');
            if (inputId === 'pickup') pickupCoords = { lat: parseFloat(loc.lat), lon: parseFloat(loc.lon) };
            else destCoords = { lat: parseFloat(loc.lat), lon: parseFloat(loc.lon) };
            document.querySelectorAll('.autocomplete-dropdown').forEach(d => d.classList.remove('show'));
        }

        async function calculateRoute(from, to) {
            try {
                const res = await fetch(`https://router.project-osrm.org/route/v1/driving/${from.lon},${from.lat};${to.lon},${to.lat}?overview=false`);
                const data = await res.json();
                if (data.code !== 'Ok') throw new Error();
                return { distance: parseFloat((data.routes[0].distance / 1000).toFixed(1)), duration: Math.round(data.routes[0].duration / 60) };
            } catch {
                const R = 6371, dLat = (to.lat - from.lat) * Math.PI / 180, dLon = (to.lon - from.lon) * Math.PI / 180;
                const a = Math.sin(dLat/2)**2 + Math.cos(from.lat * Math.PI / 180) * Math.cos(to.lat * Math.PI / 180) * Math.sin(dLon/2)**2;
                const dist = R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return { distance: parseFloat(dist.toFixed(1)), duration: Math.round(dist / 0.5 * 60) };
            }
        }

        function calculatePrice(distance) {
            const now = new Date(), hour = now.getHours(), day = now.getDay();
            let base = TARIF.grundgebuehr + distance * TARIF.kmPreis, zuschlag = 0, text = [];
            if (hour >= 22 || hour < 6) { zuschlag += base * TARIF.nachtZuschlag; text.push('Nacht +20%'); }
            if (day === 0) { zuschlag += base * TARIF.sonntagZuschlag; text.push('Sonntag +25%'); }
            return { total: (base + zuschlag).toFixed(2), zuschlagText: text, distance };
        }

        async function calcPrice() {
            if (!pickupCoords || !destCoords) { alert('‚ùå Bitte Orte aus Dropdown w√§hlen!'); return; }
            document.getElementById('price-result').innerHTML = '<div class="alert-info">Berechne...</div>';
            const route = await calculateRoute(pickupCoords, destCoords);
            const pricing = calculatePrice(route.distance);
            window.currentPrice = pricing.total;
            window.currentDistance = route.distance;
            window.currentDuration = route.duration;
            document.getElementById('price-result').innerHTML = `<div class="price-display"><div class="price">${pricing.total}‚Ç¨</div><div style="margin-top:10px;font-size:13px;color:#059669;">üìç ${route.distance} km ‚Ä¢ ‚è±Ô∏è ${route.duration} Min</div></div>`;
            document.getElementById('book-btn').style.display = 'block';
        }

        async function book() {
            const ride = {
                id: Date.now(),
                pickup: document.getElementById('pickup').value,
                destination: document.getElementById('destination').value,
                passengers: document.getElementById('passengers').value,
                price: window.currentPrice,
                distance: window.currentDistance,
                duration: window.currentDuration,
                pickupCoords, destCoords,
                status: 'new',
                time: new Date().toLocaleString('de-DE'),
                createdAt: Date.now()
            };
            await saveRide(ride);
            document.getElementById('confirm').innerHTML = '<div class="alert-success"><strong>‚úì Buchung erfolgreich!</strong><br>Fahrt-ID: #' + ride.id + '</div>';
            document.getElementById('pickup').value = '';
            document.getElementById('destination').value = '';
            document.getElementById('price-result').innerHTML = '';
            document.getElementById('book-btn').style.display = 'none';
            setTimeout(() => document.getElementById('confirm').innerHTML = '', 5000);
        }

        function toggleOnline() {
            isOnline = document.getElementById('online-toggle').checked;
            document.getElementById('online-status-text').textContent = isOnline ? 'Online' : 'Offline';
            document.getElementById('online-status-text').style.color = isOnline ? '#10b981' : '#666';
            if (isOnline && currentVehicle) startDriverTracking(null);
            else stopDriverTracking();
        }

        function startDriverTracking(rideId) {
            if (!navigator.geolocation || !currentVehicle) return;
            watchId = navigator.geolocation.watchPosition((pos) => {
                const location = { lat: pos.coords.latitude, lon: pos.coords.longitude, timestamp: Date.now(), vehicle: currentVehicle, online: isOnline };
                if (isFirebaseReady) db.ref('drivers/' + currentVehicle.replace(/[^a-zA-Z0-9]/g, '_')).set(location);
            }, null, { enableHighAccuracy: true, maximumAge: 10000 });
        }

        function stopDriverTracking() {
            if (watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; }
            if (isFirebaseReady && currentVehicle) db.ref('drivers/' + currentVehicle.replace(/[^a-zA-Z0-9]/g, '_')).remove();
        }

        async function showAvailableTaxis() {
            if (!pickupCoords || !isFirebaseReady) return;
            const onlineDrivers = Object.values(drivers).filter(d => d.online);
            if (onlineDrivers.length === 0) {
                document.getElementById('available-taxis-display').innerHTML = '<div class="alert-info">Keine Taxis verf√ºgbar</div>';
                return;
            }
            const taxisWithETA = await Promise.all(onlineDrivers.map(async (d) => {
                const route = await calculateRoute(d, pickupCoords);
                return { ...d, ...route };
            }));
            taxisWithETA.sort((a, b) => a.distance - b.distance);
            const html = `<div class="available-taxis"><h3>üöï ${taxisWithETA.length} Taxis verf√ºgbar</h3>` +
                taxisWithETA.slice(0, 3).map(t => `<div class="taxi-item"><strong>${t.vehicle}</strong><br>üìç ${t.distance} km entfernt (ca. ${t.duration} Min)</div>`).join('') +
                `<div style="margin-top:10px;padding:10px;background:#e0f2fe;border-radius:8px;text-align:center;"><strong>N√§chstes Taxi in ca. ${taxisWithETA[0].duration} Minuten!</strong></div></div>`;
            document.getElementById('available-taxis-display').innerHTML = html;
        }

        function setVehicle() {
            currentVehicle = document.getElementById('vehicle').value;
            if (currentVehicle && isOnline) startDriverTracking(null);
        }

        async function acceptRide(rideId) {
            if (!currentVehicle) { alert('‚ùå Bitte Fahrzeug w√§hlen!'); return; }
            await updateRide(rideId, { status: 'accepted', vehicle: currentVehicle, driver: currentVehicle });
            alert('‚úÖ Auftrag angenommen!');
        }

        async function completeRide(rideId) {
            await updateRide(rideId, { status: 'completed' });
            alert('‚úÖ Fahrt abgeschlossen!');
        }

        function initApp(hasFirebase) {
            clearTimeout(firebaseLoadTimeout);
            if (hasFirebase && typeof firebase !== 'undefined') {
                try {
                    firebase.initializeApp({
                        apiKey: "AIzaSyD2eHFuplImxBCijd3MWlKyCwXUZHLmhhE",
                        authDomain: "taxi-heringsdorf.firebaseapp.com",
                        databaseURL: "https://taxi-heringsdorf-default-rtdb.europe-west1.firebasedatabase.app",
                        projectId: "taxi-heringsdorf",
                        storageBucket: "taxi-heringsdorf.firebasestorage.app",
                        messagingSenderId: "886448081276",
                        appId: "1:886448081276:web:1b54875801c5d89f8efcf9"
                    });
                    db = firebase.database();
                    isFirebaseReady = true;
                    db.ref('.info/connected').on('value', (s) => { isConnected = s.val(); updateStatus(); });
                    db.ref('rides').on('value', (s) => { rides = []; s.forEach(c => { const r = c.val(); r.firebaseId = c.key; rides.push(r); }); updateViews(); });
                    db.ref('drivers').on('value', (s) => { drivers = {}; s.forEach(c => { drivers[c.key] = c.val(); }); showAvailableTaxis(); });
                } catch (e) { console.error(e); }
            }
            updateStatus();
        }

        function updateStatus() {
            const dot = document.getElementById('sync-dot'), status = document.getElementById('sync-status');
            if (isFirebaseReady && isConnected) { dot.classList.add('online'); status.textContent = 'üü¢ Live'; }
            else { dot.classList.remove('online'); status.textContent = 'üíæ Lokal'; }
        }

        async function saveRide(ride) {
            if (isFirebaseReady) {
                const ref = db.ref('rides').push();
                ride.firebaseId = ref.key;
                await ref.set(ride);
            }
            return ride;
        }

        async function updateRide(id, updates) {
            if (isFirebaseReady) await db.ref('rides/' + id).update(updates);
        }

        function updateViews() {
            if (currentView === 'driver') updateDriverView();
            else if (currentView === 'admin') updateAdminView();
        }

        function updateDriverView() {
            const newRides = rides.filter(r => r.status === 'new');
            const myRides = currentVehicle ? rides.filter(r => r.vehicle === currentVehicle) : [];
            const current = myRides.find(r => r.status === 'accepted');
            const completed = myRides.filter(r => r.status === 'completed');
            
            if (current) {
                document.getElementById('driver-current-ride').innerHTML = `<div class="alert-info"><strong>Aktuelle Fahrt #${current.id}</strong><br>Von: ${current.pickup}<br>Nach: ${current.destination}<br>Preis: ${current.price}‚Ç¨<button class="btn btn-success" onclick="completeRide('${current.firebaseId}')">‚úì Abschlie√üen</button></div>`;
            } else {
                document.getElementById('driver-current-ride').innerHTML = currentVehicle && isOnline ? '<div class="alert-info">üü¢ Bereit f√ºr Auftr√§ge</div>' : '';
            }
            
            if (!currentVehicle || !isOnline) {
                document.getElementById('new-rides').innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Bitte Fahrzeug w√§hlen und Online gehen</div>';
            } else if (newRides.length === 0) {
                document.getElementById('new-rides').innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Keine Auftr√§ge</div>';
            } else {
                document.getElementById('new-rides').innerHTML = newRides.map(r => `<div class="ride-card"><div><strong>#${r.id}</strong> <span style="background:#fef3c7;padding:4px 8px;border-radius:12px;font-size:12px;">Neu</span></div><div style="margin-top:10px;font-size:14px;">Von: ${r.pickup}<br>Nach: ${r.destination}<br>Distanz: ${r.distance} km ‚Ä¢ ${r.duration} Min<br>Preis: ${r.price}‚Ç¨</div>${!current ? `<button class="btn btn-success" onclick="acceptRide('${r.firebaseId}')">‚úì Annehmen</button>` : ''}</div>`).join('');
            }
            
            const revenue = completed.reduce((sum, r) => sum + parseFloat(r.price), 0);
            document.getElementById('d-rides').textContent = completed.length;
            document.getElementById('d-money').textContent = revenue.toFixed(2) + '‚Ç¨';
        }

        function updateAdminView() {
            const completed = rides.filter(r => r.status === 'completed');
            const pending = rides.filter(r => r.status === 'new');
            const active = rides.filter(r => r.status === 'accepted');
            const revenue = completed.reduce((sum, r) => sum + parseFloat(r.price), 0);
            document.getElementById('a-total').textContent = completed.length;
            document.getElementById('a-revenue').textContent = revenue.toFixed(2) + '‚Ç¨';
            document.getElementById('a-pending').textContent = pending.length;
            document.getElementById('a-active').textContent = active.length;
            if (rides.length === 0) {
                document.getElementById('all-rides').innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Keine Fahrten</div>';
            } else {
                document.getElementById('all-rides').innerHTML = rides.slice().reverse().map(r => `<div class="ride-card"><div><strong>#${r.id}</strong> <span style="background:${r.status==='completed'?'#d1fae5':r.status==='accepted'?'#dbeafe':'#fef3c7'};padding:4px 8px;border-radius:12px;font-size:12px;">${r.status}</span></div><div style="margin-top:10px;font-size:14px;">Von: ${r.pickup}<br>Nach: ${r.destination}<br>${r.distance} km<br>Preis: ${r.price}‚Ç¨${r.vehicle ? '<br>Fahrzeug: '+r.vehicle : ''}</div></div>`).join('');
            }
        }

        function switchView(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(view + '-view').classList.add('active');
            event.target.classList.add('active');
            currentView = view;
            updateViews();
        }

        window.addEventListener('DOMContentLoaded', () => {
            setupAutocomplete();
            setTimeout(() => { if (firebaseLoaded && typeof firebase !== 'undefined') initApp(true); else initApp(false); }, 100);
            setInterval(() => { if (pickupCoords) showAvailableTaxis(); }, 10000);
        });
    </script>
</body>
</html>
