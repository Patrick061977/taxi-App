<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Taxi HGW">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <title>Funk Taxi Heringsdorf</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- ğŸ› Eruda Debug-Panel fÃ¼r Mobile -->
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>
        // Nur auf Nicht-Desktop-GerÃ¤ten aktivieren
        if (!/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
            // Desktop - Eruda nicht laden
        } else {
            // Mobile - Eruda aktivieren
            eruda.init();
            console.log('ğŸ› Debug-Panel aktiviert! Button unten rechts Ã¶ffnen.');
        }
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 22px; margin-bottom: 5px; }
        .status-row { display: flex; justify-content: center; gap: 20px; margin-top: 8px; font-size: 11px; }
        .status-item { display: flex; align-items: center; gap: 8px; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #f59e0b; }
        .sync-dot.online { background: #10b981; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        #gps-indicator { display: none; align-items: center; gap: 8px; font-size: 11px; }
        #gps-dot { width: 8px; height: 8px; border-radius: 50%; background: #6b7280; }
        #gps-dot.online { background: #10b981; animation: pulse 2s infinite; }
        .view-selector { display: flex; background: white; border-bottom: 2px solid #e0e0e0; position: sticky; top: 90px; z-index: 99; }
        .view-btn { flex: 1; padding: 15px; border: none; background: white; font-size: 14px; cursor: pointer; }
        .view-btn.active { color: #667eea; border-bottom: 3px solid #667eea; }
        .view { display: none; padding: 15px; }
        .view.active { display: block; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }
        .input-group input, .input-group select { width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; }
        .btn { padding: 15px 25px; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; width: 100%; }
        .btn-primary { background: #667eea; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-success { background: #10b981; color: white; }
        .alert-success { background: #d1fae5; border: 2px solid #10b981; padding: 15px; border-radius: 8px; margin-bottom: 15px; color: #065f46; }
        .alert-info { background: #dbeafe; border: 2px solid #3b82f6; padding: 15px; border-radius: 8px; margin-bottom: 15px; color: #1e40af; }
        .ride-card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #e0e0e0; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0; }
        .online-toggle { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e0e0e0; }
        .toggle-switch { position: relative; width: 60px; height: 34px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(26px); }
        .available-taxis { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #10b981; }
        .taxi-item { padding: 10px; background: #f0f9ff; border-radius: 6px; margin-top: 8px; }
        #map { height: 300px; border-radius: 8px; margin-top: 15px; }
        .ride-status-box { background: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 15px; }
        .eta-display { font-size: 32px; font-weight: bold; margin: 15px 0; }
        .eta-display.green { color: #10b981; }
        .eta-display.yellow { color: #f59e0b; }
        .eta-display.red { color: #ef4444; }
        .progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin: 15px 0; }
        .progress-fill { height: 100%; transition: width 0.3s ease; }
        .autocomplete-dropdown { position: relative; background: white; border: 1px solid #e0e0e0; border-radius: 4px; margin-top: 4px; max-height: 200px; overflow-y: auto; display: none; }
        .autocomplete-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .autocomplete-item:hover { background: #f0f9ff; }
        
        /* DRIVER MAP STYLES */
        #driver-map { height: 450px; border-radius: 12px; margin: 15px 0; border: 3px solid #667eea; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .route-info-box { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .route-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px; }
        .route-stat { text-align: center; padding: 12px; background: rgba(255,255,255,0.2); border-radius: 8px; backdrop-filter: blur(10px); }
        .route-stat-value { font-size: 28px; font-weight: bold; color: white; }
        .route-stat-label { font-size: 12px; color: rgba(255,255,255,0.9); margin-top: 4px; }
        
        /* ğŸ” LOGIN SYSTEM STYLES */
        .user-profile { display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: rgba(255,255,255,0.15); border-radius: 6px; margin-top: 6px; font-size: 11px; }
        .user-avatar { width: 28px; height: 28px; border-radius: 50%; background: white; color: #667eea; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; flex-shrink: 0; }
        .user-info { flex: 1; min-width: 0; overflow: hidden; }
        .user-info > div { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .btn-logout { background: #ef4444; padding: 4px 8px; font-size: 10px; border: none; border-radius: 4px; color: white; cursor: pointer; white-space: nowrap; }
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 10% auto; padding: 30px; border-radius: 12px; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .modal-header { font-size: 24px; font-weight: bold; margin-bottom: 20px; text-align: center; }
        .modal-input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; }
        .modal-btn { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-google { background: white; color: #333; border: 2px solid #e0e0e0; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-primary-modal { background: #667eea; color: white; }
        .modal-divider { text-align: center; margin: 20px 0; color: #999; }
        .modal-link { text-align: center; margin-top: 15px; color: #667eea; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>
    <div class="header" id="main-header" style="cursor: pointer;" onclick="toggleHeader()">
        <div id="header-content">
            <h1 style="margin: 0; font-size: 20px;">ğŸš• Funk Taxi Heringsdorf</h1>
            <p style="font-size: 10px; opacity: 0.8; margin: 4px 0 0 0;">Version 5.2.9 - Kunden Reset! ğŸ—‘ï¸ (Build 20251124-2145)</p>
            <div class="status-row" id="header-status-row">
                <div class="status-item">
                    <div class="sync-dot" id="sync-dot"></div>
                    <span id="sync-status">ğŸ’¾ Lokal</span>
                </div>
                <div class="status-item" id="gps-indicator">
                    <div id="gps-dot"></div>
                    <span id="gps-status">ğŸ“ GPS Off</span>
                </div>
                <div class="status-item" id="alerts-indicator" style="display:none;">
                    <span id="sound-status" style="font-size:16px;" title="Sound Status">ğŸ”‡</span>
                    <span id="vibration-status" style="font-size:16px;margin-left:5px;" title="Vibration Status">ğŸ“³</span>
                </div>
            </div>
        </div>
        <div id="header-toggle" style="text-align: center; margin-top: 5px; font-size: 12px; opacity: 0.7;">â–¼</div>
    </div>

    <div class="view-selector">
        <button class="view-btn active" onclick="switchView('passenger')">Fahrgast</button>
        <button class="view-btn" onclick="switchView('history')">Verlauf</button>
        <button class="view-btn" onclick="switchView('driver')" id="driver-tab-btn" style="display:none;">Fahrer</button>
        <button class="view-btn" onclick="switchView('admin')" id="admin-tab-btn" style="display:none;">Admin</button>
    </div>

    <!-- ğŸ”” BENACHRICHTIGUNGS-BANNER -->
    <div id="static-notification-banner" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;text-align:center;display:none;">
        <div style="font-size:48px;margin-bottom:10px;">ğŸ””</div>
        <div style="margin-bottom:15px;">
            <strong style="font-size:18px;">Benachrichtigungen aktivieren?</strong><br>
            <span style="font-size:14px;opacity:0.9;margin-top:5px;display:block;">Erhalte sofort Push-Benachrichtigungen bei neuen Buchungen!</span>
        </div>
        <button onclick="requestNotificationPermission()" style="background:white;color:#667eea;border:none;padding:14px 24px;border-radius:8px;font-weight:700;cursor:pointer;margin-right:10px;font-size:15px;box-shadow:0 2px 8px rgba(0,0,0,0.2);">âœ“ Jetzt aktivieren</button>
        <button onclick="document.getElementById('static-notification-banner').style.display='none'" style="background:rgba(255,255,255,0.2);color:white;border:2px solid white;padding:14px 24px;border-radius:8px;font-weight:600;cursor:pointer;font-size:15px;">SpÃ¤ter</button>
    </div>

    <div id="passenger-view" class="view active">
        <h3 style="margin-bottom: 15px;">Taxi buchen</h3>
        
        <!-- ğŸŒŸ STAMMKUNDEN-SCHNELLBUCHUNG -->
        <div id="regular-customer-box" style="display:none; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                <h4 style="margin: 0; font-size: 16px;">ğŸŒŸ Willkommen zurÃ¼ck!</h4>
                <button onclick="clearRegularCustomer()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 6px; font-size: 11px; cursor: pointer; font-weight: 600;">
                    âœ• LÃ¶schen
                </button>
            </div>
            <div id="regular-customer-info" style="font-size: 13px; line-height: 1.6; margin-bottom: 12px;"></div>
            <button onclick="useRegularCustomerData()" style="width: 100%; background: white; color: #059669; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                âš¡ Daten Ã¼bernehmen
            </button>
        </div>
        
        <div id="ride-status-container"></div>
        <div id="booking-form">
            <div class="input-group">
                <label>ğŸ“ Abholort</label>
                <input type="text" id="pickup" placeholder="z.B. Bahnhof Heringsdorf">
                <button onclick="useMyLocation()" style="margin-top:8px;padding:12px;border:2px solid #3b82f6;background:#dbeafe;color:#1e40af;border-radius:8px;font-weight:600;cursor:pointer;width:100%;">ğŸ“ Meinen Standort verwenden</button>
                <div class="autocomplete-dropdown" id="pickup-dropdown"></div>
            </div>
            <div id="available-taxis-display"></div>
            <div class="input-group">
                <label>ğŸ‘¤ Ihr Name</label>
                <input type="text" id="customer-name" placeholder="z.B. Max Mustermann">
            </div>
            <div class="input-group">
                <label>ğŸ“ Telefonnummer *</label>
                <input type="tel" id="customer-phone" placeholder="z.B. 0173 1234567" required>
                <div style="font-size:12px;color:#666;margin-top:5px;">
                    Pflichtfeld â€“ fÃ¼r RÃ¼ckfragen durch den Fahrer
                </div>
            </div>
            <div class="input-group">
                <label>ğŸ• Abholzeit</label>
                <select id="pickup-time" onchange="handlePickupTimeChange()">
                    <option value="jetzt">âš¡ Sofort</option>
                    <option value="15min">ğŸ• In 15 Minuten</option>
                    <option value="30min">ğŸ• In 30 Minuten</option>
                    <option value="1h">ğŸ•‘ In 1 Stunde</option>
                    <option value="datetime">ğŸ“… Datum & Zeit wÃ¤hlen...</option>
                </select>
                <input type="datetime-local" id="custom-datetime" style="display:none;margin-top:8px;padding:14px;border:2px solid #e0e0e0;border-radius:8px;width:100%;font-size:15px;">
                <div id="datetime-help" style="display:none;margin-top:8px;padding:10px;background:#dbeafe;border-radius:6px;font-size:13px;color:#1e40af;">
                    ğŸ’¡ <strong>Tipp:</strong> Ideal fÃ¼r Flughafentransfers oder Hotel-Buchungen im Voraus!
                </div>
            </div>
            <div class="input-group">
                <label>ğŸ¯ Zielort</label>
                <input type="text" id="destination" placeholder="z.B. SeebrÃ¼cke Ahlbeck">
                <div class="autocomplete-dropdown" id="destination-dropdown"></div>
            </div>
            <div class="input-group">
                <label>ğŸ‘¥ Personen</label>
                <select id="passengers">
                    <option value="1">1 Person</option>
                    <option value="2">2 Personen</option>
                    <option value="3">3 Personen</option>
                    <option value="4">4 Personen</option>
                </select>
            </div>
            <button id="price-btn" class="btn btn-primary" onclick="handlePriceButton()">ğŸ’° Preis berechnen</button>
            <div id="price-display" style="margin-top: 15px;"></div>
            <div id="route-map" style="height: 300px; margin-top: 15px; border-radius: 8px; overflow: hidden; display: none;"></div>
            
            <!-- CRM Speicher-Option -->
            <div id="crm-save-option" style="display:none;margin-top:15px;padding:12px;background:#f0fdf4;border:2px solid #10b981;border-radius:8px;">
                <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                    <input type="checkbox" id="save-to-crm" checked style="width:20px;height:20px;accent-color:#10b981;">
                    <span style="font-size:14px;">
                        <strong>ğŸ“‹ Kundendaten im CRM aktualisieren</strong><br>
                        <span style="font-size:12px;color:#666;">Adresse und Telefon werden gespeichert</span>
                    </span>
                </label>
            </div>
            
            <button id="book-btn" class="btn btn-success" onclick="book()" style="margin-top: 10px; display: none;">ğŸš• Taxi buchen</button>
        </div>
        <div id="confirm"></div>
    </div>

    <div id="history-view" class="view">
        <h3 style="margin: 20px 0;">Meine Fahrten</h3>
        
        <!-- ğŸ“… TABS fÃ¼r Kommende / Vergangene Fahrten -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button id="tab-upcoming" onclick="showHistoryTab('upcoming')" style="flex: 1; padding: 12px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 8px; font-weight: 600; cursor: pointer;">
                ğŸ“… Kommende Fahrten
            </button>
            <button id="tab-past" onclick="showHistoryTab('past')" style="flex: 1; padding: 12px; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 8px; font-weight: 600; cursor: pointer;">
                ğŸ“– Vergangene Fahrten
            </button>
        </div>
        
        <div id="history-list"></div>
        
        <!-- ğŸ§¹ Cache-Button fÃ¼r alle -->
        <div style="margin-top:30px;padding:15px;background:#f0f9ff;border-radius:8px;text-align:center;">
            <p style="font-size:13px;color:#666;margin-bottom:10px;">
                âš ï¸ Probleme mit der App? Alte Version wird angezeigt?
            </p>
            <button onclick="clearAppCache()" style="padding:12px 24px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                ğŸ§¹ Cache leeren & App neu laden
            </button>
        </div>
    </div>

    <div id="driver-view" class="view">
        <!-- ğŸ¯ DESIGN C: FULLSCREEN MAP - Google Maps Style -->
        
        <!-- Ultra-Mini Top Bar (transparent, sticky) -->
        <div id="driver-top-bar" style="
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 8px 10px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        ">
            <!-- GPS Status Indicator -->
            <div id="gps-status-compact" style="
                display: flex;
                align-items: center;
                gap: 4px;
                padding: 4px 8px;
                background: rgba(239,68,68,0.1);
                border-radius: 12px;
                font-size: 11px;
                color: #ef4444;
            ">
                <span id="gps-icon-compact">âŒ</span>
                <span id="gps-text-compact">GPS</span>
            </div>
            
            <!-- Stornierung Badge (NEU!) -->
            <button id="cancellation-badge" onclick="showCancellationPanel()" style="
                display: none;
                background: #ef4444;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 20px;
                font-weight: bold;
                cursor: pointer;
                font-size: 13px;
                animation: pulse 1s infinite;
            ">
                ğŸš¨ <span id="cancellation-count">0</span>
            </button>
            
            <!-- Neue AuftrÃ¤ge Button -->
            <button onclick="toggleNewRidesPanel()" style="
                background: #667eea;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 20px;
                font-weight: bold;
                cursor: pointer;
                font-size: 13px;
            ">
                ğŸ“‹ <span id="new-rides-count">0</span>
            </button>
            
            <!-- Fahrzeug Select -->
            <select id="vehicle" onchange="setVehicle()" style="
                padding: 6px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 12px;
                flex: 1;
                max-width: 110px;
            ">
                <option value="">Fzg.</option>
                <option value="tesla_model3_1">#1</option>
                <option value="tesla_model3_2">#2</option>
                <option value="tesla_model3_3">#3</option>
                <option value="tesla_modely_1">Y#1</option>
                <option value="tesla_modely_2">Y#2</option>
            </select>
            
            <!-- Stats Mini -->
            <div style="font-size: 10px; color: #666; white-space: nowrap;">
                <span id="d-rides">0</span>â†‘ <span id="d-money">0â‚¬</span>
            </div>
            
            <!-- Online Toggle Mini -->
            <label class="toggle-switch" style="transform: scale(0.6);">
                <input type="checkbox" id="online-toggle" onchange="toggleOnline()" disabled style="opacity: 0.5; cursor: not-allowed;">
                <span class="slider"></span>
            </label>
            
            <!-- Menu Button -->
            <button onclick="toggleDebugPanel()" style="
                background: rgba(102,126,234,0.2);
                color: #667eea;
                border: none;
                padding: 6px 10px;
                border-radius: 6px;
                cursor: pointer;
                font-weight: bold;
            ">
                â‰¡
            </button>
        </div>
        
        <!-- Debug Panel (versteckt by default) -->
        <div id="debug-panel" style="
            display: none;
            padding: 10px;
            background: #f3f4f6;
            font-size: 11px;
            color: #666;
        ">
            FB: <span id="debug-firebase">â“</span> | 
            Fahrten: <span id="debug-rides">â“</span> | 
            Neu: <span id="debug-new">â“</span> | 
            Sync: <span id="debug-sync">â“</span>
        </div>
        
        <!-- Neue AuftrÃ¤ge Slide-In Panel mit TABS! -->
        <div id="new-rides-panel" style="
            display: none;
            padding: 0;
            background: white;
            max-height: 60vh;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        ">
            <!-- Tabs -->
            <div style="
                display: flex;
                background: #f3f4f6;
                border-bottom: 2px solid #e0e0e0;
                position: sticky;
                top: 0;
                z-index: 10;
            ">
                <button onclick="switchRidesTab('new')" id="rides-tab-new" class="rides-tab active" style="
                    flex: 1;
                    padding: 12px;
                    background: white;
                    border: none;
                    border-bottom: 3px solid #667eea;
                    font-weight: 600;
                    cursor: pointer;
                    font-size: 13px;
                ">
                    ğŸ“‹ Neu
                </button>
                <button onclick="switchRidesTab('completed')" id="rides-tab-completed" class="rides-tab" style="
                    flex: 1;
                    padding: 12px;
                    background: transparent;
                    border: none;
                    border-bottom: 3px solid transparent;
                    font-weight: 600;
                    cursor: pointer;
                    font-size: 13px;
                    color: #666;
                ">
                    âœ… Fertig
                </button>
                <button onclick="switchRidesTab('cancelled')" id="rides-tab-cancelled" class="rides-tab" style="
                    flex: 1;
                    padding: 12px;
                    background: transparent;
                    border: none;
                    border-bottom: 3px solid transparent;
                    font-weight: 600;
                    cursor: pointer;
                    font-size: 13px;
                    color: #666;
                ">
                    ğŸš¨ Storniert
                </button>
            </div>
            
            <!-- Tab Content -->
            <div style="padding: 10px;">
                <div id="new-rides"></div>
                <div id="completed-rides" style="display: none;"></div>
                <div id="cancelled-rides" style="display: none;"></div>
            </div>
        </div>
        
        <style>
            .rides-tab.active {
                background: white !important;
                border-bottom-color: #667eea !important;
                color: #667eea !important;
            }
        </style>
        
        <script>
            function switchRidesTab(tab) {
                // Hide all content
                document.getElementById('new-rides').style.display = 'none';
                document.getElementById('completed-rides').style.display = 'none';
                document.getElementById('cancelled-rides').style.display = 'none';
                
                // Remove active from all tabs
                document.querySelectorAll('.rides-tab').forEach(t => {
                    t.classList.remove('active');
                    t.style.background = 'transparent';
                    t.style.borderBottomColor = 'transparent';
                    t.style.color = '#666';
                });
                
                // Show selected content & activate tab
                if (tab === 'new') {
                    document.getElementById('new-rides').style.display = 'block';
                    document.getElementById('rides-tab-new').classList.add('active');
                } else if (tab === 'completed') {
                    document.getElementById('completed-rides').style.display = 'block';
                    document.getElementById('rides-tab-completed').classList.add('active');
                    loadCompletedRides();
                } else if (tab === 'cancelled') {
                    document.getElementById('cancelled-rides').style.display = 'block';
                    document.getElementById('rides-tab-cancelled').classList.add('active');
                    loadCancelledRides();
                }
            }
            
            function loadCompletedRides() {
                const myRides = currentVehicle ? rides.filter(r => r.vehicleId === currentVehicle || r.vehicle === (VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle)) : [];
                const completed = myRides.filter(r => r.status === 'completed');
                
                if (completed.length === 0) {
                    document.getElementById('completed-rides').innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Keine abgeschlossenen Fahrten</div>';
                    return;
                }
                
                let html = completed.map(r => `
                    <div class="ride-card" style="background:#f0fdf4;border-left:4px solid #10b981;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <strong>#${r.id}</strong>
                            <span style="background:#10b981;color:white;padding:4px 8px;border-radius:12px;font-size:11px;">âœ… Fertig</span>
                        </div>
                        ${r.customerName ? `<div style="font-weight:600;color:#065f46;margin-bottom:5px;">ğŸ‘¤ ${r.customerName}</div>` : ''}
                        <div style="font-size:13px;color:#666;">
                            Von: ${r.pickup}<br>
                            Nach: ${r.destination}<br>
                            Preis: <strong>${r.price}â‚¬</strong> â€¢ ${r.distance} km
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('completed-rides').innerHTML = html;
            }
            
            function loadCancelledRides() {
                const myRides = currentVehicle ? rides.filter(r => r.vehicleId === currentVehicle || r.vehicle === (VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle)) : [];
                const cancelled = myRides.filter(r => r.status === 'cancelled' || r.status === 'cancelled_pending_driver' || r.status === 'storniert');
                
                if (cancelled.length === 0) {
                    document.getElementById('cancelled-rides').innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Keine stornierten Fahrten</div>';
                    return;
                }
                
                let html = cancelled.map(r => `
                    <div class="ride-card" style="background:#fef2f2;border-left:4px solid #ef4444;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <strong>#${r.id}</strong>
                            <span style="background:#ef4444;color:white;padding:4px 8px;border-radius:12px;font-size:11px;">ğŸš¨ Storniert</span>
                        </div>
                        ${r.customerName ? `<div style="font-weight:600;color:#991b1b;margin-bottom:5px;">ğŸ‘¤ ${r.customerName}</div>` : ''}
                        <div style="font-size:13px;color:#666;">
                            Von: ${r.pickup}<br>
                            Nach: ${r.destination}<br>
                            ${r.cancellationFee ? `<strong>GebÃ¼hr: ${r.cancellationFee.toFixed(2)}â‚¬</strong><br>` : ''}
                            ${r.cancellationReason ? `Grund: ${r.cancellationReason}` : ''}
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('cancelled-rides').innerHTML = html;
            }
        </script>
        
        <!-- ğŸš¨ STORNIERUNG PANEL (NEU!) -->
        <div id="cancellation-panel" style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            padding: 20px;
            overflow-y: auto;
        ">
            <div id="cancellation-list" style="
                background: white;
                border-radius: 12px;
                padding: 20px;
                max-width: 500px;
                margin: 0 auto;
            "></div>
        </div>
        
        <!-- ğŸš• NEUER AUFTRAG FULLSCREEN POPUP (NEU!) -->
        <div id="new-ride-fullscreen" style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 10002;
            padding: 20px;
            overflow-y: auto;
        ">
            <div style="
                background: white;
                border-radius: 20px;
                padding: 0;
                max-width: 500px;
                margin: 50px auto;
                box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                overflow: hidden;
            ">
                <!-- Header -->
                <div style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    padding: 30px 20px;
                    text-align: center;
                    position: relative;
                ">
                    <button onclick="closeNewRideFullscreen()" style="
                        position: absolute;
                        top: 15px;
                        right: 15px;
                        background: rgba(255,255,255,0.3);
                        color: white;
                        border: none;
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        font-size: 24px;
                        cursor: pointer;
                        font-weight: bold;
                    ">âœ•</button>
                    
                    <div style="font-size: 72px; margin-bottom: 10px;">ğŸš•</div>
                    <div style="font-size: 32px; font-weight: bold; color: white; margin-bottom: 5px;">
                        NEUER AUFTRAG!
                    </div>
                    <div style="font-size: 14px; color: rgba(255,255,255,0.9);">
                        Ein Kunde wartet auf dich
                    </div>
                </div>
                
                <!-- Content -->
                <div id="new-ride-fullscreen-content" style="padding: 30px 20px;">
                    <!-- Wird dynamisch gefÃ¼llt -->
                </div>
            </div>
        </div>
        
        <!-- FULLSCREEN KARTE Container -->
        <div id="driver-route-info" style="
            display: none;
            position: relative;
            height: calc(100vh - 150px);
        ">
            <!-- ğŸ´ CARDS INFO TOP (A3/B3 Design) -->
            <div id="driver-cards-container" style="
                padding: 10px;
                background: white;
                box-shadow: 0 2px 6px rgba(0,0,0,0.1);
                display: grid;
                gap: 8px;
            ">
                <!-- Kunde Card (mit Telefon) -->
                <div id="driver-customer-card" style="
                    background: #f8f9fa;
                    padding: 10px;
                    border-radius: 8px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    border-left: 4px solid #667eea;
                ">
                    <div style="flex: 1;">
                        <div style="font-size: 10px; color: #999; text-transform: uppercase; margin-bottom: 3px;">
                            Kunde
                        </div>
                        <div id="driver-customer-name" style="font-size: 14px; font-weight: 600; color: #333;">
                            ğŸ‘¤ Kunde
                        </div>
                    </div>
                    <button id="driver-call-button" onclick="callCustomer()" style="
                        background: #10b981;
                        color: white;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 16px;
                        font-size: 12px;
                        font-weight: 600;
                        cursor: pointer;
                        display: none;
                    ">ğŸ“</button>
                </div>
                
                <!-- Preis Card (nur bei picked_up) -->
                <div id="driver-price-card" style="
                    background: #f8f9fa;
                    padding: 10px;
                    border-radius: 8px;
                    border-left: 4px solid #10b981;
                    display: none;
                ">
                    <div style="font-size: 10px; color: #999; text-transform: uppercase; margin-bottom: 3px;">
                        Preis
                    </div>
                    <div id="driver-price-value" style="font-size: 14px; font-weight: 600; color: #333;">
                        ğŸ’° -
                    </div>
                </div>
                
                <!-- Pickup Card (nur bei accepted) -->
                <div id="driver-pickup-card" style="
                    background: #f8f9fa;
                    padding: 10px;
                    border-radius: 8px;
                    border-left: 4px solid #667eea;
                    display: none;
                ">
                    <div style="font-size: 10px; color: #999; text-transform: uppercase; margin-bottom: 3px;">
                        ğŸ“ Abholen
                    </div>
                    <div id="driver-pickup-value" style="font-size: 14px; font-weight: 600; color: #333;">
                        -
                    </div>
                </div>
                
                <!-- Destination Card -->
                <div id="driver-dest-card" style="
                    background: #ecfdf5;
                    padding: 10px;
                    border-radius: 8px;
                    border-left: 4px solid #10b981;
                ">
                    <div style="font-size: 10px; color: #059669; text-transform: uppercase; margin-bottom: 3px;">
                        ğŸ¯ Ziel
                    </div>
                    <div id="driver-dest-value" style="font-size: 14px; font-weight: 600; color: #065f46;">
                        -
                    </div>
                </div>
                
                <!-- Action Button -->
                <button id="driver-action-button" style="
                    width: 100%;
                    padding: 12px;
                    background: #667eea;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    font-size: 14px;
                    cursor: pointer;
                ">ğŸš— Beim Kunden angekommen</button>
            </div>
            
            <!-- âŒ KARTE ENTFERNT - NUR INFO! -->
            
            <!-- Turn-by-Turn Central Overlay (GROÃŸ in der Mitte) -->
            <div id="turn-by-turn" style="
                display: none;
                position: absolute;
                top: 60px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(255,255,255,0.98);
                border-radius: 16px;
                padding: 20px 30px;
                text-align: center;
                box-shadow: 0 8px 24px rgba(0,0,0,0.3);
                backdrop-filter: blur(10px);
                border: 3px solid #667eea;
                z-index: 900;
            ">
                <div style="font-size: 56px; color: #667eea; margin-bottom: 8px;" id="turn-icon">â†‘</div>
                <div style="font-size: 36px; font-weight: bold; color: #333; margin-bottom: 5px;" id="turn-distance">150m</div>
                <div style="font-size: 18px; color: #666;" id="turn-instruction">Geradeaus</div>
            </div>
            
            <!-- Bottom Panel - Nur ETA -->
            <div id="bottom-panel" style="
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                padding: 10px;
                box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
                text-align: center;
                font-size: 12px;
                color: #666;
                z-index: 900;
            ">
                <span><b id="route-distance">-</b>km</span>
                <span> â€¢ </span>
                <span><b id="route-duration">-</b>min</span>
                <span> â€¢ </span>
                <span>ETA <b id="route-eta">-</b></span>
            </div>
        </div>
        
        <!-- Ready State (wenn keine Fahrt) -->
        <div id="driver-ready" style="
            padding: 80px 20px;
            text-align: center;
        ">
            <div style="font-size: 80px; margin-bottom: 20px;">ğŸš•</div>
            <div style="font-size: 28px; font-weight: 600; color: #667eea; margin-bottom: 10px;">Bereit!</div>
            <div style="font-size: 14px; color: #999;">WÃ¤hle Fahrzeug & gehe Online</div>
        </div>
        
        <!-- ğŸ§ª KLEINE TEST-BUTTONS (nur fÃ¼r Fahrer sichtbar) -->
        <div id="alert-test-buttons" style="
            display: none;
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 8px 12px;
            border-radius: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        ">
            <button onclick="testSound()" style="
                background: #667eea;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 12px;
                font-size: 11px;
                cursor: pointer;
            ">ğŸ”Š Test</button>
            <button onclick="testVibration()" style="
                background: #667eea;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 12px;
                font-size: 11px;
                cursor: pointer;
            ">ğŸ“³ Test</button>
        </div>
        
        <script>
            // ğŸ“± HEADER TOGGLE
            let headerCollapsed = false;
            function toggleHeader() {
                const header = document.getElementById('main-header');
                const content = document.getElementById('header-content');
                const toggle = document.getElementById('header-toggle');
                
                headerCollapsed = !headerCollapsed;
                
                if (headerCollapsed) {
                    content.style.display = 'none';
                    toggle.textContent = 'â–¶';
                    header.style.padding = '8px 15px';
                } else {
                    content.style.display = 'block';
                    toggle.textContent = 'â–¼';
                    header.style.padding = '15px';
                }
            }
            
            function toggleNewRidesPanel() {
                const panel = document.getElementById('new-rides-panel');
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            }
            
            function toggleDebugPanel() {
                const panel = document.getElementById('debug-panel');
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            }
            
            // ğŸš¨ STORNIERUNG PANEL FUNKTIONEN
            function showCancellationPanel() {
                const myRides = currentVehicle ? rides.filter(r => r.vehicleId === currentVehicle || r.vehicle === (VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle)) : [];
                const pendingCancellations = myRides.filter(r => 
                    (r.status === 'cancelled_pending_driver' || 
                    (r.status === 'cancelled' && r.driverNotified === false))
                );
                
                if (pendingCancellations.length === 0) {
                    alert('Keine Stornierungen!');
                    return;
                }
                
                let html = `
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h2 style="margin:0;color:#ef4444;">ğŸš¨ Stornierungen</h2>
                        <button onclick="closeCancellationPanel()" style="
                            background:#ef4444;
                            color:white;
                            border:none;
                            padding:8px 16px;
                            border-radius:8px;
                            cursor:pointer;
                            font-weight:600;
                        ">âœ• SchlieÃŸen</button>
                    </div>
                `;
                
                pendingCancellations.forEach(ride => {
                    const cancellationFee = calculateCancellationFee(ride);
                    html += `
                        <div style="
                            background:#fef2f2;
                            border:3px solid #ef4444;
                            border-radius:12px;
                            padding:20px;
                            margin-bottom:15px;
                        ">
                            <div style="font-size:24px;font-weight:bold;color:#ef4444;margin-bottom:15px;">
                                Fahrt #${ride.id}
                            </div>
                            
                            ${ride.customerName ? `
                            <div style="padding:12px;background:#dbeafe;border-radius:8px;margin-bottom:12px;">
                                <div style="font-size:18px;font-weight:600;color:#1e40af;">
                                    ğŸ‘¤ ${ride.customerName}
                                </div>
                            </div>
                            ` : ''}
                            
                            <div style="margin-bottom:12px;font-size:14px;">
                                <strong>Von:</strong> ${ride.pickup}<br>
                                <strong>Nach:</strong> ${ride.destination}<br>
                                <strong>Abholung:</strong> ${ride.pickupTime || 'Sofort'}<br>
                                <strong>Preis:</strong> ${ride.price}â‚¬
                            </div>
                            
                            ${ride.cancellationReason ? `
                            <div style="
                                padding:12px;
                                background:#fff7ed;
                                border-left:4px solid #f59e0b;
                                border-radius:6px;
                                margin-bottom:12px;
                            ">
                                <strong>Grund:</strong> ${ride.cancellationReason}
                            </div>
                            ` : ''}
                            
                            <div style="
                                padding:15px;
                                background:white;
                                border-radius:8px;
                                margin-bottom:15px;
                                text-align:center;
                            ">
                                <div style="font-size:12px;color:#666;margin-bottom:5px;">
                                    StornierungsgebÃ¼hr
                                </div>
                                <div style="font-size:32px;font-weight:bold;color:#ef4444;">
                                    ${cancellationFee.toFixed(2)}â‚¬
                                </div>
                            </div>
                            
                            <button onclick="confirmCancellation('${ride.firebaseId || ride.id}')" style="
                                width:100%;
                                padding:16px;
                                background:#ef4444;
                                color:white;
                                border:none;
                                border-radius:12px;
                                font-size:16px;
                                font-weight:bold;
                                cursor:pointer;
                            ">
                                âœ“ Stornierung bestÃ¤tigen
                            </button>
                            
                            <button onclick="showRideDetails('${ride.firebaseId || ride.id}')" style="
                                width:100%;
                                padding:12px;
                                background:white;
                                color:#ef4444;
                                border:2px solid #ef4444;
                                border-radius:12px;
                                font-size:14px;
                                font-weight:600;
                                cursor:pointer;
                                margin-top:10px;
                            ">
                                Details ansehen
                            </button>
                        </div>
                    `;
                });
                
                document.getElementById('cancellation-list').innerHTML = html;
                document.getElementById('cancellation-panel').style.display = 'block';
            }
            
            function closeCancellationPanel() {
                document.getElementById('cancellation-panel').style.display = 'none';
            }
            
            async function confirmCancellation(rideId) {
                try {
                    const ride = rides.find(r => (r.firebaseId || r.id) === rideId);
                    if (!ride) {
                        alert('âŒ Fahrt nicht gefunden!');
                        return;
                    }
                    
                    const cancellationFee = calculateCancellationFee(ride);
                    
                    // Update in Firebase
                    const updates = {
                        status: 'cancelled',
                        driverNotified: true,
                        driverConfirmedAt: new Date().toISOString(),
                        cancellationFee: cancellationFee
                    };
                    
                    if (isFirebaseReady) {
                        await db.ref('rides/' + rideId).update(updates);
                        console.log('âœ… Stornierung bestÃ¤tigt:', rideId);
                    }
                    
                    // Update lokal
                    Object.assign(ride, updates);
                    saveRides();
                    
                    // âœ… WICHTIG: Panel SOFORT schlieÃŸen!
                    closeCancellationPanel();
                    
                    // UI Update
                    updateViews();
                    
                    alert('âœ… Stornierung bestÃ¤tigt! GebÃ¼hr: ' + cancellationFee.toFixed(2) + 'â‚¬');
                    
                } catch (error) {
                    console.error('âŒ Fehler beim BestÃ¤tigen:', error);
                    alert('âŒ Fehler: ' + error.message);
                }
            }
            
            function calculateCancellationFee(ride) {
                // StornierungsgebÃ¼hr = Grundpreis (4â‚¬) + 10% vom Fahrpreis
                const baseFee = 4.00;
                const percentageFee = ride.price ? ride.price * 0.1 : 0;
                const total = baseFee + percentageFee;
                
                // Runde auf 10 Cent
                return Math.round(total * 10) / 10;
            }
        </script>
    </div>

    <div id="admin-view" class="view">
        <h3 style="margin: 20px 0;">Dashboard</h3>
        
        <!-- ğŸ” NEU: BENUTZER-VERWALTUNG -->
        <div onclick="toggleAdminSection('users')" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ‘¥ Benutzer-Verwaltung</span>
            <span id="users-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="users-content" style="display:none;margin-bottom:20px;">
            <div style="margin-bottom:15px;">
                <input type="text" id="user-search" placeholder="ğŸ” Benutzer suchen..." oninput="searchUsers()" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
            </div>
            <div id="users-list" style="max-height:300px;overflow-y:auto;"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
                <button onclick="loadAllUsers()" style="padding:12px;background:#667eea;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ”„ Benutzer laden
                </button>
                <button onclick="showAddUserModal()" style="padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    â• Neuer Mitarbeiter
                </button>
            </div>
        </div>
        
        <!-- ğŸ“‹ NEU: STAMMKUNDEN-CRM -->
        <div onclick="toggleAdminSection('customers')" style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ“‹ Stammkunden-CRM</span>
            <span id="customers-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="customers-content" style="display:none;margin-bottom:20px;">
            <div style="margin-bottom:15px;">
                <input type="text" id="customer-search" placeholder="ğŸ” Kunde suchen (Name, Email, Telefon)..." oninput="searchCustomers()" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
            </div>
            <div id="customers-list" style="max-height:400px;overflow-y:auto;"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
                <button onclick="loadAllCustomers()" style="padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ”„ Kunden laden
                </button>
                <button onclick="showAddCustomerModal()" style="padding:12px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    â• Neuer Kunde
                </button>
            </div>
            <div style="margin-top:10px;">
                <label for="csv-import" style="display:block;padding:12px;background:#8b5cf6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;text-align:center;">
                    ğŸ“¥ Google Kontakte importieren (CSV)
                </label>
                <input type="file" id="csv-import" accept=".csv" onchange="importGoogleCSV(this)" style="display:none;">
            </div>
            <div style="margin-top:10px;">
                <button onclick="deleteAllCustomers()" style="width:100%;padding:12px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ—‘ï¸ Alle Kunden lÃ¶schen
                </button>
            </div>
        </div>
        
        <!-- COLLAPSIBLE: Controls -->
        <div onclick="toggleAdminSection('controls')" style="background:#f3f4f6;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">âš™ï¸ Admin Controls</span>
            <span id="controls-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="controls-content" style="display:none;margin-bottom:20px;">
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px;">
                <button onclick="clearAppCache()" style="padding:15px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                    ğŸ§¹ Cache leeren
                </button>
                <button onclick="exportDebugLogs()" style="padding:15px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                    ğŸ“‹ Logs kopieren
                </button>
                <button onclick="exportSuperDebug()" style="padding:15px;background:#8b5cf6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                    ğŸ› Super Debug
                </button>
            </div>
            <div style="display:grid;grid-template-columns:1fr;gap:10px;">
                <button onclick="resetDatabase()" style="padding:15px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                    ğŸ—‘ï¸ Datenbank lÃ¶schen
                </button>
            </div>
        </div>
        
        <!-- Stats - immer sichtbar -->
        <div class="stats-grid">
            <div class="stat-card"><div style="font-size: 28px;" id="a-total">0</div><div>Fahrten</div></div>
            <div class="stat-card"><div style="font-size: 28px;" id="a-revenue">0â‚¬</div><div>Umsatz</div></div>
            <div class="stat-card"><div style="font-size: 28px;" id="a-pending">0</div><div>Offen</div></div>
            <div class="stat-card"><div style="font-size: 28px;" id="a-active">0</div><div>Aktiv</div></div>
        </div>
        
        <!-- COLLAPSIBLE: Online-Fahrer -->
        <div onclick="toggleAdminSection('drivers')" style="background:#f3f4f6;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸš— Online-Fahrer</span>
            <span id="drivers-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="drivers-content" style="display:none;">
            <div id="online-drivers-list" style="margin-bottom:20px;"></div>
        </div>
        
        <!-- COLLAPSIBLE: Offene Fahrten -->
        <div onclick="toggleAdminSection('open')" style="background:#f3f4f6;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ“‹ Offene Fahrten</span>
            <span id="open-toggle" style="font-size:20px;">â–²</span>
        </div>
        <div id="open-content" style="display:block;">
            <div id="upcoming-rides-admin" style="margin-bottom: 20px;"></div>
        </div>
        
        <!-- COLLAPSIBLE: Abgelehnte Fahrten -->
        <div onclick="toggleAdminSection('rejected')" style="background:#f3f4f6;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">âŒ Abgelehnte Fahrten</span>
            <span id="rejected-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="rejected-content" style="display:none;">
            <div id="rejected-rides-admin" style="margin-bottom: 20px;"></div>
        </div>
        
        <!-- COLLAPSIBLE: Abgeschlossene Fahrten -->
        <div onclick="toggleAdminSection('completed')" style="background:#f3f4f6;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">âœ… Abgeschlossene Fahrten</span>
            <span id="completed-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="completed-content" style="display:none;">
            <div id="all-rides"></div>
        </div>
        
        <!-- COLLAPSIBLE: Stornierungen -->
        <div onclick="toggleAdminSection('cancelled')" style="background:#f3f4f6;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ’¶ Stornierungen</span>
            <span id="cancelled-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="cancelled-content" style="display:none;">
            <div id="cancellations-list"></div>
        </div>
        
        <!-- ğŸ’° PREIS-STEUERUNG (SURGE PRICING) -->
        <div onclick="toggleAdminSection('pricing')" style="background:#f3f4f6;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ’° Preis-Steuerung</span>
            <span id="pricing-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="pricing-content" style="display:none;padding:15px;background:#fff;border-radius:8px;margin-bottom:20px;border:1px solid #e5e7eb;">
            
            <!-- Aktueller Multiplikator Anzeige -->
            <div style="text-align:center;margin-bottom:20px;padding:15px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:12px;color:white;">
                <div style="font-size:12px;opacity:0.9;">Aktueller Preis-Multiplikator</div>
                <div id="current-multiplier-display" style="font-size:36px;font-weight:bold;">100%</div>
                <div id="multiplier-reason" style="font-size:11px;opacity:0.8;">Normalpreis</div>
            </div>
            
            <!-- Automatische Anpassung -->
            <div style="margin-bottom:20px;">
                <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px;background:#f9fafb;border-radius:8px;">
                    <input type="checkbox" id="auto-surge-enabled" onchange="saveePricingSettings()" checked style="width:20px;height:20px;">
                    <div>
                        <div style="font-weight:600;font-size:14px;">ğŸ“Š Automatisch (Auslastung)</div>
                        <div style="font-size:12px;color:#666;">Preis steigt bei hoher Nachfrage</div>
                    </div>
                </label>
                <div style="margin-top:10px;padding:10px;background:#f0fdf4;border-radius:8px;display:flex;align-items:center;gap:10px;">
                    <span style="font-size:13px;">Pro aktivem Taxi:</span>
                    <select id="surge-per-taxi" onchange="savePricingSettings()" style="padding:8px;border-radius:6px;border:1px solid #d1d5db;font-size:14px;">
                        <option value="5">+5%</option>
                        <option value="10" selected>+10%</option>
                        <option value="15">+15%</option>
                        <option value="20">+20%</option>
                    </select>
                </div>
            </div>
            
            <!-- Manueller Aufschlag/Rabatt -->
            <div style="margin-bottom:20px;">
                <div style="font-weight:600;font-size:14px;margin-bottom:10px;">ğŸšï¸ Manueller Aufschlag/Rabatt</div>
                <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;">
                    <button onclick="setManualMultiplier(-20)" class="multiplier-btn" data-value="-20" style="padding:12px 5px;border:2px solid #e5e7eb;background:white;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;color:#10b981;">-20%</button>
                    <button onclick="setManualMultiplier(-10)" class="multiplier-btn" data-value="-10" style="padding:12px 5px;border:2px solid #e5e7eb;background:white;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;color:#10b981;">-10%</button>
                    <button onclick="setManualMultiplier(0)" class="multiplier-btn active" data-value="0" style="padding:12px 5px;border:2px solid #667eea;background:#667eea;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;color:white;">0%</button>
                    <button onclick="setManualMultiplier(10)" class="multiplier-btn" data-value="10" style="padding:12px 5px;border:2px solid #e5e7eb;background:white;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;color:#ef4444;">+10%</button>
                    <button onclick="setManualMultiplier(20)" class="multiplier-btn" data-value="20" style="padding:12px 5px;border:2px solid #e5e7eb;background:white;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;color:#ef4444;">+20%</button>
                </div>
            </div>
            
            <!-- Status-Info -->
            <div style="padding:12px;background:#fef3c7;border-radius:8px;font-size:12px;">
                <strong>ğŸ“ˆ So wird der Preis berechnet:</strong><br>
                Grundpreis Ã— (100% + Auto-Surge + Manuell) = Endpreis<br>
                <span id="pricing-example" style="color:#666;">Beispiel: 14.60â‚¬ Ã— 100% = 14.60â‚¬</span>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let firebaseLoadTimeout, firebaseLoaded = false;
        firebaseLoadTimeout = setTimeout(() => { 
            if (!firebaseLoaded && typeof initApp === 'function') initApp(false); 
        }, 5000);
    </script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js" onload="firebaseLoaded = true;" onerror="if(typeof initApp === 'function') initApp(false);"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script>
        // CONFIGURATION
        const VEHICLES = {
            'tesla_model3_1': { name: 'Tesla Model 3 #1', id: 'tesla_model3_1', plate: 'PW-TX 111' },
            'tesla_model3_2': { name: 'Tesla Model 3 #2', id: 'tesla_model3_2', plate: 'PW-TX 222' },
            'tesla_model3_3': { name: 'Tesla Model 3 #3', id: 'tesla_model3_3', plate: 'PW-TX 333' },
            'tesla_modely_1': { name: 'Tesla Model Y #1', id: 'tesla_modely_1', plate: 'PW-MY 222' },
            'tesla_modely_2': { name: 'Tesla Model Y #2', id: 'tesla_modely_2', plate: 'PW-MY 333' }
        };
        const TARIF = { 
            grundgebuehr: 4.00,
            // Gestaffelte Kilometerpreise (offizieller Tarif August 2022)
            km_1_2: 3.30,      // Kilometer 1-2
            km_3_4: 2.80,      // Kilometer 3-4
            km_ab_5: 2.20,     // Ab Kilometer 5
            // ZuschlÃ¤ge
            nachtZuschlag: 0.20, 
            sonntagZuschlag: 0.25, 
            feiertagZuschlag: 0.50,
            // Nachttarif
            nacht_grundgebuehr: 5.50,
            nacht_km_1_2: 3.30,
            nacht_km_3_4: 2.80,
            nacht_km_ab_5: 2.40
        };
        const USEDOM_ORTE = ['Heringsdorf', 'Ahlbeck', 'Bansin', 'Zinnowitz', 'Ãœckeritz', 'Loddin', 'Zempin', 'Koserow', 'Karlshagen', 'PeenemÃ¼nde', 'Trassenheide'];
        
        // Bekannte Koordinaten fÃ¼r wichtige Orte (Fallback)
        const KNOWN_PLACES = {
            'heringsdorf': { lat: 53.9533, lon: 14.1633, name: 'Heringsdorf' },
            'bahnhof heringsdorf': { lat: 53.9533, lon: 14.1633, name: 'Bahnhof Heringsdorf' },
            'ahlbeck': { lat: 53.9444, lon: 14.1933, name: 'Ahlbeck' },
            'seebrÃ¼cke ahlbeck': { lat: 53.9444, lon: 14.1933, name: 'SeebrÃ¼cke Ahlbeck' },
            'bansin': { lat: 53.9633, lon: 14.1433, name: 'Bansin' },
            'seebrÃ¼cke bansin': { lat: 53.9633, lon: 14.1433, name: 'SeebrÃ¼cke Bansin' },
            'zinnowitz': { lat: 54.0908, lon: 13.9167, name: 'Zinnowitz' },
            'bahnhof zinnowitz': { lat: 54.0908, lon: 13.9167, name: 'Bahnhof Zinnowitz' },
            'Ã¼ckeritz': { lat: 53.9878, lon: 14.0519, name: 'Ãœckeritz' },
            'loddin': { lat: 54.0083, lon: 13.9917, name: 'Loddin' },
            'zempin': { lat: 54.0194, lon: 13.9611, name: 'Zempin' },
            'koserow': { lat: 54.0681, lon: 13.9764, name: 'Koserow' },
            'karlshagen': { lat: 54.1078, lon: 13.8333, name: 'Karlshagen' },
            'peenemÃ¼nde': { lat: 54.1422, lon: 13.7753, name: 'PeenemÃ¼nde' },
            'trassenheide': { lat: 54.0997, lon: 13.8875, name: 'Trassenheide' },
            'usedom': { lat: 53.9533, lon: 14.1633, name: 'Usedom' },
            'swinemÃ¼nde': { lat: 53.9167, lon: 14.2500, name: 'SwinemÃ¼nde' }
        };

        // STATE
        let db, isFirebaseReady = false, isConnected = false, currentVehicle = null, currentView = 'passenger', rides = [], drivers = {};
        let currentBookingCustomerId = null; // FÃ¼r CRM-Update bei Stammkunden-Buchung
        let pickupCoords = null, destCoords = null, map = null, watchId = null, isOnline = false, myCurrentRide = null;
        let taxiMarker = null, pickupMarker = null, etaUpdateInterval = null, lastSoundDistance = 999;
        let wakeLock = null;
        let cancellations = []; // Neue Variable fÃ¼r Stornierungen
        
        // ğŸ› SUPER DEBUG SYSTEM
        let debugErrors = [];
        let debugLogs = [];
        let debugFirebaseQueries = [];
        let debugStateChanges = [];
        const MAX_DEBUG_LOGS = 200;
        
        // Catche ALLE JavaScript Errors
        window.addEventListener('error', (e) => {
            const errorInfo = {
                time: new Date().toISOString(),
                message: e.message,
                filename: e.filename || 'unknown',
                line: e.lineno || 0,
                column: e.colno || 0,
                stack: e.error?.stack || 'no stack trace'
            };
            debugErrors.push(errorInfo);
            console.error('ğŸ”´ ERROR CAUGHT:', errorInfo);
        });
        
        // Catche Promise Rejections
        window.addEventListener('unhandledrejection', (e) => {
            const errorInfo = {
                time: new Date().toISOString(),
                message: 'Unhandled Promise Rejection: ' + (e.reason?.message || e.reason),
                stack: e.reason?.stack || 'no stack trace'
            };
            debugErrors.push(errorInfo);
            console.error('ğŸ”´ PROMISE REJECTION:', errorInfo);
        });
        
        // Ãœberschreibe console.log fÃ¼r Debug-Logging
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        console.log = function(...args) {
            debugLogs.push({
                time: new Date().toISOString(),
                type: 'log',
                message: args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ')
            });
            if (debugLogs.length > MAX_DEBUG_LOGS) debugLogs.shift();
            originalLog.apply(console, args);
        };
        
        console.error = function(...args) {
            debugLogs.push({
                time: new Date().toISOString(),
                type: 'error',
                message: args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ')
            });
            if (debugLogs.length > MAX_DEBUG_LOGS) debugLogs.shift();
            originalError.apply(console, args);
        };
        
        console.warn = function(...args) {
            debugLogs.push({
                time: new Date().toISOString(),
                type: 'warn',
                message: args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ')
            });
            if (debugLogs.length > MAX_DEBUG_LOGS) debugLogs.shift();
            originalWarn.apply(console, args);
        };
        
        // Helper: Log State Change
        function logStateChange(description, oldValue, newValue) {
            debugStateChanges.push({
                time: new Date().toISOString(),
                description,
                oldValue,
                newValue
            });
        }
        
        // Helper: Log Firebase Query
        function logFirebaseQuery(path, result) {
            debugFirebaseQueries.push({
                time: new Date().toISOString(),
                path,
                result: typeof result === 'object' ? JSON.stringify(result).substring(0, 200) : String(result)
            });
        }
        
        // ğŸ†• AUTO-ZUWEISUNG & PUSH
        let assignmentTimers = {}; // Timer fÃ¼r 30-Sek-Countdown
        let notificationPermission = null;
        let serviceWorkerRegistration = null;
        let pushSubscription = null;
        let regularCustomer = null; // Stammkunden-Daten
        
        // ğŸ“… HISTORY TAB STATE
        let currentHistoryTab = 'upcoming'; // 'upcoming' oder 'past'
        
        // ğŸ” AUTH STATE
        let auth = null;
        let currentUser = null;

        // ğŸ’¾ SAVE RIDES TO LOCALSTORAGE
        function saveRides() {
            try {
                localStorage.setItem('rides', JSON.stringify(rides));
                console.log('ğŸ’¾ Rides gespeichert:', rides.length);
            } catch (error) {
                console.error('âŒ Fehler beim Speichern:', error);
            }
        }
        
        // ğŸŒŸ STAMMKUNDEN-FUNKTIONEN
        function loadRegularCustomer() {
            // âœ… Nur laden wenn User eingeloggt
            if (!currentUser) return;
            
            // âœ… Stammkunden-Daten pro Email-Adresse
            const storageKey = `regularCustomer_${currentUser.email}`;
            const saved = localStorage.getItem(storageKey);
            if (saved) {
                regularCustomer = JSON.parse(saved);
                showRegularCustomerBox();
            }
        }
        
        function showRegularCustomerBox() {
            if (!regularCustomer) return;
            
            const box = document.getElementById('regular-customer-box');
            const info = document.getElementById('regular-customer-info');
            
            // ğŸ›¡ï¸ Sicherheitscheck: Nur setzen wenn Element existiert
            if (!info || !box) {
                console.log('Stammkunden-Elemente noch nicht geladen, versuche spÃ¤ter...');
                return;
            }
            
            info.innerHTML = `
                ğŸ‘¤ <strong>${regularCustomer.name}</strong><br>
                ${regularCustomer.phone ? `ğŸ“ ${regularCustomer.phone}<br>` : ''}
                ğŸ“ HÃ¤ufig: ${regularCustomer.favoritePickup || 'Noch keine Fahrten'}<br>
                ğŸš• ${regularCustomer.rideCount || 0} Fahrten bisher
            `;
            
            box.style.display = 'block';
        }
        
        function useRegularCustomerData() {
            if (!regularCustomer) return;
            
            document.getElementById('customer-name').value = regularCustomer.name;
            if (regularCustomer.favoritePickup) {
                document.getElementById('pickup').value = regularCustomer.favoritePickup;
            }
            if (regularCustomer.favoriteDestination) {
                document.getElementById('destination').value = regularCustomer.favoriteDestination;
            }
            // âœ… TELEFON LADEN!
            if (regularCustomer.phone) {
                document.getElementById('customer-phone').value = regularCustomer.phone;
            }
            
            alert('âœ… Deine Daten wurden eingefÃ¼gt!\n\nÃœberprÃ¼fe die Adresse und buche dann dein Taxi.');
        }
        
        function clearRegularCustomer() {
            if (confirm('âš ï¸ Stammkundendaten lÃ¶schen?\n\nDu musst beim nÃ¤chsten Mal alles neu eingeben.')) {
                if (currentUser) {
                    const storageKey = `regularCustomer_${currentUser.email}`;
                    localStorage.removeItem(storageKey);
                }
                regularCustomer = null;
                document.getElementById('regular-customer-box').style.display = 'none';
                alert('âœ… Stammkundendaten gelÃ¶scht');
            }
        }
        
        function saveRegularCustomerData(name, pickup, destination) {
            // Alte Funktion - nicht mehr benÃ¶tigt
            // CRM wird jetzt automatisch Ã¼ber updateCustomerCRM() aktualisiert
        }
        
        // ğŸ“… HISTORY TAB FUNCTIONS
        function showHistoryTab(tab) {
            currentHistoryTab = tab;
            
            // Update Button Styles
            const upcomingBtn = document.getElementById('tab-upcoming');
            const pastBtn = document.getElementById('tab-past');
            
            if (tab === 'upcoming') {
                upcomingBtn.style.background = '#667eea';
                upcomingBtn.style.color = 'white';
                pastBtn.style.background = 'white';
                pastBtn.style.color = '#667eea';
            } else {
                upcomingBtn.style.background = 'white';
                upcomingBtn.style.color = '#667eea';
                pastBtn.style.background = '#667eea';
                pastBtn.style.color = 'white';
            }
            
            // Update History List
            updateHistoryView();
        }
        
        async function updateHistoryView() {
            const historyList = document.getElementById('history-list');
            let allRides = [];
            
            // ğŸ“¦ Hole Fahrten aus localStorage
            const localHistory = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            console.log('ğŸ” DEBUG - localStorage Fahrten:', localHistory.length);
            console.log('ğŸ” DEBUG - currentHistoryTab:', currentHistoryTab);
            console.log('ğŸ” DEBUG - currentUser:', currentUser ? 'eingeloggt' : 'nicht eingeloggt');
            
            // ğŸ”¥ Hole MEINE Fahrten aus Firebase (wenn verfÃ¼gbar)
            let firebaseRideIds = [];
            if (isFirebaseReady && currentUser) {
                try {
                    const snapshot = await db.ref('rides').orderByChild('userId').equalTo(currentUser.uid).once('value');
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            const ride = childSnapshot.val();
                            ride.firebaseId = childSnapshot.key;
                            allRides.push(ride);
                            firebaseRideIds.push(ride.id);
                        });
                    }
                } catch (error) {
                    console.error('âŒ Fehler beim Laden der Firebase Fahrten:', error);
                }
            }
            
            // âœ… Merge mit localStorage (dedupliziere)
            // âœ… Aber: Entferne Fahrten aus localStorage die nicht mehr in Firebase sind
            let cleanedLocalHistory = [];
            localHistory.forEach(localRide => {
                const existsInFirebase = allRides.some(fbRide => fbRide.id === localRide.id);
                if (!existsInFirebase) {
                    // PrÃ¼fe: Wenn User eingeloggt und Fahrt NICHT in Firebase
                    // â†’ KÃ¶nnte gelÃ¶scht worden sein, NICHT hinzufÃ¼gen
                    if (!currentUser || !isFirebaseReady) {
                        // Offline oder nicht eingeloggt: behalte lokale Fahrt
                        allRides.push(localRide);
                        cleanedLocalHistory.push(localRide);
                    } else {
                        // Online & eingeloggt: Fahrt nicht in Firebase = wurde gelÃ¶scht
                        console.log('ğŸ—‘ï¸ Entferne gelÃ¶schte Fahrt aus localStorage:', localRide.id);
                    }
                } else {
                    cleanedLocalHistory.push(localRide);
                }
            });
            
            // âœ… Speichere bereinigte localStorage History
            if (currentUser && isFirebaseReady && cleanedLocalHistory.length !== localHistory.length) {
                localStorage.setItem('rideHistory', JSON.stringify(cleanedLocalHistory));
                console.log('âœ… localStorage bereinigt:', cleanedLocalHistory.length, 'Fahrten');
            }
            
            console.log('ğŸ” DEBUG - Alle Fahrten nach Merge:', allRides.length);
            if (allRides.length > 0) {
                console.log('ğŸ” DEBUG - Status der Fahrten:', allRides.map(r => r.status));
            }
            
            if (allRides.length === 0) {
                historyList.innerHTML = '<div style="text-align:center;padding:40px;color:#999;"><p>Noch keine Fahrten</p></div>';
                return;
            }
            
            const now = Date.now();
            let filteredRides = [];
            
            if (currentHistoryTab === 'upcoming') {
                // ğŸ“… KOMMENDE FAHRTEN: vorbestellt, new, accepted, picked_up, etc.
                filteredRides = allRides.filter(r => {
                    const activeStatuses = ['vorbestellt', 'new', 'accepted', 'picked_up', 'akzeptiert', 'unterwegs', 'angekommen', 'assigned_to_driver', 'cancelled_pending_driver'];
                    return activeStatuses.includes(r.status);
                }).sort((a, b) => (a.pickupTimestamp || a.createdAt) - (b.pickupTimestamp || b.createdAt));
            } else {
                // ğŸ“– VERGANGENE FAHRTEN: completed, cancelled, storniert
                filteredRides = allRides.filter(r => {
                    const completedStatuses = ['completed', 'abgeschlossen', 'cancelled', 'storniert'];
                    return completedStatuses.includes(r.status);
                }).sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            }
            
            console.log('ğŸ” DEBUG - Gefilterte Fahrten:', filteredRides.length);
            console.log('ğŸ” DEBUG - Gefilterte Status:', filteredRides.map(r => r.status));
            
            if (filteredRides.length === 0) {
                const emptyMessage = currentHistoryTab === 'upcoming' 
                    ? 'ğŸ“… Keine kommenden Fahrten'
                    : 'ğŸ“– Noch keine vergangenen Fahrten';
                historyList.innerHTML = `<div style="text-align:center;padding:40px;color:#999;"><p>${emptyMessage}</p></div>`;
                return;
            }
            
            historyList.innerHTML = filteredRides.map(r => {
                const isActive = currentHistoryTab === 'upcoming';
                
                // ğŸ¨ Farben basierend auf Status
                let bgColor, borderColor, statusEmoji, statusText;
                
                switch(r.status) {
                    case 'vorbestellt':
                        bgColor = '#fef3c7';
                        borderColor = '#f59e0b';
                        statusEmoji = 'ğŸ“…';
                        statusText = 'Vorbestellt';
                        break;
                    case 'new':
                        bgColor = '#dbeafe';
                        borderColor = '#3b82f6';
                        statusEmoji = 'ğŸ””';
                        statusText = 'Sucht Fahrer...';
                        break;
                    case 'akzeptiert':
                        bgColor = '#d1fae5';
                        borderColor = '#10b981';
                        statusEmoji = 'âœ…';
                        statusText = 'Fahrer akzeptiert';
                        break;
                    case 'unterwegs':
                        bgColor = '#e0f2fe';
                        borderColor = '#0ea5e9';
                        statusEmoji = 'ğŸš—';
                        statusText = 'Fahrer unterwegs';
                        break;
                    case 'angekommen':
                        bgColor = '#fce7f3';
                        borderColor = '#ec4899';
                        statusEmoji = 'ğŸ¯';
                        statusText = 'Fahrer angekommen';
                        break;
                    case 'abgeschlossen':
                        bgColor = 'white';
                        borderColor = '#e0e0e0';
                        statusEmoji = 'âœ…';
                        statusText = 'Abgeschlossen';
                        break;
                    case 'storniert':
                        bgColor = '#fee2e2';
                        borderColor = '#ef4444';
                        statusEmoji = 'âŒ';
                        statusText = 'Storniert';
                        break;
                    default:
                        bgColor = 'white';
                        borderColor = '#e0e0e0';
                        statusEmoji = 'ğŸ“„';
                        statusText = r.status;
                }
                
                // ğŸ• Zeitanzeige
                let timeDisplay = r.pickupTime || 'Sofort';
                if (r.pickupTimestamp) {
                    const pickupDate = new Date(r.pickupTimestamp);
                    timeDisplay = pickupDate.toLocaleString('de-DE', {
                        weekday: 'short',
                        day: '2-digit',
                        month: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
                
                // ğŸš— Fahrzeug-Info (falls vorhanden)
                let vehicleInfo = '';
                if (r.assignedDriver && r.vehicleLabel) {
                    vehicleInfo = `<div style="margin-top:8px;padding:8px;background:rgba(102,126,234,0.1);border-radius:6px;font-size:12px;">
                        ğŸš— <strong>${r.vehicleLabel}</strong>
                    </div>`;
                }
                
                // â±ï¸ ETA Info (falls Fahrer unterwegs)
                let etaInfo = '';
                if (r.status === 'unterwegs' && r.eta) {
                    etaInfo = `<div style="margin-top:8px;padding:8px;background:#dcfce7;border-radius:6px;font-size:13px;font-weight:600;color:#166534;">
                        â±ï¸ Ankunft in ca. ${r.eta} Min
                    </div>`;
                }
                
                // ğŸš¨ STORNIERUNGSGRUND (falls vorhanden)
                let cancellationInfo = '';
                if (r.status === 'storniert' && r.cancellationReason) {
                    cancellationInfo = `<div style="margin-top:8px;padding:10px;background:#fee2e2;border-left:4px solid #ef4444;border-radius:6px;font-size:13px;color:#991b1b;">
                        <strong>ğŸš¨ Stornierungsgrund:</strong><br>
                        ${r.cancellationReason}
                    </div>`;
                }
                
                // ğŸ”˜ Aktions-Buttons
                let actionButtons = '';
                if (isActive && r.status !== 'storniert') {
                    if (r.status === 'vorbestellt' || r.status === 'new') {
                        // Vorbestellungen + Neue Fahrten: Bearbeiten & Stornieren
                        actionButtons = `
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;">
                                <button onclick="editRide('${r.firebaseId || r.id}')" 
                                    style="padding:10px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">
                                    âœï¸ Bearbeiten
                                </button>
                                <button onclick="cancelRideFromHistory('${r.firebaseId || r.id}')" 
                                    style="padding:10px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">
                                    ğŸ—‘ï¸ Stornieren
                                </button>
                            </div>
                        `;
                    } else if (r.firebaseId) {
                        actionButtons = `<button onclick="viewRideDetails('${r.firebaseId}')" 
                            style="width:100%;margin-top:10px;padding:10px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">
                            ğŸ‘ï¸ Details anzeigen
                        </button>`;
                    }
                } else {
                    // Vergangene Fahrten: 3 Buttons
                    actionButtons = `
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;">
                            <button onclick="rebookRide(${r.createdAt || r.id})" 
                                style="padding:10px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">
                                ğŸ” Nochmal
                            </button>
                            <button onclick="reverseRouteFromHistory(${r.createdAt || r.id})" 
                                style="padding:10px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">
                                ğŸ”„ Umdrehen
                            </button>
                        </div>
                        <button onclick="saveAsFavorite(${r.createdAt || r.id})" 
                            style="width:100%;margin-top:8px;padding:10px;background:#f59e0b;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">
                            â­ Als Favorit
                        </button>
                    `;
                }
                
                return `
                    <div style="background:${bgColor};border:2px solid ${borderColor};border-radius:12px;padding:15px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                        <div style="font-weight:600;color:#374151;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                            <span>${statusEmoji} ${statusText}</span>
                            ${isActive ? '<span style="font-size:11px;color:#6b7280;">ğŸ• ' + timeDisplay + '</span>' : ''}
                        </div>
                        ${!isActive ? `<div style="font-size:12px;color:#666;margin-bottom:8px;">ğŸ• ${timeDisplay}</div>` : ''}
                        <div style="margin:10px 0;font-size:14px;">
                            ğŸ“ <strong>Von:</strong> ${r.pickup}<br>
                            ğŸ¯ <strong>Nach:</strong> ${r.destination}
                        </div>
                        <div style="display:flex;gap:12px;margin-top:8px;font-size:13px;color:#666;">
                            <span>ğŸ’° ${r.price}â‚¬</span>
                            <span>ğŸ“ ${r.distance} km</span>
                            ${r.passengers ? `<span>ğŸ‘¥ ${r.passengers}</span>` : ''}
                        </div>
                        ${vehicleInfo}
                        ${etaInfo}
                        ${cancellationInfo}
                        ${actionButtons}
                    </div>
                `;
            }).join('');
        }

        // ğŸ“… DATUM & ZEIT PICKER
        function handlePickupTimeChange() {
            const select = document.getElementById('pickup-time');
            const datetimePicker = document.getElementById('custom-datetime');
            const helpText = document.getElementById('datetime-help');
            
            if (select.value === 'datetime') {
                datetimePicker.style.display = 'block';
                if (helpText) helpText.style.display = 'block';
                
                // Setze Minimum auf jetzt + 15 Minuten
                const now = new Date();
                now.setMinutes(now.getMinutes() + 15);
                const minDateTime = now.toISOString().slice(0, 16);
                datetimePicker.min = minDateTime;
                
                // Setze Standard auf jetzt + 1 Stunde
                const defaultTime = new Date();
                defaultTime.setHours(defaultTime.getHours() + 1);
                datetimePicker.value = defaultTime.toISOString().slice(0, 16);
                
            } else {
                datetimePicker.style.display = 'none';
                if (helpText) helpText.style.display = 'none';
            }
        }

        // ğŸ—‘ï¸ Fahrt aus Verlauf stornieren
        async function cancelRideFromHistory(rideId) {
            const confirmCancel = confirm('ğŸ—‘ï¸ Fahrt wirklich stornieren?');
            if (!confirmCancel) return;
            
            // Update Firebase
            if (isFirebaseReady && rideId) {
                try {
                    await db.ref('rides/' + rideId).update({ 
                        status: 'storniert',
                        cancelledAt: Date.now()
                    });
                    console.log('âœ… Fahrt in Firebase storniert');
                } catch (error) {
                    console.error('âŒ Fehler beim Stornieren in Firebase:', error);
                }
            }
            
            // Update localStorage
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            const ride = history.find(r => r.firebaseId === rideId || r.id === rideId);
            if (ride) {
                ride.status = 'storniert';
                ride.cancelledAt = Date.now();
                localStorage.setItem('rideHistory', JSON.stringify(history));
                console.log('âœ… Fahrt in localStorage storniert');
            }
            
            alert('âœ… Fahrt wurde storniert');
            updateHistoryView();
        }
        
        // ğŸ‘ï¸ Fahrtdetails anzeigen (wechselt zum Fahrgast-Tab und zeigt Status)
        function viewRideDetails(rideId) {
            if (!isFirebaseReady || !rideId) return;
            
            // Lade Fahrt und zeige Status an
            db.ref('rides/' + rideId).once('value', (snapshot) => {
                const ride = snapshot.val();
                if (ride) {
                    ride.firebaseId = rideId;
                    myCurrentRide = ride;
                    localStorage.setItem('myCurrentRideId', rideId);
                    
                    // Wechsel zum Fahrgast-Tab
                    switchView('passenger');
                    
                    // Zeige Fahrt-Status
                    showRideStatus(ride);
                    
                    // Starte Live-Listener
                    listenToMyRide(rideId);
                }
            });
        }
        
        // ğŸ” FAHRT WIEDERHOLEN
        function rebookRide(rideId) {
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            const ride = history.find(r => r.createdAt === rideId || r.id === rideId);
            
            if (!ride) {
                alert('âŒ Fahrt nicht gefunden');
                return;
            }
            
            // Wechsel zum Fahrgast-Tab
            switchView('passenger');
            
            // âœ… Warte kurz bis View gewechselt hat
            setTimeout(() => {
                // FÃ¼lle Formular aus
                document.getElementById('pickup').value = ride.pickup;
                document.getElementById('destination').value = ride.destination;
                document.getElementById('customer-name').value = ride.customerName || '';
                document.getElementById('passengers').value = ride.passengers || '1';
                
                // âœ… LÃ¶sche alte Koordinaten (mÃ¼ssen neu berechnet werden)
                pickupCoords = null;
                destCoords = null;
                
                // âœ… Setze Preis-Anzeige zurÃ¼ck
                document.getElementById('price-display').innerHTML = '';
                
                // âœ… Deaktiviere "Taxi buchen" Button
                const bookBtn = document.getElementById('book-taxi-btn');
                if (bookBtn) {
                    bookBtn.disabled = true;
                    bookBtn.style.opacity = '0.5';
                    bookBtn.style.cursor = 'not-allowed';
                }
                
                // âœ… Stelle sicher dass Formular sichtbar ist
                const bookingForm = document.getElementById('booking-form');
                if (bookingForm) {
                    bookingForm.style.display = 'block';
                    // Scroll zum Formular
                    bookingForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                
                // Zeige Hinweis
                setTimeout(() => {
                    alert('âœ… Fahrtdaten Ã¼bernommen!\n\nâš ï¸ WICHTIG:\nBitte PREIS NEU BERECHNEN\n(Tarif kÃ¶nnte sich geÃ¤ndert haben!)');
                }, 300);
            }, 100);
        }
        
        // ğŸ”„ ROUTE UMDREHEN
        function reverseRouteFromHistory(rideId) {
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            const ride = history.find(r => r.createdAt === rideId || r.id === rideId);
            
            if (!ride) {
                alert('âŒ Fahrt nicht gefunden');
                return;
            }
            
            // Wechsel zum Fahrgast-Tab
            switchView('passenger');
            
            // âœ… Warte kurz bis View gewechselt hat
            setTimeout(() => {
                // FÃ¼lle Formular aus MIT UMGEDREHTER ROUTE
                document.getElementById('pickup').value = ride.destination;  // â† GETAUSCHT
                document.getElementById('destination').value = ride.pickup;   // â† GETAUSCHT
                document.getElementById('customer-name').value = ride.customerName || '';
                document.getElementById('passengers').value = ride.passengers || '1';
                
                // âœ… LÃ¶sche alte Koordinaten (mÃ¼ssen neu berechnet werden)
                pickupCoords = null;
                destCoords = null;
                
                // âœ… Setze Preis-Anzeige zurÃ¼ck
                document.getElementById('price-display').innerHTML = '';
                
                // âœ… Deaktiviere "Taxi buchen" Button
                const bookBtn = document.getElementById('book-taxi-btn');
                if (bookBtn) {
                    bookBtn.disabled = true;
                    bookBtn.style.opacity = '0.5';
                    bookBtn.style.cursor = 'not-allowed';
                }
                
                // âœ… Stelle sicher dass Formular sichtbar ist
                const bookingForm = document.getElementById('booking-form');
                if (bookingForm) {
                    bookingForm.style.display = 'block';
                    // Scroll zum Formular
                    bookingForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                
                // Zeige Hinweis
                setTimeout(() => {
                    alert('ğŸ”„ Route umgedreht!\n\n' + 
                          'Von: ' + ride.destination + '\n' +
                          'Nach: ' + ride.pickup + '\n\n' +
                          'âš ï¸ WICHTIG:\nBitte PREIS NEU BERECHNEN\n(Tarif kÃ¶nnte sich geÃ¤ndert haben!)');
                }, 300);
            }, 100);
        }
        
        // â­ ALS FAVORIT SPEICHERN
        function saveAsFavorite(rideId) {
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            const ride = history.find(r => r.createdAt === rideId || r.id === rideId);
            
            if (!ride) {
                alert('âŒ Fahrt nicht gefunden');
                return;
            }
            
            // Lade bestehende Favoriten
            const favorites = JSON.parse(localStorage.getItem('favoritRides') || '[]');
            
            // PrÃ¼fe ob schon vorhanden
            const exists = favorites.some(f => 
                f.pickup === ride.pickup && f.destination === ride.destination
            );
            
            if (exists) {
                alert('â­ Diese Route ist bereits ein Favorit!');
                return;
            }
            
            // FÃ¼ge hinzu
            const favorite = {
                id: Date.now(),
                name: `${ride.pickup} â†’ ${ride.destination}`,
                pickup: ride.pickup,
                destination: ride.destination,
                distance: ride.distance,
                price: ride.price,
                addedAt: Date.now()
            };
            
            favorites.push(favorite);
            localStorage.setItem('favoritRides', JSON.stringify(favorites));
            
            alert('â­ Als Favorit gespeichert!\n\n' +
                  ride.pickup + ' â†’ ' + ride.destination + '\n\n' +
                  'Favoriten findest du im Fahrgast-Tab oben.');
            
            // TODO: Favoriten-Anzeige implementieren
        }
        
        // âœï¸ FAHRT BEARBEITEN
        async function editRide(rideId) {
            // Lade Fahrt aus Firebase
            let ride = null;
            
            if (isFirebaseReady) {
                const snapshot = await db.ref('rides/' + rideId).once('value');
                ride = snapshot.val();
                if (ride) ride.firebaseId = rideId;
            }
            
            // Falls nicht in Firebase, suche in localStorage
            if (!ride) {
                const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
                ride = history.find(r => r.firebaseId === rideId || r.id === rideId);
            }
            
            if (!ride) {
                alert('âŒ Fahrt nicht gefunden');
                return;
            }
            
            // Erstelle Bearbeitungs-Modal
            const pickupDate = ride.pickupTimestamp ? new Date(ride.pickupTimestamp) : new Date();
            // FIX: Konvertiere zu lokaler Zeit fÃ¼r datetime-local Input
            const year = pickupDate.getFullYear();
            const month = String(pickupDate.getMonth() + 1).padStart(2, '0');
            const day = String(pickupDate.getDate()).padStart(2, '0');
            const hours = String(pickupDate.getHours()).padStart(2, '0');
            const minutes = String(pickupDate.getMinutes()).padStart(2, '0');
            const formattedDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;max-width:400px;width:90%;max-height:80vh;overflow-y:auto;">
                    <h3 style="margin-bottom:15px;">âœï¸ Fahrt bearbeiten</h3>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block;margin-bottom:5px;font-weight:600;">ğŸ“ Abholort</label>
                        <input type="text" id="edit-pickup" value="${ride.pickup}" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block;margin-bottom:5px;font-weight:600;">ğŸ¯ Zielort</label>
                        <input type="text" id="edit-destination" value="${ride.destination}" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block;margin-bottom:5px;font-weight:600;">ğŸ‘¤ Kundenname</label>
                        <input type="text" id="edit-customer" value="${ride.customerName || ''}" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block;margin-bottom:5px;font-weight:600;">ğŸ• Abholzeit</label>
                        <input type="datetime-local" id="edit-datetime" value="${formattedDateTime}" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block;margin-bottom:5px;font-weight:600;">ğŸ‘¥ Personen</label>
                        <select id="edit-passengers" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
                            <option value="1" ${ride.passengers == 1 ? 'selected' : ''}>1 Person</option>
                            <option value="2" ${ride.passengers == 2 ? 'selected' : ''}>2 Personen</option>
                            <option value="3" ${ride.passengers == 3 ? 'selected' : ''}>3 Personen</option>
                            <option value="4" ${ride.passengers == 4 ? 'selected' : ''}>4 Personen</option>
                        </select>
                    </div>
                    
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button onclick="saveEditedRide('${rideId}')" style="flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                            âœ… Speichern
                        </button>
                        <button onclick="closeEditModal()" style="flex:1;padding:12px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                            âŒ Abbrechen
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentEditModal = modal;
        }
        
        function closeEditModal() {
            if (window.currentEditModal) {
                window.currentEditModal.remove();
                window.currentEditModal = null;
            }
        }
        
        async function saveEditedRide(rideId) {
            const newPickup = document.getElementById('edit-pickup').value.trim();
            const newDestination = document.getElementById('edit-destination').value.trim();
            const newCustomer = document.getElementById('edit-customer').value.trim();
            const newDateTime = document.getElementById('edit-datetime').value;
            const newPassengers = document.getElementById('edit-passengers').value;
            
            if (!newPickup || !newDestination) {
                alert('âŒ Abholort und Zielort mÃ¼ssen ausgefÃ¼llt sein!');
                return;
            }
            
            const newTimestamp = new Date(newDateTime).getTime();
            const now = Date.now();
            const minutesUntilPickup = (newTimestamp - now) / (1000 * 60);
            const newStatus = minutesUntilPickup <= 15 ? 'new' : 'vorbestellt';
            
            const updates = {
                pickup: newPickup,
                destination: newDestination,
                customerName: newCustomer,
                pickupTimestamp: newTimestamp,
                pickupTime: new Date(newTimestamp).toLocaleString('de-DE', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                passengers: newPassengers,
                status: newStatus,
                editedAt: Date.now()
            };
            
            // Update Firebase
            if (isFirebaseReady) {
                try {
                    await db.ref('rides/' + rideId).update(updates);
                    console.log('âœ… Fahrt in Firebase aktualisiert');
                } catch (error) {
                    console.error('âŒ Fehler beim Aktualisieren:', error);
                }
            }
            
            // Update localStorage
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            const ride = history.find(r => r.firebaseId === rideId || r.id === rideId);
            if (ride) {
                Object.assign(ride, updates);
                localStorage.setItem('rideHistory', JSON.stringify(history));
            }
            
            closeEditModal();
            alert('âœ… Fahrt wurde aktualisiert!');
            
            // Aktualisiere Views
            updateHistoryView();
            updateAdminView();
        }
        
        // ğŸ”„ FAHRT NEU ZUWEISEN (aus rejected zurÃ¼ck zu new)
        async function reassignRide(rideId) {
            if (!confirm('ğŸ”„ Fahrt neu zuweisen?\n\nDie Fahrt wird wieder als "neu" markiert und kann von Fahrern angenommen werden.')) {
                return;
            }
            
            try {
                const ride = rides.find(r => (r.firebaseId || r.id) === rideId);
                if (!ride) {
                    alert('âŒ Fahrt nicht gefunden!');
                    return;
                }
                
                // ZurÃ¼ck zu "new" Status
                const updates = {
                    status: 'new',
                    rejectedBy: null,
                    rejectedAt: null,
                    rejectedByDriver: null,
                    vehicleId: null,
                    vehicle: null
                };
                
                if (isFirebaseReady) {
                    await db.ref('rides/' + rideId).update(updates);
                    console.log('ğŸ”„ Fahrt neu zugewiesen:', rideId);
                }
                
                // Update lokal
                Object.assign(ride, updates);
                saveRides();
                
                updateViews();
                alert('âœ… Fahrt neu zugewiesen!\n\nDie Fahrt ist jetzt wieder fÃ¼r alle Fahrer verfÃ¼gbar.');
                
            } catch (error) {
                console.error('âŒ Fehler beim Neu-Zuweisen:', error);
                alert('âŒ Fehler: ' + error.message);
            }
        }
        
        // ğŸ—‘ï¸ FAHRT LÃ–SCHEN (Admin)
        async function deleteRide(rideId) {
            const confirmDelete = confirm('ğŸ—‘ï¸ Fahrt wirklich LÃ–SCHEN?\n\nDies kann nicht rÃ¼ckgÃ¤ngig gemacht werden!');
            if (!confirmDelete) return;
            
            // LÃ¶sche aus Firebase
            if (isFirebaseReady) {
                try {
                    await db.ref('rides/' + rideId).remove();
                    console.log('âœ… Fahrt aus Firebase gelÃ¶scht');
                } catch (error) {
                    console.error('âŒ Fehler beim LÃ¶schen:', error);
                }
            }
            
            // LÃ¶sche aus localStorage
            let history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            history = history.filter(r => r.firebaseId !== rideId && r.id !== rideId);
            localStorage.setItem('rideHistory', JSON.stringify(history));
            
            alert('âœ… Fahrt wurde gelÃ¶scht!');
            updateAdminView();
        }
        
        // ğŸ”„ ROUTE UMDREHEN (Admin - direkt in Firebase)
        async function reverseRouteAdmin(rideId) {
            const confirmReverse = confirm('ğŸ”„ Route umdrehen?\n\nVon â‡„ Nach werden getauscht.');
            if (!confirmReverse) return;
            
            // Lade Fahrt
            let ride = null;
            if (isFirebaseReady) {
                const snapshot = await db.ref('rides/' + rideId).once('value');
                ride = snapshot.val();
            }
            
            if (!ride) {
                alert('âŒ Fahrt nicht gefunden');
                return;
            }
            
            // Tausche Von/Nach
            const updates = {
                pickup: ride.destination,
                destination: ride.pickup,
                editedAt: Date.now()
            };
            
            // Update Firebase
            if (isFirebaseReady) {
                try {
                    await db.ref('rides/' + rideId).update(updates);
                    console.log('âœ… Route in Firebase umgedreht');
                } catch (error) {
                    console.error('âŒ Fehler:', error);
                }
            }
            
            // Update localStorage
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            const localRide = history.find(r => r.firebaseId === rideId || r.id === rideId);
            if (localRide) {
                Object.assign(localRide, updates);
                localStorage.setItem('rideHistory', JSON.stringify(history));
            }
            
            alert('âœ… Route wurde umgedreht!\n\n' + 
                  'Neu:\n' +
                  'Von: ' + ride.destination + '\n' +
                  'Nach: ' + ride.pickup);
            
            updateAdminView();
        }
        
        function saveAsFavorite(rideId) {
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            const ride = history.find(r => r.createdAt === rideId || r.id === rideId);
            
            if (!ride) {
                alert('âŒ Fahrt nicht gefunden');
                return;
            }
            
            // Lade bestehende Favoriten
            const favorites = JSON.parse(localStorage.getItem('favoritRides') || '[]');
            
            // PrÃ¼fe ob schon vorhanden
            const exists = favorites.some(f => 
                f.pickup === ride.pickup && f.destination === ride.destination
            );
            
            if (exists) {
                alert('â­ Diese Route ist bereits ein Favorit!');
                return;
            }
            
            // FÃ¼ge hinzu
            const favorite = {
                id: Date.now(),
                name: `${ride.pickup} â†’ ${ride.destination}`,
                pickup: ride.pickup,
                destination: ride.destination,
                distance: ride.distance,
                price: ride.price,
                addedAt: Date.now()
            };
            
            favorites.push(favorite);
            localStorage.setItem('favoritRides', JSON.stringify(favorites));
            
            alert('â­ Als Favorit gespeichert!\n\n' +
                  ride.pickup + ' â†’ ' + ride.destination + '\n\n' +
                  'Favoriten findest du im Fahrgast-Tab oben.');
            
            // TODO: Favoriten-Anzeige implementieren
        }

        console.log('ğŸš€ Taxi App v3.9.7 gestartet');

        // ğŸ”” SERVICE WORKER & PUSH NOTIFICATIONS
        async function initServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    serviceWorkerRegistration = await navigator.serviceWorker.register('/service-worker.js');
                    console.log('âœ… Service Worker registriert:', serviceWorkerRegistration);
                    
                    // Warte bis Service Worker aktiv ist
                    await navigator.serviceWorker.ready;
                    console.log('âœ… Service Worker bereit');
                    
                    // Push-Benachrichtigungen aktivieren
                    await initPushNotifications();
                } catch (err) {
                    console.error('âŒ Service Worker Fehler:', err);
                }
            } else {
                console.warn('âš ï¸ Service Worker nicht unterstÃ¼tzt');
            }
        }

        async function initPushNotifications() {
            if (!('Notification' in window)) {
                console.warn('âš ï¸ Benachrichtigungen nicht unterstÃ¼tzt');
                return;
            }
            
            notificationPermission = Notification.permission;
            console.log('ğŸ”” Notification Permission:', notificationPermission);
            
            if (notificationPermission === 'granted') {
                console.log('âœ… Benachrichtigungen bereits erlaubt');
            }
        }

        function showNotificationPrompt() {
            // Entferne altes Banner falls vorhanden
            const oldBanner = document.getElementById('notification-banner');
            if (oldBanner) oldBanner.remove();
            
            const banner = document.createElement('div');
            banner.id = 'notification-banner';
            banner.style.cssText = 'position:fixed;top:140px;left:10px;right:10px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;border-radius:12px;text-align:center;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.3);animation:slideDown 0.3s ease;';
            banner.innerHTML = `
                <div style="font-size:48px;margin-bottom:10px;">ğŸ””</div>
                <div style="margin-bottom:15px;">
                    <strong style="font-size:18px;">Benachrichtigungen aktivieren?</strong><br>
                    <span style="font-size:14px;opacity:0.9;margin-top:5px;display:block;">Erhalte sofort Push-Benachrichtigungen bei neuen Buchungen - auch wenn die App geschlossen ist!</span>
                </div>
                <button onclick="requestNotificationPermission()" style="background:white;color:#667eea;border:none;padding:14px 24px;border-radius:8px;font-weight:700;cursor:pointer;margin-right:10px;font-size:15px;box-shadow:0 2px 8px rgba(0,0,0,0.2);">âœ“ Jetzt aktivieren</button>
                <button onclick="document.getElementById('notification-banner').remove()" style="background:rgba(255,255,255,0.2);color:white;border:2px solid white;padding:14px 24px;border-radius:8px;font-weight:600;cursor:pointer;font-size:15px;">SpÃ¤ter</button>
            `;
            
            // CSS Animation
            const style = document.createElement('style');
            style.textContent = '@keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }';
            document.head.appendChild(style);
            
            document.body.appendChild(banner);
            
            console.log('ğŸ”” Benachrichtigungs-Banner angezeigt');
        }

        async function requestNotificationPermission() {
            try {
                // Banner entfernen (beide Varianten)
                const staticBanner = document.getElementById('static-notification-banner');
                if (staticBanner) staticBanner.style.display = 'none';
                
                const banner = document.getElementById('notification-banner');
                if (banner) banner.remove();
                
                notificationPermission = await Notification.requestPermission();
                console.log('ğŸ”” Notification Permission:', notificationPermission);
                
                if (notificationPermission === 'granted') {
                    // Zeige BestÃ¤tigung
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = 'position:fixed;top:140px;left:10px;right:10px;background:#10b981;color:white;padding:20px;border-radius:12px;text-align:center;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.3);';
                    successMsg.innerHTML = `
                        <div style="font-size:48px;margin-bottom:10px;">âœ…</div>
                        <div style="font-size:16px;font-weight:600;">Benachrichtigungen aktiviert!</div>
                        <div style="font-size:14px;margin-top:8px;opacity:0.9;">Du erhÃ¤ltst jetzt Push-Benachrichtigungen fÃ¼r neue Fahrten</div>
                    `;
                    document.body.appendChild(successMsg);
                    
                    // Automatisch nach 3 Sekunden ausblenden
                    setTimeout(() => {
                        successMsg.style.transition = 'opacity 0.5s';
                        successMsg.style.opacity = '0';
                        setTimeout(() => successMsg.remove(), 500);
                    }, 3000);
                    
                } else if (notificationPermission === 'denied') {
                    // Zeige Hilfe-Info
                    alert('âš ï¸ Benachrichtigungen wurden blockiert.\n\nSo kannst du sie aktivieren:\n\n1. Tippe auf das ğŸ”’ Schloss in der Adressleiste\n2. Gehe zu "Berechtigungen"\n3. Stelle "Benachrichtigungen" auf "Zulassen"');
                }
            } catch (err) {
                console.error('âŒ Notification Permission Fehler:', err);
                alert('âŒ Fehler beim Aktivieren der Benachrichtigungen.\n\nBitte versuche es Ã¼ber die Browser-Einstellungen.');
            }
        }

        // Lokale Benachrichtigung anzeigen
        function sendLocalNotification(title, body, data = {}) {
            if (notificationPermission !== 'granted') {
                console.warn('âš ï¸ Keine Berechtigung fÃ¼r Benachrichtigungen');
                // Fallback: Sound abspielen
                playNotificationSound();
                return;
            }
            
            // Wenn Service Worker verfÃ¼gbar, nutze diesen
            if (serviceWorkerRegistration) {
                serviceWorkerRegistration.showNotification(title, {
                    body: body,
                    icon: '/icon-192.png',
                    badge: '/icon-192.png',
                    vibrate: [200, 100, 200, 100, 200],
                    tag: 'taxi-ride-' + (data.rideId || Date.now()),
                    requireInteraction: true,
                    data: data,
                    actions: [
                        { action: 'view', title: 'ğŸ‘€ Anzeigen' },
                        { action: 'close', title: 'âŒ SchlieÃŸen' }
                    ]
                });
            } else {
                // Fallback: Browser Notification API
                const notification = new Notification(title, {
                    body: body,
                    icon: '/icon-192.png',
                    vibrate: [200, 100, 200, 100, 200],
                    tag: 'taxi-ride-' + (data.rideId || Date.now()),
                    requireInteraction: true
                });
                
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            }
            
            // Sound abspielen
            playNotificationSound();
        }

        function playNotificationSound() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+');
                audio.volume = 0.5;
                audio.play().catch(e => console.log('ğŸ”‡ Audio blockiert'));
            } catch (e) {
                console.log('ğŸ”‡ Audio nicht verfÃ¼gbar');
            }
        }

        // INIT
        function initApp(hasFirebase) {
            clearTimeout(firebaseLoadTimeout);
            console.log('ğŸ“± App initialisiert');
            
            if (hasFirebase && typeof firebase !== 'undefined') {
                try {
                    firebase.initializeApp({
                        apiKey: "AIzaSyD2eHFuplImxBCijd3MWlKyCwXUZHLmhhE",
                        authDomain: "taxi-heringsdorf.firebaseapp.com",
                        databaseURL: "https://taxi-heringsdorf-default-rtdb.europe-west1.firebasedatabase.app",
                        projectId: "taxi-heringsdorf",
                        storageBucket: "taxi-heringsdorf.firebasestorage.app",
                        messagingSenderId: "886448081276",
                        appId: "1:886448081276:web:1b54875801c5d89f8efcf9"
                    });
                    db = firebase.database();
                    isFirebaseReady = true;
                    console.log('âœ… Firebase verbunden');
                    
                    // ğŸ” Firebase Auth initialisieren mit LOCAL Persistence
                    auth = firebase.auth();
                    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(() => {
                        console.log('âœ… Auth Persistence: LOCAL');
                    }).catch((error) => {
                        console.error('âŒ Persistence Fehler:', error);
                    });
                    
                    auth.onAuthStateChanged((user) => {
                        if (user) {
                            onUserLoggedIn(user);
                        } else {
                            onUserLoggedOut();
                        }
                    });
                    
                    db.ref('.info/connected').on('value', (s) => { isConnected = s.val(); updateStatus(); });
                    db.ref('rides').on('value', (s) => {
                        const previousCount = rides.filter(r => r.status === 'new').length;
                        rides = [];
                        s.forEach(c => {
                            const r = c.val();
                            r.firebaseId = c.key;
                            rides.push(r);
                            if (myCurrentRide && r.id === myCurrentRide.id) {
                                // PrÃ¼fe ob Fahrt storniert wurde
                                if (r.status === 'storniert' && myCurrentRide.status !== 'storniert') {
                                    // Fahrt wurde gerade storniert!
                                    alert('âš ï¸ STORNIERUNG!\n\nDer Fahrgast hat die Fahrt storniert.\n\n' + 
                                          'Von: ' + r.pickup + '\n' +
                                          'Nach: ' + r.destination);
                                    
                                    // Stoppe Navigations-Updates
                                    if (window.driverMapUpdateInterval) {
                                        clearInterval(window.driverMapUpdateInterval);
                                        window.driverMapUpdateInterval = null;
                                        console.log('ğŸ›‘ Navigations-Updates gestoppt');
                                    }
                                    
                                    // LÃ¶sche Karte
                                    if (map) {
                                        map.remove();
                                        map = null;
                                        taxiMarker = null;
                                        pickupMarker = null;
                                        console.log('ğŸ—ºï¸ Karte entfernt');
                                    }
                                    
                                    // LÃ¶sche Fahrer-Karte
                                    if (driverMap) {
                                        driverMap.remove();
                                        driverMap = null;
                                        driverMarker = null;
                                        pickupMarker = null;
                                        routeLine = null;
                                        console.log('ğŸ—ºï¸ Fahrer-Karte entfernt');
                                    }
                                    
                                    // LÃ¶sche aus myCurrentRide
                                    localStorage.removeItem('myCurrentRideId');
                                    myCurrentRide = null;
                                    document.getElementById('ride-status-container').innerHTML = '';
                                    
                                    // Zeige wieder verfÃ¼gbare Fahrten
                                    if (currentView === 'driver') {
                                        updateDriverView();
                                    }
                                }
                                
                                myCurrentRide = r;
                                if (r.status === 'accepted' && r.driverLocation) showRideStatus(r);
                                if (r.status === 'picked_up') showRideStatus(r);
                                if (r.status === 'completed') showRideStatus(r);
                            }
                        });
                        
                        const currentCount = rides.filter(r => r.status === 'new').length;
                        if (currentCount > previousCount && currentView === 'driver') {
                            playDriverNotificationSound();
                            
                            // ğŸ†• ZEIGE FULLSCREEN POPUP bei neuem Auftrag
                            showNewRideFullscreen();
                        }
                        
                        updateViews();
                    });
                    db.ref('drivers').on('value', (s) => { 
                        drivers = {}; 
                        s.forEach(c => { drivers[c.key] = c.val(); }); 
                        showAvailableTaxis();
                        if (currentView === 'admin') updateAdminView(); // â† Update Admin fÃ¼r Online-Fahrer
                    });
                    db.ref('cancellations').on('value', (s) => {
                        cancellations = [];
                        s.forEach(c => {
                            const cancel = c.val();
                            cancel.firebaseId = c.key;
                            cancellations.push(cancel);
                        });
                        if (currentView === 'admin') updateAdminView();
                    });
                } catch (e) { 
                    console.error('âŒ Firebase Fehler:', e); 
                }
            } else {
                console.log('âš ï¸ Firebase nicht verfÃ¼gbar - Lokaler Modus');
            }
            
            updateStatus();
            updateViews(); // WICHTIG: Views auch ohne Firebase laden!
            
            // ğŸ”” SERVICE WORKER & PUSH initialisieren
            initServiceWorker();
        }

        function updateStatus() {
            const dot = document.getElementById('sync-dot');
            const status = document.getElementById('sync-status');
            if (isFirebaseReady && isConnected) {
                dot.classList.add('online');
                status.textContent = 'ğŸŸ¢ Live';
            } else {
                dot.classList.remove('online');
                status.textContent = 'ğŸ’¾ Lokal';
            }
        }

        // ğŸ”” SERVICE WORKER & PUSH BENACHRICHTIGUNGEN
        async function initServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    serviceWorkerRegistration = await navigator.serviceWorker.register('/service-worker.js');
                    console.log('âœ… Service Worker registriert:', serviceWorkerRegistration.scope);
                    
                    // Push-Berechtigung anfragen (nur beim ersten Mal oder wenn abgelehnt)
                    if ('Notification' in window) {
                        notificationPermission = await Notification.requestPermission();
                        console.log('ğŸ”” Notification Permission:', notificationPermission);
                        
                        if (notificationPermission === 'granted') {
                            console.log('âœ… Push-Benachrichtigungen erlaubt!');
                        }
                    }
                } catch (error) {
                    console.error('âŒ Service Worker Fehler:', error);
                }
            } else {
                console.warn('âš ï¸ Service Worker nicht unterstÃ¼tzt');
            }
        }

        // Push-Benachrichtigung senden (lokal)
        function sendLocalNotification(title, body, data = {}) {
            if ('Notification' in window && Notification.permission === 'granted') {
                if (serviceWorkerRegistration) {
                    serviceWorkerRegistration.showNotification(title, {
                        body: body,
                        icon: '/icon-192.png',
                        badge: '/badge-72.png',
                        vibrate: [200, 100, 200, 100, 200],
                        tag: 'taxi-' + (data.rideId || 'notification'),
                        requireInteraction: true,
                        data: data,
                        actions: [
                            { action: 'accept', title: 'âœ“ Annehmen' },
                            { action: 'dismiss', title: 'âœ• Ablehnen' }
                        ]
                    });
                    
                    // Sound abspielen
                    playNotificationSound();
                }
            } else {
                console.warn('âš ï¸ Notifications nicht verfÃ¼gbar oder nicht erlaubt');
            }
        }

        // Sound fÃ¼r Benachrichtigungen
        function playNotificationSound() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ==');
                audio.volume = 1.0;
                audio.play().catch(e => console.log('ğŸ”‡ Audio play blocked'));
            } catch (e) {
                console.log('ğŸ”‡ Audio not supported');
            }
        }

        function switchView(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            
            // âœ… Sichere Zugriffe - Element kÃ¶nnte fehlen
            const viewElement = document.getElementById(view + '-view');
            if (viewElement) {
                viewElement.classList.add('active');
            }
            
            // âœ… Setze aktiven Button basierend auf View-Name
            const viewBtnMap = {
                'passenger': '.view-btn[onclick*="passenger"]',
                'history': '.view-btn[onclick*="history"]',
                'driver': '.view-btn[onclick*="driver"]',
                'admin': '.view-btn[onclick*="admin"]'
            };
            const btnSelector = viewBtnMap[view];
            if (btnSelector) {
                const btn = document.querySelector(btnSelector);
                if (btn) btn.classList.add('active');
            }
            
            currentView = view;
            
            const gpsIndicator = document.getElementById('gps-indicator');
            if (view === 'driver') {
                if (gpsIndicator) gpsIndicator.style.display = 'flex';
                
                // ğŸ¯ AUTO-START GPS beim Ã–ffnen der Fahrer-Ansicht!
                console.log('ğŸš• Fahrer-Ansicht geÃ¶ffnet - starte GPS automatisch...');
                setTimeout(() => {
                    if (!watchId && currentVehicle) {
                        console.log('ğŸ”„ GPS Auto-Start...');
                        startGPSTracking();
                    }
                    // Starte GPS-Monitoring
                    startGPSMonitoring();
                }, 500);
            } else {
                if (gpsIndicator) gpsIndicator.style.display = 'none';
                // âœ… Stoppe GPS-Monitoring UND GPS-Tracking wenn Ansicht gewechselt wird
                stopGPSMonitoring();
                stopDriverTracking();  // â† FIX: GPS auch stoppen!
                console.log('ğŸ”„ View gewechselt - GPS gestoppt');
            }
            
            if (view === 'history') loadHistory();
            
            updateViews();
        }

        // ğŸ¯ GPS MONITORING - PrÃ¼ft alle 5 Sekunden ob GPS lÃ¤uft
        let gpsMonitoringInterval = null;
        let lastGPSUpdate = null;
        
        function startGPSMonitoring() {
            console.log('ğŸ‘€ GPS-Monitoring gestartet');
            
            if (gpsMonitoringInterval) {
                clearInterval(gpsMonitoringInterval);
            }
            
            gpsMonitoringInterval = setInterval(() => {
                const now = Date.now();
                const timeSinceLastUpdate = lastGPSUpdate ? (now - lastGPSUpdate) / 1000 : null;
                
                // Update UI
                updateGPSStatus(timeSinceLastUpdate);
                
                // Warnung wenn kein GPS seit 15 Sekunden
                if (timeSinceLastUpdate && timeSinceLastUpdate > 15) {
                    console.warn('âš ï¸ GPS VERLOREN! Keine Updates seit', Math.round(timeSinceLastUpdate), 'Sekunden');
                    
                    // Versuche GPS neu zu starten
                    if (watchId && currentVehicle) {
                        console.log('ğŸ”„ Versuche GPS neu zu starten...');
                        navigator.geolocation.clearWatch(watchId);
                        watchId = null;
                        setTimeout(() => startGPSTracking(), 1000);
                    }
                }
            }, 5000); // Alle 5 Sekunden prÃ¼fen
        }
        
        function stopGPSMonitoring() {
            if (gpsMonitoringInterval) {
                clearInterval(gpsMonitoringInterval);
                gpsMonitoringInterval = null;
                console.log('â¹ï¸ GPS-Monitoring gestoppt');
            }
        }
        
        function updateGPSStatus(timeSinceLastUpdate) {
            const statusDiv = document.getElementById('gps-status-compact');
            const iconSpan = document.getElementById('gps-icon-compact');
            const textSpan = document.getElementById('gps-text-compact');
            
            if (!statusDiv) return;
            
            if (!timeSinceLastUpdate || timeSinceLastUpdate > 30) {
                // KEIN GPS oder sehr alt
                statusDiv.style.background = 'rgba(239,68,68,0.1)';
                statusDiv.style.color = '#ef4444';
                iconSpan.textContent = 'âŒ';
                textSpan.textContent = 'GPS';
            } else if (timeSinceLastUpdate < 5) {
                // GPS GUT (frisch!)
                statusDiv.style.background = 'rgba(16,185,129,0.1)';
                statusDiv.style.color = '#10b981';
                iconSpan.textContent = 'ğŸ“';
                textSpan.textContent = 'GPS';
            } else if (timeSinceLastUpdate < 15) {
                // GPS OK (etwas alt)
                statusDiv.style.background = 'rgba(245,158,11,0.1)';
                statusDiv.style.color = '#f59e0b';
                iconSpan.textContent = 'âš ï¸';
                textSpan.textContent = 'GPS';
            } else {
                // GPS SCHWACH
                statusDiv.style.background = 'rgba(239,68,68,0.1)';
                statusDiv.style.color = '#ef4444';
                iconSpan.textContent = 'âš ï¸';
                textSpan.textContent = 'GPS';
            }
        }

        function updateViews() {
            // Update Debug Panel
            if (document.getElementById('debug-firebase')) {
                document.getElementById('debug-firebase').textContent = isFirebaseReady ? (isConnected ? 'âœ… Verbunden' : 'âš ï¸ Offline') : 'âŒ Fehler';
                document.getElementById('debug-rides').textContent = rides.length;
                document.getElementById('debug-new').textContent = rides.filter(r => r.status === 'new').length;
                document.getElementById('debug-sync').textContent = new Date().toLocaleTimeString('de-DE');
            }
            
            if (currentView === 'driver') updateDriverView();
            else if (currentView === 'admin') updateAdminView();
            else if (currentView === 'history') updateHistoryView();
        }

        function updateDriverView() {
            const newRides = rides.filter(r => r.status === 'new');
            const myRides = currentVehicle ? rides.filter(r => r.vehicleId === currentVehicle || r.vehicle === (VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle)) : [];
            const current = myRides.find(r => r.status === 'accepted' || r.status === 'picked_up');
            const completed = myRides.filter(r => r.status === 'completed');
            
            // ğŸš¨ CHECK FÃœR STORNIERTE FAHRTEN DIE BESTÃ„TIGUNG BRAUCHEN
            const pendingCancellations = myRides.filter(r => 
                (r.status === 'cancelled_pending_driver' || 
                (r.status === 'cancelled' && r.driverNotified === false))
            );
            
            // Update Badge
            const cancellationBadge = document.getElementById('cancellation-badge');
            const cancellationCount = document.getElementById('cancellation-count');
            if (cancellationBadge && cancellationCount) {
                if (pendingCancellations.length > 0) {
                    cancellationBadge.style.display = 'block';
                    cancellationCount.textContent = pendingCancellations.length;
                } else {
                    cancellationBadge.style.display = 'none';
                }
            }
            
            // Alte Benachrichtigungs-Logik (fÃ¼r KompatibilitÃ¤t)
            const cancelledRides = myRides.filter(r => r.status === 'cancelled' && r.driverNotified === false);
            if (cancelledRides.length > 0) {
                cancelledRides.forEach(ride => {
                    notifyDriverOfCancellation(ride);
                });
            }
            
            // Show/Hide Map vs Ready State
            if (current) {
                document.getElementById('driver-route-info').style.display = 'block';
                document.getElementById('driver-ready').style.display = 'none';
                
                // Fahrt Info im Bottom Panel
                let rideInfo = `#${current.id}`;
                if (current.customerName) rideInfo += ` â€¢ ${current.customerName}`;
                rideInfo += ` â†’ ${current.destination}`;
                if (current.price) rideInfo += ` â€¢ ${current.price}â‚¬`;
                
                document.getElementById('driver-current-ride').innerHTML = rideInfo;
                
                // Buttons im Bottom Panel
                let buttonsHtml = '';
                if (current.status === 'accepted') {
                    buttonsHtml = `
                        <button onclick="pickupCustomer('${current.firebaseId}')" style="
                            width: 100%;
                            padding: 14px;
                            background: #10b981;
                            color: white;
                            border: none;
                            border-radius: 12px;
                            font-size: 16px;
                            font-weight: bold;
                            cursor: pointer;
                        ">
                            ğŸš• Kunde abgeholt
                        </button>
                    `;
                } else if (current.status === 'picked_up') {
                    buttonsHtml = `
                        <div style="
                            display: flex;
                            gap: 10px;
                        ">
                            <button onclick="completeRide('${current.firebaseId}')" style="
                                flex: 1;
                                padding: 14px;
                                background: #10b981;
                                color: white;
                                border: none;
                                border-radius: 12px;
                                font-size: 16px;
                                font-weight: bold;
                                cursor: pointer;
                            ">
                                âœ“ Fahrt abschlieÃŸen
                            </button>
                        </div>
                    `;
                }
                
                // Insert buttons into bottom panel (append after driver-current-ride)
                const bottomPanel = document.getElementById('bottom-panel');
                let actionsDiv = bottomPanel.querySelector('#driver-actions');
                if (!actionsDiv) {
                    actionsDiv = document.createElement('div');
                    actionsDiv.id = 'driver-actions';
                    bottomPanel.appendChild(actionsDiv);
                }
                actionsDiv.innerHTML = buttonsHtml;
                actionsDiv.style.display = 'block';
                
            } else {
                document.getElementById('driver-route-info').style.display = 'none';
                document.getElementById('driver-ready').style.display = 'block';
                
                // Update ready message
                if (currentVehicle && isOnline) {
                    document.getElementById('driver-ready').innerHTML = `
                        <div style="font-size:64px;margin-bottom:20px;">ğŸš•</div>
                        <div style="font-size:24px;font-weight:600;color:#10b981;margin-bottom:10px;">Bereit fÃ¼r AuftrÃ¤ge</div>
                        <div style="font-size:14px;color:#666;">Du bist online & bereit!</div>
                    `;
                } else if (currentVehicle) {
                    document.getElementById('driver-ready').innerHTML = `
                        <div style="font-size:64px;margin-bottom:20px;">âš ï¸</div>
                        <div style="font-size:24px;font-weight:600;color:#f59e0b;margin-bottom:10px;">Offline</div>
                        <div style="font-size:14px;color:#666;">Gehe Online um AuftrÃ¤ge zu erhalten!</div>
                    `;
                } else {
                    document.getElementById('driver-ready').innerHTML = `
                        <div style="font-size:80px;margin-bottom:20px;">ğŸš•</div>
                        <div style="font-size:28px;font-weight:600;color:#667eea;margin-bottom:10px;">Bereit!</div>
                        <div style="font-size:14px;color:#999;">WÃ¤hle Fahrzeug & gehe Online</div>
                    `;
                }
            }
            
            // New rides
            if (!currentVehicle) {
                document.getElementById('new-rides').innerHTML = '<div style="padding:20px;text-align:center;color:#999;">âš ï¸ Bitte erst Fahrzeug wÃ¤hlen</div>';
            } else if (newRides.length === 0) {
                document.getElementById('new-rides').innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Keine neuen AuftrÃ¤ge</div>';
            } else {
                let ridesHtml = newRides.map(r => {
                    // ğŸ¯ Check ob Fahrt diesem Fahrer zugewiesen ist
                    const isAssignedToMe = r.assignedTo === currentVehicle;
                    const timeLeft = r.assignmentExpiresAt ? Math.max(0, Math.ceil((r.assignmentExpiresAt - Date.now()) / 1000)) : null;
                    
                    let assignmentBadge = '';
                    let cardStyle = '';
                    
                    if (isAssignedToMe && timeLeft > 0) {
                        assignmentBadge = `<span style="background:#ef4444;color:white;padding:4px 8px;border-radius:12px;font-size:12px;font-weight:bold;animation:pulse 1s infinite;">â° DIR ZUGEWIESEN - ${timeLeft}s</span>`;
                        cardStyle = 'border:3px solid #ef4444;background:#fef2f2;';
                    } else if (r.assignedTo && r.assignedTo !== currentVehicle) {
                        assignmentBadge = `<span style="background:#94a3b8;padding:4px 8px;border-radius:12px;font-size:12px;">ğŸ‘¤ Zugewiesen: ${r.assignedVehicleName || r.assignedTo}</span>`;
                    } else {
                        assignmentBadge = '<span style="background:#fef3c7;padding:4px 8px;border-radius:12px;font-size:12px;">ğŸ†• Neu</span>';
                    }
                    
                    return `
                    <div class="ride-card" style="${cardStyle}">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <strong>#${r.id}</strong>
                            ${assignmentBadge}
                        </div>
                        ${r.customerName ? `
                        <div style="margin-top:12px;padding:12px;background:#f0f9ff;border-radius:8px;border-left:4px solid #3b82f6;">
                            <div style="font-size:16px;font-weight:600;color:#1e40af;margin-bottom:8px;">
                                ğŸ‘¤ ${r.customerName}
                            </div>
                            <div style="font-size:14px;color:#0369a1;">
                                ğŸ• Abholung: <strong>${r.pickupTime || 'Sofort'}</strong>
                            </div>
                        </div>
                        ` : ''}
                        <div style="margin-top:10px;font-size:14px;">
                            <strong>Von:</strong> ${r.pickup}<br>
                            <strong>Nach:</strong> ${r.destination}<br>
                            <strong>Distanz:</strong> ${r.distance} km â€¢ ${r.duration} Min<br>
                            <strong>Preis:</strong> ${r.price}â‚¬
                            ${r.assignmentDistance ? `<br><strong>ğŸ“ Du bist:</strong> ${r.assignmentDistance.toFixed(1)} km entfernt` : ''}<br>
                            <small style="color:#666;">Bestellt: ${r.time}</small>
                        </div>
                        ${!current ? `<button class="btn btn-success" onclick="acceptRide('${r.firebaseId}')" style="margin-top:10px;">âœ“ Annehmen</button>` : '<div style="margin-top:10px;padding:8px;background:#fef3c7;border-radius:6px;font-size:13px;text-align:center;">SchlieÃŸe erst aktuelle Fahrt ab</div>'}
                    </div>
                    `;
                }).join('');
                
                if (!isOnline) {
                    ridesHtml = '<div class="alert-info" style="margin-bottom:15px;">âš ï¸ Du bist <strong>Offline</strong>. Schalte auf Online um AuftrÃ¤ge anzunehmen.</div>' + ridesHtml;
                }
                
                document.getElementById('new-rides').innerHTML = ridesHtml;
            }
            
            // Update Counter fÃ¼r neue AuftrÃ¤ge
            const countElement = document.getElementById('new-rides-count');
            if (countElement) {
                countElement.textContent = newRides.length;
            }
            
            // Stats
            const revenue = completed.reduce((sum, r) => sum + parseFloat(r.price), 0);
            document.getElementById('d-rides').textContent = completed.length;
            document.getElementById('d-money').textContent = revenue.toFixed(2) + 'â‚¬';
            
            // ğŸ§ª Zeige Test-Buttons wenn Fahrer-View aktiv
            const testButtons = document.getElementById('alert-test-buttons');
            if (testButtons) {
                testButtons.style.display = (currentView === 'driver' && currentVehicle) ? 'flex' : 'none';
            }
            
            // ğŸ“Š Update Alert Status
            updateAlertStatus();
        }

        function updateAdminView() {
            // ğŸ“¦ Merge Firebase + localStorage fÃ¼r vollstÃ¤ndige Ansicht
            let allRides = [...rides]; // Kopiere Firebase Fahrten
            
            // Lade auch aus localStorage (fÃ¼r Offline-Buchungen & stornierte Fahrten)
            const localHistory = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            localHistory.forEach(localRide => {
                const existsInFirebase = allRides.some(fbRide => fbRide.id === localRide.id || fbRide.firebaseId === localRide.firebaseId);
                if (!existsInFirebase) {
                    allRides.push(localRide);
                }
            });
            
            // ğŸ§¹ FILTERE ALTE FAHRTEN (Ã¤lter als 3 Tage) AUTOMATISCH RAUS
            const threeDaysAgo = Date.now() - (3 * 24 * 60 * 60 * 1000);
            allRides = allRides.filter(r => {
                const rideTime = r.pickupTimestamp || r.createdAt || 0;
                // Behalte nur: completed (immer), oder Fahrten von letzten 3 Tagen
                return r.status === 'completed' || r.status === 'abgeschlossen' || rideTime > threeDaysAgo;
            });
            
            console.log('ğŸ” ADMIN DEBUG - Gesamt Fahrten (nach Filter):', allRides.length);
            console.log('ğŸ” ADMIN DEBUG - Status:', allRides.map(r => r.status));
            
            const completed = allRides.filter(r => r.status === 'completed' || r.status === 'abgeschlossen');
            const pending = allRides.filter(r => r.status === 'new' || r.status === 'vorbestellt');
            const active = allRides.filter(r => r.status === 'accepted' || r.status === 'akzeptiert' || r.status === 'unterwegs' || r.status === 'picked_up');
            const rejected = allRides.filter(r => r.status === 'rejected'); // ğŸ†• Abgelehnte Fahrten
            const revenue = completed.reduce((sum, r) => sum + parseFloat(r.price), 0);
            
            document.getElementById('a-total').textContent = completed.length;
            document.getElementById('a-revenue').textContent = revenue.toFixed(2) + 'â‚¬';
            document.getElementById('a-pending').textContent = pending.length;
            document.getElementById('a-active').textContent = active.length;
            
            // ğŸ“‹ OFFENE FAHRTEN = vorbestellt, new, akzeptiert, unterwegs, angekommen
            const now = Date.now();
            const openRides = allRides.filter(r => {
                const openStatuses = ['vorbestellt', 'new', 'akzeptiert', 'accepted', 'unterwegs', 'picked_up', 'angekommen'];
                return openStatuses.includes(r.status);
            }).sort((a, b) => {
                // Sortiere nach Abholzeit (falls vorhanden) oder Erstellungszeit
                const timeA = a.pickupTimestamp || a.createdAt || 0;
                const timeB = b.pickupTimestamp || b.createdAt || 0;
                return timeA - timeB;
            });
            
            if (openRides.length === 0) {
                document.getElementById('upcoming-rides-admin').innerHTML = '<div style="padding:15px;text-align:center;color:#999;background:white;border-radius:8px;">Keine offenen Fahrten</div>';
            } else {
                // Gruppiere nach Tag
                const groupedByDay = {};
                openRides.forEach(ride => {
                    const rideTime = ride.pickupTimestamp || ride.createdAt;
                    const rideDate = new Date(rideTime);
                    const dayKey = rideDate.toLocaleDateString('de-DE', { 
                        weekday: 'long', 
                        day: '2-digit', 
                        month: '2-digit',
                        year: 'numeric'
                    });
                    
                    if (!groupedByDay[dayKey]) {
                        groupedByDay[dayKey] = [];
                    }
                    groupedByDay[dayKey].push(ride);
                });
                
                // Baue HTML fÃ¼r gruppierte Fahrten
                let html = '';
                Object.keys(groupedByDay).forEach(dayKey => {
                    const ridesForDay = groupedByDay[dayKey];
                    html += `<div style="margin-bottom:20px;">
                        <h4 style="background:#667eea;color:white;padding:10px;border-radius:8px;margin-bottom:10px;">
                            ğŸ“… ${dayKey} (${ridesForDay.length} Fahrt${ridesForDay.length !== 1 ? 'en' : ''})
                        </h4>`;
                    
                    ridesForDay.forEach(r => {
                        const pickupDate = new Date(r.pickupTimestamp || r.createdAt);
                        const formattedTime = pickupDate.toLocaleTimeString('de-DE', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                        
                        // Zeitdifferenz berechnen
                        const hoursUntil = Math.floor((pickupDate.getTime() - now) / (1000 * 60 * 60));
                        const daysUntil = Math.floor(hoursUntil / 24);
                        let countdownText = '';
                        if (daysUntil > 0) {
                            countdownText = `in ${daysUntil} Tag${daysUntil > 1 ? 'en' : ''}`;
                        } else if (hoursUntil > 0) {
                            countdownText = `in ${hoursUntil} Stunde${hoursUntil > 1 ? 'n' : ''}`;
                        } else {
                            const minutesUntil = Math.floor((pickupDate.getTime() - now) / (1000 * 60));
                            if (minutesUntil > 0) {
                                countdownText = `in ${minutesUntil} Min`;
                            } else {
                                countdownText = `JETZT`;
                            }
                        }
                        
                        // Status-Badge
                        let statusBadge = '';
                        let borderColor = '#0ea5e9';
                        let bgColor = '#e0f2fe';
                        
                        if (r.status === 'vorbestellt') {
                            statusBadge = '<span style="background:#f59e0b;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;margin-left:8px;">ğŸ“… Vorbestellt</span>';
                            borderColor = '#f59e0b';
                            bgColor = '#fef3c7';
                        } else if (r.status === 'new') {
                            statusBadge = '<span style="background:#3b82f6;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;margin-left:8px;">ğŸ”” Neu</span>';
                            borderColor = '#3b82f6';
                            bgColor = '#dbeafe';
                        } else if (r.status === 'akzeptiert' || r.status === 'accepted') {
                            statusBadge = '<span style="background:#10b981;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;margin-left:8px;">âœ… Akzeptiert</span>';
                            borderColor = '#10b981';
                            bgColor = '#d1fae5';
                        } else if (r.status === 'unterwegs' || r.status === 'picked_up') {
                            statusBadge = '<span style="background:#0ea5e9;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;margin-left:8px;">ğŸš— Unterwegs</span>';
                            borderColor = '#0ea5e9';
                            bgColor = '#e0f2fe';
                        }
                        
                        // ğŸ”˜ Aktions-Buttons fÃ¼r offene Fahrten
                        let actionButtons = '';
                        if (r.status === 'vorbestellt' || r.status === 'new') {
                            actionButtons = `
                                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-top:10px;">
                                    <button onclick="editRide('${r.firebaseId || r.id}')" 
                                        style="padding:8px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                        âœï¸ Bearbeiten
                                    </button>
                                    <button onclick="reverseRouteAdmin('${r.firebaseId || r.id}')" 
                                        style="padding:8px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                        ğŸ”„ Umdrehen
                                    </button>
                                    <button onclick="deleteRide('${r.firebaseId || r.id}')" 
                                        style="padding:8px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                        ğŸ—‘ï¸ LÃ¶schen
                                    </button>
                                </div>
                            `;
                        }
                        
                        html += `<div class="ride-card" style="border-left:4px solid ${borderColor};background:${bgColor};">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <strong>${r.customerName || 'Unbekannt'}</strong>
                                <div style="display:flex;gap:6px;align-items:center;">
                                    <span style="background:#0ea5e9;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;">${countdownText}</span>
                                    ${statusBadge}
                                </div>
                            </div>
                            <div style="margin-top:10px;font-size:14px;color:#0c4a6e;">
                                <strong>ğŸ• ${formattedTime} Uhr</strong><br>
                                <strong>ğŸ“ Von:</strong> ${r.pickup}<br>
                                <strong>ğŸ¯ Nach:</strong> ${r.destination}<br>
                                <strong>ğŸ’° Preis:</strong> ${r.price}â‚¬<br>
                                <strong>ğŸ“ Distanz:</strong> ${r.distance} km
                                ${r.vehicleLabel ? '<br><strong>ğŸš— Fahrzeug:</strong> '+r.vehicleLabel : ''}
                            </div>
                            ${actionButtons}
                        </div>`;
                    });
                    
                    html += '</div>';
                });
                
                document.getElementById('upcoming-rides-admin').innerHTML = html;
            }
            
            // âŒ ABGELEHNTE FAHRTEN anzeigen
            if (rejected.length === 0) {
                document.getElementById('rejected-rides-admin').innerHTML = '<div style="padding:15px;text-align:center;color:#999;background:white;border-radius:8px;">âœ… Keine abgelehnten Fahrten</div>';
            } else {
                let rejectedHTML = '<div style="background:#fef2f2;border:2px solid #ef4444;border-radius:12px;padding:15px;margin-bottom:10px;">';
                rejectedHTML += `<div style="color:#991b1b;font-weight:bold;margin-bottom:10px;">âš ï¸ ${rejected.length} Fahrt${rejected.length !== 1 ? 'en' : ''} wurde${rejected.length !== 1 ? 'n' : ''} abgelehnt!</div>`;
                
                rejected.forEach(r => {
                    const rejectedTime = new Date(r.rejectedAt || r.createdAt).toLocaleString('de-DE');
                    rejectedHTML += `
                        <div style="background:white;padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid #ef4444;">
                            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px;">
                                <div style="flex:1;">
                                    <div style="font-size:12px;color:#666;margin-bottom:5px;">
                                        âŒ Abgelehnt von: <strong>${r.rejectedByDriver || r.rejectedBy || 'Unbekannt'}</strong>
                                    </div>
                                    <div style="font-size:12px;color:#999;">
                                        ${rejectedTime}
                                    </div>
                                </div>
                                <div style="font-size:24px;font-weight:bold;color:#ef4444;">${r.price}â‚¬</div>
                            </div>
                            ${r.customerName ? `<div style="font-weight:600;margin-bottom:8px;">ğŸ‘¤ ${r.customerName}</div>` : ''}
                            <div style="font-size:14px;margin-bottom:5px;">
                                <strong>ğŸ“ Von:</strong> ${r.pickup}
                            </div>
                            <div style="font-size:14px;margin-bottom:10px;">
                                <strong>ğŸ¯ Nach:</strong> ${r.destination}
                            </div>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
                                <button onclick="reassignRide('${r.firebaseId || r.id}')" style="
                                    padding:12px;
                                    background:#10b981;
                                    color:white;
                                    border:none;
                                    border-radius:8px;
                                    font-weight:bold;
                                    cursor:pointer;
                                ">
                                    ğŸ”„ Neu zuweisen
                                </button>
                                <button onclick="deleteRide('${r.firebaseId || r.id}')" style="
                                    padding:12px;
                                    background:#ef4444;
                                    color:white;
                                    border:none;
                                    border-radius:8px;
                                    font-weight:bold;
                                    cursor:pointer;
                                ">
                                    ğŸ—‘ï¸ LÃ¶schen
                                </button>
                            </div>
                        </div>`;
                });
                
                rejectedHTML += '</div>';
                document.getElementById('rejected-rides-admin').innerHTML = rejectedHTML;
            }
            
            // Stornierungen anzeigen
            if (cancellations.length === 0) {
                document.getElementById('cancellations-list').innerHTML = '<div style="padding:15px;text-align:center;color:#999;background:white;border-radius:8px;">Keine Stornierungen</div>';
            } else {
                const totalFees = cancellations.reduce((sum, c) => sum + parseFloat(c.cancellationFee || 0), 0);
                document.getElementById('cancellations-list').innerHTML = 
                    `<div style="background:#fef3c7;border:2px solid #f59e0b;padding:12px;border-radius:8px;margin-bottom:15px;text-align:center;">
                        <strong>Gesamt StornogebÃ¼hren: ${totalFees.toFixed(2)}â‚¬</strong> (${cancellations.length} Stornierungen)
                    </div>` +
                    cancellations.slice().reverse().map(c => {
                        const cancelDate = new Date(c.cancelledAt).toLocaleString('de-DE');
                        return `<div class="ride-card" style="border-left:4px solid #f59e0b;">
                            <strong>${c.customerName || 'Unbekannt'}</strong> 
                            <span style="background:#fef3c7;padding:4px 8px;border-radius:12px;font-size:12px;color:#92400e;font-weight:600;">ğŸ’¶ ${c.cancellationFee.toFixed(2)}â‚¬</span>
                            <div style="margin-top:10px;font-size:14px;color:#666;">
                                <strong>Von:</strong> ${c.pickup}<br>
                                <strong>Nach:</strong> ${c.destination}<br>
                                <strong>Original-Preis:</strong> ${c.originalPrice}â‚¬<br>
                                <strong>Storniert:</strong> ${cancelDate}
                            </div>
                        </div>`;
                    }).join('');
            }
            
            // âœ… NUR ABGESCHLOSSENE FAHRTEN zeigen
            const completedRides = allRides.filter(r => r.status === 'completed' || r.status === 'abgeschlossen');
            
            if (completedRides.length === 0) {
                document.getElementById('all-rides').innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Keine abgeschlossenen Fahrten</div>';
            } else {
                document.getElementById('all-rides').innerHTML = completedRides.slice().reverse().map(r => {
                    let statusText = r.status;
                    let statusColor = '#fef3c7';
                    if (r.status === 'completed') { statusText = 'Abgeschlossen'; statusColor = '#d1fae5'; }
                    else if (r.status === 'abgeschlossen') { statusText = 'Abgeschlossen'; statusColor = '#d1fae5'; }
                    else if (r.status === 'accepted') { statusText = 'Unterwegs'; statusColor = '#dbeafe'; }
                    else if (r.status === 'akzeptiert') { statusText = 'Akzeptiert'; statusColor = '#d1fae5'; }
                    else if (r.status === 'unterwegs') { statusText = 'Unterwegs'; statusColor = '#dbeafe'; }
                    else if (r.status === 'picked_up') { statusText = 'Besetzt'; statusColor = '#fef3c7'; }
                    else if (r.status === 'new') { statusText = 'Neu'; statusColor = '#fef3c7'; }
                    else if (r.status === 'vorbestellt') { statusText = 'Vorbestellt'; statusColor = '#fef3c7'; }
                    else if (r.status === 'storniert') { statusText = 'Storniert'; statusColor = '#fee2e2'; }
                    
                    // Abholzeit formatieren
                    let pickupTimeDisplay = r.pickupTime || 'Sofort';
                    if (r.pickupTimestamp) {
                        const pickupDate = new Date(r.pickupTimestamp);
                        const now = Date.now();
                        if (pickupDate.getTime() > now + (30 * 60000)) {
                            // Zukunft
                            pickupTimeDisplay = 'ğŸ“… ' + pickupDate.toLocaleString('de-DE', {
                                day: '2-digit',
                                month: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        }
                    }
                    
                    // Manuelle Zuweisung Button fÃ¼r neue Fahrten
                    let assignButton = '';
                    if (r.status === 'new' && r.firebaseId) {
                        assignButton = `<button onclick="manuallyAssignRide('${r.firebaseId}')" style="width:100%;margin-top:10px;padding:8px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;">
                            ğŸš— Fahrer manuell zuweisen
                        </button>`;
                    }
                    
                    // Buttons fÃ¼r ALLE Fahrten
                    let actionButtons = '';
                    const rideIdForButtons = r.firebaseId || r.id || r.createdAt;
                    
                    if (r.status === 'abgeschlossen' || r.status === 'completed') {
                        // Abgeschlossene: Wiederholen + Umdrehen + Bearbeiten
                        actionButtons = `
                            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-top:10px;">
                                <button onclick="rebookRide(${r.createdAt || r.id})" 
                                    style="padding:8px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                    ğŸ” Nochmal
                                </button>
                                <button onclick="reverseRouteFromHistory(${r.createdAt || r.id})" 
                                    style="padding:8px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                    ğŸ”„ Umdrehen
                                </button>
                                <button onclick="editRide('${rideIdForButtons}')" 
                                    style="padding:8px;background:#f59e0b;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                    âœï¸ Bearbeiten
                                </button>
                            </div>
                        `;
                    } else if (r.status === 'storniert') {
                        // Stornierte: Wiederholen + Umdrehen + Bearbeiten
                        actionButtons = `
                            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-top:10px;">
                                <button onclick="rebookRide(${r.createdAt || r.id})" 
                                    style="padding:8px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                    ğŸ” Nochmal
                                </button>
                                <button onclick="reverseRouteFromHistory(${r.createdAt || r.id})" 
                                    style="padding:8px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                    ğŸ”„ Umdrehen
                                </button>
                                <button onclick="editRide('${rideIdForButtons}')" 
                                    style="padding:8px;background:#f59e0b;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                    âœï¸ Bearbeiten
                                </button>
                            </div>
                        `;
                    } else {
                        // Andere Status: Nur Bearbeiten + Umdrehen (wenn nicht aktiv unterwegs)
                        if (r.status !== 'unterwegs' && r.status !== 'akzeptiert' && r.status !== 'picked_up') {
                            actionButtons = `
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;">
                                    <button onclick="editRide('${rideIdForButtons}')" 
                                        style="padding:8px;background:#f59e0b;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;">
                                        âœï¸ Bearbeiten
                                    </button>
                                    <button onclick="reverseRouteAdmin('${rideIdForButtons}')" 
                                        style="padding:8px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;">
                                        ğŸ”„ Umdrehen
                                    </button>
                                </div>
                            `;
                        }
                    }
                    
                    return `<div class="ride-card">
                        <strong>#${r.id}</strong> <span style="background:${statusColor};padding:4px 8px;border-radius:12px;font-size:12px;">${statusText}</span>
                        ${r.customerName ? '<div style="margin-top:8px;font-weight:600;">ğŸ‘¤ '+r.customerName+'</div>' : ''}
                        <div style="margin-top:10px;font-size:14px;">
                            ğŸ• ${pickupTimeDisplay}<br>
                            ğŸ“ Von: ${r.pickup}<br>
                            ğŸ¯ Nach: ${r.destination}<br>
                            ğŸ“ ${r.distance} km<br>
                            ğŸ’° Preis: ${r.price}â‚¬
                            ${r.vehicle ? '<br>ğŸš— Fahrzeug: '+r.vehicle : ''}
                            ${r.vehiclePlate ? ' ('+r.vehiclePlate+')' : ''}
                        </div>
                        ${assignButton}
                        ${actionButtons}
                    </div>`;
                }).join('');
            }
            
            // ğŸš— Update Online-Fahrer Liste
            updateOnlineDriversList();
        }
        
        // ğŸš— ONLINE-FAHRER ANZEIGEN
        function updateOnlineDriversList() {
            const driversList = document.getElementById('online-drivers-list');
            if (!driversList) return;
            
            const now = Date.now();
            const onlineDrivers = [];
            
            // Durchsuche alle Fahrer
            Object.keys(drivers).forEach(vehicleId => {
                const driver = drivers[vehicleId];
                
                // Fahrer ist online wenn: online = true UND letzte Aktualisierung < 2 Min
                if (driver && driver.online) {
                    const lastUpdate = driver.timestamp || 0;
                    const minutesSinceUpdate = (now - lastUpdate) / (1000 * 60);
                    
                    // Nur als online zeigen wenn letzte Meldung < 5 Min
                    if (minutesSinceUpdate < 5) {
                        const vehicle = VEHICLES[vehicleId] || { name: driver.vehicle || vehicleId, plate: '?' };
                        const hasGPS = driver.lat && driver.lng;
                        const gpsAccuracy = driver.accuracy ? Math.round(driver.accuracy) : '?';
                        
                        onlineDrivers.push({
                            vehicleId: vehicleId,
                            vehicle: vehicle,
                            driver: driver,
                            hasGPS: hasGPS,
                            accuracy: gpsAccuracy,
                            lastUpdate: lastUpdate,
                            minutesSinceUpdate: Math.floor(minutesSinceUpdate)
                        });
                    }
                }
            });
            
            if (onlineDrivers.length === 0) {
                driversList.innerHTML = `
                    <div style="background:white;padding:20px;border-radius:8px;text-align:center;color:#999;">
                        ğŸ˜´ Keine Fahrer online
                    </div>
                `;
                return;
            }
            
            // Sortiere nach letztem Update (neueste zuerst)
            onlineDrivers.sort((a, b) => b.lastUpdate - a.lastUpdate);
            
            driversList.innerHTML = onlineDrivers.map(d => {
                const gpsStatus = d.hasGPS ? 'âœ… GPS aktiv' : 'âŒ Kein GPS';
                const gpsColor = d.hasGPS ? '#10b981' : '#ef4444';
                const updateText = d.minutesSinceUpdate === 0 ? 'Gerade eben' : `vor ${d.minutesSinceUpdate} Min`;
                
                return `
                    <div style="background:white;padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid ${gpsColor};">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <div style="font-weight:600;font-size:15px;">
                                    ğŸš— ${d.vehicle.name}
                                </div>
                                <div style="font-size:12px;color:#666;margin-top:4px;">
                                    ${d.vehicle.plate}
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div style="color:${gpsColor};font-weight:600;font-size:13px;">
                                    ${gpsStatus}
                                </div>
                                ${d.hasGPS ? `<div style="font-size:11px;color:#999;">Â±${d.accuracy}m</div>` : ''}
                                <div style="font-size:11px;color:#999;margin-top:4px;">
                                    ${updateText}
                                </div>
                            </div>
                        </div>
                        ${d.hasGPS ? `
                            <div style="margin-top:10px;font-size:12px;color:#666;">
                                ğŸ“ ${d.driver.lat.toFixed(5)}, ${d.driver.lng.toFixed(5)}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // ğŸš— MANUELLE FAHRER-ZUWEISUNG
        function manuallyAssignRide(rideId) {
            const ride = rides.find(r => r.firebaseId === rideId);
            if (!ride) {
                alert('âŒ Fahrt nicht gefunden!');
                return;
            }
            
            // Fahrzeug-Auswahl
            const vehicleOptions = Object.keys(VEHICLES).map(key => {
                const v = VEHICLES[key];
                return `<option value="${key}">${v.name} (${v.plate})</option>`;
            }).join('');
            
            const html = `
                <div style="background:white;padding:20px;border-radius:12px;">
                    <h3>ğŸš— Fahrer zuweisen</h3>
                    <div style="margin:15px 0;padding:15px;background:#f0f9ff;border-radius:8px;">
                        <strong>Fahrt #${ride.id}</strong><br>
                        ğŸ“ ${ride.pickup}<br>
                        ğŸ¯ ${ride.destination}<br>
                        ğŸ’° ${ride.price}â‚¬
                    </div>
                    <label style="display:block;margin:10px 0;">Fahrzeug wÃ¤hlen:</label>
                    <select id="manual-vehicle-select" style="width:100%;padding:12px;border:2px solid #667eea;border-radius:8px;font-size:14px;">
                        <option value="">-- Fahrzeug wÃ¤hlen --</option>
                        ${vehicleOptions}
                    </select>
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button onclick="confirmManualAssignment('${rideId}')" style="flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;">
                            âœ“ Zuweisen
                        </button>
                        <button onclick="closeManualAssignment()" style="flex:1;padding:12px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;">
                            âœ• Abbrechen
                        </button>
                    </div>
                </div>
            `;
            
            // Modal anzeigen
            const modal = document.createElement('div');
            modal.id = 'manual-assign-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
            modal.innerHTML = html;
            document.body.appendChild(modal);
        }
        
        async function confirmManualAssignment(rideId) {
            const vehicleId = document.getElementById('manual-vehicle-select').value;
            if (!vehicleId) {
                alert('âŒ Bitte wÃ¤hle ein Fahrzeug!');
                return;
            }
            
            const vehicle = VEHICLES[vehicleId];
            const ride = rides.find(r => r.firebaseId === rideId);
            
            if (!ride) {
                alert('âŒ Fahrt nicht gefunden!');
                return;
            }
            
            // Fahrt zuweisen
            await updateRide(rideId, {
                status: 'accepted',
                vehicleId: vehicleId,
                vehicle: vehicle.name,
                vehiclePlate: vehicle.plate,
                acceptedAt: Date.now()
            });
            
            closeManualAssignment();
            alert(`âœ… Fahrt #${ride.id} wurde ${vehicle.name} zugewiesen!`);
        }
        
        function closeManualAssignment() {
            const modal = document.getElementById('manual-assign-modal');
            if (modal) modal.remove();
        }

        // DATABASE FUNCTIONS
        async function saveRide(ride) {
            // ğŸ” FÃ¼ge userId hinzu (fÃ¼r Firebase Query)
            if (currentUser) {
                ride.userId = currentUser.uid;
            }
            
            // ğŸ”¥ Speichere in Firebase
            if (isFirebaseReady) {
                const ref = db.ref('rides').push();
                ride.firebaseId = ref.key;
                await ref.set(ride);
            }
            
            // ğŸ’¾ Speichere auch in localStorage (fÃ¼r Offline-Support & schnellen Zugriff)
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            history.push(ride);
            localStorage.setItem('rideHistory', JSON.stringify(history));
            
            return ride;
        }

        async function updateRide(id, updates) {
            if (isFirebaseReady) await db.ref('rides/' + id).update(updates);
        }

        // GEOCODING & ROUTING
        async function geocode(address) {
            // Zuerst in bekannten Orten suchen
            const searchKey = address.toLowerCase().trim();
            if (KNOWN_PLACES[searchKey]) {
                console.log('âœ… Ort aus Cache:', KNOWN_PLACES[searchKey].name);
                return KNOWN_PLACES[searchKey];
            }
            
            // Dann via API suchen
            try {
                // Versuche zuerst mit Usedom, Deutschland
                let response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Usedom, Deutschland')}&limit=1`);
                let data = await response.json();
                
                // Wenn nichts gefunden, versuche nur mit Deutschland
                if (data.length === 0) {
                    response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Deutschland')}&limit=1`);
                    data = await response.json();
                }
                
                // Wenn immer noch nichts, versuche ohne Zusatz
                if (data.length === 0) {
                    response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
                    data = await response.json();
                }
                
                if (data.length > 0) {
                    console.log('âœ… Ort gefunden:', address, 'â†’', data[0].display_name);
                    return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
                } else {
                    console.warn('âš ï¸ Ort nicht gefunden:', address);
                }
            } catch (e) { 
                console.error('âŒ Geocoding Fehler:', e); 
            }
            return null;
        }

        async function calculateRoute(from, to) {
            try {
                // overview=full gibt die komplette Route-Geometry zurÃ¼ck!
                const response = await fetch(`https://router.project-osrm.org/route/v1/driving/${from.lon},${from.lat};${to.lon},${to.lat}?overview=full&geometries=geojson`);
                const data = await response.json();
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    return { 
                        distance: (route.distance / 1000).toFixed(1), 
                        duration: Math.round(route.duration / 60),
                        geometry: route.geometry ? route.geometry.coordinates : null  // Route-Punkte!
                    };
                }
            } catch (e) { console.error(e); }
            return { distance: 0, duration: 0, geometry: null };
        }

        // ğŸ’° SURGE PRICING SETTINGS
        let pricingSettings = {
            autoSurgeEnabled: true,
            surgePerTaxi: 10,      // % pro aktivem Taxi
            manualMultiplier: 0    // Manueller +/- %
        };
        
        // Lade Pricing Settings aus localStorage
        function loadPricingSettings() {
            const saved = localStorage.getItem('pricingSettings');
            if (saved) {
                pricingSettings = JSON.parse(saved);
            }
            updatePricingUI();
        }
        
        // Speichere Pricing Settings
        function savePricingSettings() {
            pricingSettings.autoSurgeEnabled = document.getElementById('auto-surge-enabled')?.checked ?? true;
            pricingSettings.surgePerTaxi = parseInt(document.getElementById('surge-per-taxi')?.value ?? 10);
            localStorage.setItem('pricingSettings', JSON.stringify(pricingSettings));
            updatePricingUI();
            console.log('ğŸ’° Pricing Settings gespeichert:', pricingSettings);
        }
        
        // Manuellen Multiplikator setzen
        function setManualMultiplier(value) {
            pricingSettings.manualMultiplier = value;
            localStorage.setItem('pricingSettings', JSON.stringify(pricingSettings));
            
            // Button-Styling aktualisieren
            document.querySelectorAll('.multiplier-btn').forEach(btn => {
                const btnValue = parseInt(btn.dataset.value);
                if (btnValue === value) {
                    btn.style.border = '2px solid #667eea';
                    btn.style.background = '#667eea';
                    btn.style.color = 'white';
                } else {
                    btn.style.border = '2px solid #e5e7eb';
                    btn.style.background = 'white';
                    btn.style.color = btnValue < 0 ? '#10b981' : (btnValue > 0 ? '#ef4444' : '#333');
                }
            });
            
            updatePricingUI();
            console.log('ğŸ’° Manueller Multiplikator:', value + '%');
        }
        
        // Berechne aktuellen Gesamt-Multiplikator
        function getCurrentMultiplier() {
            let multiplier = 100; // Basis 100%
            let reasons = [];
            
            // Auto-Surge basierend auf aktiven Fahrten
            if (pricingSettings.autoSurgeEnabled) {
                const activeRides = rides.filter(r => r.status === 'accepted' || r.status === 'in_progress').length;
                if (activeRides > 0) {
                    const autoSurge = activeRides * pricingSettings.surgePerTaxi;
                    multiplier += autoSurge;
                    reasons.push(`+${autoSurge}% (${activeRides} Taxi${activeRides > 1 ? 's' : ''} unterwegs)`);
                }
            }
            
            // Manueller Aufschlag/Rabatt
            if (pricingSettings.manualMultiplier !== 0) {
                multiplier += pricingSettings.manualMultiplier;
                const sign = pricingSettings.manualMultiplier > 0 ? '+' : '';
                reasons.push(`${sign}${pricingSettings.manualMultiplier}% (Manuell)`);
            }
            
            return {
                multiplier: multiplier,
                factor: multiplier / 100,
                reasons: reasons.length > 0 ? reasons.join(', ') : 'Normalpreis'
            };
        }
        
        // Update Pricing UI im Admin
        function updatePricingUI() {
            const current = getCurrentMultiplier();
            
            const displayEl = document.getElementById('current-multiplier-display');
            const reasonEl = document.getElementById('multiplier-reason');
            const exampleEl = document.getElementById('pricing-example');
            
            if (displayEl) {
                displayEl.textContent = current.multiplier + '%';
                displayEl.style.color = current.multiplier > 100 ? '#fecaca' : (current.multiplier < 100 ? '#bbf7d0' : 'white');
            }
            if (reasonEl) {
                reasonEl.textContent = current.reasons;
            }
            if (exampleEl) {
                const example = (14.60 * current.factor).toFixed(2);
                exampleEl.textContent = `Beispiel: 14.60â‚¬ Ã— ${current.multiplier}% = ${example}â‚¬`;
            }
        }

        function calculatePrice(distance, timestamp = null) {
            // Nutze entweder Ã¼bergebenen timestamp oder jetzt
            const calcTime = timestamp ? new Date(timestamp) : new Date();
            const hour = calcTime.getHours(), day = calcTime.getDay();
            
            // PrÃ¼fe ob Nachttarif (Mo-Sa 22-6 Uhr, Sonntag ganztÃ¤gig)
            const isNight = (hour >= 22 || hour < 6) || (day === 0);
            
            // WÃ¤hle Tarif
            const grundgebuehr = isNight ? TARIF.nacht_grundgebuehr : TARIF.grundgebuehr;
            const km_1_2 = isNight ? TARIF.nacht_km_1_2 : TARIF.km_1_2;
            const km_3_4 = isNight ? TARIF.nacht_km_3_4 : TARIF.km_3_4;
            const km_ab_5 = isNight ? TARIF.nacht_km_ab_5 : TARIF.km_ab_5;
            
            // Gestaffelte Berechnung
            let kmPreis = 0;
            if (distance <= 2) {
                // 0-2 km: 3,30â‚¬ pro km
                kmPreis = distance * km_1_2;
            } else if (distance <= 4) {
                // 2-4 km: erste 2 km Ã  3,30â‚¬ + Rest Ã  2,80â‚¬
                kmPreis = (2 * km_1_2) + ((distance - 2) * km_3_4);
            } else {
                // >4 km: erste 2 km Ã  3,30â‚¬ + nÃ¤chste 2 km Ã  2,80â‚¬ + Rest Ã  2,20â‚¬
                kmPreis = (2 * km_1_2) + (2 * km_3_4) + ((distance - 4) * km_ab_5);
            }
            
            let base = grundgebuehr + kmPreis;
            let text = [];
            
            // Nachttarif-Hinweis
            if (isNight) {
                text.push('Nachttarif');
            }
            
            // ğŸ’° SURGE PRICING ANWENDEN
            const surge = getCurrentMultiplier();
            let finalPrice = base * surge.factor;
            
            // Surge-Hinweis fÃ¼r Kunde
            if (surge.multiplier > 100) {
                text.push(`ğŸ“ˆ +${surge.multiplier - 100}% Nachfrage`);
            } else if (surge.multiplier < 100) {
                text.push(`ğŸ‰ ${surge.multiplier - 100}% Rabatt`);
            }
            
            const totalRounded = Math.round(finalPrice / 0.1) * 0.1; // Runde auf 10 Cent
            
            return { 
                total: totalRounded.toFixed(2), 
                zuschlagText: text, 
                distance,
                basePrice: base.toFixed(2),
                surgeMultiplier: surge.multiplier
            };
        }

        // AUTOCOMPLETE
        let autocompleteTimeout = null;
        
        function setupAutocomplete() {
            ['pickup', 'destination'].forEach(id => {
                const input = document.getElementById(id);
                const dropdown = document.getElementById(id + '-dropdown');
                
                input.addEventListener('input', (e) => {
                    // Reset coords wenn User manuell tippt
                    if (id === 'pickup') pickupCoords = null;
                    else destCoords = null;
                    
                    clearTimeout(autocompleteTimeout);
                    const value = e.target.value.trim();
                    
                    if (value.length < 3) {
                        dropdown.style.display = 'none';
                        return;
                    }
                    
                    // Zeige "LÃ¤dt..." sofort
                    dropdown.innerHTML = '<div class="autocomplete-item" style="color:#999;">Suche...</div>';
                    dropdown.style.display = 'block';
                    
                    // VerzÃ¶gerte Suche (Debounce)
                    autocompleteTimeout = setTimeout(() => {
                        searchAddresses(value, id);
                    }, 300);
                });
                
                // SchlieÃŸe Dropdown wenn auÃŸerhalb geklickt
                document.addEventListener('click', (e) => {
                    if (e.target !== input && !dropdown.contains(e.target)) {
                        dropdown.style.display = 'none';
                    }
                });
            });
            
            document.getElementById('pickup-time').addEventListener('change', (e) => {
                const customTime = document.getElementById('custom-time');
                if (customTime) {  // NULL-CHECK!
                    if (e.target.value === 'custom') customTime.style.display = 'block';
                    else customTime.style.display = 'none';
                }
            });
        }

        async function searchAddresses(query, inputId) {
            const dropdown = document.getElementById(inputId + '-dropdown');
            
            try {
                // Suche mit Nominatim API
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?` +
                    `format=json&` +
                    `q=${encodeURIComponent(query)}&` +
                    `countrycodes=de&` +
                    `limit=8&` +
                    `addressdetails=1`
                );
                
                const results = await response.json();
                
                if (results.length === 0) {
                    dropdown.innerHTML = '<div class="autocomplete-item" style="color:#999;">Keine Ergebnisse</div>';
                    return;
                }
                
                // Filtere nur Usedom-relevante Ergebnisse
                const usedomResults = results.filter(r => {
                    const display = r.display_name.toLowerCase();
                    return display.includes('usedom') || 
                           display.includes('heringsdorf') || 
                           display.includes('ahlbeck') ||
                           display.includes('bansin') ||
                           display.includes('zinnowitz') ||
                           display.includes('karlshagen') ||
                           display.includes('peenemÃ¼nde') ||
                           display.includes('koserow') ||
                           display.includes('Ã¼ckeritz') ||
                           display.includes('loddin') ||
                           display.includes('zempin') ||
                           display.includes('trassenheide');
                });
                
                const resultsToShow = usedomResults.length > 0 ? usedomResults : results;
                
                dropdown.innerHTML = resultsToShow.map(r => {
                    const address = r.address;
                    let displayText = '';
                    let fullAddress = '';
                    
                    // ğŸ¨ HOTEL, RESTAURANT, POI Namen (z.B. "Pommerscher Hof")
                    const poiName = address.amenity || address.tourism || address.building || r.name;
                    
                    // Baue Haupt-Adresszeile
                    if (address.road) {
                        fullAddress = address.road;
                        if (address.house_number) fullAddress += ' ' + address.house_number;
                    }
                    
                    // Ort
                    let city = '';
                    if (address.village) city = address.village;
                    else if (address.town) city = address.town;
                    else if (address.city) city = address.city;
                    else if (address.municipality) city = address.municipality;
                    
                    // PLZ
                    const zip = address.postcode || '';
                    
                    // ğŸ¨ Baue schÃ¶ne Anzeige
                    if (poiName && poiName !== fullAddress && poiName !== city) {
                        // Zeige: "ğŸ¨ Pommerscher Hof" in erster Zeile
                        displayText = `<div style="font-weight:600;color:#667eea;">ğŸ¨ ${poiName}</div>`;
                        // Zeige: "   SeestraÃŸe 41, 17424 Heringsdorf" in zweiter Zeile
                        displayText += `<div style="font-size:13px;color:#666;margin-top:2px;padding-left:20px;">`;
                        if (fullAddress) displayText += fullAddress;
                        if (zip) displayText += ', ' + zip;
                        if (city) displayText += ' ' + city;
                        displayText += '</div>';
                    } else {
                        // Normale Adresse ohne POI
                        if (fullAddress) {
                            displayText = fullAddress;
                            if (zip) displayText += ', ' + zip;
                            if (city) displayText += ' ' + city;
                        } else {
                            displayText = r.display_name;
                        }
                    }
                    
                    // FÃ¼r selectAddress: VollstÃ¤ndige Adresse als String
                    let addressString = '';
                    if (poiName && poiName !== fullAddress && poiName !== city) {
                        addressString = poiName + ' ';
                    }
                    if (fullAddress) addressString += fullAddress;
                    if (zip) addressString += ', ' + zip;
                    if (city) addressString += ' ' + city;
                    
                    if (!addressString) addressString = r.display_name;
                    
                    return `<div class="autocomplete-item" 
                        onclick="selectAddress('${inputId}', '${addressString.replace(/'/g, "\\'")}', ${r.lat}, ${r.lon})">
                        ${displayText}
                    </div>`;
                }).join('');
                
            } catch (e) {
                console.error('Autocomplete Fehler:', e);
                dropdown.innerHTML = '<div class="autocomplete-item" style="color:#ef4444;">Fehler bei der Suche</div>';
            }
        }

        function selectAddress(inputId, address, lat, lon) {
            document.getElementById(inputId).value = address;
            document.getElementById(inputId + '-dropdown').style.display = 'none';
            
            // Speichere Koordinaten
            if (inputId === 'pickup') {
                pickupCoords = { lat: parseFloat(lat), lon: parseFloat(lon) };
                console.log('âœ… Abholort gespeichert:', address, pickupCoords);
                showAvailableTaxis();
            } else {
                destCoords = { lat: parseFloat(lat), lon: parseFloat(lon) };
                console.log('âœ… Zielort gespeichert:', address, destCoords);
            }
        }

        // LOCATION
        function useMyLocation() {
            if (!navigator.geolocation) {
                alert('âŒ GPS nicht verfÃ¼gbar!');
                return;
            }
            
            console.log('ğŸ“ GPS wird abgerufen...');
            
            navigator.geolocation.getCurrentPosition(
                async (pos) => {
                    pickupCoords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                    console.log('âœ… Abholort gespeichert (GPS):', pickupCoords);
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pickupCoords.lat}&lon=${pickupCoords.lon}`);
                        const data = await response.json();
                        const address = data.address;
                        const street = address.road || address.pedestrian || '';
                        const houseNumber = address.house_number || '';
                        const city = address.town || address.village || address.city || 'Heringsdorf';
                        const addressString = `${street} ${houseNumber}, ${city}`.trim();
                        document.getElementById('pickup').value = addressString;
                        console.log('âœ… Adresse aufgelÃ¶st:', addressString);
                        showAvailableTaxis();
                    } catch (e) {
                        console.error('âŒ Reverse Geocoding Fehler:', e);
                        document.getElementById('pickup').value = `${pickupCoords.lat.toFixed(4)}, ${pickupCoords.lon.toFixed(4)}`;
                    }
                },
                (err) => {
                    console.error('âŒ GPS-Fehler:', err);
                    alert('âŒ GPS-Fehler: ' + err.message);
                }
            );
        }

        async function showAvailableTaxis() {
            // âœ… NUR ZEIGEN WENN GÃœLTIGE ABHOLADRESSE!
            if (!pickupCoords || !isFirebaseReady) {
                document.getElementById('available-taxis-display').innerHTML = '';
                return;
            }
            
            const onlineDrivers = Object.values(drivers).filter(d => d.online && d.timestamp && (Date.now() - d.timestamp) < 60000);
            
            if (onlineDrivers.length === 0) {
                document.getElementById('available-taxis-display').innerHTML = '<div class="alert-info">â³ Momentan keine Taxis verfÃ¼gbar</div>';
                return;
            }
            
            const taxisWithETA = await Promise.all(onlineDrivers.map(async (d) => {
                const route = await calculateRoute(d, pickupCoords);
                return { ...d, ...route };
            }));
            
            taxisWithETA.sort((a, b) => a.distance - b.distance);
            
            const html = `<div class="available-taxis"><h3>ğŸš• ${taxisWithETA.length} Taxis verfÃ¼gbar</h3>` +
                taxisWithETA.slice(0, 3).map(t => {
                    const plate = VEHICLES[t.vehicleId] ? VEHICLES[t.vehicleId].plate : '';
                    return `<div class="taxi-item"><strong>${t.vehicle}</strong>${plate ? `<br>ğŸš— ${plate}` : ''}<br>ğŸ“ ${t.distance} km entfernt (ca. ${t.duration} Min)</div>`;
                }).join('') +
                `<div style="margin-top:10px;padding:10px;background:#e0f2fe;border-radius:8px;text-align:center;"><strong>NÃ¤chstes Taxi in ca. ${taxisWithETA[0].duration} Minuten!</strong></div></div>`;
            document.getElementById('available-taxis-display').innerHTML = html;
        }

        // ğŸ†• PREIS-BUTTON HANDLER - wechselt zwischen "Preis berechnen" und "Abbrechen"
        let priceCalculated = false;
        
        function handlePriceButton() {
            if (priceCalculated) {
                // Abbrechen-Modus: Reset
                cancelBooking();
            } else {
                // Preis-berechnen-Modus
                calculatePriceAndShow();
            }
        }
        
        // ğŸ†• BUCHUNG ABBRECHEN - setzt alles zurÃ¼ck
        function cancelBooking() {
            // ğŸ†• BestÃ¤tigungsdialog
            const confirmed = confirm('â†©ï¸ Buchung wirklich abbrechen?\n\nAlle eingegebenen Daten werden gelÃ¶scht.');
            if (!confirmed) return;
            
            // Felder leeren
            document.getElementById('pickup').value = '';
            document.getElementById('destination').value = '';
            document.getElementById('pickup-time').value = 'jetzt';
            document.getElementById('passengers').value = '1';
            
            // Karte verstecken
            const routeMap = document.getElementById('route-map');
            if (routeMap) routeMap.style.display = 'none';
            
            // Preis verstecken
            document.getElementById('price-display').innerHTML = '';
            
            // Taxi buchen Button verstecken
            document.getElementById('book-btn').style.display = 'none';
            
            // VerfÃ¼gbare Taxis verstecken
            document.getElementById('available-taxis-display').innerHTML = '';
            
            // Button zurÃ¼ck zu "Preis berechnen"
            const priceBtn = document.getElementById('price-btn');
            priceBtn.innerHTML = 'ğŸ’° Preis berechnen';
            priceBtn.classList.remove('btn-danger');
            priceBtn.classList.add('btn-primary');
            
            // Status zurÃ¼cksetzen
            priceCalculated = false;
            window.currentPrice = null;
            window.currentDistance = null;
            window.currentDuration = null;
            pickupCoords = null;
            destCoords = null;
            
            console.log('â†©ï¸ Buchung abgebrochen');
        }

        // BOOKING
        async function calculatePriceAndShow() {
            const pickup = document.getElementById('pickup').value.trim();
            const destination = document.getElementById('destination').value.trim();
            
            if (!pickup || !destination) {
                alert('âŒ Bitte Abholort und Zielort eingeben!');
                return;
            }
            
            // Wenn Coords noch nicht vorhanden (User hat nicht aus Autocomplete gewÃ¤hlt), geocode
            if (!pickupCoords) {
                pickupCoords = await geocode(pickup);
                if (!pickupCoords) {
                    alert('âŒ Abholort "' + pickup + '" nicht gefunden!\n\nTipp: Nutze die Autocomplete-VorschlÃ¤ge');
                    return;
                }
            }
            
            if (!destCoords) {
                destCoords = await geocode(destination);
                if (!destCoords) {
                    alert('âŒ Zielort "' + destination + '" nicht gefunden!\n\nTipp: Nutze die Autocomplete-VorschlÃ¤ge');
                    return;
                }
            }
            
            const route = await calculateRoute(pickupCoords, destCoords);
            
            // Hole Abholzeit fÃ¼r korrekte Tarifberechnung
            const pickupTimeSelect = document.getElementById('pickup-time').value;
            const customDateTime = document.getElementById('custom-datetime').value;
            let pickupTimestamp = Date.now();
            
            if (pickupTimeSelect === '15min') {
                pickupTimestamp = Date.now() + 15 * 60000;
            } else if (pickupTimeSelect === '30min') {
                pickupTimestamp = Date.now() + 30 * 60000;
            } else if (pickupTimeSelect === '1h') {
                pickupTimestamp = Date.now() + 60 * 60000;
            } else if (pickupTimeSelect === 'datetime' && customDateTime) {
                pickupTimestamp = new Date(customDateTime).getTime();
            }
            
            // Berechne Preis MIT Zeitstempel (fÃ¼r korrekten Tag/Nacht-Tarif)
            const pricing = calculatePrice(parseFloat(route.distance), pickupTimestamp);
            
            window.currentPrice = pricing.total;
            window.currentDistance = route.distance;
            window.currentDuration = route.duration;
            
            let priceHtml = `<div style="background:white;padding:15px;border-radius:8px;border:2px solid #10b981;">
                <div style="font-size:32px;font-weight:bold;color:#10b981;text-align:center;">${pricing.total}â‚¬</div>
                <div style="text-align:center;margin-top:8px;color:#666;">
                    ${route.distance} km â€¢ ${route.duration} Min Fahrt
                </div>`;
            
            if (pricing.zuschlagText.length > 0) {
                priceHtml += `<div style="margin-top:10px;padding:8px;background:#fef3c7;border-radius:6px;font-size:13px;text-align:center;">
                    ${pricing.zuschlagText.join(' â€¢ ')}
                </div>`;
            }
            
            priceHtml += '</div>';
            
            const priceDisplay = document.getElementById('price-display');
            priceDisplay.innerHTML = priceHtml;
            priceDisplay.style.display = 'block';
            
            // ğŸ—ºï¸ ROUTE-KARTE ANZEIGEN
            showRouteMap(route, pickupCoords, destCoords);
            
            const bookBtn = document.getElementById('book-btn');
            if (bookBtn) {
                bookBtn.style.display = 'block';
                bookBtn.style.visibility = 'visible';
            }
            
            // ğŸ†• PREIS-BUTTON ZU ABBRECHEN Ã„NDERN
            const priceBtn = document.getElementById('price-btn');
            if (priceBtn) {
                priceBtn.innerHTML = 'â†©ï¸ Abbrechen';
                priceBtn.classList.remove('btn-primary');
                priceBtn.classList.add('btn-danger');
            }
            priceCalculated = true;
        }

        // ğŸ—ºï¸ ROUTE-KARTE ANZEIGEN
        let routeMapInstance = null;
        function showRouteMap(route, pickupCoords, destCoords) {
            const mapContainer = document.getElementById('route-map');
            mapContainer.style.display = 'block';
            
            // Karte entfernen falls vorhanden
            if (routeMapInstance) {
                routeMapInstance.remove();
            }
            
            // Neue Karte erstellen - 2-Finger-Zoom, 1-Finger scrollt Seite
            routeMapInstance = L.map('route-map', {
                zoomControl: false,
                attributionControl: false,
                dragging: false,           // Kein Drag mit 1 Finger
                tap: false,                // Kein Tap-Drag
                scrollWheelZoom: false,    // Kein Scroll-Zoom
                touchZoom: true            // Pinch-Zoom mit 2 Fingern erlaubt
            });
            
            // OpenStreetMap Tiles laden
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19
            }).addTo(routeMapInstance);
            
            // Start Marker (grÃ¼n)
            L.marker([pickupCoords.lat, pickupCoords.lon], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background:#10b981;width:24px;height:24px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);"></div>',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                })
            }).addTo(routeMapInstance);
            
            // Ziel Marker (rot)
            L.marker([destCoords.lat, destCoords.lon], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background:#ef4444;width:24px;height:24px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);"></div>',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                })
            }).addTo(routeMapInstance);
            
            // Route-Linie zeichnen (aus geometry)
            if (route.geometry && route.geometry.length > 0) {
                const routeLine = L.polyline(
                    route.geometry.map(coord => [coord[1], coord[0]]), // [lon, lat] â†’ [lat, lon]
                    {
                        color: '#667eea',
                        weight: 5,
                        opacity: 0.8
                    }
                ).addTo(routeMapInstance);
                
                // Zoom auf Route
                routeMapInstance.fitBounds(routeLine.getBounds(), { padding: [30, 30] });
            } else {
                // Fallback: Zoom auf Start und Ziel
                routeMapInstance.fitBounds([
                    [pickupCoords.lat, pickupCoords.lon],
                    [destCoords.lat, destCoords.lon]
                ], { padding: [30, 30] });
            }
            
            console.log('ğŸ—ºï¸ Route-Karte angezeigt');
        }

        // ğŸ¯ INTELLIGENTE AUTO-ZUWEISUNG MIT 30-SEK-TIMER
        async function startAutoAssignment(rideId, ride) {
            console.log('ğŸ¯ Starte Auto-Zuweisung fÃ¼r Fahrt:', rideId);
            
            // Finde nÃ¤chstes verfÃ¼gbares Taxi
            const nearestVehicle = findNearestAvailableVehicle(ride.pickupCoords);
            
            if (!nearestVehicle) {
                console.log('âš ï¸ Kein Taxi verfÃ¼gbar - Fahrt bleibt in Warteschlange');
                return;
            }
            
            console.log('âœ… NÃ¤chstes Taxi gefunden:', nearestVehicle.id, 'Entfernung:', nearestVehicle.distance.toFixed(2), 'km');
            
            // Markiere Fahrt als zugewiesen
            await db.ref('rides/' + rideId).update({
                assignedTo: nearestVehicle.id,
                assignedVehicleName: nearestVehicle.name,
                assignedAt: Date.now(),
                assignmentExpiresAt: Date.now() + 30000, // 30 Sekunden
                assignmentDistance: nearestVehicle.distance
            });
            
            // Push-Benachrichtigung an Fahrer
            sendLocalNotification(
                'ğŸš• NEUE FAHRT!',
                `${ride.customerName || 'Fahrgast'} â€¢ ${ride.pickup} â†’ ${ride.destination}\nğŸ’° ${ride.price}â‚¬ â€¢ â±ï¸ 30 Sekunden Zeit!`,
                { rideId: rideId, vehicleId: nearestVehicle.id }
            );
            
            // Starte 30-Sekunden-Timer
            assignmentTimers[rideId] = setTimeout(async () => {
                // PrÃ¼fe ob Fahrt in 30 Sek. angenommen wurde
                const rideCheck = await db.ref('rides/' + rideId).once('value');
                const rideData = rideCheck.val();
                
                if (rideData && rideData.status === 'new') {
                    console.log('â° TIMEOUT! Fahrt nicht angenommen - weise nÃ¤chstem Taxi zu');
                    
                    // Zur Blacklist hinzufÃ¼gen (fÃ¼r diese Fahrt)
                    const blacklist = rideData.assignmentBlacklist || [];
                    blacklist.push(nearestVehicle.id);
                    
                    await db.ref('rides/' + rideId).update({
                        assignedTo: null,
                        assignmentBlacklist: blacklist,
                        lastAssignmentTimeout: Date.now()
                    });
                    
                    // NÃ¤chstes Taxi zuweisen
                    startAutoAssignment(rideId, rideData);
                }
            }, 30000);
        }

        // Finde nÃ¤chstes verfÃ¼gbares Taxi nach GPS-Entfernung
        function findNearestAvailableVehicle(pickupCoords) {
            const availableVehicles = [];
            
            // Durchsuche alle Online-Fahrer
            for (const vehicleId in drivers) {
                const driver = drivers[vehicleId];
                
                // PrÃ¼fungen:
                // 1. Fahrer ist online
                // 2. Hat GPS-Position
                // 3. Hat keine aktive Fahrt
                if (driver && driver.online && driver.lat && driver.lon) {
                    // PrÃ¼fe ob Fahrzeug bereits eine Fahrt hat oder zugewiesen bekommen hat
                    const hasActiveRide = rides.some(r => 
                        (r.vehicleId === vehicleId || r.assignedTo === vehicleId) && 
                        (r.status === 'assigned' || r.status === 'accepted' || r.status === 'picked_up')
                    );
                    
                    if (!hasActiveRide) {
                        // Berechne Entfernung
                        const distance = calculateDistance(
                            pickupCoords.lat, pickupCoords.lon,
                            driver.lat, driver.lon
                        );
                        
                        availableVehicles.push({
                            id: vehicleId,
                            name: driver.vehicle || VEHICLES[vehicleId]?.name || vehicleId,
                            distance: distance,
                            lat: driver.lat,
                            lon: driver.lon
                        });
                    }
                }
            }
            
            // Sortiere nach Entfernung (nÃ¤chstes zuerst)
            availableVehicles.sort((a, b) => a.distance - b.distance);
            
            console.log('ğŸ“ VerfÃ¼gbare Taxis:', availableVehicles.length, availableVehicles);
            
            return availableVehicles.length > 0 ? availableVehicles[0] : null;
        }

        // Haversine-Formel fÃ¼r Entfernungsberechnung
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Erdradius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        async function book() {
            const customerName = document.getElementById('customer-name').value.trim();
            const customerPhone = document.getElementById('customer-phone').value.trim();
            const pickupTimeSelect = document.getElementById('pickup-time').value;
            const customDateTime = document.getElementById('custom-datetime').value;
            
            if (!customerName) {
                alert('âŒ Bitte Name eingeben!');
                return;
            }
            
            if (!customerPhone) {
                alert('âŒ Bitte Telefonnummer eingeben!\n\nDie Telefonnummer wird benÃ¶tigt, damit der Fahrer Sie bei RÃ¼ckfragen erreichen kann.');
                document.getElementById('customer-phone').focus();
                return;
            }
            
            let pickupTime = 'Sofort';
            let pickupTimestamp = Date.now();
            const now = new Date();
            
            if (pickupTimeSelect === '15min') {
                pickupTime = new Date(now.getTime() + 15 * 60000).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                pickupTimestamp = now.getTime() + 15 * 60000;
            } else if (pickupTimeSelect === '30min') {
                pickupTime = new Date(now.getTime() + 30 * 60000).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                pickupTimestamp = now.getTime() + 30 * 60000;
            } else if (pickupTimeSelect === '1h') {
                pickupTime = new Date(now.getTime() + 60 * 60000).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                pickupTimestamp = now.getTime() + 60 * 60000;
            } else if (pickupTimeSelect === 'datetime' && customDateTime) {
                // Datum & Zeit aus datetime-local
                const selectedDate = new Date(customDateTime);
                pickupTimestamp = selectedDate.getTime();
                
                // Formatiere als "22.11.2024, 08:00"
                pickupTime = selectedDate.toLocaleString('de-DE', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                // PrÃ¼fe ob in der Vergangenheit
                if (pickupTimestamp < Date.now()) {
                    alert('âŒ Die Abholzeit liegt in der Vergangenheit!\n\nBitte wÃ¤hle eine Zeit in der Zukunft.');
                    return;
                }
                
                // Warnung wenn sehr weit in der Zukunft (mehr als 7 Tage)
                const daysDiff = (pickupTimestamp - Date.now()) / (1000 * 60 * 60 * 24);
                if (daysDiff > 7) {
                    const confirm = window.confirm(
                        `ğŸ“… Buchung fÃ¼r ${Math.floor(daysDiff)} Tage im Voraus\n\n` +
                        `Abholung: ${pickupTime}\n\n` +
                        `MÃ¶chtest du diese Vorausbuchung bestÃ¤tigen?`
                    );
                    if (!confirm) return;
                }
            }
            
            // ğŸ• Berechne Zeitdifferenz fÃ¼r Vorbestellungs-Logik
            const minutesUntilPickup = (pickupTimestamp - Date.now()) / (1000 * 60);
            
            // âš¡ Sofort (â‰¤15 Min) vs ğŸ“… Vorbestellung (>15 Min)
            const rideStatus = minutesUntilPickup <= 15 ? 'new' : 'vorbestellt';
            
            const ride = {
                id: Date.now(),
                customerName,
                customerPhone,
                pickupTime,
                pickupTimestamp,
                pickup: document.getElementById('pickup').value,
                destination: document.getElementById('destination').value,
                passengers: document.getElementById('passengers').value,
                price: window.currentPrice,
                distance: window.currentDistance,
                duration: window.currentDuration,
                pickupCoords, destCoords,
                status: rideStatus,
                time: new Date().toLocaleString('de-DE'),
                createdAt: Date.now()
            };
            
            const savedRide = await saveRide(ride);
            myCurrentRide = savedRide;
            localStorage.setItem('myCurrentRideId', savedRide.firebaseId);
            
            // ğŸ“‹ CRM: Kunde automatisch anlegen/aktualisieren
            await updateCustomerCRM(customerName, customerPhone, ride.pickup, ride.price);
            
            // ğŸ“‹ CRM: Stammkunden-Daten aktualisieren wenn Checkbox aktiv
            const saveToCrmCheckbox = document.getElementById('save-to-crm');
            if (currentBookingCustomerId && saveToCrmCheckbox && saveToCrmCheckbox.checked) {
                try {
                    await db.ref('customers/' + currentBookingCustomerId).update({
                        phone: customerPhone,
                        address: ride.pickup
                    });
                    console.log('ğŸ“‹ Stammkunden-Daten aktualisiert:', currentBookingCustomerId);
                } catch (error) {
                    console.error('âŒ Fehler beim Aktualisieren:', error);
                }
            }
            
            // Reset Stammkunden-ID und verstecke Checkbox
            currentBookingCustomerId = null;
            const crmOption = document.getElementById('crm-save-option');
            if (crmOption) crmOption.style.display = 'none';
            
            // ğŸ”„ Aktualisiere Verlauf (damit Vorbestellung sofort sichtbar ist)
            updateHistoryView();
            
            // âœ… BESTÃ„TIGUNG fÃ¼r Nutzer
            if (savedRide.status === 'vorbestellt') {
                alert(
                    'âœ… Vorbestellung erfolgreich!\n\n' +
                    'ğŸ“… Abholung: ' + pickupTime + '\n' +
                    'ğŸ“ Von: ' + ride.pickup + '\n' +
                    'ğŸ¯ Nach: ' + ride.destination + '\n' +
                    'ğŸ’° Preis: ' + ride.price + 'â‚¬\n\n' +
                    'ğŸ’¡ Du kannst deine Buchung jederzeit im Verlauf Ã¤ndern oder stornieren.'
                );
            } else {
                alert(
                    'âœ… Buchung erfolgreich!\n\n' +
                    'ğŸ“ Von: ' + ride.pickup + '\n' +
                    'ğŸ¯ Nach: ' + ride.destination + '\n' +
                    'ğŸ’° Preis: ' + ride.price + 'â‚¬\n\n' +
                    'ğŸš• Wir suchen jetzt einen Fahrer fÃ¼r dich!'
                );
            }
            
            // ğŸ¯ AUTO-ZUWEISUNG starten (nur wenn NICHT Vorbestellung)
            if (isFirebaseReady && savedRide.firebaseId && savedRide.status === 'new') {
                startAutoAssignment(savedRide.firebaseId, savedRide);
            }
            
            document.getElementById('booking-form').style.display = 'none';
            showRideStatus(savedRide);
            
            if (isFirebaseReady) listenToMyRide(savedRide.firebaseId);
        }

        function listenToMyRide(rideId) {
            if (!isFirebaseReady) return;
            db.ref('rides/' + rideId).on('value', (s) => {
                const ride = s.val();
                if (ride) {
                    ride.firebaseId = rideId;
                    myCurrentRide = ride;
                    showRideStatus(ride);
                }
            });
        }

        async function cancelRideConfirm(rideId) {
            const ride = myCurrentRide;
            
            let confirmMessage = 'ğŸ—‘ï¸ Fahrt wirklich stornieren?\n\nDie Buchung wird gelÃ¶scht.';
            let hasCancellationFee = false;
            let cancellationFee = 0;
            
            // StornogebÃ¼hr wenn Fahrer schon unterwegs
            if (ride && ride.status === 'accepted') {
                if (ride.driverLocation) {
                    // FAHRER IST UNTERWEGS - KOSTENPFLICHTIG!
                    cancellationFee = 10.00; // 10â‚¬ StornogebÃ¼hr
                    hasCancellationFee = true;
                    
                    confirmMessage = 'âš ï¸ KOSTENPFLICHTIGE STORNIERUNG!\n\n' +
                        ride.vehicle + ' ist bereits unterwegs zu dir!\n\n' +
                        'ğŸ’¶ StornogebÃ¼hr: ' + cancellationFee.toFixed(2) + 'â‚¬\n' +
                        '(Wird bei nÃ¤chster Fahrt berechnet)\n\n' +
                        'Trotzdem stornieren?\n\n' +
                        '(Kostenlos stornieren: 038378 / 1234)';
                } else {
                    // Fahrer hat angenommen, aber noch nicht losgefahren
                    confirmMessage = 'âš ï¸ ACHTUNG!\n\n' +
                        ride.vehicle + ' hat die Fahrt bereits angenommen!\n\n' +
                        'Stornierung noch kostenlos mÃ¶glich.\n\n' +
                        'Trotzdem stornieren?';
                }
            }
            
            const confirmed = confirm(confirmMessage);
            
            if (!confirmed) return;
            
            // StornogebÃ¼hr speichern
            if (hasCancellationFee) {
                const cancellation = {
                    rideId: ride.id,
                    customerName: ride.customerName,
                    pickup: ride.pickup,
                    destination: ride.destination,
                    originalPrice: ride.price,
                    cancellationFee: cancellationFee,
                    cancelledAt: Date.now(),
                    reason: 'customer_cancelled_driver_on_way'
                };
                
                // Speichere Stornierung in Firebase
                if (isFirebaseReady) {
                    await db.ref('cancellations').push(cancellation);
                    console.log('ğŸ’¶ StornogebÃ¼hr gespeichert:', cancellationFee + 'â‚¬');
                }
            }
            
            // Setze Fahrt auf cancelled_pending_driver damit Fahrer bestÃ¤tigen muss!
            if (isFirebaseReady && rideId) {
                await db.ref('rides/' + rideId).update({
                    status: hasCancellationFee ? 'cancelled_pending_driver' : 'cancelled',  // â† Wenn kostenpflichtig, muss Fahrer bestÃ¤tigen!
                    cancelledAt: Date.now(),
                    cancelledBy: 'passenger',
                    cancellationFee: cancellationFee,
                    driverNotified: false,  // Flag: Fahrer muss noch benachrichtigt werden
                    cancellationReason: hasCancellationFee ? 'Fahrer bereits unterwegs' : 'Kunde storniert'
                });
                console.log('âŒ Fahrt storniert in Firebase:', rideId, hasCancellationFee ? '(wartet auf Fahrer-BestÃ¤tigung)' : '(sofort storniert)');
            }
            
            // âœ… Update auch localStorage!
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            const localRide = history.find(r => r.firebaseId === rideId || r.id === rideId);
            if (localRide) {
                localRide.status = hasCancellationFee ? 'cancelled_pending_driver' : 'cancelled';
                localRide.cancelledAt = Date.now();
                localRide.cancellationFee = cancellationFee;
                localStorage.setItem('rideHistory', JSON.stringify(history));
                console.log('âœ… Fahrt in localStorage storniert');
            }
            
            // Lokalen Status zurÃ¼cksetzen
            localStorage.removeItem('myCurrentRideId');
            myCurrentRide = null;
            document.getElementById('ride-status-container').innerHTML = '';
            document.getElementById('booking-form').style.display = 'block';
            
            // ğŸ†• FORMULAR ZURÃœCKSETZEN nach Stornierung
            resetBookingForm();
            
            if (hasCancellationFee) {
                alert('âœ… Fahrt storniert!\n\nğŸ’¶ StornogebÃ¼hr: ' + cancellationFee.toFixed(2) + 'â‚¬\n\nWird bei deiner nÃ¤chsten Fahrt berechnet.');
            } else {
                alert('âœ… Fahrt storniert!');
            }
        }

        // ğŸ†• FORMULAR ZURÃœCKSETZEN (nach Stornierung oder abgeschlossener Fahrt)
        function resetBookingForm() {
            // Felder LEEREN
            document.getElementById('pickup').value = '';
            document.getElementById('destination').value = '';
            
            // ZurÃ¼cksetzen auf Default-Werte
            document.getElementById('pickup-time').value = 'jetzt';
            document.getElementById('passengers').value = '1';
            
            // datetime-local Feld ausblenden falls sichtbar
            document.getElementById('custom-datetime').style.display = 'none';
            document.getElementById('datetime-help').style.display = 'none';
            
            // Preis-Anzeige ausblenden
            document.getElementById('price-display').innerHTML = '';
            document.getElementById('price-display').style.display = 'none';
            
            // ğŸ—ºï¸ Route-Karte ausblenden
            const routeMapEl = document.getElementById('route-map');
            if (routeMapEl) {
                routeMapEl.style.display = 'none';
            }
            if (routeMapInstance) {
                routeMapInstance.remove();
                routeMapInstance = null;
            }
            
            // "Taxi buchen" Button verstecken (WICHTIG!)
            const bookBtn = document.getElementById('book-btn');
            if (bookBtn) {
                bookBtn.style.display = 'none';
                bookBtn.style.visibility = 'hidden'; // Doppelt sicher!
            }
            
            // VerfÃ¼gbare Taxis ausblenden
            document.getElementById('available-taxis-display').innerHTML = '';
            
            // Global Variablen zurÃ¼cksetzen
            window.currentPrice = null;
            window.currentDistance = null;
            window.currentDuration = null;
            pickupCoords = null;  // âœ… Ohne "window."!
            destCoords = null;    // âœ… Ohne "window."!
            
            console.log('âœ… Formular zurÃ¼ckgesetzt');
        }

        async function cancelRide() {
            // Statt zu lÃ¶schen, als "storniert" markieren!
            if (myCurrentRide) {
                const rideId = myCurrentRide.firebaseId || myCurrentRide.id;
                
                // Update Firebase
                if (isFirebaseReady && rideId) {
                    try {
                        await db.ref('rides/' + rideId).update({ 
                            status: 'storniert',
                            cancelledAt: Date.now()
                        });
                        console.log('âœ… Sofort-Fahrt in Firebase storniert');
                    } catch (error) {
                        console.error('âŒ Fehler beim Stornieren in Firebase:', error);
                    }
                }
                
                // Update localStorage
                const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
                const ride = history.find(r => r.firebaseId === rideId || r.id === rideId);
                if (ride) {
                    ride.status = 'storniert';
                    ride.cancelledAt = Date.now();
                    localStorage.setItem('rideHistory', JSON.stringify(history));
                    console.log('âœ… Sofort-Fahrt in localStorage storniert');
                }
            }
            
            // UI aufrÃ¤umen
            localStorage.removeItem('myCurrentRideId');
            myCurrentRide = null;
            document.getElementById('ride-status-container').innerHTML = '';
            document.getElementById('booking-form').style.display = 'block';
            
            // ğŸ†• FORMULAR ZURÃœCKSETZEN nach Stornierung
            resetBookingForm();
        }

        // DRIVER FUNCTIONS
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    // Wenn bereits aktiv, nicht neu anfordern
                    if (wakeLock !== null && !wakeLock.released) {
                        console.log('âœ… Wake Lock bereits aktiv');
                        return;
                    }
                    
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('âœ… Screen Wake Lock aktiviert');
                    
                    wakeLock.addEventListener('release', () => {
                        console.log('âš ï¸ Wake Lock freigegeben - versuche sofortige Reaktivierung');
                        wakeLock = null;
                        
                        // SOFORT neu aktivieren wenn noch online
                        if (isOnline) {
                            requestWakeLock();
                        }
                    });
                } else {
                    console.warn('âš ï¸ Wake Lock API nicht verfÃ¼gbar');
                }
            } catch (err) {
                console.error('âŒ Wake Lock Fehler:', err);
                wakeLock = null;
                
                // Bei Fehler sofort nochmal versuchen wenn online
                if (isOnline) {
                    setTimeout(() => {
                        if (wakeLock === null && isOnline) {
                            requestWakeLock();
                        }
                    }, 1000);
                }
            }
        }
        
        // ğŸ”„ Wake Lock alle 30 Sekunden checken & reaktivieren
        setInterval(() => {
            if (isOnline && currentView === 'driver') {
                if (wakeLock === null || wakeLock.released) {
                    console.log('ğŸ”„ Wake Lock Check: Reaktiviere...');
                    requestWakeLock();
                }
            }
        }, 30000); // Alle 30 Sekunden

        function releaseWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release();
                wakeLock = null;
            }
        }

        // ğŸš¨ FAHRER-BENACHRICHTIGUNG BEI STORNIERUNG
        async function notifyDriverOfCancellation(ride) {
            console.log('ğŸš¨ STORNIERUNG ERKANNT:', ride);
            
            // Spiele Sound ab (falls Browser erlaubt)
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ==');
                audio.play().catch(e => console.log('Audio play blocked'));
            } catch (e) {
                console.log('Audio not supported');
            }
            
            // SchlieÃŸe Karte falls offen
            closeDriverMap();
            
            // GroÃŸe Alert-Box
            const feeText = ride.cancellationFee ? `\n\nğŸ’¶ StornogebÃ¼hr: ${ride.cancellationFee.toFixed(2)}â‚¬\n(Wird dem Kunden berechnet)` : '';
            
            alert(
                `ğŸš¨ FAHRT STORNIERT!\n\n` +
                `#${ride.id} - ${ride.customerName || 'Fahrgast'}\n` +
                `Von: ${ride.pickup}\n` +
                `Nach: ${ride.destination}\n\n` +
                `âŒ Kunde hat gerade storniert!${feeText}\n\n` +
                `Fahrt wird archiviert.`
            );
            
            // Markiere als benachrichtigt in Firebase
            if (isFirebaseReady && ride.firebaseId) {
                await db.ref('rides/' + ride.firebaseId).update({
                    driverNotified: true,
                    driverNotifiedAt: Date.now()
                });
                console.log('âœ… Fahrer als benachrichtigt markiert');
            }
            
            // ğŸ”§ WICHTIG: GPS und Wake Lock neu aktivieren!
            console.log('ğŸ”„ Reaktiviere GPS und Wake Lock...');
            if (isOnline && currentVehicle) {
                requestWakeLock();
                // GPS lÃ¤uft schon, nur sicherstellen dass es aktiv ist
                if (!watchId) {
                    startDriverTracking(null);
                }
            }
            
            // Nach 5 Sekunden automatisch zu "completed" verschieben fÃ¼r Archivierung
            setTimeout(async () => {
                if (isFirebaseReady && ride.firebaseId) {
                    await db.ref('rides/' + ride.firebaseId).update({
                        status: 'completed',
                        archivedAsCancel: true
                    });
                    updateViews();
                }
            }, 5000);
        }
        
        // ğŸ“ KUNDE ANRUFEN
        function callCustomer() {
            const ride = rides.find(r => 
                r.vehicleId === currentVehicle && 
                (r.status === 'accepted' || r.status === 'picked_up')
            );
            
            if (!ride) {
                alert('âŒ Keine aktive Fahrt gefunden!');
                return;
            }
            
            if (!ride.customerPhone) {
                alert('âŒ Keine Telefonnummer hinterlegt!\n\nKunde hat keine Nummer angegeben.');
                return;
            }
            
            // Ã–ffne Telefon-App
            window.open('tel:' + ride.customerPhone);
        }
        
        // ğŸ“‹ UPDATE DRIVER INFO TOP
        // ğŸ“‹ UPDATE DRIVER CARDS (A3/B3 Design)
        function updateDriverInfoTop(ride) {
            if (!ride) {
                console.error('âŒ updateDriverInfoTop: Kein ride!');
                return;
            }
            
            console.log('ğŸ“‹ updateDriverInfoTop called with ride:');
            console.log('   - id:', ride.id || ride.firebaseId);
            console.log('   - customerName:', ride.customerName);
            console.log('   - pickup:', ride.pickup);
            console.log('   - destination:', ride.destination);
            console.log('   - status:', ride.status);
            console.log('   - VOLLES OBJEKT:', JSON.stringify(ride));
            
            const rideId = ride.firebaseId || ride.id;
            
            // Customer Name
            const customerName = document.getElementById('driver-customer-name');
            if (customerName) {
                customerName.textContent = 'ğŸ‘¤ ' + (ride.customerName || 'Kunde');
            }
            
            // Call Button
            const callButton = document.getElementById('driver-call-button');
            if (callButton) {
                // Nur zeigen wenn: Telefon DA + noch unterwegs zum Kunden
                if (ride.customerPhone && ride.status === 'accepted') {
                    callButton.style.display = 'block';
                } else {
                    callButton.style.display = 'none';  // Verstecken wenn Kunde an Bord
                }
            }
            
            // Cards Container
            const customerCard = document.getElementById('driver-customer-card');
            const priceCard = document.getElementById('driver-price-card');
            const pickupCard = document.getElementById('driver-pickup-card');
            const destCard = document.getElementById('driver-dest-card');
            
            if (ride.status === 'accepted') {
                // A3 Design: Zum Kunden
                // Zeige: Kunde, Pickup, Destination
                // Verstecke: Preis
                
                if (customerCard) customerCard.style.gridColumn = '1 / -1';
                if (priceCard) priceCard.style.display = 'none';
                if (pickupCard) {
                    pickupCard.style.display = 'block';
                    const pickupValue = document.getElementById('driver-pickup-value');
                    if (pickupValue) pickupValue.textContent = ride.pickup || '-';
                }
                if (destCard) {
                    const destValue = document.getElementById('driver-dest-value');
                    if (destValue) destValue.textContent = ride.destination || '-';
                }
                
            } else if (ride.status === 'picked_up') {
                // B3 Design: Kunde an Bord
                // Zeige: Kunde, Preis, Destination
                // Verstecke: Pickup
                
                const cardsContainer = document.getElementById('driver-cards-container');
                if (cardsContainer) {
                    cardsContainer.style.gridTemplateColumns = '2fr 1fr';
                }
                
                if (customerCard) customerCard.style.gridColumn = '';
                if (priceCard) {
                    priceCard.style.display = 'block';
                    const priceValue = document.getElementById('driver-price-value');
                    if (priceValue) priceValue.textContent = 'ğŸ’° ' + (ride.price || '-') + 'â‚¬';
                }
                if (pickupCard) pickupCard.style.display = 'none';
                if (destCard) {
                    destCard.style.gridColumn = '1 / -1';
                    const destValue = document.getElementById('driver-dest-value');
                    if (destValue) destValue.textContent = ride.destination || '-';
                }
            }
            
            // Action Button
            const actionButton = document.getElementById('driver-action-button');
            if (actionButton) {
                if (ride.status === 'accepted') {
                    actionButton.textContent = 'ğŸš— Beim Kunden angekommen';
                    actionButton.onclick = () => pickupCustomer(rideId);
                    actionButton.style.background = '#667eea';
                } else if (ride.status === 'picked_up') {
                    actionButton.textContent = 'âœ… Ziel erreicht';
                    actionButton.onclick = () => completeRide(rideId);
                    actionButton.style.background = '#10b981';
                }
            }
        }

        function toggleOnline() {
            isOnline = document.getElementById('online-toggle').checked;
            
            // âœ… Sichere Zugriffe auf optionale Elemente
            const statusText = document.getElementById('online-status-text');
            if (statusText) {
                statusText.textContent = isOnline ? 'Online' : 'Offline';
                statusText.style.color = isOnline ? '#10b981' : '#666';
            }
            
            const gpsIndicator = document.getElementById('gps-indicator');
            const gpsDot = document.getElementById('gps-dot');
            const gpsStatus = document.getElementById('gps-status');
            
            if (isOnline) {
                if (gpsIndicator) gpsIndicator.style.display = 'flex';
                if (gpsDot) {
                    gpsDot.style.background = '#10b981';
                    gpsDot.classList.add('online');
                }
                if (gpsStatus) gpsStatus.textContent = 'ğŸ“ GPS On';
                requestWakeLock();
            } else {
                if (gpsDot) {
                    gpsDot.style.background = '#6b7280';
                    gpsDot.classList.remove('online');
                }
                if (gpsStatus) gpsStatus.textContent = 'ğŸ“ GPS Off';
                releaseWakeLock();
            }
            
            if (isOnline && currentVehicle) startDriverTracking(null);
            else stopDriverTracking();
        }

        function setVehicle() {
            const previousVehicle = currentVehicle;
            const vehicleId = document.getElementById('vehicle').value;
            
            // âœ… Stoppe GPS wenn Fahrzeug wechselt
            if (previousVehicle && previousVehicle !== vehicleId) {
                console.log('ğŸ”„ Fahrzeugwechsel erkannt - stoppe GPS');
                stopDriverTracking();
                stopGPSMonitoring();
            }
            
            currentVehicle = vehicleId;
            console.log('ğŸš— Fahrzeug gewÃ¤hlt:', currentVehicle);
            
            // ğŸ”’ NEUE LOGIK: Toggle nur aktivieren wenn Fahrzeug gewÃ¤hlt!
            const toggle = document.getElementById('online-toggle');
            if (toggle) {
                if (currentVehicle) {
                    toggle.disabled = false;
                    toggle.style.opacity = '1';
                    toggle.style.cursor = 'pointer';
                    console.log('âœ… Online-Toggle aktiviert');
                } else {
                    toggle.disabled = true;
                    toggle.checked = false;
                    toggle.style.opacity = '0.5';
                    toggle.style.cursor = 'not-allowed';
                    isOnline = false;
                    console.log('ğŸ”’ Online-Toggle gesperrt - kein Fahrzeug');
                    
                    // GPS stoppen wenn kein Fahrzeug
                    if (watchId) {
                        stopDriverTracking();
                    }
                }
            }
            
            if (currentVehicle && isOnline) startDriverTracking(null);
            updateViews();
        }

        function loadSavedVehicle() {
            const dropdown = document.getElementById('vehicle');
            if (dropdown && dropdown.value) {
                currentVehicle = dropdown.value;
                console.log('ğŸ”„ Gespeichertes Fahrzeug geladen:', currentVehicle);
                updateViews();
            }
        }

        // ğŸ”„ TOGGLE STATE SYNCHRONISIEREN
        function syncToggleState() {
            const toggle = document.getElementById('online-toggle');
            if (!toggle) return;
            
            console.log('ğŸ”„ Synchronisiere Toggle-State...');
            console.log('  - watchId:', watchId);
            console.log('  - isOnline:', isOnline);
            console.log('  - currentVehicle:', currentVehicle);
            
            // PrÃ¼fe ob GPS wirklich lÃ¤uft
            if (watchId && currentVehicle) {
                // GPS lÃ¤uft - soll online sein
                if (!isOnline || !toggle.checked) {
                    console.log('âœ… GPS lÃ¤uft, aber Toggle off â†’ Korrigiere auf ON');
                    isOnline = true;
                    toggle.checked = true;
                    
                    // Update UI
                    const statusText = document.getElementById('online-status-text');
                    if (statusText) {
                        statusText.textContent = 'Online';
                        statusText.style.color = '#10b981';
                    }
                }
            } else {
                // Kein GPS - soll offline sein
                if (isOnline || toggle.checked) {
                    console.log('âš ï¸ Kein GPS, aber Toggle on â†’ Korrigiere auf OFF');
                    isOnline = false;
                    toggle.checked = false;
                    
                    // Update UI
                    const statusText = document.getElementById('online-status-text');
                    if (statusText) {
                        statusText.textContent = 'Offline';
                        statusText.style.color = '#666';
                    }
                }
            }
            
            console.log('âœ… Toggle-State synchronisiert:', isOnline ? 'ON' : 'OFF');
        }

        function startDriverTracking(rideId) {
            if (!currentVehicle) {
                console.error('âŒ Kein Fahrzeug ausgewÃ¤hlt!');
                return;
            }
            
            // âœ… WICHTIG: Alte watchId IMMER cleanen BEVOR neu gestartet wird!
            if (watchId) {
                console.log('âš ï¸ GPS lÃ¤uft bereits - watchId:', watchId, '- STOPPE ERST!');
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                console.log('âœ… Alte watchId cleared');
            }
            
            console.log('ğŸš€ Starte GPS-Tracking' + (rideId ? ' fÃ¼r Fahrt: ' + rideId : ''));
            
            // Versuche ERST watchPosition mit HIGH ACCURACY
            watchId = navigator.geolocation.watchPosition(
                (pos) => {
                    const location = { 
                        lat: pos.coords.latitude, 
                        lon: pos.coords.longitude, 
                        timestamp: Date.now(), 
                        vehicleId: currentVehicle,
                        vehicle: VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle,
                        online: isOnline,
                        accuracy: pos.coords.accuracy
                    };
                    
                    // ğŸ¯ Update lastGPSUpdate fÃ¼r Monitoring
                    lastGPSUpdate = Date.now();
                    
                    console.log('ğŸ“ GPS (watchPosition):', location.lat.toFixed(4), location.lon.toFixed(4), 'Genauigkeit:', Math.round(location.accuracy), 'm');
                    
                    // Update GPS-Indicator
                    const gpsIndicator = document.getElementById('gps-indicator');
                    const gpsDot = document.getElementById('gps-dot');
                    const gpsStatus = document.getElementById('gps-status');
                    if (gpsIndicator && gpsDot && gpsStatus) {
                        gpsIndicator.style.display = 'flex';
                        gpsDot.classList.add('online');
                        gpsStatus.textContent = 'ğŸ“ GPS: ' + Math.round(location.accuracy) + 'm';
                    }
                    
                    if (!isFirebaseReady) {
                        console.error('âŒ Firebase nicht bereit!');
                        return;
                    }
                    
                    // Immer in drivers/ speichern
                    db.ref('drivers/' + currentVehicle).set(location).then(() => {
                        console.log('âœ… GPS â†’ drivers/' + currentVehicle);
                    }).catch(err => {
                        console.error('âŒ Fehler beim GPS-Upload:', err);
                    });
                    
                    // Wenn rideId vorhanden, auch in Fahrt speichern
                    if (rideId) {
                        db.ref('rides/' + rideId + '/driverLocation').set(location).then(() => {
                            console.log('âœ… GPS â†’ rides/' + rideId + '/driverLocation');
                        }).catch(err => {
                            console.error('âŒ Fehler beim GPS-Upload zur Fahrt:', err);
                        });
                    }
                },
                (err) => {
                    console.error('âŒ GPS Fehler:', err.message, err.code);
                    
                    // Update GPS-Indicator
                    const gpsIndicator = document.getElementById('gps-indicator');
                    const gpsDot = document.getElementById('gps-dot');
                    const gpsStatus = document.getElementById('gps-status');
                    if (gpsIndicator && gpsDot && gpsStatus) {
                        gpsIndicator.style.display = 'flex';
                        gpsDot.classList.remove('online');
                        gpsStatus.textContent = 'ğŸ“ GPS: Fehler';
                    }
                    
                    // Bei Timeout (Code 3) -> Automatisch neu versuchen
                    if (err.code === 3 && isOnline) {
                        console.log('â±ï¸ GPS Timeout - versuche erneut in 5 Sekunden...');
                        setTimeout(() => {
                            if (isOnline && !watchId) {
                                console.log('ğŸ”„ GPS-Tracking neu starten...');
                                startDriverTracking(rideId);
                            }
                        }, 5000);
                    } else if (err.code === 1) {
                        // Berechtigung verweigert
                        alert('âŒ GPS-Berechtigung verweigert!\n\nBitte in den Einstellungen die Standort-Berechtigung fÃ¼r diese App aktivieren.');
                    }
                },
                { 
                    enableHighAccuracy: true, 
                    maximumAge: 10000,  // Akzeptiere max. 10 Sek alte Position
                    timeout: 60000      // 60 Sekunden Timeout (erhÃ¶ht von 30)
                }
            );
            
            console.log('ğŸ¯ GPS watchId:', watchId);
            
            // FALLBACK: Wenn watchPosition nach 30 Sek kein Update liefert, nutze Intervall
            setTimeout(() => {
                if (isOnline && !document.getElementById('gps-dot')?.classList.contains('online')) {
                    console.warn('âš ï¸ watchPosition liefert keine Updates - aktiviere Fallback-Modus');
                    
                    // Starte Intervall-basiertes GPS
                    const gpsInterval = setInterval(() => {
                        if (!isOnline) {
                            clearInterval(gpsInterval);
                            return;
                        }
                        
                        navigator.geolocation.getCurrentPosition(
                            (pos) => {
                                const location = { 
                                    lat: pos.coords.latitude, 
                                    lon: pos.coords.longitude, 
                                    timestamp: Date.now(), 
                                    vehicleId: currentVehicle,
                                    vehicle: VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle,
                                    online: isOnline,
                                    accuracy: pos.coords.accuracy
                                };
                                
                                console.log('ğŸ“ GPS (Fallback):', location.lat.toFixed(4), location.lon.toFixed(4), 'Genauigkeit:', Math.round(location.accuracy), 'm');
                                
                                // Update GPS-Indicator
                                const gpsIndicator = document.getElementById('gps-indicator');
                                const gpsDot = document.getElementById('gps-dot');
                                const gpsStatus = document.getElementById('gps-status');
                                if (gpsIndicator && gpsDot && gpsStatus) {
                                    gpsIndicator.style.display = 'flex';
                                    gpsDot.classList.add('online');
                                    gpsStatus.textContent = 'ğŸ“ GPS: ' + Math.round(location.accuracy) + 'm (Fallback)';
                                }
                                
                                if (isFirebaseReady) {
                                    db.ref('drivers/' + currentVehicle).set(location).then(() => {
                                        console.log('âœ… GPS (Fallback) â†’ drivers/' + currentVehicle);
                                    });
                                }
                            },
                            (err) => {
                                console.error('âŒ GPS Fallback-Fehler:', err);
                            },
                            { 
                                enableHighAccuracy: true, 
                                maximumAge: 0,
                                timeout: 10000
                            }
                        );
                    }, 15000); // Alle 15 Sekunden
                    
                    // Speichere Intervall-ID zum AufrÃ¤umen
                    window.gpsIntervalId = gpsInterval;
                }
            }, 30000);
        }

        function stopDriverTracking() {
            if (watchId) { 
                navigator.geolocation.clearWatch(watchId); 
                watchId = null; 
                console.log('ğŸ›‘ GPS gestoppt');
            }
            
            // Stoppe auch Fallback-Intervall
            if (window.gpsIntervalId) {
                clearInterval(window.gpsIntervalId);
                window.gpsIntervalId = null;
                console.log('ğŸ›‘ GPS Fallback-Intervall gestoppt');
            }
            
            if (isFirebaseReady && currentVehicle) {
                db.ref('drivers/' + currentVehicle).remove();
                console.log('ğŸ—‘ï¸ GPS aus drivers/ entfernt');
            }
        }

        // ğŸ¯ ALIAS-FUNKTIONEN fÃ¼r bessere Lesbarkeit
        function startGPSTracking() {
            startDriverTracking();
        }
        
        function stopGPSTracking() {
            stopDriverTracking();
        }

        async function acceptRide(rideId) {
            if (!currentVehicle) {
                alert('âŒ Bitte Fahrzeug wÃ¤hlen!');
                return;
            }
            
            // âœ… SCHLIESSE FULLSCREEN wenn offen
            closeNewRideFullscreen();
            stopRepeatingVibration();
            
            const ride = rides.find(r => r.firebaseId === rideId);
            if (!ride) {
                alert('âŒ Fahrt nicht gefunden!');
                return;
            }
            
            // âœ… CHECK: Wurde Fahrt storniert?
            if (ride.status === 'storniert' || ride.cancelledBy || ride.cancelledAt) {
                alert('ğŸš¨ STORNIERT!\n\n' +
                      'Diese Fahrt wurde bereits storniert.\n\n' +
                      (ride.cancellationReason ? `Grund: ${ride.cancellationReason}\n\n` : '') +
                      'Du kannst diese Fahrt nicht mehr annehmen.');
                closeNewRideFullscreen();
                return;
            }
            
            // Zeitwarnung
            if (ride.pickupTimestamp && ride.pickupTimestamp > Date.now()) {
                const minutesUntilPickup = Math.round((ride.pickupTimestamp - Date.now()) / 60000);
                const pickupTimeStr = ride.pickupTime || 'spÃ¤ter';
                
                const confirm = window.confirm(
                    `âš ï¸ ACHTUNG!\n\n` +
                    `Abholung erst um ${pickupTimeStr}\n` +
                    `Das ist in ${minutesUntilPickup} Minuten!\n\n` +
                    `Trotzdem jetzt annehmen und losfahren?`
                );
                
                if (!confirm) return;
            }
            
            // Auto-Online wenn offline
            if (!isOnline) {
                document.getElementById('online-toggle').checked = true;
                toggleOnline();
            }
            
            const vehicleName = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle;
            const vehiclePlate = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].plate : '';
            
            console.log('ğŸ“ Akzeptiere Fahrt:', rideId);
            
            // ğŸ›‘ Stoppe Assignment-Timer
            if (assignmentTimers[rideId]) {
                clearTimeout(assignmentTimers[rideId]);
                delete assignmentTimers[rideId];
                console.log('â° Assignment-Timer gestoppt');
            }
            
            // Update Fahrt in Firebase
            await updateRide(rideId, { 
                status: 'accepted', 
                vehicleId: currentVehicle,
                vehicle: vehicleName,
                vehiclePlate: vehiclePlate,
                driver: vehicleName,
                acceptedAt: Date.now(),
                assignedTo: null, // ZurÃ¼cksetzen
                assignmentExpiresAt: null
            });
            
            // GPS komplett neu starten mit rideId
            if (watchId) {
                console.log('ğŸ›‘ Stoppe altes GPS');
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            setTimeout(() => {
                startDriverTracking(rideId);
                initDriverMap(rideId);  // Ãœbergebe rideId - wird aus Firebase geladen
            }, 100);
            
            alert('âœ… Auftrag angenommen! GPS lÃ¤uft...');
        }

        async function pickupCustomer(rideId) {
            await updateRide(rideId, { 
                status: 'picked_up',
                pickedUpAt: Date.now() 
            });
            
            // Lade ride NEU aus Firebase und update Display
            const snapshot = await db.ref('rides/' + rideId).once('value');
            const ride = snapshot.val();
            if (ride) {
                ride.firebaseId = rideId;
                updateDriverInfoTop(ride);
            }
            
            alert('âœ… Kunde eingestiegen! Navigation zum Ziel lÃ¤uft.');
        }

        async function completeRide(rideId) {
            await updateRide(rideId, { 
                status: 'completed', 
                driverLocation: null,
                completedAt: Date.now()
            });
            
            // SchlieÃŸe Karte
            closeDriverMap();
            
            if (etaUpdateInterval) { 
                clearInterval(etaUpdateInterval); 
                etaUpdateInterval = null; 
            }
            
            console.log('âœ… Fahrt abgeschlossen');
            
            // WICHTIG: Erst komplett stoppen
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                console.log('ğŸ›‘ GPS gestoppt');
            }
            
            // Dann neu starten wenn noch Online
            if (isOnline && currentVehicle) {
                console.log('ğŸ”„ Starte GPS neu (ohne rideId)');
                // Kurz warten damit clearWatch durchlÃ¤uft
                setTimeout(() => {
                    startDriverTracking(null);
                }, 100);
            }
            
            alert('âœ… Fahrt abgeschlossen! Sie sind wieder verfÃ¼gbar.');
        }

        async function resetDatabase() {
            if (!confirm('âš ï¸ WIRKLICH alle Fahrten lÃ¶schen?\n\nLÃ¶scht ALLES:\n- Alle Firebase Fahrten\n- localStorage Verlauf\n- Komplett leere Datenbank')) return;
            if (!confirm('âš ï¸ LETZTE WARNUNG!\n\nDies kann nicht rÃ¼ckgÃ¤ngig gemacht werden!')) return;
            
            if (isFirebaseReady) {
                try {
                    console.log('ğŸ—‘ï¸ LÃ¶sche ALLE Fahrten...');
                    
                    // 1. Firebase komplett leeren
                    await db.ref('rides').remove();
                    console.log('âœ… Firebase rides/ gelÃ¶scht');
                    
                    // 2. Lokales Array leeren
                    rides = [];
                    
                    // 3. localStorage leeren
                    localStorage.removeItem('rideHistory');
                    localStorage.removeItem('myCurrentRideId');
                    console.log('âœ… localStorage geleert');
                    
                    // 4. Current Ride zurÃ¼cksetzen
                    myCurrentRide = null;
                    
                    alert(
                        'âœ… Datenbank komplett gelÃ¶scht!\n\n' +
                        'ğŸ”¥ Alle Fahrten entfernt\n' +
                        'ğŸ”¥ localStorage geleert\n' +
                        'ğŸ”¥ Komplett sauber!\n\n' +
                        'Seite lÃ¤dt neu...'
                    );
                    
                    // Auto-Reload nach 1 Sekunde
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                    
                } catch (error) {
                    console.error('âŒ Fehler beim LÃ¶schen:', error);
                    alert('âŒ Fehler beim LÃ¶schen: ' + error.message);
                }
            } else {
                alert('âŒ Firebase nicht bereit!');
            }
        }
        
        // ğŸ“‚ ADMIN SECTION TOGGLE
        function toggleAdminSection(section) {
            const content = document.getElementById(section + '-content');
            const toggle = document.getElementById(section + '-toggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = 'â–²';
            } else {
                content.style.display = 'none';
                toggle.textContent = 'â–¼';
            }
        }
        
        // ğŸ‘¥ BENUTZER-VERWALTUNG
        let allUsers = [];
        
        async function loadAllUsers() {
            if (!isFirebaseReady) {
                alert('âŒ Firebase nicht verbunden!');
                return;
            }
            
            try {
                const snapshot = await db.ref('users').once('value');
                allUsers = [];
                snapshot.forEach(child => {
                    const user = child.val();
                    user.uid = child.key;
                    allUsers.push(user);
                });
                
                console.log('ğŸ‘¥ Benutzer geladen:', allUsers.length);
                renderUsersList(allUsers);
            } catch (error) {
                console.error('âŒ Fehler beim Laden der Benutzer:', error);
                alert('âŒ Fehler beim Laden der Benutzer');
            }
        }
        
        function searchUsers() {
            const query = document.getElementById('user-search').value.toLowerCase();
            const filtered = allUsers.filter(u => 
                (u.email && u.email.toLowerCase().includes(query)) ||
                (u.displayName && u.displayName.toLowerCase().includes(query))
            );
            renderUsersList(filtered);
        }
        
        // ğŸš— Fahrzeug-Liste
        const vehicles = ['Tesla #1', 'Tesla #2', 'Tesla #3', 'Tesla #4', 'Tesla #5'];
        
        // â• NEUER MITARBEITER
        function showAddUserModal() {
            const modal = document.createElement('div');
            modal.id = 'add-user-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;width:90%;max-width:400px;">
                    <h3 style="margin:0 0 15px 0;">â• Neuer Mitarbeiter</h3>
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        <div>
                            <label style="font-size:12px;color:#666;">Name *</label>
                            <input type="text" id="new-user-name" placeholder="Max Mustermann" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                        </div>
                        <div>
                            <label style="font-size:12px;color:#666;">Email *</label>
                            <input type="email" id="new-user-email" placeholder="fahrer@gmail.com" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                        </div>
                        <div>
                            <label style="font-size:12px;color:#666;">Telefon</label>
                            <input type="text" id="new-user-phone" placeholder="0173 1234567" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                        </div>
                        <div>
                            <label style="font-size:12px;color:#666;">Rolle *</label>
                            <select id="new-user-role" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                                <option value="fahrgast">Fahrgast</option>
                                <option value="fahrer" selected>Fahrer</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size:12px;color:#666;">Fahrzeug (fÃ¼r Fahrer)</label>
                            <select id="new-user-vehicle" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                                <option value="">-- Kein Fahrzeug --</option>
                                ${vehicles.map(v => `<option value="${v}">${v}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div style="background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;padding:10px;margin-top:15px;font-size:12px;">
                        âš ï¸ Der Mitarbeiter muss sich spÃ¤ter selbst mit dieser Email registrieren. Die Rolle wird automatisch zugewiesen.
                    </div>
                    <div style="display:flex;gap:10px;margin-top:15px;">
                        <button onclick="saveNewUser()" style="flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">ğŸ’¾ Speichern</button>
                        <button onclick="closeAddUserModal()" style="flex:1;padding:12px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Abbrechen</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeAddUserModal() {
            const modal = document.getElementById('add-user-modal');
            if (modal) modal.remove();
        }
        
        async function saveNewUser() {
            const name = document.getElementById('new-user-name').value.trim();
            const email = document.getElementById('new-user-email').value.trim();
            const role = document.getElementById('new-user-role').value;
            
            if (!name || !email) {
                alert('âŒ Name und Email sind erforderlich!');
                return;
            }
            
            // Erstelle vorab einen Eintrag - wird mit echtem UID verknÃ¼pft wenn User sich registriert
            const userData = {
                displayName: name,
                email: email,
                phone: document.getElementById('new-user-phone').value.trim(),
                role: role,
                vehicle: document.getElementById('new-user-vehicle').value,
                preRegistered: true,
                createdAt: Date.now()
            };
            
            try {
                // Speichere unter Email als Key (wird spÃ¤ter mit UID verknÃ¼pft)
                const emailKey = email.replace(/\./g, '_').replace(/@/g, '_at_');
                await db.ref('preRegisteredUsers/' + emailKey).set(userData);
                console.log('âœ… Mitarbeiter vorregistriert:', email);
                closeAddUserModal();
                alert('âœ… Mitarbeiter "' + name + '" wurde angelegt!\n\nDer Mitarbeiter kann sich jetzt mit ' + email + ' registrieren und bekommt automatisch die Rolle "' + role + '".');
            } catch (error) {
                console.error('âŒ Fehler:', error);
                alert('âŒ Fehler beim Speichern');
            }
        }
        
        function renderUsersList(users) {
            const container = document.getElementById('users-list');
            
            if (users.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">Keine Benutzer gefunden</div>';
                return;
            }
            
            container.innerHTML = users.map(user => {
                const roleOptions = ['fahrgast', 'fahrer', 'admin'];
                const currentRole = user.role || 'fahrgast';
                
                return `
                    <div style="background:white;border:1px solid #e0e0e0;border-radius:8px;padding:12px;margin-bottom:10px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div style="flex:1;">
                                <div style="font-weight:600;">${user.displayName || 'Unbekannt'}</div>
                                <div style="font-size:12px;color:#666;">${user.email}</div>
                                ${user.phone ? `<div style="font-size:11px;color:#888;">ğŸ“ ${user.phone}</div>` : ''}
                                ${user.vehicle ? `<div style="font-size:11px;color:#10b981;">ğŸš— ${user.vehicle}</div>` : ''}
                                <div style="font-size:10px;color:#999;">Letzter Login: ${user.lastLogin ? new Date(user.lastLogin).toLocaleString('de-DE') : 'Nie'}</div>
                            </div>
                            <div style="display:flex;flex-direction:column;gap:5px;align-items:flex-end;">
                                <select onchange="changeUserRole('${user.uid}', this.value)" style="padding:6px;border:2px solid #e0e0e0;border-radius:6px;font-size:12px;">
                                    ${roleOptions.map(role => `<option value="${role}" ${currentRole === role ? 'selected' : ''}>${role.charAt(0).toUpperCase() + role.slice(1)}</option>`).join('')}
                                </select>
                                <button onclick="editUser('${user.uid}')" style="padding:6px 10px;background:#3b82f6;color:white;border:none;border-radius:6px;font-size:11px;cursor:pointer;">
                                    âœï¸ Bearbeiten
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function editUser(uid) {
            const user = allUsers.find(u => u.uid === uid);
            if (!user) return;
            
            const currentVehicle = user.vehicle || '';
            
            const modal = document.createElement('div');
            modal.id = 'edit-user-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;width:90%;max-width:400px;">
                    <h3 style="margin:0 0 15px 0;">âœï¸ Mitarbeiter bearbeiten</h3>
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        <div>
                            <label style="font-size:12px;color:#666;">Name</label>
                            <input type="text" id="edit-user-name" value="${user.displayName || ''}" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                        </div>
                        <div>
                            <label style="font-size:12px;color:#666;">Email (nicht Ã¤nderbar)</label>
                            <input type="text" value="${user.email}" disabled style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;background:#f3f4f6;">
                        </div>
                        <div>
                            <label style="font-size:12px;color:#666;">Telefon</label>
                            <input type="text" id="edit-user-phone" value="${user.phone || ''}" placeholder="0173 1234567" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                        </div>
                        <div>
                            <label style="font-size:12px;color:#666;">Fahrzeug (fÃ¼r Fahrer)</label>
                            <select id="edit-user-vehicle" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                                <option value="">-- Kein Fahrzeug --</option>
                                ${vehicles.map(v => `<option value="${v}" ${currentVehicle === v ? 'selected' : ''}>${v}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div style="display:flex;gap:10px;margin-top:15px;">
                        <button onclick="saveUser('${uid}')" style="flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">ğŸ’¾ Speichern</button>
                        <button onclick="closeEditUserModal()" style="flex:1;padding:12px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Abbrechen</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeEditUserModal() {
            const modal = document.getElementById('edit-user-modal');
            if (modal) modal.remove();
        }
        
        async function saveUser(uid) {
            const updates = {
                displayName: document.getElementById('edit-user-name').value.trim(),
                phone: document.getElementById('edit-user-phone').value.trim(),
                vehicle: document.getElementById('edit-user-vehicle').value
            };
            
            try {
                await db.ref('users/' + uid).update(updates);
                console.log('âœ… Benutzer aktualisiert');
                closeEditUserModal();
                loadAllUsers();
                alert('âœ… Benutzer aktualisiert!');
            } catch (error) {
                console.error('âŒ Fehler:', error);
                alert('âŒ Fehler beim Speichern');
            }
        }
        
        async function changeUserRole(uid, newRole) {
            if (!isFirebaseReady) return;
            
            try {
                await db.ref('users/' + uid).update({ role: newRole });
                console.log('âœ… Rolle geÃ¤ndert:', uid, 'â†’', newRole);
                
                // Update lokale Liste
                const user = allUsers.find(u => u.uid === uid);
                if (user) user.role = newRole;
                
                alert('âœ… Rolle geÃ¤ndert zu: ' + newRole);
            } catch (error) {
                console.error('âŒ Fehler beim Ã„ndern der Rolle:', error);
                alert('âŒ Fehler beim Ã„ndern der Rolle');
            }
        }
        
        // ğŸ“‹ STAMMKUNDEN-CRM FUNKTIONEN
        let allCustomers = [];
        
        async function loadAllCustomers() {
            if (!isFirebaseReady) {
                alert('âŒ Firebase nicht verbunden!');
                return;
            }
            
            try {
                const snapshot = await db.ref('customers').once('value');
                allCustomers = [];
                snapshot.forEach(child => {
                    const customer = child.val();
                    customer.id = child.key;
                    allCustomers.push(customer);
                });
                
                // Sortiere nach letzter Fahrt (neueste zuerst)
                allCustomers.sort((a, b) => (b.lastRide || 0) - (a.lastRide || 0));
                
                console.log('ğŸ“‹ Kunden geladen:', allCustomers.length);
                renderCustomersList(allCustomers);
            } catch (error) {
                console.error('âŒ Fehler beim Laden der Kunden:', error);
                alert('âŒ Fehler beim Laden der Kunden');
            }
        }
        
        function searchCustomers() {
            const query = document.getElementById('customer-search').value.toLowerCase();
            const filtered = allCustomers.filter(c => 
                (c.name && c.name.toLowerCase().includes(query)) ||
                (c.email && c.email.toLowerCase().includes(query)) ||
                (c.phone && c.phone.includes(query)) ||
                (c.address && c.address.toLowerCase().includes(query))
            );
            renderCustomersList(filtered);
        }
        
        function renderCustomersList(customers) {
            const container = document.getElementById('customers-list');
            
            if (customers.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">Keine Kunden gefunden</div>';
                return;
            }
            
            container.innerHTML = customers.map(c => {
                const lastRideDate = c.lastRide ? new Date(c.lastRide).toLocaleDateString('de-DE') : 'Nie';
                return `
                    <div style="background:white;border:1px solid #e0e0e0;border-radius:8px;padding:12px;margin-bottom:10px;">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                            <div style="flex:1;">
                                <div style="font-weight:600;font-size:15px;">${c.name || 'Unbekannt'}</div>
                                ${c.phone ? `<div style="font-size:13px;color:#666;">ğŸ“ ${c.phone}</div>` : ''}
                                ${c.email ? `<div style="font-size:12px;color:#888;">ğŸ“§ ${c.email}</div>` : ''}
                                ${c.address ? `<div style="font-size:12px;color:#888;">ğŸ“ ${c.address}</div>` : ''}
                                <div style="font-size:11px;color:#999;margin-top:4px;">
                                    ğŸš• ${c.totalRides || 0} Fahrten Â· ğŸ’° ${(c.totalRevenue || 0).toFixed(2)}â‚¬ Â· ğŸ“… ${lastRideDate}
                                </div>
                            </div>
                            <div style="display:flex;flex-direction:column;gap:5px;">
                                <button onclick="bookForCustomer('${c.id}')" style="padding:8px 12px;background:#10b981;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;">
                                    ğŸš• Buchen
                                </button>
                                <button onclick="editCustomer('${c.id}')" style="padding:8px 12px;background:#3b82f6;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;">
                                    âœï¸ Bearbeiten
                                </button>
                            </div>
                        </div>
                        ${c.notes ? `<div style="font-size:11px;color:#666;margin-top:8px;padding:8px;background:#f9fafb;border-radius:4px;">ğŸ“ ${c.notes}</div>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // ğŸ—‘ï¸ Alle Kunden lÃ¶schen (fÃ¼r Neu-Import)
        async function deleteAllCustomers() {
            if (!isFirebaseReady) {
                alert('âŒ Firebase nicht verbunden!');
                return;
            }
            
            // Sicherheitsabfrage
            const confirm1 = confirm('âš ï¸ ACHTUNG!\n\nAlle Kunden im CRM werden gelÃ¶scht!\n\nDies kann nicht rÃ¼ckgÃ¤ngig gemacht werden.\n\nFortfahren?');
            if (!confirm1) return;
            
            const confirm2 = confirm('ğŸ”´ LETZTE WARNUNG!\n\nAlle ' + (document.querySelectorAll('#crm-list > div').length || 'X') + ' Kunden werden UNWIDERRUFLICH gelÃ¶scht!\n\nTippe OK um zu lÃ¶schen.');
            if (!confirm2) return;
            
            try {
                await db.ref('customers').remove();
                alert('âœ… Alle Kunden wurden gelÃ¶scht!\n\nDu kannst jetzt die CSV neu importieren.');
                
                // Liste leeren
                document.getElementById('crm-list').innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Keine Kunden vorhanden</div>';
            } catch (error) {
                console.error('âŒ Fehler beim LÃ¶schen:', error);
                alert('âŒ Fehler: ' + error.message);
            }
        }
        
        function showAddCustomerModal() {
            const modal = document.createElement('div');
            modal.id = 'add-customer-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;width:90%;max-width:400px;max-height:90vh;overflow-y:auto;">
                    <h3 style="margin:0 0 15px 0;">â• Neuer Kunde</h3>
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        <input type="text" id="new-customer-name" placeholder="Name *" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;">
                        <input type="text" id="new-customer-phone" placeholder="Telefon" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;">
                        <input type="email" id="new-customer-email" placeholder="Email" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;">
                        <div style="position:relative;">
                            <input type="text" id="new-customer-address" placeholder="ğŸ  Wohnanschrift" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;width:100%;">
                            <div id="new-customer-address-dropdown" style="position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #e0e0e0;border-radius:8px;max-height:200px;overflow-y:auto;display:none;z-index:10000;box-shadow:0 4px 6px rgba(0,0,0,0.1);"></div>
                        </div>
                        <textarea id="new-customer-notes" placeholder="Notizen (z.B. Kindersitz, Rollstuhl)" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;min-height:60px;"></textarea>
                    </div>
                    <div style="display:flex;gap:10px;margin-top:15px;">
                        <button onclick="saveNewCustomer()" style="flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">ğŸ’¾ Speichern</button>
                        <button onclick="closeAddCustomerModal()" style="flex:1;padding:12px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Abbrechen</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Autocomplete aktivieren nach Modal erscheint
            setTimeout(() => {
                setupCustomerAddressAutocomplete('new-customer-address', 'new-customer-address-dropdown');
            }, 100);
        }
        
        // ğŸ  Autocomplete fÃ¼r Kunden-Wohnanschrift - nutzt GLEICHE Funktion wie Abholort/Zielort
        let customerAddressTimeout = null;
        
        function setupCustomerAddressAutocomplete(inputId, suggestionsId) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(suggestionsId);
            if (!input || !dropdown) return;
            
            input.addEventListener('input', (e) => {
                clearTimeout(customerAddressTimeout);
                const value = e.target.value.trim();
                
                if (value.length < 3) {
                    dropdown.style.display = 'none';
                    return;
                }
                
                // Zeige "LÃ¤dt..." sofort
                dropdown.innerHTML = '<div style="padding:10px;color:#999;font-size:13px;">Suche...</div>';
                dropdown.style.display = 'block';
                
                // VerzÃ¶gerte Suche (Debounce)
                customerAddressTimeout = setTimeout(() => {
                    searchCustomerAddresses(value, inputId, suggestionsId);
                }, 300);
            });
            
            // SchlieÃŸe Dropdown wenn auÃŸerhalb geklickt
            document.addEventListener('click', (e) => {
                if (e.target !== input && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }
        
        async function searchCustomerAddresses(query, inputId, suggestionsId) {
            const dropdown = document.getElementById(suggestionsId);
            
            try {
                // GLEICHE Suche wie bei Abholort/Zielort!
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?` +
                    `format=json&` +
                    `q=${encodeURIComponent(query)}&` +
                    `countrycodes=de&` +
                    `limit=8&` +
                    `addressdetails=1`
                );
                
                const results = await response.json();
                
                if (results.length === 0) {
                    dropdown.innerHTML = '<div style="padding:10px;color:#999;font-size:13px;">Keine Ergebnisse gefunden</div>';
                    return;
                }
                
                // Filtere Usedom-relevante Ergebnisse (wie bei Abholort)
                const usedomResults = results.filter(r => {
                    const display = r.display_name.toLowerCase();
                    return display.includes('usedom') || 
                           display.includes('heringsdorf') || 
                           display.includes('ahlbeck') ||
                           display.includes('bansin') ||
                           display.includes('zinnowitz') ||
                           display.includes('karlshagen') ||
                           display.includes('peenemÃ¼nde') ||
                           display.includes('koserow') ||
                           display.includes('Ã¼ckeritz') ||
                           display.includes('loddin') ||
                           display.includes('zempin') ||
                           display.includes('trassenheide');
                });
                
                const resultsToShow = usedomResults.length > 0 ? usedomResults : results;
                
                dropdown.innerHTML = resultsToShow.map(r => {
                    const address = r.address;
                    let displayText = '';
                    
                    // StraÃŸe + Hausnummer
                    if (address.road) {
                        displayText = address.road;
                        if (address.house_number) displayText += ' ' + address.house_number;
                    }
                    
                    // PLZ + Ort
                    let location = '';
                    if (address.postcode) location = address.postcode + ' ';
                    location += address.village || address.town || address.city || address.municipality || '';
                    
                    if (location && displayText) {
                        displayText += ', ' + location.trim();
                    } else if (location) {
                        displayText = location.trim();
                    } else if (r.display_name) {
                        displayText = r.display_name.split(',').slice(0, 3).join(',');
                    }
                    
                    return `
                        <div onclick="document.getElementById('${inputId}').value='${displayText.replace(/'/g, "\\'")}'; document.getElementById('${suggestionsId}').style.display='none';" 
                             style="padding:10px;cursor:pointer;border-bottom:1px solid #eee;font-size:13px;"
                             onmouseover="this.style.background='#f3f4f6'" 
                             onmouseout="this.style.background='white'">
                            ğŸ“ ${displayText}
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Autocomplete Fehler:', error);
                dropdown.innerHTML = '<div style="padding:10px;color:#ef4444;font-size:13px;">Fehler bei der Suche</div>';
            }
        }
        
        function closeAddCustomerModal() {
            const modal = document.getElementById('add-customer-modal');
            if (modal) modal.remove();
        }
        
        // ğŸ“¥ Google Kontakte CSV Import
        async function importGoogleCSV(input) {
            const file = input.files[0];
            if (!file) return;
            
            if (!isFirebaseReady) {
                alert('âŒ Firebase nicht verbunden!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const csv = e.target.result;
                    
                    // NEUER CSV-Parser der mehrzeilige Felder unterstÃ¼tzt
                    const rows = parseCSVMultiline(csv);
                    
                    if (rows.length < 2) {
                        alert('âŒ CSV-Datei ist leer!');
                        return;
                    }
                    
                    // Header parsen (erste Zeile)
                    const headers = rows[0];
                    console.log('ğŸ“¥ CSV Headers:', headers);
                    
                    // Finde relevante Spalten (Google CSV Format)
                    const firstNameIdx = headers.findIndex(h => h === 'First Name');
                    const lastNameIdx = headers.findIndex(h => h === 'Last Name');
                    const orgNameIdx = headers.findIndex(h => h === 'Organization Name');
                    const phone1Idx = headers.findIndex(h => h === 'Phone 1 - Value');
                    const phone2Idx = headers.findIndex(h => h === 'Phone 2 - Value');
                    const phone3Idx = headers.findIndex(h => h === 'Phone 3 - Value');
                    const email1Idx = headers.findIndex(h => h === 'E-mail 1 - Value');
                    const addressIdx = headers.findIndex(h => h === 'Address 1 - Formatted');
                    const streetIdx = headers.findIndex(h => h === 'Address 1 - Street');
                    const cityIdx = headers.findIndex(h => h === 'Address 1 - City');
                    const postalIdx = headers.findIndex(h => h === 'Address 1 - Postal Code');
                    
                    console.log('ğŸ“¥ Spalten: FirstName=' + firstNameIdx + ', LastName=' + lastNameIdx + ', Org=' + orgNameIdx + ', Phone1=' + phone1Idx + ', Phone2=' + phone2Idx + ', Phone3=' + phone3Idx);
                    
                    let imported = 0;
                    let skipped = 0;
                    
                    // Lade existierende Kunden einmal
                    const existingSnapshot = await db.ref('customers').once('value');
                    const existingCustomers = [];
                    existingSnapshot.forEach(child => {
                        existingCustomers.push(child.val());
                    });
                    
                    // Daten parsen (ab Zeile 2)
                    for (let i = 1; i < rows.length; i++) {
                        const values = rows[i];
                        if (!values || values.length === 0) continue;
                        
                        // Name zusammenbauen
                        let name = '';
                        const firstName = firstNameIdx >= 0 ? (values[firstNameIdx] || '').trim() : '';
                        const lastName = lastNameIdx >= 0 ? (values[lastNameIdx] || '').trim() : '';
                        const orgName = orgNameIdx >= 0 ? (values[orgNameIdx] || '').trim() : '';
                        
                        // PrioritÃ¤t: Vorname+Nachname, dann Organisation
                        if (firstName || lastName) {
                            name = (firstName + ' ' + lastName).trim();
                        } else if (orgName) {
                            name = orgName;
                        }
                        
                        // Telefon (ALLE gefundenen sammeln)
                        let phones = [];
                        if (phone1Idx >= 0 && values[phone1Idx]) {
                            const p = values[phone1Idx].trim().replace(/[^\d+\s-]/g, '').trim();
                            if (p) phones.push(p);
                        }
                        if (phone2Idx >= 0 && values[phone2Idx]) {
                            const p = values[phone2Idx].trim().replace(/[^\d+\s-]/g, '').trim();
                            if (p) phones.push(p);
                        }
                        if (phone3Idx >= 0 && values[phone3Idx]) {
                            const p = values[phone3Idx].trim().replace(/[^\d+\s-]/g, '').trim();
                            if (p) phones.push(p);
                        }
                        const phone = phones.join(' / ');
                        
                        // Debug: Zeige gefundene Telefonnummern
                        if (phones.length > 1) {
                            console.log('ğŸ“± Mehrere Nummern fÃ¼r ' + name + ':', phones);
                        }
                        
                        // Email
                        const email = email1Idx >= 0 ? (values[email1Idx] || '').trim() : '';
                        
                        // Adresse zusammenbauen
                        let address = '';
                        if (addressIdx >= 0) {
                            address = (values[addressIdx] || '').trim().replace(/\n/g, ', ');
                        }
                        if (!address && streetIdx >= 0) {
                            const street = (values[streetIdx] || '').trim();
                            const city = cityIdx >= 0 ? (values[cityIdx] || '').trim() : '';
                            const postal = postalIdx >= 0 ? (values[postalIdx] || '').trim() : '';
                            if (street) {
                                address = street;
                                if (postal || city) address += ', ' + (postal + ' ' + city).trim();
                            }
                        }
                        
                        // Nur importieren wenn Name vorhanden
                        if (!name) {
                            skipped++;
                            continue;
                        }
                        
                        // PrÃ¼fe ob Kunde schon existiert (per Telefon, Email oder Name)
                        let exists = false;
                        for (const c of existingCustomers) {
                            // PrÃ¼fe jede importierte Nummer gegen existierende
                            if (phones.length > 0 && c.phone) {
                                const existingPhones = c.phone.replace(/\D/g, '');
                                for (const p of phones) {
                                    if (p.replace(/\D/g, '') && existingPhones.includes(p.replace(/\D/g, ''))) {
                                        exists = true;
                                        break;
                                    }
                                }
                            }
                            if (exists) break;
                            if (email && c.email && c.email.toLowerCase() === email.toLowerCase()) {
                                exists = true;
                                break;
                            }
                        }
                        
                        if (exists) {
                            skipped++;
                            continue;
                        }
                        
                        // Neuen Kunden anlegen
                        const newCustomer = {
                            name: name,
                            phone: phone,
                            email: email,
                            address: address,
                            notes: 'Importiert aus Google Kontakte',
                            totalRides: 0,
                            totalRevenue: 0,
                            lastRide: null,
                            createdAt: Date.now(),
                            importedFrom: 'google_csv'
                        };
                        
                        await db.ref('customers').push(newCustomer);
                        existingCustomers.push(newCustomer); // FÃ¼r Duplikat-Check
                        imported++;
                    }
                    
                    // Ergebnis anzeigen
                    alert(
                        'ğŸ“¥ Import abgeschlossen!\n\n' +
                        'âœ… Importiert: ' + imported + ' Kontakte\n' +
                        'â­ï¸ Ãœbersprungen: ' + skipped + ' (bereits vorhanden oder ohne Name)\n\n' +
                        'Klicke "ğŸ”„ Kunden laden" um die Liste zu aktualisieren.'
                    );
                    
                    // Input zurÃ¼cksetzen
                    input.value = '';
                    
                } catch (error) {
                    console.error('âŒ Import Fehler:', error);
                    alert('âŒ Fehler beim Import: ' + error.message);
                }
            };
            
            reader.readAsText(file, 'UTF-8');
        }
        
        // CSV Zeile parsen (berÃ¼cksichtigt AnfÃ¼hrungszeichen)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            
            return result;
        }
        
        // NEUER CSV-Parser fÃ¼r mehrzeilige Felder (z.B. Adressen mit ZeilenumbrÃ¼chen)
        function parseCSVMultiline(csv) {
            const rows = [];
            let currentRow = [];
            let currentField = '';
            let inQuotes = false;
            
            for (let i = 0; i < csv.length; i++) {
                const char = csv[i];
                const nextChar = csv[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // Escaped quote ("") -> single quote
                        currentField += '"';
                        i++; // Skip next quote
                    } else {
                        // Toggle quote mode
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // End of field
                    currentRow.push(currentField.trim());
                    currentField = '';
                } else if ((char === '\n' || (char === '\r' && nextChar === '\n')) && !inQuotes) {
                    // End of row (nur wenn nicht in AnfÃ¼hrungszeichen!)
                    if (char === '\r') i++; // Skip \n after \r
                    currentRow.push(currentField.trim());
                    if (currentRow.some(f => f !== '')) { // Nur nicht-leere Zeilen
                        rows.push(currentRow);
                    }
                    currentRow = [];
                    currentField = '';
                } else if (char === '\r' && !inQuotes) {
                    // Standalone \r = end of row
                    currentRow.push(currentField.trim());
                    if (currentRow.some(f => f !== '')) {
                        rows.push(currentRow);
                    }
                    currentRow = [];
                    currentField = '';
                } else {
                    currentField += char;
                }
            }
            
            // Letzte Zeile nicht vergessen
            if (currentField || currentRow.length > 0) {
                currentRow.push(currentField.trim());
                if (currentRow.some(f => f !== '')) {
                    rows.push(currentRow);
                }
            }
            
            console.log('ğŸ“¥ CSV geparst: ' + rows.length + ' Zeilen');
            return rows;
        }
        
        // ğŸ“‹ CRM: Kunde automatisch anlegen/aktualisieren bei Buchung
        async function updateCustomerCRM(name, phone, address, price) {
            if (!isFirebaseReady) return;
            if (!name || name.trim() === '') return;
            
            const cleanName = name.trim();
            const cleanPhone = phone ? phone.trim() : '';
            const cleanAddress = address ? address.trim() : '';
            const ridePrice = parseFloat(price) || 0;
            
            try {
                // Suche existierenden Kunden (per Telefon ODER Name)
                const snapshot = await db.ref('customers').once('value');
                let existingCustomerId = null;
                let existingCustomer = null;
                
                snapshot.forEach(child => {
                    const customer = child.val();
                    // PrioritÃ¤t 1: Telefonnummer stimmt Ã¼berein (wenn vorhanden)
                    if (cleanPhone && customer.phone && customer.phone === cleanPhone) {
                        existingCustomerId = child.key;
                        existingCustomer = customer;
                    }
                    // PrioritÃ¤t 2: Name stimmt Ã¼berein (wenn keine Telefonnummer)
                    if (!existingCustomerId && customer.name && customer.name.toLowerCase() === cleanName.toLowerCase()) {
                        existingCustomerId = child.key;
                        existingCustomer = customer;
                    }
                });
                
                if (existingCustomerId) {
                    // âœ… Kunde existiert â†’ Update
                    const updates = {
                        totalRides: (existingCustomer.totalRides || 0) + 1,
                        totalRevenue: (existingCustomer.totalRevenue || 0) + ridePrice,
                        lastRide: Date.now()
                    };
                    
                    // Update Adresse nur wenn leer
                    if (!existingCustomer.address && cleanAddress) {
                        updates.address = cleanAddress;
                    }
                    // Update Telefon nur wenn leer
                    if (!existingCustomer.phone && cleanPhone) {
                        updates.phone = cleanPhone;
                    }
                    
                    await db.ref('customers/' + existingCustomerId).update(updates);
                    console.log('ğŸ“‹ CRM: Kunde aktualisiert:', cleanName, 'â†’', updates.totalRides, 'Fahrten');
                    
                } else {
                    // ğŸ†• Neuer Kunde â†’ Anlegen
                    const newCustomer = {
                        name: cleanName,
                        phone: cleanPhone,
                        email: '',
                        address: cleanAddress,
                        notes: '',
                        totalRides: 1,
                        totalRevenue: ridePrice,
                        lastRide: Date.now(),
                        createdAt: Date.now(),
                        autoCreated: true // Markiert als automatisch erstellt
                    };
                    
                    await db.ref('customers').push(newCustomer);
                    console.log('ğŸ“‹ CRM: Neuer Kunde angelegt:', cleanName);
                }
                
            } catch (error) {
                console.error('ğŸ“‹ CRM Fehler:', error);
                // Fehler nicht an User zeigen - Buchung soll trotzdem funktionieren
            }
        }
        
        async function saveNewCustomer() {
            const name = document.getElementById('new-customer-name').value.trim();
            if (!name) {
                alert('âŒ Name ist erforderlich!');
                return;
            }
            
            const customer = {
                name: name,
                phone: document.getElementById('new-customer-phone').value.trim(),
                email: document.getElementById('new-customer-email').value.trim(),
                address: document.getElementById('new-customer-address').value.trim(),
                notes: document.getElementById('new-customer-notes').value.trim(),
                totalRides: 0,
                totalRevenue: 0,
                createdAt: Date.now()
            };
            
            try {
                await db.ref('customers').push(customer);
                console.log('âœ… Kunde gespeichert:', customer.name);
                closeAddCustomerModal();
                loadAllCustomers();
                alert('âœ… Kunde "' + name + '" wurde angelegt!');
            } catch (error) {
                console.error('âŒ Fehler beim Speichern:', error);
                alert('âŒ Fehler beim Speichern');
            }
        }
        
        function bookForCustomer(customerId) {
            const customer = allCustomers.find(c => c.id === customerId);
            if (!customer) return;
            
            // Speichere Kunden-ID fÃ¼r spÃ¤tere CRM-Aktualisierung
            currentBookingCustomerId = customerId;
            
            // Wechsel zum Fahrgast-Tab und fÃ¼lle Daten aus
            switchView('passenger');
            
            if (customer.name) document.getElementById('customer-name').value = customer.name;
            if (customer.phone) document.getElementById('customer-phone').value = customer.phone;
            if (customer.address) document.getElementById('pickup').value = customer.address;
            
            // Zeige CRM-Speicher-Option
            const crmOption = document.getElementById('crm-save-option');
            if (crmOption) {
                crmOption.style.display = 'block';
                document.getElementById('save-to-crm').checked = true;
            }
            
            alert('âœ… Daten von "' + customer.name + '" wurden eingefÃ¼llt!\n\nBitte Ziel eingeben und Preis berechnen.');
        }
        
        function editCustomer(customerId) {
            const customer = allCustomers.find(c => c.id === customerId);
            if (!customer) return;
            
            const modal = document.createElement('div');
            modal.id = 'edit-customer-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;width:90%;max-width:400px;max-height:90vh;overflow-y:auto;">
                    <h3 style="margin:0 0 15px 0;">âœï¸ Kunde bearbeiten</h3>
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        <input type="text" id="edit-customer-name" value="${customer.name || ''}" placeholder="Name *" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;">
                        <input type="text" id="edit-customer-phone" value="${customer.phone || ''}" placeholder="Telefon" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;">
                        <input type="email" id="edit-customer-email" value="${customer.email || ''}" placeholder="Email" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;">
                        <div style="position:relative;">
                            <input type="text" id="edit-customer-address" value="${customer.address || ''}" placeholder="ğŸ  Wohnanschrift" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;width:100%;">
                            <div id="edit-customer-address-dropdown" style="position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #e0e0e0;border-radius:8px;max-height:200px;overflow-y:auto;display:none;z-index:10000;box-shadow:0 4px 6px rgba(0,0,0,0.1);"></div>
                        </div>
                        <textarea id="edit-customer-notes" placeholder="Notizen" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;min-height:60px;">${customer.notes || ''}</textarea>
                    </div>
                    <div style="font-size:12px;color:#666;margin-top:10px;padding:10px;background:#f9fafb;border-radius:6px;">
                        ğŸš• ${customer.totalRides || 0} Fahrten Â· ğŸ’° ${(customer.totalRevenue || 0).toFixed(2)}â‚¬
                    </div>
                    <div style="display:flex;gap:10px;margin-top:15px;">
                        <button onclick="updateCustomer('${customerId}')" style="flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">ğŸ’¾ Speichern</button>
                        <button onclick="closeEditCustomerModal()" style="flex:1;padding:12px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Abbrechen</button>
                    </div>
                    <button onclick="deleteCustomer('${customerId}')" style="width:100%;margin-top:10px;padding:12px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">ğŸ—‘ï¸ Kunde lÃ¶schen</button>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Autocomplete aktivieren nach Modal erscheint
            setTimeout(() => {
                setupCustomerAddressAutocomplete('edit-customer-address', 'edit-customer-address-dropdown');
            }, 100);
        }
        
        function closeEditCustomerModal() {
            const modal = document.getElementById('edit-customer-modal');
            if (modal) modal.remove();
        }
        
        async function updateCustomer(customerId) {
            const name = document.getElementById('edit-customer-name').value.trim();
            if (!name) {
                alert('âŒ Name ist erforderlich!');
                return;
            }
            
            const updates = {
                name: name,
                phone: document.getElementById('edit-customer-phone').value.trim(),
                email: document.getElementById('edit-customer-email').value.trim(),
                address: document.getElementById('edit-customer-address').value.trim(),
                notes: document.getElementById('edit-customer-notes').value.trim()
            };
            
            try {
                await db.ref('customers/' + customerId).update(updates);
                console.log('âœ… Kunde aktualisiert:', name);
                closeEditCustomerModal();
                loadAllCustomers();
                alert('âœ… Kunde aktualisiert!');
            } catch (error) {
                console.error('âŒ Fehler beim Aktualisieren:', error);
                alert('âŒ Fehler beim Aktualisieren');
            }
        }
        
        async function deleteCustomer(customerId) {
            if (!confirm('âš ï¸ Kunde wirklich lÃ¶schen?\n\nDiese Aktion kann nicht rÃ¼ckgÃ¤ngig gemacht werden!')) return;
            
            try {
                await db.ref('customers/' + customerId).remove();
                console.log('ğŸ—‘ï¸ Kunde gelÃ¶scht');
                closeEditCustomerModal();
                loadAllCustomers();
                alert('âœ… Kunde gelÃ¶scht!');
            } catch (error) {
                console.error('âŒ Fehler beim LÃ¶schen:', error);
                alert('âŒ Fehler beim LÃ¶schen');
            }
        }
        
        // ğŸ§¹ CACHE LEEREN FUNKTION
        async function clearAppCache() {
            if (!confirm('ğŸ§¹ Cache leeren?\n\nDies hilft bei Problemen mit alten Versionen.\nDie App wird neu geladen.')) return;
            
            try {
                // 1. Service Worker deregistrieren
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                        console.log('âœ… Service Worker deregistriert');
                    }
                }
                
                // 2. Cache Storage leeren
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    for (let name of cacheNames) {
                        await caches.delete(name);
                        console.log('âœ… Cache gelÃ¶scht:', name);
                    }
                }
                
                // 3. LocalStorage NICHT lÃ¶schen (Stammkunden-Daten behalten!)
                // localStorage.clear(); // NICHT ausfÃ¼hren!
                
                alert('âœ… Cache geleert!\n\nDie App wird jetzt neu geladen.');
                
                // 4. Hard Reload
                window.location.reload(true);
                
            } catch (error) {
                console.error('âŒ Fehler beim Cache leeren:', error);
                alert('âŒ Fehler beim Cache leeren!\n\nVersuche es manuell:\nEinstellungen â†’ Datenschutz â†’ Browserdaten lÃ¶schen');
            }
        }

        // ğŸ“‹ DEBUG LOGS EXPORTIEREN
        let consoleLogHistory = []; // Speichere alle Console-Logs
        
        // Console-Logs abfangen und speichern
        (function() {
            const originalLog = console.log;
            const originalError = console.error;
            const originalWarn = console.warn;
            
            console.log = function(...args) {
                consoleLogHistory.push({ type: 'log', time: new Date().toISOString(), message: args.join(' ') });
                originalLog.apply(console, args);
            };
            
            console.error = function(...args) {
                consoleLogHistory.push({ type: 'error', time: new Date().toISOString(), message: args.join(' ') });
                originalError.apply(console, args);
            };
            
            console.warn = function(...args) {
                consoleLogHistory.push({ type: 'warn', time: new Date().toISOString(), message: args.join(' ') });
                originalWarn.apply(console, args);
            };
        })();
        
        function exportDebugLogs() {
            try {
                // Sammle ALLE Debug-Infos
                const allRides = rides.map(r => ({
                    id: r.id,
                    status: r.status,
                    pickup: r.pickup,
                    destination: r.destination,
                    customerName: r.customerName,
                    price: r.price,
                    createdAt: r.createdAt
                }));
                
                const allDrivers = Object.keys(drivers).map(id => ({
                    id: id,
                    vehicle: drivers[id].vehicle,
                    online: drivers[id].online,
                    lat: drivers[id].lat,
                    lng: drivers[id].lng,
                    timestamp: drivers[id].timestamp
                }));
                
                const localStorageData = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    localStorageData[key] = localStorage.getItem(key);
                }
                
                const debugInfo = {
                    timestamp: new Date().toISOString(),
                    version: "4.2.1",
                    userAgent: navigator.userAgent,
                    
                    // App-Status
                    currentView: currentView,
                    isOnline: isOnline,
                    isFirebaseReady: isFirebaseReady,
                    currentUser: currentUser ? { uid: currentUser.uid, email: currentUser.email, name: currentUser.displayName } : null,
                    
                    // Daten
                    rides_count: rides.length,
                    all_rides: allRides,
                    drivers_count: Object.keys(drivers).length,
                    all_drivers: allDrivers,
                    localStorage_complete: localStorageData,
                    regularCustomer: regularCustomer,
                    
                    // GPS
                    pickupCoords: pickupCoords,
                    destCoords: destCoords,
                    watchId: watchId,
                    
                    // Wake Lock
                    wakeLock_active: wakeLock !== null,
                    
                    // Console Logs (letzte 100)
                    console_logs: consoleLogHistory.slice(-100)
                };
                
                // Formatiere als JSON fÃ¼r einfaches Kopieren
                const debugJSON = JSON.stringify(debugInfo, null, 2);
                
                // Formatiere auch als lesbaren Text
                const debugText = `
ğŸš• TAXI-APP MEGA DEBUG EXPORT
========================
Version: ${debugInfo.version}
Zeitpunkt: ${debugInfo.timestamp}

ğŸ“± GERÃ„T:
${debugInfo.userAgent}

ğŸ‘¤ USER:
- Angemeldet: ${debugInfo.currentUser ? 'Ja (' + debugInfo.currentUser.email + ')' : 'Nein'}
- Stammkunde: ${debugInfo.regularCustomer ? debugInfo.regularCustomer.name + ' (' + debugInfo.regularCustomer.rideCount + ' Fahrten)' : 'Nein'}

ğŸ“Š STATUS:
- Ansicht: ${debugInfo.currentView}
- Online: ${debugInfo.isOnline}
- Firebase: ${debugInfo.isFirebaseReady}
- Wake Lock: ${debugInfo.wakeLock_active ? 'Aktiv' : 'Inaktiv'}

ğŸ—ƒï¸ DATEN:
- Fahrten in Firebase: ${debugInfo.rides_count}
- Fahrer registriert: ${debugInfo.drivers_count}
- Fahrer online: ${allDrivers.filter(d => d.online).length}

ğŸš— ALLE FAHRER:
${allDrivers.map(d => `- ${d.vehicle} | Online: ${d.online} | GPS: ${d.lat ? 'Ja' : 'Nein'}`).join('\n') || '(keine)'}

ğŸš– LETZTE 10 FAHRTEN:
${allRides.slice(-10).map(r => `- #${r.id} | ${r.status} | ${r.pickup} â†’ ${r.destination} | ${r.price}â‚¬`).join('\n') || '(keine)'}

ğŸ“ CONSOLE LOGS (letzte 20):
${consoleLogHistory.slice(-20).map(l => `[${l.type.toUpperCase()}] ${l.time}: ${l.message}`).join('\n') || '(keine)'}

ğŸ’¾ LOCALSTORAGE KEYS:
${Object.keys(localStorageData).join(', ')}

========================

ğŸ“¦ KOMPLETTE DATEN ALS JSON:
Siehe unten fÃ¼r vollstÃ¤ndigen JSON-Export...

${debugJSON}
`;
                
                // Erstelle Blob fÃ¼r Download
                const blob = new Blob([debugText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `taxi-app-debug-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
                
                // Zeige Options-Dialog
                const choice = confirm(
                    'ğŸ“‹ DEBUG EXPORT\n\n' +
                    'WÃ¤hle eine Option:\n\n' +
                    '[OK] = In Zwischenablage kopieren\n' +
                    '[Abbrechen] = Als Datei herunterladen'
                );
                
                if (choice) {
                    // Kopiere in Zwischenablage
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(debugText).then(() => {
                            alert('âœ… Mega-Debug-Export kopiert!\n\nAlles ist in deiner Zwischenablage:\n- Console Logs\n- Alle Fahrten\n- Alle Fahrer\n- localStorage\n- etc.');
                        }).catch(err => {
                            prompt('ğŸ“‹ Debug-Export (Strg+C zum Kopieren):', debugText);
                        });
                    } else {
                        prompt('ğŸ“‹ Debug-Export (Strg+C zum Kopieren):', debugText);
                    }
                } else {
                    // Download als Datei
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    alert('âœ… Debug-Export heruntergeladen!\n\nSiehe Downloads-Ordner.');
                }
                
            } catch (error) {
                console.error('âŒ Fehler beim Exportieren:', error);
                alert('âŒ Fehler beim Exportieren der Logs!');
            }
        }
        
        // ğŸ› SUPER DEBUG EXPORT
        function exportSuperDebug() {
            try {
                const now = new Date().toISOString();
                
                // System Info
                const systemInfo = {
                    version: "4.7.1",
                    build: "20251123-0800",
                    timestamp: now,
                    userAgent: navigator.userAgent,
                    currentView: currentView,
                    isOnline: isOnline,
                    isFirebaseReady: isFirebaseReady,
                    currentUser: currentUser ? {
                        uid: currentUser.uid,
                        email: currentUser.email,
                        name: currentUser.displayName
                    } : null
                };
                
                // Erstelle Text-Export
                let debugText = `
=====================================
ğŸ› SUPER DEBUG EXPORT
=====================================
Version: ${systemInfo.version}
Build: ${systemInfo.build}
Zeit: ${systemInfo.timestamp}
User: ${systemInfo.currentUser?.email || 'Nicht eingeloggt'}

ğŸ“Š SYSTEM:
- Browser: ${systemInfo.userAgent}
- View: ${systemInfo.currentView}
- Online: ${systemInfo.isOnline}
- Firebase: ${systemInfo.isFirebaseReady}

ğŸ”´ FEHLER (${debugErrors.length}):
`;
                
                if (debugErrors.length === 0) {
                    debugText += 'âœ… Keine Fehler aufgetreten!\n';
                } else {
                    debugErrors.forEach((err, i) => {
                        debugText += `
[${i+1}] ${err.time}
Message: ${err.message}
File: ${err.filename}:${err.line}:${err.column}
Stack: ${err.stack}
---
`;
                    });
                }
                
                debugText += `
ğŸ“‹ CONSOLE LOGS (letzte ${Math.min(debugLogs.length, 100)}):
`;
                debugLogs.slice(-100).forEach(log => {
                    const icon = log.type === 'error' ? 'ğŸ”´' : log.type === 'warn' ? 'âš ï¸' : 'ğŸ“';
                    debugText += `[${log.time}] ${icon} ${log.message}\n`;
                });
                
                debugText += `
ğŸ” FIREBASE QUERIES (${debugFirebaseQueries.length}):
`;
                if (debugFirebaseQueries.length === 0) {
                    debugText += 'Keine Queries aufgezeichnet\n';
                } else {
                    debugFirebaseQueries.slice(-20).forEach(query => {
                        debugText += `[${query.time}] ${query.path}\n  â†’ ${query.result}\n`;
                    });
                }
                
                debugText += `
âš¡ STATE CHANGES (${debugStateChanges.length}):
`;
                if (debugStateChanges.length === 0) {
                    debugText += 'Keine State Changes aufgezeichnet\n';
                } else {
                    debugStateChanges.slice(-20).forEach(change => {
                        debugText += `[${change.time}] ${change.description}\n  ${change.oldValue} â†’ ${change.newValue}\n`;
                    });
                }
                
                debugText += `
ğŸ’¾ AKTUELLER STATE:
- Rides in Array: ${rides.length}
- Drivers online: ${Object.values(drivers).filter(d => d.online).length}
- Current Vehicle: ${currentVehicle || 'none'}
- Current Ride: ${myCurrentRide?.id || 'none'}
- Pickup Coords: ${pickupCoords ? 'Set' : 'None'}
- Dest Coords: ${destCoords ? 'Set' : 'None'}

ğŸ“¦ FAHRTEN (letzte 10):
`;
                rides.slice(-10).forEach(r => {
                    debugText += `#${r.id} | ${r.status} | ${r.customerName || 'N/A'} | ${r.pickup} â†’ ${r.destination}\n`;
                });
                
                debugText += `
=====================================
`;
                
                // Download als Datei
                const blob = new Blob([debugText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `super-debug-${now.slice(0,19).replace(/:/g,'-')}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert(
                    'ğŸ› Super Debug Export erstellt!\n\n' +
                    `ğŸ“Š ${debugErrors.length} Fehler\n` +
                    `ğŸ“‹ ${debugLogs.length} Console Logs\n` +
                    `ğŸ” ${debugFirebaseQueries.length} Firebase Queries\n` +
                    `âš¡ ${debugStateChanges.length} State Changes\n\n` +
                    'âœ… Datei heruntergeladen!\n' +
                    'Schicke mir diese Datei und ich kann ALLES sehen!'
                );
                
            } catch (error) {
                console.error('âŒ Fehler beim Super Debug Export:', error);
                alert('âŒ Fehler beim Export: ' + error.message);
            }
        }

        // SOUNDS
        // ğŸ”Š ALERT STATUS TRACKING
        let soundAvailable = false;
        let vibrationAvailable = false;
        
        function playDriverNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const beeps = [0, 0.25, 0.5, 0.75, 1.0, 1.25, 1.5, 1.75];
                
                beeps.forEach((time) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 1400;
                    oscillator.type = 'square';
                    
                    gainNode.gain.setValueAtTime(0.8, audioContext.currentTime + time);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + time + 0.15);
                    
                    oscillator.start(audioContext.currentTime + time);
                    oscillator.stop(audioContext.currentTime + time + 0.15);
                });
                
                soundAvailable = true;
                updateAlertStatus();
                return true;
            } catch (e) {
                console.error('Sound Fehler:', e);
                soundAvailable = false;
                updateAlertStatus();
                return false;
            }
        }
        
        // ğŸ§ª TEST FUNKTIONEN
        function testSound() {
            const success = playDriverNotificationSound();
            if (success) {
                setTimeout(() => alert('âœ… Sound funktioniert!'), 500);
            } else {
                alert('âŒ Sound blockiert!\n\nBitte in Browser-Einstellungen:\nSound erlauben');
            }
        }
        
        function testVibration() {
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 400, 100, 200]);
                vibrationAvailable = true;
                updateAlertStatus();
                setTimeout(() => alert('âœ… Vibration funktioniert!'), 500);
            } else {
                vibrationAvailable = false;
                updateAlertStatus();
                alert('âŒ Vibration nicht verfÃ¼gbar!\n\nGerÃ¤t unterstÃ¼tzt keine Vibration.');
            }
        }
        
        // ğŸ“Š UPDATE STATUS INDICATORS
        function updateAlertStatus() {
            const soundIcon = document.getElementById('sound-status');
            const vibrationIcon = document.getElementById('vibration-status');
            const alertsIndicator = document.getElementById('alerts-indicator');
            
            if (currentView === 'driver' && (currentVehicle || isOnline)) {
                alertsIndicator.style.display = 'flex';
                
                if (soundIcon) {
                    soundIcon.textContent = soundAvailable ? 'ğŸ”Š' : 'ğŸ”‡';
                    soundIcon.title = soundAvailable ? 'Sound: OK' : 'Sound: Inaktiv';
                }
                
                if (vibrationIcon) {
                    vibrationIcon.textContent = vibrationAvailable ? 'ğŸ“³' : 'ğŸ“µ';
                    vibrationIcon.title = vibrationAvailable ? 'Vibration: OK' : 'Vibration: Inaktiv';
                }
            } else {
                alertsIndicator.style.display = 'none';
            }
        }
        
        // ğŸš• FULLSCREEN POPUP FUNKTIONEN
        function showNewRideFullscreen() {
            if (!currentVehicle) return;
            
            // Zeige neue AuftrÃ¤ge die:
            // 1. Status 'new' haben UND (keine vehicleId ODER mir zugewiesen)
            // 2. ODER mir zugewiesen sind (assignedTo)
            const myRides = rides.filter(r => {
                const isNew = r.status === 'new';
                const isUnassigned = !r.vehicleId;
                const isAssignedToMe = r.assignedTo === currentVehicle;
                const isMyRide = r.vehicleId === currentVehicle || r.vehicle === (VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle);
                
                return (isNew && (isUnassigned || isMyRide || isAssignedToMe));
            });
            
            if (myRides.length === 0) return;
            
            // Zeige ersten neuen Auftrag
            const ride = myRides[0];
            
            const content = `
                <div style="margin-bottom: 25px;">
                    <div style="
                        background: #f3f4f6;
                        padding: 20px;
                        border-radius: 12px;
                        margin-bottom: 20px;
                    ">
                        ${ride.customerName ? `
                        <div style="
                            background: #dbeafe;
                            padding: 15px;
                            border-radius: 8px;
                            margin-bottom: 15px;
                        ">
                            <div style="font-size: 12px; color: #1e40af; margin-bottom: 5px;">KUNDE</div>
                            <div style="font-size: 22px; font-weight: 600; color: #1e3a8a;">
                                ğŸ‘¤ ${ride.customerName}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ğŸ“ ABHOLUNG</div>
                            <div style="font-size: 18px; font-weight: 600; color: #111;">
                                ${ride.pickup}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ğŸ¯ ZIEL</div>
                            <div style="font-size: 18px; font-weight: 600; color: #111;">
                                ${ride.destination}
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                            <div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">â° ABHOLZEIT</div>
                                <div style="font-size: 16px; font-weight: 600;">
                                    ${ride.pickupTime || 'âš¡ Sofort'}
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ğŸ’° PREIS</div>
                                <div style="font-size: 16px; font-weight: 600; color: #10b981;">
                                    ${ride.price}â‚¬
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <button onclick="rejectRide('${ride.firebaseId || ride.id}')" style="
                        padding: 18px;
                        background: white;
                        color: #ef4444;
                        border: 2px solid #ef4444;
                        border-radius: 12px;
                        font-size: 16px;
                        font-weight: 700;
                        cursor: pointer;
                    ">
                        âŒ Ablehnen
                    </button>
                    <button onclick="acceptRideFromFullscreen('${ride.firebaseId || ride.id}')" style="
                        padding: 18px;
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        color: white;
                        border: none;
                        border-radius: 12px;
                        font-size: 16px;
                        font-weight: 700;
                        cursor: pointer;
                        box-shadow: 0 4px 12px rgba(16,185,129,0.4);
                    ">
                        âœ… Annehmen
                    </button>
                </div>
            `;
            
            document.getElementById('new-ride-fullscreen-content').innerHTML = content;
            document.getElementById('new-ride-fullscreen').style.display = 'block';
            
            // ğŸ“³ WIEDERKEHRENDE VIBRATION BIS REAKTION!
            startRepeatingVibration();
        }
        
        // ğŸ“³ VIBRATIONS-SYSTEM
        let vibrationInterval = null;
        let vibrationCount = 0;
        
        function startRepeatingVibration() {
            // Stoppe alte Vibration falls vorhanden
            stopRepeatingVibration();
            
            vibrationCount = 0;
            
            // Sofort erste Vibration
            doVibration();
            
            // Wiederhole alle 3 Sekunden, maximal 10 Mal
            vibrationInterval = setInterval(() => {
                vibrationCount++;
                
                if (vibrationCount >= 10) {
                    stopRepeatingVibration();
                    return;
                }
                
                doVibration();
            }, 3000); // Alle 3 Sekunden
        }
        
        function doVibration() {
            if (navigator.vibrate) {
                // Kurz-Lang-Kurz-Lang-Kurz Pattern
                navigator.vibrate([200, 100, 400, 100, 200]);
            }
        }
        
        function stopRepeatingVibration() {
            if (vibrationInterval) {
                clearInterval(vibrationInterval);
                vibrationInterval = null;
            }
            vibrationCount = 0;
        }
        
        function closeNewRideFullscreen() {
            stopRepeatingVibration(); // Stoppe Vibration!
            document.getElementById('new-ride-fullscreen').style.display = 'none';
        }
        
        async function acceptRideFromFullscreen(rideId) {
            stopRepeatingVibration(); // Stoppe Vibration!
            closeNewRideFullscreen();
            // Nutze existierende acceptRide Funktion
            await acceptRide(rideId);
        }
        
        async function rejectRide(rideId) {
            if (!confirm('Auftrag wirklich ablehnen?\n\nDer Auftrag bleibt im System und kann anderen Fahrern zugewiesen werden.')) {
                return;
            }
            
            stopRepeatingVibration(); // Stoppe Vibration!
            
            try {
                const ride = rides.find(r => (r.firebaseId || r.id) === rideId);
                if (!ride) {
                    alert('âŒ Fahrt nicht gefunden!');
                    return;
                }
                
                // Update in Firebase
                const updates = {
                    status: 'rejected',
                    rejectedBy: currentVehicle,
                    rejectedAt: new Date().toISOString(),
                    rejectedByDriver: VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle
                };
                
                if (isFirebaseReady) {
                    await db.ref('rides/' + rideId).update(updates);
                    console.log('âŒ Auftrag abgelehnt:', rideId);
                }
                
                // Update lokal
                Object.assign(ride, updates);
                saveRides();
                
                closeNewRideFullscreen();
                updateViews();
                
                alert('âœ… Auftrag abgelehnt!\n\nDer Auftrag bleibt im System fÃ¼r andere Fahrer.');
                
            } catch (error) {
                console.error('âŒ Fehler beim Ablehnen:', error);
                alert('âŒ Fehler: ' + error.message);
            }
        }

        function playArrivalSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const beeps = [0, 0.15, 0.3];
                
                beeps.forEach((time) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime + time);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + time + 0.1);
                    
                    oscillator.start(audioContext.currentTime + time);
                    oscillator.stop(audioContext.currentTime + time + 0.1);
                });
            } catch (e) {
                console.error('Sound Fehler:', e);
            }
        }

        // HISTORY
        function saveToHistory(ride) {
            try {
                let history = JSON.parse(localStorage.getItem('ride-history') || '[]');
                
                if (!history.find(r => r.id === ride.id)) {
                    history.unshift({
                        id: ride.id,
                        customerName: ride.customerName,
                        pickup: ride.pickup,
                        destination: ride.destination,
                        pickupLat: ride.pickupCoords?.lat,
                        pickupLon: ride.pickupCoords?.lon,
                        destLat: ride.destCoords?.lat,
                        destLon: ride.destCoords?.lon,
                        vehicle: ride.vehicle,
                        price: ride.price,
                        distance: ride.distance,
                        time: ride.time,
                        completedAt: new Date().toLocaleString('de-DE')
                    });
                    
                    if (history.length > 50) history = history.slice(0, 50);
                    localStorage.setItem('ride-history', JSON.stringify(history));
                }
            } catch (e) {
                console.error('Fehler beim Speichern der Historie:', e);
            }
        }

        function closeRide() {
            localStorage.removeItem('myCurrentRideId');
            myCurrentRide = null;
            document.getElementById('ride-status-container').innerHTML = '';
            document.getElementById('booking-form').style.display = 'block';
            document.getElementById('confirm').innerHTML = '<div class="alert-success">âœ“ Fahrt wurde in Ihrem Verlauf gespeichert</div>';
            setTimeout(() => document.getElementById('confirm').innerHTML = '', 3000);
        }

        // ğŸ”„ ROUTE UMDREHEN
        function reverseRoute(pickup, destination, pickupLat, pickupLon, destLat, destLon) {
            // Tausche Abholort und Zielort
            document.getElementById('pickup').value = destination;
            document.getElementById('destination').value = pickup;
            
            // Tausche Koordinaten
            if (destLat && destLon) {
                pickupCoords = { lat: parseFloat(destLat), lon: parseFloat(destLon) };
            }
            if (pickupLat && pickupLon) {
                destCoords = { lat: parseFloat(pickupLat), lon: parseFloat(pickupLon) };
            }
            
            // Wechsle zur Fahrgast-Ansicht
            switchView('passenger');
            
            // Zeige BestÃ¤tigung
            const banner = document.createElement('div');
            banner.style.cssText = 'background:#667eea;color:white;padding:15px;border-radius:8px;margin-bottom:15px;text-align:center;';
            banner.innerHTML = 'ğŸ”„ <strong>Route wurde umgedreht!</strong><br><span style="font-size:13px;">ÃœberprÃ¼fe die Adressen und berechne den Preis.</span>';
            
            const bookingForm = document.getElementById('booking-form');
            bookingForm.insertBefore(banner, bookingForm.firstChild);
            setTimeout(() => banner.remove(), 4000);
        }

        // ğŸ“‹ NOCHMAL BUCHEN
        function bookAgain(pickup, destination, pickupLat, pickupLon, destLat, destLon) {
            // FÃ¼lle Felder aus
            document.getElementById('pickup').value = pickup;
            document.getElementById('destination').value = destination;
            
            // Setze Koordinaten
            if (pickupLat && pickupLon) {
                pickupCoords = { lat: parseFloat(pickupLat), lon: parseFloat(pickupLon) };
            }
            if (destLat && destLon) {
                destCoords = { lat: parseFloat(destLat), lon: parseFloat(destLon) };
            }
            
            // Wechsle zur Fahrgast-Ansicht
            switchView('passenger');
            
            // Zeige BestÃ¤tigung
            const banner = document.createElement('div');
            banner.style.cssText = 'background:#10b981;color:white;padding:15px;border-radius:8px;margin-bottom:15px;text-align:center;';
            banner.innerHTML = 'ğŸ“‹ <strong>Route wurde geladen!</strong><br><span style="font-size:13px;">ÃœberprÃ¼fe die Adressen und berechne den Preis.</span>';
            
            const bookingForm = document.getElementById('booking-form');
            bookingForm.insertBefore(banner, bookingForm.firstChild);
            setTimeout(() => banner.remove(), 4000);
        }

        // â­ ALS FAVORIT SPEICHERN
        function addToFavorites(pickup, destination, pickupLat, pickupLon, destLat, destLon) {
            try {
                let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
                
                // PrÃ¼fe ob bereits vorhanden
                const exists = favorites.some(f => 
                    f.pickup === pickup && f.destination === destination
                );
                
                if (exists) {
                    alert('â­ Diese Route ist bereits in deinen Favoriten!');
                    return;
                }
                
                // FÃ¼ge zu Favoriten hinzu
                favorites.push({
                    pickup: pickup,
                    destination: destination,
                    pickupLat: pickupLat,
                    pickupLon: pickupLon,
                    destLat: destLat,
                    destLon: destLon,
                    addedAt: Date.now()
                });
                
                localStorage.setItem('favorites', JSON.stringify(favorites));
                
                alert('â­ Favorit gespeichert!\n\nDiese Route findest du jetzt in deinen Favoriten.');
                
                console.log('â­ Favorit gespeichert:', { pickup, destination });
            } catch (e) {
                console.error('âŒ Fehler beim Speichern des Favoriten:', e);
                alert('âŒ Fehler beim Speichern');
            }
        }

        function closeRide() {
            localStorage.removeItem('myCurrentRideId');
            myCurrentRide = null;
            document.getElementById('ride-status-container').innerHTML = '';
            document.getElementById('booking-form').style.display = 'block';
            document.getElementById('confirm').innerHTML = '<div class="alert-success">âœ“ Fahrt wurde in Ihrem Verlauf gespeichert</div>';
            setTimeout(() => document.getElementById('confirm').innerHTML = '', 3000);
        }
        
        function closeFutureRide(rideId) {
            // Fahrt bleibt in Firebase und im Verlauf gespeichert
            // Display wird nur frei gemacht
            localStorage.removeItem('myCurrentRideId');
            myCurrentRide = null;
            document.getElementById('ride-status-container').innerHTML = '';
            document.getElementById('booking-form').style.display = 'block';
            document.getElementById('confirm').innerHTML = '<div class="alert-success">âœ“ Fahrt gespeichert! Du findest sie unter "Verlauf" â†’ "Kommende Fahrten"</div>';
            setTimeout(() => document.getElementById('confirm').innerHTML = '', 5000);
        }

        function loadHistory() {
            try {
                const history = JSON.parse(localStorage.getItem('ride-history') || '[]');
                const container = document.getElementById('history-list');
                
                if (history.length === 0) {
                    container.innerHTML = '<div style="padding:40px 20px;text-align:center;color:#999;">Noch keine Fahrten</div>';
                    return;
                }
                
                container.innerHTML = history.map(r => `
                    <div class="ride-card">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <strong style="color:#667eea;">#${r.id}</strong>
                            <span style="background:#d1fae5;padding:4px 8px;border-radius:12px;font-size:12px;color:#065f46;">Abgeschlossen</span>
                        </div>
                        ${r.customerName ? `<div style="font-size:15px;font-weight:600;margin-bottom:8px;">ğŸ‘¤ ${r.customerName}</div>` : ''}
                        <div style="font-size:14px;color:#666;line-height:1.8;">
                            <strong>Von:</strong> ${r.pickup}<br>
                            <strong>Nach:</strong> ${r.destination}<br>
                            <strong>Fahrzeug:</strong> ${r.vehicle || 'Taxi'}<br>
                            <strong>Distanz:</strong> ${r.distance} km<br>
                            <strong>Preis:</strong> ${r.price}â‚¬<br>
                            <small style="opacity:0.7;">Abgeschlossen: ${r.completedAt || r.time}</small>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:15px;">
                            <button onclick="reverseRoute('${r.pickup.replace(/'/g, "\\'")}', '${r.destination.replace(/'/g, "\\'")}', ${r.pickupLat || 'null'}, ${r.pickupLon || 'null'}, ${r.destLat || 'null'}, ${r.destLon || 'null'})" 
                                style="padding:10px;border:2px solid #667eea;background:white;color:#667eea;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;">
                                ğŸ”„ Route umdrehen
                            </button>
                            <button onclick="bookAgain('${r.pickup.replace(/'/g, "\\'")}', '${r.destination.replace(/'/g, "\\'")}', ${r.pickupLat || 'null'}, ${r.pickupLon || 'null'}, ${r.destLat || 'null'}, ${r.destLon || 'null'})" 
                                style="padding:10px;border:2px solid #10b981;background:white;color:#10b981;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;">
                                ğŸ“‹ Nochmal buchen
                            </button>
                        </div>
                        <button onclick="addToFavorites('${r.pickup.replace(/'/g, "\\'")}', '${r.destination.replace(/'/g, "\\'")}', ${r.pickupLat || 'null'}, ${r.pickupLon || 'null'}, ${r.destLat || 'null'}, ${r.destLon || 'null'})" 
                            style="padding:10px;border:2px solid #f59e0b;background:white;color:#f59e0b;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;width:100%;margin-top:8px;">
                            â­ Als Favorit speichern
                        </button>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Fehler beim Laden der Historie:', e);
            }
        }

        // RIDE STATUS & TRACKING
        function showRideStatus(ride) {
            const container = document.getElementById('ride-status-container');
            
            // ğŸ“… CHECK: Ist die Fahrt in der Zukunft?
            const now = Date.now();
            // Fahrer-Zuweisung beginnt 30 Min vor Abholung
            const isFutureRide = ride.pickupTimestamp && ride.pickupTimestamp > now + (30 * 60000); // 30 Min Vorlauf
            
            // Wenn Fahrt in der Zukunft und Status 'new', zeige Vormerkung
            if (ride.status === 'new' && isFutureRide) {
                const pickupDate = new Date(ride.pickupTimestamp);
                const formattedDate = pickupDate.toLocaleDateString('de-DE', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                const formattedTime = pickupDate.toLocaleTimeString('de-DE', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                container.innerHTML = `
                    <div class="ride-status-box" style="background:#e0f2fe;border:2px solid #0ea5e9;">
                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“…</div>
                        <h3>Fahrt vorgemerkt!</h3>
                        <div style="margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                            <div style="font-size: 18px; font-weight: 600; color: #0c4a6e; margin-bottom: 10px;">
                                ğŸ• ${formattedDate}<br>
                                um ${formattedTime} Uhr
                            </div>
                        </div>
                        <div style="margin-top: 15px; font-size: 14px; color: #0c4a6e;">
                            <strong>ğŸ“ Von:</strong> ${ride.pickup}<br>
                            <strong>ğŸ¯ Nach:</strong> ${ride.destination}<br>
                            <strong>ğŸ’° Preis:</strong> ${ride.price}â‚¬
                        </div>
                        <div style="margin-top: 15px; padding: 12px; background: #dcfce7; border-radius: 8px; font-size: 13px; color: #14532d;">
                            âœ… Du erhÃ¤ltst 30 Minuten vor der Abholung eine Benachrichtigung, wenn der Fahrer zugewiesen wurde.
                        </div>
                        <div style="display:flex;gap:10px;margin-top:15px;">
                            <button onclick="closeFutureRide('${ride.firebaseId}')" style="flex:1;padding:12px 24px;border:none;background:#10b981;color:white;border-radius:8px;cursor:pointer;font-weight:600;font-size:15px;">âœ“ OK</button>
                            <button onclick="cancelRideConfirm('${ride.firebaseId}')" style="flex:1;padding:12px 24px;border:none;background:#ef4444;color:white;border-radius:8px;cursor:pointer;font-weight:600;font-size:15px;">ğŸ—‘ï¸ Stornieren</button>
                        </div>
                    </div>
                `;
                return;
            }
            
            if (ride.status === 'completed') {
                container.innerHTML = `
                    <div class="ride-status-box" style="background:#d1fae5;border:2px solid #10b981;">
                        <div style="font-size: 48px; margin-bottom: 10px;">âœ…</div>
                        <h3>Fahrt abgeschlossen!</h3>
                        <p style="margin-top: 10px;">Vielen Dank fÃ¼r Ihre Fahrt</p>
                        <div style="margin-top: 15px; font-size: 14px; color: #065f46;">
                            <strong>Fahrzeug:</strong> ${ride.vehicle || 'Taxi'}${ride.vehiclePlate ? ` (ğŸš— ${ride.vehiclePlate})` : ''}<br>
                            <strong>Von:</strong> ${ride.pickup}<br>
                            <strong>Nach:</strong> ${ride.destination}<br>
                            <strong>Preis:</strong> ${ride.price}â‚¬
                        </div>
                        <button onclick="closeRide()" class="btn btn-primary" style="margin-top:20px;">âœ“ SchlieÃŸen</button>
                    </div>
                `;
                saveToHistory(ride);
                return;
            }
            
            if (ride.status === 'picked_up') {
                container.innerHTML = `
                    <div class="ride-status-box" style="background:#dcfce7;border:2px solid #10b981;">
                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸš—</div>
                        <h3>Gute Fahrt!</h3>
                        <p style="margin-top: 10px; font-size: 16px; color: #047857;">
                            ${ride.vehicle || 'Ihr Taxi'}${ride.vehiclePlate ? ` (ğŸš— ${ride.vehiclePlate})` : ''} fÃ¤hrt Sie zu Ihrem Ziel
                        </p>
                        <div style="margin-top: 15px; font-size: 14px; color: #065f46;">
                            <strong>Von:</strong> ${ride.pickup}<br>
                            <strong>Nach:</strong> ${ride.destination}<br>
                            <strong>Distanz:</strong> ${ride.distance} km<br>
                            <strong>Preis:</strong> ${ride.price}â‚¬
                        </div>
                    </div>
                `;
                
                if (!window.lastPickedUpRide || window.lastPickedUpRide !== ride.id) {
                    playArrivalSound();
                    window.lastPickedUpRide = ride.id;
                }
                return;
            }
            
            if (ride.status === 'new') {
                container.innerHTML = `
                    <div class="ride-status-box" style="background:#fef3c7;border:2px solid #f59e0b;">
                        <div style="font-size: 32px; margin-bottom: 8px;">â³</div>
                        <h3 style="font-size: 18px; margin: 8px 0;">Warte auf Fahrer...</h3>
                        <p style="margin-top: 8px; font-size: 14px;">Deine Fahrt wird zugewiesen</p>
                        <div style="margin-top: 12px; font-size: 13px; color: #92400e;">
                            <strong>Von:</strong> ${ride.pickup}<br>
                            <strong>Nach:</strong> ${ride.destination}<br>
                            <strong>Preis:</strong> ${ride.price}â‚¬
                        </div>
                        <button onclick="cancelRideConfirm('${ride.firebaseId}')" style="margin-top:12px;padding:10px 20px;border:none;background:#ef4444;color:white;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;">ğŸ—‘ï¸ Fahrt stornieren</button>
                    </div>
                `;
            } else if (ride.status === 'accepted' && ride.driverLocation) {
                updateRideTracking(ride);
            } else if (ride.status === 'accepted' && !ride.driverLocation) {
                container.innerHTML = `
                    <div class="ride-status-box" style="background:#dbeafe;border:2px solid #3b82f6;">
                        <div style="font-size: 32px; margin-bottom: 8px;">âœ…</div>
                        <h3 style="font-size: 18px; margin: 8px 0;">${ride.vehicle || 'Fahrer'} hat angenommen!</h3>
                        <p style="margin-top: 8px; font-size: 14px;">Warte auf GPS-Position...</p>
                        <div style="margin-top: 12px; font-size: 13px;">
                            <strong>Fahrzeug:</strong> ${ride.vehicle}${ride.vehiclePlate ? ` (${ride.vehiclePlate})` : ''}<br>
                            <strong>Von:</strong> ${ride.pickup}<br>
                            <strong>Nach:</strong> ${ride.destination}<br>
                            <strong>Preis:</strong> ${ride.price}â‚¬
                        </div>
                        <button onclick="cancelRideConfirm('${ride.firebaseId}')" style="margin-top:12px;padding:8px 16px;border:none;background:#ef4444;color:white;border-radius:8px;cursor:pointer;font-size:13px;">ğŸ—‘ï¸ Stornieren</button>
                    </div>
                `;
            }
        }

        async function updateRideTracking(ride) {
            const driverLoc = ride.driverLocation;
            const route = await calculateRoute(driverLoc, ride.pickupCoords);
            const distanceKm = route.distance;
            const durationMin = route.duration;
            
            const eta = new Date(Date.now() + durationMin * 60000);
            const etaTime = eta.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            
            let statusIcon = 'ğŸš•', statusText = ride.vehicle + ' ist unterwegs', statusClass = 'status-coming';
            let etaClass = 'green', progressColor = '#10b981', progress = 80;
            
            if (durationMin <= 2) {
                statusIcon = 'ğŸ¯';
                statusText = ride.vehicle + ' ist gleich da!';
                etaClass = 'green';
                progress = 95;
                if (lastSoundDistance > 2) {
                    playArrivalSound();
                    lastSoundDistance = durationMin;
                }
            } else if (durationMin <= 5) {
                etaClass = 'yellow';
                progressColor = '#f59e0b';
                progress = 60;
            } else {
                etaClass = 'red';
                progressColor = '#ef4444';
                progress = 30;
            }
            
            const container = document.getElementById('ride-status-container');
            container.innerHTML = `
                <div class="ride-status-box ${statusClass}">
                    <div style="font-size: 32px; margin-bottom: 8px;">${statusIcon}</div>
                    <h3 style="font-size: 18px; margin: 8px 0;">${statusText}</h3>
                    <div class="eta-display ${etaClass}" style="font-size: 16px;">${distanceKm} km â€¢ ${durationMin} Min</div>
                    <div style="font-size: 13px; opacity: 0.8; margin-bottom: 12px;">
                        Ankunft ca. ${etaTime} Uhr
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%; background: ${progressColor};"></div>
                    </div>
                    <div style="margin-top: 12px; font-size: 13px;">
                        <strong>Fahrzeug:</strong> ${ride.vehicle}${ride.vehiclePlate ? ` (ğŸš— ${ride.vehiclePlate})` : ''}<br>
                        <strong>Von:</strong> ${ride.pickup}<br>
                        <strong>Nach:</strong> ${ride.destination}<br>
                        <strong>Preis:</strong> ${ride.price}â‚¬
                    </div>
                    <button onclick="cancelRideConfirm('${ride.firebaseId}')" style="margin-top:12px;padding:8px 16px;border:none;background:#ef4444;color:white;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;">ğŸ’¶ Kostenpflichtig stornieren (10â‚¬)</button>
                </div>
                <div id="map"></div>
            `;
            
            if (!map) {
                setTimeout(() => {
                    map = L.map('map').setView([driverLoc.lat, driverLoc.lon], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                    taxiMarker = L.marker([driverLoc.lat, driverLoc.lon]).addTo(map).bindPopup('ğŸš• ' + ride.vehicle);
                    pickupMarker = L.marker([ride.pickupCoords.lat, ride.pickupCoords.lon]).addTo(map).bindPopup('ğŸ“ Abholort');
                    map.fitBounds([[driverLoc.lat, driverLoc.lon], [ride.pickupCoords.lat, ride.pickupCoords.lon]]);
                }, 100);
            } else {
                if (taxiMarker) taxiMarker.setLatLng([driverLoc.lat, driverLoc.lon]);
                map.setView([driverLoc.lat, driverLoc.lon], map.getZoom());
            }
        }

        // ==========================================
        // DRIVER MAP FUNCTIONS
        // ==========================================
        let driverMap = null;
        let driverMarker = null;
        let customerMarker = null;
        let routeLine = null;
        let driverMapUpdateInterval = null;

        async function initDriverMap(rideOrId) {
            // Kann entweder ride Objekt ODER rideId sein
            const rideId = (typeof rideOrId === 'string') ? rideOrId : (rideOrId.firebaseId || rideOrId.id);
            
            console.log('â„¹ï¸ Lade Fahrt-Info aus Firebase:', rideId);
            
            // LADE DIREKT AUS FIREBASE!
            const snapshot = await db.ref('rides/' + rideId).once('value');
            const ride = snapshot.val();
            
            if (!ride) {
                console.error('âŒ Fahrt nicht in Firebase gefunden!');
                alert('âŒ Fehler: Fahrt nicht gefunden!');
                return;
            }
            
            // FÃ¼ge firebaseId hinzu
            ride.firebaseId = rideId;
            
            console.log('âœ… Fahrt aus Firebase geladen:', ride);
            
            // ğŸ“‹ Update Info Box oben
            updateDriverInfoTop(ride);
            
            // Verstecke Ready-State, Zeige Info-Container
            document.getElementById('driver-ready').style.display = 'none';
            document.getElementById('driver-route-info').style.display = 'block';
            
            // âŒ KEINE KARTE! Nur Info-Anzeige
        }

        async function updateDriverRoute(ride) {
            const driver = drivers[currentVehicle];
            if (!driver || !driver.lat || !driver.lon || !driverMap) return;
            
            // FLEXIBEL: Navigation zum Abholort ODER zum Ziel!
            let targetCoords, targetLabel, routeTitle;
            if (ride.status === 'picked_up') {
                // Kunde ist drin â†’ Navigation zum ZIEL
                targetCoords = ride.destCoords;
                targetLabel = 'ğŸ¯ Ziel';
                routeTitle = 'ğŸ¯ Navigation zum Ziel';
            } else {
                // Fahrt angenommen â†’ Navigation zum ABHOLORT
                targetCoords = ride.pickupCoords;
                targetLabel = 'ğŸ“ Fahrgast';
                routeTitle = 'ğŸ“ Navigation zum Fahrgast';
            }
            
            // Update Titel
            document.getElementById('route-title').textContent = routeTitle;
            
            // Update Fahrer-Position
            if (driverMarker) {
                driverMarker.setLatLng([driver.lat, driver.lon]);
            }
            
            // Update Ziel-Marker
            if (customerMarker && ride.status === 'picked_up') {
                // Ã„ndere Marker zum Ziel
                customerMarker.setLatLng([targetCoords.lat, targetCoords.lon]);
                const destIcon = L.divIcon({
                    html: '<div style="background:#10b981;color:white;padding:8px 12px;border-radius:20px;font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,0.3);">ğŸ¯ Ziel</div>',
                    className: '',
                    iconSize: [100, 40]
                });
                customerMarker.setIcon(destIcon);
            }
            
            // Berechne Route
            const route = await calculateRoute(
                { lat: driver.lat, lon: driver.lon },
                { lat: targetCoords.lat, lon: targetCoords.lon }
            );
            
            // Update Info-Box
            document.getElementById('route-distance').textContent = route.distance;
            document.getElementById('route-duration').textContent = route.duration;
            
            const eta = new Date(Date.now() + route.duration * 60000);
            document.getElementById('route-eta').textContent = eta.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            
            // Hole detaillierte Route MIT TURN-BY-TURN ANWEISUNGEN!
            try {
                const response = await fetch(
                    `https://router.project-osrm.org/route/v1/driving/${driver.lon},${driver.lat};${targetCoords.lon},${targetCoords.lat}?overview=full&geometries=geojson&steps=true`
                );
                const data = await response.json();
                
                if (data.routes && data.routes.length > 0) {
                    const routeData = data.routes[0];
                    const coords = routeData.geometry.coordinates;
                    const latLngs = coords.map(c => [c[1], c[0]]);  // [lon,lat] â†’ [lat,lon]
                    
                    // Entferne alte Linie
                    if (routeLine) {
                        driverMap.removeLayer(routeLine);
                    }
                    
                    // Zeichne neue Route
                    routeLine = L.polyline(latLngs, {
                        color: '#667eea',
                        weight: 5,
                        opacity: 0.8
                    }).addTo(driverMap);
                    
                    // ğŸ¯ TURN-BY-TURN ANWEISUNGEN!
                    if (routeData.legs && routeData.legs[0].steps) {
                        const steps = routeData.legs[0].steps;
                        const currentStep = steps[0]; // NÃ¤chste Anweisung
                        
                        if (currentStep) {
                            updateTurnByTurnDisplay(currentStep);
                        }
                    }
                    
                    console.log('âœ… Route gezeichnet:', route.distance, 'km,', route.duration, 'min');
                }
            } catch (e) {
                console.error('âŒ Route-Fehler:', e);
            }
        }

        function updateTurnByTurnDisplay(step) {
            const maneuver = step.maneuver;
            const distance = step.distance;
            const name = step.name || 'StraÃŸe';
            
            // Berechne Distanz in Metern
            const distanceMeters = Math.round(distance);
            const distanceText = distanceMeters >= 1000 
                ? `${(distanceMeters / 1000).toFixed(1)} km` 
                : `${distanceMeters} m`;
            
            // Bestimme Icon und Text basierend auf ManÃ¶ver-Typ
            let icon = 'â†‘';
            let instruction = 'Geradeaus weiter';
            
            const type = maneuver.type;
            const modifier = maneuver.modifier;
            
            if (type === 'turn') {
                if (modifier === 'left') {
                    icon = 'â†';
                    instruction = 'LINKS abbiegen';
                } else if (modifier === 'right') {
                    icon = 'â†’';
                    instruction = 'RECHTS abbiegen';
                } else if (modifier === 'slight left') {
                    icon = 'â†–';
                    instruction = 'Leicht links';
                } else if (modifier === 'slight right') {
                    icon = 'â†—';
                    instruction = 'Leicht rechts';
                } else if (modifier === 'sharp left') {
                    icon = 'â¬…';
                    instruction = 'SCHARF LINKS';
                } else if (modifier === 'sharp right') {
                    icon = 'â¡';
                    instruction = 'SCHARF RECHTS';
                }
            } else if (type === 'depart') {
                icon = 'ğŸš—';
                instruction = 'Losfahren';
            } else if (type === 'arrive') {
                icon = 'ğŸ¯';
                instruction = 'ZIEL ERREICHT!';
            } else if (type === 'roundabout') {
                icon = 'â­•';
                instruction = 'Kreisverkehr';
                if (modifier === 'left') instruction += ' - 3. Ausfahrt';
                else if (modifier === 'right') instruction += ' - 1. Ausfahrt';
                else instruction += ' - 2. Ausfahrt';
            } else if (type === 'merge') {
                icon = 'â¤´';
                instruction = 'EinfÃ¤deln';
            } else if (type === 'continue') {
                icon = 'â†‘';
                instruction = 'Weiter geradeaus';
            }
            
            // Update UI
            document.getElementById('turn-icon').textContent = icon;
            document.getElementById('turn-distance').textContent = distanceText;
            document.getElementById('turn-instruction').textContent = instruction;
            document.getElementById('turn-street').textContent = `auf ${name}`;
            
            // FÃ¤rbe Box basierend auf Distanz
            const turnBox = document.getElementById('turn-by-turn');
            if (distanceMeters < 50) {
                turnBox.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'; // ROT - JETZT!
            } else if (distanceMeters < 200) {
                turnBox.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'; // ORANGE - Gleich!
            } else {
                turnBox.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'; // BLAU - Normal
            }
            
            console.log(`ğŸ§­ NÃ¤chste Anweisung: ${instruction} in ${distanceText} auf ${name}`);
        }

        function closeDriverMap() {
            console.log('ğŸ—ºï¸ SchlieÃŸe Fahrer-Karte');
            
            // Stoppe Updates
            if (driverMapUpdateInterval) {
                clearInterval(driverMapUpdateInterval);
                driverMapUpdateInterval = null;
            }
            
            // Entferne Karte
            if (driverMap) {
                driverMap.remove();
                driverMap = null;
                driverMarker = null;
                customerMarker = null;
                routeLine = null;
            }
            
            // Verstecke Container, Zeige Ready
            document.getElementById('driver-route-info').style.display = 'none';
            document.getElementById('driver-ready').style.display = 'block';
        }

        function openGoogleMapsNavigation(rideId, destination) {
            const ride = rides.find(r => r.firebaseId === rideId);
            if (!ride) {
                alert('âŒ Fahrt nicht gefunden!');
                return;
            }
            
            let targetLat, targetLon, targetName;
            
            if (destination === 'pickup') {
                // Navigation zum Kunden (Abholort)
                targetLat = ride.pickupCoords.lat;
                targetLon = ride.pickupCoords.lon;
                targetName = ride.pickup;
            } else {
                // Navigation zum Ziel
                targetLat = ride.destCoords.lat;
                targetLon = ride.destCoords.lon;
                targetName = ride.destination;
            }
            
            // Google Maps URL fÃ¼r Navigation
            // FÃ¼r Mobile: google.navigation:q=lat,lon
            // FÃ¼r Desktop/Fallback: https://www.google.com/maps/dir/?api=1&destination=lat,lon
            
            const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
            let mapsUrl;
            
            if (isMobile) {
                // Mobile: Ã–ffne Google Maps App direkt mit Navigation
                mapsUrl = `google.navigation:q=${targetLat},${targetLon}`;
                
                // Fallback fÃ¼r iOS oder wenn Google Maps nicht installiert
                setTimeout(() => {
                    window.location.href = `https://www.google.com/maps/dir/?api=1&destination=${targetLat},${targetLon}&travelmode=driving`;
                }, 500);
            } else {
                // Desktop: Ã–ffne Google Maps im Browser
                mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${targetLat},${targetLon}&travelmode=driving`;
            }
            
            console.log('ğŸ—ºï¸ Ã–ffne Google Maps Navigation zu:', targetName);
            console.log('ğŸ“ Koordinaten:', targetLat, targetLon);
            
            // Ã–ffne Maps
            window.open(mapsUrl, '_blank');
            
            // BestÃ¤tigungsmeldung
            alert(`âœ… Google Maps Navigation gestartet!\n\nZiel: ${targetName}\n\nğŸ’¡ Tipp: Die Navigation Ã¶ffnet sich in der Google Maps App.`);
        }

        // ğŸ” LOGIN SYSTEM FUNCTIONS
        
        function showLoginModal() {
            document.getElementById('register-modal').style.display = 'none';
            document.getElementById('login-modal').style.display = 'block';
        }
        
        function closeLoginModal() {
            document.getElementById('login-modal').style.display = 'none';
        }
        
        function showRegisterModal() {
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('register-modal').style.display = 'block';
        }
        
        function closeRegisterModal() {
            document.getElementById('register-modal').style.display = 'none';
        }
        
        async function loginWithGoogle() {
            if (!auth) {
                // Versuche Firebase Auth nochmal zu initialisieren
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    auth = firebase.auth();
                } else {
                    alert('âŒ Firebase Auth ist nicht verfÃ¼gbar.\n\nBitte lade die Seite neu (Strg+F5) und versuche es nochmal.');
                    return;
                }
            }
            
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
                closeLoginModal();
            } catch (error) {
                console.error('Google Login Fehler:', error);
                if (error.code === 'auth/popup-blocked') {
                    alert('âŒ Popup wurde blockiert!\n\nBitte erlaube Popups fÃ¼r diese Seite.');
                } else {
                    alert('âŒ Google Login fehlgeschlagen: ' + error.message);
                }
            }
        }
        
        async function loginWithEmail() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                alert('Bitte E-Mail und Passwort eingeben');
                return;
            }
            
            if (!auth) {
                alert('Firebase Auth nicht verfÃ¼gbar');
                return;
            }
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                closeLoginModal();
            } catch (error) {
                console.error('Login Fehler:', error);
                alert('Login fehlgeschlagen: ' + error.message);
            }
        }
        
        async function registerWithEmail() {
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            if (!name || !email || !password) {
                alert('Bitte alle Felder ausfÃ¼llen');
                return;
            }
            
            if (!auth) {
                alert('Firebase Auth nicht verfÃ¼gbar');
                return;
            }
            
            try {
                const result = await auth.createUserWithEmailAndPassword(email, password);
                await result.user.updateProfile({ displayName: name });
                closeRegisterModal();
                alert('Registrierung erfolgreich! Willkommen, ' + name + '!');
            } catch (error) {
                console.error('Registrierung Fehler:', error);
                alert('Registrierung fehlgeschlagen: ' + error.message);
            }
        }
        
        async function logoutUser() {
            if (!auth || !currentUser) return;
            
            try {
                await auth.signOut();
                console.log('âœ… Logout erfolgreich');
            } catch (error) {
                console.error('âŒ Logout-Fehler:', error);
                alert('Logout fehlgeschlagen: ' + error.message);
            }
        }
        
        // ğŸ†• Stammkunden-Daten lÃ¶schen
        function clearRegularCustomer() {
            if (confirm('Stammkunden-Daten lÃ¶schen?\n\nDeine gespeicherten Daten (Name, Adresse, Fahrten-Anzahl) werden entfernt.')) {
                localStorage.removeItem('regularCustomer');
                updateUserProfile();
                console.log('ğŸ—‘ï¸ Stammkunden-Daten gelÃ¶scht');
            }
        }
        
        // ğŸ” ROLLEN-SYSTEM
        let userRole = 'fahrgast'; // Standard-Rolle
        
        async function getUserRole(user) {
            // Admin per Email
            if (user.email === 'funktaxi.pw@gmail.com') {
                return 'admin';
            }
            
            // PrÃ¼fe Firebase fÃ¼r zugewiesene Rollen
            if (isFirebaseReady) {
                try {
                    // Erst normale User-Tabelle prÃ¼fen
                    const snapshot = await db.ref('users/' + user.uid).once('value');
                    const userData = snapshot.val();
                    if (userData && userData.role) {
                        return userData.role;
                    }
                    
                    // Dann vorregistrierte Mitarbeiter prÃ¼fen
                    const emailKey = user.email.replace(/\./g, '_').replace(/@/g, '_at_');
                    const preRegSnapshot = await db.ref('preRegisteredUsers/' + emailKey).once('value');
                    const preRegData = preRegSnapshot.val();
                    if (preRegData && preRegData.role) {
                        // Ãœbertrage Daten zum echten User
                        await db.ref('users/' + user.uid).update({
                            role: preRegData.role,
                            vehicle: preRegData.vehicle || '',
                            phone: preRegData.phone || '',
                            preRegisteredAt: preRegData.createdAt
                        });
                        console.log('âœ… Vorregistrierten Mitarbeiter aktiviert:', user.email, 'â†’', preRegData.role);
                        return preRegData.role;
                    }
                } catch (error) {
                    console.error('âŒ Fehler beim Laden der Rolle:', error);
                }
            }
            
            return 'fahrgast'; // Standard
        }
        
        function applyRoleRestrictions(role) {
            console.log('ğŸ” Rolle anwenden:', role);
            userRole = role;
            
            const fahrgastBtn = document.querySelector('.view-btn[onclick*="passenger"]');
            const verlaufBtn = document.querySelector('.view-btn[onclick*="history"]');
            const fahrerBtn = document.querySelector('.view-btn[onclick*="driver"]');
            const adminBtn = document.querySelector('.view-btn[onclick*="admin"]');
            
            // Alle verstecken erstmal
            if (fahrgastBtn) fahrgastBtn.style.display = 'none';
            if (verlaufBtn) verlaufBtn.style.display = 'none';
            if (fahrerBtn) fahrerBtn.style.display = 'none';
            if (adminBtn) adminBtn.style.display = 'none';
            
            // Je nach Rolle anzeigen
            if (role === 'fahrgast') {
                if (fahrgastBtn) fahrgastBtn.style.display = 'block';
                if (verlaufBtn) verlaufBtn.style.display = 'block';
                switchView('passenger');
            } else if (role === 'fahrer') {
                if (fahrerBtn) fahrerBtn.style.display = 'block';
                switchView('driver');
            } else if (role === 'admin') {
                // Admin sieht ALLES
                if (fahrgastBtn) fahrgastBtn.style.display = 'block';
                if (verlaufBtn) verlaufBtn.style.display = 'block';
                if (fahrerBtn) fahrerBtn.style.display = 'block';
                if (adminBtn) adminBtn.style.display = 'block';
            }
        }
        
        async function onUserLoggedIn(user) {
            console.log('ğŸ‘¤ User eingeloggt:', user.email);
            currentUser = user;
            
            // ğŸ” Rolle laden und anwenden
            const role = await getUserRole(user);
            applyRoleRestrictions(role);
            
            // User in Firebase speichern (fÃ¼r Rechteverwaltung)
            if (isFirebaseReady) {
                db.ref('users/' + user.uid).update({
                    email: user.email,
                    displayName: user.displayName || '',
                    lastLogin: Date.now()
                });
            }
            
            updateUserProfile();
            
            // ğŸ“ FÃ¼lle Name-Feld automatisch aus
            const nameField = document.getElementById('customer-name');
            if (nameField && user.displayName) {
                nameField.value = user.displayName;
            }
        }
        
        function onUserLoggedOut() {
            console.log('ğŸ‘¤ User ausgeloggt');
            currentUser = null;
            userRole = 'fahrgast';
            
            // ğŸ” Alle Tabs wieder anzeigen (fÃ¼r nicht eingeloggte User)
            const allBtns = document.querySelectorAll('.view-btn');
            allBtns.forEach(btn => btn.style.display = 'block');
            
            updateUserProfile();
        }
        
        function updateUserProfile() {
            const header = document.querySelector('.header');
            if (!header) {
                console.warn('âš ï¸ Header element not found yet');
                return;
            }
            
            let profileBox = document.getElementById('user-profile-box');
            
            if (currentUser) {
                // User ist eingeloggt - zeige Profil + Stammkunden-Info
                const initial = (currentUser.displayName || currentUser.email).charAt(0).toUpperCase();
                const displayName = currentUser.displayName || currentUser.email.split('@')[0];
                
                // Lade Stammkunden-Daten
                const regularCustomer = JSON.parse(localStorage.getItem('regularCustomer') || 'null');
                
                if (!profileBox) {
                    profileBox = document.createElement('div');
                    profileBox.id = 'user-profile-box';
                    profileBox.className = 'user-profile';
                    header.appendChild(profileBox);
                }
                
                // Stammkunden-Info
                let customerStats = '';
                if (regularCustomer && regularCustomer.rideCount > 0) {
                    customerStats = `<div style="font-size: 9px; opacity: 0.8; margin-top: 2px;">ğŸš• ${regularCustomer.rideCount} Fahrt${regularCustomer.rideCount > 1 ? 'en' : ''} Â· ğŸ“ ${regularCustomer.favoritePickup ? regularCustomer.favoritePickup.substring(0, 20) + (regularCustomer.favoritePickup.length > 20 ? '...' : '') : 'Keine Adresse'}</div>`;
                }
                
                profileBox.innerHTML = `
                    <div class="user-avatar">${initial}</div>
                    <div class="user-info">
                        <div style="font-weight: 600; font-size: 11px;">${displayName}</div>
                        <div style="font-size: 9px; opacity: 0.75;">${currentUser.email}</div>
                        ${customerStats}
                    </div>
                    <button class="btn-logout" onclick="logoutUser()">Aus</button>
                `;
            } else {
                // User ist nicht eingeloggt - zeige nur Anmelden Button
                if (!profileBox) {
                    profileBox = document.createElement('div');
                    profileBox.id = 'user-profile-box';
                    header.appendChild(profileBox);
                }
                
                profileBox.className = '';
                profileBox.style.marginTop = '15px';
                profileBox.innerHTML = `
                    <button class="btn btn-primary" onclick="showLoginModal()" style="padding: 10px 20px; font-size: 13px;">
                        ğŸ” Anmelden / Registrieren
                    </button>
                `;
            }
        }

        // EVENT LISTENERS
        window.addEventListener('DOMContentLoaded', () => {
            // ğŸ” STARTSEITE: Nur Fahrgast + Verlauf anzeigen (bis Login)
            const fahrerBtn = document.querySelector('.view-btn[onclick*="driver"]');
            const adminBtn = document.querySelector('.view-btn[onclick*="admin"]');
            if (fahrerBtn) fahrerBtn.style.display = 'none';
            if (adminBtn) adminBtn.style.display = 'none';
            
            // ğŸ› Globaler Error Handler fÃ¼r besseres Debugging
            window.addEventListener('error', (e) => {
                console.error('âŒ FEHLER:', {
                    message: e.message,
                    filename: e.filename,
                    lineno: e.lineno,
                    colno: e.colno,
                    error: e.error
                });
            });
            
            setupAutocomplete();
            
            // ğŸ†• BUTTON-LOGIK: Verstecke "Taxi buchen" wenn Felder geÃ¤ndert werden
            const pickupField = document.getElementById('pickup');
            const destField = document.getElementById('destination');
            const bookBtn = document.getElementById('book-btn');
            
            function hideBookButton() {
                if (bookBtn) {
                    bookBtn.style.display = 'none';
                    bookBtn.style.visibility = 'hidden';
                    console.log('ğŸ”’ "Taxi buchen" versteckt (Felder geÃ¤ndert)');
                }
            }
            
            if (pickupField) {
                pickupField.addEventListener('input', hideBookButton);
            }
            if (destField) {
                destField.addEventListener('input', hideBookButton);
            }
            
            // ğŸ”” BENACHRICHTIGUNGS-BANNER SOFORT ANZEIGEN
            if ('Notification' in window && Notification.permission !== 'granted') {
                document.getElementById('static-notification-banner').style.display = 'block';
            }
            
            // ğŸ”” Service Worker & Push Notifications initialisieren
            initServiceWorker();
            
            // ğŸŒŸ Stammkunden-Daten laden
            loadRegularCustomer();
            
            // ğŸ’° Pricing Settings laden
            loadPricingSettings();
            
            // ğŸ” Zeige Login-Button (wird von Auth Observer aktualisiert)
            try {
                updateUserProfile();
            } catch (error) {
                console.error('âŒ updateUserProfile Fehler:', error);
            }
            
            setTimeout(() => { 
                if (firebaseLoaded && typeof firebase !== 'undefined') initApp(true); 
                else initApp(false); 
                
                const savedRideId = localStorage.getItem('myCurrentRideId');
                if (savedRideId && isFirebaseReady) {
                    console.log('ğŸ”„ Lade gespeicherte Fahrt:', savedRideId);
                    listenToMyRide(savedRideId);
                }
                
                loadSavedVehicle();
            }, 100);
            
            setInterval(() => { 
                if (pickupCoords) showAvailableTaxis(); 
                if (myCurrentRide && myCurrentRide.status === 'accepted') showRideStatus(myCurrentRide);
                
                // ğŸ”§ Wake Lock alle 30 Sek. prÃ¼fen und neu aktivieren
                if (isOnline && wakeLock === null) {
                    console.log('ğŸ”„ Wake Lock reaktivieren...');
                    requestWakeLock();
                }
            }, 30000);
            
            // ğŸ¯ Live-Update fÃ¼r Assignment-Countdown (jede Sekunde)
            setInterval(() => {
                if (currentView === 'driver') {
                    updateViews(); // Aktualisiert Countdown-Timer
                }
            }, 1000);
            
            // ğŸ“± PAGE VISIBILITY: GPS stoppen wenn App geschlossen/im Hintergrund
            document.addEventListener('visibilitychange', () => {
                console.log('ğŸ‘ï¸ Visibility changed:', document.hidden ? 'HIDDEN' : 'VISIBLE');
                
                if (document.hidden) {
                    // App im Hintergrund oder geschlossen
                    console.log('ğŸ“± App geht in Hintergrund...');
                    
                    if (watchId && currentVehicle) {
                        console.log('â¸ï¸ Pausiere GPS (App im Hintergrund)');
                        // GPS lÃ¤uft weiter, aber Wake Lock freigeben
                        if (wakeLock) {
                            wakeLock.release();
                            wakeLock = null;
                            console.log('âš ï¸ Wake Lock freigegeben (Hintergrund)');
                        }
                    }
                } else {
                    // App wieder sichtbar
                    console.log('ğŸ“± App wieder sichtbar');
                    
                    if (isOnline && currentVehicle && !watchId) {
                        console.log('â–¶ï¸ Starte GPS neu (App wieder aktiv)');
                        startDriverTracking();
                    }
                    
                    // Wake Lock reaktivieren
                    if (isOnline && !wakeLock) {
                        requestWakeLock();
                    }
                    
                    // Synchronisiere Toggle-State
                    syncToggleState();
                }
            });
            
            // ğŸšª BEFOREUNLOAD: GPS cleanup beim SchlieÃŸen
            window.addEventListener('beforeunload', () => {
                console.log('ğŸšª App wird geschlossen - cleanup...');
                
                if (watchId) {
                    navigator.geolocation.clearWatch(watchId);
                    console.log('ğŸ›‘ GPS gestoppt (beforeunload)');
                }
                
                if (wakeLock) {
                    wakeLock.release();
                    console.log('âš ï¸ Wake Lock freigegeben (beforeunload)');
                }
                
                // Firebase cleanup
                if (currentVehicle && isFirebaseReady) {
                    db.ref('drivers/' + currentVehicle).remove();
                    console.log('ğŸ—‘ï¸ GPS aus Firebase entfernt (beforeunload)');
                }
            });
            
            // ğŸ“… VORBESTELLUNGS-CHECK: PrÃ¼fe alle 60 Sek. ob Vorbestellungen aktiviert werden mÃ¼ssen
            setInterval(async () => {
                if (!isFirebaseReady) return;
                
                try {
                    const snapshot = await db.ref('rides').orderByChild('status').equalTo('vorbestellt').once('value');
                    if (!snapshot.exists()) return;
                    
                    const now = Date.now();
                    snapshot.forEach(async (childSnapshot) => {
                        const ride = childSnapshot.val();
                        const rideId = childSnapshot.key;
                        
                        // ğŸ›¡ï¸ SICHERHEITS-CHECKS: Verhindere doppelte Aktivierung
                        
                        // Check 1: Wurde schon aktiviert?
                        if (ride.activatedAt) {
                            console.log('â­ï¸ Vorbestellung bereits aktiviert, Ã¼berspringe:', rideId);
                            return;
                        }
                        
                        // Check 2: Status wirklich "vorbestellt"?
                        if (ride.status !== 'vorbestellt') {
                            console.log('â­ï¸ Status nicht mehr "vorbestellt", Ã¼berspringe:', rideId, ride.status);
                            return;
                        }
                        
                        // Check 3: Nicht completed/cancelled?
                        if (ride.status === 'completed' || ride.status === 'cancelled' || ride.status === 'storniert' || ride.status === 'abgeschlossen') {
                            console.log('â­ï¸ Fahrt bereits abgeschlossen, Ã¼berspringe:', rideId);
                            return;
                        }
                        
                        // PrÃ¼fe ob Abholzeit in â‰¤ 15 Min
                        if (ride.pickupTimestamp) {
                            const minutesUntilPickup = (ride.pickupTimestamp - now) / (1000 * 60);
                            
                            if (minutesUntilPickup <= 15 && minutesUntilPickup > 0) {
                                console.log('ğŸ“… Vorbestellung wird aktiviert:', rideId, 'noch', minutesUntilPickup.toFixed(1), 'Min');
                                
                                // Status auf "new" setzen â†’ Fahrer bekommen Benachrichtigung
                                await db.ref('rides/' + rideId).update({
                                    status: 'new',
                                    activatedAt: Date.now()
                                });
                                
                                // ğŸ¯ STARTE AUTO-ASSIGNMENT fÃ¼r aktivierte Vorbestellung
                                const updatedRide = { ...ride, status: 'new', firebaseId: rideId };
                                startAutoAssignment(rideId, updatedRide);
                                console.log('ğŸ¯ Auto-Assignment gestartet fÃ¼r aktivierte Vorbestellung:', rideId);
                            } else if (minutesUntilPickup <= 0) {
                                console.log('â° Vorbestellung ist Ã¼berfÃ¤llig:', rideId, 'war vor', Math.abs(minutesUntilPickup).toFixed(1), 'Min');
                            }
                        }
                    });
                } catch (error) {
                    console.error('âŒ Fehler beim Vorbestellungs-Check:', error);
                }
            }, 60000); // Alle 60 Sekunden
            
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    console.log('ğŸ“± App wieder sichtbar - prÃ¼fe Wake Lock');
                    if (isOnline && (wakeLock === null || wakeLock.released)) {
                        console.log('ğŸ”„ Reaktiviere Wake Lock');
                        requestWakeLock();
                    }
                    // GPS-Position auch neu senden wenn Fahrer online
                    if (isOnline && currentView === 'driver' && watchId) {
                        navigator.geolocation.getCurrentPosition(sendDriverLocation);
                    }
                }
            });
            
            // ğŸ“± ZusÃ¤tzliche Wake Lock Reaktivierung bei User-Interaktion
            ['focus', 'touchstart', 'click'].forEach(eventType => {
                document.addEventListener(eventType, () => {
                    if (isOnline && currentView === 'driver' && (wakeLock === null || wakeLock.released)) {
                        console.log('ğŸ‘† User-Interaktion erkannt - reaktiviere Wake Lock');
                        requestWakeLock();
                    }
                }, { once: false, passive: true });
            });
        });
    </script>
    <!-- ğŸ” LOGIN MODAL -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ğŸ” Anmelden</div>
            
            <button class="modal-btn btn-google" onclick="loginWithGoogle()">
                <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Mit Google anmelden
            </button>
            
            <div class="modal-divider">oder</div>
            
            <input type="email" id="login-email" class="modal-input" placeholder="E-Mail">
            <input type="password" id="login-password" class="modal-input" placeholder="Passwort">
            
            <button class="modal-btn btn-primary-modal" onclick="loginWithEmail()">Anmelden</button>
            
            <div class="modal-link" onclick="showRegisterModal()">Noch kein Konto? Jetzt registrieren</div>
            <div class="modal-link" onclick="closeLoginModal()">Abbrechen</div>
        </div>
    </div>
    
    <!-- ğŸ“ REGISTER MODAL -->
    <div id="register-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ğŸ“ Registrieren</div>
            
            <input type="text" id="register-name" class="modal-input" placeholder="Name">
            <input type="email" id="register-email" class="modal-input" placeholder="E-Mail">
            <input type="password" id="register-password" class="modal-input" placeholder="Passwort">
            
            <button class="modal-btn btn-primary-modal" onclick="registerWithEmail()">Registrieren</button>
            
            <div class="modal-link" onclick="showLoginModal()">Bereits ein Konto? Anmelden</div>
            <div class="modal-link" onclick="closeRegisterModal()">Abbrechen</div>
        </div>
    </div>

</body>
</html>
