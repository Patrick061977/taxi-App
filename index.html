<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funk Taxi Heringsdorf - √ñPNV-Taxi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 16px;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(17, 153, 142, 0.4);
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            color: #667eea;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .station-info {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .station-name {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .station-distance {
            color: #666;
            font-size: 14px;
        }
        
        .departure-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
        }
        
        .departure-line {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .departure-direction {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .departure-time {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
        }
        
        .time-badge {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .countdown {
            color: #11998e;
            font-weight: 600;
        }
        
        .delay {
            color: #e74c3c;
            font-weight: 600;
        }
        
        .oepnv-banner {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .oepnv-banner h3 {
            font-size: 22px;
            margin-bottom: 10px;
        }
        
        .oepnv-banner p {
            font-size: 16px;
            opacity: 0.95;
            margin-bottom: 15px;
        }
        
        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }
        
        .debug-info {
            background: #f0f0f0;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöï Funk Taxi Heringsdorf</h1>
            <p>Ihr √ñPNV-Taxi auf Usedom</p>
        </div>

        <div class="card">
            <button class="btn btn-primary" onclick="showSchedule()">
                üöå Fahrplan anzeigen
            </button>
            <button class="btn btn-success" onclick="bookTaxi()">
                üöï Taxi jetzt buchen
            </button>
        </div>

        <div id="content"></div>
    </div>

    <script>
        let userLocation = null;
        let debugMode = true; // Debug-Modus f√ºr Patrick!
        
        async function showSchedule() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="card">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>GPS-Position wird ermittelt...</p>
                    </div>
                </div>
            `;
            
            try {
                // GPS-Position abrufen
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });
                
                userLocation = {
                    lat: position.coords.latitude,
                    lon: position.coords.longitude
                };
                
                console.log('GPS Position:', userLocation);
                
                // Haltestellen in der N√§he suchen
                content.innerHTML = `
                    <div class="card">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Suche Haltestellen in der N√§he...</p>
                        </div>
                    </div>
                `;
                
                const stationsUrl = `https://v6.db.transport.rest/locations/nearby?latitude=${userLocation.lat}&longitude=${userLocation.lon}&results=3`;
                console.log('Fetching stations:', stationsUrl);
                
                const stationsResponse = await fetch(stationsUrl);
                
                if (!stationsResponse.ok) {
                    throw new Error(`Stations API error: ${stationsResponse.status}`);
                }
                
                const stationsData = await stationsResponse.json();
                console.log('Stations Response:', stationsData);
                
                // WICHTIG: Die API kann direkt ein Array zur√ºckgeben!
                const stations = Array.isArray(stationsData) ? stationsData : (stationsData.stations || []);
                
                if (!stations || stations.length === 0) {
                    content.innerHTML = `
                        <div class="card">
                            <div class="empty-state">
                                <div class="empty-state-icon">üöè</div>
                                <h3>Keine Haltestellen gefunden</h3>
                                <p>In Ihrer N√§he wurden keine √ñPNV-Haltestellen gefunden.</p>
                            </div>
                            ${debugMode ? `<div class="debug-info">DEBUG: ${JSON.stringify(stationsData, null, 2)}</div>` : ''}
                        </div>
                    `;
                    return;
                }
                
                // Erste Haltestelle nehmen
                const station = stations[0];
                
                // Abfahrten abrufen
                content.innerHTML = `
                    <div class="card">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Lade Abfahrtszeiten...</p>
                        </div>
                    </div>
                `;
                
                const departuresUrl = `https://v6.db.transport.rest/stops/${encodeURIComponent(station.id)}/departures?duration=120`;
                console.log('Fetching departures:', departuresUrl);
                
                const departuresResponse = await fetch(departuresUrl);
                
                if (!departuresResponse.ok) {
                    throw new Error(`Departures API error: ${departuresResponse.status}`);
                }
                
                const departuresData = await departuresResponse.json();
                console.log('Departures Response:', departuresData);
                console.log('Type:', typeof departuresData);
                console.log('Is Array:', Array.isArray(departuresData));
                
                // WICHTIG: Die API gibt direkt ein Array zur√ºck!
                const departures = Array.isArray(departuresData) ? departuresData : (departuresData.departures || []);
                
                displaySchedule(station, departures, userLocation, departuresData);
                
            } catch (error) {
                console.error('Error:', error);
                
                let errorMessage = 'Ein Fehler ist aufgetreten.';
                
                if (error.code === 1) {
                    errorMessage = 'Bitte erlauben Sie den Zugriff auf Ihren Standort.';
                } else if (error.code === 2) {
                    errorMessage = 'Standort konnte nicht ermittelt werden.';
                } else if (error.code === 3) {
                    errorMessage = 'Zeit√ºberschreitung bei der Standortermittlung.';
                }
                
                content.innerHTML = `
                    <div class="card">
                        <div class="error">
                            <strong>‚ùå Fehler</strong><br>
                            ${errorMessage}<br>
                            <small>${error.message}</small>
                        </div>
                        <button class="btn btn-primary" onclick="showSchedule()">
                            üîÑ Erneut versuchen
                        </button>
                    </div>
                `;
            }
        }
        
        function displaySchedule(station, departures, location, rawData) {
            const content = document.getElementById('content');
            
            // Distanz berechnen (ungef√§hr)
            const distance = station.distance ? Math.round(station.distance) : '?';
            
            // √ñPNV-Taxi Banner
            let html = `
                <div class="oepnv-banner">
                    <h3>üöï √ñPNV-Taxi</h3>
                    <p>Nur 2‚Ç¨ Aufpreis zum Busticket!</p>
                    <button class="btn btn-success" onclick="bookTaxi()" style="max-width: 300px; margin: 0 auto;">
                        Jetzt buchen
                    </button>
                </div>
            `;
            
            // Stationsinfo
            html += `
                <div class="card">
                    <div class="station-info">
                        <div class="station-name">üìç ${station.name}</div>
                        <div class="station-distance">üìè Ca. ${distance}m entfernt</div>
                    </div>
            `;
            
            if (!departures || departures.length === 0) {
                html += `
                    <div class="empty-state">
                        <div class="empty-state-icon">üïê</div>
                        <h3>Keine Abfahrten</h3>
                        <p>In den n√§chsten 2 Stunden fahren hier keine Busse oder Bahnen.</p>
                    </div>
                `;
                
                if (debugMode) {
                    html += `<div class="debug-info">DEBUG RAW DATA:<br>${JSON.stringify(rawData, null, 2)}</div>`;
                }
            } else {
                // Abfahrten gruppieren nach Verkehrsmittel
                const trains = departures.filter(d => d.line && (d.line.product === 'regional' || d.line.product === 'nationalExpress' || d.line.product === 'national'));
                const buses = departures.filter(d => d.line && d.line.product === 'bus');
                
                if (trains.length > 0) {
                    html += `<h3 style="margin: 20px 0 15px 0; color: #333;">üöÇ Z√ºge</h3>`;
                    trains.slice(0, 5).forEach(dep => {
                        html += formatDeparture(dep);
                    });
                }
                
                if (buses.length > 0) {
                    html += `<h3 style="margin: 20px 0 15px 0; color: #333;">üöå Busse</h3>`;
                    buses.slice(0, 5).forEach(dep => {
                        html += formatDeparture(dep);
                    });
                }
                
                // Falls weder Z√ºge noch Busse, zeige alle
                if (trains.length === 0 && buses.length === 0) {
                    html += `<h3 style="margin: 20px 0 15px 0; color: #333;">üö¶ Alle Abfahrten</h3>`;
                    departures.slice(0, 10).forEach(dep => {
                        html += formatDeparture(dep);
                    });
                }
            }
            
            html += `
                    <button class="btn btn-primary" onclick="showSchedule()" style="margin-top: 20px;">
                        üîÑ Aktualisieren
                    </button>
                </div>
            `;
            
            content.innerHTML = html;
        }
        
        function formatDeparture(departure) {
            const when = new Date(departure.when || departure.plannedWhen);
            const now = new Date();
            const minutesUntil = Math.round((when - now) / 1000 / 60);
            
            const time = when.toLocaleTimeString('de-DE', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            const delay = departure.delay ? departure.delay / 60 : 0;
            const delayText = delay > 0 ? `<span class="delay">+${Math.round(delay)} Min</span>` : '';
            
            let countdownText = '';
            if (minutesUntil < 0) {
                countdownText = '<span class="countdown">Abgefahren</span>';
            } else if (minutesUntil === 0) {
                countdownText = '<span class="countdown">Jetzt</span>';
            } else if (minutesUntil < 60) {
                countdownText = `<span class="countdown">in ${minutesUntil} Min</span>`;
            }
            
            const lineName = departure.line?.name || '?';
            const direction = departure.direction || 'Unbekannt';
            const platform = departure.platform ? ` | Gleis ${departure.platform}` : '';
            
            return `
                <div class="departure-item">
                    <div class="departure-line">${lineName} ‚Üí ${direction}</div>
                    <div class="departure-time">
                        <span class="time-badge">${time}</span>
                        ${countdownText}
                        ${delayText}
                    </div>
                    ${platform ? `<div style="color: #999; font-size: 13px; margin-top: 5px;">${platform}</div>` : ''}
                </div>
            `;
        }
        
        function bookTaxi() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="card">
                    <h2 style="color: #333; margin-bottom: 20px;">üöï Taxi buchen</h2>
                    <p style="color: #666; margin-bottom: 20px;">
                        Rufen Sie uns an oder buchen Sie online:
                    </p>
                    <a href="tel:03837822022" class="btn btn-success" style="text-decoration: none; display: block;">
                        üìû 038378 22022
                    </a>
                    <p style="text-align: center; margin-top: 15px; color: #666; font-size: 14px;">
                        √ñPNV-Taxi: Nur 2‚Ç¨ Aufpreis zum Busticket!
                    </p>
                </div>
            `;
        }
    </script>
</body>
</html>
