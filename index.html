<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Taxi HGW">
    <!-- ğŸ”„ Cache-Control fÃ¼r Updates -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <title>Funk Taxi Heringsdorf</title>
    
    <!-- ğŸ“‹ VERSION INFO -->
    <script>
        console.log('ğŸš• Funk Taxi App v5.38.5 - Build 20251205-1100');
        console.log('ğŸ› DEBUG-TOGGLE SYSTEM!');
        console.log('âœ… Console an/aus fÃ¼r FahrgÃ¤ste!');
        console.log('');
        console.log('ğŸ†• v5.38.5: Debug-Modus Toggle!');
        console.log('âœ… Console standardmÃ¤ÃŸig AUS fÃ¼r FahrgÃ¤ste!');
        console.log('âœ… Debug-Button im Footer (diskret)!');
        console.log('âœ… Test-Buttons entfernt!');
        console.log('âœ… ZÃ¼ge & Busse entfernt!');
        console.log('âœ… Login-Box dezent & klein!');
        console.log('âœ… Header ohne Titel!');
        console.log('');
        console.log('ğŸ”´ OFFLINE-SCHALTER fÃ¼r Buchungssystem!');
        console.log('âœ… ORIGINAL TAXI-APP (ohne Ã–PNV)');
        console.log('âœ… Mit Login & Buchungssystem');
        console.log('âœ… Schnellbuchung mit Autocomplete, Fahrzeuge & Favoriten!');
        console.log('âœ… Alle Original-Features!');
    </script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- ğŸ› Eruda Debug-Panel fÃ¼r Mobile -->
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>
        // Nur auf Nicht-Desktop-GerÃ¤ten aktivieren
        if (!/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
            // Desktop - Eruda nicht laden
        } else {
            // Mobile - Eruda aktivieren
            eruda.init();
            console.log('ğŸ› Debug-Panel aktiviert! Button unten rechts Ã¶ffnen.');
        }
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 22px; margin-bottom: 5px; }
        .status-row { display: flex; justify-content: center; gap: 20px; margin-top: 8px; font-size: 11px; }
        .status-item { display: flex; align-items: center; gap: 8px; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #f59e0b; }
        .sync-dot.online { background: #10b981; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        #gps-indicator { display: none; align-items: center; gap: 8px; font-size: 11px; }
        #gps-dot { width: 8px; height: 8px; border-radius: 50%; background: #6b7280; }
        #gps-dot.online { background: #10b981; animation: pulse 2s infinite; }
        .view-selector { display: flex; background: white; border-bottom: 2px solid #e0e0e0; position: sticky; top: 90px; z-index: 99; }
        .view-btn { flex: 1; padding: 15px; border: none; background: white; font-size: 14px; cursor: pointer; }
        .view-btn.active { color: #667eea; border-bottom: 3px solid #667eea; }
        
        /* ğŸ†• v5.33.1: Admin-Tab Buttons */
        .admin-tab-btn:hover {
            background: #667eea !important;
            color: white !important;
        }
        .admin-tab-btn.active {
            background: #667eea !important;
            color: white !important;
        }
        .view { display: none; padding: 15px; }
        .view.active { display: block; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }
        .input-group input, .input-group select { width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; }
        .btn { padding: 15px 25px; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; width: 100%; }
        .btn-primary { background: #667eea; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-success { background: #10b981; color: white; }
        .alert-success { background: #d1fae5; border: 2px solid #10b981; padding: 15px; border-radius: 8px; margin-bottom: 15px; color: #065f46; }
        .alert-info { background: #dbeafe; border: 2px solid #3b82f6; padding: 15px; border-radius: 8px; margin-bottom: 15px; color: #1e40af; }
        .ride-card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #e0e0e0; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0; }
        .online-toggle { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e0e0e0; }
        .toggle-switch { position: relative; width: 60px; height: 34px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(26px); }
        .available-taxis { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #10b981; }
        .taxi-item { padding: 10px; background: #f0f9ff; border-radius: 6px; margin-top: 8px; }
        #map { height: 300px; border-radius: 8px; margin-top: 15px; }
        .ride-status-box { background: white; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 12px; }
        .eta-display { font-size: 32px; font-weight: bold; margin: 15px 0; }
        .eta-display.green { color: #10b981; }
        .eta-display.yellow { color: #f59e0b; }
        .eta-display.red { color: #ef4444; }
        .progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin: 15px 0; }
        .progress-fill { height: 100%; transition: width 0.3s ease; }
        .autocomplete-dropdown { position: relative; background: white; border: 1px solid #e0e0e0; border-radius: 4px; margin-top: 4px; max-height: 200px; overflow-y: auto; display: none; }
        .autocomplete-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .autocomplete-item:hover { background: #f0f9ff; }
        
        /* DRIVER MAP STYLES */
        #driver-map { height: 450px; border-radius: 12px; margin: 15px 0; border: 3px solid #667eea; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .route-info-box { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .route-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px; }
        .route-stat { text-align: center; padding: 12px; background: rgba(255,255,255,0.2); border-radius: 8px; backdrop-filter: blur(10px); }
        .route-stat-value { font-size: 28px; font-weight: bold; color: white; }
        .route-stat-label { font-size: 12px; color: rgba(255,255,255,0.9); margin-top: 4px; }
        
        /* ğŸ” LOGIN SYSTEM STYLES */
        .user-profile { display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: rgba(255,255,255,0.15); border-radius: 6px; margin-top: 6px; font-size: 11px; }
        .user-avatar { width: 28px; height: 28px; border-radius: 50%; background: white; color: #667eea; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; flex-shrink: 0; }
        .user-info { flex: 1; min-width: 0; overflow: hidden; }
        .user-info > div { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .btn-logout { background: #ef4444; padding: 4px 8px; font-size: 10px; border: none; border-radius: 4px; color: white; cursor: pointer; white-space: nowrap; }
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 10% auto; padding: 30px; border-radius: 12px; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .modal-header { font-size: 24px; font-weight: bold; margin-bottom: 20px; text-align: center; }
        .modal-input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; }
        .modal-btn { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-google { background: white; color: #333; border: 2px solid #e0e0e0; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-primary-modal { background: #667eea; color: white; }
        .modal-divider { text-align: center; margin: 20px 0; color: #999; }
        .modal-link { text-align: center; margin-top: 15px; color: #667eea; cursor: pointer; text-decoration: underline; }
        
        /* ğŸš¨ Admin Alarm Animationen */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        /* ğŸ“± MOBILE RESPONSIVE CSS */
        @media only screen and (max-width: 768px) {
            /* GrÃ¶ÃŸere Touch-Targets */
            .btn { 
                padding: 18px 25px !important; 
                font-size: 16px !important;
                min-height: 50px;
            }
            
            /* ğŸ”§ FIX: Driver Top-Bar auf Mobile - flex-wrap aktivieren */
            #driver-top-bar {
                flex-wrap: wrap !important;
                gap: 6px !important;
                padding: 8px !important;
            }
            
            /* Batterie-Display auf der rechten Seite der ersten Zeile halten */
            #battery-display {
                margin-left: auto !important;
                order: 10 !important;
            }
            
            /* Power-Save und Settings in neuer Zeile auf voller Breite */
            #power-save-btn {
                order: 11 !important;
                flex: 1 !important;
                justify-content: center !important;
                min-width: 45% !important;
            }
            
            #settings-btn {
                order: 12 !important;
                flex: 0 !important;
                min-width: 50px !important;
            }
            
            /* Fahrzeug-Select nicht zu breit */
            #vehicle {
                max-width: 80px !important;
                flex: 0 0 auto !important;
            }
            
            /* Stats kompakter */
            #driver-top-bar > div[style*="font-size: 10px"] {
                font-size: 11px !important;
                white-space: nowrap !important;
            }
            
            /* Online Toggle kleiner auf Mobile */
            #driver-top-bar .toggle-switch {
                transform: scale(0.55) !important;
            }
            
            /* Menu Button */
            #driver-top-bar button[onclick*="toggleDebugPanel"] {
                padding: 6px 8px !important;
            }
            
            /* Input-Felder grÃ¶ÃŸer */
            .input-group input,
            .input-group select {
                padding: 16px !important;
                font-size: 16px !important;
                min-height: 50px;
            }
            
            /* Header kompakter auf Mobile */
            .header {
                padding: 15px 10px !important;
            }
            
            .header h1 {
                font-size: 18px !important;
            }
            
            /* Status-Row responsive */
            .status-row {
                gap: 10px !important;
                font-size: 10px !important;
                flex-wrap: wrap;
            }
            
            /* View-Selector grÃ¶ÃŸer */
            .view-btn {
                padding: 18px 10px !important;
                font-size: 15px !important;
                min-height: 50px;
            }
            
            /* Karten mit mehr Padding */
            .ride-card,
            .stat-card {
                padding: 18px !important;
                font-size: 15px !important;
            }
            
            /* Map auf Mobile hÃ¶her */
            #map,
            #driver-map {
                height: 400px !important;
            }
            
            /* Modal auf Mobile anpassen */
            .modal-content {
                margin: 5% auto !important;
                padding: 25px 20px !important;
                max-width: 95% !important;
            }
            
            /* Online Toggle grÃ¶ÃŸer */
            .toggle-switch {
                width: 70px !important;
                height: 40px !important;
            }
            
            .slider:before {
                height: 32px !important;
                width: 32px !important;
            }
            
            input:checked + .slider:before {
                transform: translateX(30px) !important;
            }
            
            /* Stats Grid auf Mobile single column */
            .stats-grid {
                grid-template-columns: 1fr !important;
            }
            
            /* User Profile kompakter */
            .user-profile {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            /* Telegram Box auf Mobile */
            #telegram-box {
                padding: 15px !important;
            }
            
            #telegram-box input {
                font-size: 16px !important;
                padding: 14px !important;
            }
            
            /* Besseres Spacing auf Mobile */
            .view {
                padding: 12px !important;
            }
            
            /* Alert-Boxen grÃ¶ÃŸer */
            .alert-success,
            .alert-info {
                padding: 16px !important;
                font-size: 14px !important;
            }
        }
        
        /* ğŸ“± Sehr kleine Screens (unter 400px) */
        @media only screen and (max-width: 400px) {
            .header h1 {
                font-size: 16px !important;
            }
            
            .status-row {
                font-size: 9px !important;
            }
            
            .view-btn {
                font-size: 13px !important;
                padding: 15px 5px !important;
            }
        }

        /* ğŸ“± MENÃœ ANIMATIONEN */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* Hamburger Button Hover */
        #menu-toggle-btn:hover {
            background: rgba(255,255,255,0.3) !important;
            transform: translateY(-50%) scale(1.05) !important;
        }

        #menu-toggle-btn:active {
            transform: translateY(-50%) scale(0.95) !important;
        }

        /* 2 HAUPT-TABS: Fahrgast & Verlauf */
        .view-btn {
            transition: all 0.2s !important;
        }

        .view-btn:hover {
            opacity: 0.9 !important;
            transform: translateY(-2px) !important;
        }

        .view-btn:active {
            transform: translateY(0) !important;
        }

        .view-btn.active {
            background: #667eea !important;
            color: white !important;
        }

        .view-btn:not(.active) {
            background: #e5e7eb !important;
            color: #6b7280 !important;
        }

        .view-btn:not(.active):hover {
            background: #d1d5db !important;
            color: #4b5563 !important;
        }
    </style>
</head>
<body>
    <div class="header" id="main-header" style="cursor: pointer; position: relative;" onclick="toggleHeader()">
        <!-- Hamburger Menu Button -->
        <button id="menu-toggle-btn" onclick="toggleMenu(event)" style="
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            color: white;
            z-index: 1001;
            transition: all 0.2s;
        ">â˜°</button>
        
        <div id="header-content">
            <p style="font-size: 11px; opacity: 0.9; margin: 4px 0 0 0; font-weight: 600;">ğŸ“¦ Version 5.38.5 - Login dezent & Header clean (Build 20251205-1000)</p>
            
            <!-- Cache Leeren Button -->
            <button onclick="clearAppCache(event)" style="
                margin-top: 8px;
                padding: 6px 12px;
                background: rgba(255,255,255,0.2);
                border: 1px solid rgba(255,255,255,0.3);
                border-radius: 6px;
                color: white;
                font-size: 11px;
                font-weight: 600;
                cursor: pointer;
                display: inline-flex;
                align-items: center;
                gap: 4px;
            ">
                ğŸ”„ Cache & Daten leeren
            </button>
            
            <div class="status-row" id="header-status-row">
                <div class="status-item">
                    <div class="sync-dot" id="sync-dot"></div>
                    <span id="sync-status">ğŸ’¾ Lokal</span>
                </div>
                <div class="status-item" id="gps-indicator">
                    <div id="gps-dot"></div>
                    <span id="gps-status">ğŸ“ GPS Off</span>
                </div>
                <div class="status-item" id="alerts-indicator" style="display:none;">
                    <span id="sound-status" style="font-size:16px;" title="Sound Status">ğŸ”‡</span>
                    <span id="vibration-status" style="font-size:16px;margin-left:5px;" title="Vibration Status">ğŸ“³</span>
                </div>
            </div>
        </div>
        <div id="header-toggle" style="text-align: center; margin-top: 5px; font-size: 12px; opacity: 0.7;">â–¼</div>
    </div>

    <!-- ğŸ†• v5.33.1: TAB-LEISTE - NUR FÃœR ADMIN! -->
    <div id="admin-tabs" style="
        display: none;
        background: white;
        padding: 10px 15px;
        border-bottom: 2px solid #e5e7eb;
        position: sticky;
        top: 0;
        z-index: 999;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    ">
        <div style="display: flex; gap: 8px; overflow-x: auto; -webkit-overflow-scrolling: touch;">
            <button onclick="switchView('passenger')" class="admin-tab-btn" data-view="passenger" style="
                padding: 10px 16px;
                border: 2px solid #667eea;
                background: white;
                color: #667eea;
                border-radius: 8px;
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
            ">
                ğŸš• Taxi buchen
            </button>
            <button onclick="switchView('schedule')" class="admin-tab-btn" data-view="schedule" style="
                padding: 10px 16px;
                border: 2px solid #667eea;
                background: white;
                color: #667eea;
                border-radius: 8px;
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
            ">
                ğŸšŒğŸš‚ Fahrplan
            </button>
            <button onclick="switchView('history')" class="admin-tab-btn" data-view="history" style="
                padding: 10px 16px;
                border: 2px solid #667eea;
                background: white;
                color: #667eea;
                border-radius: 8px;
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
            ">
                ğŸ“– Verlauf
            </button>
            <button onclick="switchView('driver')" class="admin-tab-btn" data-view="driver" style="
                padding: 10px 16px;
                border: 2px solid #667eea;
                background: white;
                color: #667eea;
                border-radius: 8px;
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
            ">
                ğŸš— Fahrer
            </button>
            <button onclick="switchView('admin')" class="admin-tab-btn" data-view="admin" style="
                padding: 10px 16px;
                border: 2px solid #667eea;
                background: white;
                color: #667eea;
                border-radius: 8px;
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
            ">
                âš™ï¸ Admin
            </button>
        </div>
    </div>

    <!-- ğŸ”” PUSH DEAKTIVIERT - Telegram Ã¼bernimmt! -->

    <!-- ğŸ†• v5.26.0: TELEFON-REGISTRIERUNG / LOGIN SCREEN -->
    <div id="phone-auth-screen" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        z-index: 10000;
        padding: 20px;
        overflow-y: auto;
    ">
        <div style="max-width: 400px; margin: 40px auto;">
            <!-- Logo & Titel -->
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="font-size: 64px; margin-bottom: 10px;">ğŸš•</div>
                <h1 style="color: white; font-size: 24px; margin-bottom: 5px;">Funk Taxi Heringsdorf</h1>
                <p style="color: rgba(255,255,255,0.8); font-size: 14px;">Anmelden um Taxi zu buchen</p>
            </div>
            
            <!-- SCHRITT 1: Telefonnummer eingeben -->
            <div id="phone-step-1" style="background: white; border-radius: 16px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                <h3 style="margin: 0 0 20px 0; font-size: 18px; text-align: center;">ğŸ“± Telefonnummer eingeben</h3>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">Deine Handynummer</label>
                    <div style="display: flex; gap: 8px;">
                        <select id="phone-country-code" style="padding: 14px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; width: 90px;">
                            <option value="+49">ğŸ‡©ğŸ‡ª +49</option>
                            <option value="+43">ğŸ‡¦ğŸ‡¹ +43</option>
                            <option value="+41">ğŸ‡¨ğŸ‡­ +41</option>
                            <option value="+48">ğŸ‡µğŸ‡± +48</option>
                        </select>
                        <input type="tel" id="phone-number-input" placeholder="173 1234567" 
                            style="flex: 1; padding: 14px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;"
                            oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                    </div>
                </div>
                
                <!-- reCAPTCHA Container -->
                <div id="recaptcha-container" style="margin-bottom: 15px;"></div>
                
                <!-- PrimÃ¤rer Button: PrÃ¼ft ob Kunde bekannt ist -->
                <button onclick="checkAndLogin()" id="check-login-btn" style="
                    width: 100%;
                    padding: 16px;
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    color: white;
                    border: none;
                    border-radius: 10px;
                    font-size: 16px;
                    font-weight: 700;
                    cursor: pointer;
                    margin-bottom: 10px;
                ">
                    ğŸ”“ Anmelden
                </button>
                
                <p style="text-align: center; font-size: 12px; color: #999; margin-top: 10px;">
                    Noch nicht registriert? Beim ersten Mal erhÃ¤ltst du einen SMS-Code.
                </p>
            </div>
            
            <!-- SCHRITT 2: Code eingeben (anfangs versteckt) -->
            <div id="phone-step-2" style="display: none; background: white; border-radius: 16px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                <h3 style="margin: 0 0 10px 0; font-size: 18px; text-align: center;">âœ… Code eingeben</h3>
                <p id="phone-sent-to" style="text-align: center; font-size: 13px; color: #666; margin-bottom: 20px;"></p>
                
                <div style="display: flex; gap: 8px; justify-content: center; margin-bottom: 20px;">
                    <input type="text" id="code-1" maxlength="1" class="code-input" style="width: 45px; height: 55px; text-align: center; font-size: 24px; font-weight: bold; border: 2px solid #e5e7eb; border-radius: 8px;" oninput="moveToNext(this, 'code-2')">
                    <input type="text" id="code-2" maxlength="1" class="code-input" style="width: 45px; height: 55px; text-align: center; font-size: 24px; font-weight: bold; border: 2px solid #e5e7eb; border-radius: 8px;" oninput="moveToNext(this, 'code-3')">
                    <input type="text" id="code-3" maxlength="1" class="code-input" style="width: 45px; height: 55px; text-align: center; font-size: 24px; font-weight: bold; border: 2px solid #e5e7eb; border-radius: 8px;" oninput="moveToNext(this, 'code-4')">
                    <input type="text" id="code-4" maxlength="1" class="code-input" style="width: 45px; height: 55px; text-align: center; font-size: 24px; font-weight: bold; border: 2px solid #e5e7eb; border-radius: 8px;" oninput="moveToNext(this, 'code-5')">
                    <input type="text" id="code-5" maxlength="1" class="code-input" style="width: 45px; height: 55px; text-align: center; font-size: 24px; font-weight: bold; border: 2px solid #e5e7eb; border-radius: 8px;" oninput="moveToNext(this, 'code-6')">
                    <input type="text" id="code-6" maxlength="1" class="code-input" style="width: 45px; height: 55px; text-align: center; font-size: 24px; font-weight: bold; border: 2px solid #e5e7eb; border-radius: 8px;" oninput="verifyCodeAuto()">
                </div>
                
                <button onclick="verifyCode()" id="verify-code-btn" style="
                    width: 100%;
                    padding: 16px;
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    color: white;
                    border: none;
                    border-radius: 10px;
                    font-size: 16px;
                    font-weight: 700;
                    cursor: pointer;
                ">
                    âœ… BestÃ¤tigen
                </button>
                
                <div style="text-align: center; margin-top: 15px;">
                    <button onclick="goBackToPhone()" style="background: none; border: none; color: #667eea; font-size: 13px; cursor: pointer;">
                        â† Andere Nummer verwenden
                    </button>
                </div>
                
                <div id="resend-timer" style="text-align: center; font-size: 12px; color: #999; margin-top: 10px;"></div>
            </div>
            
            <!-- Error Message -->
            <div id="phone-auth-error" style="display: none; background: #fef2f2; color: #dc2626; padding: 12px; border-radius: 8px; margin-top: 15px; text-align: center; font-size: 14px;"></div>
        </div>
    </div>

    <!-- ğŸ“± MENÃœ OVERLAY -->
    <div id="menu-overlay" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        animation: fadeIn 0.2s;
    " onclick="closeMenu()">
        <div id="menu-panel" style="
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 280px;
            max-width: 85%;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.3);
            overflow-y: auto;
            animation: slideInRight 0.3s;
        " onclick="event.stopPropagation()">
            <!-- MenÃ¼ Header -->
            <div style="
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px;
                position: sticky;
                top: 0;
                z-index: 1;
            ">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; font-size: 20px;">ğŸ“± MenÃ¼</h2>
                    <button onclick="closeMenu()" style="
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        font-size: 24px;
                        width: 36px;
                        height: 36px;
                        border-radius: 8px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">Ã—</button>
                </div>
            </div>

            <!-- MenÃ¼ Items -->
            <div style="padding: 15px;">
                <div style="font-size: 12px; color: #6b7280; font-weight: 600; margin-bottom: 10px; text-transform: uppercase;">
                    â„¹ï¸ Informationen
                </div>

                <!-- Bus & Zug Fahrplan -->
                <div onclick="openScheduleFromMenu()" style="
                    background: white;
                    border: 2px solid #e5e7eb;
                    border-radius: 12px;
                    padding: 15px;
                    margin-bottom: 12px;
                    cursor: pointer;
                    transition: all 0.2s;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                " onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 2px 8px rgba(59,130,246,0.2)'"
                   onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                    <div style="font-size: 28px;">ğŸšŒğŸš‚</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 700; color: #1f2937; font-size: 15px; margin-bottom: 2px;">
                            Bus & Zug Fahrplan
                        </div>
                        <div style="font-size: 12px; color: #6b7280;">
                            Live-Abfahrten in Ihrer NÃ¤he
                        </div>
                    </div>
                    <div style="color: #3b82f6; font-size: 20px;">â†’</div>
                </div>

                <!-- Mein Verlauf -->
                <div onclick="openHistoryFromMenu()" style="
                    background: white;
                    border: 2px solid #e5e7eb;
                    border-radius: 12px;
                    padding: 15px;
                    margin-bottom: 12px;
                    cursor: pointer;
                    transition: all 0.2s;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                " onmouseover="this.style.borderColor='#667eea'; this.style.boxShadow='0 2px 8px rgba(102,126,234,0.2)'"
                   onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                    <div style="font-size: 28px;">ğŸ“‹</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 700; color: #1f2937; font-size: 15px; margin-bottom: 2px;">
                            Mein Verlauf
                        </div>
                        <div style="font-size: 12px; color: #6b7280;">
                            Ihre Taxifahrten
                        </div>
                    </div>
                    <div style="color: #667eea; font-size: 20px;">â†’</div>
                </div>

                <div style="border-top: 1px solid #e5e7eb; margin: 20px 0;"></div>

                <!-- ZurÃ¼ck zur Buchung -->
                <div onclick="backToBookingFromMenu()" style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border-radius: 12px;
                    padding: 15px;
                    cursor: pointer;
                    text-align: center;
                    font-weight: 700;
                    font-size: 15px;
                    transition: all 0.2s;
                " onmouseover="this.style.opacity='0.9'"
                   onmouseout="this.style.opacity='1'">
                    ğŸš• ZurÃ¼ck zur Buchung
                </div>
            </div>
        </div>
    </div>

    <div id="passenger-view" class="view active">
        <h3 style="margin:0 0 15px 0;">ğŸš• Taxi buchen</h3>
        
        <!-- ğŸ‘¤ MEINE DATEN - Nur fÃ¼r eingeloggte User -->
        <!-- ğŸ†• v5.26.0: EINGELOGGT ALS (Quick-Login) -->
        <div id="quick-login-box" style="display:none; background: rgba(16, 185, 129, 0.1); color: #059669; padding: 8px 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(16, 185, 129, 0.3); font-size: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1; display: flex; align-items: center; gap: 8px;">
                    <span style="opacity: 0.7;">âœ…</span>
                    <span id="quick-login-phone" style="font-weight: 600;"></span>
                </div>
                <div style="display: flex; gap: 6px;">
                    <button onclick="showQuickLoginProfile()" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); color: #059669; padding: 4px 8px; border-radius: 6px; font-size: 11px; cursor: pointer; font-weight: 600;">
                        âœï¸ Profil
                    </button>
                    <button onclick="logoutQuickLogin()" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); color: #059669; padding: 4px 8px; border-radius: 6px; font-size: 11px; cursor: pointer; font-weight: 600;">
                        ğŸšª Abmelden
                    </button>
                </div>
            </div>
        </div>
        
        <div id="my-profile-box" style="display:none; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h4 style="margin: 0; font-size: 16px;">ğŸ‘¤ Mein Konto</h4>
                <button onclick="showMyProfileModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 600;">
                    âœï¸ Bearbeiten
                </button>
            </div>
            <div id="my-profile-info" style="font-size: 13px; line-height: 1.6;"></div>
            <button onclick="useMyProfileData()" style="width: 100%; background: white; color: #1d4ed8; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; margin-top: 10px;">
                âš¡ Meine Daten Ã¼bernehmen
            </button>
        </div>
        
        <!-- ğŸŒŸ STAMMKUNDEN-SCHNELLBUCHUNG -->
        <div id="regular-customer-box" style="display:none; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                <h4 style="margin: 0; font-size: 16px;">ğŸŒŸ Willkommen zurÃ¼ck!</h4>
                <button onclick="clearRegularCustomer()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 6px; font-size: 11px; cursor: pointer; font-weight: 600;">
                    âœ• LÃ¶schen
                </button>
            </div>
            <div id="regular-customer-info" style="font-size: 13px; line-height: 1.6; margin-bottom: 12px;"></div>
            <button onclick="useRegularCustomerData()" style="width: 100%; background: white; color: #059669; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                âš¡ Daten Ã¼bernehmen
            </button>
        </div>
        
        <div id="ride-status-container"></div>
        <div id="booking-form">
            <div class="input-group">
                <label>ğŸ“ Abholort</label>
                <div style="display:flex;gap:8px;align-items:center;">
                    <input type="text" id="pickup" placeholder="z.B. Bahnhof Heringsdorf" style="flex:1;">
                    <button onclick="saveLocationPOI('pickup')" style="padding:12px 14px;border:2px solid #f59e0b;background:#fef3c7;color:#92400e;border-radius:8px;font-weight:600;cursor:pointer;font-size:16px;" title="Ort speichern">
                        â­
                    </button>
                </div>
                
                <!-- ğŸ“ GESPEICHERTE ORTE - Schnellauswahl -->
                <div id="pickup-saved-locations" style="display:none;margin-top:8px;"></div>
                
                <button onclick="useMyLocation()" style="margin-top:8px;padding:12px;border:2px solid #3b82f6;background:#dbeafe;color:#1e40af;border-radius:8px;font-weight:600;cursor:pointer;width:100%;">ğŸ“ Meinen Standort verwenden</button>
                <div class="autocomplete-dropdown" id="pickup-dropdown"></div>
            </div>
            
            <div class="input-group">
                <label>ğŸ¯ Zielort</label>
                <div style="display:flex;gap:8px;align-items:center;">
                    <input type="text" id="destination" placeholder="z.B. SeebrÃ¼cke Ahlbeck" style="flex:1;">
                    <button onclick="saveLocationPOI('destination')" style="padding:12px 14px;border:2px solid #f59e0b;background:#fef3c7;color:#92400e;border-radius:8px;font-weight:600;cursor:pointer;font-size:16px;" title="Ort speichern">
                        â­
                    </button>
                </div>
                
                <!-- ğŸ“ GESPEICHERTE ORTE - Schnellauswahl -->
                <div id="destination-saved-locations" style="display:none;margin-top:8px;"></div>
                
                <div class="autocomplete-dropdown" id="destination-dropdown"></div>
            </div>
            
            <!-- ğŸ†• v5.30.0: WANN MÃ–CHTEN SIE FAHREN? -->
            <div class="input-group" style="margin-top:25px;">
                <label style="font-size:16px;font-weight:700;margin-bottom:15px;display:block;">â±ï¸ Wann mÃ¶chten Sie fahren?</label>
                
                <div id="ride-type-buttons-container" style="display:grid;grid-template-columns:1fr;gap:12px;">
                    <!-- SOFORT Button - ğŸ†• v5.32.5g: Initial versteckt, nur wenn Fahrer verfÃ¼gbar -->
                    <button id="btn-sofort" onclick="selectRideType('sofort')" style="display:none;padding:20px 15px;border:3px solid #10b981;background:white;border-radius:12px;cursor:pointer;transition:all 0.3s;">
                        <div style="font-size:32px;margin-bottom:8px;">âš¡</div>
                        <div style="font-weight:700;font-size:16px;color:#059669;margin-bottom:4px;">SOFORT</div>
                        <div style="font-size:12px;color:#666;">NÃ¤chstes verfÃ¼gbares Taxi</div>
                    </button>
                    
                    <!-- VORBESTELLEN Button -->
                    <button id="btn-vorbestellen" onclick="selectRideType('vorbestellen')" style="padding:20px 15px;border:3px solid #e5e7eb;background:white;border-radius:12px;cursor:pointer;transition:all 0.3s;">
                        <div style="font-size:32px;margin-bottom:8px;">ğŸ“…</div>
                        <div style="font-weight:700;font-size:16px;color:#6b7280;margin-bottom:4px;">VORBESTELLEN</div>
                        <div style="font-size:12px;color:#666;">Datum & Zeit wÃ¤hlen</div>
                    </button>
                </div>
            </div>
            
            <!-- ğŸš• SOFORT-BEREICH: VerfÃ¼gbare Taxis -->
            <div id="sofort-bereich" style="display:none;">
                <div id="available-taxis-display"></div>
            </div>
            
            <!-- ğŸ“… VORBESTELLEN-BEREICH: Datum & Zeit direkt wÃ¤hlen -->
            <div id="vorbestellen-bereich" style="display:none;">
                <div class="input-group">
                    <label>ğŸ“… Abholzeit wÃ¤hlen</label>
                    
                    <!-- Datum + Zeit direkt (ohne Dropdown!) -->
                    <div id="custom-datetime-container" style="margin-top:0;">
                        <input type="date" id="custom-date" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:15px;width:100%;margin-bottom:8px;">
                        <div style="display:flex;gap:8px;align-items:center;">
                            <select id="custom-hour" style="flex:1;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:15px;">
                                <option value="00">00</option><option value="01">01</option><option value="02">02</option>
                                <option value="03">03</option><option value="04">04</option><option value="05">05</option>
                                <option value="06">06</option><option value="07">07</option><option value="08">08</option>
                                <option value="09">09</option><option value="10">10</option><option value="11">11</option>
                                <option value="12">12</option><option value="13">13</option><option value="14">14</option>
                                <option value="15">15</option><option value="16">16</option><option value="17">17</option>
                                <option value="18">18</option><option value="19">19</option><option value="20">20</option>
                                <option value="21">21</option><option value="22">22</option><option value="23">23</option>
                            </select>
                            <span style="font-size:20px;font-weight:bold;">:</span>
                            <select id="custom-minute" style="flex:1;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:15px;">
                                <option value="00">00</option><option value="05">05</option><option value="10">10</option>
                                <option value="15">15</option><option value="20">20</option><option value="25">25</option>
                                <option value="30">30</option><option value="35">35</option><option value="40">40</option>
                                <option value="45">45</option><option value="50">50</option><option value="55">55</option>
                            </select>
                            <span style="font-size:14px;color:#666;">Uhr</span>
                        </div>
                    </div>
                    <div id="datetime-help" style="margin-top:8px;padding:10px;background:#dbeafe;border-radius:6px;font-size:13px;color:#1e40af;">
                        ğŸ’¡ <strong>Tipp:</strong> Ideal fÃ¼r Flughafentransfers oder Hotel-Buchungen im Voraus!
                    </div>
                </div>
            </div>
            
            <div class="input-group">
                <label>ğŸ‘¤ Ihr Name</label>
                <input type="text" id="customer-name" placeholder="z.B. Max Mustermann">
            </div>
            <div class="input-group">
                <label>ğŸ“ Telefonnummer *</label>
                <input type="tel" id="customer-phone" placeholder="z.B. 0173 1234567" required oninput="checkPhoneInCRM()">
                <div id="crm-greeting" style="display:none;margin-top:8px;padding:12px;background:linear-gradient(135deg,#10b981,#059669);color:white;border-radius:8px;font-size:14px;">
                </div>
                <div style="font-size:12px;color:#666;margin-top:5px;">
                    Pflichtfeld â€“ fÃ¼r RÃ¼ckfragen durch den Fahrer
                </div>
                <div style="margin-top:8px;padding:10px;background:#f0f9ff;border:1px solid #bfdbfe;border-radius:6px;font-size:12px;color:#1e40af;">
                    ğŸ“² <strong>Nach der Buchung:</strong> Sie erhalten SMS + Telegram mit Tracking-Link!<br>
                    ğŸ’¬ <em>FÃ¼r Telegram:</em> <a href="https://t.me/${TELEGRAM_BOT_USERNAME}" target="_blank" style="color:#1e40af;text-decoration:underline;">Bot starten</a> und verknÃ¼pfen
                </div>
            </div>
            <div class="input-group">
                <label>ğŸ‘¥ Personen</label>
                <select id="passengers">
                    <option value="1">1 Person</option>
                    <option value="2">2 Personen</option>
                    <option value="3">3 Personen</option>
                    <option value="4">4 Personen</option>
                </select>
            </div>
            <button id="price-btn" class="btn btn-primary" onclick="handlePriceButton()">ğŸ’° Preis berechnen</button>
            <div id="price-display" style="margin-top: 15px;"></div>
            <div id="route-map" style="height: 300px; margin-top: 15px; border-radius: 8px; overflow: hidden; display: none;"></div>
            
            <!-- CRM Speicher-Option -->
            <div id="crm-save-option" style="display:none;margin-top:15px;padding:12px;background:#f0fdf4;border:2px solid #10b981;border-radius:8px;">
                <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                    <input type="checkbox" id="save-to-crm" checked style="width:20px;height:20px;accent-color:#10b981;">
                    <span style="font-size:14px;">
                        <strong>ğŸ“‹ Kundendaten im CRM aktualisieren</strong><br>
                        <span style="font-size:12px;color:#666;">Adresse und Telefon werden gespeichert</span>
                    </span>
                </label>
            </div>
            
            <!-- ğŸ’³ ZAHLUNGSMETHODE -->
            <div class="input-group" style="margin-top:15px;">
                <label>ğŸ’³ Zahlungsmethode</label>
                <select id="payment-method" style="padding:14px;border:2px solid #10b981;border-radius:8px;font-size:15px;font-weight:600;background:white;color:#333;cursor:pointer;width:100%;">
                    <option value="bar">ğŸ’¶ Bar (Bargeld)</option>
                    <option value="karte">ğŸ’³ EC-Karte / Kreditkarte</option>
                    <option value="paypal">ğŸ“± PayPal / Digitale Zahlung</option>
                    <option value="rechnung">ğŸ§¾ Rechnung (Firmenkunden)</option>
                </select>
                <div style="font-size:12px;color:#666;margin-top:5px;">
                    â„¹ï¸ Der Fahrer sieht Ihre Zahlungsmethode
                </div>
            </div>
            
            <button id="book-btn" class="btn btn-success" onclick="book()" style="margin-top: 10px; display: none;">ğŸš• Taxi buchen</button>
        </div>
        
        <!-- ğŸ†• v5.38.2: OFFLINE MESSAGE -->
        <div id="offline-message" style="display:none;padding:25px;background:linear-gradient(135deg,#ef4444,#dc2626);border-radius:12px;color:white;text-align:center;margin-bottom:20px;">
            <div style="font-size:48px;margin-bottom:15px;">ğŸ”´</div>
            <div style="font-size:20px;font-weight:700;margin-bottom:10px;">Buchungssystem offline</div>
            <div style="font-size:14px;margin-bottom:20px;opacity:0.9;">
                Aktuell kÃ¶nnen keine Online-Buchungen angenommen werden.
            </div>
            <div style="padding:20px;background:rgba(255,255,255,0.15);border-radius:10px;margin-bottom:20px;">
                <div style="font-size:16px;font-weight:600;margin-bottom:8px;">Bitte rufen Sie uns an:</div>
                <a href="tel:+4915229117722" style="font-size:32px;font-weight:700;color:white;text-decoration:none;display:block;">
                    ğŸ“ 0152 29117722
                </a>
            </div>
            <div style="font-size:12px;opacity:0.8;">
                Wir sind gerne fÃ¼r Sie da und nehmen Ihre Buchung telefonisch entgegen!
            </div>
        </div>
        
        <div id="confirm"></div>
        
        <!-- ğŸ§¹ Cache-Button fÃ¼r ALLE sichtbar -->
        <div style="margin-top:30px;padding:15px;background:#f0f9ff;border-radius:8px;text-align:center;">
            <p style="font-size:13px;color:#666;margin-bottom:10px;">
                âš ï¸ Probleme mit der App? Alte Version wird angezeigt?
            </p>
            <button onclick="clearAppCache()" style="padding:12px 24px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                ğŸ§¹ Cache leeren & App neu laden
            </button>
        </div>
    </div>

    <!-- ğŸ†• v5.32.6: FAHRPLAN-VIEW - Bus & Zug Live-Fahrplan -->
    <div id="schedule-view" class="view">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;gap:8px;">
            <h3 style="margin:0;flex:1;">ğŸšŒğŸš‚ Fahrplan</h3>
            <button onclick="switchView('passenger')" class="view-btn" style="padding:10px 15px;background:#667eea;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;">
                ğŸš• Taxi buchen
            </button>
        </div>
        
        <!-- Standort & Aktualisieren -->
        <div style="background:#dbeafe;padding:15px;border-radius:12px;margin-bottom:15px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div style="flex:1;">
                    <div style="font-size:12px;color:#1e40af;margin-bottom:4px;">ğŸ“ Dein Standort:</div>
                    <div id="schedule-location" style="font-weight:600;color:#1e3a8a;">Wird geladen...</div>
                </div>
                <button onclick="refreshSchedule()" style="padding:10px 15px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">
                    ğŸ”„ Aktualisieren
                </button>
            </div>
        </div>
        
        <!-- NÃ¤chste Haltestelle -->
        <div id="schedule-nearest-stop" style="margin-bottom:15px;"></div>
        
        <!-- Ã–PNV-Taxi Angebot -->
        <!-- Ã–PNV-Taxi Angebot - Kompakt -->
        <div style="background:linear-gradient(135deg, #10b981 0%, #059669 100%);color:white;padding:12px 16px;border-radius:10px;margin-bottom:15px;box-shadow:0 2px 8px rgba(16, 185, 129, 0.3);display:flex;align-items:center;justify-content:space-between;">
            <div style="flex:1;">
                <div style="font-size:15px;font-weight:700;margin-bottom:2px;">ğŸš• Ã–PNV-Taxi verfÃ¼gbar</div>
                <div style="font-size:12px;opacity:0.9;">Bus-Preis + nur 2â‚¬ Aufpreis</div>
            </div>
            <button onclick="switchView('passenger')" style="padding:10px 20px;background:white;color:#059669;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px;white-space:nowrap;">
                Jetzt buchen
            </button>
        </div>
        </div>
        
        <!-- Info -->
        <div style="background:#fef3c7;padding:12px;border-radius:8px;font-size:13px;color:#78350f;">
            <strong>ğŸ’¡ Hinweis:</strong> Fahrplandaten werden live von der Deutschen Bahn API abgerufen und enthalten Echtzeit-VerspÃ¤tungen.
        </div>
    </div>

    <div id="history-view" class="view">
        <h3 style="margin: 20px 0;">Meine Fahrten</h3>
        
        <!-- ğŸ“… TABS fÃ¼r Kommende / Vergangene Fahrten -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button id="tab-upcoming" onclick="showHistoryTab('upcoming')" style="flex: 1; padding: 12px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 8px; font-weight: 600; cursor: pointer;">
                ğŸ“… Kommende Fahrten
            </button>
            <button id="tab-past" onclick="showHistoryTab('past')" style="flex: 1; padding: 12px; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 8px; font-weight: 600; cursor: pointer;">
                ğŸ“– Vergangene Fahrten
            </button>
        </div>
        
        <div id="history-list"></div>
        
        <!-- ğŸ§¹ Cache-Button fÃ¼r alle -->
        <div style="margin-top:30px;padding:15px;background:#f0f9ff;border-radius:8px;text-align:center;">
            <p style="font-size:13px;color:#666;margin-bottom:10px;">
                âš ï¸ Probleme mit der App? Alte Version wird angezeigt?
            </p>
            <button onclick="clearAppCache()" style="padding:12px 24px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                ğŸ§¹ Cache leeren & App neu laden
            </button>
        </div>
    </div>

    <!-- ğŸ†• v5.27.0: KALENDER VIEW -->

    <div id="driver-view" class="view">
        <!-- ğŸ¯ DESIGN C: FULLSCREEN MAP - Google Maps Style -->
        
        <!-- Ultra-Mini Top Bar (transparent, sticky) -->
        <div id="driver-top-bar" style="
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 8px 10px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        ">
            <!-- GPS Status Indicator -->
            <div id="gps-status-compact" style="
                display: flex;
                align-items: center;
                gap: 4px;
                padding: 4px 8px;
                background: rgba(239,68,68,0.1);
                border-radius: 12px;
                font-size: 11px;
                color: #ef4444;
            ">
                <span id="gps-icon-compact">âŒ</span>
                <span id="gps-text-compact">GPS</span>
            </div>
            
            <!-- Stornierung Badge (NEU!) -->
            <button id="cancellation-badge" onclick="showCancellationPanel()" style="
                display: none;
                background: #ef4444;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 20px;
                font-weight: bold;
                cursor: pointer;
                font-size: 13px;
                animation: pulse 1s infinite;
            ">
                ğŸš¨ <span id="cancellation-count">0</span>
            </button>
            
            <!-- Neue AuftrÃ¤ge Button -->
            <button onclick="toggleNewRidesPanel()" style="
                background: #667eea;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 20px;
                font-weight: bold;
                cursor: pointer;
                font-size: 13px;
            ">
                ğŸ“‹ <span id="new-rides-count">0</span>
            </button>
            
            <!-- Fahrzeug Select -->
            <select id="vehicle" onchange="setVehicle()" style="
                padding: 6px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 12px;
                flex: 1;
                max-width: 110px;
            ">
                <option value="">Fzg.</option>
                <option value="tesla_model3_1">#1</option>
                <option value="tesla_model3_2">#2</option>
                <option value="tesla_model3_3">#3</option>
                <option value="tesla_modely_1">Y#1</option>
                <option value="tesla_modely_2">Y#2</option>
            </select>
            
            <!-- Stats Mini -->
            <div style="font-size: 10px; color: #666; white-space: nowrap;">
                <span id="d-rides">0</span>â†‘ <span id="d-money">0â‚¬</span>
            </div>
            
            <!-- Online Toggle Mini -->
            <label class="toggle-switch" style="transform: scale(0.6);">
                <input type="checkbox" id="online-toggle" onchange="toggleOnline()" disabled style="opacity: 0.5; cursor: not-allowed;">
                <span class="slider"></span>
            </label>
            
            <!-- Menu Button -->
            <button onclick="toggleDebugPanel()" style="
                background: rgba(102,126,234,0.2);
                color: #667eea;
                border: none;
                padding: 6px 10px;
                border-radius: 6px;
                cursor: pointer;
                font-weight: bold;
            ">
                â‰¡
            </button>
        </div>
        
        <!-- Debug Panel (versteckt by default) -->
        <div id="debug-panel" style="
            display: none;
            padding: 10px;
            background: #f3f4f6;
            font-size: 11px;
            color: #666;
        ">
            FB: <span id="debug-firebase">â“</span> | 
            Fahrten: <span id="debug-rides">â“</span> | 
            Neu: <span id="debug-new">â“</span> | 
            Sync: <span id="debug-sync">â“</span>
            
            <!-- ğŸ†• v5.18.0: TELEGRAM FÃœR FAHRER -->
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                <b>ğŸ“± Telegram-Alarm aktivieren:</b>
                <div style="margin-top: 8px; display: flex; gap: 8px; align-items: center;">
                    <input type="text" id="driver-telegram-id" placeholder="Deine Chat-ID" style="
                        flex: 1;
                        padding: 8px;
                        border: 1px solid #ccc;
                        border-radius: 6px;
                        font-size: 12px;
                    ">
                    <button onclick="saveDriverTelegramId()" style="
                        padding: 8px 12px;
                        background: #0088cc;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        font-size: 12px;
                        cursor: pointer;
                    ">ğŸ’¾</button>
                    <button onclick="testDriverTelegram()" style="
                        padding: 8px 12px;
                        background: #10b981;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        font-size: 12px;
                        cursor: pointer;
                    ">ğŸ“¤ Test</button>
                </div>
                <div id="driver-telegram-status" style="margin-top: 6px; font-size: 10px; color: #888;">
                    â“ Noch nicht eingerichtet
                </div>
                <div style="margin-top: 6px; font-size: 10px; color: #666;">
                    Hol dir deine Chat-ID: Schreibe /getid an <a href="https://t.me/myidbot" target="_blank" style="color: #0088cc;">@myidbot</a>
                </div>
            </div>
        </div>
        
        <!-- Neue AuftrÃ¤ge Slide-In Panel mit TABS! -->
        <div id="new-rides-panel" style="
            display: none;
            padding: 0;
            background: white;
            max-height: 60vh;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        ">
            <!-- Tabs -->
            <div style="
                display: flex;
                background: #f3f4f6;
                border-bottom: 2px solid #e0e0e0;
                position: sticky;
                top: 0;
                z-index: 10;
            ">
                <button onclick="switchRidesTab('new')" id="rides-tab-new" class="rides-tab active" style="
                    flex: 1;
                    padding: 12px;
                    background: white;
                    border: none;
                    border-bottom: 3px solid #667eea;
                    font-weight: 600;
                    cursor: pointer;
                    font-size: 13px;
                ">
                    ğŸ“‹ Neu
                </button>
                <button onclick="switchRidesTab('completed')" id="rides-tab-completed" class="rides-tab" style="
                    flex: 1;
                    padding: 12px;
                    background: transparent;
                    border: none;
                    border-bottom: 3px solid transparent;
                    font-weight: 600;
                    cursor: pointer;
                    font-size: 13px;
                    color: #666;
                ">
                    âœ… Fertig
                </button>
                <button onclick="switchRidesTab('cancelled')" id="rides-tab-cancelled" class="rides-tab" style="
                    flex: 1;
                    padding: 12px;
                    background: transparent;
                    border: none;
                    border-bottom: 3px solid transparent;
                    font-weight: 600;
                    cursor: pointer;
                    font-size: 13px;
                    color: #666;
                ">
                    ğŸš¨ Storniert
                </button>
            </div>
            
            <!-- Tab Content -->
            <div style="padding: 10px;">
                <div id="new-rides"></div>
                <div id="completed-rides" style="display: none;"></div>
                <div id="cancelled-rides" style="display: none;"></div>
            </div>
        </div>
        
        <style>
            .rides-tab.active {
                background: white !important;
                border-bottom-color: #667eea !important;
                color: #667eea !important;
            }
        </style>
        
        <script>
            function switchRidesTab(tab) {
                // Hide all content
                document.getElementById('new-rides').style.display = 'none';
                document.getElementById('completed-rides').style.display = 'none';
                document.getElementById('cancelled-rides').style.display = 'none';
                
                // Remove active from all tabs
                document.querySelectorAll('.rides-tab').forEach(t => {
                    t.classList.remove('active');
                    t.style.background = 'transparent';
                    t.style.borderBottomColor = 'transparent';
                    t.style.color = '#666';
                });
                
                // Show selected content & activate tab
                if (tab === 'new') {
                    document.getElementById('new-rides').style.display = 'block';
                    document.getElementById('rides-tab-new').classList.add('active');
                } else if (tab === 'completed') {
                    document.getElementById('completed-rides').style.display = 'block';
                    document.getElementById('rides-tab-completed').classList.add('active');
                    loadCompletedRides();
                } else if (tab === 'cancelled') {
                    document.getElementById('cancelled-rides').style.display = 'block';
                    document.getElementById('rides-tab-cancelled').classList.add('active');
                    loadCancelledRides();
                }
            }
            
            function loadCompletedRides() {
                const myRides = currentVehicle ? rides.filter(r => r.vehicleId === currentVehicle || r.vehicle === (VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle)) : [];
                const completed = myRides.filter(r => r.status === 'completed');
                
                if (completed.length === 0) {
                    document.getElementById('completed-rides').innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Keine abgeschlossenen Fahrten</div>';
                    return;
                }
                
                // ğŸ†• v5.25.6: Mit Zeitstempel anzeigen
                let html = completed.map(r => {
                    // Buchungszeit formatieren
                    let buchungZeit = '?';
                    if (r.timestamp || r.createdAt) {
                        const bookingDate = new Date(r.timestamp || r.createdAt);
                        buchungZeit = bookingDate.toLocaleString('de-DE', {
                            day: '2-digit', month: '2-digit', 
                            hour: '2-digit', minute: '2-digit'
                        });
                    }
                    
                    // Abschlusszeit formatieren
                    let abschlussZeit = '?';
                    if (r.completedAt) {
                        const completeDate = new Date(r.completedAt);
                        abschlussZeit = completeDate.toLocaleString('de-DE', {
                            day: '2-digit', month: '2-digit', 
                            hour: '2-digit', minute: '2-digit'
                        });
                    }
                    
                    return `
                    <div class="ride-card" style="background:#f0fdf4;border-left:4px solid #10b981;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <span style="font-size:11px;color:#888;">ğŸ“… ${buchungZeit}</span>
                            <span style="background:#10b981;color:white;padding:4px 8px;border-radius:12px;font-size:11px;">âœ… Fertig</span>
                        </div>
                        ${r.customerName ? `<div style="font-weight:600;color:#065f46;margin-bottom:5px;">ğŸ‘¤ ${r.customerName}</div>` : ''}
                        <div style="font-size:13px;color:#666;">
                            Von: ${r.pickup}<br>
                            Nach: ${r.destination}<br>
                            Preis: <strong>${r.price}â‚¬</strong> â€¢ ${r.distance} km<br>
                            <span style="font-size:11px;color:#10b981;">âœ… Abgeschlossen: ${abschlussZeit}</span>
                        </div>
                    </div>
                `}).join('');
                
                document.getElementById('completed-rides').innerHTML = html;
            }
            
            function loadCancelledRides() {
                // ğŸ†• v5.20.8: Auch assignedTo prÃ¼fen (nicht nur vehicleId)!
                const myRides = currentVehicle ? rides.filter(r => 
                    r.vehicleId === currentVehicle || 
                    r.assignedTo === currentVehicle ||
                    r.vehicle === (VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle)
                ) : [];
                const cancelled = myRides.filter(r => r.status === 'cancelled' || r.status === 'cancelled_pending_driver' || r.status === 'storniert');
                
                if (cancelled.length === 0) {
                    document.getElementById('cancelled-rides').innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Keine stornierten Fahrten</div>';
                    return;
                }
                
                // ğŸ†• v5.20.7: Mit Uhrzeiten anzeigen
                let html = cancelled.map(r => {
                    // Buchungszeit formatieren
                    let buchungZeit = '?';
                    if (r.timestamp || r.createdAt) {
                        const bookingDate = new Date(r.timestamp || r.createdAt);
                        buchungZeit = bookingDate.toLocaleString('de-DE', {
                            day: '2-digit', month: '2-digit', 
                            hour: '2-digit', minute: '2-digit'
                        });
                    }
                    
                    // Stornierungszeit formatieren
                    let stornoZeit = '?';
                    if (r.cancelledAt) {
                        const cancelDate = new Date(r.cancelledAt);
                        stornoZeit = cancelDate.toLocaleString('de-DE', {
                            day: '2-digit', month: '2-digit', 
                            hour: '2-digit', minute: '2-digit'
                        });
                    }
                    
                    // Abholzeit formatieren (falls Vorbestellung)
                    let abholZeit = '';
                    if (r.pickupTime && r.pickupTime !== 'Sofort') {
                        abholZeit = `â° Geplant: ${r.pickupTime}<br>`;
                    }
                    
                    return `
                    <div class="ride-card" style="background:#fef2f2;border-left:4px solid #ef4444;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <span style="font-size:11px;color:#888;">ğŸ“… ${buchungZeit}</span>
                            <span style="background:#ef4444;color:white;padding:4px 8px;border-radius:12px;font-size:11px;">ğŸš¨ Storniert</span>
                        </div>
                        ${r.customerName ? `<div style="font-weight:600;color:#991b1b;margin-bottom:5px;">ğŸ‘¤ ${r.customerName}</div>` : ''}
                        <div style="font-size:13px;color:#666;">
                            ğŸ“ Von: ${r.pickup}<br>
                            ğŸ¯ Nach: ${r.destination}<br>
                            ${abholZeit}
                            ğŸ’° Preis: ${r.price || '?'}â‚¬<br>
                            ${r.cancellationFee ? `<strong style="color:#dc2626;">ğŸ’¶ StornogebÃ¼hr: ${r.cancellationFee.toFixed(2)}â‚¬</strong><br>` : ''}
                            âŒ Storniert: ${stornoZeit}<br>
                            ${r.cancellationReason ? `ğŸ“ Grund: ${r.cancellationReason}` : ''}
                        </div>
                    </div>
                `;
                }).join('');
                
                document.getElementById('cancelled-rides').innerHTML = html;
            }
        </script>
        
        <!-- ğŸš¨ STORNIERUNG PANEL (NEU!) -->
        <div id="cancellation-panel" style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            padding: 20px;
            overflow-y: auto;
        ">
            <div id="cancellation-list" style="
                background: white;
                border-radius: 12px;
                padding: 20px;
                max-width: 500px;
                margin: 0 auto;
            "></div>
        </div>
        
        <!-- ğŸš• NEUER AUFTRAG FULLSCREEN POPUP (NEU!) -->
        <div id="new-ride-fullscreen" style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 10002;
            padding: 15px;
            overflow-y: auto;
            display: none;
            align-items: center;
            justify-content: center;
        ">
            <div style="
                background: white;
                border-radius: 16px;
                padding: 0;
                max-width: 380px;
                width: 100%;
                margin: 20px auto;
                box-shadow: 0 10px 40px rgba(0,0,0,0.4);
                overflow: hidden;
            ">
                <!-- Header - kompakter -->
                <div style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    padding: 15px;
                    text-align: center;
                    position: relative;
                ">
                    <button onclick="closeNewRideFullscreen()" style="
                        position: absolute;
                        top: 8px;
                        right: 8px;
                        background: rgba(0,0,0,0.4);
                        color: white;
                        border: 2px solid white;
                        width: 36px;
                        height: 36px;
                        border-radius: 50%;
                        font-size: 20px;
                        cursor: pointer;
                        font-weight: bold;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">âœ•</button>
                    
                    <div style="font-size: 40px; margin-bottom: 5px;">ğŸš•</div>
                    <div style="font-size: 22px; font-weight: bold; color: white;">
                        NEUE FAHRT!
                    </div>
                </div>
                
                <!-- Content -->
                <div id="new-ride-fullscreen-content" style="padding: 15px;">
                    <!-- Wird dynamisch gefÃ¼llt -->
                </div>
                </div>
            </div>
        </div>
        
        <!-- FULLSCREEN KARTE Container -->
        <div id="driver-route-info" style="
            display: none;
            position: relative;
            height: calc(100vh - 150px);
        ">
            <!-- ğŸ´ CARDS INFO TOP (A3/B3 Design) -->
            <div id="driver-cards-container" style="
                padding: 10px;
                background: white;
                box-shadow: 0 2px 6px rgba(0,0,0,0.1);
                display: grid;
                gap: 8px;
            ">
                <!-- Kunde Card (mit Telefon) -->
                <div id="driver-customer-card" style="
                    background: #f8f9fa;
                    padding: 10px;
                    border-radius: 8px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    border-left: 4px solid #667eea;
                ">
                    <div style="flex: 1;">
                        <div style="font-size: 10px; color: #999; text-transform: uppercase; margin-bottom: 3px;">
                            Kunde
                        </div>
                        <div id="driver-customer-name" style="font-size: 14px; font-weight: 600; color: #333;">
                            ğŸ‘¤ Kunde
                        </div>
                    </div>
                    <button id="driver-call-button" onclick="callCustomer()" style="
                        background: #10b981;
                        color: white;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 16px;
                        font-size: 12px;
                        font-weight: 600;
                        cursor: pointer;
                        display: none;
                    ">ğŸ“</button>
                </div>
                
                <!-- Preis Card (nur bei picked_up) -->
                <div id="driver-price-card" style="
                    background: #f8f9fa;
                    padding: 10px;
                    border-radius: 8px;
                    border-left: 4px solid #10b981;
                    display: none;
                ">
                    <div style="font-size: 10px; color: #999; text-transform: uppercase; margin-bottom: 3px;">
                        Preis
                    </div>
                    <div id="driver-price-value" style="font-size: 14px; font-weight: 600; color: #333;">
                        ğŸ’° -
                    </div>
                </div>
                
                <!-- Pickup Card (nur bei accepted) -->
                <div id="driver-pickup-card" style="
                    background: #f8f9fa;
                    padding: 10px;
                    border-radius: 8px;
                    border-left: 4px solid #667eea;
                    display: none;
                ">
                    <div style="font-size: 10px; color: #999; text-transform: uppercase; margin-bottom: 3px;">
                        ğŸ“ Abholen
                    </div>
                    <div id="driver-pickup-value" style="font-size: 14px; font-weight: 600; color: #333;">
                        -
                    </div>
                </div>
                
                <!-- Destination Card -->
                <div id="driver-dest-card" style="
                    background: #ecfdf5;
                    padding: 10px;
                    border-radius: 8px;
                    border-left: 4px solid #10b981;
                ">
                    <div style="font-size: 10px; color: #059669; text-transform: uppercase; margin-bottom: 3px;">
                        ğŸ¯ Ziel
                    </div>
                    <div id="driver-dest-value" style="font-size: 14px; font-weight: 600; color: #065f46;">
                        -
                    </div>
                </div>
                
                <!-- Action Button -->
                <button id="driver-action-button" style="
                    width: 100%;
                    padding: 12px;
                    background: #667eea;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    font-size: 14px;
                    cursor: pointer;
                ">ğŸš— Beim Kunden angekommen</button>
            </div>
            
            <!-- âŒ KARTE ENTFERNT - NUR INFO! -->
            
            <!-- Turn-by-Turn Central Overlay (GROÃŸ in der Mitte) -->
            <div id="turn-by-turn" style="
                display: none;
                position: absolute;
                top: 60px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(255,255,255,0.98);
                border-radius: 16px;
                padding: 20px 30px;
                text-align: center;
                box-shadow: 0 8px 24px rgba(0,0,0,0.3);
                backdrop-filter: blur(10px);
                border: 3px solid #667eea;
                z-index: 900;
            ">
                <div style="font-size: 56px; color: #667eea; margin-bottom: 8px;" id="turn-icon">â†‘</div>
                <div style="font-size: 36px; font-weight: bold; color: #333; margin-bottom: 5px;" id="turn-distance">150m</div>
                <div style="font-size: 18px; color: #666;" id="turn-instruction">Geradeaus</div>
            </div>
            
            <!-- Bottom Panel - Nur ETA -->
            <div id="bottom-panel" style="
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                padding: 10px;
                box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
                text-align: center;
                font-size: 12px;
                color: #666;
                z-index: 900;
            ">
                <span><b id="route-distance">-</b>km</span>
                <span> â€¢ </span>
                <span><b id="route-duration">-</b>min</span>
                <span> â€¢ </span>
                <span>ETA <b id="route-eta">-</b></span>
            </div>
        </div>
        
        <!-- Ready State (wenn keine Fahrt) - NUR FÃœR FAHRER -->
        <div id="driver-ready" style="
            display: none;
            padding: 80px 20px;
            text-align: center;
        ">
            <div style="font-size: 80px; margin-bottom: 20px;">ğŸš•</div>
            <div style="font-size: 28px; font-weight: 600; color: #667eea; margin-bottom: 10px;">Bereit!</div>
            <div style="font-size: 14px; color: #999;">WÃ¤hle Fahrzeug & gehe Online</div>
        </div>
        
        <script>
            // ğŸ“± HEADER TOGGLE
            let headerCollapsed = false;
            function toggleHeader() {
                const header = document.getElementById('main-header');
                const content = document.getElementById('header-content');
                const toggle = document.getElementById('header-toggle');
                
                headerCollapsed = !headerCollapsed;
                
                if (headerCollapsed) {
                    content.style.display = 'none';
                    toggle.textContent = 'â–¶';
                    header.style.padding = '8px 15px';
                } else {
                    content.style.display = 'block';
                    toggle.textContent = 'â–¼';
                    header.style.padding = '15px';
                }
            }
            
            // ğŸ”„ CACHE & DATEN LEEREN
            function clearAppCache(event) {
                // Verhindere dass Header collapsed wird
                if (event) event.stopPropagation();
                
                console.log('ğŸ”„ CACHE LEEREN GESTARTET...');
                
                const confirmed = confirm(
                    'ğŸ”„ Cache & Daten leeren?\n\n' +
                    'Das lÃ¶scht:\n' +
                    'âœ“ LocalStorage (gespeicherte Daten)\n' +
                    'âœ“ SessionStorage\n' +
                    'âœ“ Service Worker\n\n' +
                    'Die Seite wird neu geladen.\n\n' +
                    'Fortfahren?'
                );
                
                if (!confirmed) {
                    console.log('âŒ Abgebrochen');
                    return;
                }
                
                let cleared = [];
                
                try {
                    // 1. LocalStorage leeren
                    localStorage.clear();
                    console.log('âœ… LocalStorage gelÃ¶scht');
                    cleared.push('LocalStorage');
                } catch (e) {
                    console.error('âŒ LocalStorage Fehler:', e);
                }
                
                try {
                    // 2. SessionStorage leeren
                    sessionStorage.clear();
                    console.log('âœ… SessionStorage gelÃ¶scht');
                    cleared.push('SessionStorage');
                } catch (e) {
                    console.error('âŒ SessionStorage Fehler:', e);
                }
                
                try {
                    // 3. Service Worker deregistrieren
                    if ('serviceWorker' in navigator) {
                        navigator.serviceWorker.getRegistrations().then(registrations => {
                            registrations.forEach(registration => {
                                registration.unregister();
                                console.log('âœ… Service Worker deregistriert');
                            });
                            cleared.push('Service Worker');
                        });
                    }
                } catch (e) {
                    console.error('âŒ Service Worker Fehler:', e);
                }
                
                // 4. IndexedDB leeren (falls vorhanden)
                try {
                    if (window.indexedDB) {
                        indexedDB.databases().then(databases => {
                            databases.forEach(db => {
                                indexedDB.deleteDatabase(db.name);
                                console.log('âœ… IndexedDB gelÃ¶scht:', db.name);
                            });
                        });
                        cleared.push('IndexedDB');
                    }
                } catch (e) {
                    console.error('âŒ IndexedDB Fehler:', e);
                }
                
                console.log('âœ… GelÃ¶scht:', cleared.join(', '));
                
                // Zeige Erfolg + Anleitung fÃ¼r Browser-Cache
                alert(
                    'âœ… App-Daten gelÃ¶scht!\n\n' +
                    'GelÃ¶scht: ' + cleared.join(', ') + '\n\n' +
                    'âš ï¸ BROWSER-CACHE:\n' +
                    'Muss manuell gelÃ¶scht werden:\n\n' +
                    'Desktop: Strg+Shift+R\n' +
                    'Android: Chrome MenÃ¼ â†’ Verlauf â†’\n' +
                    'Browserdaten lÃ¶schen â†’ Cache\n\n' +
                    'Seite wird jetzt neu geladen...'
                );
                
                // Hard Reload
                setTimeout(() => {
                    console.log('ğŸ”„ Hard Reload...');
                    window.location.reload(true);
                }, 500);
            }
            
            // ğŸ†• v5.38.5: DEBUG-MODUS TOGGLE
            function toggleDebugMode() {
                debugMode = !debugMode;
                localStorage.setItem('debugMode', debugMode);
                
                const icon = document.getElementById('debug-icon');
                
                if (debugMode) {
                    // Aktiviere Console
                    if (console._originalLog) {
                        console.log = console._originalLog;
                        console.error = console._originalError;
                        console.warn = console._originalWarn;
                    }
                    
                    icon.textContent = 'ğŸŸ¢';
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    console.log('âœ… DEBUG-MODUS AKTIVIERT!');
                    console.log('ğŸ“Š Console-Logs sind jetzt sichtbar!');
                    console.log('ğŸš• Funk Taxi App v5.38.5');
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                } else {
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    console.log('ğŸ”´ DEBUG-MODUS DEAKTIVIERT!');
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    
                    // Deaktiviere Console
                    console.log = function() {};
                    console.error = function() {};
                    console.warn = function() {};
                    
                    icon.textContent = 'ğŸ›';
                }
            }
            
            // ğŸ†• v5.38.5: Console Override (nur wenn Debug AUS)
            if (!debugMode) {
                const originalLog = console.log;
                const originalError = console.error;
                const originalWarn = console.warn;
                
                console.log = function() {};
                console.error = function() {};
                console.warn = function() {};
                
                // Speichere Originale fÃ¼r Debug-Modus
                console._originalLog = originalLog;
                console._originalError = originalError;
                console._originalWarn = originalWarn;
            }
            
            function toggleNewRidesPanel() {
                const panel = document.getElementById('new-rides-panel');
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            }
            
            function toggleDebugPanel() {
                const panel = document.getElementById('debug-panel');
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            }
            
            // ğŸš¨ STORNIERUNG PANEL FUNKTIONEN
            function showCancellationPanel() {
                const myRides = currentVehicle ? rides.filter(r => r.vehicleId === currentVehicle || r.vehicle === (VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle)) : [];
                // ğŸ†• VEREINFACHT: Nur cancelled Fahrten die noch nicht gesehen wurden
                const pendingCancellations = myRides.filter(r => 
                    r.status === 'cancelled' && r.driverNotified === false
                );
                
                if (pendingCancellations.length === 0) {
                    alert('Keine Stornierungen!');
                    return;
                }
                
                let html = `
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h2 style="margin:0;color:#ef4444;">ğŸš¨ Stornierungen</h2>
                        <button onclick="closeCancellationPanel()" style="
                            background:#ef4444;
                            color:white;
                            border:none;
                            padding:8px 16px;
                            border-radius:8px;
                            cursor:pointer;
                            font-weight:600;
                        ">âœ• SchlieÃŸen</button>
                    </div>
                `;
                
                pendingCancellations.forEach(ride => {
                    const cancellationFee = calculateCancellationFee(ride);
                    html += `
                        <div style="
                            background:#fef2f2;
                            border:3px solid #ef4444;
                            border-radius:12px;
                            padding:20px;
                            margin-bottom:15px;
                        ">
                            <div style="font-size:24px;font-weight:bold;color:#ef4444;margin-bottom:15px;">
                                Fahrt #${ride.id}
                            </div>
                            
                            ${ride.customerName ? `
                            <div style="padding:12px;background:#dbeafe;border-radius:8px;margin-bottom:12px;">
                                <div style="font-size:18px;font-weight:600;color:#1e40af;">
                                    ğŸ‘¤ ${ride.customerName}
                                </div>
                            </div>
                            ` : ''}
                            
                            <div style="margin-bottom:12px;font-size:14px;">
                                <strong>Von:</strong> ${ride.pickup}<br>
                                <strong>Nach:</strong> ${ride.destination}<br>
                                <strong>Abholung:</strong> ${ride.pickupTime || 'Sofort'}<br>
                                <strong>Preis:</strong> ${ride.price}â‚¬
                            </div>
                            
                            ${ride.cancellationReason ? `
                            <div style="
                                padding:12px;
                                background:#fff7ed;
                                border-left:4px solid #f59e0b;
                                border-radius:6px;
                                margin-bottom:12px;
                            ">
                                <strong>Grund:</strong> ${ride.cancellationReason}
                            </div>
                            ` : ''}
                            
                            <div style="
                                padding:15px;
                                background:white;
                                border-radius:8px;
                                margin-bottom:15px;
                                text-align:center;
                            ">
                                <div style="font-size:12px;color:#666;margin-bottom:5px;">
                                    StornierungsgebÃ¼hr
                                </div>
                                <div style="font-size:32px;font-weight:bold;color:#ef4444;">
                                    ${cancellationFee.toFixed(2)}â‚¬
                                </div>
                            </div>
                            
                            <button onclick="confirmCancellation('${ride.firebaseId || ride.id}')" style="
                                width:100%;
                                padding:16px;
                                background:#ef4444;
                                color:white;
                                border:none;
                                border-radius:12px;
                                font-size:16px;
                                font-weight:bold;
                                cursor:pointer;
                            ">
                                âœ“ OK, verstanden
                            </button>
                            
                            <button onclick="showRideDetails('${ride.firebaseId || ride.id}')" style="
                                width:100%;
                                padding:12px;
                                background:white;
                                color:#ef4444;
                                border:2px solid #ef4444;
                                border-radius:12px;
                                font-size:14px;
                                font-weight:600;
                                cursor:pointer;
                                margin-top:10px;
                            ">
                                Details ansehen
                            </button>
                        </div>
                    `;
                });
                
                document.getElementById('cancellation-list').innerHTML = html;
                document.getElementById('cancellation-panel').style.display = 'block';
            }
            
            function closeCancellationPanel() {
                document.getElementById('cancellation-panel').style.display = 'none';
            }
            
            async function confirmCancellation(rideId) {
                try {
                    const ride = rides.find(r => (r.firebaseId || r.id) === rideId);
                    if (!ride) {
                        alert('âŒ Fahrt nicht gefunden!');
                        return;
                    }
                    
                    // ğŸ†• VEREINFACHT: Nur als "gesehen" markieren, kein Status-Wechsel nÃ¶tig
                    const updates = {
                        driverNotified: true,
                        driverConfirmedAt: new Date().toISOString()
                    };
                    
                    if (isFirebaseReady) {
                        await db.ref('rides/' + rideId).update(updates);
                        console.log('âœ… Stornierung zur Kenntnis genommen:', rideId);
                    }
                    
                    // Update lokal
                    Object.assign(ride, updates);
                    saveRides();
                    
                    // âœ… Panel schlieÃŸen
                    closeCancellationPanel();
                    
                    // UI Update
                    updateViews();
                    
                    // ğŸ†• Einfache BestÃ¤tigung
                    const feeText = ride.cancellationFee ? ` (GebÃ¼hr: ${ride.cancellationFee.toFixed(2)}â‚¬)` : '';
                    alert('âœ… OK!' + feeText);
                    
                } catch (error) {
                    console.error('âŒ Fehler:', error);
                    alert('âŒ Fehler: ' + error.message);
                }
            }
            
            function calculateCancellationFee(ride) {
                // StornierungsgebÃ¼hr = Grundpreis (4â‚¬) + 10% vom Fahrpreis
                const baseFee = 4.00;
                const percentageFee = ride.price ? ride.price * 0.1 : 0;
                const total = baseFee + percentageFee;
                
                // Runde auf 10 Cent
                return Math.round(total * 10) / 10;
            }
        </script>
    </div>

    <div id="admin-view" class="view">
        <h3 style="margin: 20px 0;">Dashboard</h3>
        
        <!-- ğŸ†• v5.31.3: RIDE-ID SUCHE -->
        <div style="background:white;padding:15px;border-radius:12px;margin-bottom:20px;border:2px solid #667eea;box-shadow:0 4px 12px rgba(102,126,234,0.15);">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                <div style="font-size:24px;">ğŸ”</div>
                <div style="flex:1;">
                    <label style="display:block;font-weight:600;font-size:14px;color:#1f2937;margin-bottom:8px;">
                        Suche nach Fahrt-ID
                    </label>
                    <input 
                        type="text" 
                        id="ride-id-search" 
                        placeholder="ride_1733047234567_k3n9x2m4p" 
                        style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;font-family:monospace;box-sizing:border-box;"
                        onkeypress="if(event.key==='Enter') searchRideById()">
                </div>
                <button 
                    onclick="searchRideById()" 
                    style="padding:12px 20px;background:#667eea;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;white-space:nowrap;font-size:14px;">
                    ğŸ” Suchen
                </button>
            </div>
            <div style="font-size:12px;color:#6b7280;">
                ğŸ’¡ Tipp: ID aus Telegram kopieren und hier einfÃ¼gen
            </div>
        </div>
        
        <!-- ğŸ†• v5.27.1: KALENDER (NUR FÃœR ADMIN!) -->
        <div onclick="toggleAdminSection('calendar')" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ“… Fahrten-Kalender</span>
            <span id="calendar-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="calendar-content" style="display:none;margin-bottom:20px;background:white;padding:15px;border-radius:8px;border:1px solid #e5e7eb;">
            <!-- Ansichts-Toggle -->
            <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
                <button id="cal-month-btn" onclick="switchCalendarView('month')" style="flex: 1; min-width: 120px; padding: 12px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    ğŸ“… Monat
                </button>
                <button id="cal-week-btn" onclick="switchCalendarView('week')" style="flex: 1; min-width: 120px; padding: 12px; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    ğŸ“Š Woche
                </button>
                <button id="cal-day-btn" onclick="switchCalendarView('day')" style="flex: 1; min-width: 120px; padding: 12px; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    ğŸ“‹ Tag
                </button>
                <button id="cal-timeline-btn" onclick="switchCalendarView('timeline')" style="flex: 1; min-width: 140px; padding: 12px; border: 2px solid #10b981; background: white; color: #10b981; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    ğŸš—â±ï¸ Fahrzeug-Timeline
                </button>
            </div>
            
            <!-- Monats-Navigation -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 12px; background: #f9fafb; border-radius: 8px;">
                <button onclick="previousPeriod()" style="padding: 8px 16px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; font-weight: 600; cursor: pointer;">
                    â—€ï¸ ZurÃ¼ck
                </button>
                <div style="font-weight: 700; font-size: 16px; color: #1f2937;" id="calendar-period-title">
                    November 2025
                </div>
                <button onclick="nextPeriod()" style="padding: 8px 16px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; font-weight: 600; cursor: pointer;">
                    Vor â–¶ï¸
                </button>
            </div>
            
            <!-- Legende -->
            <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 15px; padding: 12px; background: #f9fafb; border-radius: 8px; font-size: 13px;">
                <div style="font-weight: 600; width: 100%; margin-bottom: 5px; color: #1f2937;">Status:</div>
                <div style="display: flex; align-items: center; gap: 4px;">
                    <div style="width: 12px; height: 12px; background: #10b981; border-radius: 50%;"></div>
                    <span>Abgeschlossen</span>
                </div>
                <div style="display: flex; align-items: center; gap: 4px;">
                    <div style="width: 12px; height: 12px; background: #ef4444; border-radius: 50%;"></div>
                    <span>Storniert</span>
                </div>
                <div style="display: flex; align-items: center; gap: 4px;">
                    <div style="width: 12px; height: 12px; background: #f59e0b; border-radius: 50%;"></div>
                    <span>Vorbestellt</span>
                </div>
                <div style="display: flex; align-items: center; gap: 4px;">
                    <div style="width: 12px; height: 12px; background: #3b82f6; border-radius: 50%;"></div>
                    <span>In Bearbeitung</span>
                </div>
            </div>
            
            <!-- ğŸ†• v5.29.0: KAPAZITÃ„TS-LEGENDE -->
            <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; padding: 12px; background: #fffbeb; border-radius: 8px; font-size: 13px; border: 2px solid #fcd34d;">
                <div style="font-weight: 600; width: 100%; margin-bottom: 5px; color: #1f2937;">ğŸ”¥ Auslastung:</div>
                <div style="display: flex; align-items: center; gap: 6px;">
                    <div style="padding: 4px 8px; background: #f0fdf4; border: 2px solid #86efac; border-radius: 6px; font-weight: 600; color: #166534;">
                        âœ… 1-3
                    </div>
                    <span style="color: #166534;">OK</span>
                </div>
                <div style="display: flex; align-items: center; gap: 6px;">
                    <div style="padding: 4px 8px; background: #fef3c7; border: 2px solid #fcd34d; border-radius: 6px; font-weight: 600; color: #92400e;">
                        âš ï¸ 4-5
                    </div>
                    <span style="color: #92400e;">KÃ¶nnte eng werden</span>
                </div>
                <div style="display: flex; align-items: center; gap: 6px;">
                    <div style="padding: 4px 8px; background: #fef2f2; border: 2px solid: #fca5a5; border-radius: 6px; font-weight: 600; color: #991b1b;">
                        ğŸ”¥ 6+
                    </div>
                    <span style="color: #991b1b;">Viele Fahrten!</span>
                </div>
            </div>
            
            <!-- Kalender-Container -->
            <div id="calendar-container" style="margin-bottom: 20px;">
                <!-- Wird dynamisch gefÃ¼llt -->
            </div>
            
            <!-- Statistik -->
            <div id="calendar-stats" style="padding: 15px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 12px; font-size: 14px;">
                <!-- Wird dynamisch gefÃ¼llt -->
            </div>
        </div>
        
        <!-- ğŸš¨ NEU: AKTIVE FAHRTEN ÃœBERSICHT -->
        <div onclick="toggleAdminSection('activerides')" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸš¨ Aktive Fahrten <span id="active-rides-count" style="background:white;color:#d97706;padding:2px 8px;border-radius:10px;font-size:12px;margin-left:8px;">0</span></span>
            <span id="activerides-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="activerides-content" style="display:none;margin-bottom:20px;">
            <div style="display:flex;gap:10px;margin-bottom:10px;">
                <button onclick="loadActiveRides()" style="padding:10px 15px;background:#f59e0b;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ”„ Aktualisieren
                </button>
                <button onclick="cleanupAllStuckRides()" style="padding:10px 15px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ§¹ HÃ¤ngende zurÃ¼cksetzen
                </button>
            </div>
            <div id="active-rides-list" style="background:#fff;border-radius:8px;border:1px solid #e5e7eb;max-height:400px;overflow-y:auto;">
                <div style="padding:20px;text-align:center;color:#999;">Lade aktive Fahrten...</div>
            </div>
        </div>
        
        <!-- ğŸ—ºï¸ NEU: FAHRZEUG-KARTE -->
        <div onclick="toggleAdminSection('fleetmap')" style="background:linear-gradient(135deg,#0ea5e9,#0284c7);color:white;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ—ºï¸ Fahrzeug-Ãœbersicht <span id="fleet-status" style="font-size:12px;opacity:0.8;"></span></span>
            <span id="fleetmap-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="fleetmap-content" style="display:none;margin-bottom:20px;">
            <!-- Legende -->
            <div style="display:flex;gap:15px;margin-bottom:10px;font-size:13px;">
                <div style="display:flex;align-items:center;gap:5px;">
                    <div style="width:12px;height:12px;background:#22c55e;border-radius:50%;"></div>
                    <span>Frei</span>
                </div>
                <div style="display:flex;align-items:center;gap:5px;">
                    <div style="width:12px;height:12px;background:#ef4444;border-radius:50%;"></div>
                    <span>Besetzt</span>
                </div>
                <div style="display:flex;align-items:center;gap:5px;">
                    <div style="width:12px;height:12px;background:#f59e0b;border-radius:50%;"></div>
                    <span>Zugewiesen</span>
                </div>
                <div style="display:flex;align-items:center;gap:5px;">
                    <div style="width:12px;height:12px;background:#6b7280;border-radius:50%;"></div>
                    <span>Offline</span>
                </div>
            </div>
            
            <!-- Karte -->
            <div id="fleet-map" style="height:350px;border-radius:8px;border:2px solid #e0e0e0;"></div>
            
            <!-- Fahrzeug-Liste -->
            <div id="fleet-vehicle-list" style="margin-top:10px;"></div>
            
            <!-- Buttons -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
                <button onclick="refreshFleetMap()" style="padding:12px;background:#0ea5e9;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ”„ Aktualisieren
                </button>
                <button onclick="toggleFleetAutoRefresh()" id="fleet-auto-btn" style="padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    â–¶ï¸ Auto-Update
                </button>
            </div>
        </div>
        
        <!-- ğŸ”´ NEU: LIVE-LOG -->
        <div onclick="toggleAdminSection('livelog')" style="background:linear-gradient(135deg,#dc2626,#b91c1c);color:white;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ”´ Live-Log <span id="live-log-status" style="font-size:12px;opacity:0.8;">(gestoppt)</span></span>
            <span id="livelog-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="livelog-content" style="display:none;margin-bottom:20px;">
            <!-- Live-Log Konsole -->
            <div id="live-log-console" style="background:#1e1e1e;color:#00ff00;font-family:monospace;font-size:12px;padding:15px;border-radius:8px;height:300px;overflow-y:auto;margin-bottom:10px;">
                <div style="color:#888;">// Live-Log gestartet...</div>
                <div style="color:#888;">// Warte auf Ereignisse...</div>
            </div>
            
            <!-- Live-Log Controls -->
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
                <button id="live-log-toggle-btn" onclick="toggleLiveLog()" style="padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    â–¶ï¸ Starten
                </button>
                <button onclick="clearLiveLogConsole()" style="padding:12px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ—‘ï¸ Console leeren
                </button>
                <button onclick="exportLiveLog()" style="padding:12px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ“‹ Kopieren
                </button>
            </div>
            
            <!-- Filter fÃ¼r Live-Log -->
            <div style="margin-top:10px;display:flex;flex-wrap:wrap;gap:5px;">
                <label style="display:flex;align-items:center;gap:4px;font-size:12px;background:#f3f4f6;padding:5px 10px;border-radius:15px;cursor:pointer;">
                    <input type="checkbox" id="live-filter-booking" checked onchange="updateLiveFilters()"> ğŸ“± Buchungen
                </label>
                <label style="display:flex;align-items:center;gap:4px;font-size:12px;background:#f3f4f6;padding:5px 10px;border-radius:15px;cursor:pointer;">
                    <input type="checkbox" id="live-filter-driver" checked onchange="updateLiveFilters()"> ğŸš— Fahrer
                </label>
                <label style="display:flex;align-items:center;gap:4px;font-size:12px;background:#f3f4f6;padding:5px 10px;border-radius:15px;cursor:pointer;">
                    <input type="checkbox" id="live-filter-assignment" checked onchange="updateLiveFilters()"> ğŸ¯ Vermittlung
                </label>
                <label style="display:flex;align-items:center;gap:4px;font-size:12px;background:#f3f4f6;padding:5px 10px;border-radius:15px;cursor:pointer;">
                    <input type="checkbox" id="live-filter-status" checked onchange="updateLiveFilters()"> ğŸ“Š Status
                </label>
                <label style="display:flex;align-items:center;gap:4px;font-size:12px;background:#f3f4f6;padding:5px 10px;border-radius:15px;cursor:pointer;">
                    <input type="checkbox" id="live-filter-gps" onchange="updateLiveFilters()"> ğŸ“ GPS
                </label>
                <label style="display:flex;align-items:center;gap:4px;font-size:12px;background:#f3f4f6;padding:5px 10px;border-radius:15px;cursor:pointer;">
                    <input type="checkbox" id="live-filter-system" checked onchange="updateLiveFilters()"> âš™ï¸ System
                </label>
            </div>
        </div>
        
        <!-- ğŸ†• v5.28.0: ANTI-BETRUGS-ALARME -->
        <div id="antifraud-alert-badge" onclick="toggleAdminSection('antifraud')" style="background:linear-gradient(135deg,#dc2626,#991b1b);color:white;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:none;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸš¨ Anti-Betrugs-Alarme <span id="antifraud-alert-count" style="background:white;color:#dc2626;padding:2px 8px;border-radius:10px;font-size:12px;margin-left:8px;">0</span></span>
            <span id="antifraud-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="antifraud-content" style="display:none;margin-bottom:20px;">
            <div style="padding:15px;background:#fef2f2;border-radius:8px;margin-bottom:15px;">
                <div style="font-weight:600;margin-bottom:8px;color:#991b1b;">âš ï¸ VerdÃ¤chtige Ã–PNV-Mehrfach-Abrechnungen</div>
                <div style="font-size:13px;color:#7f1d1d;">
                    Diese Fahrten kÃ¶nnten Mehrfach-Abrechnungen derselben Fahrt sein.<br>
                    PrÃ¼fen Sie ob es sich um verschiedene Personen oder um Betrug handelt.
                </div>
            </div>
            
            <!-- Buttons -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px;">
                <button onclick="loadAntiFraudAlerts()" style="padding:10px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ”„ Aktualisieren
                </button>
                <button onclick="clearResolvedAlerts()" style="padding:10px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ—‘ï¸ Erledigte lÃ¶schen
                </button>
            </div>
            
            <!-- Alarm-Liste -->
            <div id="antifraud-alerts-list" style="background:#fff;border-radius:8px;border:1px solid #e5e7eb;max-height:400px;overflow-y:auto;">
                <div style="padding:20px;text-align:center;color:#999;">Keine Alarme vorhanden</div>
            </div>
        </div>
        
        <!-- ğŸ“œ NEU: AKTIVITÃ„TS-PROTOKOLL -->
        <div onclick="toggleAdminSection('activitylog')" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ“œ AktivitÃ¤ts-Protokoll</span>
            <span id="activitylog-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="activitylog-content" style="display:none;margin-bottom:20px;">
            <!-- Filter -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
                <select id="log-filter-type" onchange="filterActivityLog()" style="padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                    <option value="all">Alle AktivitÃ¤ten</option>
                    <option value="booking">ğŸ“± Buchungen</option>
                    <option value="driver">ğŸš— Fahrer</option>
                    <option value="assignment">ğŸ¯ Vermittlung</option>
                    <option value="status">ğŸ“Š Status</option>
                    <option value="deleted">ğŸ—‘ï¸ GelÃ¶scht</option>
                    <option value="gps">ğŸ“ GPS</option>
                </select>
                <select id="log-filter-time" onchange="filterActivityLog()" style="padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                    <option value="today">Heute</option>
                    <option value="yesterday">Gestern</option>
                    <option value="week">Diese Woche</option>
                    <option value="all">Alle</option>
                </select>
            </div>
            
            <!-- Live-Statistik -->
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:15px;">
                <div style="background:#dbeafe;padding:10px;border-radius:8px;text-align:center;">
                    <div style="font-size:20px;font-weight:bold;color:#1d4ed8;" id="log-stat-bookings">0</div>
                    <div style="font-size:11px;color:#666;">Buchungen</div>
                </div>
                <div style="background:#dcfce7;padding:10px;border-radius:8px;text-align:center;">
                    <div style="font-size:20px;font-weight:bold;color:#16a34a;" id="log-stat-completed">0</div>
                    <div style="font-size:11px;color:#666;">Abgeschlossen</div>
                </div>
                <div style="background:#fef3c7;padding:10px;border-radius:8px;text-align:center;">
                    <div style="font-size:20px;font-weight:bold;color:#d97706;" id="log-stat-online">0</div>
                    <div style="font-size:11px;color:#666;">Fahrer Online</div>
                </div>
                <div style="background:#fee2e2;padding:10px;border-radius:8px;text-align:center;">
                    <div style="font-size:20px;font-weight:bold;color:#dc2626;" id="log-stat-deleted">0</div>
                    <div style="font-size:11px;color:#666;">GelÃ¶scht</div>
                </div>
            </div>
            
            <!-- Protokoll-Liste -->
            <div id="activity-log-list" style="max-height:400px;overflow-y:auto;background:#f9fafb;border-radius:8px;padding:10px;">
                <p style="text-align:center;color:#999;">Protokoll wird geladen...</p>
            </div>
            
            <!-- Buttons -->
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px;">
                <button onclick="loadActivityLog()" style="padding:12px;background:#f59e0b;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ”„ Aktualisieren
                </button>
                <button onclick="exportActivityLog()" style="padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ“¥ Exportieren
                </button>
                <button onclick="clearActivityLog()" style="padding:12px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ—‘ï¸ Leeren
                </button>
            </div>
        </div>
        
        <!-- ğŸ—‘ï¸ NEU: GELÃ–SCHTE FAHRTEN -->
        <div onclick="toggleAdminSection('deleted')" style="background:linear-gradient(135deg,#ef4444,#dc2626);color:white;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ—‘ï¸ GelÃ¶schte Fahrten</span>
            <span id="deleted-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="deleted-content" style="display:none;margin-bottom:20px;">
            <div style="margin-bottom:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <select id="deleted-filter-time" onchange="loadDeletedRides()" style="padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                    <option value="today">Heute</option>
                    <option value="yesterday">Gestern</option>
                    <option value="week">Diese Woche</option>
                    <option value="all">Alle</option>
                </select>
                <button onclick="loadDeletedRides()" style="padding:10px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ”„ Aktualisieren
                </button>
            </div>
            <div id="deleted-rides-list" style="max-height:400px;overflow-y:auto;background:#f9fafb;border-radius:8px;padding:10px;">
                <p style="text-align:center;color:#999;">Klicke auf "Aktualisieren" um gelÃ¶schte Fahrten zu laden</p>
            </div>
        </div>
        
        <!-- ğŸ” NEU: BENUTZER-VERWALTUNG -->
        <div onclick="toggleAdminSection('users')" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ‘¥ Benutzer-Verwaltung</span>
            <span id="users-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="users-content" style="display:none;margin-bottom:20px;">
            <div style="margin-bottom:15px;">
                <input type="text" id="user-search" placeholder="ğŸ” Benutzer suchen..." oninput="searchUsers()" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
            </div>
            <div id="users-list" style="max-height:300px;overflow-y:auto;"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
                <button onclick="loadAllUsers()" style="padding:12px;background:#667eea;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ”„ Benutzer laden
                </button>
                <button onclick="showAddUserModal()" style="padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    â• Neuer Mitarbeiter
                </button>
            </div>
        </div>
        
        <!-- ğŸš— NEU: FAHRZEUG-VERWALTUNG -->
        <div onclick="toggleAdminSection('vehicles')" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸš— Fahrzeug-Verwaltung</span>
            <span id="vehicles-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="vehicles-content" style="display:none;margin-bottom:20px;">
            <div id="vehicles-list" style="margin-bottom:15px;"></div>
            <button onclick="showAddVehicleModal()" style="width:100%;padding:12px;background:#f59e0b;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                â• Neues Fahrzeug hinzufÃ¼gen
            </button>
        </div>
        
        <!-- ğŸ“‹ NEU: STAMMKUNDEN-CRM -->
        <div onclick="toggleAdminSection('customers')" style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ“‹ Stammkunden-CRM</span>
            <span id="customers-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="customers-content" style="display:none;margin-bottom:20px;">
            <!-- ğŸ”€ Tab-Auswahl: Stammkunden vs App-User -->
            <div style="display:flex;margin-bottom:15px;border-radius:8px;overflow:hidden;border:2px solid #e0e0e0;">
                <button id="crm-tab-customers" onclick="switchCrmTab('customers')" style="flex:1;padding:10px;border:none;background:#10b981;color:white;font-weight:600;cursor:pointer;">
                    ğŸ“‹ Stammkunden
                </button>
                <button id="crm-tab-users" onclick="switchCrmTab('users')" style="flex:1;padding:10px;border:none;background:#f3f4f6;color:#333;font-weight:600;cursor:pointer;">
                    ğŸ“± App-User
                </button>
            </div>
            
            <div style="margin-bottom:15px;">
                <input type="text" id="customer-search" placeholder="ğŸ” Kunde suchen (Name, Email, Telefon)..." oninput="searchCustomers()" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
            </div>
            <div id="customers-list" style="max-height:400px;overflow-y:auto;"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
                <button onclick="loadAllCustomers()" style="padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ”„ Kunden laden
                </button>
                <button onclick="showAddCustomerModal()" style="padding:12px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    â• Neuer Kunde
                </button>
            </div>
            <div style="margin-top:10px;">
                <label for="csv-import" style="display:block;padding:12px;background:#8b5cf6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;text-align:center;">
                    ğŸ“¥ Google Kontakte importieren (CSV)
                </label>
                <input type="file" id="csv-import" accept=".csv" onchange="importGoogleCSV(this)" style="display:none;">
            </div>
            <div style="margin-top:10px;">
                <button onclick="deleteAllCustomers()" style="width:100%;padding:12px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                    ğŸ—‘ï¸ Alle Kunden lÃ¶schen
                </button>
            </div>
        </div>
        
        <!-- COLLAPSIBLE: Controls -->
        <div onclick="toggleAdminSection('controls')" style="background:#f3f4f6;padding:12px;border-radius:8px;cursor:pointer;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">âš™ï¸ Admin Controls</span>
            <span id="controls-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="controls-content" style="display:none;margin-bottom:20px;">
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px;">
                <button onclick="clearAppCache()" style="padding:15px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                    ğŸ§¹ Cache leeren
                </button>
                <button onclick="exportDebugLogs()" style="padding:15px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                    ğŸ“‹ Logs kopieren
                </button>
                <button onclick="exportSuperDebug()" style="padding:15px;background:#8b5cf6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                    ğŸ› Super Debug
                </button>
            </div>
            <div style="display:grid;grid-template-columns:1fr;gap:10px;">
                <button onclick="resetDatabase()" style="padding:15px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                    ğŸ—‘ï¸ Datenbank lÃ¶schen
                </button>
            </div>
        </div>
        
        <!-- Stats - immer sichtbar -->
        <div class="stats-grid">
            <div class="stat-card"><div style="font-size: 28px;" id="a-total">0</div><div>Fahrten</div></div>
            <div class="stat-card"><div style="font-size: 28px;" id="a-revenue">0â‚¬</div><div>Umsatz</div></div>
            <div class="stat-card"><div style="font-size: 28px;" id="a-pending">0</div><div>Offen</div></div>
            <div class="stat-card"><div style="font-size: 28px;" id="a-active">0</div><div>Aktiv</div></div>
        </div>
        
        <!-- ğŸ†• v5.31.5: DEZENTE BENACHRICHTIGUNG fÃ¼r neue Fahrten -->
        <div id="admin-notification-bar" style="display:none;background:linear-gradient(135deg,#dc2626,#ef4444);color:white;padding:15px;border-radius:12px;margin:15px 0;box-shadow:0 4px 12px rgba(220,38,38,0.3);">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div style="flex:1;">
                    <div style="font-size:18px;font-weight:700;margin-bottom:5px;">
                        ğŸš• <span id="notification-ride-count">0</span> neue Fahrt(en)!
                    </div>
                    <div style="font-size:14px;opacity:0.9;">
                        Bitte Fahrer zuweisen
                    </div>
                </div>
                <button onclick="scrollToOpenRides()" 
                    style="padding:10px 20px;background:white;color:#dc2626;border:none;border-radius:8px;font-weight:700;cursor:pointer;white-space:nowrap;">
                    ğŸ‘‰ Zuweisen
                </button>
            </div>
        </div>
        
        <!-- ğŸ†• v5.31.5: ALARM EINSTELLUNGEN -->
        <div style="background:#f9fafb;border:2px solid #e5e7eb;padding:15px;border-radius:12px;margin:15px 0;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <div style="font-weight:600;font-size:15px;">ğŸ”” Alarm-Einstellungen</div>
            </div>
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px;background:white;border-radius:8px;border:2px solid #e5e7eb;">
                <input type="checkbox" id="disable-admin-alarm" onchange="toggleAdminAlarm()" 
                    style="width:20px;height:20px;cursor:pointer;">
                <div>
                    <div style="font-weight:600;font-size:14px;color:#1f2937;">Alarm-Modal deaktivieren</div>
                    <div style="font-size:12px;color:#6b7280;margin-top:2px;">Keine Pop-ups & Sound (nur dezente Benachrichtigung oben)</div>
                </div>
            </label>
        </div>
        
        <!-- ğŸ†• v5.32.5h: AUTO-BOOKING EINSTELLUNGEN -->
        <div style="background:#f9fafb;border:2px solid #e5e7eb;padding:15px;border-radius:12px;margin:15px 0;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <div style="font-weight:600;font-size:15px;">ğŸ¤– Auto-Booking</div>
            </div>
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px;background:white;border-radius:8px;border:2px solid #e5e7eb;">
                <input type="checkbox" id="enable-auto-booking" onchange="toggleAutoBooking()" 
                    style="width:20px;height:20px;cursor:pointer;">
                <div>
                    <div style="font-weight:600;font-size:14px;color:#1f2937;">Auto-Booking aktivieren</div>
                    <div style="font-size:12px;color:#6b7280;margin-top:2px;">
                        System schlÃ¤gt bei belegten Zeiten automatisch Alternativen vor
                    </div>
                </div>
            </label>
            <div id="auto-booking-status" style="margin-top:10px;padding:8px;border-radius:6px;font-size:13px;text-align:center;"></div>
        </div>
        
        <!-- ğŸ†• v5.33.2: ZEITSLOT-EINSTELLUNGEN -->
        <div style="background:#f9fafb;border:2px solid #e5e7eb;padding:15px;border-radius:12px;margin:15px 0;">
            <div style="font-weight:600;font-size:15px;margin-bottom:15px;display:flex;align-items:center;gap:8px;">
                â° Zeitslot-Einstellungen
                <span style="font-size:11px;background:#dbeafe;color:#1e40af;padding:2px 8px;border-radius:4px;font-weight:600;">NEU!</span>
            </div>
            
            <div style="background:white;padding:15px;border-radius:8px;border:1px solid #e5e7eb;">
                <p style="font-size:13px;color:#6b7280;margin:0 0 15px 0;">
                    Passe die Zeitpuffer an, um zu steuern wie eng Fahrten hintereinander gebucht werden kÃ¶nnen.
                </p>
                
                <!-- Fahrtdauer Fallback -->
                <div style="margin-bottom:20px;">
                    <label style="display:block;font-weight:600;font-size:13px;color:#1f2937;margin-bottom:8px;">
                        ğŸ“ Fahrtdauer (Fallback wenn unbekannt)
                    </label>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <input type="range" id="ride-duration-slider" min="5" max="30" value="10" 
                            oninput="updateTimeslotSettings()" 
                            style="flex:1;height:6px;border-radius:3px;cursor:pointer;">
                        <span id="ride-duration-value" style="font-weight:600;color:#667eea;min-width:50px;text-align:right;">10 Min</span>
                    </div>
                    <div style="font-size:11px;color:#9ca3af;margin-top:4px;">
                        Durchschnittliche Fahrtdauer wenn keine Route berechnet werden kann
                    </div>
                </div>
                
                <!-- Anfahrtszeit Fallback -->
                <div style="margin-bottom:20px;">
                    <label style="display:block;font-weight:600;font-size:13px;color:#1f2937;margin-bottom:8px;">
                        ğŸš— Anfahrtszeit (Fallback wenn unbekannt)
                    </label>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <input type="range" id="travel-time-slider" min="2" max="20" value="5" 
                            oninput="updateTimeslotSettings()" 
                            style="flex:1;height:6px;border-radius:3px;cursor:pointer;">
                        <span id="travel-time-value" style="font-weight:600;color:#667eea;min-width:50px;text-align:right;">5 Min</span>
                    </div>
                    <div style="font-size:11px;color:#9ca3af;margin-top:4px;">
                        Zeit die das Taxi vom Ende einer Fahrt zum Start der nÃ¤chsten braucht
                    </div>
                </div>
                
                <!-- Zeitpuffer -->
                <div style="margin-bottom:20px;">
                    <label style="display:block;font-weight:600;font-size:13px;color:#1f2937;margin-bottom:8px;">
                        â±ï¸ Sicherheits-Puffer
                    </label>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <input type="range" id="buffer-time-slider" min="0" max="15" value="3" 
                            oninput="updateTimeslotSettings()" 
                            style="flex:1;height:6px;border-radius:3px;cursor:pointer;">
                        <span id="buffer-time-value" style="font-weight:600;color:#667eea;min-width:50px;text-align:right;">3 Min</span>
                    </div>
                    <div style="font-size:11px;color:#9ca3af;margin-top:4px;">
                        Extra Zeit fÃ¼r VerzÃ¶gerungen, Tankstopps, etc.
                    </div>
                </div>
                
                <!-- Total Buffer Anzeige -->
                <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;padding:12px;border-radius:8px;text-align:center;margin-bottom:15px;">
                    <div style="font-size:12px;opacity:0.9;margin-bottom:2px;">ğŸ“Š Total Buffer zwischen Fahrten:</div>
                    <div id="total-buffer-display" style="font-size:24px;font-weight:700;">18 Min</div>
                    <div style="font-size:11px;opacity:0.8;margin-top:4px;">
                        = Fahrtdauer + Anfahrtszeit + Puffer
                    </div>
                </div>
                
                <!-- Admin Override Toggle -->
                <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px;background:#fef3c7;border-radius:8px;border:2px solid #fbbf24;margin-bottom:15px;">
                    <input type="checkbox" id="admin-override-enabled" onchange="updateTimeslotSettings()" 
                        style="width:20px;height:20px;cursor:pointer;">
                    <div>
                        <div style="font-weight:600;font-size:13px;color:#92400e;">
                            ğŸ¯ Admin-Override aktivieren
                        </div>
                        <div style="font-size:11px;color:#78350f;margin-top:2px;">
                            Als Admin kannst du Zeitslot-Checks ignorieren und trotzdem buchen
                        </div>
                    </div>
                </label>
                
                <!-- Speichern Button -->
                <button onclick="saveTimeslotSettings()" style="
                    width:100%;
                    padding:12px;
                    background:#10b981;
                    color:white;
                    border:none;
                    border-radius:8px;
                    font-weight:600;
                    cursor:pointer;
                    font-size:14px;
                ">
                    ğŸ’¾ Einstellungen speichern
                </button>
                
                <div id="timeslot-save-status" style="margin-top:8px;text-align:center;font-size:12px;"></div>
            </div>
        </div>
        
        <!-- ğŸ†• v5.34.0: SCHNELLBUCHUNG BUTTON -->
        <button onclick="openQuickBookingModal()" style="
            width:100%;
            padding:15px;
            background:linear-gradient(135deg, #10b981 0%, #059669 100%);
            color:white;
            border:none;
            border-radius:12px;
            font-weight:700;
            font-size:16px;
            cursor:pointer;
            margin-bottom:15px;
            box-shadow:0 4px 6px rgba(16, 185, 129, 0.3);
            display:flex;
            align-items:center;
            justify-content:center;
            gap:10px;
        ">
            âš¡ Schnellbuchung fÃ¼r Kunde
        </button>
        
        <!-- COLLAPSIBLE: Online-Fahrer -->
        <div onclick="toggleAdminSection('drivers')" style="background:#f3f4f6;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸš— Online-Fahrer</span>
            <span id="drivers-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="drivers-content" style="display:none;">
            <div id="online-drivers-list" style="margin-bottom:20px;"></div>
        </div>
        
        <!-- COLLAPSIBLE: Offene Fahrten -->
        <div onclick="toggleAdminSection('open')" style="background:#f3f4f6;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ“‹ Offene Fahrten</span>
            <span id="open-toggle" style="font-size:20px;">â–²</span>
        </div>
        <div id="open-content" style="display:block;">
            <div id="upcoming-rides-admin" style="margin-bottom: 20px;"></div>
        </div>
        
        <!-- COLLAPSIBLE: Abgelehnte Fahrten -->
        <div onclick="toggleAdminSection('rejected')" style="background:#f3f4f6;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">âŒ Abgelehnte Fahrten</span>
            <span id="rejected-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="rejected-content" style="display:none;">
            <div id="rejected-rides-admin" style="margin-bottom: 20px;"></div>
        </div>
        
        <!-- COLLAPSIBLE: Abgeschlossene Fahrten -->
        <div onclick="toggleAdminSection('completed')" style="background:#f3f4f6;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">âœ… Abgeschlossene Fahrten</span>
            <span id="completed-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="completed-content" style="display:none;">
            <div id="all-rides"></div>
        </div>
        
        <!-- COLLAPSIBLE: Stornierungen -->
        <div onclick="toggleAdminSection('cancelled')" style="background:#f3f4f6;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ’¶ Stornierungen</span>
            <span id="cancelled-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="cancelled-content" style="display:none;">
            <div id="cancellations-list"></div>
        </div>
        
        <!-- ğŸ“… NEU: VORBESTELLUNGEN mit ICS Export -->
        <div onclick="toggleAdminSection('prebookings')" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ“… Vorbestellungen</span>
            <span id="prebookings-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="prebookings-content" style="display:none;margin-bottom:20px;padding:15px;background:#fff;border-radius:8px;border:1px solid #e5e7eb;">
            <button onclick="exportPrebookingsToICS()" style="width:100%;padding:15px;background:#8b5cf6;color:white;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;margin-bottom:15px;box-shadow:0 4px 12px rgba(139,92,246,0.3);">
                ğŸ“… Als Kalender exportieren (.ics)
            </button>
            <div id="prebookings-list" style="max-height:400px;overflow-y:auto;"></div>
        </div>
        
        <!-- ğŸ“± NEU: TELEGRAM-ALARME -->
        <div onclick="toggleAdminSection('telegram')" style="background:linear-gradient(135deg,#0088cc,#0077b3);color:white;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ“± Telegram-Alarme</span>
            <span id="telegram-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="telegram-content" style="display:none;margin-bottom:20px;padding:15px;background:#fff;border-radius:8px;border:1px solid #e5e7eb;">
            <div style="background:#e0f2fe;padding:15px;border-radius:8px;margin-bottom:15px;">
                <div style="font-weight:600;margin-bottom:8px;color:#0369a1;">âœ… Funktioniert auch bei:</div>
                <div style="font-size:14px;color:#0c4a6e;line-height:1.8;">
                    â€¢ ğŸ“± Handy gesperrt<br>
                    â€¢ ğŸŒ™ App geschlossen<br>
                    â€¢ ğŸ”‡ Browser im Hintergrund<br>
                    â€¢ ğŸ“µ Keine Internet-Verbindung (Nachricht kommt spÃ¤ter)
                </div>
            </div>
            
            <button onclick="showTelegramActivation()" style="width:100%;padding:15px;background:#0088cc;color:white;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;margin-bottom:15px;box-shadow:0 4px 12px rgba(0,136,204,0.3);">
                ğŸ“± Telegram-Alarme aktivieren
            </button>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px;">
                <button onclick="sendTelegramTest()" style="padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;">
                    ğŸ§ª Test-Nachricht
                </button>
                <button onclick="updateTelegramStatus()" style="padding:12px;background:#f3f4f6;color:#333;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;">
                    ğŸ”„ Status
                </button>
            </div>
            
            <div id="telegram-status" style="margin-top:0;padding:12px;background:#f9fafb;border-radius:8px;font-size:13px;color:#666;">â³ Status wird geladen...</div>
        </div>
        
        <!-- ğŸ’° PREIS-STEUERUNG (SURGE PRICING) -->
        
        <!-- ğŸš Ã–PNV-TAXI SYSTEM -->
        <div onclick="toggleAdminSection('oepnv')" style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸš Ã–PNV-Taxi System</span>
            <span id="oepnv-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="oepnv-content" style="display:none;padding:15px;background:#fff;border-radius:8px;margin-bottom:20px;border:1px solid #e5e7eb;">
            
            <!-- AKTIVIERUNG -->
            <div style="margin-bottom:20px;padding:15px;background:#f0fdf4;border-radius:8px;">
                <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                    <input type="checkbox" id="oepnv-enabled" onchange="saveOEPNVSettings()" style="width:20px;height:20px;">
                    <div>
                        <div style="font-weight:600;font-size:16px;">ğŸš Ã–PNV-Taxi aktivieren</div>
                        <div style="font-size:12px;color:#666;margin-top:2px;">Fahrer kÃ¶nnen bei Fahrtannahme zwischen Normal und Ã–PNV wÃ¤hlen</div>
                    </div>
                </label>
            </div>
            
            <div id="oepnv-settings" style="display:none;">
                
                <!-- TAXI-ZUSCHLAG -->
                <div style="margin-bottom:20px;">
                    <div style="font-weight:600;font-size:14px;margin-bottom:8px;">ğŸ’° Taxi-Zuschlag (einmalig pro Fahrt)</div>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <input type="number" id="oepnv-surcharge" step="0.50" min="0" value="2.00" style="padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;width:100px;">
                        <span>â‚¬</span>
                    </div>
                    <div style="font-size:12px;color:#666;margin-top:5px;">Wird einmalig zum Busticket addiert (weil Taxi komfortabler als Bus)</div>
                </div>
                
                <!-- TARIFSTUFEN -->
                <div style="margin-bottom:20px;">
                    <div style="font-weight:600;font-size:14px;margin-bottom:10px;">ğŸ“Š Busticket-Tarifstufen</div>
                    
                    <!-- Kurzstrecke -->
                    <div style="padding:12px;background:#f9fafb;border-radius:8px;margin-bottom:10px;">
                        <div style="font-weight:600;margin-bottom:8px;">Kurzstrecke (bis <input type="number" id="tarif-kurz-km" value="3" min="1" style="width:50px;padding:4px;border:1px solid #d1d5db;border-radius:4px;"> km)</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                            <div>
                                <label style="font-size:12px;color:#666;">Erwachsener</label>
                                <div style="display:flex;align-items:center;gap:5px;">
                                    <input type="number" id="tarif-kurz-erw" step="0.50" value="2.00" style="padding:8px;border:2px solid #e0e0e0;border-radius:6px;width:80px;">
                                    <span>â‚¬</span>
                                </div>
                            </div>
                            <div>
                                <label style="font-size:12px;color:#666;">Kind (6-14 J.)</label>
                                <div style="display:flex;align-items:center;gap:5px;">
                                    <input type="number" id="tarif-kurz-kind" step="0.50" value="1.50" style="padding:8px;border:2px solid #e0e0e0;border-radius:6px;width:80px;">
                                    <span>â‚¬</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Normalstrecke -->
                    <div style="padding:12px;background:#f9fafb;border-radius:8px;margin-bottom:10px;">
                        <div style="font-weight:600;margin-bottom:8px;">Normalstrecke (bis <input type="number" id="tarif-normal-km" value="7" min="1" style="width:50px;padding:4px;border:1px solid #d1d5db;border-radius:4px;"> km)</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                            <div>
                                <label style="font-size:12px;color:#666;">Erwachsener</label>
                                <div style="display:flex;align-items:center;gap:5px;">
                                    <input type="number" id="tarif-normal-erw" step="0.50" value="3.00" style="padding:8px;border:2px solid #e0e0e0;border-radius:6px;width:80px;">
                                    <span>â‚¬</span>
                                </div>
                            </div>
                            <div>
                                <label style="font-size:12px;color:#666;">Kind (6-14 J.)</label>
                                <div style="display:flex;align-items:center;gap:5px;">
                                    <input type="number" id="tarif-normal-kind" step="0.50" value="2.00" style="padding:8px;border:2px solid #e0e0e0;border-radius:6px;width:80px;">
                                    <span>â‚¬</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- LÃ¤ngere Strecke -->
                    <div style="padding:12px;background:#f9fafb;border-radius:8px;margin-bottom:10px;">
                        <div style="font-weight:600;margin-bottom:8px;">LÃ¤ngere Strecke (bis <input type="number" id="tarif-lang-km" value="15" min="1" style="width:50px;padding:4px;border:1px solid #d1d5db;border-radius:4px;"> km)</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                            <div>
                                <label style="font-size:12px;color:#666;">Erwachsener</label>
                                <div style="display:flex;align-items:center;gap:5px;">
                                    <input type="number" id="tarif-lang-erw" step="0.50" value="4.50" style="padding:8px;border:2px solid #e0e0e0;border-radius:6px;width:80px;">
                                    <span>â‚¬</span>
                                </div>
                            </div>
                            <div>
                                <label style="font-size:12px;color:#666;">Kind (6-14 J.)</label>
                                <div style="display:flex;align-items:center;gap:5px;">
                                    <input type="number" id="tarif-lang-kind" step="0.50" value="3.00" style="padding:8px;border:2px solid #e0e0e0;border-radius:6px;width:80px;">
                                    <span>â‚¬</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Insel-Ticket -->
                    <div style="padding:12px;background:#f9fafb;border-radius:8px;">
                        <div style="font-weight:600;margin-bottom:8px;">Insel-Ticket (Ã¼ber 15 km)</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                            <div>
                                <label style="font-size:12px;color:#666;">Erwachsener</label>
                                <div style="display:flex;align-items:center;gap:5px;">
                                    <input type="number" id="tarif-insel-erw" step="0.50" value="6.00" style="padding:8px;border:2px solid #e0e0e0;border-radius:6px;width:80px;">
                                    <span>â‚¬</span>
                                </div>
                            </div>
                            <div>
                                <label style="font-size:12px;color:#666;">Kind (6-14 J.)</label>
                                <div style="display:flex;align-items:center;gap:5px;">
                                    <input type="number" id="tarif-insel-kind" step="0.50" value="4.00" style="padding:8px;border:2px solid #e0e0e0;border-radius:6px;width:80px;">
                                    <span>â‚¬</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- GEMEINDE/ABRECHNUNGSSTELLE -->
                <div style="margin-bottom:20px;">
                    <div style="font-weight:600;font-size:14px;margin-bottom:8px;">ğŸ›ï¸ Abrechnungsstelle</div>
                    <div style="margin-bottom:10px;">
                        <label style="font-size:12px;color:#666;display:block;margin-bottom:4px;">Name</label>
                        <input type="text" id="oepnv-community-name" value="Gemeinde Heringsdorf" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="font-size:12px;color:#666;display:block;margin-bottom:4px;">Email</label>
                        <input type="email" id="oepnv-community-email" placeholder="finanzen@heringsdorf.de" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;box-sizing:border-box;">
                    </div>
                </div>
                
                <!-- BELEG-OPTIONEN -->
                <div style="margin-bottom:20px;">
                    <div style="font-weight:600;font-size:14px;margin-bottom:8px;">ğŸ“„ Beleg-Optionen fÃ¼r Kunden</div>
                    <div style="display:flex;flex-direction:column;gap:8px;">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:#f9fafb;border-radius:6px;">
                            <input type="checkbox" id="oepnv-beleg-qr" checked style="width:18px;height:18px;">
                            <span style="font-size:14px;">QR-Code anzeigen</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:#f9fafb;border-radius:6px;">
                            <input type="checkbox" id="oepnv-beleg-app" checked style="width:18px;height:18px;">
                            <span style="font-size:14px;">In-App Beleg (Verlauf)</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:#f9fafb;border-radius:6px;">
                            <input type="checkbox" id="oepnv-beleg-pdf" checked style="width:18px;height:18px;">
                            <span style="font-size:14px;">PDF-Download anbieten</span>
                        </label>
                    </div>
                </div>
                
                <!-- BEISPIEL-BERECHNUNG -->
                <div style="padding:15px;background:#fef3c7;border-radius:8px;">
                    <div style="font-weight:600;margin-bottom:8px;">ğŸ“‹ Beispiel-Berechnung:</div>
                    <div style="font-size:13px;color:#666;">
                        <strong>Strecke:</strong> 5 km (Normalstrecke)<br>
                        <strong>Personen:</strong> 2 Erwachsene + 1 Kind<br>
                        <br>
                        <strong>Bustickets:</strong><br>
                        2Ã— 3,00â‚¬ = 6,00â‚¬<br>
                        1Ã— 2,00â‚¬ = 2,00â‚¬<br>
                        Busticket gesamt: 8,00â‚¬<br>
                        + Taxi-Zuschlag: 2,00â‚¬<br>
                        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br>
                        <strong>Kunde zahlt: 10,00â‚¬</strong><br>
                        <br>
                        Bei Taxi-Preis 15,00â‚¬:<br>
                        <strong>Gemeinde zahlt: 5,00â‚¬</strong>
                    </div>
                </div>
                
                <!-- ğŸ†• v5.28.0: ANTI-BETRUGS-SYSTEM -->
                <div style="margin-top:30px;padding:20px;background:#fef2f2;border:2px solid #ef4444;border-radius:12px;">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px;">
                        <div style="font-size:28px;">ğŸš¨</div>
                        <div>
                            <div style="font-weight:700;font-size:16px;color:#991b1b;">Anti-Betrugs-System</div>
                            <div style="font-size:12px;color:#7f1d1d;">Verhindert Mehrfach-Abrechnungen bei Sammelfahrten</div>
                        </div>
                    </div>
                    
                    <!-- TOGGLE -->
                    <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:12px;background:white;border-radius:8px;margin-bottom:15px;">
                        <input type="checkbox" id="oepnv-antifraud-enabled" onchange="saveOEPNVSettings()" style="width:20px;height:20px;">
                        <div style="flex:1;">
                            <div style="font-weight:600;font-size:14px;color:#1f2937;">ğŸ›¡ï¸ Anti-Betrugs-System aktivieren</div>
                            <div style="font-size:12px;color:#6b7280;margin-top:2px;">Erkennt automatisch verdÃ¤chtige Mehrfach-Abrechnungen</div>
                        </div>
                    </label>
                    
                    <!-- MODUS -->
                    <div id="antifraud-mode-section" style="display:none;padding:12px;background:white;border-radius:8px;margin-bottom:15px;">
                        <div style="font-weight:600;font-size:13px;color:#1f2937;margin-bottom:10px;">Betriebsmodus:</div>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:#f9fafb;border-radius:6px;margin-bottom:6px;">
                            <input type="radio" name="antifraud-mode" value="warn" checked style="width:16px;height:16px;">
                            <div>
                                <div style="font-weight:600;font-size:13px;color:#10b981;">âš ï¸ Nur Warnen (Empfohlen fÃ¼r Start)</div>
                                <div style="font-size:11px;color:#6b7280;">Erkennt Duplikate, blockiert aber nicht â†’ Admin sieht Warnungen</div>
                            </div>
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:#f9fafb;border-radius:6px;">
                            <input type="radio" name="antifraud-mode" value="block" style="width:16px;height:16px;">
                            <div>
                                <div style="font-weight:600;font-size:13px;color:#ef4444;">ğŸš« Blockieren</div>
                                <div style="font-size:11px;color:#6b7280;">Verhindert Mehrfach-Abrechnungen aktiv â†’ Blockiert zweite Buchung</div>
                            </div>
                        </label>
                    </div>
                    
                    <!-- ERKENNUNGS-KRITERIEN -->
                    <div id="antifraud-criteria" style="display:none;padding:12px;background:white;border-radius:8px;margin-bottom:15px;">
                        <div style="font-weight:600;font-size:13px;color:#1f2937;margin-bottom:8px;">ğŸ” Erkennungs-Kriterien:</div>
                        <div style="font-size:12px;color:#4b5563;line-height:1.6;">
                            System markiert als verdÃ¤chtig wenn:<br>
                            âœ“ Gleicher Fahrer<br>
                            âœ“ Gleiche Start-Adresse<br>
                            âœ“ Gleiches Ziel<br>
                            âœ“ Zeitdifferenz &lt; 5 Minuten<br>
                            <br>
                            <div style="padding:8px;background:#fef3c7;border-radius:6px;font-size:11px;">
                                <strong>ğŸ’¡ Tipp:</strong> Starten Sie im "Nur Warnen" Modus um Daten zu sammeln, bevor Sie blockieren!
                            </div>
                        </div>
                    </div>
                    
                    <!-- INFO BOX -->
                    <div style="padding:12px;background:#dbeafe;border-radius:8px;font-size:12px;color:#1e40af;">
                        <strong>â„¹ï¸ Was passiert bei Aktivierung?</strong><br>
                        â€¢ Admin sieht verdÃ¤chtige Muster im Dashboard<br>
                        â€¢ Automatische Duplikats-Erkennung<br>
                        â€¢ Warnungen in Echtzeit<br>
                        â€¢ Excel-Export fÃ¼r Gemeinde<br>
                        <br>
                        <strong>ğŸ‘ Vorteile:</strong> Gemeinde spart Geld, Betrug wird verhindert, professionelles System!
                    </div>
                </div>
                
                <button onclick="saveOEPNVSettings()" style="width:100%;margin-top:15px;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:15px;">
                    ğŸ’¾ Einstellungen speichern
                </button>
                
            </div>
        </div>
        
        <!-- ğŸ†• v5.38.2: BUCHUNGSSYSTEM AN/AUS -->
        <div onclick="toggleAdminSection('booking-system')" style="background:#f3f4f6;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ”´ Buchungssystem</span>
            <span id="booking-system-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="booking-system-content" style="display:none;padding:15px;background:#fff;border-radius:8px;margin-bottom:20px;border:1px solid #e5e7eb;">
            
            <!-- Status Anzeige -->
            <div id="booking-system-status" style="text-align:center;margin-bottom:20px;padding:20px;border-radius:12px;color:white;">
                <div style="font-size:14px;opacity:0.9;margin-bottom:8px;">Aktueller Status</div>
                <div id="booking-status-text" style="font-size:32px;font-weight:bold;">ğŸŸ¢ ONLINE</div>
                <div style="font-size:12px;opacity:0.8;margin-top:8px;">Buchungen werden angenommen</div>
            </div>
            
            <!-- ON/OFF Schalter -->
            <div style="margin-bottom:20px;">
                <div style="font-weight:600;font-size:14px;margin-bottom:15px;">ğŸ“± Buchungen aktivieren/deaktivieren</div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                    <button onclick="setBookingSystem(true)" id="btn-booking-on" style="padding:15px;border:3px solid #10b981;background:#10b981;border-radius:12px;font-weight:700;cursor:pointer;font-size:15px;color:white;transition:all 0.2s;">
                        âœ… ONLINE<br>
                        <span style="font-size:11px;font-weight:normal;opacity:0.9;">Buchungen mÃ¶glich</span>
                    </button>
                    <button onclick="setBookingSystem(false)" id="btn-booking-off" style="padding:15px;border:3px solid #e5e7eb;background:white;border-radius:12px;font-weight:700;cursor:pointer;font-size:15px;color:#666;transition:all 0.2s;">
                        ğŸ”´ OFFLINE<br>
                        <span style="font-size:11px;font-weight:normal;opacity:0.8;">Nur Anrufen</span>
                    </button>
                </div>
            </div>
            
            <!-- Info-Box -->
            <div style="padding:12px;background:#fef3c7;border-radius:8px;font-size:12px;">
                <strong>ğŸ’¡ Was passiert wenn OFFLINE?</strong><br>
                â€¢ Buchungs-Button wird ausgeblendet<br>
                â€¢ FahrgÃ¤ste sehen "Bitte anrufen"<br>
                â€¢ Telefonnummer wird angezeigt<br>
                â€¢ Ideal fÃ¼r Urlaub oder Wartung<br>
            </div>
        </div>
        
        <div onclick="toggleAdminSection('pricing')" style="background:#f3f4f6;padding:12px;border-radius:8px;cursor:pointer;margin:20px 0 10px 0;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;font-size:15px;">ğŸ’° Preis-Steuerung</span>
            <span id="pricing-toggle" style="font-size:20px;">â–¼</span>
        </div>
        <div id="pricing-content" style="display:none;padding:15px;background:#fff;border-radius:8px;margin-bottom:20px;border:1px solid #e5e7eb;">
            
            <!-- Aktueller Multiplikator Anzeige -->
            <div style="text-align:center;margin-bottom:20px;padding:15px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:12px;color:white;">
                <div style="font-size:12px;opacity:0.9;">Aktueller Preis-Multiplikator</div>
                <div id="current-multiplier-display" style="font-size:36px;font-weight:bold;">100%</div>
                <div id="multiplier-reason" style="font-size:11px;opacity:0.8;">Normalpreis</div>
            </div>
            
            <!-- Automatische Anpassung -->
            <div style="margin-bottom:20px;">
                <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px;background:#f9fafb;border-radius:8px;">
                    <input type="checkbox" id="auto-surge-enabled" onchange="savePricingSettings()" checked style="width:20px;height:20px;">
                    <div>
                        <div style="font-weight:600;font-size:14px;">ğŸ“Š Automatisch (Auslastung)</div>
                        <div style="font-size:12px;color:#666;">Preis steigt bei hoher Nachfrage</div>
                    </div>
                </label>
                <div style="margin-top:10px;padding:10px;background:#f0fdf4;border-radius:8px;display:flex;align-items:center;gap:10px;">
                    <span style="font-size:13px;">Pro aktivem Taxi:</span>
                    <select id="surge-per-taxi" onchange="savePricingSettings()" style="padding:8px;border-radius:6px;border:1px solid #d1d5db;font-size:14px;">
                        <option value="5">+5%</option>
                        <option value="10" selected>+10%</option>
                        <option value="15">+15%</option>
                        <option value="20">+20%</option>
                    </select>
                </div>
            </div>
            
            <!-- Manueller Aufschlag/Rabatt -->
            <div style="margin-bottom:20px;">
                <div style="font-weight:600;font-size:14px;margin-bottom:10px;">ğŸšï¸ Manueller Aufschlag/Rabatt</div>
                <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;">
                    <button onclick="setManualMultiplier(-20)" class="multiplier-btn" data-value="-20" style="padding:12px 5px;border:2px solid #e5e7eb;background:white;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;color:#10b981;">-20%</button>
                    <button onclick="setManualMultiplier(-10)" class="multiplier-btn" data-value="-10" style="padding:12px 5px;border:2px solid #e5e7eb;background:white;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;color:#10b981;">-10%</button>
                    <button onclick="setManualMultiplier(0)" class="multiplier-btn active" data-value="0" style="padding:12px 5px;border:2px solid #667eea;background:#667eea;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;color:white;">0%</button>
                    <button onclick="setManualMultiplier(10)" class="multiplier-btn" data-value="10" style="padding:12px 5px;border:2px solid #e5e7eb;background:white;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;color:#ef4444;">+10%</button>
                    <button onclick="setManualMultiplier(20)" class="multiplier-btn" data-value="20" style="padding:12px 5px;border:2px solid #e5e7eb;background:white;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;color:#ef4444;">+20%</button>
                </div>
            </div>
            
            <!-- Status-Info -->
            <div style="padding:12px;background:#fef3c7;border-radius:8px;font-size:12px;">
                <strong>ğŸ“ˆ So wird der Preis berechnet:</strong><br>
                Grundpreis Ã— (100% + Auto-Surge + Manuell) = Endpreis<br>
                <span id="pricing-example" style="color:#666;">Beispiel: 14.60â‚¬ Ã— 100% = 14.60â‚¬</span>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        let firebaseLoadTimeout, firebaseLoaded = false;
        firebaseLoadTimeout = setTimeout(() => { 
            if (!firebaseLoaded && typeof initApp === 'function') initApp(false); 
        }, 5000);
    </script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js" onload="firebaseLoaded = true;" onerror="if(typeof initApp === 'function') initApp(false);"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script>
        // CONFIGURATION
        // ğŸš— FAHRZEUGE - werden aus Firebase geladen, Fallback auf Hardcoded
        const DEFAULT_VEHICLES = {
            'tesla_model3_1': { name: 'Tesla Model 3 #1', id: 'tesla_model3_1', plate: 'PW-TX 111' },
            'tesla_model3_2': { name: 'Tesla Model 3 #2', id: 'tesla_model3_2', plate: 'PW-TX 222' },
            'tesla_model3_3': { name: 'Tesla Model 3 #3', id: 'tesla_model3_3', plate: 'PW-TX 333' },
            'tesla_modely_1': { name: 'Tesla Model Y #1', id: 'tesla_modely_1', plate: 'PW-MY 222' },
            'tesla_modely_2': { name: 'Tesla Model Y #2', id: 'tesla_modely_2', plate: 'PW-MY 333' }
        };
        let VEHICLES = { ...DEFAULT_VEHICLES }; // Wird aus Firebase Ã¼berschrieben
        const TARIF = { 
            grundgebuehr: 4.00,
            // Gestaffelte Kilometerpreise (offizieller Tarif August 2022)
            km_1_2: 3.30,      // Kilometer 1-2
            km_3_4: 2.80,      // Kilometer 3-4
            km_ab_5: 2.20,     // Ab Kilometer 5
            // ZuschlÃ¤ge
            nachtZuschlag: 0.20, 
            sonntagZuschlag: 0.25, 
            feiertagZuschlag: 0.50,
            // Nachttarif
            nacht_grundgebuehr: 5.50,
            nacht_km_1_2: 3.30,
            nacht_km_3_4: 2.80,
            nacht_km_ab_5: 2.40
        };
        const USEDOM_ORTE = ['Heringsdorf', 'Ahlbeck', 'Bansin', 'Zinnowitz', 'Ãœckeritz', 'Loddin', 'Zempin', 'Koserow', 'Karlshagen', 'PeenemÃ¼nde', 'Trassenheide'];
        
        // ğŸ”„ VERSION-CHECK SYSTEM (jetzt im <head> - siehe oben!)
        const APP_VERSION = '5.21.8';
        const APP_BUILD = '20251127-BLACKLIST-FIX';
        
        // âœ… v5.10.0: Auto-Update System KOMPLETT ENTFERNT!
        // War zu fehleranfÃ¤llig mit Service Worker Cache-Problemen.
        // Jetzt: Stabile Version, User lÃ¤dt bei Bedarf manuell neu.
        // â†’ Kein rekursiver Aufruf mehr
        // â†’ Nur 1x beim Start
        // â†’ "SpÃ¤ter" Button funktioniert korrekt
        
        // Bekannte Koordinaten fÃ¼r wichtige Orte (Fallback)
        const KNOWN_PLACES = {
            'heringsdorf': { lat: 53.9533, lon: 14.1633, name: 'Heringsdorf' },
            'bahnhof heringsdorf': { lat: 53.9533, lon: 14.1633, name: 'Bahnhof Heringsdorf' },
            'ahlbeck': { lat: 53.9444, lon: 14.1933, name: 'Ahlbeck' },
            'seebrÃ¼cke ahlbeck': { lat: 53.9444, lon: 14.1933, name: 'SeebrÃ¼cke Ahlbeck' },
            'bansin': { lat: 53.9633, lon: 14.1433, name: 'Bansin' },
            'seebrÃ¼cke bansin': { lat: 53.9633, lon: 14.1433, name: 'SeebrÃ¼cke Bansin' },
            'zinnowitz': { lat: 54.0908, lon: 13.9167, name: 'Zinnowitz' },
            'bahnhof zinnowitz': { lat: 54.0908, lon: 13.9167, name: 'Bahnhof Zinnowitz' },
            'Ã¼ckeritz': { lat: 53.9878, lon: 14.0519, name: 'Ãœckeritz' },
            'loddin': { lat: 54.0083, lon: 13.9917, name: 'Loddin' },
            'zempin': { lat: 54.0194, lon: 13.9611, name: 'Zempin' },
            'koserow': { lat: 54.0681, lon: 13.9764, name: 'Koserow' },
            'karlshagen': { lat: 54.1078, lon: 13.8333, name: 'Karlshagen' },
            'peenemÃ¼nde': { lat: 54.1422, lon: 13.7753, name: 'PeenemÃ¼nde' },
            'trassenheide': { lat: 54.0997, lon: 13.8875, name: 'Trassenheide' },
            'usedom': { lat: 53.9533, lon: 14.1633, name: 'Usedom' },
            'swinemÃ¼nde': { lat: 53.9167, lon: 14.2500, name: 'SwinemÃ¼nde' }
        };

        // STATE
        let db, isFirebaseReady = false, isConnected = false, currentVehicle = null, currentView = 'passenger', rides = [], drivers = {};
        let currentBookingCustomerId = null; // FÃ¼r CRM-Update bei Stammkunden-Buchung
        let pickupCoords = null, destCoords = null, map = null, watchId = null, isOnline = false, myCurrentRide = null;
        let currentTrackingRideId = null; // ğŸ†• Aktuelle Fahrt fÃ¼r GPS-Tracking
        let taxiMarker = null, pickupMarker = null, etaUpdateInterval = null, lastSoundDistance = 999;
        let wakeLock = null;
        let cancellations = []; // Neue Variable fÃ¼r Stornierungen
        let notifiedCancellations = new Set(); // ğŸ†• v5.21.7: Verhindert doppelte Stornierung-Alerts
        let bookingSystemOnline = true; // ğŸ†• v5.38.2: Buchungssystem AN/AUS (Standard: AN)
        
        // ğŸ†• v5.38.5: DEBUG-MODUS
        let debugMode = localStorage.getItem('debugMode') === 'true' || false;
        
        // Debug-Console Wrapper
        const debugLog = (...args) => {
            if (debugMode) console.log(...args);
        };
        const debugError = (...args) => {
            if (debugMode) console.error(...args);
        };
        const debugWarn = (...args) => {
            if (debugMode) console.warn(...args);
        };
        
        // ğŸ†• v5.19.0: DUAL-GPS MODUS
        let gpsMode = 'off'; // 'off', 'standby' (LTE), 'active' (GPS)
        let standbyIntervalId = null; // Interval fÃ¼r Standby-Modus
        
        // ğŸ›¡ï¸ DUPLIKAT-SCHUTZ fÃ¼r Telegram
        const sentTelegramRides = new Set(); // Speichert Ride-IDs die schon gesendet wurden
        const warnedOpenRides = new Set(); // ğŸ†• Speichert Ride-IDs fÃ¼r die schon Warnungen gesendet wurden
        
        // ğŸ› SUPER DEBUG SYSTEM
        let debugErrors = [];
        let debugLogs = [];
        let debugFirebaseQueries = [];
        let debugStateChanges = [];
        const MAX_DEBUG_LOGS = 200;
        
        // Catche ALLE JavaScript Errors
        window.addEventListener('error', (e) => {
            const errorInfo = {
                time: new Date().toISOString(),
                message: e.message,
                filename: e.filename || 'unknown',
                line: e.lineno || 0,
                column: e.colno || 0,
                stack: e.error?.stack || 'no stack trace'
            };
            debugErrors.push(errorInfo);
            console.error('ğŸ”´ ERROR CAUGHT:', errorInfo);
        });
        
        // Catche Promise Rejections
        window.addEventListener('unhandledrejection', (e) => {
            const errorInfo = {
                time: new Date().toISOString(),
                message: 'Unhandled Promise Rejection: ' + (e.reason?.message || e.reason),
                stack: e.reason?.stack || 'no stack trace'
            };
            debugErrors.push(errorInfo);
            console.error('ğŸ”´ PROMISE REJECTION:', errorInfo);
        });
        
        // Ãœberschreibe console.log fÃ¼r Debug-Logging
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        console.log = function(...args) {
            debugLogs.push({
                time: new Date().toISOString(),
                type: 'log',
                message: args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ')
            });
            if (debugLogs.length > MAX_DEBUG_LOGS) debugLogs.shift();
            originalLog.apply(console, args);
        };
        
        console.error = function(...args) {
            debugLogs.push({
                time: new Date().toISOString(),
                type: 'error',
                message: args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ')
            });
            if (debugLogs.length > MAX_DEBUG_LOGS) debugLogs.shift();
            originalError.apply(console, args);
        };
        
        console.warn = function(...args) {
            debugLogs.push({
                time: new Date().toISOString(),
                type: 'warn',
                message: args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ')
            });
            if (debugLogs.length > MAX_DEBUG_LOGS) debugLogs.shift();
            originalWarn.apply(console, args);
        };
        
        // Helper: Log State Change
        function logStateChange(description, oldValue, newValue) {
            debugStateChanges.push({
                time: new Date().toISOString(),
                description,
                oldValue,
                newValue
            });
        }
        
        // Helper: Log Firebase Query
        function logFirebaseQuery(path, result) {
            debugFirebaseQueries.push({
                time: new Date().toISOString(),
                path,
                result: typeof result === 'object' ? JSON.stringify(result).substring(0, 200) : String(result)
            });
        }
        
        // ğŸ†• AUTO-ZUWEISUNG & PUSH
        let assignmentTimers = {}; // Timer fÃ¼r 30-Sek-Countdown
        let notificationPermission = null;
        let serviceWorkerRegistration = null;
        let pushSubscription = null;
        let regularCustomer = null; // Stammkunden-Daten
        
        // ğŸ“… HISTORY TAB STATE
        let currentHistoryTab = 'upcoming'; // 'upcoming' oder 'past'
        
        // ğŸ” AUTH STATE
        let auth = null;
        let currentUser = null;

        // ğŸ’¾ SAVE RIDES TO LOCALSTORAGE
        function saveRides() {
            try {
                localStorage.setItem('rides', JSON.stringify(rides));
                console.log('ğŸ’¾ Rides gespeichert:', rides.length);
            } catch (error) {
                console.error('âŒ Fehler beim Speichern:', error);
            }
        }
        
        // ğŸŒŸ STAMMKUNDEN-FUNKTIONEN
        function loadRegularCustomer() {
            // âœ… Nur laden wenn User eingeloggt
            if (!currentUser) return;
            
            // âœ… Stammkunden-Daten pro Email-Adresse
            const storageKey = `regularCustomer_${currentUser.email}`;
            const saved = localStorage.getItem(storageKey);
            if (saved) {
                regularCustomer = JSON.parse(saved);
                showRegularCustomerBox();
            }
        }
        
        function showRegularCustomerBox() {
            if (!regularCustomer) return;
            
            const box = document.getElementById('regular-customer-box');
            const info = document.getElementById('regular-customer-info');
            
            // ğŸ›¡ï¸ Sicherheitscheck: Nur setzen wenn Element existiert
            if (!info || !box) {
                console.log('Stammkunden-Elemente noch nicht geladen, versuche spÃ¤ter...');
                return;
            }
            
            info.innerHTML = `
                ğŸ‘¤ <strong>${regularCustomer.name}</strong><br>
                ${regularCustomer.phone ? `ğŸ“ ${regularCustomer.phone}<br>` : ''}
                ğŸ“ HÃ¤ufig: ${regularCustomer.favoritePickup || 'Noch keine Fahrten'}<br>
                ğŸš• ${regularCustomer.rideCount || 0} Fahrten bisher
            `;
            
            box.style.display = 'block';
        }
        
        function useRegularCustomerData() {
            if (!regularCustomer) return;
            
            document.getElementById('customer-name').value = regularCustomer.name;
            if (regularCustomer.favoritePickup) {
                document.getElementById('pickup').value = regularCustomer.favoritePickup;
            }
            if (regularCustomer.favoriteDestination) {
                document.getElementById('destination').value = regularCustomer.favoriteDestination;
            }
            // âœ… TELEFON LADEN!
            if (regularCustomer.phone) {
                document.getElementById('customer-phone').value = regularCustomer.phone;
            }
            
            alert('âœ… Deine Daten wurden eingefÃ¼gt!\n\nÃœberprÃ¼fe die Adresse und buche dann dein Taxi.');
        }
        
        function clearRegularCustomer() {
            if (confirm('âš ï¸ Stammkundendaten lÃ¶schen?\n\nDu musst beim nÃ¤chsten Mal alles neu eingeben.')) {
                if (currentUser) {
                    const storageKey = `regularCustomer_${currentUser.email}`;
                    localStorage.removeItem(storageKey);
                }
                regularCustomer = null;
                document.getElementById('regular-customer-box').style.display = 'none';
                alert('âœ… Stammkundendaten gelÃ¶scht');
            }
        }
        
        function saveRegularCustomerData(name, pickup, destination) {
            // Alte Funktion - nicht mehr benÃ¶tigt
            // CRM wird jetzt automatisch Ã¼ber updateCustomerCRM() aktualisiert
        }
        
        // ğŸ“… HISTORY TAB FUNCTIONS
        function showHistoryTab(tab) {
            currentHistoryTab = tab;
            
            // Update Button Styles
            const upcomingBtn = document.getElementById('tab-upcoming');
            const pastBtn = document.getElementById('tab-past');
            
            if (tab === 'upcoming') {
                upcomingBtn.style.background = '#667eea';
                upcomingBtn.style.color = 'white';
                pastBtn.style.background = 'white';
                pastBtn.style.color = '#667eea';
            } else {
                upcomingBtn.style.background = 'white';
                upcomingBtn.style.color = '#667eea';
                pastBtn.style.background = '#667eea';
                pastBtn.style.color = 'white';
            }
            
            // Update History List
            updateHistoryView();
        }
        
        async function updateHistoryView() {
            console.log('ğŸ“– updateHistoryView aufgerufen - Tab:', currentHistoryTab);
            const historyList = document.getElementById('history-list');
            let allRides = [];
            
            // ğŸ“¦ Hole Fahrten aus localStorage
            const localHistory = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            console.log('ğŸ” DEBUG - localStorage Fahrten:', localHistory.length);
            console.log('ğŸ” DEBUG - currentHistoryTab:', currentHistoryTab);
            console.log('ğŸ” DEBUG - currentUser:', currentUser ? 'eingeloggt' : 'nicht eingeloggt');
            
            // ğŸ”¥ Hole MEINE Fahrten aus Firebase (wenn verfÃ¼gbar)
            let firebaseRides = [];
            let firebaseRideIds = [];
            if (isFirebaseReady && currentUser) {
                try {
                    const snapshot = await db.ref('rides').orderByChild('userId').equalTo(currentUser.uid).once('value');
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            const ride = childSnapshot.val();
                            ride.firebaseId = childSnapshot.key;
                            firebaseRides.push(ride);
                            firebaseRideIds.push(ride.id);
                        });
                    }
                } catch (error) {
                    console.error('âŒ Fehler beim Laden der Firebase Fahrten:', error);
                }
            }
            
            // ğŸ†• v5.26.14g: FIREBASE HAT VORRANG!
            // Merge-Logik: Firebase-Status Ã¼berschreibt localStorage
            const rideMap = new Map();
            
            // 1. FÃ¼ge localStorage-Fahrten hinzu (als Basis)
            localHistory.forEach(localRide => {
                rideMap.set(localRide.id, localRide);
            });
            
            // 2. Ãœberschreibe mit Firebase-Fahrten (haben Vorrang!)
            firebaseRides.forEach(fbRide => {
                rideMap.set(fbRide.id, fbRide);
                console.log('âœ… Firebase-Fahrt hat Vorrang:', fbRide.id, 'Status:', fbRide.status);
            });
            
            // 3. Entferne Fahrten die in Firebase gelÃ¶scht wurden
            if (currentUser && isFirebaseReady) {
                localHistory.forEach(localRide => {
                    const existsInFirebase = firebaseRideIds.includes(localRide.id);
                    if (!existsInFirebase) {
                        console.log('ğŸ—‘ï¸ Entferne gelÃ¶schte Fahrt:', localRide.id);
                        rideMap.delete(localRide.id);
                    }
                });
            }
            
            // 4. Konvertiere Map zurÃ¼ck zu Array
            allRides = Array.from(rideMap.values());
            
            // 5. Aktualisiere localStorage mit aktuellen Status
            if (currentUser && isFirebaseReady && allRides.length > 0) {
                localStorage.setItem('rideHistory', JSON.stringify(allRides));
                console.log('âœ… localStorage aktualisiert mit Firebase-Status:', allRides.length, 'Fahrten');
            }
            
            console.log('ğŸ” DEBUG - Alle Fahrten nach Merge:', allRides.length);
            if (allRides.length > 0) {
                console.log('ğŸ” DEBUG - Status der Fahrten:', allRides.map(r => r.status));
            }
            
            if (allRides.length === 0) {
                historyList.innerHTML = '<div style="text-align:center;padding:40px;color:#999;"><p>Noch keine Fahrten</p></div>';
                return;
            }
            
            const now = Date.now();
            let filteredRides = [];
            
            if (currentHistoryTab === 'upcoming') {
                // ğŸ“… KOMMENDE FAHRTEN: vorbestellt, new, accepted, picked_up, etc.
                filteredRides = allRides.filter(r => {
                    const activeStatuses = ['vorbestellt', 'new', 'accepted', 'picked_up', 'akzeptiert', 'unterwegs', 'angekommen', 'assigned_to_driver', 'assigned'];
                    const isActiveStatus = activeStatuses.includes(r.status);
                    
                    // ğŸ†• v5.32.5d: FÃ¼r vorbestellte Fahrten â†’ PrÃ¼fe ob Zeit noch nicht vorbei!
                    if (r.status === 'vorbestellt' && r.pickupTimestamp) {
                        const isFuture = r.pickupTimestamp > now;
                        if (!isFuture) {
                            console.log('â° Ãœberspringe alte Vorbestellung:', r.firebaseId, new Date(r.pickupTimestamp));
                        }
                        return isFuture;
                    }
                    
                    return isActiveStatus;
                }).sort((a, b) => (a.pickupTimestamp || a.createdAt) - (b.pickupTimestamp || b.createdAt));
            } else {
                // ğŸ“– VERGANGENE FAHRTEN: completed, cancelled, storniert + alte Vorbestellungen
                filteredRides = allRides.filter(r => {
                    const completedStatuses = ['completed', 'abgeschlossen', 'cancelled', 'storniert'];
                    const isCompletedStatus = completedStatuses.includes(r.status);
                    
                    // ğŸ†• v5.32.5d: Alte Vorbestellungen auch hier anzeigen!
                    const isOldPreorder = r.status === 'vorbestellt' && r.pickupTimestamp && r.pickupTimestamp < now;
                    
                    return isCompletedStatus || isOldPreorder;
                }).sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            }
            
            console.log('ğŸ” DEBUG - Gefilterte Fahrten:', filteredRides.length);
            console.log('ğŸ” DEBUG - Gefilterte Status:', filteredRides.map(r => r.status));
            
            if (filteredRides.length === 0) {
                const emptyMessage = currentHistoryTab === 'upcoming' 
                    ? 'ğŸ“… Keine kommenden Fahrten'
                    : 'ğŸ“– Noch keine vergangenen Fahrten';
                historyList.innerHTML = `<div style="text-align:center;padding:40px;color:#999;"><p>${emptyMessage}</p></div>`;
                return;
            }
            
            historyList.innerHTML = filteredRides.map(r => {
                const isActive = currentHistoryTab === 'upcoming';
                
                // ğŸ¨ Farben basierend auf Status
                let bgColor, borderColor, statusEmoji, statusText;
                
                switch(r.status) {
                    case 'vorbestellt':
                        bgColor = '#fef3c7';
                        borderColor = '#f59e0b';
                        statusEmoji = 'ğŸ“…';
                        statusText = 'Vorbestellt';
                        break;
                    case 'new':
                        bgColor = '#dbeafe';
                        borderColor = '#3b82f6';
                        statusEmoji = 'ğŸ””';
                        statusText = 'Sucht Fahrer...';
                        break;
                    case 'akzeptiert':
                        bgColor = '#d1fae5';
                        borderColor = '#10b981';
                        statusEmoji = 'âœ…';
                        statusText = 'Fahrer akzeptiert';
                        break;
                    case 'unterwegs':
                        bgColor = '#e0f2fe';
                        borderColor = '#0ea5e9';
                        statusEmoji = 'ğŸš—';
                        statusText = 'Fahrer unterwegs';
                        break;
                    case 'angekommen':
                        bgColor = '#fce7f3';
                        borderColor = '#ec4899';
                        statusEmoji = 'ğŸ¯';
                        statusText = 'Fahrer angekommen';
                        break;
                    case 'abgeschlossen':
                        bgColor = 'white';
                        borderColor = '#e0e0e0';
                        statusEmoji = 'âœ…';
                        statusText = 'Abgeschlossen';
                        break;
                    case 'storniert':
                        bgColor = '#fee2e2';
                        borderColor = '#ef4444';
                        statusEmoji = 'âŒ';
                        statusText = 'Storniert';
                        break;
                    default:
                        bgColor = 'white';
                        borderColor = '#e0e0e0';
                        statusEmoji = 'ğŸ“„';
                        statusText = r.status;
                }
                
                // ğŸ• Zeitanzeige
                let timeDisplay = r.pickupTime || 'Sofort';
                if (r.pickupTimestamp) {
                    const pickupDate = new Date(r.pickupTimestamp);
                    timeDisplay = pickupDate.toLocaleString('de-DE', {
                        weekday: 'short',
                        day: '2-digit',
                        month: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
                
                // ğŸš— Fahrzeug-Info (falls vorhanden)
                let vehicleInfo = '';
                if (r.assignedDriver && r.vehicleLabel) {
                    vehicleInfo = `<div style="margin-top:8px;padding:8px;background:rgba(102,126,234,0.1);border-radius:6px;font-size:12px;">
                        ğŸš— <strong>${r.vehicleLabel}</strong>
                    </div>`;
                }
                
                // â±ï¸ ETA Info (falls Fahrer unterwegs)
                let etaInfo = '';
                if (r.status === 'unterwegs' && r.eta) {
                    etaInfo = `<div style="margin-top:8px;padding:8px;background:#dcfce7;border-radius:6px;font-size:13px;font-weight:600;color:#166534;">
                        â±ï¸ Ankunft in ca. ${r.eta} Min
                    </div>`;
                }
                
                // ğŸš¨ STORNIERUNGSGRUND (falls vorhanden)
                let cancellationInfo = '';
                if (r.status === 'storniert' && r.cancellationReason) {
                    cancellationInfo = `<div style="margin-top:8px;padding:10px;background:#fee2e2;border-left:4px solid #ef4444;border-radius:6px;font-size:13px;color:#991b1b;">
                        <strong>ğŸš¨ Stornierungsgrund:</strong><br>
                        ${r.cancellationReason}
                    </div>`;
                }
                
                // ğŸ”˜ Aktions-Buttons
                let actionButtons = '';
                
                // ğŸ†• v5.32.3: TRACKING-LINK BUTTON (fÃ¼r alle Fahrten!)
                const trackingLink = r.firebaseId ? `${window.location.origin}${window.location.pathname}?ride=${r.firebaseId}` : null;
                let trackingButton = '';
                if (trackingLink) {
                    trackingButton = `
                        <button onclick="openTrackingLink('${trackingLink}')" 
                            style="width:100%;margin-top:10px;padding:10px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">
                            ğŸ”— Tracking Ã¶ffnen
                        </button>
                        <button onclick="shareTrackingLink('${trackingLink}')" 
                            style="width:100%;margin-top:8px;padding:8px;background:white;color:#3b82f6;border:2px solid #3b82f6;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;">
                            ğŸ“² Link teilen
                        </button>
                    `;
                }
                
                // ğŸ†• v5.32.3: SMS/TELEGRAM STATUS ANZEIGEN
                let notificationStatus = '';
                if (r.notificationsSent) {
                    const smsIcon = r.notificationsSent.sms ? 'âœ…' : 'â³';
                    const telegramIcon = r.notificationsSent.telegram ? 'âœ…' : 'â³';
                    notificationStatus = `
                        <div style="margin-top:10px;padding:8px;background:#f0f9ff;border:1px solid #bfdbfe;border-radius:6px;font-size:11px;color:#1e40af;">
                            ğŸ“² <strong>Benachrichtigungen:</strong><br>
                            ${smsIcon} SMS ${r.notificationsSent.sms ? 'gesendet' : 'ausstehend'} | 
                            ${telegramIcon} Telegram ${r.notificationsSent.telegram ? 'gesendet' : 'nicht verknÃ¼pft'}
                        </div>
                    `;
                }
                
                if (isActive && r.status !== 'storniert') {
                    // ğŸ†• v5.26.14f: Keine Stornierung bei picked_up!
                    if (r.status === 'picked_up') {
                        actionButtons = `
                            <div style="padding:12px;background:#fef3c7;border-left:4px solid #f59e0b;border-radius:6px;font-size:13px;color:#92400e;margin-top:10px;">
                                âš ï¸ <strong>Fahrt lÃ¤uft bereits</strong><br>
                                Stornierung nicht mehr mÃ¶glich
                            </div>
                        `;
                    } else if (r.status === 'vorbestellt' || r.status === 'new') {
                        // Vorbestellungen + Neue Fahrten: Bearbeiten & Stornieren
                        actionButtons = `
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;">
                                <button onclick="editRide('${r.firebaseId || r.id}')" 
                                    style="padding:10px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">
                                    âœï¸ Bearbeiten
                                </button>
                                <button onclick="cancelRideFromHistory('${r.firebaseId || r.id}')" 
                                    style="padding:10px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">
                                    ğŸ—‘ï¸ Stornieren
                                </button>
                            </div>
                        `;
                    } else if (r.firebaseId) {
                        actionButtons = `<button onclick="viewRideDetails('${r.firebaseId}')" 
                            style="width:100%;margin-top:10px;padding:10px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">
                            ğŸ‘ï¸ Details anzeigen
                        </button>`;
                    }
                } else {
                    // Vergangene Fahrten: Buttons inkl. Rechnung + Stornobeleg
                    
                    // ğŸ“„ RECHNUNG-Button fÃ¼r abgeschlossene Fahrten
                    // ğŸ†• v5.26.14g: RECHNUNG REGELN
                    let documentButton = '';
                    
                    if (r.status === 'abgeschlossen' || r.status === 'completed') {
                        // âœ… Normale Rechnung fÃ¼r abgeschlossene Fahrten
                        documentButton = `
                            <button onclick="downloadReceipt(${r.createdAt || r.id})" 
                                style="width:100%;margin-top:8px;padding:10px;background:#8b5cf6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">
                                ğŸ“„ Rechnung laden
                            </button>
                        `;
                    } else if (r.status === 'storniert' || r.status === 'cancelled') {
                        // ğŸš¨ Stornobeleg NUR wenn innerhalb 60 Minuten storniert!
                        const createdAt = r.createdAt || 0;
                        const cancelledAt = r.cancelledAt || r.completedAt || 0;
                        const timeDiff = cancelledAt - createdAt;
                        const minutesDiff = Math.floor(timeDiff / (60 * 1000));
                        
                        if (minutesDiff <= 60 && minutesDiff >= 0) {
                            // Innerhalb 60 Min â†’ 15% StornogebÃ¼hr
                            const cancellationFee = Math.round((r.price || 0) * 0.15 * 100) / 100;
                            documentButton = `
                                <button onclick="downloadCancellationReceipt(${r.createdAt || r.id})" 
                                    style="width:100%;margin-top:8px;padding:10px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">
                                    ğŸ“„ Stornobeleg laden (${cancellationFee.toFixed(2)}â‚¬)
                                </button>
                            `;
                        }
                        // Sonst: Kein Button (kostenlose Stornierung)
                    }
                    
                    actionButtons = `
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;">
                            <button onclick="rebookRide(${r.createdAt || r.id})" 
                                style="padding:10px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">
                                ğŸ” Nochmal
                            </button>
                            <button onclick="reverseRouteFromHistory(${r.createdAt || r.id})" 
                                style="padding:10px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">
                                ğŸ”„ Umdrehen
                            </button>
                        </div>
                        <button onclick="saveAsFavorite(${r.createdAt || r.id})" 
                            style="width:100%;margin-top:8px;padding:10px;background:#f59e0b;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">
                            â­ Als Favorit
                        </button>
                        ${documentButton}
                    `;
                }
                
                return `
                    <div style="background:${bgColor};border:2px solid ${borderColor};border-radius:12px;padding:15px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                        <div style="font-weight:600;color:#374151;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                            <span>${statusEmoji} ${statusText}</span>
                            ${isActive ? '<span style="font-size:11px;color:#6b7280;">ğŸ• ' + timeDisplay + '</span>' : ''}
                        </div>
                        ${!isActive ? `<div style="font-size:12px;color:#666;margin-bottom:8px;">ğŸ• ${timeDisplay}</div>` : ''}
                        <div style="margin:10px 0;font-size:14px;">
                            ğŸ“ <strong>Von:</strong> ${r.pickup}<br>
                            ğŸ¯ <strong>Nach:</strong> ${r.destination}
                        </div>
                        <div style="display:flex;gap:12px;margin-top:8px;font-size:13px;color:#666;">
                            <span>ğŸ’° ${r.price}â‚¬</span>
                            <span>ğŸ“ ${r.distance} km</span>
                            ${r.passengers ? `<span>ğŸ‘¥ ${r.passengers}</span>` : ''}
                        </div>
                        ${vehicleInfo}
                        ${etaInfo}
                        ${cancellationInfo}
                        ${notificationStatus}
                        ${trackingButton}
                        ${actionButtons}
                    </div>
                `;
            }).join('');
        }

        // ğŸ“… DATUM & ZEIT PICKER
        // NOTE: Diese Funktion wird in v5.30.0 nicht mehr verwendet (Sofort/Vorbestellen UX)
        function handlePickupTimeChange() {
            const select = document.getElementById('pickup-time');
            if (!select) return; // Element existiert nicht mehr in v5.30.0
            
            const datetimePicker = document.getElementById('custom-datetime');
            const datetimeContainer = document.getElementById('custom-datetime-container');
            const helpText = document.getElementById('datetime-help');
            
            if (select.value === 'datetime') {
                // Verstecke alten Picker, zeige neuen Container
                datetimePicker.style.display = 'none';
                datetimeContainer.style.display = 'block';
                if (helpText) helpText.style.display = 'block';
                
                // Setze Standard auf jetzt + 1 Stunde (gerundet auf 5 Min)
                const defaultTime = new Date();
                defaultTime.setHours(defaultTime.getHours() + 1);
                
                // ğŸ”§ Runde auf nÃ¤chste 5 Minuten
                const roundedMinutes = Math.ceil(defaultTime.getMinutes() / 5) * 5;
                defaultTime.setMinutes(roundedMinutes % 60);
                if (roundedMinutes >= 60) defaultTime.setHours(defaultTime.getHours() + 1);
                
                // Setze Werte
                const dateInput = document.getElementById('custom-date');
                const hourSelect = document.getElementById('custom-hour');
                const minuteSelect = document.getElementById('custom-minute');
                
                // Datum im Format YYYY-MM-DD
                const year = defaultTime.getFullYear();
                const month = String(defaultTime.getMonth() + 1).padStart(2, '0');
                const day = String(defaultTime.getDate()).padStart(2, '0');
                dateInput.value = `${year}-${month}-${day}`;
                
                // Minimum-Datum auf heute setzen
                const today = new Date();
                const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                dateInput.min = todayStr;
                
                // Stunde und Minute
                hourSelect.value = String(defaultTime.getHours()).padStart(2, '0');
                minuteSelect.value = String(defaultTime.getMinutes()).padStart(2, '0');
                
            } else {
                datetimePicker.style.display = 'none';
                datetimeContainer.style.display = 'none';
                if (helpText) helpText.style.display = 'none';
            }
        }
        
        // ğŸ†• v5.30.0: Fahrt-Typ wÃ¤hlen (Sofort / Vorbestellen)
        let currentRideType = null; // 'sofort' oder 'vorbestellen'
        
        function selectRideType(type) {
            currentRideType = type;
            
            const btnSofort = document.getElementById('btn-sofort');
            const btnVorbestellen = document.getElementById('btn-vorbestellen');
            const sofortBereich = document.getElementById('sofort-bereich');
            const vorbestellenBereich = document.getElementById('vorbestellen-bereich');
            
            if (type === 'sofort') {
                // âš¡ SOFORT Button aktiv
                btnSofort.style.border = '3px solid #10b981';
                btnSofort.style.background = 'linear-gradient(135deg,#10b981,#059669)';
                btnSofort.querySelector('div:nth-child(2)').style.color = 'white';
                btnSofort.querySelector('div:nth-child(3)').style.color = 'rgba(255,255,255,0.9)';
                
                // ğŸ“… VORBESTELLEN Button inaktiv
                btnVorbestellen.style.border = '3px solid #e5e7eb';
                btnVorbestellen.style.background = 'white';
                btnVorbestellen.querySelector('div:nth-child(2)').style.color = '#6b7280';
                btnVorbestellen.querySelector('div:nth-child(3)').style.color = '#666';
                
                // Bereiche zeigen/verstecken
                sofortBereich.style.display = 'block';
                vorbestellenBereich.style.display = 'none';
                
                // âœ… WENN Abholadresse bereits eingegeben â†’ Lade Taxis!
                const pickupInput = document.getElementById('pickup');
                if (pickupInput && pickupInput.value.trim()) {
                    console.log('ğŸ“ Abholadresse vorhanden, lade Taxis...');
                    
                    // Zeige Loading
                    const display = document.getElementById('available-taxis-display');
                    display.innerHTML = `
                        <div style="padding:20px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:12px;text-align:center;margin-top:10px;">
                            <div style="font-size:20px;margin-bottom:10px;">ğŸ“</div>
                            <div style="font-weight:600;font-size:16px;margin-bottom:5px;">Suche verfÃ¼gbare Taxis...</div>
                            <div style="font-size:13px;opacity:0.9;">Bitte warten...</div>
                        </div>
                    `;
                    
                    setTimeout(() => {
                        showAvailableTaxis();
                    }, 500);
                }
                
            } else if (type === 'vorbestellen') {
                // ğŸ“… VORBESTELLEN Button aktiv
                btnVorbestellen.style.border = '3px solid #667eea';
                btnVorbestellen.style.background = 'linear-gradient(135deg,#667eea,#764ba2)';
                btnVorbestellen.querySelector('div:nth-child(2)').style.color = 'white';
                btnVorbestellen.querySelector('div:nth-child(3)').style.color = 'rgba(255,255,255,0.9)';
                
                // âš¡ SOFORT Button inaktiv
                btnSofort.style.border = '3px solid #e5e7eb';
                btnSofort.style.background = 'white';
                btnSofort.querySelector('div:nth-child(2)').style.color = '#6b7280';
                btnSofort.querySelector('div:nth-child(3)').style.color = '#666';
                
                // Bereiche zeigen/verstecken
                sofortBereich.style.display = 'none';
                vorbestellenBereich.style.display = 'block';
                
                // ğŸ“… Initialisiere Datum/Zeit-Felder mit sinnvollen Defaults
                initVorbestellenDefaults();
            }
        }
        
        // ğŸ†• v5.32.0: Setze Default-Werte fÃ¼r Vorbestellen-Felder
        function initVorbestellenDefaults() {
            const datetimeContainer = document.getElementById('custom-datetime-container');
            const helpText = document.getElementById('datetime-help');
            
            // Zeige die Felder
            datetimeContainer.style.display = 'block';
            if (helpText) helpText.style.display = 'block';
            
            // Setze Standard auf jetzt + 1 Stunde (gerundet auf 5 Min)
            const defaultTime = new Date();
            defaultTime.setHours(defaultTime.getHours() + 1);
            
            // ğŸ”§ Runde auf nÃ¤chste 5 Minuten
            const roundedMinutes = Math.ceil(defaultTime.getMinutes() / 5) * 5;
            defaultTime.setMinutes(roundedMinutes % 60);
            if (roundedMinutes >= 60) defaultTime.setHours(defaultTime.getHours() + 1);
            
            // Setze Werte
            const dateInput = document.getElementById('custom-date');
            const hourSelect = document.getElementById('custom-hour');
            const minuteSelect = document.getElementById('custom-minute');
            
            // Datum im Format YYYY-MM-DD
            const year = defaultTime.getFullYear();
            const month = String(defaultTime.getMonth() + 1).padStart(2, '0');
            const day = String(defaultTime.getDate()).padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;
            
            // Minimum-Datum auf heute setzen
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            dateInput.min = todayStr;
            
            // Stunde und Minute
            hourSelect.value = String(defaultTime.getHours()).padStart(2, '0');
            minuteSelect.value = String(defaultTime.getMinutes()).padStart(2, '0');
        }

        // ğŸ—‘ï¸ Fahrt aus Verlauf stornieren
        async function cancelRideFromHistory(rideId) {
            const confirmCancel = confirm('ğŸ—‘ï¸ Fahrt wirklich stornieren?');
            if (!confirmCancel) return;
            
            // Update Firebase mit updateRide() fÃ¼r Telegram-Benachrichtigung
            if (isFirebaseReady && rideId) {
                try {
                    await updateRide(rideId, { 
                        status: 'storniert',
                        cancelledAt: Date.now()
                    });
                    console.log('âœ… Fahrt in Firebase storniert');
                } catch (error) {
                    console.error('âŒ Fehler beim Stornieren in Firebase:', error);
                }
            }
            
            // Update localStorage
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            const ride = history.find(r => r.firebaseId === rideId || r.id === rideId);
            if (ride) {
                ride.status = 'storniert';
                ride.cancelledAt = Date.now();
                localStorage.setItem('rideHistory', JSON.stringify(history));
                console.log('âœ… Fahrt in localStorage storniert');
            }
            
            alert('âœ… Fahrt wurde storniert');
            updateHistoryView();
        }
        
        // ğŸ‘ï¸ Fahrtdetails anzeigen (wechselt zum Fahrgast-Tab und zeigt Status)
        function viewRideDetails(rideId) {
            if (!isFirebaseReady || !rideId) return;
            
            // Lade Fahrt und zeige Status an
            db.ref('rides/' + rideId).once('value', (snapshot) => {
                const ride = snapshot.val();
                if (ride) {
                    ride.firebaseId = rideId;
                    myCurrentRide = ride;
                    localStorage.setItem('myCurrentRideId', rideId);
                    
                    // Wechsel zum Fahrgast-Tab
                    switchView('passenger');
                    
                    // Zeige Fahrt-Status
                    showRideStatus(ride);
                    
                    // Starte Live-Listener
                    listenToMyRide(rideId);
                }
            });
        }
        
        // ğŸ” FAHRT WIEDERHOLEN
        function rebookRide(rideId) {
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            const ride = history.find(r => r.createdAt === rideId || r.id === rideId);
            
            if (!ride) {
                alert('âŒ Fahrt nicht gefunden');
                return;
            }
            
            // Wechsel zum Fahrgast-Tab
            switchView('passenger');
            
            // âœ… Warte kurz bis View gewechselt hat
            setTimeout(() => {
                // FÃ¼lle Formular aus
                document.getElementById('pickup').value = ride.pickup;
                document.getElementById('destination').value = ride.destination;
                document.getElementById('customer-name').value = ride.customerName || '';
                document.getElementById('passengers').value = ride.passengers || '1';
                
                // âœ… LÃ¶sche alte Koordinaten (mÃ¼ssen neu berechnet werden)
                pickupCoords = null;
                destCoords = null;
                
                // âœ… Setze Preis-Anzeige zurÃ¼ck
                document.getElementById('price-display').innerHTML = '';
                
                // âœ… Deaktiviere "Taxi buchen" Button
                const bookBtn = document.getElementById('book-taxi-btn');
                if (bookBtn) {
                    bookBtn.disabled = true;
                    bookBtn.style.opacity = '0.5';
                    bookBtn.style.cursor = 'not-allowed';
                }
                
                // âœ… Stelle sicher dass Formular sichtbar ist
                const bookingForm = document.getElementById('booking-form');
                if (bookingForm) {
                    bookingForm.style.display = 'block';
                    // Scroll zum Formular
                    bookingForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                
                // Zeige Hinweis
                setTimeout(() => {
                    alert('âœ… Fahrtdaten Ã¼bernommen!\n\nâš ï¸ WICHTIG:\nBitte PREIS NEU BERECHNEN\n(Tarif kÃ¶nnte sich geÃ¤ndert haben!)');
                }, 300);
            }, 100);
        }
        
        // ğŸ”„ ROUTE UMDREHEN
        function reverseRouteFromHistory(rideId) {
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            const ride = history.find(r => r.createdAt === rideId || r.id === rideId);
            
            if (!ride) {
                alert('âŒ Fahrt nicht gefunden');
                return;
            }
            
            // Wechsel zum Fahrgast-Tab
            switchView('passenger');
            
            // âœ… Warte kurz bis View gewechselt hat
            setTimeout(() => {
                // FÃ¼lle Formular aus MIT UMGEDREHTER ROUTE
                document.getElementById('pickup').value = ride.destination;  // â† GETAUSCHT
                document.getElementById('destination').value = ride.pickup;   // â† GETAUSCHT
                document.getElementById('customer-name').value = ride.customerName || '';
                document.getElementById('passengers').value = ride.passengers || '1';
                
                // âœ… LÃ¶sche alte Koordinaten (mÃ¼ssen neu berechnet werden)
                pickupCoords = null;
                destCoords = null;
                
                // âœ… Setze Preis-Anzeige zurÃ¼ck
                document.getElementById('price-display').innerHTML = '';
                
                // âœ… Deaktiviere "Taxi buchen" Button
                const bookBtn = document.getElementById('book-taxi-btn');
                if (bookBtn) {
                    bookBtn.disabled = true;
                    bookBtn.style.opacity = '0.5';
                    bookBtn.style.cursor = 'not-allowed';
                }
                
                // âœ… Stelle sicher dass Formular sichtbar ist
                const bookingForm = document.getElementById('booking-form');
                if (bookingForm) {
                    bookingForm.style.display = 'block';
                    // Scroll zum Formular
                    bookingForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                
                // Zeige Hinweis
                setTimeout(() => {
                    alert('ğŸ”„ Route umgedreht!\n\n' + 
                          'Von: ' + ride.destination + '\n' +
                          'Nach: ' + ride.pickup + '\n\n' +
                          'âš ï¸ WICHTIG:\nBitte PREIS NEU BERECHNEN\n(Tarif kÃ¶nnte sich geÃ¤ndert haben!)');
                }, 300);
            }, 100);
        }
        
        // â­ ALS FAVORIT SPEICHERN
        function saveAsFavorite(rideId) {
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            const ride = history.find(r => r.createdAt === rideId || r.id === rideId);
            
            if (!ride) {
                alert('âŒ Fahrt nicht gefunden');
                return;
            }
            
            // Lade bestehende Favoriten
            const favorites = JSON.parse(localStorage.getItem('favoritRides') || '[]');
            
            // PrÃ¼fe ob schon vorhanden
            const exists = favorites.some(f => 
                f.pickup === ride.pickup && f.destination === ride.destination
            );
            
            if (exists) {
                alert('â­ Diese Route ist bereits ein Favorit!');
                return;
            }
            
            // FÃ¼ge hinzu
            const favorite = {
                id: Date.now(),
                name: `${ride.pickup} â†’ ${ride.destination}`,
                pickup: ride.pickup,
                destination: ride.destination,
                distance: ride.distance,
                price: ride.price,
                addedAt: Date.now()
            };
            
            favorites.push(favorite);
            localStorage.setItem('favoritRides', JSON.stringify(favorites));
            
            alert('â­ Als Favorit gespeichert!\n\n' +
                  ride.pickup + ' â†’ ' + ride.destination + '\n\n' +
                  'Favoriten findest du im Fahrgast-Tab oben.');
            
            // TODO: Favoriten-Anzeige implementieren
        }
        
        // âœï¸ FAHRT BEARBEITEN
        async function editRide(rideId) {
            // Lade Fahrt aus Firebase
            let ride = null;
            
            if (isFirebaseReady) {
                const snapshot = await db.ref('rides/' + rideId).once('value');
                ride = snapshot.val();
                if (ride) ride.firebaseId = rideId;
            }
            
            // Falls nicht in Firebase, suche in localStorage
            if (!ride) {
                const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
                ride = history.find(r => r.firebaseId === rideId || r.id === rideId);
            }
            
            if (!ride) {
                alert('âŒ Fahrt nicht gefunden');
                return;
            }
            
            // Erstelle Bearbeitungs-Modal
            const pickupDate = ride.pickupTimestamp ? new Date(ride.pickupTimestamp) : new Date();
            // FIX: Konvertiere zu lokaler Zeit fÃ¼r datetime-local Input
            const year = pickupDate.getFullYear();
            const month = String(pickupDate.getMonth() + 1).padStart(2, '0');
            const day = String(pickupDate.getDate()).padStart(2, '0');
            const hours = String(pickupDate.getHours()).padStart(2, '0');
            const minutes = String(pickupDate.getMinutes()).padStart(2, '0');
            const formattedDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;max-width:400px;width:90%;max-height:80vh;overflow-y:auto;">
                    <h3 style="margin-bottom:15px;">âœï¸ Fahrt bearbeiten</h3>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block;margin-bottom:5px;font-weight:600;">ğŸ“ Abholort</label>
                        <input type="text" id="edit-pickup" value="${ride.pickup}" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block;margin-bottom:5px;font-weight:600;">ğŸ¯ Zielort</label>
                        <input type="text" id="edit-destination" value="${ride.destination}" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block;margin-bottom:5px;font-weight:600;">ğŸ‘¤ Kundenname</label>
                        <input type="text" id="edit-customer" value="${ride.customerName || ''}" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block;margin-bottom:5px;font-weight:600;">ğŸ• Abholzeit</label>
                        <input type="datetime-local" id="edit-datetime" step="300" value="${formattedDateTime}" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block;margin-bottom:5px;font-weight:600;">ğŸ‘¥ Personen</label>
                        <select id="edit-passengers" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
                            <option value="1" ${ride.passengers == 1 ? 'selected' : ''}>1 Person</option>
                            <option value="2" ${ride.passengers == 2 ? 'selected' : ''}>2 Personen</option>
                            <option value="3" ${ride.passengers == 3 ? 'selected' : ''}>3 Personen</option>
                            <option value="4" ${ride.passengers == 4 ? 'selected' : ''}>4 Personen</option>
                        </select>
                    </div>
                    
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button onclick="saveEditedRide('${rideId}')" style="flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                            âœ… Speichern
                        </button>
                        <button onclick="closeEditModal()" style="flex:1;padding:12px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                            âŒ Abbrechen
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentEditModal = modal;
        }
        
        function closeEditModal() {
            if (window.currentEditModal) {
                window.currentEditModal.remove();
                window.currentEditModal = null;
            }
        }
        
        async function saveEditedRide(rideId) {
            const newPickup = document.getElementById('edit-pickup').value.trim();
            const newDestination = document.getElementById('edit-destination').value.trim();
            const newCustomer = document.getElementById('edit-customer').value.trim();
            const newDateTime = document.getElementById('edit-datetime').value;
            const newPassengers = document.getElementById('edit-passengers').value;
            
            if (!newPickup || !newDestination) {
                alert('âŒ Abholort und Zielort mÃ¼ssen ausgefÃ¼llt sein!');
                return;
            }
            
            const newTimestamp = new Date(newDateTime).getTime();
            const now = Date.now();
            const minutesUntilPickup = (newTimestamp - now) / (1000 * 60);
            const newStatus = minutesUntilPickup <= 15 ? 'new' : 'vorbestellt';
            
            const updates = {
                pickup: newPickup,
                destination: newDestination,
                customerName: newCustomer,
                pickupTimestamp: newTimestamp,
                pickupTime: new Date(newTimestamp).toLocaleString('de-DE', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                passengers: newPassengers,
                status: newStatus,
                editedAt: Date.now()
            };
            
            // Update Firebase
            if (isFirebaseReady) {
                try {
                    await db.ref('rides/' + rideId).update(updates);
                    console.log('âœ… Fahrt in Firebase aktualisiert');
                } catch (error) {
                    console.error('âŒ Fehler beim Aktualisieren:', error);
                }
            }
            
            // Update localStorage
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            const ride = history.find(r => r.firebaseId === rideId || r.id === rideId);
            if (ride) {
                Object.assign(ride, updates);
                localStorage.setItem('rideHistory', JSON.stringify(history));
            }
            
            closeEditModal();
            alert('âœ… Fahrt wurde aktualisiert!');
            
            // Aktualisiere Views
            updateHistoryView();
            updateAdminView();
        }
        
        // ğŸ”„ FAHRT NEU ZUWEISEN (aus rejected zurÃ¼ck zu new)
        async function reassignRide(rideId) {
            try {
                const ride = rides.find(r => (r.firebaseId || r.id) === rideId);
                if (!ride) {
                    alert('âŒ Fahrt nicht gefunden!');
                    return;
                }
                
                // âš ï¸ WICHTIG: Verhindere Neu-Zuweisung von angenommenen Fahrten!
                if (ride.status === 'accepted' || ride.status === 'picked_up') {
                    alert('âŒ Fehler!\n\nDiese Fahrt wurde bereits angenommen und kann nicht neu zugewiesen werden.\n\nStatus: ' + ride.status);
                    return;
                }
                
                if (!confirm('ğŸ”„ Fahrt neu zuweisen?\n\nDie Fahrt wird wieder als "neu" markiert und kann von Fahrern angenommen werden.')) {
                    return;
                }
                
                // ZurÃ¼ck zu "new" Status
                const updates = {
                    status: 'new',
                    rejectedBy: null,
                    rejectedAt: null,
                    rejectedByDriver: null,
                    vehicleId: null,
                    vehicle: null
                };
                
                if (isFirebaseReady) {
                    await db.ref('rides/' + rideId).update(updates);
                    console.log('ğŸ”„ Fahrt neu zugewiesen:', rideId);
                }
                
                // Update lokal
                Object.assign(ride, updates);
                saveRides();
                
                updateViews();
                alert('âœ… Fahrt neu zugewiesen!\n\nDie Fahrt ist jetzt wieder fÃ¼r alle Fahrer verfÃ¼gbar.');
                
            } catch (error) {
                console.error('âŒ Fehler beim Neu-Zuweisen:', error);
                alert('âŒ Fehler: ' + error.message);
            }
        }
        
        // ğŸ—‘ï¸ FAHRT LÃ–SCHEN (Admin)
        async function deleteRide(rideId) {
            const confirmDelete = confirm('ğŸ—‘ï¸ Fahrt wirklich LÃ–SCHEN?\n\nDies kann nicht rÃ¼ckgÃ¤ngig gemacht werden!');
            if (!confirmDelete) return;
            
            // ğŸ†• Lade Fahrt VORHER um Telegram zu senden und zu loggen
            let ride = null;
            if (isFirebaseReady) {
                try {
                    const snapshot = await db.ref('rides/' + rideId).once('value');
                    ride = snapshot.val();
                    
                    // ğŸ“œ LOGGING: Fahrt wird gelÃ¶scht
                    if (ride) {
                        logActivity('status', 'deleted', 
                            `Fahrt gelÃ¶scht: ${ride.customerName} (${ride.pickup} â†’ ${ride.destination})`, {
                            customer: ride.customerName,
                            phone: ride.customerPhone,
                            pickup: ride.pickup,
                            destination: ride.destination,
                            status: ride.status,
                            vehicle: ride.vehicle || 'Nicht zugewiesen',
                            price: ride.price,
                            deletedBy: currentUser ? currentUser.email : 'Admin'
                        });
                    }
                    
                    // ğŸ“± TELEGRAM SENDEN - IMMER wenn Fahrt existiert!
                    if (ride) {
                        await sendTelegramForDeletedRide(ride);
                    }
                    
                } catch (error) {
                    console.error('âŒ Fehler beim Laden der Fahrt:', error);
                }
            }
            
            // LÃ¶sche aus Firebase
            if (isFirebaseReady) {
                try {
                    await db.ref('rides/' + rideId).remove();
                    console.log('âœ… Fahrt aus Firebase gelÃ¶scht');
                } catch (error) {
                    console.error('âŒ Fehler beim LÃ¶schen:', error);
                }
            }
            
            // LÃ¶sche aus localStorage
            let history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            history = history.filter(r => r.firebaseId !== rideId && r.id !== rideId);
            localStorage.setItem('rideHistory', JSON.stringify(history));
            
            alert('âœ… Fahrt wurde gelÃ¶scht!');
            updateAdminView();
        }
        
        // ğŸš— v5.31.5: FAHRER MANUELL ZUWEISEN (Admin)
        async function assignVehicleToRide(rideId) {
            try {
                // Lade Fahrt
                const ride = rides.find(r => (r.firebaseId || r.id) === rideId);
                if (!ride) {
                    alert('âŒ Fahrt nicht gefunden!');
                    return;
                }
                
                // Lade alle Fahrzeuge
                let vehiclesList = [];
                if (isFirebaseReady) {
                    const snapshot = await db.ref('drivers').once('value');
                    const driversData = snapshot.val() || {};
                    vehiclesList = Object.entries(driversData).map(([id, data]) => ({
                        id: id,
                        vehicle: data.vehicle || id,
                        plate: data.plate || '',
                        userId: data.userId
                    }));
                }
                
                if (vehiclesList.length === 0) {
                    alert('âŒ Keine Fahrzeuge verfÃ¼gbar!');
                    return;
                }
                
                // Modal erstellen
                const modal = document.createElement('div');
                modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;';
                
                let vehicleOptions = '';
                vehiclesList.forEach(v => {
                    vehicleOptions += `
                        <div onclick="selectVehicleForAssignment('${rideId}', '${v.id}')" 
                             style="padding:15px;background:white;border:2px solid #e5e7eb;border-radius:10px;cursor:pointer;margin-bottom:10px;transition:all 0.2s;"
                             onmouseover="this.style.borderColor='#667eea';this.style.background='#f3f4f6'"
                             onmouseout="this.style.borderColor='#e5e7eb';this.style.background='white'">
                            <div style="font-size:18px;font-weight:700;color:#1f2937;margin-bottom:5px;">
                                ğŸš— ${v.vehicle}
                            </div>
                            ${v.plate ? `<div style="font-size:14px;color:#6b7280;">ğŸ“‹ ${v.plate}</div>` : ''}
                        </div>
                    `;
                });
                
                modal.innerHTML = `
                    <div style="background:white;border-radius:16px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;">
                        <div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;border-radius:16px 16px 0 0;">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <h3 style="margin:0;font-size:20px;">ğŸš— Fahrer zuweisen</h3>
                                <button onclick="this.closest('div').parentElement.parentElement.remove()" 
                                    style="background:rgba(255,255,255,0.2);border:none;color:white;font-size:24px;width:32px;height:32px;border-radius:50%;cursor:pointer;">Ã—</button>
                            </div>
                        </div>
                        <div style="padding:20px;">
                            <div style="background:#f9fafb;padding:15px;border-radius:10px;margin-bottom:20px;">
                                <div style="font-weight:700;margin-bottom:8px;">ğŸ“ ${ride.pickup}</div>
                                <div style="font-weight:700;color:#667eea;">ğŸ¯ ${ride.destination}</div>
                                <div style="margin-top:8px;color:#6b7280;">ğŸ‘¤ ${ride.customerName} | ğŸ’° ${ride.price}â‚¬</div>
                            </div>
                            <div style="font-weight:600;margin-bottom:15px;color:#1f2937;">WÃ¤hle ein Fahrzeug:</div>
                            ${vehicleOptions}
                            <button onclick="this.closest('div').parentElement.parentElement.remove()" 
                                style="width:100%;padding:12px;background:#e5e7eb;color:#1f2937;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-top:10px;">
                                Abbrechen
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('âŒ Fehler beim Zuweisen:', error);
                alert('âŒ Fehler: ' + error.message);
            }
        }
        
        // ğŸš— v5.31.5: FAHRZEUG AUSWAHL BESTÃ„TIGEN
        async function selectVehicleForAssignment(rideId, vehicleId) {
            try {
                // Lade Fahrzeug-Daten
                let vehicleData = null;
                if (isFirebaseReady) {
                    const snapshot = await db.ref('drivers/' + vehicleId).once('value');
                    vehicleData = snapshot.val();
                }
                
                if (!vehicleData) {
                    alert('âŒ Fahrzeug nicht gefunden!');
                    return;
                }
                
                const vehicleName = vehicleData.vehicle || vehicleId;
                
                if (!confirm(`ğŸš— Fahrt zuweisen an:\n\n${vehicleName}\n\nFortfahren?`)) {
                    return;
                }
                
                // Update Fahrt in Firebase
                if (isFirebaseReady) {
                    await db.ref('rides/' + rideId).update({
                        vehicleId: vehicleId,
                        vehicle: vehicleName,
                        vehiclePlate: vehicleData.plate || '',
                        status: 'accepted',
                        acceptedAt: Date.now(),
                        assignedBy: 'admin'
                    });
                }
                
                // Update lokal
                const ride = rides.find(r => (r.firebaseId || r.id) === rideId);
                if (ride) {
                    ride.vehicleId = vehicleId;
                    ride.vehicle = vehicleName;
                    ride.vehiclePlate = vehicleData.plate || '';
                    ride.status = 'accepted';
                    ride.acceptedAt = Date.now();
                    ride.assignedBy = 'admin';
                }
                
                // Telegram an Fahrer senden
                await sendTelegramToDriver(vehicleId, ride, 0);
                
                // Log Activity
                logActivity('admin', 'assign', `Admin hat Fahrt zugewiesen: ${vehicleName}`, {
                    vehicle: vehicleName,
                    customer: ride.customerName,
                    pickup: ride.pickup,
                    destination: ride.destination
                });
                
                // SchlieÃŸe Modal
                const modal = document.querySelector('div[style*="position:fixed"]');
                if (modal) modal.remove();
                
                // Update Views
                updateViews();
                
                alert(`âœ… Fahrt zugewiesen!\n\nğŸš— ${vehicleName}\nğŸ“± Telegram gesendet!`);
                
            } catch (error) {
                console.error('âŒ Fehler:', error);
                alert('âŒ Fehler: ' + error.message);
            }
        }
        
        // ğŸ”„ ROUTE UMDREHEN (Admin - direkt in Firebase)
        async function reverseRouteAdmin(rideId) {
            const confirmReverse = confirm('ğŸ”„ Route umdrehen?\n\nVon â‡„ Nach werden getauscht.');
            if (!confirmReverse) return;
            
            // Lade Fahrt
            let ride = null;
            if (isFirebaseReady) {
                const snapshot = await db.ref('rides/' + rideId).once('value');
                ride = snapshot.val();
            }
            
            if (!ride) {
                alert('âŒ Fahrt nicht gefunden');
                return;
            }
            
            // Tausche Von/Nach
            const updates = {
                pickup: ride.destination,
                destination: ride.pickup,
                editedAt: Date.now()
            };
            
            // Update Firebase
            if (isFirebaseReady) {
                try {
                    await db.ref('rides/' + rideId).update(updates);
                    console.log('âœ… Route in Firebase umgedreht');
                } catch (error) {
                    console.error('âŒ Fehler:', error);
                }
            }
            
            // Update localStorage
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            const localRide = history.find(r => r.firebaseId === rideId || r.id === rideId);
            if (localRide) {
                Object.assign(localRide, updates);
                localStorage.setItem('rideHistory', JSON.stringify(history));
            }
            
            alert('âœ… Route wurde umgedreht!\n\n' + 
                  'Neu:\n' +
                  'Von: ' + ride.destination + '\n' +
                  'Nach: ' + ride.pickup);
            
            updateAdminView();
        }
        
        function saveAsFavorite(rideId) {
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            const ride = history.find(r => r.createdAt === rideId || r.id === rideId);
            
            if (!ride) {
                alert('âŒ Fahrt nicht gefunden');
                return;
            }
            
            // Lade bestehende Favoriten
            const favorites = JSON.parse(localStorage.getItem('favoritRides') || '[]');
            
            // PrÃ¼fe ob schon vorhanden
            const exists = favorites.some(f => 
                f.pickup === ride.pickup && f.destination === ride.destination
            );
            
            if (exists) {
                alert('â­ Diese Route ist bereits ein Favorit!');
                return;
            }
            
            // FÃ¼ge hinzu
            const favorite = {
                id: Date.now(),
                name: `${ride.pickup} â†’ ${ride.destination}`,
                pickup: ride.pickup,
                destination: ride.destination,
                distance: ride.distance,
                price: ride.price,
                addedAt: Date.now()
            };
            
            favorites.push(favorite);
            localStorage.setItem('favoritRides', JSON.stringify(favorites));
            
            alert('â­ Als Favorit gespeichert!\n\n' +
                  ride.pickup + ' â†’ ' + ride.destination + '\n\n' +
                  'Favoriten findest du im Fahrgast-Tab oben.');
            
            // TODO: Favoriten-Anzeige implementieren
        }

        console.log('ğŸš€ Taxi App v5.23.1 gestartet');

        // ğŸ”” SERVICE WORKER & PUSH NOTIFICATIONS
        async function initServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    serviceWorkerRegistration = await navigator.serviceWorker.register('./service-worker.js');
                    console.log('âœ… Service Worker registriert:', serviceWorkerRegistration);
                    
                    // Warte bis Service Worker aktiv ist
                    await navigator.serviceWorker.ready;
                    console.log('âœ… Service Worker bereit');
                    
                    // Push-Benachrichtigungen aktivieren
                    await initPushNotifications();
                } catch (err) {
                    console.error('âŒ Service Worker Fehler:', err);
                }
            } else {
                console.warn('âš ï¸ Service Worker nicht unterstÃ¼tzt');
            }
        }

        async function initPushNotifications() {
            if (!('Notification' in window)) {
                console.warn('âš ï¸ Benachrichtigungen nicht unterstÃ¼tzt');
                return;
            }
            
            notificationPermission = Notification.permission;
            console.log('ğŸ”” Notification Permission:', notificationPermission);
            
            if (notificationPermission === 'granted') {
                console.log('âœ… Benachrichtigungen bereits erlaubt');
            }
        }

        function showNotificationPrompt() {
            // Entferne altes Banner falls vorhanden
            const oldBanner = document.getElementById('notification-banner');
            if (oldBanner) oldBanner.remove();
            
            const banner = document.createElement('div');
            banner.id = 'notification-banner';
            banner.style.cssText = 'position:fixed;top:140px;left:10px;right:10px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;border-radius:12px;text-align:center;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.3);animation:slideDown 0.3s ease;';
            banner.innerHTML = `
                <div style="font-size:48px;margin-bottom:10px;">ğŸ””</div>
                <div style="margin-bottom:15px;">
                    <strong style="font-size:18px;">Benachrichtigungen aktivieren?</strong><br>
                    <span style="font-size:14px;opacity:0.9;margin-top:5px;display:block;">Erhalte sofort Push-Benachrichtigungen bei neuen Buchungen - auch wenn die App geschlossen ist!</span>
                </div>
                <button onclick="requestNotificationPermission()" style="background:white;color:#667eea;border:none;padding:14px 24px;border-radius:8px;font-weight:700;cursor:pointer;margin-right:10px;font-size:15px;box-shadow:0 2px 8px rgba(0,0,0,0.2);">âœ“ Jetzt aktivieren</button>
                <button onclick="document.getElementById('notification-banner').remove()" style="background:rgba(255,255,255,0.2);color:white;border:2px solid white;padding:14px 24px;border-radius:8px;font-weight:600;cursor:pointer;font-size:15px;">SpÃ¤ter</button>
            `;
            
            // CSS Animation
            const style = document.createElement('style');
            style.textContent = '@keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }';
            document.head.appendChild(style);
            
            document.body.appendChild(banner);
            
            console.log('ğŸ”” Benachrichtigungs-Banner angezeigt');
        }

        async function requestNotificationPermission() {
            try {
                // Banner entfernen (beide Varianten)
                const staticBanner = document.getElementById('static-notification-banner');
                if (staticBanner) staticBanner.style.display = 'none';
                
                const banner = document.getElementById('notification-banner');
                if (banner) banner.remove();
                
                notificationPermission = await Notification.requestPermission();
                console.log('ğŸ”” Notification Permission:', notificationPermission);
                
                if (notificationPermission === 'granted') {
                    // Zeige BestÃ¤tigung
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = 'position:fixed;top:140px;left:10px;right:10px;background:#10b981;color:white;padding:20px;border-radius:12px;text-align:center;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.3);';
                    successMsg.innerHTML = `
                        <div style="font-size:48px;margin-bottom:10px;">âœ…</div>
                        <div style="font-size:16px;font-weight:600;">Benachrichtigungen aktiviert!</div>
                        <div style="font-size:14px;margin-top:8px;opacity:0.9;">Du erhÃ¤ltst jetzt Push-Benachrichtigungen fÃ¼r neue Fahrten</div>
                    `;
                    document.body.appendChild(successMsg);
                    
                    // Automatisch nach 3 Sekunden ausblenden
                    setTimeout(() => {
                        successMsg.style.transition = 'opacity 0.5s';
                        successMsg.style.opacity = '0';
                        setTimeout(() => successMsg.remove(), 500);
                    }, 3000);
                    
                } else if (notificationPermission === 'denied') {
                    // Zeige Hilfe-Info
                    alert('âš ï¸ Benachrichtigungen wurden blockiert.\n\nSo kannst du sie aktivieren:\n\n1. Tippe auf das ğŸ”’ Schloss in der Adressleiste\n2. Gehe zu "Berechtigungen"\n3. Stelle "Benachrichtigungen" auf "Zulassen"');
                }
            } catch (err) {
                console.error('âŒ Notification Permission Fehler:', err);
                alert('âŒ Fehler beim Aktivieren der Benachrichtigungen.\n\nBitte versuche es Ã¼ber die Browser-Einstellungen.');
            }
        }

        // Lokale Benachrichtigung anzeigen
        function sendLocalNotification(title, body, data = {}) {
            if (notificationPermission !== 'granted') {
                console.warn('âš ï¸ Keine Berechtigung fÃ¼r Benachrichtigungen');
                // Fallback: Sound abspielen
                playNotificationSound();
                return;
            }
            
            // Wenn Service Worker verfÃ¼gbar, nutze diesen
            if (serviceWorkerRegistration) {
                serviceWorkerRegistration.showNotification(title, {
                    body: body,
                    icon: '/icon-192.png',
                    badge: '/icon-192.png',
                    vibrate: [200, 100, 200, 100, 200],
                    tag: 'taxi-ride-' + (data.rideId || Date.now()),
                    requireInteraction: true,
                    data: data,
                    actions: [
                        { action: 'view', title: 'ğŸ‘€ Anzeigen' },
                        { action: 'close', title: 'âŒ SchlieÃŸen' }
                    ]
                });
            } else {
                // Fallback: Browser Notification API
                const notification = new Notification(title, {
                    body: body,
                    icon: '/icon-192.png',
                    vibrate: [200, 100, 200, 100, 200],
                    tag: 'taxi-ride-' + (data.rideId || Date.now()),
                    requireInteraction: true
                });
                
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            }
            
            // Sound abspielen
            playNotificationSound();
        }

        function playNotificationSound() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+');
                audio.volume = 0.5;
                audio.play().catch(e => console.log('ğŸ”‡ Audio blockiert'));
            } catch (e) {
                console.log('ğŸ”‡ Audio nicht verfÃ¼gbar');
            }
        }
        
        // ğŸ§¹ v5.24.8: CLEANUP fÃ¼r hÃ¤ngende 'assigned' Fahrten
        // ğŸ§¹ v5.24.9: ERWEITERT - auch alte 'new' und 'vorbestellt' Fahrten (Ã¤lter als 24h)
        async function cleanupStuckAssignedRides() {
            if (!db) return;
            
            try {
                const now = Date.now();
                const MAX_ASSIGNED_AGE = 2 * 60 * 1000; // 2 Minuten fÃ¼r assigned
                const MAX_NEW_AGE = 24 * 60 * 60 * 1000; // 24 Stunden fÃ¼r new/vorbestellt
                
                // 1. Cleanup fÃ¼r 'assigned' Fahrten (Ã¤lter als 2 Min)
                const assignedSnapshot = await db.ref('rides').orderByChild('status').equalTo('assigned').once('value');
                const assignedRides = assignedSnapshot.val() || {};
                
                for (const rideId in assignedRides) {
                    const ride = assignedRides[rideId];
                    const assignedAge = now - (ride.assignedAt || 0);
                    
                    if (assignedAge > MAX_ASSIGNED_AGE) {
                        console.log(`ğŸ§¹ Cleanup: Fahrt ${rideId} hÃ¤ngt seit ${Math.round(assignedAge/1000)}s im assigned Status`);
                        
                        // ğŸ”§ FIX: Blacklist beibehalten UND aktuellen Fahrer hinzufÃ¼gen!
                        const currentBlacklist = ride.assignmentBlacklist || [];
                        if (ride.assignedTo && !currentBlacklist.includes(ride.assignedTo)) {
                            currentBlacklist.push(ride.assignedTo);
                        }
                        
                        await db.ref('rides/' + rideId).update({
                            status: 'new',
                            assignedTo: null,
                            assignedVehicleName: null,
                            assignmentBlacklist: currentBlacklist, // Blacklist behalten!
                            cleanedUp: true,
                            cleanedUpAt: now,
                            lastAssignmentTimeout: now
                        });
                        
                        console.log(`âœ… Fahrt ${rideId} zurÃ¼ckgesetzt auf 'new' - Blacklist: ${currentBlacklist.join(', ')}`);
                    }
                }
                
                // 2. Cleanup fÃ¼r alte 'new' Fahrten (Ã¤lter als 24h)
                const newSnapshot = await db.ref('rides').orderByChild('status').equalTo('new').once('value');
                const newRides = newSnapshot.val() || {};
                
                for (const rideId in newRides) {
                    const ride = newRides[rideId];
                    const createdAt = ride.createdAt || ride.timestamp || 0;
                    const pickupTime = ride.pickupTimestamp || 0;
                    const relevantTime = pickupTime || createdAt;
                    const age = now - relevantTime;
                    
                    if (age > MAX_NEW_AGE) {
                        console.log(`ğŸ§¹ Cleanup: Alte Fahrt ${rideId} - ${Math.round(age/3600000)}h alt - wird storniert`);
                        
                        await db.ref('rides/' + rideId).update({
                            status: 'cancelled',
                            cancelledReason: 'Auto-Storno: Fahrt Ã¤lter als 24h',
                            cancelledAt: now,
                            autoCleanup: true
                        });
                        
                        console.log(`ğŸ—‘ï¸ Alte Fahrt ${rideId} automatisch storniert`);
                        
                        logActivity('system', 'auto_cancel', `Alte Fahrt auto-storniert: ${ride.customerName || 'Kunde'}`, {
                            rideId: rideId,
                            age: Math.round(age/3600000) + 'h'
                        });
                    }
                }
                
                // 3. Cleanup fÃ¼r alte 'vorbestellt' Fahrten (Abholzeit in der Vergangenheit + 2h)
                const vorbestelltSnapshot = await db.ref('rides').orderByChild('status').equalTo('vorbestellt').once('value');
                const vorbestelltRides = vorbestelltSnapshot.val() || {};
                
                for (const rideId in vorbestelltRides) {
                    const ride = vorbestelltRides[rideId];
                    const pickupTime = ride.pickupTimestamp || 0;
                    const timeSincePickup = now - pickupTime;
                    
                    // Wenn Abholzeit mehr als 2 Stunden vorbei ist
                    if (pickupTime > 0 && timeSincePickup > 2 * 60 * 60 * 1000) {
                        console.log(`ğŸ§¹ Cleanup: Verpasste Vorbestellung ${rideId} - Abholzeit war vor ${Math.round(timeSincePickup/3600000)}h`);
                        
                        await db.ref('rides/' + rideId).update({
                            status: 'cancelled',
                            cancelledReason: 'Auto-Storno: Abholzeit verpasst',
                            cancelledAt: now,
                            autoCleanup: true
                        });
                        
                        console.log(`ğŸ—‘ï¸ Verpasste Vorbestellung ${rideId} automatisch storniert`);
                    }
                }
                
                // 4. Cleanup fÃ¼r alte 'accepted' Fahrten (Ã¤lter als 24h)
                const acceptedSnapshot = await db.ref('rides').orderByChild('status').equalTo('accepted').once('value');
                const acceptedRides = acceptedSnapshot.val() || {};
                
                for (const rideId in acceptedRides) {
                    const ride = acceptedRides[rideId];
                    const acceptedAt = ride.acceptedAt || ride.createdAt || 0;
                    const age = now - acceptedAt;
                    
                    if (age > MAX_NEW_AGE) { // 24h
                        console.log(`ğŸ§¹ Cleanup: Alte accepted Fahrt ${rideId} - ${Math.round(age/3600000)}h alt`);
                        
                        await db.ref('rides/' + rideId).update({
                            status: 'cancelled',
                            cancelledReason: 'Auto-Storno: Fahrt Ã¤lter als 24h (nie abgeschlossen)',
                            cancelledAt: now,
                            autoCleanup: true
                        });
                        
                        console.log(`ğŸ—‘ï¸ Alte accepted Fahrt ${rideId} automatisch storniert`);
                    }
                }
                
                // 5. Cleanup fÃ¼r alte 'picked_up' Fahrten (Ã¤lter als 24h)
                const pickedUpSnapshot = await db.ref('rides').orderByChild('status').equalTo('picked_up').once('value');
                const pickedUpRides = pickedUpSnapshot.val() || {};
                
                for (const rideId in pickedUpRides) {
                    const ride = pickedUpRides[rideId];
                    const pickedUpAt = ride.pickedUpAt || ride.acceptedAt || ride.createdAt || 0;
                    const age = now - pickedUpAt;
                    
                    if (age > MAX_NEW_AGE) { // 24h
                        console.log(`ğŸ§¹ Cleanup: Alte picked_up Fahrt ${rideId} - ${Math.round(age/3600000)}h alt`);
                        
                        await db.ref('rides/' + rideId).update({
                            status: 'completed',
                            completedAt: now,
                            completedReason: 'Auto-Abschluss: Fahrt Ã¤lter als 24h',
                            autoCleanup: true
                        });
                        
                        console.log(`âœ… Alte picked_up Fahrt ${rideId} automatisch abgeschlossen`);
                    }
                }
                
                console.log('âœ… Cleanup abgeschlossen');
                
            } catch (error) {
                console.error('âŒ Cleanup-Fehler:', error);
            }
        }

        // INIT
        function initApp(hasFirebase) {
            clearTimeout(firebaseLoadTimeout);
            console.log('ğŸ“± App initialisiert');
            
            if (hasFirebase && typeof firebase !== 'undefined') {
                try {
                    firebase.initializeApp({
                        apiKey: "AIzaSyD2eHFuplImxBCijd3MWlKyCwXUZHLmhhE",
                        authDomain: "taxi-heringsdorf.firebaseapp.com",
                        databaseURL: "https://taxi-heringsdorf-default-rtdb.europe-west1.firebasedatabase.app",
                        projectId: "taxi-heringsdorf",
                        storageBucket: "taxi-heringsdorf.firebasestorage.app",
                        messagingSenderId: "886448081276",
                        appId: "1:886448081276:web:1b54875801c5d89f8efcf9"
                    });
                    db = firebase.database();
                    isFirebaseReady = true;
                    console.log('âœ… Firebase verbunden');
                    
                    // ğŸ“œ PROTOKOLL: App gestartet & Firebase verbunden
                    setTimeout(() => {
                        logActivity('system', 'app_start', 'App gestartet - Firebase verbunden', {});
                    }, 1000);
                    
                    // ğŸ§¹ CLEANUP: HÃ¤ngende 'assigned' Fahrten zurÃ¼cksetzen (Ã¤lter als 2 Minuten)
                    setTimeout(() => cleanupStuckAssignedRides(), 2000);
                    
                    // ğŸ’° Preis-Einstellungen aus Firebase laden
                    loadPricingSettings();
                    
                    // ğŸ”´ Buchungssystem-Status aus Firebase laden
                    loadBookingSystemStatus();
                    
                    // ğŸš— Fahrzeuge aus Firebase laden
                    loadVehiclesFromFirebase();
                    
                    // ğŸ”„ LADE GESPEICHERTE FAHRT (falls vorhanden)
                    const savedRideId = localStorage.getItem('myCurrentRideId');
                    if (savedRideId) {
                        console.log('ğŸ”„ Lade gespeicherte Fahrt:', savedRideId);
                        listenToMyRide(savedRideId);
                    }
                    
                    // ğŸ” Firebase Auth initialisieren mit LOCAL Persistence
                    auth = firebase.auth();
                    
                    // ğŸ†• v5.21.0: ERST Persistence setzen, DANN Observer!
                    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(() => {
                        console.log('âœ… Auth Persistence: LOCAL');
                        
                        // Jetzt erst den Observer starten!
                        auth.onAuthStateChanged((user) => {
                            console.log('ğŸ” Auth State Changed:', user ? user.email : 'KEIN USER');
                            
                            // ğŸ“œ PROTOKOLL im Live-Log
                            if (user) {
                                logActivity('system', 'auth', `ğŸ” User eingeloggt: ${user.email || user.phoneNumber}`, {
                                    email: user.email,
                                    phone: user.phoneNumber,
                                    uid: user.uid
                                });
                                onUserLoggedIn(user);
                            } else {
                                logActivity('system', 'auth', `ğŸ” User ausgeloggt`, {});
                                onUserLoggedOut();
                            }
                        });
                        
                    }).catch((error) => {
                        console.error('âŒ Persistence Fehler:', error);
                        
                        // Fallback: Observer trotzdem starten
                        auth.onAuthStateChanged((user) => {
                            if (user) {
                                onUserLoggedIn(user);
                            } else {
                                onUserLoggedOut();
                            }
                        });
                    });
                    
                    db.ref('.info/connected').on('value', (s) => { 
                        const wasConnected = isConnected;
                        isConnected = s.val(); 
                        updateStatus();
                        
                        // ğŸ“œ PROTOKOLL: Verbindungsstatus geÃ¤ndert
                        if (wasConnected === true && isConnected === false) {
                            logActivity('system', 'connection_lost', 'âš ï¸ Firebase-Verbindung verloren', {});
                        } else if (wasConnected === false && isConnected === true) {
                            logActivity('system', 'connection_restored', 'âœ… Firebase-Verbindung wiederhergestellt', {});
                        }
                    });
                    db.ref('rides').on('value', (s) => {
                        console.log('ğŸ”„ Firebase: rides value event triggered');
                        const previousCount = rides.filter(r => r.status === 'new' || r.status === 'vorbestellt').length;
                        rides = [];
                        let loadedCount = 0;
                        s.forEach(c => {
                            const r = c.val();
                            r.firebaseId = c.key;
                            rides.push(r);
                            loadedCount++;
                            
                            // ğŸ†• v5.20.7: Ignoriere kÃ¼rzlich stornierte Fahrten KOMPLETT!
                            if (recentlyCancelledRideIds && recentlyCancelledRideIds.has(r.firebaseId)) {
                                console.log('ğŸ›¡ï¸ Ignoriere stornierte Fahrt:', r.firebaseId);
                                return; // Ãœberspringen!
                            }
                            
                            // ğŸ†• v5.20.8: PrÃ¼fe ob mir ZUGEWIESENE Fahrt storniert wurde
                            if (currentVehicle && r.assignedTo === currentVehicle && currentView === 'driver') {
                                const cancelledStatuses = ['storniert', 'cancelled', 'cancelled_pending_driver'];
                                if (cancelledStatuses.includes(r.status)) {
                                    // PrÃ¼fe ob wir das schon gemeldet haben (PERSISTENT!)
                                    if (!hasShownCancelAlarm(r.firebaseId)) {
                                        saveShownCancelAlarm(r.firebaseId);
                                        console.log('ğŸš¨ Mir zugewiesene Fahrt wurde storniert:', r.firebaseId);
                                        showCancellationAlarm(r);
                                    } else {
                                        console.log('ğŸ›¡ï¸ Stornierung bereits gezeigt (Skip):', r.firebaseId);
                                    }
                                }
                            }
                            
                            if (myCurrentRide && r.id === myCurrentRide.id) {
                                // ğŸ†• v5.20.4: PrÃ¼fe ALLE Stornierung-Status!
                                const cancelledStatuses = ['storniert', 'cancelled', 'cancelled_pending_driver'];
                                const wasNotCancelled = !cancelledStatuses.includes(myCurrentRide.status);
                                const isNowCancelled = cancelledStatuses.includes(r.status);
                                
                                if (isNowCancelled && wasNotCancelled) {
                                    // Fahrt wurde gerade storniert!
                                    console.log('ğŸš« Fahrt wurde storniert:', r.id, r.status);
                                    
                                    // Stoppe Navigations-Updates
                                    if (window.driverMapUpdateInterval) {
                                        clearInterval(window.driverMapUpdateInterval);
                                        window.driverMapUpdateInterval = null;
                                        console.log('ğŸ›‘ Navigations-Updates gestoppt');
                                    }
                                    
                                    // LÃ¶sche Karte
                                    if (map) {
                                        map.remove();
                                        map = null;
                                        taxiMarker = null;
                                        pickupMarker = null;
                                        console.log('ğŸ—ºï¸ Karte entfernt');
                                    }
                                    
                                    // LÃ¶sche Fahrer-Karte
                                    if (driverMap) {
                                        driverMap.remove();
                                        driverMap = null;
                                        driverMarker = null;
                                        pickupMarker = null;
                                        routeLine = null;
                                        console.log('ğŸ—ºï¸ Fahrer-Karte entfernt');
                                    }
                                    
                                    // LÃ¶sche aus myCurrentRide
                                    localStorage.removeItem('myCurrentRideId');
                                    myCurrentRide = null;
                                    document.getElementById('ride-status-container').innerHTML = '';
                                    document.getElementById('booking-form').style.display = 'block';
                                    
                                    // ğŸ†• v5.20.4: Stoppe auch den einzelnen Listener
                                    db.ref('rides/' + r.firebaseId).off();
                                    
                                    // ğŸ†• v5.20.4: Formular zurÃ¼cksetzen
                                    resetBookingForm();
                                    
                                    // ğŸ†• v5.20.8: Zeige VISUELLEN Stornierung-Alarm fÃ¼r Fahrer!
                                    // âš ï¸ v5.24.7: DEAKTIVIERT - lÃ¶st Spam aus bei App-Start
                                    /*
                                    if (currentView === 'driver') {
                                        // PrÃ¼fe ob wir diesen Alarm schon gezeigt haben
                                        if (!hasShownCancelAlarm(r.firebaseId)) {
                                            saveShownCancelAlarm(r.firebaseId);
                                            showCancellationAlarm(r);
                                        } else {
                                            console.log('ğŸ›¡ï¸ Stornierung bereits gezeigt (Skip):', r.firebaseId);
                                        }
                                        updateDriverView();
                                    }
                                    */
                                    if (currentView === 'driver') {
                                        updateDriverView();
                                    }
                                    
                                    // WICHTIG: Nicht weitermachen!
                                    return;
                                    return;
                                }
                                
                                // ğŸ†• v5.20.4: Wenn Fahrt storniert ist, NICHT anzeigen!
                                if (isNowCancelled) {
                                    return;
                                }
                                
                                myCurrentRide = r;
                                if (r.status === 'accepted' && r.driverLocation) showRideStatus(r);
                                if (r.status === 'picked_up') showRideStatus(r);
                                if (r.status === 'completed') showRideStatus(r);
                            }
                        });
                        
                        const currentCount = rides.filter(r => r.status === 'new' || r.status === 'vorbestellt').length;
                        console.log(`ğŸ“Š Fahrten geladen: ${loadedCount} total, ${currentCount} new/vorbestellt`);
                        
                        // ğŸš¨ ALARM fÃ¼r Admin bei neuen Fahrten!
                        if (currentCount > previousCount) {
                            if (userRole === 'admin') {
                                triggerAdminAlarm(currentCount);
                            }
                            
                            // FÃ¼r Fahrer: alter Alarm
                            if (currentView === 'driver') {
                                playDriverNotificationSound();
                                showNewRideFullscreen();
                            }
                        }
                        
                        // Badge am Admin-Tab aktualisieren
                        updateAdminBadge(currentCount);
                        
                        updateViewsDebounced(); // ğŸ†• v5.21.7: Debounced um Flackern zu vermeiden
                    });
                    db.ref('drivers').on('value', (s) => { 
                        drivers = {}; 
                        s.forEach(c => { drivers[c.key] = c.val(); }); 
                        showAvailableTaxis();
                        checkDriverAvailability(); // ğŸ†• v5.32.5g: SOFORT-Button nur wenn Fahrer verfÃ¼gbar
                        if (currentView === 'admin') updateAdminView(); // â† Update Admin fÃ¼r Online-Fahrer
                    });
                    db.ref('cancellations').on('value', (s) => {
                        cancellations = [];
                        s.forEach(c => {
                            const cancel = c.val();
                            cancel.firebaseId = c.key;
                            cancellations.push(cancel);
                        });
                        if (currentView === 'admin') updateAdminView();
                    });
                    
                    // ğŸ†• v5.31.0: child_changed ENTFERNT - verursachte Race Conditions!
                    // Der 'value' Listener oben updated schon alles automatisch!
                    
                } catch (e) { 
                    console.error('âŒ Firebase Fehler:', e); 
                }
            } else {
                console.log('âš ï¸ Firebase nicht verfÃ¼gbar - Lokaler Modus');
            }
            
            updateStatus();
            updateViews(); // WICHTIG: Views auch ohne Firebase laden!
            
            // ğŸ”” SERVICE WORKER DEAKTIVIERT - Telegram Ã¼bernimmt Benachrichtigungen!
            // initServiceWorker();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸšŒğŸš‚ FAHRPLAN-FUNKTIONEN (v5.32.6)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let scheduleLoaded = false;
        
        // LÃ¤dt Fahrplan beim ersten Ã–ffnen
        async function loadSchedule() {
            if (scheduleLoaded) return;
            
            console.log('ğŸšŒ Lade Fahrplan-Daten...');
            
            // GPS-Check
            if (!navigator.geolocation) {
                showScheduleError('GPS nicht verfÃ¼gbar in deinem Browser.');
                return;
            }
            
            try {
                // 1. GPS-Standort holen
                console.log('ğŸ“ Hole GPS-Standort...');
                
                const location = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            console.log('âœ… GPS-Standort erhalten:', pos.coords.latitude, pos.coords.longitude);
                            resolve({
                                latitude: pos.coords.latitude,
                                longitude: pos.coords.longitude
                            });
                        },
                        (err) => {
                            console.error('âŒ GPS-Fehler:', err);
                            reject(err);
                        },
                        {
                            enableHighAccuracy: true,  // ğŸ”§ v5.32.11: Bessere Genauigkeit
                            timeout: 30000,            // ğŸ”§ v5.32.11: 30 Sekunden statt 10
                            maximumAge: 300000
                        }
                    );
                });
                
                const { latitude, longitude } = location;
                document.getElementById('schedule-location').textContent = 
                    `Lat: ${latitude.toFixed(4)}, Lng: ${longitude.toFixed(4)}`;
                
                // 2. NÃ¤chste Haltestellen finden (mehrere zur Auswahl!)
                console.log('ğŸ” Suche Haltestellen in der NÃ¤he...');
                const nearbyStops = await fetchNearbyStops(latitude, longitude);
                
                if (!nearbyStops || nearbyStops.length === 0) {
                    showScheduleError('Keine Haltestelle in der NÃ¤he gefunden.');
                    return;
                }
                
                console.log('âœ… Haltestellen gefunden:', nearbyStops.length);
                
                // Zeige alle Haltestellen zur Auswahl
                displayStopSelection(nearbyStops, latitude, longitude);
                
                scheduleLoaded = true;
                
            } catch (error) {
                console.error('âŒ Fehler beim Laden des Fahrplans:', error);
                
                if (error.code === 1) {
                    showScheduleError('GPS-Berechtigung verweigert. Bitte erlaube den Standort-Zugriff in den Browser-Einstellungen.');
                } else if (error.code === 2) {
                    showScheduleError('Standort nicht verfÃ¼gbar. Bitte aktiviere GPS.');
                } else if (error.code === 3) {
                    showScheduleError('GPS-Timeout (30 Sek Ã¼berschritten). Bitte gehe nach drauÃŸen oder ans Fenster und versuche es erneut. Bei schlechtem GPS-Empfang kann es bis zu 30 Sekunden dauern.');
                } else {
                    showScheduleError('Fehler beim Laden der Fahrplandaten: ' + error.message);
                }
            }
        }
        
        // Aktualisiert Fahrplan
        async function refreshSchedule() {
            scheduleLoaded = false;
            
            // Loading states
            document.getElementById('schedule-trains').innerHTML = 
                '<div style="text-align:center;padding:20px;color:#6b7280;">Lade Zugverbindungen...</div>';
            document.getElementById('schedule-buses').innerHTML = 
                '<div style="text-align:center;padding:20px;color:#6b7280;">Lade Busverbindungen...</div>';
            
            await loadSchedule();
        }
        
        // Holt nahegelegene Haltestellen
        async function fetchNearbyStops(lat, lng) {
            try {
                const url = `https://v6.db.transport.rest/locations/nearby?latitude=${lat}&longitude=${lng}&results=5&distance=2000`;
                
                console.log('ğŸ” DEBUG: Suche Haltestellen...');
                console.log('ğŸ“ GPS:', lat, lng);
                console.log('ğŸŒ API-URL:', url);
                
                const response = await fetch(url);
                
                console.log('ğŸ“¡ Response Status:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ API Error Response:', errorText);
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                console.log('ğŸ“¦ Raw API Data:', data);
                
                const stops = Array.isArray(data) ? data : (data.stops || []);
                console.log('âœ… Haltestellen gefunden:', stops.length);
                
                if (stops.length > 0) {
                    console.log('ğŸš NÃ¤chste Haltestelle:', stops[0].name, '|', stops[0].distance, 'm');
                    console.log('ğŸ” KOMPLETTES Stop-Objekt:', JSON.stringify(stops[0], null, 2));
                    console.log('ğŸ†” Stop.id:', stops[0].id);
                    console.log('ğŸ†” Stop.ibnr:', stops[0].ibnr);
                    console.log('ğŸ†” Stop.ids:', stops[0].ids);
                }
                
                return stops;
                
            } catch (error) {
                console.error('âŒ FEHLER bei Haltestellen-Suche:', error);
                throw error;
            }
        }
        
        // Zeigt nÃ¤chste Haltestelle an
        // Zeigt mehrere Haltestellen zur Auswahl
        function displayStopSelection(stops, userLat, userLon) {
            // Sortiere: BahnhÃ¶fe zuerst, dann Bushaltestellen
            const sortedStops = stops.slice(0, 10).sort((a, b) => {
                const aIsStation = isTrainStation(a);
                const bIsStation = isTrainStation(b);
                
                // BahnhÃ¶fe haben PrioritÃ¤t
                if (aIsStation && !bIsStation) return -1;
                if (!aIsStation && bIsStation) return 1;
                
                // Sonst nach Entfernung sortieren
                return (a.distance || 9999) - (b.distance || 9999);
            });
            
            // Gruppiere nach Typ
            const stations = sortedStops.filter(s => isTrainStation(s));
            const busStops = sortedStops.filter(s => !isTrainStation(s));
            
            let stationsHTML = '';
            if (stations.length > 0) {
                stationsHTML = `
                    <div style="font-size:13px;font-weight:700;color:#1f2937;margin:15px 0 8px 0;">
                        ğŸš‚ BAHNHÃ–FE (mit Zugverbindungen):
                    </div>
                `;
                stationsHTML += stations.map(stop => createStopHTML(stop, userLat, userLon, 'ğŸš‚', '#3b82f6')).join('');
            }
            
            let busStopsHTML = '';
            if (busStops.length > 0) {
                busStopsHTML = `
                    <div style="font-size:13px;font-weight:700;color:#1f2937;margin:15px 0 8px 0;">
                        ğŸšŒ BUSHALTESTELLEN:
                    </div>
                `;
                busStopsHTML += busStops.map(stop => createStopHTML(stop, userLat, userLon, 'ğŸšŒ', '#f59e0b')).join('');
            }
            
            document.getElementById('schedule-nearest-stop').innerHTML = `
                <div style="margin-bottom:15px;">
                    <div style="font-size:14px;color:#6b7280;margin-bottom:10px;font-weight:600;">
                        ğŸš Haltestellen in Ihrer NÃ¤he:
                    </div>
                    ${stationsHTML}
                    ${busStopsHTML}
                    <div style="font-size:12px;color:#6b7280;text-align:center;margin-top:10px;">
                        ğŸ’¡ Tipp: BahnhÃ¶fe haben Zug + Bus, Bushaltestellen nur Bus
                    </div>
                </div>
            `;
            
            // Verstecke ZÃ¼ge/Busse Container bis Haltestelle gewÃ¤hlt
            document.getElementById('schedule-trains').innerHTML = '';
            document.getElementById('schedule-buses').innerHTML = '';
        }
        
        // PrÃ¼ft ob Haltestelle ein Bahnhof ist
        function isTrainStation(stop) {
            // Bahnhof wenn name "Bahnhof" oder "Bf" enthÃ¤lt
            if (stop.name && (stop.name.includes('Bahnhof') || stop.name.includes(' Bf') || stop.name.includes('Bhf'))) {
                return true;
            }
            
            // Oder wenn Zug-Produkte verfÃ¼gbar sind
            if (stop.products) {
                return stop.products.nationalExpress || 
                       stop.products.national || 
                       stop.products.regional || 
                       stop.products.regionalExp || 
                       stop.products.suburban;
            }
            
            return false;
        }
        
        // Erstellt HTML fÃ¼r eine Haltestelle
        function createStopHTML(stop, userLat, userLon, icon, color) {
            const distance = stop.distance ? Math.round(stop.distance) : '?';
            const stopId = stop.ibnr || stop.id;
            
            return `
                <div style="background:white;padding:12px;border-radius:10px;margin-bottom:8px;border-left:4px solid ${color};border-right:2px solid #e5e7eb;border-top:2px solid #e5e7eb;border-bottom:2px solid #e5e7eb;cursor:pointer;transition:all 0.2s;" 
                     onclick="selectStop('${stopId}', '${stop.name.replace(/'/g, "\\'")}', ${userLat}, ${userLon})"
                     onmouseover="this.style.borderColor='${color}';this.style.boxShadow='0 2px 8px rgba(59,130,246,0.2)'"
                     onmouseout="this.style.borderLeftColor='${color}';this.style.borderRightColor='#e5e7eb';this.style.borderTopColor='#e5e7eb';this.style.borderBottomColor='#e5e7eb';this.style.boxShadow='none'">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            <div style="font-size:15px;font-weight:700;color:#1f2937;margin-bottom:2px;">
                                ${icon} ${stop.name}
                            </div>
                            <div style="font-size:12px;color:#6b7280;">
                                ğŸ“ ${distance}m entfernt
                            </div>
                        </div>
                        <div style="padding:8px 16px;background:${color};color:white;border-radius:6px;font-size:13px;font-weight:600;">
                            Abfahrten â†’
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ALTE Funktion bleibt fÃ¼r KompatibilitÃ¤t
        
        // Wird aufgerufen wenn User eine Haltestelle wÃ¤hlt
        async function selectStop(stopId, stopName, userLat, userLon) {
            console.log('ğŸš Haltestelle gewÃ¤hlt:', stopName);
            console.log('ğŸ†” Stop-ID:', stopId);
            
            // Zeige gewÃ¤hlte Haltestelle
            document.getElementById('schedule-nearest-stop').innerHTML = `
                <div style="background:white;padding:15px;border-radius:12px;border:2px solid #3b82f6;margin-bottom:15px;">
                    <div style="font-size:14px;color:#3b82f6;margin-bottom:4px;font-weight:600;">âœ… GewÃ¤hlte Haltestelle:</div>
                    <div style="font-size:16px;font-weight:700;color:#1f2937;">${stopName}</div>
                    <button onclick="loadSchedule()" style="margin-top:8px;padding:6px 12px;background:#f3f4f6;border:none;border-radius:6px;font-size:12px;color:#6b7280;cursor:pointer;">
                        ğŸ”„ Andere Haltestelle wÃ¤hlen
                    </button>
                </div>
            `;
            
            // Lade Abfahrten
            await loadDepartures(stopId, stopName);
        }
        
        function displayNearestStop(stop) {
            const distance = stop.distance ? Math.round(stop.distance) : 'unbekannt';
            
            document.getElementById('schedule-nearest-stop').innerHTML = `
                <div style="background:white;padding:15px;border-radius:12px;border:2px solid #e5e7eb;">
                    <div style="font-size:14px;color:#6b7280;margin-bottom:4px;">ğŸš NÃ¤chste Haltestelle:</div>
                    <div style="font-size:16px;font-weight:700;color:#1f2937;">${stop.name}</div>
                    <div style="font-size:13px;color:#6b7280;margin-top:4px;">
                        ğŸ“ ${distance}m entfernt
                    </div>
                </div>
            `;
        }
        
        // LÃ¤dt Abfahrten von Haltestelle
        async function loadDepartures(stopId, stopName) {
            try {
                const url = `https://v6.db.transport.rest/stops/${encodeURIComponent(stopId)}/departures?duration=120&results=20`;
                
                console.log('ğŸš‚ğŸšŒ DEBUG: Lade Abfahrten...');
                console.log('ğŸš Haltestelle:', stopName);
                console.log('ğŸ†” Stop-ID:', stopId);
                console.log('ğŸŒ API-URL:', url);
                
                const response = await fetch(url);
                
                console.log('ğŸ“¡ Response Status:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ API Error Response:', errorText);
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                console.log('ğŸ“¦ Raw API Data Type:', typeof data, '| Array?', Array.isArray(data));
                console.log('ğŸ“¦ Raw API Data:', data);
                
                const departures = Array.isArray(data) ? data : (data.departures || []);
                
                console.log('âœ… Abfahrten gefunden:', departures.length);
                
                // Trennen in ZÃ¼ge und Busse
                const trains = [];
                const buses = [];
                
                for (const dep of departures) {
                    const product = dep.line?.product || dep.product;
                    
                    if (product === 'suburban' || product === 'regional' || product === 'regionalExp' || product === 'national' || product === 'nationalExpress') {
                        trains.push(dep);
                    } else if (product === 'bus') {
                        buses.push(dep);
                    }
                }
                
                console.log('ğŸš‚ ZÃ¼ge:', trains.length);
                console.log('ğŸšŒ Busse:', buses.length);
                
                // Anzeigen
                displayTrains(trains, stopName);
                displayBuses(buses, stopName);
                
            } catch (error) {
                console.error('âŒ FEHLER beim Laden der Abfahrten:', error);
                showScheduleError('Fehler beim Laden der Abfahrten: ' + error.message);
            }
        }
        
        // Zeigt ZÃ¼ge an
        function displayTrains(trains, stopName) {
            const container = document.getElementById('schedule-trains');
            
            if (trains.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;padding:20px;color:#6b7280;">
                        Keine ZÃ¼ge in den nÃ¤chsten 2 Stunden
                    </div>
                `;
                return;
            }
            
            const html = trains.slice(0, 10).map(train => {
                const when = new Date(train.when);
                const plannedWhen = new Date(train.plannedWhen);
                const delay = train.delay ? Math.round(train.delay / 60) : 0;
                const isDelayed = delay > 0;
                
                // Countdown berechnen
                const now = new Date();
                const minutesUntil = Math.round((when - now) / 60000);
                const countdownText = minutesUntil < 1 ? 'Jetzt' : 
                                      minutesUntil === 1 ? 'in 1 Min' : 
                                      `in ${minutesUntil} Min`;
                
                return `
                    <div style="background:white;padding:12px;border-radius:8px;margin-bottom:8px;border-left:4px solid #3b82f6;">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
                            <div style="flex:1;">
                                <div style="font-weight:700;color:#1f2937;font-size:15px;">
                                    ${train.line.name} â†’ Richtung: ${train.direction}
                                </div>
                                <div style="font-size:13px;color:#6b7280;margin-top:4px;">
                                    ğŸ“ Ab: ${stopName}${train.platform ? ' | Gleis ' + train.platform : ''}
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:18px;font-weight:700;color:#1f2937;">
                                    ${when.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}
                                </div>
                                <div style="font-size:12px;color:${isDelayed ? '#dc2626' : '#10b981'};">
                                    ${isDelayed ? 'ğŸ• +' + delay + ' Min' : 'âš¡ PÃ¼nktlich'}
                                </div>
                            </div>
                        </div>
                        <div style="font-size:13px;font-weight:600;color:#3b82f6;">
                            â° ${countdownText}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }
        
        // Zeigt Busse an
        function displayBuses(buses, stopName) {
            const container = document.getElementById('schedule-buses');
            
            if (buses.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;padding:20px;color:#6b7280;">
                        Keine Busse in den nÃ¤chsten 2 Stunden
                    </div>
                `;
                return;
            }
            
            const html = buses.slice(0, 10).map(bus => {
                const when = new Date(bus.when);
                const plannedWhen = new Date(bus.plannedWhen);
                const delay = bus.delay ? Math.round(bus.delay / 60) : 0;
                const isDelayed = delay > 0;
                
                // Countdown berechnen
                const now = new Date();
                const minutesUntil = Math.round((when - now) / 60000);
                const countdownText = minutesUntil < 1 ? 'Jetzt' : 
                                      minutesUntil === 1 ? 'in 1 Min' : 
                                      `in ${minutesUntil} Min`;
                
                return `
                    <div style="background:white;padding:12px;border-radius:8px;margin-bottom:8px;border-left:4px solid #f59e0b;">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
                            <div style="flex:1;">
                                <div style="font-weight:700;color:#1f2937;font-size:15px;">
                                    Bus ${bus.line.name} â†’ Richtung: ${bus.direction}
                                </div>
                                <div style="font-size:13px;color:#6b7280;margin-top:4px;">
                                    ğŸ“ Ab: ${stopName}
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:18px;font-weight:700;color:#1f2937;">
                                    ${when.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}
                                </div>
                                <div style="font-size:12px;color:${isDelayed ? '#dc2626' : '#10b981'};">
                                    ${isDelayed ? 'ğŸ• +' + delay + ' Min' : 'âš¡ PÃ¼nktlich'}
                                </div>
                            </div>
                        </div>
                        <div style="font-size:13px;font-weight:600;color:#f59e0b;">
                            â° ${countdownText}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }
        
        // Zeigt Fehler an
        function showScheduleError(message) {
            document.getElementById('schedule-trains').innerHTML = `
                <div style="background:#fef2f2;color:#dc2626;padding:15px;border-radius:8px;text-align:center;">
                    âš ï¸ ${message}
                </div>
            `;
            document.getElementById('schedule-buses').innerHTML = '';
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function updateStatus() {
            const dot = document.getElementById('sync-dot');
            const status = document.getElementById('sync-status');
            if (isFirebaseReady && isConnected) {
                dot.classList.add('online');
                status.textContent = 'ğŸŸ¢ Live';
            } else {
                dot.classList.remove('online');
                status.textContent = 'ğŸ’¾ Lokal';
            }
        }
        async function initServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    serviceWorkerRegistration = await navigator.serviceWorker.register('./service-worker.js');
                    console.log('âœ… Service Worker registriert:', serviceWorkerRegistration.scope);
                    
                    // Push-Berechtigung anfragen (nur beim ersten Mal oder wenn abgelehnt)
                    if ('Notification' in window) {
                        notificationPermission = await Notification.requestPermission();
                        console.log('ğŸ”” Notification Permission:', notificationPermission);
                        
                        if (notificationPermission === 'granted') {
                            console.log('âœ… Push-Benachrichtigungen erlaubt!');
                        }
                    }
                } catch (error) {
                    console.error('âŒ Service Worker Fehler:', error);
                }
            } else {
                console.warn('âš ï¸ Service Worker nicht unterstÃ¼tzt');
            }
        }

        // Push-Benachrichtigung senden (lokal)
        function sendLocalNotification(title, body, data = {}) {
            if ('Notification' in window && Notification.permission === 'granted') {
                if (serviceWorkerRegistration) {
                    serviceWorkerRegistration.showNotification(title, {
                        body: body,
                        icon: '/icon-192.png',
                        badge: '/badge-72.png',
                        vibrate: [200, 100, 200, 100, 200],
                        tag: 'taxi-' + (data.rideId || 'notification'),
                        requireInteraction: true,
                        data: data,
                        actions: [
                            { action: 'accept', title: 'âœ“ Annehmen' },
                            { action: 'dismiss', title: 'âœ• Ablehnen' }
                        ]
                    });
                    
                    // Sound abspielen
                    playNotificationSound();
                }
            } else {
                console.warn('âš ï¸ Notifications nicht verfÃ¼gbar oder nicht erlaubt');
            }
        }

        // Sound fÃ¼r Benachrichtigungen
        function playNotificationSound() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ==');
                audio.volume = 1.0;
                audio.play().catch(e => console.log('ğŸ”‡ Audio play blocked'));
            } catch (e) {
                console.log('ğŸ”‡ Audio not supported');
            }
        }

        function switchView(view) {
            console.log('ğŸ”„ switchView aufgerufen mit:', view);
            
            // Entferne active von allen Views
            document.querySelectorAll('.view').forEach(v => {
                v.classList.remove('active');
                v.style.display = 'none'; // Extra sicher!
                v.style.visibility = 'hidden'; // ğŸ†• v5.33.4: Auch visibility!
            });
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            // ğŸ†• v5.33.1: Entferne active von Admin-Tab-Buttons
            document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));
            
            // ğŸ†• v5.33.4: EXTRA BRUTAL - Verstecke alle Views einzeln!
            const allViews = ['passenger-view', 'schedule-view', 'history-view', 'driver-view', 'admin-view'];
            allViews.forEach(viewId => {
                const viewEl = document.getElementById(viewId);
                if (viewEl) {
                    viewEl.style.display = 'none';
                    viewEl.style.visibility = 'hidden';
                    viewEl.classList.remove('active');
                    console.log('  âŒ Versteckt:', viewId);
                }
            });
            
            // âœ… Zeige nur die aktive View
            const viewElement = document.getElementById(view + '-view');
            if (viewElement) {
                viewElement.style.display = 'block';
                viewElement.style.visibility = 'visible';
                viewElement.classList.add('active');
                console.log('  âœ… Zeige:', view + '-view');
            } else {
                console.error('  âš ï¸ View nicht gefunden:', view + '-view');
            }
            
            // âœ… Setze aktiven Button basierend auf View-Name
            const viewBtnMap = {
                'passenger': '.view-btn[onclick*="passenger"]',
                'schedule': '.view-btn[onclick*="schedule"]',
                'history': '.view-btn[onclick*="history"]',
                'driver': '.view-btn[onclick*="driver"]',
                'admin': '.view-btn[onclick*="admin"]'
            };
            const btnSelector = viewBtnMap[view];
            if (btnSelector) {
                const btn = document.querySelector(btnSelector);
                if (btn) btn.classList.add('active');
            }
            
            // ğŸ†• v5.33.1: Setze aktiven Admin-Tab-Button
            const adminTabBtn = document.querySelector(`.admin-tab-btn[data-view="${view}"]`);
            if (adminTabBtn) {
                adminTabBtn.classList.add('active');
            }
            
            currentView = view;
            
            console.log('ğŸ”„ View gewechselt zu:', view);
            
            // ğŸ†• v5.26.0: Telefon-Auth prÃ¼fen bei Fahrgast-Tab
            if (view === 'passenger') {
                setTimeout(() => checkPassengerAuth(), 100);
            } else {
                // Login-Screen verstecken bei anderen Tabs
                const authScreen = document.getElementById('phone-auth-screen');
                if (authScreen) authScreen.style.display = 'none';
            }
            
            // ğŸ†• v5.32.6: Fahrplan laden bei Schedule-Tab
            if (view === 'schedule') {
                setTimeout(() => loadSchedule(), 100);
            }
            
            const gpsIndicator = document.getElementById('gps-indicator');
            if (view === 'driver') {
                if (gpsIndicator) gpsIndicator.style.display = 'flex';
                
                // ğŸ”‹ Initialisiere Batterie-Spar-System
                if (typeof PowerSaveManager !== 'undefined') {
                    setTimeout(() => PowerSaveManager.init(), 500);
                }
                
                // âš™ï¸ Initialisiere Driver-Settings-Manager (nach PowerSaveManager!)
                if (typeof DriverSettingsManager !== 'undefined' && currentVehicle) {
                    setTimeout(() => DriverSettingsManager.init(currentVehicle), 1000);
                }
                
                // ğŸ¯ AUTO-START GPS beim Ã–ffnen der Fahrer-Ansicht!
                console.log('ğŸš• Fahrer-Ansicht geÃ¶ffnet - starte GPS automatisch...');
                setTimeout(() => {
                    if (!watchId && currentVehicle) {
                        console.log('ğŸ”„ GPS Auto-Start...');
                        startGPSTracking();
                    }
                    // Starte GPS-Monitoring
                    startGPSMonitoring();
                }, 500);
            } else {
                if (gpsIndicator) gpsIndicator.style.display = 'none';
                // âœ… Stoppe GPS-Monitoring UND GPS-Tracking wenn Ansicht gewechselt wird
                stopGPSMonitoring();
                stopDriverTracking();  // â† FIX: GPS auch stoppen!
                console.log('ğŸ”„ View gewechselt - GPS gestoppt');
            }
            
            if (view === 'history') loadHistory();
            
            updateViews();
        }

        // ğŸ“± MENÃœ FUNKTIONEN
        function toggleMenu(event) {
            event.stopPropagation();
            const menu = document.getElementById('menu-overlay');
            if (menu.style.display === 'none' || !menu.style.display) {
                menu.style.display = 'block';
                document.body.style.overflow = 'hidden'; // Verhindere Scrollen im Hintergrund
            } else {
                closeMenu();
            }
        }

        function closeMenu() {
            const menu = document.getElementById('menu-overlay');
            menu.style.display = 'none';
            document.body.style.overflow = ''; // Erlaube Scrollen wieder
        }

        function openScheduleFromMenu() {
            closeMenu();
            switchView('schedule');
        }

        function openHistoryFromMenu() {
            closeMenu();
            switchView('history');
        }

        function backToBookingFromMenu() {
            closeMenu();
            switchView('passenger');
        }

        // ğŸ†• v5.33.1: Admin-Tabs anzeigen/verstecken
        function updateAdminTabsVisibility() {
            const adminTabs = document.getElementById('admin-tabs');
            if (!adminTabs) return;
            
            // ğŸ†• v5.33.6: PrÃ¼fe User-Rolle!
            // Tabs nur fÃ¼r Fahrer & Admin, NICHT fÃ¼r FahrgÃ¤ste!
            
            // 1. PrÃ¼fe ob User eingeloggt ist
            const phoneAuthScreen = document.getElementById('phone-auth-screen');
            const phoneAuthVisible = phoneAuthScreen && phoneAuthScreen.style.display !== 'none';
            
            const accountName = document.getElementById('customer-name-display');
            const hasName = accountName && accountName.textContent && accountName.textContent.trim() !== '';
            
            const bookingForm = document.getElementById('booking-form');
            const bookingVisible = bookingForm && window.getComputedStyle(bookingForm).display !== 'none';
            
            const isLoggedIn = !phoneAuthVisible && (hasName || bookingVisible);
            
            // 2. PrÃ¼fe User-Rolle (global gesetzt durch applyRoleRestrictions)
            // Tabs ONLY fÃ¼r Fahrer & Admin!
            const showTabs = isLoggedIn && (userRole === 'admin' || userRole === 'fahrer');
            
            if (showTabs) {
                adminTabs.style.display = 'block';
                console.log('âœ… Admin-Tabs angezeigt (User:', userRole, ')');
            } else {
                adminTabs.style.display = 'none';
                if (isLoggedIn) {
                    console.log('âŒ Admin-Tabs versteckt (Fahrgast - nutzt MenÃ¼)');
                } else {
                    console.log('âŒ Admin-Tabs versteckt (nicht eingeloggt)');
                }
            }
        }
        
        // Admin-Tabs beim Laden prÃ¼fen (mehrfach fÃ¼r Sicherheit)
        setTimeout(() => updateAdminTabsVisibility(), 500);
        setTimeout(() => updateAdminTabsVisibility(), 1500);
        setTimeout(() => updateAdminTabsVisibility(), 3000);
        // Und danach regelmÃ¤ÃŸig
        setInterval(() => updateAdminTabsVisibility(), 5000);

        // ğŸ¯ GPS MONITORING - PrÃ¼ft alle 5 Sekunden ob GPS lÃ¤uft
        let gpsMonitoringInterval = null;
        let lastGPSUpdate = null;
        
        function startGPSMonitoring() {
            console.log('ğŸ‘€ GPS-Monitoring gestartet');
            
            if (gpsMonitoringInterval) {
                clearInterval(gpsMonitoringInterval);
            }
            
            gpsMonitoringInterval = setInterval(() => {
                const now = Date.now();
                const timeSinceLastUpdate = lastGPSUpdate ? (now - lastGPSUpdate) / 1000 : null;
                
                // Update UI
                updateGPSStatus(timeSinceLastUpdate);
                
                // Warnung wenn kein GPS seit 15 Sekunden
                if (timeSinceLastUpdate && timeSinceLastUpdate > 15) {
                    console.warn('âš ï¸ GPS VERLOREN! Keine Updates seit', Math.round(timeSinceLastUpdate), 'Sekunden');
                    
                    // Versuche GPS neu zu starten
                    if (watchId && currentVehicle) {
                        console.log('ğŸ”„ Versuche GPS neu zu starten...');
                        navigator.geolocation.clearWatch(watchId);
                        watchId = null;
                        setTimeout(() => startGPSTracking(), 1000);
                    }
                }
            }, 5000); // Alle 5 Sekunden prÃ¼fen
        }
        
        function stopGPSMonitoring() {
            if (gpsMonitoringInterval) {
                clearInterval(gpsMonitoringInterval);
                gpsMonitoringInterval = null;
                console.log('â¹ï¸ GPS-Monitoring gestoppt');
            }
        }
        
        function updateGPSStatus(timeSinceLastUpdate) {
            const statusDiv = document.getElementById('gps-status-compact');
            const iconSpan = document.getElementById('gps-icon-compact');
            const textSpan = document.getElementById('gps-text-compact');
            
            if (!statusDiv) return;
            
            if (!timeSinceLastUpdate || timeSinceLastUpdate > 30) {
                // KEIN GPS oder sehr alt
                statusDiv.style.background = 'rgba(239,68,68,0.1)';
                statusDiv.style.color = '#ef4444';
                iconSpan.textContent = 'âŒ';
                textSpan.textContent = 'GPS';
            } else if (timeSinceLastUpdate < 5) {
                // GPS GUT (frisch!)
                statusDiv.style.background = 'rgba(16,185,129,0.1)';
                statusDiv.style.color = '#10b981';
                iconSpan.textContent = 'ğŸ“';
                textSpan.textContent = 'GPS';
            } else if (timeSinceLastUpdate < 15) {
                // GPS OK (etwas alt)
                statusDiv.style.background = 'rgba(245,158,11,0.1)';
                statusDiv.style.color = '#f59e0b';
                iconSpan.textContent = 'âš ï¸';
                textSpan.textContent = 'GPS';
            } else {
                // GPS SCHWACH
                statusDiv.style.background = 'rgba(239,68,68,0.1)';
                statusDiv.style.color = '#ef4444';
                iconSpan.textContent = 'âš ï¸';
                textSpan.textContent = 'GPS';
            }
        }

        // ğŸ†• v5.21.7: Debounce fÃ¼r updateViews (verhindert Flackern)
        let updateViewsTimeout = null;
        function updateViewsDebounced() {
            if (updateViewsTimeout) {
                clearTimeout(updateViewsTimeout);
            }
            updateViewsTimeout = setTimeout(() => {
                updateViews();
            }, 100); // 100ms warten
        }

        function updateViews() {
            // Update Debug Panel
            if (document.getElementById('debug-firebase')) {
                document.getElementById('debug-firebase').textContent = isFirebaseReady ? (isConnected ? 'âœ… Verbunden' : 'âš ï¸ Offline') : 'âŒ Fehler';
                document.getElementById('debug-rides').textContent = rides.length;
                document.getElementById('debug-new').textContent = rides.filter(r => r.status === 'new').length;
                document.getElementById('debug-sync').textContent = new Date().toLocaleTimeString('de-DE');
            }
            
            if (currentView === 'driver') updateDriverView();
            else if (currentView === 'admin') updateAdminView();
            else if (currentView === 'history') updateHistoryView();
        }

        function updateDriverView() {
            const newRides = rides.filter(r => r.status === 'new');
            const myRides = currentVehicle ? rides.filter(r => r.vehicleId === currentVehicle || r.vehicle === (VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle)) : [];
            const current = myRides.find(r => r.status === 'accepted' || r.status === 'picked_up');
            const completed = myRides.filter(r => r.status === 'completed');
            
            // ğŸš¨ CHECK FÃœR STORNIERTE FAHRTEN DIE BESTÃ„TIGUNG BRAUCHEN
            const pendingCancellations = myRides.filter(r => 
                (r.status === 'cancelled_pending_driver' || 
                (r.status === 'cancelled' && r.driverNotified === false))
            );
            
            // Update Badge
            const cancellationBadge = document.getElementById('cancellation-badge');
            const cancellationCount = document.getElementById('cancellation-count');
            if (cancellationBadge && cancellationCount) {
                if (pendingCancellations.length > 0) {
                    cancellationBadge.style.display = 'block';
                    cancellationCount.textContent = pendingCancellations.length;
                } else {
                    cancellationBadge.style.display = 'none';
                }
            }
            
            // Alte Benachrichtigungs-Logik (fÃ¼r KompatibilitÃ¤t)
            // ğŸ†• v5.31.6: Nur NEUE Stornierungen anzeigen (letzte 2 Min statt 10!)
            const twoMinutesAgo = Date.now() - (2 * 60 * 1000); // âœ… GeÃ¤ndert von 10 auf 2 Min!
            const cancelledRides = myRides.filter(r => 
                r.status === 'cancelled' && 
                r.driverNotified === false &&
                r.cancelledAt && r.cancelledAt > twoMinutesAgo // Nur letzte 2 Min!
            );
            if (cancelledRides.length > 0) {
                cancelledRides.forEach(ride => {
                    // ğŸ†• v5.21.7: Nur anzeigen wenn noch nicht gezeigt!
                    const rideKey = ride.firebaseId || ride.id;
                    if (!notifiedCancellations.has(rideKey)) {
                        notifiedCancellations.add(rideKey);
                        notifyDriverOfCancellation(ride);
                    }
                });
            }
            
            // Show/Hide Map vs Ready State
            if (current) {
                document.getElementById('driver-route-info').style.display = 'block';
                document.getElementById('driver-ready').style.display = 'none';
                
                // Fahrt Info im Bottom Panel - mit Zeitstempel
                let rideInfo = '';
                
                // Buchungszeit formatieren
                if (current.createdAt || current.timestamp) {
                    const bookingDate = new Date(current.createdAt || current.timestamp);
                    const timeStr = bookingDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    rideInfo += `<span style="font-size:11px;color:#888;">ğŸ“… ${timeStr}</span> â€¢ `;
                }
                
                if (current.customerName) rideInfo += `ğŸ‘¤ ${current.customerName} â€¢ `;
                rideInfo += `â†’ ${current.destination}`;
                if (current.price) rideInfo += ` â€¢ ğŸ’° ${current.price}â‚¬`;
                
                document.getElementById('driver-current-ride').innerHTML = rideInfo;
                
                // Buttons im Bottom Panel
                let buttonsHtml = '';
                if (current.status === 'accepted') {
                    buttonsHtml = `
                        <button onclick="pickupCustomer('${current.firebaseId}')" style="
                            width: 100%;
                            padding: 14px;
                            background: #10b981;
                            color: white;
                            border: none;
                            border-radius: 12px;
                            font-size: 16px;
                            font-weight: bold;
                            cursor: pointer;
                        ">
                            ğŸš• Kunde abgeholt
                        </button>
                    `;
                } else if (current.status === 'picked_up') {
                    buttonsHtml = `
                        <div style="
                            display: flex;
                            gap: 10px;
                        ">
                            <button onclick="completeRide('${current.firebaseId}')" style="
                                flex: 1;
                                padding: 14px;
                                background: #10b981;
                                color: white;
                                border: none;
                                border-radius: 12px;
                                font-size: 16px;
                                font-weight: bold;
                                cursor: pointer;
                            ">
                                âœ“ Fahrt abschlieÃŸen
                            </button>
                        </div>
                    `;
                }
                
                // Insert buttons into bottom panel (append after driver-current-ride)
                const bottomPanel = document.getElementById('bottom-panel');
                let actionsDiv = bottomPanel.querySelector('#driver-actions');
                if (!actionsDiv) {
                    actionsDiv = document.createElement('div');
                    actionsDiv.id = 'driver-actions';
                    bottomPanel.appendChild(actionsDiv);
                }
                actionsDiv.innerHTML = buttonsHtml;
                actionsDiv.style.display = 'block';
                
            } else {
                document.getElementById('driver-route-info').style.display = 'none';
                document.getElementById('driver-ready').style.display = 'block';
                
                // Update ready message
                if (currentVehicle && isOnline) {
                    document.getElementById('driver-ready').innerHTML = `
                        <div style="font-size:64px;margin-bottom:20px;">ğŸš•</div>
                        <div style="font-size:24px;font-weight:600;color:#10b981;margin-bottom:10px;">Bereit fÃ¼r AuftrÃ¤ge</div>
                        <div style="font-size:14px;color:#666;">Du bist online & bereit!</div>
                    `;
                } else if (currentVehicle) {
                    document.getElementById('driver-ready').innerHTML = `
                        <div style="font-size:64px;margin-bottom:20px;">âš ï¸</div>
                        <div style="font-size:24px;font-weight:600;color:#f59e0b;margin-bottom:10px;">Offline</div>
                        <div style="font-size:14px;color:#666;">Gehe Online um AuftrÃ¤ge zu erhalten!</div>
                    `;
                } else {
                    document.getElementById('driver-ready').innerHTML = `
                        <div style="font-size:80px;margin-bottom:20px;">ğŸš•</div>
                        <div style="font-size:28px;font-weight:600;color:#667eea;margin-bottom:10px;">Bereit!</div>
                        <div style="font-size:14px;color:#999;">WÃ¤hle Fahrzeug & gehe Online</div>
                    `;
                }
            }
            
            // New rides
            if (!currentVehicle) {
                document.getElementById('new-rides').innerHTML = '<div style="padding:20px;text-align:center;color:#999;">âš ï¸ Bitte erst Fahrzeug wÃ¤hlen</div>';
            } else if (newRides.length === 0) {
                document.getElementById('new-rides').innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Keine neuen AuftrÃ¤ge</div>';
            } else {
                let ridesHtml = newRides.map(r => {
                    // ğŸ¯ Check ob Fahrt diesem Fahrer zugewiesen ist
                    const isAssignedToMe = r.assignedTo === currentVehicle;
                    const timeLeft = r.assignmentExpiresAt ? Math.max(0, Math.ceil((r.assignmentExpiresAt - Date.now()) / 1000)) : null;
                    
                    let assignmentBadge = '';
                    let cardStyle = '';
                    
                    if (isAssignedToMe && timeLeft > 0) {
                        assignmentBadge = `<span style="background:#ef4444;color:white;padding:4px 8px;border-radius:12px;font-size:12px;font-weight:bold;animation:pulse 1s infinite;">â° DIR ZUGEWIESEN - ${timeLeft}s</span>`;
                        cardStyle = 'border:3px solid #ef4444;background:#fef2f2;';
                    } else if (r.assignedTo && r.assignedTo !== currentVehicle) {
                        assignmentBadge = `<span style="background:#94a3b8;padding:4px 8px;border-radius:12px;font-size:12px;">ğŸ‘¤ Zugewiesen: ${r.assignedVehicleName || r.assignedTo}</span>`;
                    } else {
                        assignmentBadge = '<span style="background:#fef3c7;padding:4px 8px;border-radius:12px;font-size:12px;">ğŸ†• Neu</span>';
                    }
                    
                    return `
                    <div class="ride-card" style="${cardStyle}">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <strong>#${r.id}</strong>
                            ${assignmentBadge}
                        </div>
                        ${r.customerName ? `
                        <div style="margin-top:12px;padding:12px;background:#f0f9ff;border-radius:8px;border-left:4px solid #3b82f6;">
                            <div style="font-size:16px;font-weight:600;color:#1e40af;margin-bottom:8px;">
                                ğŸ‘¤ ${r.customerName}
                            </div>
                            <div style="font-size:14px;color:#0369a1;">
                                ğŸ• Abholung: <strong>${r.pickupTime || 'Sofort'}</strong>
                            </div>
                        </div>
                        ` : ''}
                        <div style="margin-top:10px;font-size:14px;">
                            <strong>Von:</strong> ${r.pickup}<br>
                            <strong>Nach:</strong> ${r.destination}<br>
                            <strong>Distanz:</strong> ${r.distance} km â€¢ ${r.duration} Min<br>
                            <strong>Preis:</strong> ${r.price}â‚¬
                            ${r.assignmentDistance ? `<br><strong>ğŸ“ Du bist:</strong> ${r.assignmentDistance.toFixed(1)} km entfernt` : ''}<br>
                            <div style="margin-top:6px;padding:6px 8px;background:#f3f4f6;border-radius:4px;font-size:12px;color:#4b5563;">
                                ğŸ“… Bestellt: <strong>${r.time}</strong>
                                ${r.pickupTime && r.pickupTime !== 'Sofort' ? ` | â° Abholung: <strong>${r.pickupTime}</strong>` : ' | âš¡ Sofort'}
                            </div>
                        </div>
                        ${!current ? `<button class="btn btn-success" onclick="acceptRide('${r.firebaseId}')" style="margin-top:10px;">âœ“ Annehmen</button>` : '<div style="margin-top:10px;padding:8px;background:#fef3c7;border-radius:6px;font-size:13px;text-align:center;">SchlieÃŸe erst aktuelle Fahrt ab</div>'}
                    </div>
                    `;
                }).join('');
                
                if (!isOnline) {
                    ridesHtml = '<div class="alert-info" style="margin-bottom:15px;">âš ï¸ Du bist <strong>Offline</strong>. Schalte auf Online um AuftrÃ¤ge anzunehmen.</div>' + ridesHtml;
                }
                
                document.getElementById('new-rides').innerHTML = ridesHtml;
            }
            
            // Update Counter fÃ¼r neue AuftrÃ¤ge
            const countElement = document.getElementById('new-rides-count');
            if (countElement) {
                countElement.textContent = newRides.length;
            }
            
            // Stats
            const revenue = completed.reduce((sum, r) => sum + parseFloat(r.price), 0);
            document.getElementById('d-rides').textContent = completed.length;
            document.getElementById('d-money').textContent = revenue.toFixed(2) + 'â‚¬';
            
            // ğŸ§ª Zeige Test-Buttons wenn Fahrer-View aktiv
            const testButtons = document.getElementById('alert-test-buttons');
            if (testButtons) {
                testButtons.style.display = (currentView === 'driver' && currentVehicle) ? 'flex' : 'none';
            }
            
            // ğŸ“Š Update Alert Status
            updateAlertStatus();
        }

        function updateAdminView() {
            // ğŸ“¦ Merge Firebase + localStorage fÃ¼r vollstÃ¤ndige Ansicht
            let allRides = [...rides]; // Kopiere Firebase Fahrten
            
            // Lade auch aus localStorage (fÃ¼r Offline-Buchungen & stornierte Fahrten)
            const localHistory = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            localHistory.forEach(localRide => {
                const existsInFirebase = allRides.some(fbRide => fbRide.id === localRide.id || fbRide.firebaseId === localRide.firebaseId);
                if (!existsInFirebase) {
                    allRides.push(localRide);
                }
            });
            
            // ğŸ§¹ FILTERE ALTE FAHRTEN (Ã¤lter als 3 Tage) AUTOMATISCH RAUS
            const threeDaysAgo = Date.now() - (3 * 24 * 60 * 60 * 1000);
            allRides = allRides.filter(r => {
                const rideTime = r.pickupTimestamp || r.createdAt || 0;
                // Behalte nur: completed (immer), oder Fahrten von letzten 3 Tagen
                return r.status === 'completed' || r.status === 'abgeschlossen' || rideTime > threeDaysAgo;
            });
            
            console.log('ğŸ” ADMIN DEBUG - Gesamt Fahrten (nach Filter):', allRides.length);
            console.log('ğŸ” ADMIN DEBUG - Status:', allRides.map(r => r.status));
            
            const completed = allRides.filter(r => r.status === 'completed' || r.status === 'abgeschlossen');
            const pending = allRides.filter(r => r.status === 'new' || r.status === 'vorbestellt');
            const active = allRides.filter(r => r.status === 'accepted' || r.status === 'akzeptiert' || r.status === 'unterwegs' || r.status === 'picked_up');
            const rejected = allRides.filter(r => r.status === 'rejected'); // ğŸ†• Abgelehnte Fahrten
            const revenue = completed.reduce((sum, r) => sum + parseFloat(r.price), 0);
            
            document.getElementById('a-total').textContent = completed.length;
            document.getElementById('a-revenue').textContent = revenue.toFixed(2) + 'â‚¬';
            document.getElementById('a-pending').textContent = pending.length;
            document.getElementById('a-active').textContent = active.length;
            
            // ğŸ†• v5.31.5: Update Benachrichtigungs-Bar
            updateNotificationBar();
            
            // ğŸ“‹ OFFENE FAHRTEN = vorbestellt, new, akzeptiert, unterwegs, angekommen
            const now = Date.now();
            const openRides = allRides.filter(r => {
                const openStatuses = ['vorbestellt', 'new', 'akzeptiert', 'accepted', 'unterwegs', 'picked_up', 'angekommen'];
                return openStatuses.includes(r.status);
            }).sort((a, b) => {
                // Sortiere nach Abholzeit (falls vorhanden) oder Erstellungszeit
                const timeA = a.pickupTimestamp || a.createdAt || 0;
                const timeB = b.pickupTimestamp || b.createdAt || 0;
                return timeA - timeB;
            });
            
            if (openRides.length === 0) {
                document.getElementById('upcoming-rides-admin').innerHTML = '<div style="padding:15px;text-align:center;color:#999;background:white;border-radius:8px;">Keine offenen Fahrten</div>';
            } else {
                // Gruppiere nach Tag
                const groupedByDay = {};
                openRides.forEach(ride => {
                    const rideTime = ride.pickupTimestamp || ride.createdAt;
                    const rideDate = new Date(rideTime);
                    const dayKey = rideDate.toLocaleDateString('de-DE', { 
                        weekday: 'long', 
                        day: '2-digit', 
                        month: '2-digit',
                        year: 'numeric'
                    });
                    
                    if (!groupedByDay[dayKey]) {
                        groupedByDay[dayKey] = [];
                    }
                    groupedByDay[dayKey].push(ride);
                });
                
                // Baue HTML fÃ¼r gruppierte Fahrten
                let html = '';
                Object.keys(groupedByDay).forEach(dayKey => {
                    const ridesForDay = groupedByDay[dayKey];
                    html += `<div style="margin-bottom:20px;">
                        <h4 style="background:#667eea;color:white;padding:10px;border-radius:8px;margin-bottom:10px;">
                            ğŸ“… ${dayKey} (${ridesForDay.length} Fahrt${ridesForDay.length !== 1 ? 'en' : ''})
                        </h4>`;
                    
                    ridesForDay.forEach(r => {
                        const pickupDate = new Date(r.pickupTimestamp || r.createdAt);
                        const formattedTime = pickupDate.toLocaleTimeString('de-DE', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                        
                        // Zeitdifferenz berechnen
                        const hoursUntil = Math.floor((pickupDate.getTime() - now) / (1000 * 60 * 60));
                        const daysUntil = Math.floor(hoursUntil / 24);
                        let countdownText = '';
                        if (daysUntil > 0) {
                            countdownText = `in ${daysUntil} Tag${daysUntil > 1 ? 'en' : ''}`;
                        } else if (hoursUntil > 0) {
                            countdownText = `in ${hoursUntil} Stunde${hoursUntil > 1 ? 'n' : ''}`;
                        } else {
                            const minutesUntil = Math.floor((pickupDate.getTime() - now) / (1000 * 60));
                            if (minutesUntil > 0) {
                                countdownText = `in ${minutesUntil} Min`;
                            } else {
                                countdownText = `JETZT`;
                            }
                        }
                        
                        // Status-Badge
                        let statusBadge = '';
                        let borderColor = '#0ea5e9';
                        let bgColor = '#e0f2fe';
                        
                        if (r.status === 'vorbestellt') {
                            statusBadge = '<span style="background:#f59e0b;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;margin-left:8px;">ğŸ“… Vorbestellt</span>';
                            borderColor = '#f59e0b';
                            bgColor = '#fef3c7';
                        } else if (r.status === 'new') {
                            statusBadge = '<span style="background:#3b82f6;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;margin-left:8px;">ğŸ”” Neu</span>';
                            borderColor = '#3b82f6';
                            bgColor = '#dbeafe';
                        } else if (r.status === 'akzeptiert' || r.status === 'accepted') {
                            statusBadge = '<span style="background:#10b981;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;margin-left:8px;">âœ… Akzeptiert</span>';
                            borderColor = '#10b981';
                            bgColor = '#d1fae5';
                        } else if (r.status === 'unterwegs' || r.status === 'picked_up') {
                            statusBadge = '<span style="background:#0ea5e9;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;margin-left:8px;">ğŸš— Unterwegs</span>';
                            borderColor = '#0ea5e9';
                            bgColor = '#e0f2fe';
                        }
                        
                        // ğŸ”˜ Aktions-Buttons fÃ¼r offene Fahrten
                        let actionButtons = '';
                        if (r.status === 'vorbestellt' || r.status === 'new') {
                            actionButtons = `
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:10px;">
                                    <button onclick="assignVehicleToRide('${r.firebaseId || r.id}')" 
                                        style="padding:10px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:700;">
                                        ğŸš— Fahrer zuweisen
                                    </button>
                                    <button onclick="editRide('${r.firebaseId || r.id}')" 
                                        style="padding:8px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                        âœï¸ Bearbeiten
                                    </button>
                                    <button onclick="reverseRouteAdmin('${r.firebaseId || r.id}')" 
                                        style="padding:8px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                        ğŸ”„ Umdrehen
                                    </button>
                                    <button onclick="deleteRide('${r.firebaseId || r.id}')" 
                                        style="padding:8px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                        ğŸ—‘ï¸ LÃ¶schen
                                    </button>
                                </div>
                            `;
                        }
                        
                        html += `<div class="ride-card" style="border-left:4px solid ${borderColor};background:${bgColor};">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <strong>${r.customerName || 'Unbekannt'}</strong>
                                <div style="display:flex;gap:6px;align-items:center;">
                                    <span style="background:#0ea5e9;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;">${countdownText}</span>
                                    ${statusBadge}
                                    ${r.adminConfirmed || acknowledgedRides.has(r.id) ? '<span style="background:#10b981;color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;">âœ… BestÃ¤tigt</span>' : ''}
                                    <button onclick="exportSingleRideToICS('${r.firebaseId || r.id}')" 
                                        style="background:#8b5cf6;color:white;padding:4px 8px;border:none;border-radius:12px;font-size:11px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:4px;"
                                        title="Als Kalender-Termin exportieren">
                                        ğŸ“¥ ICS
                                    </button>
                                </div>
                            </div>
                            <div style="margin-top:10px;font-size:14px;color:#0c4a6e;">
                                <strong>ğŸ• ${formattedTime} Uhr</strong><br>
                                <strong>ğŸ“ Von:</strong> ${r.pickup}<br>
                                <strong>ğŸ¯ Nach:</strong> ${r.destination}<br>
                                <strong>ğŸ’° Preis:</strong> ${r.price}â‚¬<br>
                                <strong>ğŸ“ Distanz:</strong> ${r.distance} km
                                ${r.vehicleLabel ? '<br><strong>ğŸš— Fahrzeug:</strong> '+r.vehicleLabel : ''}
                            </div>
                            ${actionButtons}
                        </div>`;
                    });
                    
                    html += '</div>';
                });
                
                document.getElementById('upcoming-rides-admin').innerHTML = html;
            }
            
            // âŒ ABGELEHNTE FAHRTEN anzeigen
            if (rejected.length === 0) {
                document.getElementById('rejected-rides-admin').innerHTML = '<div style="padding:15px;text-align:center;color:#999;background:white;border-radius:8px;">âœ… Keine abgelehnten Fahrten</div>';
            } else {
                let rejectedHTML = '<div style="background:#fef2f2;border:2px solid #ef4444;border-radius:12px;padding:15px;margin-bottom:10px;">';
                rejectedHTML += `<div style="color:#991b1b;font-weight:bold;margin-bottom:10px;">âš ï¸ ${rejected.length} Fahrt${rejected.length !== 1 ? 'en' : ''} wurde${rejected.length !== 1 ? 'n' : ''} abgelehnt!</div>`;
                
                rejected.forEach(r => {
                    const rejectedTime = new Date(r.rejectedAt || r.createdAt).toLocaleString('de-DE');
                    rejectedHTML += `
                        <div style="background:white;padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid #ef4444;">
                            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px;">
                                <div style="flex:1;">
                                    <div style="font-size:12px;color:#666;margin-bottom:5px;">
                                        âŒ Abgelehnt von: <strong>${r.rejectedByDriver || r.rejectedBy || 'Unbekannt'}</strong>
                                    </div>
                                    <div style="font-size:12px;color:#999;">
                                        ${rejectedTime}
                                    </div>
                                </div>
                                <div style="font-size:24px;font-weight:bold;color:#ef4444;">${r.price}â‚¬</div>
                            </div>
                            ${r.customerName ? `<div style="font-weight:600;margin-bottom:8px;">ğŸ‘¤ ${r.customerName}</div>` : ''}
                            <div style="font-size:14px;margin-bottom:5px;">
                                <strong>ğŸ“ Von:</strong> ${r.pickup}
                            </div>
                            <div style="font-size:14px;margin-bottom:10px;">
                                <strong>ğŸ¯ Nach:</strong> ${r.destination}
                            </div>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
                                <button onclick="reassignRide('${r.firebaseId || r.id}')" style="
                                    padding:12px;
                                    background:#10b981;
                                    color:white;
                                    border:none;
                                    border-radius:8px;
                                    font-weight:bold;
                                    cursor:pointer;
                                ">
                                    ğŸ”„ Neu zuweisen
                                </button>
                                <button onclick="deleteRide('${r.firebaseId || r.id}')" style="
                                    padding:12px;
                                    background:#ef4444;
                                    color:white;
                                    border:none;
                                    border-radius:8px;
                                    font-weight:bold;
                                    cursor:pointer;
                                ">
                                    ğŸ—‘ï¸ LÃ¶schen
                                </button>
                            </div>
                        </div>`;
                });
                
                rejectedHTML += '</div>';
                document.getElementById('rejected-rides-admin').innerHTML = rejectedHTML;
            }
            
            // Stornierungen anzeigen
            if (cancellations.length === 0) {
                document.getElementById('cancellations-list').innerHTML = '<div style="padding:15px;text-align:center;color:#999;background:white;border-radius:8px;">Keine Stornierungen</div>';
            } else {
                const totalFees = cancellations.reduce((sum, c) => sum + parseFloat(c.cancellationFee || 0), 0);
                document.getElementById('cancellations-list').innerHTML = 
                    `<div style="background:#fef3c7;border:2px solid #f59e0b;padding:12px;border-radius:8px;margin-bottom:15px;text-align:center;">
                        <strong>Gesamt StornogebÃ¼hren: ${totalFees.toFixed(2)}â‚¬</strong> (${cancellations.length} Stornierungen)
                    </div>` +
                    cancellations.slice().reverse().map(c => {
                        const cancelDate = new Date(c.cancelledAt).toLocaleString('de-DE');
                        return `<div class="ride-card" style="border-left:4px solid #f59e0b;">
                            <strong>${c.customerName || 'Unbekannt'}</strong> 
                            <span style="background:#fef3c7;padding:4px 8px;border-radius:12px;font-size:12px;color:#92400e;font-weight:600;">ğŸ’¶ ${c.cancellationFee.toFixed(2)}â‚¬</span>
                            <div style="margin-top:10px;font-size:14px;color:#666;">
                                <strong>Von:</strong> ${c.pickup}<br>
                                <strong>Nach:</strong> ${c.destination}<br>
                                <strong>Original-Preis:</strong> ${c.originalPrice}â‚¬<br>
                                <strong>Storniert:</strong> ${cancelDate}
                            </div>
                        </div>`;
                    }).join('');
            }
            
            // âœ… NUR ABGESCHLOSSENE FAHRTEN zeigen
            const completedRides = allRides.filter(r => r.status === 'completed' || r.status === 'abgeschlossen');
            
            if (completedRides.length === 0) {
                document.getElementById('all-rides').innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Keine abgeschlossenen Fahrten</div>';
            } else {
                document.getElementById('all-rides').innerHTML = completedRides.slice().reverse().map(r => {
                    let statusText = r.status;
                    let statusColor = '#fef3c7';
                    if (r.status === 'completed') { statusText = 'Abgeschlossen'; statusColor = '#d1fae5'; }
                    else if (r.status === 'abgeschlossen') { statusText = 'Abgeschlossen'; statusColor = '#d1fae5'; }
                    else if (r.status === 'accepted') { statusText = 'Unterwegs'; statusColor = '#dbeafe'; }
                    else if (r.status === 'akzeptiert') { statusText = 'Akzeptiert'; statusColor = '#d1fae5'; }
                    else if (r.status === 'unterwegs') { statusText = 'Unterwegs'; statusColor = '#dbeafe'; }
                    else if (r.status === 'picked_up') { statusText = 'Besetzt'; statusColor = '#fef3c7'; }
                    else if (r.status === 'new') { statusText = 'Neu'; statusColor = '#fef3c7'; }
                    else if (r.status === 'vorbestellt') { statusText = 'Vorbestellt'; statusColor = '#fef3c7'; }
                    else if (r.status === 'storniert') { statusText = 'Storniert'; statusColor = '#fee2e2'; }
                    
                    // Abholzeit formatieren
                    let pickupTimeDisplay = r.pickupTime || 'Sofort';
                    if (r.pickupTimestamp) {
                        const pickupDate = new Date(r.pickupTimestamp);
                        const now = Date.now();
                        if (pickupDate.getTime() > now + (30 * 60000)) {
                            // Zukunft
                            pickupTimeDisplay = 'ğŸ“… ' + pickupDate.toLocaleString('de-DE', {
                                day: '2-digit',
                                month: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        }
                    }
                    
                    // Manuelle Zuweisung Button fÃ¼r neue Fahrten
                    let assignButton = '';
                    if (r.status === 'new' && r.firebaseId) {
                        assignButton = `<button onclick="manuallyAssignRide('${r.firebaseId}')" style="width:100%;margin-top:10px;padding:8px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;">
                            ğŸš— Fahrer manuell zuweisen
                        </button>`;
                    }
                    
                    // Buttons fÃ¼r ALLE Fahrten
                    let actionButtons = '';
                    const rideIdForButtons = r.firebaseId || r.id || r.createdAt;
                    
                    if (r.status === 'abgeschlossen' || r.status === 'completed') {
                        // Abgeschlossene: Wiederholen + Umdrehen + Bearbeiten
                        actionButtons = `
                            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-top:10px;">
                                <button onclick="rebookRide(${r.createdAt || r.id})" 
                                    style="padding:8px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                    ğŸ” Nochmal
                                </button>
                                <button onclick="reverseRouteFromHistory(${r.createdAt || r.id})" 
                                    style="padding:8px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                    ğŸ”„ Umdrehen
                                </button>
                                <button onclick="editRide('${rideIdForButtons}')" 
                                    style="padding:8px;background:#f59e0b;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                    âœï¸ Bearbeiten
                                </button>
                            </div>
                        `;
                    } else if (r.status === 'storniert') {
                        // Stornierte: Wiederholen + Umdrehen + Bearbeiten
                        actionButtons = `
                            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-top:10px;">
                                <button onclick="rebookRide(${r.createdAt || r.id})" 
                                    style="padding:8px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                    ğŸ” Nochmal
                                </button>
                                <button onclick="reverseRouteFromHistory(${r.createdAt || r.id})" 
                                    style="padding:8px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                    ğŸ”„ Umdrehen
                                </button>
                                <button onclick="editRide('${rideIdForButtons}')" 
                                    style="padding:8px;background:#f59e0b;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
                                    âœï¸ Bearbeiten
                                </button>
                            </div>
                        `;
                    } else {
                        // Andere Status: Nur Bearbeiten + Umdrehen (wenn nicht aktiv unterwegs)
                        if (r.status !== 'unterwegs' && r.status !== 'akzeptiert' && r.status !== 'picked_up') {
                            actionButtons = `
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;">
                                    <button onclick="editRide('${rideIdForButtons}')" 
                                        style="padding:8px;background:#f59e0b;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;">
                                        âœï¸ Bearbeiten
                                    </button>
                                    <button onclick="reverseRouteAdmin('${rideIdForButtons}')" 
                                        style="padding:8px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;">
                                        ğŸ”„ Umdrehen
                                    </button>
                                </div>
                            `;
                        }
                    }
                    
                    return `<div class="ride-card">
                        <strong>#${r.id}</strong> <span style="background:${statusColor};padding:4px 8px;border-radius:12px;font-size:12px;">${statusText}</span>
                        ${r.customerName ? '<div style="margin-top:8px;font-weight:600;">ğŸ‘¤ '+r.customerName+'</div>' : ''}
                        <div style="margin-top:10px;font-size:14px;">
                            ğŸ• ${pickupTimeDisplay}<br>
                            ğŸ“ Von: ${r.pickup}<br>
                            ğŸ¯ Nach: ${r.destination}<br>
                            ğŸ“ ${r.distance} km<br>
                            ğŸ’° Preis: ${r.price}â‚¬
                            ${r.vehicle ? '<br>ğŸš— Fahrzeug: '+r.vehicle : ''}
                            ${r.vehiclePlate ? ' ('+r.vehiclePlate+')' : ''}
                        </div>
                        ${assignButton}
                        ${actionButtons}
                    </div>`;
                }).join('');
            }
            
            // ğŸš— Update Online-Fahrer Liste
            updateOnlineDriversList();
        }
        
        // ğŸš— ONLINE-FAHRER ANZEIGEN
        function updateOnlineDriversList() {
            const driversList = document.getElementById('online-drivers-list');
            if (!driversList) return;
            
            const now = Date.now();
            const onlineDrivers = [];
            
            // Durchsuche alle Fahrer
            Object.keys(drivers).forEach(vehicleId => {
                const driver = drivers[vehicleId];
                
                // Fahrer ist online wenn: online = true UND letzte Aktualisierung < 2 Min
                if (driver && driver.online) {
                    const lastUpdate = driver.timestamp || 0;
                    const minutesSinceUpdate = (now - lastUpdate) / (1000 * 60);
                    
                    // Nur als online zeigen wenn letzte Meldung < 2 Min
                    if (minutesSinceUpdate < 2) {
                        const vehicle = VEHICLES[vehicleId] || { name: driver.vehicle || vehicleId, plate: '?' };
                        const hasGPS = driver.lat && driver.lng;
                        const gpsAccuracy = driver.accuracy ? Math.round(driver.accuracy) : '?';
                        
                        onlineDrivers.push({
                            vehicleId: vehicleId,
                            vehicle: vehicle,
                            driver: driver,
                            hasGPS: hasGPS,
                            accuracy: gpsAccuracy,
                            lastUpdate: lastUpdate,
                            minutesSinceUpdate: Math.floor(minutesSinceUpdate)
                        });
                    }
                }
            });
            
            if (onlineDrivers.length === 0) {
                driversList.innerHTML = `
                    <div style="background:white;padding:20px;border-radius:8px;text-align:center;color:#999;">
                        ğŸ˜´ Keine Fahrer online
                    </div>
                `;
                return;
            }
            
            // Sortiere nach letztem Update (neueste zuerst)
            onlineDrivers.sort((a, b) => b.lastUpdate - a.lastUpdate);
            
            driversList.innerHTML = onlineDrivers.map(d => {
                const gpsStatus = d.hasGPS ? 'âœ… GPS aktiv' : 'âŒ Kein GPS';
                const gpsColor = d.hasGPS ? '#10b981' : '#ef4444';
                const updateText = d.minutesSinceUpdate === 0 ? 'Gerade eben' : `vor ${d.minutesSinceUpdate} Min`;
                
                return `
                    <div style="background:white;padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid ${gpsColor};">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <div style="font-weight:600;font-size:15px;">
                                    ğŸš— ${d.vehicle.name}
                                </div>
                                <div style="font-size:12px;color:#666;margin-top:4px;">
                                    ${d.vehicle.plate}
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div style="color:${gpsColor};font-weight:600;font-size:13px;">
                                    ${gpsStatus}
                                </div>
                                ${d.hasGPS ? `<div style="font-size:11px;color:#999;">Â±${d.accuracy}m</div>` : ''}
                                <div style="font-size:11px;color:#999;margin-top:4px;">
                                    ${updateText}
                                </div>
                            </div>
                        </div>
                        ${d.hasGPS ? `
                            <div style="margin-top:10px;font-size:12px;color:#666;">
                                ğŸ“ ${d.driver.lat.toFixed(5)}, ${d.driver.lng.toFixed(5)}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // ğŸš— MANUELLE FAHRER-ZUWEISUNG
        function manuallyAssignRide(rideId) {
            const ride = rides.find(r => r.firebaseId === rideId);
            if (!ride) {
                alert('âŒ Fahrt nicht gefunden!');
                return;
            }
            
            // Fahrzeug-Auswahl
            const vehicleOptions = Object.keys(VEHICLES).map(key => {
                const v = VEHICLES[key];
                return `<option value="${key}">${v.name} (${v.plate})</option>`;
            }).join('');
            
            const html = `
                <div style="background:white;padding:20px;border-radius:12px;">
                    <h3>ğŸš— Fahrer zuweisen</h3>
                    <div style="margin:15px 0;padding:15px;background:#f0f9ff;border-radius:8px;">
                        <strong>Fahrt #${ride.id}</strong><br>
                        ğŸ“ ${ride.pickup}<br>
                        ğŸ¯ ${ride.destination}<br>
                        ğŸ’° ${ride.price}â‚¬
                    </div>
                    <label style="display:block;margin:10px 0;">Fahrzeug wÃ¤hlen:</label>
                    <select id="manual-vehicle-select" style="width:100%;padding:12px;border:2px solid #667eea;border-radius:8px;font-size:14px;">
                        <option value="">-- Fahrzeug wÃ¤hlen --</option>
                        ${vehicleOptions}
                    </select>
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button onclick="confirmManualAssignment('${rideId}')" style="flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;">
                            âœ“ Zuweisen
                        </button>
                        <button onclick="closeManualAssignment()" style="flex:1;padding:12px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;">
                            âœ• Abbrechen
                        </button>
                    </div>
                </div>
            `;
            
            // Modal anzeigen
            const modal = document.createElement('div');
            modal.id = 'manual-assign-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
            modal.innerHTML = html;
            document.body.appendChild(modal);
        }
        
        async function confirmManualAssignment(rideId) {
            const vehicleId = document.getElementById('manual-vehicle-select').value;
            if (!vehicleId) {
                alert('âŒ Bitte wÃ¤hle ein Fahrzeug!');
                return;
            }
            
            const vehicle = VEHICLES[vehicleId];
            const ride = rides.find(r => r.firebaseId === rideId);
            
            if (!ride) {
                alert('âŒ Fahrt nicht gefunden!');
                return;
            }
            
            // Fahrt zuweisen
            await updateRide(rideId, {
                status: 'accepted',
                vehicleId: vehicleId,
                vehicle: vehicle.name,
                vehiclePlate: vehicle.plate,
                acceptedAt: Date.now(),
                adminConfirmed: true  // ğŸ†• Markiere als bestÃ¤tigt
            });
            
            // Markiere als acknowledged
            acknowledgedRides.add(ride.id);
            saveAcknowledgedRides();
            
            closeManualAssignment();
            alert(`âœ… Fahrt #${ride.id} wurde ${vehicle.name} zugewiesen!`);
        }
        
        function closeManualAssignment() {
            const modal = document.getElementById('manual-assign-modal');
            if (modal) modal.remove();
        }

        // ğŸ†• v5.31.0: EINDEUTIGE RIDE-ID GENERATOR
        function generateRideId() {
            // Format: ride_TIMESTAMP_RANDOM
            // Beispiel: ride_1733047234567_k3n9x2m4p
            const timestamp = Date.now();
            const random = Math.random().toString(36).substr(2, 9);
            const rideId = `ride_${timestamp}_${random}`;
            console.log('ğŸ†” Neue Ride-ID generiert:', rideId);
            return rideId;
        }

        // DATABASE FUNCTIONS
        
        // ğŸ” v5.31.3: RIDE-ID SUCHE
        async function searchRideById() {
            const input = document.getElementById('ride-id-search');
            const searchId = input.value.trim();
            
            if (!searchId) {
                alert('âŒ Bitte eine Ride-ID eingeben!');
                return;
            }
            
            console.log('ğŸ” Suche nach Ride-ID:', searchId);
            
            // Suche in allen Quellen
            let foundRide = null;
            
            // 1. Suche in Firebase (aktuelle rides)
            foundRide = rides.find(r => 
                r.id === searchId || 
                r.firebaseId === searchId ||
                (r.id && r.id.toString() === searchId) ||
                (r.firebaseId && r.firebaseId.toString() === searchId)
            );
            
            // 2. Falls nicht gefunden, suche in Firebase direkt
            if (!foundRide && isFirebaseReady) {
                try {
                    const snapshot = await db.ref('rides/' + searchId).once('value');
                    if (snapshot.exists()) {
                        foundRide = snapshot.val();
                        foundRide.firebaseId = searchId;
                        console.log('âœ… Fahrt in Firebase gefunden:', searchId);
                    }
                } catch (error) {
                    console.error('âŒ Firebase Suche Fehler:', error);
                }
            }
            
            // 3. Falls immer noch nicht gefunden, suche in localStorage
            if (!foundRide) {
                const localHistory = JSON.parse(localStorage.getItem('rideHistory') || '[]');
                foundRide = localHistory.find(r => 
                    r.id === searchId || 
                    r.firebaseId === searchId ||
                    (r.id && r.id.toString() === searchId) ||
                    (r.firebaseId && r.firebaseId.toString() === searchId)
                );
                if (foundRide) {
                    console.log('âœ… Fahrt in localStorage gefunden:', searchId);
                }
            }
            
            // Ergebnis anzeigen
            if (foundRide) {
                console.log('âœ… Fahrt gefunden:', foundRide);
                showRideDetailsModal(foundRide);
                input.value = ''; // Input leeren
            } else {
                alert(`âŒ Keine Fahrt gefunden mit ID:\n\n${searchId}\n\nğŸ’¡ PrÃ¼fe ob die ID korrekt ist.`);
            }
        }
        
        // ğŸ†• v5.31.3: FAHRT-DETAILS MODAL
        function showRideDetailsModal(ride) {
            // Entferne altes Modal falls vorhanden
            const oldModal = document.getElementById('ride-details-modal');
            if (oldModal) oldModal.remove();
            
            // Formatiere Zeitstempel
            const createdTime = ride.createdAt ? new Date(ride.createdAt).toLocaleString('de-DE') : 'Unbekannt';
            const pickupTime = ride.pickupTimestamp ? new Date(ride.pickupTimestamp).toLocaleString('de-DE') : ride.pickupTime || 'Sofort';
            
            // Status formatieren
            const statusColors = {
                'new': '#3b82f6',
                'vorbestellt': '#f59e0b',
                'accepted': '#10b981',
                'picked_up': '#8b5cf6',
                'completed': '#10b981',
                'storniert': '#ef4444',
                'cancelled': '#ef4444'
            };
            const statusColor = statusColors[ride.status] || '#6b7280';
            
            const statusNames = {
                'new': 'ğŸ†• Neu',
                'vorbestellt': 'ğŸ“… Vorbestellt',
                'accepted': 'âœ… Angenommen',
                'picked_up': 'ğŸš— Unterwegs',
                'completed': 'âœ… Abgeschlossen',
                'storniert': 'ğŸ—‘ï¸ Storniert',
                'cancelled': 'ğŸ—‘ï¸ Storniert'
            };
            const statusName = statusNames[ride.status] || ride.status;
            
            // Modal erstellen
            const modal = document.createElement('div');
            modal.id = 'ride-details-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;';
            
            modal.innerHTML = `
                <div style="background:white;border-radius:16px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                    <!-- Header -->
                    <div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;border-radius:16px 16px 0 0;">
                        <div style="display:flex;justify-content:space-between;align-items:start;">
                            <div>
                                <div style="font-size:24px;margin-bottom:5px;">ğŸ“‹</div>
                                <h3 style="margin:0;font-size:18px;">Fahrt-Details</h3>
                            </div>
                            <button onclick="this.closest('#ride-details-modal').remove()" style="background:rgba(255,255,255,0.2);border:none;color:white;font-size:24px;width:32px;height:32px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;">Ã—</button>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div style="padding:20px;">
                        <!-- Ride-ID -->
                        <div style="background:#f9fafb;padding:15px;border-radius:12px;margin-bottom:20px;border:2px solid #e5e7eb;">
                            <div style="font-size:12px;font-weight:600;color:#6b7280;margin-bottom:5px;">RIDE-ID</div>
                            <div style="font-family:monospace;font-size:14px;font-weight:600;color:#1f2937;word-break:break-all;">
                                ${ride.firebaseId || ride.id || 'unbekannt'}
                            </div>
                        </div>
                        
                        <!-- Status Badge -->
                        <div style="display:inline-block;background:${statusColor};color:white;padding:8px 16px;border-radius:20px;font-weight:600;font-size:14px;margin-bottom:20px;">
                            ${statusName}
                        </div>
                        
                        <!-- Kunde -->
                        <div style="margin-bottom:15px;">
                            <div style="font-size:12px;font-weight:600;color:#6b7280;margin-bottom:5px;">KUNDE</div>
                            <div style="font-size:16px;font-weight:600;color:#1f2937;">ğŸ‘¤ ${ride.customerName || 'Unbekannt'}</div>
                            <div style="font-size:14px;color:#6b7280;margin-top:3px;">ğŸ“ ${ride.customerPhone || 'Keine Nummer'}</div>
                        </div>
                        
                        <!-- Route -->
                        <div style="margin-bottom:15px;">
                            <div style="font-size:12px;font-weight:600;color:#6b7280;margin-bottom:5px;">ROUTE</div>
                            <div style="font-size:14px;color:#1f2937;line-height:1.6;">
                                <div>ğŸ“ <strong>Von:</strong> ${ride.pickup || 'Unbekannt'}</div>
                                <div>ğŸ¯ <strong>Nach:</strong> ${ride.destination || 'Unbekannt'}</div>
                            </div>
                        </div>
                        
                        <!-- Fahrzeug (falls zugewiesen) -->
                        ${ride.vehicle ? `
                        <div style="margin-bottom:15px;">
                            <div style="font-size:12px;font-weight:600;color:#6b7280;margin-bottom:5px;">FAHRZEUG</div>
                            <div style="font-size:14px;color:#1f2937;">
                                ğŸš— ${ride.vehicle}${ride.vehiclePlate ? ` (${ride.vehiclePlate})` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Preis & Details -->
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px;">
                            <div>
                                <div style="font-size:12px;font-weight:600;color:#6b7280;margin-bottom:5px;">PREIS</div>
                                <div style="font-size:18px;font-weight:700;color:#10b981;">
                                    ${ride.price ? ride.price + 'â‚¬' : 'N/A'}
                                </div>
                            </div>
                            <div>
                                <div style="font-size:12px;font-weight:600;color:#6b7280;margin-bottom:5px;">DISTANZ</div>
                                <div style="font-size:14px;font-weight:600;color:#1f2937;">
                                    ${ride.distance ? ride.distance + ' km' : 'N/A'}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Zeiten -->
                        <div style="margin-bottom:15px;">
                            <div style="font-size:12px;font-weight:600;color:#6b7280;margin-bottom:5px;">ZEITEN</div>
                            <div style="font-size:13px;color:#6b7280;line-height:1.8;">
                                <div>ğŸ“… <strong>Erstellt:</strong> ${createdTime}</div>
                                <div>ğŸ• <strong>Abholung:</strong> ${pickupTime}</div>
                            </div>
                        </div>
                        
                        <!-- Zahlungsmethode -->
                        ${ride.paymentMethod ? `
                        <div style="margin-bottom:15px;">
                            <div style="font-size:12px;font-weight:600;color:#6b7280;margin-bottom:5px;">ZAHLUNG</div>
                            <div style="font-size:14px;color:#1f2937;">
                                ğŸ’³ ${ride.paymentMethod === 'bar' ? 'Bar' : ride.paymentMethod === 'karte' ? 'Karte' : ride.paymentMethod}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Buttons -->
                        <div style="margin-top:25px;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                            <button onclick="this.closest('#ride-details-modal').remove()" style="padding:12px;background:#e5e7eb;color:#1f2937;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                                SchlieÃŸen
                            </button>
                            ${ride.firebaseId ? `
                            <button onclick="navigator.clipboard.writeText('${ride.firebaseId || ride.id}');alert('âœ… ID kopiert!');" style="padding:12px;background:#667eea;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                                ğŸ“‹ ID kopieren
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        async function saveRide(ride) {
            // ğŸ†• v5.31.0: Nutze EINDEUTIGE ID statt push()
            // Wenn noch keine ID â†’ generiere eine
            if (!ride.id) {
                ride.id = generateRideId();
            }
            
            // ğŸ” FÃ¼ge userId hinzu (fÃ¼r Firebase Query)
            if (currentUser) {
                ride.userId = currentUser.uid;
            }
            
            // ğŸ”¥ Speichere in Firebase
            if (isFirebaseReady) {
                try {
                    // ğŸ†• v5.31.0: Nutze set() mit fester ID statt push()!
                    // ride.id und ride.firebaseId sind jetzt IDENTISCH!
                    ride.firebaseId = ride.id;
                    await db.ref('rides/' + ride.id).set(ride);
                    
                    console.log('âœ… Fahrt gespeichert mit ID:', ride.id);
                    
                    // ğŸ“± TELEGRAM wird in book() gesendet, NICHT hier!
                    // (Sonst Duplikate weil book() auch sendet)
                } catch (error) {
                    console.error('âŒ Fehler beim Speichern:', error);
                    // ğŸ“œ PROTOKOLL: Buchung fehlgeschlagen
                    logActivity('system', 'booking_error', `Buchung fehlgeschlagen: ${error.message}`, {
                        customer: ride.customerName,
                        from: ride.pickup,
                        to: ride.destination
                    });
                    throw error; // Weitergeben damit book() es behandeln kann
                }
            }
            
            // ğŸ’¾ Speichere auch in localStorage (fÃ¼r Offline-Support & schnellen Zugriff)
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            history.push(ride);
            localStorage.setItem('rideHistory', JSON.stringify(history));
            
            return ride;
        }

        async function updateRide(id, updates) {
            if (isFirebaseReady) {
                // Hole KOMPLETTE alte Fahrt-Daten
                const snapshot = await db.ref('rides/' + id).once('value');
                const oldRide = snapshot.val();
                const oldStatus = oldRide ? oldRide.status : null;
                
                // Update Firebase
                await db.ref('rides/' + id).update(updates);
                
                // PrÃ¼fe ob Status geÃ¤ndert wurde
                if (updates.status && updates.status !== oldStatus && oldRide) {
                    // ğŸ¯ WICHTIG: Nutze die ALTEN Daten + neuen Status
                    // So haben wir ALLE Fahrtdaten fÃ¼r Telegram!
                    const rideForTelegram = {
                        ...oldRide,  // Alle alten Daten
                        status: updates.status,  // Neuer Status
                        firebaseId: id
                    };
                    
                    // Sende Telegram-Benachrichtigung mit vollstÃ¤ndigen Daten
                    await sendTelegramStatusUpdate(rideForTelegram, oldStatus, updates.status);
                }
            }
        }

        // GEOCODING & ROUTING
        async function geocode(address) {
            // Zuerst in bekannten Orten suchen
            const searchKey = address.toLowerCase().trim();
            if (KNOWN_PLACES[searchKey]) {
                console.log('âœ… Ort aus Cache:', KNOWN_PLACES[searchKey].name);
                return KNOWN_PLACES[searchKey];
            }
            
            // Dann via API suchen
            try {
                // Versuche zuerst mit Usedom, Deutschland
                let response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Usedom, Deutschland')}&limit=1`);
                let data = await response.json();
                
                // Wenn nichts gefunden, versuche nur mit Deutschland
                if (data.length === 0) {
                    response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Deutschland')}&limit=1`);
                    data = await response.json();
                }
                
                // Wenn immer noch nichts, versuche ohne Zusatz
                if (data.length === 0) {
                    response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
                    data = await response.json();
                }
                
                if (data.length > 0) {
                    console.log('âœ… Ort gefunden:', address, 'â†’', data[0].display_name);
                    return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
                } else {
                    console.warn('âš ï¸ Ort nicht gefunden:', address);
                }
            } catch (e) { 
                console.error('âŒ Geocoding Fehler:', e); 
            }
            return null;
        }

        async function calculateRoute(from, to) {
            try {
                // overview=full gibt die komplette Route-Geometry zurÃ¼ck!
                const response = await fetch(`https://router.project-osrm.org/route/v1/driving/${from.lon},${from.lat};${to.lon},${to.lat}?overview=full&geometries=geojson`);
                const data = await response.json();
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    return { 
                        distance: (route.distance / 1000).toFixed(1), 
                        duration: Math.round(route.duration / 60),
                        geometry: route.geometry ? route.geometry.coordinates : null  // Route-Punkte!
                    };
                }
            } catch (e) { console.error(e); }
            return { distance: 0, duration: 0, geometry: null };
        }

        // ğŸ’° SURGE PRICING SETTINGS (Firebase-synchronisiert!)
        let pricingSettings = {
            autoSurgeEnabled: true,
            surgePerTaxi: 10,      // % pro aktivem Taxi
            manualMultiplier: 0    // Manueller +/- %
        };
        
        // Lade Pricing Settings aus Firebase
        function loadPricingSettings() {
            if (isFirebaseReady) {
                // Einmalig laden
                db.ref('settings/pricing').once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        pricingSettings = { ...pricingSettings, ...snapshot.val() };
                        console.log('ğŸ’° Pricing Settings aus Firebase geladen:', pricingSettings);
                    }
                    updatePricingUI();
                });
                
                // Live-Updates abonnieren
                db.ref('settings/pricing').on('value', snapshot => {
                    if (snapshot.exists()) {
                        pricingSettings = { ...pricingSettings, ...snapshot.val() };
                        console.log('ğŸ’° Pricing Settings aktualisiert:', pricingSettings);
                        updatePricingUI();
                    }
                });
            } else {
                // Fallback: localStorage
                const saved = localStorage.getItem('pricingSettings');
                if (saved) {
                    pricingSettings = JSON.parse(saved);
                }
                updatePricingUI();
            }
        }
        
        // Speichere Pricing Settings in Firebase
        function savePricingSettings() {
            pricingSettings.autoSurgeEnabled = document.getElementById('auto-surge-enabled')?.checked ?? true;
            pricingSettings.surgePerTaxi = parseInt(document.getElementById('surge-per-taxi')?.value ?? 10);
            
            if (isFirebaseReady) {
                db.ref('settings/pricing').update({
                    autoSurgeEnabled: pricingSettings.autoSurgeEnabled,
                    surgePerTaxi: pricingSettings.surgePerTaxi
                });
            }
            localStorage.setItem('pricingSettings', JSON.stringify(pricingSettings));
            updatePricingUI();
            console.log('ğŸ’° Pricing Settings gespeichert:', pricingSettings);
        }
        
        // Manuellen Multiplikator setzen (in Firebase!)
        function setManualMultiplier(value) {
            pricingSettings.manualMultiplier = value;
            
            if (isFirebaseReady) {
                db.ref('settings/pricing').update({
                    manualMultiplier: value
                });
            }
            localStorage.setItem('pricingSettings', JSON.stringify(pricingSettings));
            
            // Button-Styling aktualisieren
            document.querySelectorAll('.multiplier-btn').forEach(btn => {
                const btnValue = parseInt(btn.dataset.value);
                if (btnValue === value) {
                    btn.style.border = '2px solid #667eea';
                    btn.style.background = '#667eea';
                    btn.style.color = 'white';
                } else {
                    btn.style.border = '2px solid #e5e7eb';
                    btn.style.background = 'white';
                    btn.style.color = btnValue < 0 ? '#10b981' : (btnValue > 0 ? '#ef4444' : '#333');
                }
            });
            
            updatePricingUI();
            console.log('ğŸ’° Manueller Multiplikator:', value + '%');
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.38.2: BUCHUNGSSYSTEM ON/OFF
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Lade Buchungssystem-Status aus Firebase
        function loadBookingSystemStatus() {
            if (isFirebaseReady) {
                // Einmalig laden
                db.ref('settings/bookingSystemOnline').once('value').then(snapshot => {
                    bookingSystemOnline = snapshot.exists() ? snapshot.val() : true;
                    console.log('ğŸ”´ Buchungssystem-Status geladen:', bookingSystemOnline ? 'ONLINE' : 'OFFLINE');
                    updateBookingSystemUI();
                    updateBookingButton(); // Update Fahrgast-Button
                });
                
                // Live-Updates abonnieren
                db.ref('settings/bookingSystemOnline').on('value', snapshot => {
                    bookingSystemOnline = snapshot.exists() ? snapshot.val() : true;
                    console.log('ğŸ”´ Buchungssystem-Status aktualisiert:', bookingSystemOnline ? 'ONLINE' : 'OFFLINE');
                    updateBookingSystemUI();
                    updateBookingButton(); // Update Fahrgast-Button
                });
            } else {
                // Fallback: localStorage
                const saved = localStorage.getItem('bookingSystemOnline');
                bookingSystemOnline = saved !== null ? (saved === 'true') : true;
                updateBookingSystemUI();
                updateBookingButton();
            }
        }
        
        // Setze Buchungssystem ON/OFF
        function setBookingSystem(online) {
            bookingSystemOnline = online;
            
            if (isFirebaseReady) {
                db.ref('settings/bookingSystemOnline').set(online);
                console.log('ğŸ”´ Buchungssystem in Firebase gespeichert:', online ? 'ONLINE' : 'OFFLINE');
            }
            localStorage.setItem('bookingSystemOnline', online.toString());
            
            updateBookingSystemUI();
            updateBookingButton();
            
            // Admin-Feedback
            alert(online ? 'âœ… Buchungssystem ist jetzt ONLINE!\n\nFahrgÃ¤ste kÃ¶nnen wieder buchen.' : 'ğŸ”´ Buchungssystem ist jetzt OFFLINE!\n\nFahrgÃ¤ste kÃ¶nnen nur noch anrufen.');
        }
        
        // Update Admin-UI
        function updateBookingSystemUI() {
            const statusBox = document.getElementById('booking-system-status');
            const statusText = document.getElementById('booking-status-text');
            const btnOn = document.getElementById('btn-booking-on');
            const btnOff = document.getElementById('btn-booking-off');
            
            if (bookingSystemOnline) {
                // ONLINE
                if (statusBox) statusBox.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                if (statusText) {
                    statusText.textContent = 'ğŸŸ¢ ONLINE';
                    statusText.parentElement.querySelector('div:last-child').textContent = 'Buchungen werden angenommen';
                }
                if (btnOn) {
                    btnOn.style.border = '3px solid #10b981';
                    btnOn.style.background = '#10b981';
                    btnOn.style.color = 'white';
                }
                if (btnOff) {
                    btnOff.style.border = '3px solid #e5e7eb';
                    btnOff.style.background = 'white';
                    btnOff.style.color = '#666';
                }
            } else {
                // OFFLINE
                if (statusBox) statusBox.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                if (statusText) {
                    statusText.textContent = 'ğŸ”´ OFFLINE';
                    statusText.parentElement.querySelector('div:last-child').textContent = 'Nur Anrufen mÃ¶glich';
                }
                if (btnOff) {
                    btnOff.style.border = '3px solid #ef4444';
                    btnOff.style.background = '#ef4444';
                    btnOff.style.color = 'white';
                }
                if (btnOn) {
                    btnOn.style.border = '3px solid #e5e7eb';
                    btnOn.style.background = 'white';
                    btnOn.style.color = '#666';
                }
            }
        }
        
        // Update Fahrgast-Buchungs-Button
        function updateBookingButton() {
            const bookingForm = document.getElementById('booking-form');
            const offlineMessage = document.getElementById('offline-message');
            
            if (bookingSystemOnline) {
                // ONLINE: Button zeigen
                if (bookingForm) bookingForm.style.display = 'block';
                if (offlineMessage) offlineMessage.style.display = 'none';
            } else {
                // OFFLINE: Button verstecken, Anruf-Info zeigen
                if (bookingForm) bookingForm.style.display = 'none';
                if (offlineMessage) offlineMessage.style.display = 'block';
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.26.14: Ã–PNV-TAXI SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Ã–PNV-Einstellungen laden
        function loadOEPNVSettings() {
            const settings = JSON.parse(localStorage.getItem('oepnvSettings') || '{}');
            
            // Defaults
            const defaults = {
                enabled: false,
                surcharge: 2.00,
                tariffs: {
                    kurz: { km: 3, erw: 2.00, kind: 1.50 },
                    normal: { km: 7, erw: 3.00, kind: 2.00 },
                    lang: { km: 15, erw: 4.50, kind: 3.00 },
                    insel: { erw: 6.00, kind: 4.00 }
                },
                community: {
                    name: 'Gemeinde Heringsdorf',
                    email: ''
                },
                belegOptions: {
                    qr: true,
                    app: true,
                    pdf: true
                },
                // ğŸ†• v5.28.0: Anti-Betrugs-Defaults
                antiFraud: {
                    enabled: false,
                    mode: 'warn'
                }
            };
            
            const merged = { ...defaults, ...settings };
            // Ensure antiFraud object exists
            if (!merged.antiFraud) {
                merged.antiFraud = defaults.antiFraud;
            }
            
            // UI befÃ¼llen
            document.getElementById('oepnv-enabled').checked = merged.enabled;
            document.getElementById('oepnv-surcharge').value = merged.surcharge;
            
            document.getElementById('tarif-kurz-km').value = merged.tariffs.kurz.km;
            document.getElementById('tarif-kurz-erw').value = merged.tariffs.kurz.erw;
            document.getElementById('tarif-kurz-kind').value = merged.tariffs.kurz.kind;
            
            document.getElementById('tarif-normal-km').value = merged.tariffs.normal.km;
            document.getElementById('tarif-normal-erw').value = merged.tariffs.normal.erw;
            document.getElementById('tarif-normal-kind').value = merged.tariffs.normal.kind;
            
            document.getElementById('tarif-lang-km').value = merged.tariffs.lang.km;
            document.getElementById('tarif-lang-erw').value = merged.tariffs.lang.erw;
            document.getElementById('tarif-lang-kind').value = merged.tariffs.lang.kind;
            
            document.getElementById('tarif-insel-erw').value = merged.tariffs.insel.erw;
            document.getElementById('tarif-insel-kind').value = merged.tariffs.insel.kind;
            
            document.getElementById('oepnv-community-name').value = merged.community.name;
            document.getElementById('oepnv-community-email').value = merged.community.email;
            
            document.getElementById('oepnv-beleg-qr').checked = merged.belegOptions.qr;
            document.getElementById('oepnv-beleg-app').checked = merged.belegOptions.app;
            document.getElementById('oepnv-beleg-pdf').checked = merged.belegOptions.pdf;
            
            // ğŸ†• v5.28.0: Anti-Betrugs UI laden
            document.getElementById('oepnv-antifraud-enabled').checked = merged.antiFraud.enabled;
            const modeRadios = document.querySelectorAll('input[name="antifraud-mode"]');
            modeRadios.forEach(radio => {
                if (radio.value === merged.antiFraud.mode) {
                    radio.checked = true;
                }
            });
            
            // Settings anzeigen/verstecken
            document.getElementById('oepnv-settings').style.display = merged.enabled ? 'block' : 'none';
            
            // ğŸ†• v5.28.0: Anti-Betrugs UI anzeigen/verstecken
            document.getElementById('antifraud-mode-section').style.display = merged.antiFraud.enabled ? 'block' : 'none';
            document.getElementById('antifraud-criteria').style.display = merged.antiFraud.enabled ? 'block' : 'none';
            
            // In globale Variable speichern
            window.oepnvSettings = merged;
            
            console.log('ğŸš Ã–PNV-Settings geladen:', merged);
        }
        
        // Ã–PNV-Einstellungen speichern
        function saveOEPNVSettings() {
            const enabled = document.getElementById('oepnv-enabled').checked;
            
            // ğŸ†• v5.28.0: Anti-Betrugs-System
            const antiFraudEnabled = document.getElementById('oepnv-antifraud-enabled').checked;
            const antiFraudMode = document.querySelector('input[name="antifraud-mode"]:checked')?.value || 'warn';
            
            const settings = {
                enabled: enabled,
                surcharge: parseFloat(document.getElementById('oepnv-surcharge').value),
                tariffs: {
                    kurz: {
                        km: parseInt(document.getElementById('tarif-kurz-km').value),
                        erw: parseFloat(document.getElementById('tarif-kurz-erw').value),
                        kind: parseFloat(document.getElementById('tarif-kurz-kind').value)
                    },
                    normal: {
                        km: parseInt(document.getElementById('tarif-normal-km').value),
                        erw: parseFloat(document.getElementById('tarif-normal-erw').value),
                        kind: parseFloat(document.getElementById('tarif-normal-kind').value)
                    },
                    lang: {
                        km: parseInt(document.getElementById('tarif-lang-km').value),
                        erw: parseFloat(document.getElementById('tarif-lang-erw').value),
                        kind: parseFloat(document.getElementById('tarif-lang-kind').value)
                    },
                    insel: {
                        erw: parseFloat(document.getElementById('tarif-insel-erw').value),
                        kind: parseFloat(document.getElementById('tarif-insel-kind').value)
                    }
                },
                community: {
                    name: document.getElementById('oepnv-community-name').value,
                    email: document.getElementById('oepnv-community-email').value
                },
                belegOptions: {
                    qr: document.getElementById('oepnv-beleg-qr').checked,
                    app: document.getElementById('oepnv-beleg-app').checked,
                    pdf: document.getElementById('oepnv-beleg-pdf').checked
                },
                // ğŸ†• v5.28.0: Anti-Betrugs-Settings
                antiFraud: {
                    enabled: antiFraudEnabled,
                    mode: antiFraudMode
                }
            };
            
            // Speichern
            localStorage.setItem('oepnvSettings', JSON.stringify(settings));
            
            // Firebase
            if (isFirebaseReady) {
                db.ref('settings/oepnv').set(settings);
            }
            
            // Settings anzeigen/verstecken
            document.getElementById('oepnv-settings').style.display = enabled ? 'block' : 'none';
            
            // ğŸ†• v5.28.0: Anti-Betrugs UI anzeigen/verstecken
            document.getElementById('antifraud-mode-section').style.display = antiFraudEnabled ? 'block' : 'none';
            document.getElementById('antifraud-criteria').style.display = antiFraudEnabled ? 'block' : 'none';
            
            // Global speichern
            window.oepnvSettings = settings;
            
            console.log('ğŸš Ã–PNV-Settings gespeichert:', settings);
            
            // ğŸ†• v5.28.0: Info Ã¼ber Anti-Betrugs-Status
            if (antiFraudEnabled) {
                console.log('ğŸš¨ Anti-Betrugs-System:', antiFraudMode === 'warn' ? 'NUR WARNEN' : 'BLOCKIEREN');
            }
            
            alert('âœ… Ã–PNV-Einstellungen gespeichert!' + 
                  (antiFraudEnabled ? '\n\nğŸš¨ Anti-Betrugs-System: ' + (antiFraudMode === 'warn' ? 'Nur Warnen' : 'Blockieren') : ''));
        }
        
        // Berechne Busticket-Preis basierend auf km und Personen
        function calculateBusticket(km, adults, children) {
            if (!window.oepnvSettings) {
                loadOEPNVSettings();
            }
            
            const tariffs = window.oepnvSettings.tariffs;
            let tarif, tarifName;
            
            // Bestimme Tarifstufe
            if (km <= tariffs.kurz.km) {
                tarif = tariffs.kurz;
                tarifName = 'Kurzstrecke';
            } else if (km <= tariffs.normal.km) {
                tarif = tariffs.normal;
                tarifName = 'Normalstrecke';
            } else if (km <= tariffs.lang.km) {
                tarif = tariffs.lang;
                tarifName = 'LÃ¤ngere Strecke';
            } else {
                tarif = tariffs.insel;
                tarifName = 'Insel-Ticket';
            }
            
            // Berechne Ticketpreis
            const adultPrice = adults * tarif.erw;
            const childPrice = children * tarif.kind;
            const busticket = adultPrice + childPrice;
            
            return {
                busticket: busticket,
                adultPrice: adultPrice,
                childPrice: childPrice,
                tarif: tarifName,
                tarifDetails: tarif
            };
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.28.0: ANTI-BETRUGS-SYSTEM - DUPLIKATS-ERKENNUNG
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // PrÃ¼fe ob Ã–PNV-Fahrt Duplikat ist (Mehrfach-Abrechnung)
        function checkOEPNVDuplicate(newRide) {
            // Nur wenn Anti-Betrugs-System aktiviert
            if (!window.oepnvSettings?.antiFraud?.enabled) {
                return { isDuplicate: false, duplicates: [] };
            }
            
            console.log('ğŸš¨ PrÃ¼fe auf Duplikate:', newRide);
            
            // Hole alle Ã–PNV-Fahrten der letzten 10 Minuten
            const now = Date.now();
            const tenMinutesAgo = now - (10 * 60 * 1000);
            
            // Suche in rides-Objekt (alle aktiven/letzten Fahrten)
            const recentOepnvRides = Object.values(rides).filter(r => 
                r.isOEPNV && 
                r.timestamp >= tenMinutesAgo &&
                r.id !== newRide.id // Nicht sich selbst
            );
            
            console.log('ğŸ” Gefundene Ã–PNV-Fahrten (10 Min):', recentOepnvRides.length);
            
            // Suche Duplikate
            const duplicates = recentOepnvRides.filter(existingRide => {
                const timeDiff = Math.abs(newRide.timestamp - existingRide.timestamp);
                const fiveMinutes = 5 * 60 * 1000;
                
                const sameDriver = existingRide.driverId === newRide.driverId;
                const samePickup = existingRide.pickup === newRide.pickup;
                const sameDestination = existingRide.destination === newRide.destination;
                const sameTime = timeDiff < fiveMinutes;
                
                console.log('  Vergleiche mit Fahrt:', existingRide.id, {
                    sameDriver,
                    samePickup,
                    sameDestination,
                    sameTime,
                    timeDiff: Math.round(timeDiff / 1000) + 's'
                });
                
                return sameDriver && samePickup && sameDestination && sameTime;
            });
            
            if (duplicates.length > 0) {
                console.log('ğŸš¨ DUPLIKAT ERKANNT!', duplicates);
                
                // Speichere Alarm fÃ¼r Admin-Dashboard
                saveAntiFraudAlert(newRide, duplicates);
            }
            
            return {
                isDuplicate: duplicates.length > 0,
                duplicates: duplicates
            };
        }
        
        // Speichere Anti-Betrugs-Alarm fÃ¼r Admin
        function saveAntiFraudAlert(newRide, duplicates) {
            const alert = {
                id: 'af-' + Date.now(),
                timestamp: Date.now(),
                newRide: {
                    id: newRide.id,
                    pickup: newRide.pickup,
                    destination: newRide.destination,
                    driverId: newRide.driverId,
                    customerName: newRide.customerName
                },
                duplicates: duplicates.map(d => ({
                    id: d.id,
                    pickup: d.pickup,
                    destination: d.destination,
                    timestamp: d.timestamp
                })),
                resolved: false
            };
            
            // In localStorage speichern
            const alerts = JSON.parse(localStorage.getItem('antiFraudAlerts') || '[]');
            alerts.unshift(alert);
            // Nur letzte 50 behalten
            const trimmed = alerts.slice(0, 50);
            localStorage.setItem('antiFraudAlerts', JSON.stringify(trimmed));
            
            // Firebase
            if (isFirebaseReady) {
                db.ref('antiFraudAlerts/' + alert.id).set(alert);
            }
            
            console.log('ğŸš¨ Anti-Betrugs-Alarm gespeichert:', alert);
            
            // Badge-Update im Admin-Dashboard
            updateAntiFraudBadge();
        }
        
        // Update Badge-Anzahl fÃ¼r Anti-Betrugs-Alarme
        function updateAntiFraudBadge() {
            const alerts = JSON.parse(localStorage.getItem('antiFraudAlerts') || '[]');
            const unresolved = alerts.filter(a => !a.resolved);
            
            const badge = document.getElementById('antifraud-alert-count');
            if (badge) {
                badge.textContent = unresolved.length;
                badge.parentElement.style.display = unresolved.length > 0 ? 'flex' : 'none';
            }
        }
        
        // Lade und zeige Anti-Betrugs-Alarme im Admin-Dashboard
        function loadAntiFraudAlerts() {
            const alerts = JSON.parse(localStorage.getItem('antiFraudAlerts') || '[]');
            console.log('ğŸš¨ Lade Anti-Betrugs-Alarme:', alerts.length);
            
            const container = document.getElementById('antifraud-alerts-list');
            
            if (alerts.length === 0) {
                container.innerHTML = '<div style="padding:20px;text-align:center;color:#999;">âœ… Keine Alarme vorhanden</div>';
                return;
            }
            
            // Sortiere nach Timestamp (neueste zuerst)
            alerts.sort((a, b) => b.timestamp - a.timestamp);
            
            let html = '';
            alerts.forEach(alert => {
                const date = new Date(alert.timestamp);
                const timeStr = date.toLocaleString('de-DE');
                
                html += `
                    <div style="padding:15px;border-bottom:1px solid #e5e7eb;${alert.resolved ? 'opacity:0.5;background:#f9fafb;' : ''}">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px;">
                            <div>
                                <div style="font-weight:600;font-size:14px;color:${alert.resolved ? '#6b7280' : '#dc2626'};">
                                    ${alert.resolved ? 'âœ…' : 'ğŸš¨'} ${alert.duplicates.length + 1} Fahrten verdÃ¤chtig
                                </div>
                                <div style="font-size:12px;color:#6b7280;">${timeStr}</div>
                            </div>
                            ${!alert.resolved ? `
                                <button onclick="resolveAlert('${alert.id}')" style="padding:6px 12px;background:#10b981;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;">
                                    âœ… Erledigt
                                </button>
                            ` : ''}
                        </div>
                        
                        <div style="background:#f9fafb;padding:10px;border-radius:6px;margin-bottom:8px;">
                            <div style="font-weight:600;font-size:13px;color:#1f2937;margin-bottom:4px;">ğŸ“ Route:</div>
                            <div style="font-size:12px;color:#4b5563;">
                                ${alert.newRide.pickup} â†’ ${alert.newRide.destination}
                            </div>
                        </div>
                        
                        <div style="font-size:12px;color:#6b7280;">
                            <strong>Fahrt ${alert.newRide.id}</strong> (${alert.newRide.customerName || 'Unbekannt'})<br>
                            ${alert.duplicates.length} Ã¤hnliche Fahrt${alert.duplicates.length > 1 ? 'en' : ''} zur gleichen Zeit erkannt!
                        </div>
                        
                        ${alert.duplicates.length > 0 ? `
                            <details style="margin-top:8px;">
                                <summary style="cursor:pointer;font-size:12px;color:#667eea;">ğŸ” Details anzeigen</summary>
                                <div style="margin-top:8px;padding:8px;background:white;border-radius:4px;font-size:11px;">
                                    ${alert.duplicates.map((d, i) => {
                                        const dupDate = new Date(d.timestamp);
                                        const timeDiff = Math.round((alert.timestamp - d.timestamp) / 1000 / 60);
                                        return `
                                            <div style="padding:6px 0;border-top:1px solid #e5e7eb;">
                                                <strong>Duplikat ${i+1}:</strong> Fahrt ${d.id}<br>
                                                Zeitdifferenz: ${timeDiff} Minuten
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </details>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
            updateAntiFraudBadge();
        }
        
        // Markiere Alarm als erledigt
        function resolveAlert(alertId) {
            const alerts = JSON.parse(localStorage.getItem('antiFraudAlerts') || '[]');
            const alert = alerts.find(a => a.id === alertId);
            
            if (alert) {
                alert.resolved = true;
                alert.resolvedAt = Date.now();
                
                localStorage.setItem('antiFraudAlerts', JSON.stringify(alerts));
                
                // Firebase
                if (isFirebaseReady) {
                    db.ref('antiFraudAlerts/' + alertId + '/resolved').set(true);
                    db.ref('antiFraudAlerts/' + alertId + '/resolvedAt').set(alert.resolvedAt);
                }
                
                console.log('âœ… Alarm erledigt:', alertId);
                loadAntiFraudAlerts();
            }
        }
        
        // LÃ¶sche erledigte Alarme
        function clearResolvedAlerts() {
            const confirmed = confirm('â“ Alle erledigten Alarme lÃ¶schen?');
            if (!confirmed) return;
            
            const alerts = JSON.parse(localStorage.getItem('antiFraudAlerts') || '[]');
            const unresolved = alerts.filter(a => !a.resolved);
            
            localStorage.setItem('antiFraudAlerts', JSON.stringify(unresolved));
            
            // Firebase: LÃ¶sche resolved
            if (isFirebaseReady) {
                alerts.filter(a => a.resolved).forEach(a => {
                    db.ref('antiFraudAlerts/' + a.id).remove();
                });
            }
            
            console.log('ğŸ—‘ï¸ Erledigte Alarme gelÃ¶scht');
            alert('âœ… Erledigte Alarme wurden gelÃ¶scht!');
            loadAntiFraudAlerts();
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.26.14d: RECHNUNG-DOWNLOAD FÃœR FAHRGAST
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function downloadReceipt(rideIdOrTimestamp) {
            try {
                console.log('ğŸ“„ downloadReceipt aufgerufen fÃ¼r:', rideIdOrTimestamp);
                
                // ğŸ†• v5.26.14j: Check ob jsPDF geladen ist!
                if (!window.jspdf || !window.jspdf.jsPDF) {
                    alert('âŒ PDF-Bibliothek nicht geladen!\n\nBitte Seite neu laden (F5).');
                    console.error('âŒ jsPDF nicht verfÃ¼gbar!');
                    return;
                }
                
                // Finde Fahrt
                const localHistory = JSON.parse(localStorage.getItem('rideHistory') || '[]');
                const ride = localHistory.find(r => r.createdAt === rideIdOrTimestamp || r.id === rideIdOrTimestamp);
                
                console.log('ğŸ” Gefundene Fahrt:', ride);
                
                if (!ride) {
                    alert('âŒ Fahrt nicht gefunden!');
                    console.error('âŒ Fahrt nicht in localStorage gefunden:', rideIdOrTimestamp);
                    return;
                }
                
                console.log('âœ… Erstelle PDF...');
                
                // Erstelle PDF mit jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
            // Schriftart und GrÃ¶ÃŸe
            doc.setFont('helvetica');
            
            // HEADER
            doc.setFontSize(20);
            doc.setTextColor(102, 126, 234); // #667eea
            doc.text('Funk Taxi Heringsdorf', 105, 20, { align: 'center' });
            
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text('RECHNUNG', 105, 30, { align: 'center' });
            
            // Linie
            doc.setDrawColor(200, 200, 200);
            doc.line(20, 35, 190, 35);
            
            // FAHRT-NUMMER & DATUM
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            const fahrtNr = ride.id || String(ride.createdAt).substring(0, 10);
            doc.text('Fahrt-Nr: #' + fahrtNr, 20, 45);
            
            if (ride.createdAt) {
                const datum = new Date(ride.createdAt);
                const datumStr = datum.toLocaleString('de-DE', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                doc.text('Datum: ' + datumStr, 20, 52);
            }
            
            // FAHRT-DETAILS
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            doc.text('Von:', 20, 65);
            doc.setFont('helvetica', 'normal');
            doc.text(ride.pickup || 'Unbekannt', 20, 72);
            
            doc.setFont('helvetica', 'bold');
            doc.text('Nach:', 20, 85);
            doc.setFont('helvetica', 'normal');
            doc.text(ride.destination || 'Unbekannt', 20, 92);
            
            // STRECKE & PREIS
            doc.setFont('helvetica', 'bold');
            doc.text('Strecke:', 20, 105);
            doc.setFont('helvetica', 'normal');
            doc.text((ride.distance || '?') + ' km', 20, 112);
            
            doc.setFont('helvetica', 'bold');
            doc.text('Preis:', 20, 125);
            doc.setFontSize(18);
            doc.setTextColor(102, 126, 234);
            doc.text((ride.price || '?') + ',00 EUR', 20, 135);
            
            // ZAHLUNGSMETHODE (falls vorhanden)
            if (ride.paymentMethod) {
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('Zahlungsmethode:', 20, 148);
                doc.setFont('helvetica', 'normal');
                const paymentText = {
                    'bar': 'Bargeld',
                    'karte': 'EC-Karte/Kreditkarte',
                    'paypal': 'PayPal/Digitale Zahlung',
                    'rechnung': 'Rechnung (Firmenkunden)'
                }[ride.paymentMethod] || ride.paymentMethod;
                doc.text(paymentText, 20, 155);
            }
            
            // FAHRZEUG-INFO (falls vorhanden)
            if (ride.vehicleLabel) {
                doc.setFont('helvetica', 'bold');
                doc.text('Fahrzeug:', 20, 168);
                doc.setFont('helvetica', 'normal');
                doc.text(ride.vehicleLabel, 20, 175);
            }
            
            // FOOTER
            doc.setFontSize(9);
            doc.setTextColor(150, 150, 150);
            doc.text('Funk Taxi Heringsdorf', 105, 280, { align: 'center' });
            doc.text('Vielen Dank fÃ¼r Ihre Fahrt!', 105, 285, { align: 'center' });
            
            // DOWNLOAD
            const filename = 'Rechnung_Taxi_' + fahrtNr + '.pdf';
            doc.save(filename);
            
            console.log('âœ… Rechnung erstellt:', filename);
            alert('âœ… Rechnung wird heruntergeladen!\n\n' + filename);
            
            } catch (error) {
                console.error('âŒ Fehler beim Erstellen der Rechnung:', error);
                alert('âŒ Fehler beim Erstellen der Rechnung!\n\n' + error.message + '\n\nBitte Screenshot machen und melden.');
            }
        }
        
        // ğŸ†• v5.26.14j: STORNOBELEG MIT ERROR-HANDLING
        function downloadCancellationReceipt(rideIdOrTimestamp) {
            try {
                console.log('ğŸ“„ downloadCancellationReceipt aufgerufen fÃ¼r:', rideIdOrTimestamp);
                
                // ğŸ†• v5.26.14j: Check ob jsPDF geladen ist!
                if (!window.jspdf || !window.jspdf.jsPDF) {
                    alert('âŒ PDF-Bibliothek nicht geladen!\n\nBitte Seite neu laden (F5).');
                    console.error('âŒ jsPDF nicht verfÃ¼gbar!');
                    return;
                }
                
                // Finde Fahrt
                const localHistory = JSON.parse(localStorage.getItem('rideHistory') || '[]');
                const ride = localHistory.find(r => r.createdAt === rideIdOrTimestamp || r.id === rideIdOrTimestamp);
                
                console.log('ğŸ” Gefundene Fahrt:', ride);
                
                if (!ride) {
                    alert('âŒ Fahrt nicht gefunden!');
                    console.error('âŒ Fahrt nicht in localStorage gefunden:', rideIdOrTimestamp);
                    return;
                }
                
            // ğŸ†• v5.26.14g: Berechne StornogebÃ¼hr (15% vom Preis)
            const createdAt = ride.createdAt || 0;
            const cancelledAt = ride.cancelledAt || ride.completedAt || Date.now();
            const timeDiff = cancelledAt - createdAt;
            const minutesDiff = Math.floor(timeDiff / (60 * 1000));
            
            if (minutesDiff > 60) {
                alert('â„¹ï¸ Diese Stornierung war kostenfrei (mehr als 60 Min nach Buchung).');
                return;
            }
            
            const cancellationFee = Math.round((ride.price || 0) * 0.15 * 100) / 100;
            
            if (cancellationFee <= 0) {
                alert('âŒ Keine StornogebÃ¼hr berechenbar (kein Preis vorhanden)!');
                return;
            }
            
            // Erstelle PDF mit jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Schriftart und GrÃ¶ÃŸe
            doc.setFont('helvetica');
            
            // HEADER
            doc.setFontSize(20);
            doc.setTextColor(239, 68, 68); // #ef4444 (rot)
            doc.text('Funk Taxi Heringsdorf', 105, 20, { align: 'center' });
            
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text('STORNOBELEG', 105, 30, { align: 'center' });
            
            // Linie
            doc.setDrawColor(200, 200, 200);
            doc.line(20, 35, 190, 35);
            
            // FAHRT-NUMMER & DATUM
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            const fahrtNr = ride.id || String(ride.createdAt).substring(0, 10);
            doc.text('Fahrt-Nr: #' + fahrtNr, 20, 45);
            
            if (ride.createdAt) {
                const datum = new Date(ride.createdAt);
                const datumStr = datum.toLocaleString('de-DE', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                doc.text('Buchungsdatum: ' + datumStr, 20, 52);
            }
            
            if (ride.cancelledAt) {
                const cancelDatum = new Date(ride.cancelledAt);
                const cancelStr = cancelDatum.toLocaleString('de-DE', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                doc.text('Storniert am: ' + cancelStr, 20, 59);
            }
            
            // STORNIERUNG HINWEIS
            doc.setFontSize(12);
            doc.setTextColor(239, 68, 68);
            doc.setFont('helvetica', 'bold');
            doc.text('Diese Fahrt wurde storniert', 20, 75);
            
            // FAHRT-DETAILS
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            doc.text('Von:', 20, 90);
            doc.setFont('helvetica', 'normal');
            doc.text(ride.pickup || 'Unbekannt', 20, 97);
            
            doc.setFont('helvetica', 'bold');
            doc.text('Nach:', 20, 110);
            doc.setFont('helvetica', 'normal');
            doc.text(ride.destination || 'Unbekannt', 20, 117);
            
            // STORNIERUNGSGRUND
            if (ride.cancellationReason) {
                doc.setFont('helvetica', 'bold');
                doc.text('Stornierungsgrund:', 20, 130);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                const lines = doc.splitTextToSize(ride.cancellationReason, 170);
                doc.text(lines, 20, 137);
            }
            
            // STORNOGEBÃœHR
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text('Stornogebuehr (15%):', 20, 160);
            doc.setFontSize(18);
            doc.setTextColor(239, 68, 68);
            doc.text(cancellationFee.toFixed(2) + ' EUR', 20, 170);
            
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text('Stornierung innerhalb 60 Min - 15% Stornogebuehr', 20, 180);
            doc.text('(Urspruenglicher Preis: ' + (ride.price || 0).toFixed(2) + ' EUR)', 20, 187);
            
            // FOOTER
            doc.setFontSize(9);
            doc.setTextColor(150, 150, 150);
            doc.text('Funk Taxi Heringsdorf', 105, 280, { align: 'center' });
            
            // DOWNLOAD
            const filename = 'Stornobeleg_Taxi_' + fahrtNr + '.pdf';
            doc.save(filename);
            
            console.log('âœ… Stornobeleg erstellt:', filename);
            alert('âœ… Stornobeleg wird heruntergeladen!\n\n' + filename);
            
            } catch (error) {
                console.error('âŒ Fehler beim Erstellen des Stornobelegs:', error);
                alert('âŒ Fehler beim Erstellen des Stornobelegs!\n\n' + error.message + '\n\nBitte Screenshot machen und melden.');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Berechne aktuellen Gesamt-Multiplikator
        function getCurrentMultiplier() {
            let multiplier = 100; // Basis 100%
            let reasons = [];
            
            // Auto-Surge basierend auf aktiven Fahrten
            if (pricingSettings.autoSurgeEnabled) {
                const activeRides = rides.filter(r => r.status === 'accepted' || r.status === 'in_progress').length;
                if (activeRides > 0) {
                    const autoSurge = activeRides * pricingSettings.surgePerTaxi;
                    multiplier += autoSurge;
                    reasons.push(`+${autoSurge}% (${activeRides} Taxi${activeRides > 1 ? 's' : ''} unterwegs)`);
                }
            }
            
            // Manueller Aufschlag/Rabatt
            if (pricingSettings.manualMultiplier !== 0) {
                multiplier += pricingSettings.manualMultiplier;
                const sign = pricingSettings.manualMultiplier > 0 ? '+' : '';
                reasons.push(`${sign}${pricingSettings.manualMultiplier}% (Manuell)`);
            }
            
            return {
                multiplier: multiplier,
                factor: multiplier / 100,
                reasons: reasons.length > 0 ? reasons.join(', ') : 'Normalpreis'
            };
        }
        
        // Update Pricing UI im Admin
        function updatePricingUI() {
            const current = getCurrentMultiplier();
            
            const displayEl = document.getElementById('current-multiplier-display');
            const reasonEl = document.getElementById('multiplier-reason');
            const exampleEl = document.getElementById('pricing-example');
            
            if (displayEl) {
                displayEl.textContent = current.multiplier + '%';
                displayEl.style.color = current.multiplier > 100 ? '#fecaca' : (current.multiplier < 100 ? '#bbf7d0' : 'white');
            }
            if (reasonEl) {
                reasonEl.textContent = current.reasons;
            }
            if (exampleEl) {
                const example = (14.60 * current.factor).toFixed(2);
                exampleEl.textContent = `Beispiel: 14.60â‚¬ Ã— ${current.multiplier}% = ${example}â‚¬`;
            }
        }

        // ğŸš¨ ADMIN ALARM SYSTEM fÃ¼r neue Fahrten
        let adminAlarmInterval = null;
        // ğŸ¯ Welche Fahrten wurden bereits vom Admin bestÃ¤tigt
        // Wird in localStorage gespeichert damit es nach Logout erhalten bleibt!
        function loadAcknowledgedRides() {
            const saved = localStorage.getItem('acknowledgedRides');
            if (saved) {
                try {
                    return new Set(JSON.parse(saved));
                } catch (e) {
                    return new Set();
                }
            }
            return new Set();
        }
        
        function saveAcknowledgedRides() {
            localStorage.setItem('acknowledgedRides', JSON.stringify([...acknowledgedRides]));
        }
        
        let acknowledgedRides = loadAcknowledgedRides();
        
        // ğŸ†• v5.31.5: ALARM EINSTELLUNGEN
        function toggleAdminAlarm() {
            const checkbox = document.getElementById('disable-admin-alarm');
            localStorage.setItem('disableAdminAlarm', checkbox.checked ? 'true' : 'false');
            
            if (checkbox.checked) {
                alert('âœ… Alarm-Modal deaktiviert!\n\nDu siehst jetzt nur noch die dezente Benachrichtigung oben.');
            } else {
                alert('ğŸ”” Alarm-Modal aktiviert!\n\nDu bekommst wieder Pop-ups & Sound bei neuen Fahrten.');
            }
        }
        
        // ğŸ†• v5.31.5: Zu offenen Fahrten scrollen
        function scrollToOpenRides() {
            const openSection = document.getElementById('open-content');
            if (openSection) {
                openSection.style.display = 'block';
                document.getElementById('open-toggle').textContent = 'â–²';
                openSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        // ğŸ†• v5.31.5: Update Benachrichtigungs-Bar
        function updateNotificationBar() {
            const newRides = rides.filter(r => 
                (r.status === 'new' || r.status === 'vorbestellt') && 
                !acknowledgedRides.has(r.id) &&
                !r.vehicleId  // Noch kein Fahrer zugewiesen
            );
            
            const bar = document.getElementById('admin-notification-bar');
            const count = document.getElementById('notification-ride-count');
            
            if (newRides.length > 0) {
                bar.style.display = 'block';
                count.textContent = newRides.length;
            } else {
                bar.style.display = 'none';
            }
        }
        
        // Alarm-Sound (Lauter Beep)
        function playAdminAlarmSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // 3x hintereinander abspielen
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800; // Hoher Ton
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                }, i * 400);
            }
        }
        
        // Hauptfunktion: Alarm auslÃ¶sen
        function triggerAdminAlarm(newRideCount) {
            console.log('ğŸš¨ ADMIN ALARM: Neue Fahrt(en)!', newRideCount);
            
            // ğŸ†• v5.31.5: Dezente Benachrichtigung IMMER updaten
            updateNotificationBar();
            
            // ğŸ†• v5.31.5: PrÃ¼fe ob Alarm deaktiviert ist
            const alarmDisabled = localStorage.getItem('disableAdminAlarm') === 'true';
            
            if (alarmDisabled) {
                console.log('ğŸ”• Alarm-Modal ist deaktiviert - nur dezente Benachrichtigung');
                return; // STOP! Nur dezente Benachrichtigung anzeigen
            }
            
            // 1. Sound abspielen (nur wenn nicht deaktiviert)
            playAdminAlarmSound();
            
            // 2. Browser-Notification (wenn erlaubt)
            if (Notification.permission === 'granted') {
                new Notification('ğŸš• NEUE FAHRT!', {
                    body: `${newRideCount} neue Fahrt${newRideCount > 1 ? 'en' : ''} wartet auf Zuweisung!`,
                    icon: 'ğŸš•',
                    requireInteraction: true
                });
            }
            
            // 3. Modal anzeigen
            showAdminAlarmModal();
            
            // 4. Wiederholungs-Timer starten (alle 3 Min)
            if (adminAlarmInterval) clearInterval(adminAlarmInterval);
            adminAlarmInterval = setInterval(() => {
                const stillNewRides = rides.filter(r => 
                    (r.status === 'new' || r.status === 'vorbestellt') && 
                    !acknowledgedRides.has(r.id)
                ).length;
                if (stillNewRides > 0) {
                    // Nur wenn nicht deaktiviert
                    if (localStorage.getItem('disableAdminAlarm') !== 'true') {
                        playAdminAlarmSound();
                        if (Notification.permission === 'granted') {
                            new Notification('âš ï¸ UNBEARBEITETE FAHRT!', {
                                body: `${stillNewRides} Fahrt${stillNewRides > 1 ? 'en' : ''} noch nicht zugewiesen!`,
                                requireInteraction: true
                            });
                        }
                    }
                } else {
                    clearInterval(adminAlarmInterval);
                    adminAlarmInterval = null;
                }
            }, 3 * 60 * 1000); // 3 Minuten
        }
        
        // Modal anzeigen
        function showAdminAlarmModal() {
            // Entferne altes Modal falls vorhanden
            const oldModal = document.getElementById('admin-alarm-modal');
            if (oldModal) oldModal.remove();
            
            const newRides = rides.filter(r => 
                (r.status === 'new' || r.status === 'vorbestellt') && 
                !acknowledgedRides.has(r.id)
            );
            if (newRides.length === 0) return;
            
            const modal = document.createElement('div');
            modal.id = 'admin-alarm-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(220,38,38,0.95);display:flex;align-items:center;justify-content:center;z-index:99999;animation:pulse 1s infinite;';
            
            const ride = newRides[0];
            // ğŸ›¡ï¸ FIX: pickupTimestamp verwenden ODER pickupTime direkt anzeigen
            let pickupTime = 'Sofort';
            if (ride.pickupTimestamp) {
                pickupTime = new Date(ride.pickupTimestamp).toLocaleString('de-DE', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } else if (ride.pickupTime && ride.pickupTime !== 'Sofort') {
                pickupTime = ride.pickupTime; // Bereits formatierter String
            }
            
            const title = newRides.length === 1 ? 'NEUE FAHRT!' : `${newRides.length} NEUE FAHRTEN!`;
            
            modal.innerHTML = `
                <div style="background:white;border-radius:20px;padding:40px;max-width:500px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.5);">
                    <div style="font-size:80px;margin-bottom:20px;animation:bounce 1s infinite;">ğŸš•</div>
                    <h2 style="margin:0 0 10px 0;font-size:32px;color:#dc2626;">${title}</h2>
                    <div style="background:#fef2f2;padding:20px;border-radius:12px;margin:20px 0;text-align:left;">
                        <div style="margin-bottom:10px;"><strong>ğŸ“ Von:</strong> ${ride.pickup}</div>
                        <div style="margin-bottom:10px;"><strong>ğŸ“ Nach:</strong> ${ride.destination}</div>
                        <div style="margin-bottom:10px;"><strong>ğŸ‘¤ Name:</strong> ${ride.customerName}</div>
                        <div style="margin-bottom:10px;"><strong>ğŸ“ Tel:</strong> ${ride.customerPhone}</div>
                        <div style="margin-bottom:10px;"><strong>ğŸ• Abholung:</strong> ${pickupTime}</div>
                    </div>
                    <button onclick="acknowledgeAdminAlarm()" style="width:100%;padding:18px;background:#dc2626;color:white;border:none;border-radius:12px;font-size:18px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(220,38,38,0.4);">
                        âœ“ BestÃ¤tigt - Fahrer zuweisen!
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Alarm bestÃ¤tigen
        function acknowledgeAdminAlarm() {
            const newRides = rides.filter(r => 
                r.status === 'new' || r.status === 'vorbestellt'
            );
            newRides.forEach(r => acknowledgedRides.add(r.id));
            
            // ğŸ’¾ Speichere in localStorage
            saveAcknowledgedRides();
            
            const modal = document.getElementById('admin-alarm-modal');
            if (modal) modal.remove();
            
            // Wechsle zum Admin-Tab
            if (currentView !== 'admin') {
                switchView('admin');
            }
        }
        
        // Badge am Admin-Tab aktualisieren
        function updateAdminBadge(count) {
            const adminBtn = document.getElementById('admin-tab-btn');
            if (!adminBtn) return;
            
            let badge = adminBtn.querySelector('.admin-badge');
            if (!badge) {
                badge = document.createElement('span');
                badge.className = 'admin-badge';
                badge.style.cssText = 'position:absolute;top:-8px;right:-8px;background:#dc2626;color:white;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;box-shadow:0 2px 8px rgba(220,38,38,0.4);';
                adminBtn.style.position = 'relative';
                adminBtn.appendChild(badge);
            }
            
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // ğŸ“± TELEGRAM BOT INTEGRATION
        const TELEGRAM_BOT_TOKEN = '8456598996:AAGEIdlDDbQwZ4-1OQFoW3fkT9tZlfTc_FM';
        const TELEGRAM_BOT_USERNAME = 'FunkTaxiHeringsdorfBot';
        
        // Telegram-Nachricht senden
        async function sendTelegramMessage(chatId, text) {
            try {
                const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: text,
                        parse_mode: 'HTML'
                    })
                });
                
                const data = await response.json();
                if (data.ok) {
                    console.log('âœ… Telegram gesendet an Chat', chatId);
                } else {
                    console.error('âŒ Telegram Fehler:', data);
                    // ğŸ“œ PROTOKOLL: Telegram-Fehler
                    logActivity('system', 'telegram_error', `Telegram-Fehler: ${data.description || 'Unbekannt'}`, {
                        chatId: chatId,
                        errorCode: data.error_code
                    });
                }
                return data.ok;
            } catch (error) {
                console.error('âŒ Telegram Fehler:', error);
                // ğŸ“œ PROTOKOLL: Telegram-Fehler
                logActivity('system', 'telegram_error', `Telegram nicht erreichbar: ${error.message}`, {
                    chatId: chatId
                });
                return false;
            }
        }
        
        // Alarm Ã¼ber Telegram senden (VERALTET - wird nicht mehr verwendet)
        // JEDE Fahrt bekommt jetzt ihre eigene Nachricht via sendTelegramForNewRide()
        async function sendTelegramAlarm() {
            // Diese Funktion ist veraltet
            console.log('âš ï¸ sendTelegramAlarm ist veraltet - Fahrten werden einzeln gesendet');
        }
        
        // ğŸ†• v5.25.6: TELEGRAM AN ADMIN bei wichtigen Events
        async function sendTelegramToAdmin(message) {
            if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) {
                console.log('âš ï¸ Telegram nicht konfiguriert');
                return false;
            }
            
            try {
                // Sende an Haupt-Chat-ID (Admin)
                const success = await sendTelegramMessage(TELEGRAM_CHAT_ID, message);
                if (success) {
                    console.log('ğŸ“± Admin-Telegram gesendet');
                }
                return success;
            } catch (error) {
                console.error('âŒ Admin-Telegram Fehler:', error);
                return false;
            }
        }
        
        // ğŸ†• v5.18.0: TELEGRAM DIREKT AN ZUGEWIESENEN FAHRER!
        // ğŸ†• v5.19.0: Erweitert mit GPS-Warnung + User-basierte Chat-ID
        async function sendTelegramToDriver(vehicleId, ride, gpsAgeMinutes = 0) {
            if (!isFirebaseReady) return false;
            
            try {
                // Hole Fahrer-Daten aus Firebase
                const driverSnapshot = await db.ref('drivers/' + vehicleId).once('value');
                const driverData = driverSnapshot.val();
                
                if (!driverData) {
                    console.log('âš ï¸ Keine Fahrer-Daten fÃ¼r:', vehicleId);
                    return false;
                }
                
                const driverName = driverData.vehicle || vehicleId;
                const userId = driverData.userId;
                
                // ğŸ†• v5.19.0: Hole Chat-ID vom USER (nicht vom Fahrzeug!)
                let chatId = null;
                
                if (userId) {
                    const userSnapshot = await db.ref('users/' + userId + '/telegramChatId').once('value');
                    chatId = userSnapshot.val();
                    console.log('ğŸ“± Chat-ID von User', userId, ':', chatId);
                }
                
                // Fallback: Alte Struktur (Chat-ID beim Fahrzeug)
                if (!chatId && driverData.telegramChatId) {
                    chatId = driverData.telegramChatId;
                    console.log('ğŸ“± Chat-ID von Fahrzeug (Fallback):', chatId);
                }
                
                if (!chatId) {
                    console.log('âš ï¸ Fahrer hat keine Telegram-ID hinterlegt:', vehicleId);
                    return false;
                }
                
                // ğŸ†• GPS-Warnung wenn Position Ã¤lter als 3 Minuten
                let gpsWarning = '';
                if (gpsAgeMinutes > 3) {
                    gpsWarning = `\nâš ï¸ <b>ACHTUNG:</b> Dein GPS ist seit ${gpsAgeMinutes} Min offline!\n` +
                                 `ğŸ‘‰ App Ã¶ffnen damit GPS wieder lÃ¤uft!\n`;
                }
                
                // Formatiere Nachricht fÃ¼r Fahrer MIT RIDE-ID
                const rideId = ride.firebaseId || ride.id || 'unbekannt';
                const message = `ğŸš¨ <b>NEUER AUFTRAG FÃœR DICH!</b> ğŸš¨\n` +
                    `ğŸ†” <b>ID:</b> <code>${rideId}</code>\n\n` +
                    `â±ï¸ <b>Du hast 60 SEKUNDEN Zeit!</b>\n` +
                    gpsWarning +
                    `\nğŸ“ <b>Abholung:</b> ${ride.pickup}\n` +
                    `ğŸ¯ <b>Ziel:</b> ${ride.destination}\n` +
                    `ğŸ‘¤ <b>Kunde:</b> ${ride.customerName}\n` +
                    `ğŸ“ <b>Tel:</b> ${ride.customerPhone}\n` +
                    `ğŸ’° <b>Preis:</b> ${ride.price}â‚¬\n\n` +
                    `ğŸ‘‰ <b>JETZT App Ã¶ffnen und ANNEHMEN!</b>\n` +
                    `<a href="https://patrick061977.github.io/taxi/">ğŸš• App Ã¶ffnen</a>`;
                
                const success = await sendTelegramMessage(chatId, message);
                
                if (success) {
                    console.log('âœ… Telegram an Fahrer gesendet:', driverName, chatId);
                    logActivity('system', 'telegram_driver', `ğŸ“± Telegram an Fahrer: ${driverName}`, {
                        driver: driverName,
                        vehicleId: vehicleId,
                        customer: ride.customerName,
                        gpsAge: gpsAgeMinutes + ' Min'
                    });
                }
                
                return success;
                
            } catch (error) {
                console.error('âŒ Telegram an Fahrer Fehler:', error);
                return false;
            }
        }
        
        // ğŸ†• v5.20.4: TELEGRAM AN FAHRER BEI STORNIERUNG
        async function sendTelegramToDriverCancel(vehicleId, message) {
            console.log('ğŸ“± sendTelegramToDriverCancel gestartet fÃ¼r:', vehicleId);
            
            if (!isFirebaseReady) {
                console.log('âŒ Firebase nicht bereit!');
                return false;
            }
            
            try {
                // Hole Fahrer-Daten aus Firebase
                const driverSnapshot = await db.ref('drivers/' + vehicleId).once('value');
                const driverData = driverSnapshot.val();
                
                console.log('ğŸ“Š Fahrer-Daten:', driverData ? 'gefunden' : 'NICHT gefunden', driverData);
                
                if (!driverData) {
                    console.log('âš ï¸ Keine Fahrer-Daten fÃ¼r:', vehicleId);
                    return false;
                }
                
                const userId = driverData.userId;
                console.log('ğŸ‘¤ userId:', userId);
                
                let chatId = null;
                
                // Chat-ID vom USER holen
                if (userId) {
                    const userSnapshot = await db.ref('users/' + userId + '/telegramChatId').once('value');
                    chatId = userSnapshot.val();
                    console.log('ğŸ“± Chat-ID von User:', chatId);
                }
                
                // Fallback: Chat-ID vom Fahrzeug
                if (!chatId && driverData.telegramChatId) {
                    chatId = driverData.telegramChatId;
                    console.log('ğŸ“± Chat-ID von Fahrzeug (Fallback):', chatId);
                }
                
                if (!chatId) {
                    console.log('âš ï¸ Fahrer hat keine Telegram-ID:', vehicleId);
                    return false;
                }
                
                console.log('ğŸ“¤ Sende Telegram an Chat-ID:', chatId);
                const success = await sendTelegramMessage(chatId, message);
                
                if (success) {
                    console.log('âœ… Stornierung-Telegram an Fahrer gesendet:', vehicleId, chatId);
                    
                    // Protokoll
                    logActivity('system', 'telegram_cancel', `ğŸ“± Stornierung an Fahrer: ${vehicleId}`, {
                        vehicleId: vehicleId,
                        chatId: chatId
                    });
                } else {
                    console.log('âŒ Telegram senden fehlgeschlagen!');
                }
                
                return success;
                
            } catch (error) {
                console.error('âŒ Telegram Stornierung Fehler:', error);
                return false;
            }
        }
        
        // ğŸ†• v5.32.3: SMS AN KUNDEN SENDEN
        async function sendCustomerSMS(phone, trackingLink, ride) {
            // ğŸ“± SMS-Gateway Integration (Twilio, etc.)
            // TODO: SMS-Gateway API-Key in Firebase Config speichern
            
            const smsText = `ğŸš• FUNK TAXI HERINGSDORF\n\n` +
                `âœ… Ihre Fahrt wurde bestellt!\n\n` +
                `ğŸ“ Von: ${ride.pickup}\n` +
                `ğŸ¯ Nach: ${ride.destination}\n` +
                `ğŸ’° Preis: ${ride.price}â‚¬\n\n` +
                `ğŸ“² Verfolgen Sie Ihre Fahrt:\n${trackingLink}\n\n` +
                `Bei Fragen: ${phone}`;
            
            try {
                // ğŸ”§ PLACEHOLDER: Hier SMS-Gateway API einbinden!
                // Beispiel fÃ¼r Twilio:
                /*
                const response = await fetch('https://api.twilio.com/2010-04-01/Accounts/YOUR_ACCOUNT_SID/Messages.json', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Basic ' + btoa('YOUR_ACCOUNT_SID:YOUR_AUTH_TOKEN'),
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        From: 'YOUR_TWILIO_NUMBER',
                        To: phone,
                        Body: smsText
                    })
                });
                
                const data = await response.json();
                if (data.sid) {
                    console.log('âœ… SMS gesendet:', data.sid);
                    logActivity('customer', 'sms_sent', `SMS an Kunde: ${phone}`, {
                        phone: phone,
                        trackingLink: trackingLink
                    });
                    return true;
                } else {
                    console.error('âŒ SMS Fehler:', data);
                    return false;
                }
                */
                
                // ğŸ“ ENTWICKLUNG: SMS-Text loggen
                console.log('ğŸ“± SMS wÃ¼rde gesendet werden:');
                console.log('ğŸ“ An:', phone);
                console.log('ğŸ“„ Text:', smsText);
                
                // ğŸ“œ PROTOKOLL: SMS-Versuch
                logActivity('customer', 'sms_planned', `SMS geplant fÃ¼r: ${phone}`, {
                    phone: phone,
                    trackingLink: trackingLink,
                    text: smsText
                });
                
                // TODO: Sobald SMS-Gateway konfiguriert ist, return true
                return true; // FÃ¼r Tests
                
            } catch (error) {
                console.error('âŒ SMS Fehler:', error);
                logActivity('customer', 'sms_error', `SMS-Fehler fÃ¼r ${phone}: ${error.message}`, {
                    phone: phone,
                    error: error.message
                });
                return false;
            }
        }
        
        // ğŸ†• v5.32.3: TELEGRAM AN KUNDEN SENDEN
        async function sendCustomerTelegram(phone, trackingLink, ride) {
            if (!isFirebaseReady) return false;
            
            try {
                // Hole Kunden-Chat-ID aus Firebase (wenn vorhanden)
                // Kunden kÃ¶nnen sich mit dem Bot verknÃ¼pfen Ã¼ber /start
                
                // ğŸ“± Suche nach Kunden-Chat-ID via Telefonnummer
                const customersSnapshot = await db.ref('customers').orderByChild('phone').equalTo(phone).once('value');
                const customersData = customersSnapshot.val();
                
                if (!customersData) {
                    console.log('âš ï¸ Kunde nicht in DB gefunden:', phone);
                    return false;
                }
                
                // Finde ersten Kunden mit telegramChatId
                let chatId = null;
                for (const customerId in customersData) {
                    const customer = customersData[customerId];
                    if (customer.telegramChatId) {
                        chatId = customer.telegramChatId;
                        console.log('ğŸ“± Kunden-Chat-ID gefunden:', chatId);
                        break;
                    }
                }
                
                if (!chatId) {
                    console.log('âš ï¸ Kunde hat keine Telegram-VerknÃ¼pfung:', phone);
                    return false;
                }
                
                // Formatiere Telegram-Nachricht fÃ¼r Kunden
                const pickupTimeDisplay = ride.pickupTime || 'Sofort';
                const message = `ğŸš• <b>IHRE FAHRT WURDE BESTELLT!</b> ğŸš•\n\n` +
                    `ğŸ“ <b>Von:</b> ${ride.pickup}\n` +
                    `ğŸ¯ <b>Nach:</b> ${ride.destination}\n` +
                    `ğŸ• <b>Abholung:</b> ${pickupTimeDisplay}\n` +
                    `ğŸ’° <b>Preis:</b> ${ride.price}â‚¬\n\n` +
                    `ğŸ“² <b>Ihre Fahrt live verfolgen:</b>\n` +
                    `<a href="${trackingLink}">ğŸ—ºï¸ Tracking Ã¶ffnen</a>\n\n` +
                    `âœ… Sie erhalten Updates sobald ein Fahrer zugewiesen wurde!\n\n` +
                    `ğŸ“ Bei Fragen: ${ride.customerPhone}`;
                
                const success = await sendTelegramMessage(chatId, message);
                
                if (success) {
                    console.log('âœ… Telegram an Kunde gesendet:', phone, chatId);
                    logActivity('customer', 'telegram_sent', `ğŸ“± Telegram an Kunde: ${ride.customerName}`, {
                        customer: ride.customerName,
                        phone: phone,
                        chatId: chatId,
                        trackingLink: trackingLink
                    });
                }
                
                return success;
                
            } catch (error) {
                console.error('âŒ Telegram an Kunde Fehler:', error);
                logActivity('customer', 'telegram_error', `Telegram-Fehler fÃ¼r ${phone}: ${error.message}`, {
                    phone: phone,
                    error: error.message
                });
                return false;
            }
        }
        
        // ğŸ†• v5.32.3: KUNDEN-BENACHRICHTIGUNGEN (SMS + Telegram)
        async function sendCustomerNotifications(ride) {
            console.log('ğŸ“² Sende Kunden-Benachrichtigungen...');
            
            // ğŸ”— Erstelle Tracking-Link
            const trackingLink = `${window.location.origin}${window.location.pathname}?ride=${ride.firebaseId}`;
            
            // ğŸ“± SMS senden
            const smsSuccess = await sendCustomerSMS(ride.customerPhone, trackingLink, ride);
            if (smsSuccess) {
                console.log('âœ… SMS an Kunde gesendet');
            } else {
                console.log('âš ï¸ SMS konnte nicht gesendet werden');
            }
            
            // ğŸ’¬ Telegram senden (wenn verknÃ¼pft)
            const telegramSuccess = await sendCustomerTelegram(ride.customerPhone, trackingLink, ride);
            if (telegramSuccess) {
                console.log('âœ… Telegram an Kunde gesendet');
            } else {
                console.log('âš ï¸ Kunde hat kein Telegram verknÃ¼pft');
            }
            
            // ğŸ’¾ Speichere Status in Firebase
            if (isFirebaseReady && ride.firebaseId) {
                try {
                    await db.ref('rides/' + ride.firebaseId).update({
                        notificationsSent: {
                            sms: smsSuccess,
                            telegram: telegramSuccess,
                            timestamp: Date.now()
                        }
                    });
                    console.log('âœ… Benachrichtigungs-Status in Firebase gespeichert');
                } catch (error) {
                    console.error('âŒ Fehler beim Speichern des Status:', error);
                }
            }
            
            return {
                sms: smsSuccess,
                telegram: telegramSuccess
            };
        }
        
        // Telegram Chat registrieren (automatisch beim /start)
        async function registerTelegramChat(chatId) {
            if (!isFirebaseReady) return;
            
            try {
                const snapshot = await db.ref('settings/telegram/adminChats').once('value');
                let adminChats = snapshot.val() || [];
                
                if (!adminChats.includes(chatId)) {
                    adminChats.push(chatId);
                    await db.ref('settings/telegram/adminChats').set(adminChats);
                    console.log('âœ… Telegram Chat registriert:', chatId);
                    
                    // BestÃ¤tigungs-Nachricht senden
                    await sendTelegramMessage(chatId, 
                        'âœ… <b>Erfolgreich registriert!</b>\n\n' +
                        'Du bekommst ab jetzt alle neuen Fahrten als Telegram-Nachricht.\n\n' +
                        'ğŸš• Funk Taxi Heringsdorf'
                    );
                }
            } catch (error) {
                console.error('âŒ Telegram Registrierung Fehler:', error);
            }
        }
        
        // Telegram sofort beim Erstellen senden (nicht warten auf Admin-Alarm)
        async function sendTelegramForNewRide(ride) {
            if (!isFirebaseReady) return;
            
            // ğŸ›¡ï¸ DUPLIKAT-SCHUTZ: PrÃ¼fe ob diese Fahrt schon gesendet wurde
            const rideKey = ride.firebaseId || ride.id || ride.createdAt;
            if (sentTelegramRides.has(rideKey)) {
                console.log('âš ï¸ Telegram DUPLIKAT verhindert fÃ¼r Fahrt:', rideKey);
                return; // STOP! Nicht nochmal senden!
            }
            
            try {
                // Lade Admin Chat IDs aus Firebase
                const snapshot = await db.ref('settings/telegram/adminChats').once('value');
                const adminChats = snapshot.val() || [];
                
                if (adminChats.length === 0) {
                    console.log('âš ï¸ Keine Telegram-Admin-Chats konfiguriert');
                    return;
                }
                
                // Intelligente Zeit-Formatierung
                const now = new Date();
                const pickupDate = ride.pickupTimestamp ? new Date(ride.pickupTimestamp) : now;
                
                // â° ZEITSTEMPEL fÃ¼r Telegram
                const timestamp = now.toLocaleString('de-DE', {
                    day: '2-digit',
                    month: '2-digit',
                    year: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                // Ist es heute?
                const isToday = pickupDate.toDateString() === now.toDateString();
                
                // Ist es sofort? (innerhalb 15 Min)
                const isSofort = ride.status === 'new';
                
                let pickupTimeFormatted;
                let statusEmoji;
                let statusText;
                
                if (isSofort) {
                    // SOFORT-FAHRT
                    pickupTimeFormatted = 'SOFORT';
                    statusEmoji = 'ğŸš•';
                    statusText = 'SOFORT-FAHRT!';
                } else if (isToday) {
                    // VORBESTELLUNG - Heute
                    const time = pickupDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    pickupTimeFormatted = `Heute ${time}`;
                    statusEmoji = 'ğŸ“…';
                    statusText = 'VORBESTELLUNG';
                } else {
                    // VORBESTELLUNG - Morgen oder spÃ¤ter
                    const date = pickupDate.toLocaleDateString('de-DE', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: '2-digit' 
                    });
                    const time = pickupDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    pickupTimeFormatted = `${date} ${time}`;
                    statusEmoji = 'ğŸ“…';
                    statusText = 'VORBESTELLUNG';
                }
                
                // Formatiere Nachricht MIT ZEITSTEMPEL UND RIDE-ID
                const rideId = ride.firebaseId || ride.id || 'unbekannt';
                const message = `${statusEmoji} <b>${statusText}</b>\n` +
                    `ğŸ†” <b>ID:</b> <code>${rideId}</code>\n\n` +
                    `ğŸ“ <b>Von:</b> ${ride.pickup}\n` +
                    `ğŸ“ <b>Nach:</b> ${ride.destination}\n` +
                    `ğŸ‘¤ <b>Name:</b> ${ride.customerName}\n` +
                    `ğŸ“ <b>Tel:</b> ${ride.customerPhone}\n` +
                    `ğŸ• <b>Abholung:</b> ${pickupTimeFormatted}\n` +
                    `ğŸ’° <b>Preis:</b> ${ride.price}â‚¬\n` +
                    `â° <b>Gesendet:</b> ${timestamp}\n` +
                    `\nğŸ‘‰ <a href="https://patrick061977.github.io/taxi-App/">App Ã¶ffnen</a>`;
                
                // Sende an alle Admin-Chats
                for (const chatId of adminChats) {
                    await sendTelegramMessage(chatId, message);
                }
                
                // ğŸ›¡ï¸ Markiere als gesendet
                sentTelegramRides.add(rideKey);
                console.log('âœ… Telegram-Benachrichtigung gesendet fÃ¼r Fahrt:', ride.id, 'um', timestamp);
                
                // ğŸ“œ PROTOKOLL: Telegram gesendet
                logActivity('system', 'telegram', `ğŸ“± Telegram versendet: Neue ${ride.status === 'vorbestellt' ? 'Vorbestellung' : 'Buchung'}`, {
                    customer: ride.customerName,
                    type: ride.status === 'vorbestellt' ? 'Vorbestellung' : 'Sofort-Fahrt',
                    recipients: adminChats.length
                });
                
            } catch (error) {
                console.error('âŒ Telegram Benachrichtigung Fehler:', error);
                
                // ğŸ“œ PROTOKOLL: Telegram Fehler
                logActivity('system', 'error', `âš ï¸ Telegram nicht erreichbar: ${error.message}`, {
                    error: error.message
                });
            }
        }
        
        // ğŸ“± Telegram bei StatusÃ¤nderungen
        async function sendTelegramStatusUpdate(ride, oldStatus, newStatus) {
            if (!isFirebaseReady) return;
            
            try {
                // Lade Admin Chat IDs aus Firebase
                const snapshot = await db.ref('settings/telegram/adminChats').once('value');
                const adminChats = snapshot.val() || [];
                
                if (adminChats.length === 0) {
                    console.log('âš ï¸ Keine Telegram-Admin-Chats konfiguriert');
                    return;
                }
                
                let message = '';
                let statusEmoji = '';
                
                // Formatiere Nachricht je nach Status
                const rideId = ride.firebaseId || ride.id || 'unbekannt';
                
                if (newStatus === 'accepted') {
                    // âœ… Fahrer zugewiesen
                    statusEmoji = 'âœ…';
                    message = `${statusEmoji} <b>FAHRER ZUGEWIESEN!</b>\n` +
                        `ğŸ†” <b>ID:</b> <code>${rideId}</code>\n\n` +
                        `ğŸš— <b>Fahrzeug:</b> ${ride.vehicle || 'Unbekannt'}${ride.vehiclePlate ? ` (${ride.vehiclePlate})` : ''}\n` +
                        `ğŸ‘¤ <b>Kunde:</b> ${ride.customerName}\n` +
                        `ğŸ“ <b>Tel:</b> ${ride.customerPhone}\n` +
                        `ğŸ“ <b>Von:</b> ${ride.pickup}\n` +
                        `ğŸ“ <b>Nach:</b> ${ride.destination}\n` +
                        `ğŸ’° <b>Preis:</b> ${ride.price}â‚¬\n` +
                        `\nğŸ‘‰ <a href="https://patrick061977.github.io/taxi-App/">App Ã¶ffnen</a>`;
                        
                } else if (newStatus === 'storniert' || newStatus === 'cancelled') {
                    // ğŸ—‘ï¸ Fahrt storniert
                    statusEmoji = 'ğŸ—‘ï¸';
                    message = `${statusEmoji} <b>FAHRT STORNIERT</b>\n` +
                        `ğŸ†” <b>ID:</b> <code>${rideId}</code>\n\n` +
                        `ğŸ‘¤ <b>Kunde:</b> ${ride.customerName}\n` +
                        `ğŸ“ <b>Tel:</b> ${ride.customerPhone}\n` +
                        `ğŸ“ <b>Von:</b> ${ride.pickup}\n` +
                        `ğŸ“ <b>Nach:</b> ${ride.destination}\n` +
                        `ğŸ’° <b>Preis:</b> ${ride.price}â‚¬\n` +
                        `\nâš ï¸ Status: Storniert`;
                        
                } else if (newStatus === 'picked_up') {
                    // ğŸš— Kunde abgeholt
                    statusEmoji = 'ğŸš—';
                    message = `${statusEmoji} <b>KUNDE ABGEHOLT!</b>\n` +
                        `ğŸ†” <b>ID:</b> <code>${rideId}</code>\n\n` +
                        `ğŸš— <b>Fahrzeug:</b> ${ride.vehicle || 'Unbekannt'}\n` +
                        `ğŸ‘¤ <b>Kunde:</b> ${ride.customerName}\n` +
                        `ğŸ“ <b>Von:</b> ${ride.pickup}\n` +
                        `ğŸ“ <b>Nach:</b> ${ride.destination}\n` +
                        `ğŸ’° <b>Preis:</b> ${ride.price}â‚¬\n` +
                        `\nğŸ¯ Fahrt zum Ziel lÃ¤uft...`;
                        
                } else if (newStatus === 'completed') {
                    // âœ… Fahrt abgeschlossen
                    statusEmoji = 'âœ…';
                    message = `${statusEmoji} <b>FAHRT ABGESCHLOSSEN!</b>\n` +
                        `ğŸ†” <b>ID:</b> <code>${rideId}</code>\n\n` +
                        `ğŸš— <b>Fahrzeug:</b> ${ride.vehicle || 'Unbekannt'}\n` +
                        `ğŸ‘¤ <b>Kunde:</b> ${ride.customerName}\n` +
                        `ğŸ“ <b>Von:</b> ${ride.pickup}\n` +
                        `ğŸ“ <b>Nach:</b> ${ride.destination}\n` +
                        `ğŸ’° <b>Preis:</b> ${ride.price}â‚¬\n` +
                        `\nâœ… Status: Abgeschlossen`;
                        
                } else {
                    // Anderer Status - keine Nachricht
                    return;
                }
                
                // Sende an alle Admin-Chats
                for (const chatId of adminChats) {
                    await sendTelegramMessage(chatId, message);
                }
                
                console.log(`âœ… Telegram-Status-Update gesendet: ${oldStatus} â†’ ${newStatus}`);
                
                // ğŸ“œ PROTOKOLL: Telegram Status-Update
                logActivity('system', 'telegram', `ğŸ“± Telegram versendet: Status ${oldStatus} â†’ ${newStatus}`, {
                    customer: ride.customerName,
                    oldStatus: oldStatus,
                    newStatus: newStatus
                });
                
            } catch (error) {
                console.error('âŒ Telegram Status-Update Fehler:', error);
            }
        }
        
        // Telegram-Aktivierung im Admin-Panel
        function showTelegramActivation() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:99999;';
            
            modal.innerHTML = `
                <div style="background:white;border-radius:16px;padding:30px;max-width:450px;text-align:center;">
                    <div style="font-size:60px;margin-bottom:15px;">ğŸ“±</div>
                    <h2 style="margin:0 0 15px 0;">Telegram-Alarme aktivieren</h2>
                    <p style="color:#666;margin-bottom:25px;">Erhalte Push-Benachrichtigungen Ã¼ber neue Fahrten - auch wenn die App geschlossen ist!</p>
                    
                    <div style="background:#f3f4f6;padding:15px;border-radius:10px;margin-bottom:20px;text-align:left;">
                        <div style="font-weight:600;margin-bottom:10px;">ğŸ“‹ Anleitung:</div>
                        <div style="font-size:14px;line-height:1.8;">
                            1ï¸âƒ£ Klicke auf "Bot Ã¶ffnen"<br>
                            2ï¸âƒ£ Schreibe <code>/start</code> im Bot<br>
                            3ï¸âƒ£ Klicke auf "Chat ID anzeigen"<br>
                            4ï¸âƒ£ Kopiere die Zahl (<code>"id":123456789</code>)<br>
                            5ï¸âƒ£ Trage sie hier ein und klicke "Registrieren"
                        </div>
                    </div>
                    
                    <button onclick="window.open('https://t.me/${TELEGRAM_BOT_USERNAME}', '_blank');" style="width:100%;padding:15px;background:#0088cc;color:white;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;margin-bottom:10px;">
                        ğŸ“± Bot Ã¶ffnen
                    </button>
                    
                    <button onclick="window.open('https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getUpdates', '_blank');" style="width:100%;padding:12px;background:#f3f4f6;color:#333;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;margin-bottom:15px;">
                        ğŸ” Chat ID anzeigen
                    </button>
                    
                    <input type="text" id="telegram-chat-id-input" placeholder="Chat ID hier eintragen..." style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;margin-bottom:10px;font-size:14px;box-sizing:border-box;">
                    
                    <button onclick="registerManualChatId()" style="width:100%;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;margin-bottom:10px;">
                        âœ… Chat ID registrieren
                    </button>
                    
                    <button onclick="this.closest('div').parentElement.remove()" style="width:100%;padding:12px;background:#e5e7eb;color:#333;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;">
                        Abbrechen
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Manuelle Chat ID Registrierung
        async function registerManualChatId() {
            const input = document.getElementById('telegram-chat-id-input');
            const chatId = input.value.trim();
            
            if (!chatId || isNaN(chatId)) {
                alert('âŒ Bitte gÃ¼ltige Chat ID eingeben!');
                return;
            }
            
            await registerTelegramChat(parseInt(chatId));
            alert('âœ… Chat ID registriert! Teste jetzt mit "Test-Nachricht senden".');
            
            // SchlieÃŸe Modal
            const modal = input.closest('div').parentElement;
            if (modal) modal.remove();
            
            // Update Status
            await updateTelegramStatus();
        }
        
        // ğŸ†• TELEGRAM: Fahrt vom Admin gelÃ¶scht
        async function sendTelegramForDeletedRide(ride) {
            if (!isFirebaseReady) return;
            
            try {
                // Lade Admin Chat IDs aus Firebase
                const snapshot = await db.ref('settings/telegram/adminChats').once('value');
                const adminChats = snapshot.val() || [];
                
                if (adminChats.length === 0) {
                    console.log('âš ï¸ Keine Telegram-Admin-Chats konfiguriert');
                    return;
                }
                
                // â° ZEITSTEMPEL
                const timestamp = new Date().toLocaleString('de-DE', {
                    day: '2-digit',
                    month: '2-digit',
                    year: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                // Formatiere Status
                let statusText = 'Nicht zugewiesen';
                if (ride.status === 'accepted') statusText = 'âœ… Angenommen';
                if (ride.status === 'picked_up') statusText = 'ğŸš— Unterwegs';
                if (ride.status === 'vorbestellt') statusText = 'ğŸ“… Vorbestellt';
                
                // Erstelle Nachricht MIT ZEITSTEMPEL UND RIDE-ID
                const rideId = ride.firebaseId || ride.id || 'unbekannt';
                const message = `ğŸ—‘ï¸ <b>FAHRT GELÃ–SCHT (Admin)</b>\n` +
                    `ğŸ†” <b>ID:</b> <code>${rideId}</code>\n\n` +
                    `âš ï¸ <b>Status war:</b> ${statusText}\n` +
                    (ride.vehicle ? `ğŸš— <b>Fahrzeug:</b> ${ride.vehicle}${ride.vehiclePlate ? ` (${ride.vehiclePlate})` : ''}\n` : '') +
                    `ğŸ‘¤ <b>Kunde:</b> ${ride.customerName}\n` +
                    `ğŸ“ <b>Tel:</b> ${ride.customerPhone}\n` +
                    `ğŸ“ <b>Von:</b> ${ride.pickup}\n` +
                    `ğŸ“ <b>Nach:</b> ${ride.destination}\n` +
                    (ride.pickupTime && ride.pickupTime !== 'Sofort' ? `â° <b>Abholung:</b> ${ride.pickupTime}\n` : '') +
                    `ğŸ’° <b>Preis:</b> ${ride.price}â‚¬\n` +
                    `â° <b>Gesendet:</b> ${timestamp}\n` +
                    `\nğŸš¨ <b>Diese Fahrt wurde vom Admin gelÃ¶scht!</b>`;
                
                // Sende an alle Admin-Chats
                for (const chatId of adminChats) {
                    await sendTelegramMessage(chatId, message);
                }
                
                console.log('ğŸ“± Telegram: LÃ¶sch-Benachrichtigung gesendet um', timestamp);
                
                // ğŸ“œ PROTOKOLL: Telegram LÃ¶sch-Nachricht
                logActivity('system', 'telegram', `ğŸ“± Telegram versendet: Fahrt gelÃ¶scht`, {
                    customer: ride.customerName,
                    type: 'LÃ¶schung'
                });
                
            } catch (error) {
                console.error('âŒ Telegram Fehler:', error);
            }
        }
        
        // ğŸ†• TELEGRAM: Warnung fÃ¼r offene Fahrten (15 Min vor Abholzeit)
        async function sendTelegramOpenRideWarning(ride) {
            if (!isFirebaseReady) return;
            
            const rideKey = ride.firebaseId || ride.id;
            if (warnedOpenRides.has(rideKey)) {
                console.log('âš ï¸ Warnung schon gesendet fÃ¼r Fahrt:', rideKey);
                return;
            }
            
            try {
                const snapshot = await db.ref('settings/telegram/adminChats').once('value');
                const adminChats = snapshot.val() || [];
                
                if (adminChats.length === 0) return;
                
                const timestamp = new Date().toLocaleString('de-DE', {
                    day: '2-digit', month: '2-digit', year: '2-digit',
                    hour: '2-digit', minute: '2-digit'
                });
                
                const pickupTime = ride.pickupTime || 'Unbekannt';
                const rideId = ride.firebaseId || ride.id || 'unbekannt';
                
                const message = `ğŸš¨ğŸš¨ğŸš¨ <b>ACHTUNG: OFFENE FAHRT!</b> ğŸš¨ğŸš¨ğŸš¨\n` +
                    `ğŸ†” <b>ID:</b> <code>${rideId}</code>\n\n` +
                    `â° <b>Abholzeit:</b> ${pickupTime}\n` +
                    `âš ï¸ <b>Noch KEIN Fahrer zugewiesen!</b>\n\n` +
                    `ğŸ‘¤ <b>Kunde:</b> ${ride.customerName}\n` +
                    `ğŸ“ <b>Tel:</b> ${ride.customerPhone}\n` +
                    `ğŸ“ <b>Von:</b> ${ride.pickup}\n` +
                    `ğŸ“ <b>Nach:</b> ${ride.destination}\n` +
                    `ğŸ’° <b>Preis:</b> ${ride.price}â‚¬\n\n` +
                    `ğŸ”´ <b>Bitte SOFORT einen Fahrer zuweisen!</b>\n` +
                    `â° <b>Warnung gesendet:</b> ${timestamp}`;
                
                for (const chatId of adminChats) {
                    await sendTelegramMessage(chatId, message);
                }
                
                warnedOpenRides.add(rideKey);
                
                console.log('ğŸš¨ Telegram: Offene-Fahrt-Warnung gesendet fÃ¼r', ride.customerName);
                
                logActivity('system', 'telegram', `ğŸš¨ Telegram: OFFENE FAHRT Warnung - ${ride.customerName}`, {
                    customer: ride.customerName,
                    pickupTime: pickupTime,
                    type: 'Warnung'
                });
                
            } catch (error) {
                console.error('âŒ Telegram Warnung Fehler:', error);
            }
        }
        
        // ğŸ†• Periodische PrÃ¼fung fÃ¼r offene Vorbestellungen (alle 60 Sek)
        function startOpenRideChecker() {
            console.log('ğŸ” Offene-Fahrten-Checker gestartet (prÃ¼ft alle 60 Sek)');
            
            setInterval(() => {
                if (!isFirebaseReady || !rides || rides.length === 0) return;
                
                const now = Date.now();
                
                rides.forEach(ride => {
                    // Nur Fahrten ohne Fahrer prÃ¼fen
                    if (ride.status !== 'new' && ride.status !== 'vorbestellt') return;
                    if (ride.vehicle || ride.driverId) return; // Hat schon Fahrer
                    
                    // PrÃ¼fe ob Abholzeit in <= 10 Minuten (Zuweisung war bei 15 Min!)
                    const pickupTime = ride.pickupTimestamp || 0;
                    const minutesUntilPickup = (pickupTime - now) / (1000 * 60);
                    
                    if (minutesUntilPickup <= 10 && minutesUntilPickup > 0) {
                        // Noch nicht gewarnt? â†’ Telegram senden!
                        const rideKey = ride.firebaseId || ride.id;
                        if (!warnedOpenRides.has(rideKey)) {
                            console.log('ğŸš¨ Offene Fahrt gefunden! Abholzeit in', Math.round(minutesUntilPickup), 'Min');
                            sendTelegramOpenRideWarning(ride);
                        }
                    }
                });
            }, 60000); // Alle 60 Sekunden prÃ¼fen
        }
        
        // ğŸ†• VORBESTELLUNGS-AKTIVIERER: Aktiviert Vorbestellungen 15 Min vor Abholung
        const activatedPrebookings = new Set(); // Verhindert Doppel-Aktivierung
        
        function startPrebookingActivator() {
            console.log('ğŸ“… Vorbestellungs-Aktivierer gestartet (prÃ¼ft alle 30 Sek)');
            
            setInterval(async () => {
                if (!isFirebaseReady || !rides || rides.length === 0) return;
                
                const now = Date.now();
                
                for (const ride of rides) {
                    // Nur vorbestellte Fahrten prÃ¼fen
                    if (ride.status !== 'vorbestellt') continue;
                    
                    const rideKey = ride.firebaseId || ride.id;
                    if (activatedPrebookings.has(rideKey)) continue; // Schon aktiviert
                    
                    // PrÃ¼fe ob Abholzeit in <= 15 Minuten
                    const pickupTime = ride.pickupTimestamp || 0;
                    const minutesUntilPickup = (pickupTime - now) / (1000 * 60);
                    
                    if (minutesUntilPickup <= 15 && minutesUntilPickup > -5) { // 15 Min vorher bis 5 Min danach
                        console.log('ğŸ“… AKTIVIERE Vorbestellung:', ride.customerName, '- Abholzeit in', Math.round(minutesUntilPickup), 'Min');
                        
                        // Status auf 'new' setzen
                        try {
                            await db.ref('rides/' + ride.firebaseId).update({
                                status: 'new',
                                activatedAt: Date.now(),
                                activatedFromPrebooking: true
                            });
                            
                            activatedPrebookings.add(rideKey);
                            
                            console.log('âœ… Vorbestellung aktiviert:', ride.customerName);
                            
                            // ğŸ¯ AUTO-ZUWEISUNG STARTEN!
                            const updatedRide = { ...ride, status: 'new' };
                            startAutoAssignment(ride.firebaseId, updatedRide);
                            
                            // Telegram Info
                            sendTelegramStatusUpdate(ride, 'vorbestellt', 'new');
                            
                        } catch (error) {
                            console.error('âŒ Fehler beim Aktivieren:', error);
                        }
                    }
                }
            }, 30000); // Alle 30 Sekunden prÃ¼fen
        }
        
        // Telegram Status anzeigen
        async function updateTelegramStatus() {
            const statusEl = document.getElementById('telegram-status');
            if (!statusEl || !isFirebaseReady) return;
            
            try {
                const snapshot = await db.ref('settings/telegram/adminChats').once('value');
                const adminChats = snapshot.val() || [];
                
                if (adminChats.length === 0) {
                    statusEl.innerHTML = 'âš ï¸ Noch keine Admins registriert';
                    statusEl.style.background = '#fef3c7';
                    statusEl.style.color = '#92400e';
                } else {
                    statusEl.innerHTML = `âœ… <b>${adminChats.length}</b> Admin${adminChats.length > 1 ? 's' : ''} registriert<br><small style="opacity:0.7;">Chat IDs: ${adminChats.join(', ')}</small>`;
                    statusEl.style.background = '#d1fae5';
                    statusEl.style.color = '#065f46';
                }
            } catch (error) {
                console.error('âŒ Status Update Fehler:', error);
            }
        }
        
        // Test-Nachricht senden
        async function sendTelegramTest() {
            if (!isFirebaseReady) {
                alert('âŒ Firebase nicht verbunden!');
                return;
            }
            
            try {
                const snapshot = await db.ref('settings/telegram/adminChats').once('value');
                const adminChats = snapshot.val() || [];
                
                if (adminChats.length === 0) {
                    alert('âŒ Keine Admins registriert! Bitte erst aktivieren.');
                    return;
                }
                
                const message = 'ğŸ§ª <b>TEST-NACHRICHT</b>\n\n' +
                    'âœ… Telegram-Alarme funktionieren!\n\n' +
                    'ğŸš• Funk Taxi Heringsdorf\n' +
                    `ğŸ“… ${new Date().toLocaleString('de-DE')}`;
                
                let success = 0;
                for (const chatId of adminChats) {
                    const sent = await sendTelegramMessage(chatId, message);
                    if (sent) success++;
                }
                
                alert(`âœ… Test-Nachricht gesendet an ${success}/${adminChats.length} Admin(s)!`);
                
            } catch (error) {
                console.error('âŒ Test-Nachricht Fehler:', error);
                alert('âŒ Fehler beim Senden!');
            }
        }
        
        // Telegram Updates abrufen (fÃ¼r automatische Registrierung)
        async function checkTelegramUpdates() {
            // Diese Funktion ist jetzt optional - manuelle Registrierung ist bevorzugt
            await updateTelegramStatus();
        }

        // ğŸ“… VORBESTELLUNGEN - ICS Export
        function exportPrebookingsToICS() {
            const prebookings = rides.filter(r => r.status === 'vorbestellt');
            
            if (prebookings.length === 0) {
                alert('ğŸ“… Keine Vorbestellungen vorhanden!');
                return;
            }
            
            // ICS Datei erstellen
            let icsContent = 'BEGIN:VCALENDAR\n';
            icsContent += 'VERSION:2.0\n';
            icsContent += 'PRODID:-//Funk Taxi Heringsdorf//DE\n';
            icsContent += 'CALSCALE:GREGORIAN\n';
            icsContent += 'METHOD:PUBLISH\n';
            icsContent += 'X-WR-CALNAME:Funk Taxi Vorbestellungen\n';
            icsContent += 'X-WR-TIMEZONE:Europe/Berlin\n';
            
            prebookings.forEach(ride => {
                const startDate = new Date(ride.pickupTimestamp);
                const endDate = new Date(ride.pickupTimestamp + 60 * 60000); // +1 Stunde
                
                // Formatiere Datum fÃ¼r ICS (YYYYMMDDTHHMMSS)
                const formatDate = (date) => {
                    const pad = (n) => n.toString().padStart(2, '0');
                    return date.getFullYear() + 
                           pad(date.getMonth() + 1) + 
                           pad(date.getDate()) + 'T' +
                           pad(date.getHours()) +
                           pad(date.getMinutes()) + '00';
                };
                
                icsContent += 'BEGIN:VEVENT\n';
                icsContent += `UID:${ride.id}@funktaxi-heringsdorf.de\n`;
                icsContent += `DTSTAMP:${formatDate(new Date())}\n`;
                icsContent += `DTSTART:${formatDate(startDate)}\n`;
                icsContent += `DTEND:${formatDate(endDate)}\n`;
                icsContent += `SUMMARY:ğŸš• Taxi ${ride.customerName}\n`;
                icsContent += `DESCRIPTION:Von: ${ride.pickup}\\nNach: ${ride.destination}\\nTel: ${ride.customerPhone}\\nPreis: ${ride.price}â‚¬\n`;
                icsContent += `LOCATION:${ride.pickup}\n`;
                icsContent += 'STATUS:CONFIRMED\n';
                icsContent += 'BEGIN:VALARM\n';
                icsContent += 'TRIGGER:-PT15M\n';
                icsContent += 'ACTION:DISPLAY\n';
                icsContent += `DESCRIPTION:Taxi-Abholung in 15 Minuten: ${ride.customerName}\n`;
                icsContent += 'END:VALARM\n';
                icsContent += 'END:VEVENT\n';
            });
            
            icsContent += 'END:VCALENDAR';
            
            // Download erstellen
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Taxi-Vorbestellungen_${new Date().toISOString().split('T')[0]}.ics`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert(`âœ… ${prebookings.length} Vorbestellung${prebookings.length > 1 ? 'en' : ''} exportiert!\n\nDatei wurde heruntergeladen.`);
        }
        
        // ğŸ“¥ EINZELNE FAHRT als ICS exportieren
        function exportSingleRideToICS(rideId) {
            // Finde die Fahrt
            const ride = rides.find(r => (r.firebaseId || r.id) === rideId);
            
            if (!ride) {
                alert('âŒ Fahrt nicht gefunden!');
                return;
            }
            
            if (!ride.pickupTimestamp) {
                alert('âŒ Keine Abholzeit vorhanden!');
                return;
            }
            
            // ICS Datei erstellen
            let icsContent = 'BEGIN:VCALENDAR\n';
            icsContent += 'VERSION:2.0\n';
            icsContent += 'PRODID:-//Funk Taxi Heringsdorf//DE\n';
            icsContent += 'CALSCALE:GREGORIAN\n';
            icsContent += 'METHOD:PUBLISH\n';
            icsContent += 'X-WR-CALNAME:Funk Taxi Heringsdorf\n';
            icsContent += 'X-WR-TIMEZONE:Europe/Berlin\n';
            
            const startDate = new Date(ride.pickupTimestamp);
            const endDate = new Date(ride.pickupTimestamp + 60 * 60000); // +1 Stunde
            
            // Formatiere Datum fÃ¼r ICS (YYYYMMDDTHHMMSS)
            const formatDate = (date) => {
                const pad = (n) => n.toString().padStart(2, '0');
                return date.getFullYear() + 
                       pad(date.getMonth() + 1) + 
                       pad(date.getDate()) + 'T' +
                       pad(date.getHours()) +
                       pad(date.getMinutes()) + '00';
            };
            
            icsContent += 'BEGIN:VEVENT\n';
            icsContent += `UID:${ride.id}@funktaxi-heringsdorf.de\n`;
            icsContent += `DTSTAMP:${formatDate(new Date())}\n`;
            icsContent += `DTSTART:${formatDate(startDate)}\n`;
            icsContent += `DTEND:${formatDate(endDate)}\n`;
            icsContent += `SUMMARY:ğŸš• Taxi ${ride.customerName}\n`;
            icsContent += `DESCRIPTION:Kunde: ${ride.customerName}\\nTelefon: ${ride.customerPhone}\\n\\nVon: ${ride.pickup}\\nNach: ${ride.destination}\\n\\nPreis: ${ride.price}â‚¬\\nDistanz: ${ride.distance} km\n`;
            icsContent += `LOCATION:${ride.pickup}\n`;
            icsContent += 'STATUS:CONFIRMED\n';
            
            // Erinnerung 30 Minuten vorher
            icsContent += 'BEGIN:VALARM\n';
            icsContent += 'TRIGGER:-PT30M\n';
            icsContent += 'ACTION:DISPLAY\n';
            icsContent += `DESCRIPTION:ğŸš• Taxi-Abholung in 30 Minuten\\n\\nKunde: ${ride.customerName}\\nVon: ${ride.pickup}\\nNach: ${ride.destination}\n`;
            icsContent += 'END:VALARM\n';
            
            icsContent += 'END:VEVENT\n';
            icsContent += 'END:VCALENDAR';
            
            // Dateiname mit Datum und Kundenname
            const dateStr = startDate.toISOString().split('T')[0];
            const timeStr = startDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }).replace(':', '');
            const safeName = ride.customerName.replace(/[^a-zA-Z0-9Ã¤Ã¶Ã¼Ã„Ã–ÃœÃŸ]/g, '_');
            const fileName = `Taxi_${safeName}_${dateStr}_${timeStr}.ics`;
            
            // ğŸ“± MOBILE vs DESKTOP Detection
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            if (isMobile && navigator.share) {
                // ğŸ“± MOBILE: Web Share API
                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const file = new File([blob], fileName, { type: 'text/calendar' });
                
                navigator.share({
                    files: [file],
                    title: `ğŸš• Taxi ${ride.customerName}`,
                    text: `Taxi-Fahrt am ${startDate.toLocaleDateString('de-DE')}`
                }).then(() => {
                    console.log('âœ… Erfolgreich geteilt');
                }).catch((error) => {
                    console.error('âŒ Share-Fehler:', error);
                    // Fallback zu Download
                    downloadICS(icsContent, fileName, ride, startDate);
                });
            } else {
                // ğŸ’» DESKTOP: Standard Download
                downloadICS(icsContent, fileName, ride, startDate);
            }
        }
        
        // ğŸ“¥ Helper: ICS Download
        function downloadICS(icsContent, fileName, ride, startDate) {
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            // BestÃ¤tigung
            const formattedDate = startDate.toLocaleDateString('de-DE', { 
                weekday: 'short', 
                day: '2-digit', 
                month: '2-digit',
                year: 'numeric'
            });
            const formattedTime = startDate.toLocaleTimeString('de-DE', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            alert(`âœ… Fahrt exportiert!\n\nğŸ“… ${ride.customerName}\nğŸ• ${formattedDate}, ${formattedTime}\n\nâœ… Kalender-Termin wurde heruntergeladen.\n\nğŸ’¡ Tipp: Ã–ffne die .ics-Datei um sie zu deinem Kalender hinzuzufÃ¼gen.`);
        }
        
        // Vorbestellungen-Liste aktualisieren
        function updatePrebookingsList() {
            const listEl = document.getElementById('prebookings-list');
            if (!listEl) return;
            
            const prebookings = rides.filter(r => r.status === 'vorbestellt')
                .sort((a, b) => a.pickupTimestamp - b.pickupTimestamp);
            
            if (prebookings.length === 0) {
                listEl.innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Keine Vorbestellungen</div>';
                return;
            }
            
            listEl.innerHTML = prebookings.map(r => {
                const date = new Date(r.pickupTimestamp);
                const dateStr = date.toLocaleDateString('de-DE', { 
                    day: '2-digit', 
                    month: '2-digit',
                    weekday: 'short'
                });
                const timeStr = date.toLocaleTimeString('de-DE', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                return `
                    <div style="background:#f9fafb;padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid #8b5cf6;">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
                            <div>
                                <div style="font-weight:600;font-size:15px;">${r.customerName}</div>
                                <div style="color:#666;font-size:13px;">ğŸ“ ${r.customerPhone}</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-weight:600;color:#8b5cf6;">${dateStr}</div>
                                <div style="font-size:15px;">${timeStr}</div>
                            </div>
                        </div>
                        <div style="font-size:13px;color:#666;line-height:1.6;">
                            ğŸ“ <b>Von:</b> ${r.pickup}<br>
                            ğŸ¯ <b>Nach:</b> ${r.destination}<br>
                            ğŸ’° <b>Preis:</b> ${r.price}â‚¬
                        </div>
                    </div>
                `;
            }).join('');
        }

        function calculatePrice(distance, timestamp = null) {
            // Nutze entweder Ã¼bergebenen timestamp oder jetzt
            const calcTime = timestamp ? new Date(timestamp) : new Date();
            const hour = calcTime.getHours(), day = calcTime.getDay();
            
            // PrÃ¼fe ob Nachttarif (Mo-Sa 22-6 Uhr, Sonntag ganztÃ¤gig)
            const isNight = (hour >= 22 || hour < 6) || (day === 0);
            
            // WÃ¤hle Tarif
            const grundgebuehr = isNight ? TARIF.nacht_grundgebuehr : TARIF.grundgebuehr;
            const km_1_2 = isNight ? TARIF.nacht_km_1_2 : TARIF.km_1_2;
            const km_3_4 = isNight ? TARIF.nacht_km_3_4 : TARIF.km_3_4;
            const km_ab_5 = isNight ? TARIF.nacht_km_ab_5 : TARIF.km_ab_5;
            
            // Gestaffelte Berechnung
            let kmPreis = 0;
            if (distance <= 2) {
                // 0-2 km: 3,30â‚¬ pro km
                kmPreis = distance * km_1_2;
            } else if (distance <= 4) {
                // 2-4 km: erste 2 km Ã  3,30â‚¬ + Rest Ã  2,80â‚¬
                kmPreis = (2 * km_1_2) + ((distance - 2) * km_3_4);
            } else {
                // >4 km: erste 2 km Ã  3,30â‚¬ + nÃ¤chste 2 km Ã  2,80â‚¬ + Rest Ã  2,20â‚¬
                kmPreis = (2 * km_1_2) + (2 * km_3_4) + ((distance - 4) * km_ab_5);
            }
            
            let base = grundgebuehr + kmPreis;
            let text = [];
            
            // Nachttarif-Hinweis
            if (isNight) {
                text.push('Nachttarif');
            }
            
            // ğŸ’° SURGE PRICING ANWENDEN
            const surge = getCurrentMultiplier();
            let finalPrice = base * surge.factor;
            
            // Surge-Hinweis fÃ¼r Kunde
            if (surge.multiplier > 100) {
                text.push(`ğŸ“ˆ +${surge.multiplier - 100}% Nachfrage`);
            } else if (surge.multiplier < 100) {
                text.push(`ğŸ‰ ${surge.multiplier - 100}% Rabatt`);
            }
            
            const totalRounded = Math.round(finalPrice / 0.1) * 0.1; // Runde auf 10 Cent
            
            return { 
                total: totalRounded.toFixed(2), 
                zuschlagText: text, 
                distance,
                basePrice: base.toFixed(2),
                surgeMultiplier: surge.multiplier
            };
        }

        // AUTOCOMPLETE
        let autocompleteTimeout = null;
        
        function setupAutocomplete() {
            ['pickup', 'destination'].forEach(id => {
                const input = document.getElementById(id);
                const dropdown = document.getElementById(id + '-dropdown');
                
                input.addEventListener('input', (e) => {
                    // Reset coords wenn User manuell tippt
                    if (id === 'pickup') pickupCoords = null;
                    else destCoords = null;
                    
                    clearTimeout(autocompleteTimeout);
                    const value = e.target.value.trim();
                    
                    if (value.length < 3) {
                        dropdown.style.display = 'none';
                        return;
                    }
                    
                    // Zeige "LÃ¤dt..." sofort
                    dropdown.innerHTML = '<div class="autocomplete-item" style="color:#999;">Suche...</div>';
                    dropdown.style.display = 'block';
                    
                    // VerzÃ¶gerte Suche (Debounce)
                    autocompleteTimeout = setTimeout(() => {
                        searchAddresses(value, id);
                    }, 300);
                });
                
                // SchlieÃŸe Dropdown wenn auÃŸerhalb geklickt
                document.addEventListener('click', (e) => {
                    if (e.target !== input && !dropdown.contains(e.target)) {
                        dropdown.style.display = 'none';
                    }
                });
            });
            
            // NOTE: pickup-time Element entfernt in v5.30.0 (Sofort/Vorbestellen UX)
            // Alter Event-Listener nicht mehr benÃ¶tigt
            const oldPickupTime = document.getElementById('pickup-time');
            if (oldPickupTime) {
                oldPickupTime.addEventListener('change', (e) => {
                    const customTime = document.getElementById('custom-time');
                    if (customTime) {
                        if (e.target.value === 'custom') customTime.style.display = 'block';
                        else customTime.style.display = 'none';
                    }
                });
            }
        }

        async function searchAddresses(query, inputId) {
            const dropdown = document.getElementById(inputId + '-dropdown');
            
            try {
                // Suche mit Nominatim API
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?` +
                    `format=json&` +
                    `q=${encodeURIComponent(query)}&` +
                    `countrycodes=de&` +
                    `limit=8&` +
                    `addressdetails=1`
                );
                
                const results = await response.json();
                
                if (results.length === 0) {
                    dropdown.innerHTML = '<div class="autocomplete-item" style="color:#999;">Keine Ergebnisse</div>';
                    return;
                }
                
                // Filtere nur Usedom-relevante Ergebnisse
                const usedomResults = results.filter(r => {
                    const display = r.display_name.toLowerCase();
                    return display.includes('usedom') || 
                           display.includes('heringsdorf') || 
                           display.includes('ahlbeck') ||
                           display.includes('bansin') ||
                           display.includes('zinnowitz') ||
                           display.includes('karlshagen') ||
                           display.includes('peenemÃ¼nde') ||
                           display.includes('koserow') ||
                           display.includes('Ã¼ckeritz') ||
                           display.includes('loddin') ||
                           display.includes('zempin') ||
                           display.includes('trassenheide');
                });
                
                const resultsToShow = usedomResults.length > 0 ? usedomResults : results;
                
                dropdown.innerHTML = resultsToShow.map(r => {
                    const address = r.address;
                    let displayText = '';
                    let fullAddress = '';
                    
                    // ğŸ¨ HOTEL, RESTAURANT, POI Namen (z.B. "Pommerscher Hof")
                    const poiName = address.amenity || address.tourism || address.building || r.name;
                    
                    // Baue Haupt-Adresszeile
                    if (address.road) {
                        fullAddress = address.road;
                        if (address.house_number) fullAddress += ' ' + address.house_number;
                    }
                    
                    // Ort
                    let city = '';
                    if (address.village) city = address.village;
                    else if (address.town) city = address.town;
                    else if (address.city) city = address.city;
                    else if (address.municipality) city = address.municipality;
                    
                    // PLZ
                    const zip = address.postcode || '';
                    
                    // ğŸ¨ Baue schÃ¶ne Anzeige
                    if (poiName && poiName !== fullAddress && poiName !== city) {
                        // Zeige: "ğŸ¨ Pommerscher Hof" in erster Zeile
                        displayText = `<div style="font-weight:600;color:#667eea;">ğŸ¨ ${poiName}</div>`;
                        // Zeige: "   SeestraÃŸe 41, 17424 Heringsdorf" in zweiter Zeile
                        displayText += `<div style="font-size:13px;color:#666;margin-top:2px;padding-left:20px;">`;
                        if (fullAddress) displayText += fullAddress;
                        if (zip) displayText += ', ' + zip;
                        if (city) displayText += ' ' + city;
                        displayText += '</div>';
                    } else {
                        // Normale Adresse ohne POI
                        if (fullAddress) {
                            displayText = fullAddress;
                            if (zip) displayText += ', ' + zip;
                            if (city) displayText += ' ' + city;
                        } else {
                            displayText = r.display_name;
                        }
                    }
                    
                    // FÃ¼r selectAddress: VollstÃ¤ndige Adresse als String
                    let addressString = '';
                    if (poiName && poiName !== fullAddress && poiName !== city) {
                        addressString = poiName + ' ';
                    }
                    if (fullAddress) addressString += fullAddress;
                    if (zip) addressString += ', ' + zip;
                    if (city) addressString += ' ' + city;
                    
                    if (!addressString) addressString = r.display_name;
                    
                    return `<div class="autocomplete-item" 
                        onclick="selectAddress('${inputId}', '${addressString.replace(/'/g, "\\'")}', ${r.lat}, ${r.lon})">
                        ${displayText}
                    </div>`;
                }).join('');
                
            } catch (e) {
                console.error('Autocomplete Fehler:', e);
                dropdown.innerHTML = '<div class="autocomplete-item" style="color:#ef4444;">Fehler bei der Suche</div>';
            }
        }

        function selectAddress(inputId, address, lat, lon) {
            document.getElementById(inputId).value = address;
            document.getElementById(inputId + '-dropdown').style.display = 'none';
            
            // Speichere Koordinaten
            if (inputId === 'pickup') {
                pickupCoords = { lat: parseFloat(lat), lon: parseFloat(lon) };
                console.log('âœ… Abholort gespeichert:', address, pickupCoords);
                
                // ğŸ†• v5.30.0: NUR bei "Sofort" Taxis laden!
                if (currentRideType === 'sofort') {
                    const display = document.getElementById('available-taxis-display');
                    display.innerHTML = `
                        <div style="padding:20px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:12px;text-align:center;margin-top:10px;">
                            <div style="font-size:20px;margin-bottom:10px;">ğŸ“</div>
                            <div style="font-weight:600;font-size:16px;margin-bottom:5px;">Position wird geladen...</div>
                            <div style="font-size:13px;opacity:0.9;">ğŸ” Suche verfÃ¼gbare Taxis in der NÃ¤he...</div>
                        </div>
                    `;
                    
                    setTimeout(() => {
                        showAvailableTaxis();
                    }, 1000);
                }
            } else {
                destCoords = { lat: parseFloat(lat), lon: parseFloat(lon) };
                console.log('âœ… Zielort gespeichert:', address, destCoords);
            }
        }

        // LOCATION
        function useMyLocation() {
            if (!navigator.geolocation) {
                alert('âŒ GPS nicht verfÃ¼gbar!');
                return;
            }
            
            console.log('ğŸ“ GPS wird abgerufen...');
            
            navigator.geolocation.getCurrentPosition(
                async (pos) => {
                    pickupCoords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                    console.log('âœ… Abholort gespeichert (GPS):', pickupCoords);
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pickupCoords.lat}&lon=${pickupCoords.lon}`);
                        const data = await response.json();
                        const address = data.address;
                        const street = address.road || address.pedestrian || '';
                        const houseNumber = address.house_number || '';
                        const city = address.town || address.village || address.city || 'Heringsdorf';
                        const addressString = `${street} ${houseNumber}, ${city}`.trim();
                        document.getElementById('pickup').value = addressString;
                        console.log('âœ… Adresse aufgelÃ¶st:', addressString);
                        
                        // ğŸ†• v5.30.0: NUR bei "Sofort" Taxis laden!
                        if (currentRideType === 'sofort') {
                            const display = document.getElementById('available-taxis-display');
                            display.innerHTML = `
                                <div style="padding:20px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:12px;text-align:center;margin-top:10px;">
                                    <div style="font-size:20px;margin-bottom:10px;">ğŸ“</div>
                                    <div style="font-weight:600;font-size:16px;margin-bottom:5px;">Position wird geladen...</div>
                                    <div style="font-size:13px;opacity:0.9;">ğŸ” Suche verfÃ¼gbare Taxis in der NÃ¤he...</div>
                                </div>
                            `;
                            
                            setTimeout(() => {
                                showAvailableTaxis();
                            }, 1000);
                        }
                    } catch (e) {
                        console.error('âŒ Reverse Geocoding Fehler:', e);
                        document.getElementById('pickup').value = `${pickupCoords.lat.toFixed(4)}, ${pickupCoords.lon.toFixed(4)}`;
                    }
                },
                (err) => {
                    console.error('âŒ GPS-Fehler:', err);
                    // ğŸ†• NICHT BLOCKIEREND! Nutzer kann manuell eingeben
                    const pickupField = document.getElementById('pickup');
                    if (pickupField) {
                        pickupField.placeholder = 'âš ï¸ GPS nicht verfÃ¼gbar - bitte manuell eingeben';
                        pickupField.focus();
                    }
                    
                    // Zeige Info-Banner statt blockendem Alert
                    const banner = document.createElement('div');
                    banner.style.cssText = 'position:fixed;top:60px;left:10px;right:10px;background:#fef3c7;padding:15px;border-radius:8px;border:2px solid #f59e0b;z-index:9999;text-align:center;';
                    banner.innerHTML = `
                        <div style="font-weight:600;margin-bottom:5px;">âš ï¸ GPS nicht verfÃ¼gbar</div>
                        <div style="font-size:13px;">Bitte gib deinen Abholort manuell ein</div>
                        <button onclick="this.parentElement.remove()" style="margin-top:10px;padding:8px 16px;background:#f59e0b;color:white;border:none;border-radius:6px;font-weight:600;">OK</button>
                    `;
                    document.body.appendChild(banner);
                    setTimeout(() => banner.remove(), 5000);
                }
            );
        }

        async function showAvailableTaxis() {
            console.log('ğŸ“ showAvailableTaxis aufgerufen - pickupCoords:', pickupCoords, 'isFirebaseReady:', isFirebaseReady);
            
            // âœ… NUR ZEIGEN WENN GÃœLTIGE ABHOLADRESSE!
            if (!pickupCoords) {
                document.getElementById('available-taxis-display').innerHTML = '';
                return;
            }
            
            // ğŸ†• v5.27.1: WARTE AUF FIREBASE!
            if (!isFirebaseReady) {
                console.log('â³ Warte auf Firebase...');
                document.getElementById('available-taxis-display').innerHTML = `
                    <div style="padding:20px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:12px;text-align:center;margin-top:10px;">
                        <div style="font-size:20px;margin-bottom:10px;">â³</div>
                        <div style="font-weight:600;font-size:16px;margin-bottom:5px;">Verbinde mit Server...</div>
                        <div style="font-size:13px;opacity:0.9;">Einen Moment bitte...</div>
                    </div>
                `;
                
                // Versuche erneut nach 2 Sekunden
                setTimeout(() => {
                    if (pickupCoords) {
                        showAvailableTaxis();
                    }
                }, 2000);
                return;
            }
            
            const onlineDrivers = Object.values(drivers).filter(d => d.online && d.timestamp && (Date.now() - d.timestamp) < 120000);
            console.log('ğŸš• Online Fahrer gefunden:', onlineDrivers.length);
            
            // ğŸ†• v5.26.14i: BESSERE "KEINE TAXIS"-MELDUNG
            if (onlineDrivers.length === 0) {
                document.getElementById('available-taxis-display').innerHTML = `
                    <div style="padding:20px;background:#fef3c7;border:2px solid #f59e0b;border-radius:12px;margin-top:10px;">
                        <div style="text-align:center;margin-bottom:15px;">
                            <div style="font-size:32px;margin-bottom:8px;">âš ï¸</div>
                            <div style="font-weight:700;font-size:16px;color:#92400e;margin-bottom:5px;">
                                Aktuell keine Taxis verfÃ¼gbar
                            </div>
                            <div style="font-size:13px;color:#78350f;">
                                Alle Fahrer sind gerade unterwegs
                            </div>
                        </div>
                        <div style="background:white;padding:15px;border-radius:8px;text-align:center;">
                            <div style="font-weight:600;color:#1e40af;margin-bottom:8px;">ğŸ“ Bitte direkt anrufen:</div>
                            <a href="tel:038378" style="display:inline-block;padding:12px 20px;background:#3b82f6;color:white;text-decoration:none;border-radius:8px;font-weight:700;font-size:18px;">
                                038378 / 1234
                            </a>
                            <div style="font-size:12px;color:#666;margin-top:8px;">
                                Wir helfen Ihnen gerne weiter!
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            const taxisWithETA = await Promise.all(onlineDrivers.map(async (d) => {
                const route = await calculateRoute(d, pickupCoords);
                return { ...d, ...route };
            }));
            
            taxisWithETA.sort((a, b) => a.distance - b.distance);
            
            // ğŸ†• v5.26.14i: SCHÃ–NERE TAXI-ANZEIGE
            const html = `
                <div class="available-taxis" style="margin-top:10px;">
                    <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:15px;border-radius:12px;text-align:center;margin-bottom:10px;">
                        <div style="font-size:20px;margin-bottom:5px;">ğŸš•</div>
                        <div style="font-weight:700;font-size:18px;margin-bottom:3px;">
                            ${taxisWithETA.length} ${taxisWithETA.length === 1 ? 'Taxi' : 'Taxis'} verfÃ¼gbar!
                        </div>
                        <div style="font-size:14px;opacity:0.9;">
                            NÃ¤chstes Taxi in ca. ${taxisWithETA[0].duration} Minuten
                        </div>
                    </div>
                    ${taxisWithETA.slice(0, 3).map(t => {
                        const plate = VEHICLES[t.vehicleId] ? VEHICLES[t.vehicleId].plate : '';
                        return `
                            <div class="taxi-item" style="background:#f0fdfa;border:2px solid #14b8a6;padding:12px;border-radius:8px;margin-bottom:8px;">
                                <div style="font-weight:600;font-size:15px;color:#0f766e;margin-bottom:4px;">
                                    ${t.vehicle}
                                </div>
                                ${plate ? `<div style="font-size:13px;color:#14b8a6;margin-bottom:6px;">ğŸš— ${plate}</div>` : ''}
                                <div style="font-size:13px;color:#0f766e;">
                                    ğŸ“ ${t.distance} km entfernt â€¢ â±ï¸ ca. ${t.duration} Min
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            document.getElementById('available-taxis-display').innerHTML = html;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.32.5g: PRÃœFE FAHRER-VERFÃœGBARKEIT â†’ SOFORT-BUTTON ZEIGEN/VERSTECKEN
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function checkDriverAvailability() {
            console.log('ğŸ” PrÃ¼fe Fahrer-VerfÃ¼gbarkeit...');
            
            const sofortBtn = document.getElementById('btn-sofort');
            if (!sofortBtn) {
                console.log('âš ï¸ SOFORT-Button nicht gefunden');
                return;
            }
            
            // PrÃ¼fe ob mindestens 1 Fahrer ONLINE oder BESETZT (busy)
            let hasAvailableDriver = false;
            
            for (const driverId in drivers) {
                const driver = drivers[driverId];
                
                // ONLINE = VerfÃ¼gbar
                if (driver.online && driver.timestamp && (Date.now() - driver.timestamp) < 120000) {
                    hasAvailableDriver = true;
                    console.log('âœ… Fahrer verfÃ¼gbar (online):', driver.vehicle || driverId);
                    break;
                }
                
                // BESETZT = Hat Fahrt, aber angemeldet
                // Status kann sein: 'busy', 'assigned', 'picked_up', 'ongoing'
                if (driver.status && ['busy', 'assigned', 'picked_up', 'ongoing'].includes(driver.status)) {
                    // PrÃ¼fe ob Timestamp aktuell (innerhalb 2 Min)
                    if (driver.timestamp && (Date.now() - driver.timestamp) < 120000) {
                        hasAvailableDriver = true;
                        console.log('âœ… Fahrer verfÃ¼gbar (besetzt aber angemeldet):', driver.vehicle || driverId);
                        break;
                    }
                }
            }
            
            // SOFORT-Button zeigen/verstecken
            const buttonsContainer = document.getElementById('ride-type-buttons-container');
            
            if (hasAvailableDriver) {
                sofortBtn.style.display = 'block';
                if (buttonsContainer) {
                    buttonsContainer.style.gridTemplateColumns = '1fr 1fr'; // 2 Spalten
                }
                console.log('âœ… SOFORT-Button ANGEZEIGT - Fahrer verfÃ¼gbar!');
            } else {
                sofortBtn.style.display = 'none';
                if (buttonsContainer) {
                    buttonsContainer.style.gridTemplateColumns = '1fr'; // 1 Spalte (VORBESTELLEN volle Breite)
                }
                console.log('âŒ SOFORT-Button VERSTECKT - Keine Fahrer verfÃ¼gbar!');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // ğŸ†• PREIS-BUTTON HANDLER - wechselt zwischen "Preis berechnen" und "Abbrechen"
        let priceCalculated = false;
        
        function handlePriceButton() {
            if (priceCalculated) {
                // Abbrechen-Modus: Reset
                cancelBooking();
            } else {
                // Preis-berechnen-Modus
                calculatePriceAndShow();
            }
        }
        
        // ğŸ†• BUCHUNG ABBRECHEN - setzt alles zurÃ¼ck
        function cancelBooking() {
            // ğŸ†• BestÃ¤tigungsdialog
            const confirmed = confirm('â†©ï¸ Buchung wirklich abbrechen?\n\nAlle eingegebenen Daten werden gelÃ¶scht.');
            if (!confirmed) return;
            
            // Felder leeren
            document.getElementById('pickup').value = '';
            document.getElementById('destination').value = '';
            // NOTE: pickup-time Element entfernt in v5.30.0
            const oldPickupTime = document.getElementById('pickup-time');
            if (oldPickupTime) oldPickupTime.value = 'jetzt';
            document.getElementById('passengers').value = '1';
            
            // Karte verstecken
            const routeMap = document.getElementById('route-map');
            if (routeMap) routeMap.style.display = 'none';
            
            // Preis verstecken
            document.getElementById('price-display').innerHTML = '';
            
            // Taxi buchen Button verstecken
            document.getElementById('book-btn').style.display = 'none';
            
            // VerfÃ¼gbare Taxis verstecken
            document.getElementById('available-taxis-display').innerHTML = '';
            
            // Button zurÃ¼ck zu "Preis berechnen"
            const priceBtn = document.getElementById('price-btn');
            priceBtn.innerHTML = 'ğŸ’° Preis berechnen';
            priceBtn.classList.remove('btn-danger');
            priceBtn.classList.add('btn-primary');
            
            // Status zurÃ¼cksetzen
            priceCalculated = false;
            window.currentPrice = null;
            window.currentDistance = null;
            window.currentDuration = null;
            pickupCoords = null;
            destCoords = null;
            
            console.log('â†©ï¸ Buchung abgebrochen');
        }

        // BOOKING
        async function calculatePriceAndShow() {
            const pickup = document.getElementById('pickup').value.trim();
            const destination = document.getElementById('destination').value.trim();
            
            if (!pickup || !destination) {
                alert('âŒ Bitte Abholort und Zielort eingeben!');
                return;
            }
            
            // Wenn Coords noch nicht vorhanden (User hat nicht aus Autocomplete gewÃ¤hlt), geocode
            if (!pickupCoords) {
                pickupCoords = await geocode(pickup);
                if (!pickupCoords) {
                    alert('âŒ Abholort "' + pickup + '" nicht gefunden!\n\nTipp: Nutze die Autocomplete-VorschlÃ¤ge');
                    return;
                }
            }
            
            if (!destCoords) {
                destCoords = await geocode(destination);
                if (!destCoords) {
                    alert('âŒ Zielort "' + destination + '" nicht gefunden!\n\nTipp: Nutze die Autocomplete-VorschlÃ¤ge');
                    return;
                }
            }
            
            const route = await calculateRoute(pickupCoords, destCoords);
            
            // Hole Abholzeit fÃ¼r korrekte Tarifberechnung
            // ğŸ†• v5.30.0: Alte pickup-time gibt es nicht mehr, nutze Fallback
            const oldPickupTimeElem = document.getElementById('pickup-time');
            const pickupTimeSelect = oldPickupTimeElem ? oldPickupTimeElem.value : 'sofort';
            // ğŸ†• SOFORT = +5 Min Vorlauf fÃ¼r Logik-StabilitÃ¤t
            let pickupTimestamp = Date.now() + 5 * 60000;
            
            if (pickupTimeSelect === '15min') {
                pickupTimestamp = Date.now() + 15 * 60000;
            } else if (pickupTimeSelect === '30min') {
                pickupTimestamp = Date.now() + 30 * 60000;
            } else if (pickupTimeSelect === '1h') {
                pickupTimestamp = Date.now() + 60 * 60000;
            } else if (pickupTimeSelect === 'datetime') {
                // ğŸ†• Lese aus neuen Feldern (Datum + Stunde + Minute)
                const dateVal = document.getElementById('custom-date').value;
                const hourVal = document.getElementById('custom-hour').value;
                const minuteVal = document.getElementById('custom-minute').value;
                if (dateVal && hourVal && minuteVal) {
                    pickupTimestamp = new Date(`${dateVal}T${hourVal}:${minuteVal}:00`).getTime();
                }
            }
            
            // Berechne Preis MIT Zeitstempel (fÃ¼r korrekten Tag/Nacht-Tarif)
            const pricing = calculatePrice(parseFloat(route.distance), pickupTimestamp);
            
            window.currentPrice = pricing.total;
            window.currentDistance = route.distance;
            window.currentDuration = route.duration;
            
            let priceHtml = `<div style="background:white;padding:15px;border-radius:8px;border:2px solid #10b981;">
                <div style="font-size:32px;font-weight:bold;color:#10b981;text-align:center;">${pricing.total}â‚¬</div>
                <div style="text-align:center;margin-top:8px;color:#666;">
                    ${route.distance} km â€¢ ${route.duration} Min Fahrt
                </div>`;
            
            if (pricing.zuschlagText.length > 0) {
                priceHtml += `<div style="margin-top:10px;padding:8px;background:#fef3c7;border-radius:6px;font-size:13px;text-align:center;">
                    ${pricing.zuschlagText.join(' â€¢ ')}
                </div>`;
            }
            
            priceHtml += '</div>';
            
            const priceDisplay = document.getElementById('price-display');
            priceDisplay.innerHTML = priceHtml;
            priceDisplay.style.display = 'block';
            
            // ğŸ—ºï¸ ROUTE-KARTE ANZEIGEN
            showRouteMap(route, pickupCoords, destCoords);
            
            const bookBtn = document.getElementById('book-btn');
            if (bookBtn) {
                bookBtn.style.display = 'block';
                bookBtn.style.visibility = 'visible';
            }
            
            // ğŸ†• PREIS-BUTTON ZU ABBRECHEN Ã„NDERN
            const priceBtn = document.getElementById('price-btn');
            if (priceBtn) {
                priceBtn.innerHTML = 'â†©ï¸ Abbrechen';
                priceBtn.classList.remove('btn-primary');
                priceBtn.classList.add('btn-danger');
            }
            priceCalculated = true;
        }

        // ğŸ—ºï¸ ROUTE-KARTE ANZEIGEN
        let routeMapInstance = null;
        function showRouteMap(route, pickupCoords, destCoords) {
            const mapContainer = document.getElementById('route-map');
            mapContainer.style.display = 'block';
            
            // Karte entfernen falls vorhanden
            if (routeMapInstance) {
                routeMapInstance.remove();
            }
            
            // Neue Karte erstellen - 2-Finger-Zoom, 1-Finger scrollt Seite
            routeMapInstance = L.map('route-map', {
                zoomControl: false,
                attributionControl: false,
                dragging: false,           // Kein Drag mit 1 Finger
                tap: false,                // Kein Tap-Drag
                scrollWheelZoom: false,    // Kein Scroll-Zoom
                touchZoom: true            // Pinch-Zoom mit 2 Fingern erlaubt
            });
            
            // OpenStreetMap Tiles laden
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19
            }).addTo(routeMapInstance);
            
            // Start Marker (grÃ¼n)
            L.marker([pickupCoords.lat, pickupCoords.lon], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background:#10b981;width:24px;height:24px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);"></div>',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                })
            }).addTo(routeMapInstance);
            
            // Ziel Marker (rot)
            L.marker([destCoords.lat, destCoords.lon], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background:#ef4444;width:24px;height:24px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);"></div>',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                })
            }).addTo(routeMapInstance);
            
            // Route-Linie zeichnen (aus geometry)
            if (route.geometry && route.geometry.length > 0) {
                const routeLine = L.polyline(
                    route.geometry.map(coord => [coord[1], coord[0]]), // [lon, lat] â†’ [lat, lon]
                    {
                        color: '#667eea',
                        weight: 5,
                        opacity: 0.8
                    }
                ).addTo(routeMapInstance);
                
                // Zoom auf Route
                routeMapInstance.fitBounds(routeLine.getBounds(), { padding: [30, 30] });
            } else {
                // Fallback: Zoom auf Start und Ziel
                routeMapInstance.fitBounds([
                    [pickupCoords.lat, pickupCoords.lon],
                    [destCoords.lat, destCoords.lon]
                ], { padding: [30, 30] });
            }
            
            console.log('ğŸ—ºï¸ Route-Karte angezeigt');
        }

        // ğŸ¯ INTELLIGENTE AUTO-ZUWEISUNG MIT 30-SEK-TIMER
        async function startAutoAssignment(rideId, ride) {
            console.log('ğŸ¯ startAutoAssignment aufgerufen fÃ¼r Fahrt:', rideId, 'Status:', ride?.status);
            console.log('ğŸ“ Aufruf-Stack:', new Error().stack.split('\n').slice(2, 4).join('\n'));
            
            // ğŸ›¡ï¸ WICHTIG: PrÃ¼fe ob Fahrt noch zuweisbar ist!
            if (isFirebaseReady) {
                try {
                    const currentRide = await db.ref('rides/' + rideId).once('value');
                    const rideData = currentRide.val();
                    
                    if (!rideData) {
                        console.log('â¹ï¸ Auto-Zuweisung abgebrochen - Fahrt existiert nicht mehr');
                        return;
                    }
                    
                    // âš ï¸ KRITISCH: Nur zuweisen wenn Status 'new' ist!
                    // Verhindert Doppel-Zuweisung bei accepted/assigned/cancelled Fahrten
                    if (rideData.status !== 'new') {
                        console.log('â¹ï¸ Auto-Zuweisung abgebrochen - Fahrt hat Status:', rideData.status, '(erwartet: new)');
                        console.log('ğŸ›¡ï¸ Verhindere Doppel-Zuweisung fÃ¼r rideId:', rideId);
                        return;
                    }
                } catch (error) {
                    console.error('âŒ Fehler beim PrÃ¼fen der Fahrt:', error);
                    return;
                }
            }
            
            // Finde nÃ¤chstes verfÃ¼gbares Taxi
            // ğŸ†• v5.21.8: Blacklist Ã¼bergeben um Endlos-Zuweisung zu verhindern
            const blacklist = ride.assignmentBlacklist || [];
            const nearestVehicle = findNearestAvailableVehicle(ride.pickupCoords, blacklist);
            
            if (!nearestVehicle) {
                console.log('âš ï¸ Kein Taxi verfÃ¼gbar - Fahrt bleibt in Warteschlange');
                
                // ğŸ†• v5.21.8: Unterscheide zwischen "keiner online" und "alle haben abgelehnt"
                if (blacklist.length > 0) {
                    console.log('ğŸ“‹ Blacklist hat', blacklist.length, 'Fahrer - alle haben nicht angenommen');
                    logActivity('assignment', 'all_rejected', `Alle ${blacklist.length} Fahrer haben nicht angenommen`, {
                        customer: ride.customerName,
                        from: ride.pickup,
                        to: ride.destination,
                        blacklist: blacklist.join(', ')
                    });
                } else {
                    // ğŸ“œ PROTOKOLL: Kein Fahrer verfÃ¼gbar
                    logActivity('assignment', 'no_driver', `Kein Fahrer verfÃ¼gbar fÃ¼r Fahrt`, {
                        customer: ride.customerName,
                        from: ride.pickup,
                        to: ride.destination
                    });
                }
                return;
            }
            
            console.log('âœ… NÃ¤chstes Taxi gefunden:', nearestVehicle.id, 'Entfernung:', nearestVehicle.distance.toFixed(2), 'km');
            
            // Markiere Fahrt als zugewiesen
            await db.ref('rides/' + rideId).update({
                status: 'assigned',  // ğŸš• WICHTIG: Fahrer ist jetzt BESETZT!
                assignedTo: nearestVehicle.id,
                assignedVehicleName: nearestVehicle.name,
                assignedAt: Date.now(),
                assignmentExpiresAt: Date.now() + 60000, // 60 Sekunden (erhÃ¶ht von 30!)
                assignmentDistance: nearestVehicle.distance
            });
            
            // ğŸ“œ PROTOKOLL: Fahrt zugewiesen
            logActivity('assignment', 'assigned', `Fahrt zugewiesen an ${nearestVehicle.name}`, {
                customer: ride.customerName,
                driver: nearestVehicle.name,
                vehicle: nearestVehicle.id,
                distance: nearestVehicle.distance.toFixed(2) + ' km',
                from: ride.pickup,
                to: ride.destination,
                price: ride.price
            });
            
            // Push-Benachrichtigung an Fahrer (lokal in der App)
            sendLocalNotification(
                'ğŸš• NEUE FAHRT!',
                `${ride.customerName || 'Fahrgast'} â€¢ ${ride.pickup} â†’ ${ride.destination}\nğŸ’° ${ride.price}â‚¬ â€¢ â±ï¸ 60 Sekunden Zeit!`,
                { rideId: rideId, vehicleId: nearestVehicle.id }
            );
            
            // ğŸ†• v5.18.0: TELEGRAM DIREKT AN FAHRER SENDEN!
            // Das ist der kritische Teil - Fahrer bekommt Telegram auch wenn App im Hintergrund!
            // ğŸ†• v5.19.0: GPS-Alter fÃ¼r Warnung Ã¼bergeben
            sendTelegramToDriver(nearestVehicle.id, ride, nearestVehicle.gpsAge || 0);
            
            // Starte 60-Sekunden-Timer
            assignmentTimers[rideId] = setTimeout(async () => {
                // PrÃ¼fe ob Fahrt in 60 Sek. angenommen wurde
                const rideCheck = await db.ref('rides/' + rideId).once('value');
                const rideData = rideCheck.val();
                
                // Wenn Status noch 'assigned' ist = Fahrer hat NICHT angenommen!
                if (rideData && rideData.status === 'assigned') {
                    console.log('â° TIMEOUT! Fahrt nicht angenommen - weise nÃ¤chstem Taxi zu');
                    
                    // ğŸ†• v5.25.6: TEMPORÃ„RE SPERRE FÃœR FAHRER (3 Minuten)
                    const blockUntil = Date.now() + (3 * 60 * 1000); // 3 Minuten
                    await db.ref('drivers/' + nearestVehicle.id + '/temporaryBlock').set({
                        blockedAt: Date.now(),
                        blockedUntil: blockUntil,
                        reason: 'Keine Reaktion auf Fahrt-Zuweisung',
                        rideId: rideId,
                        customerName: rideData.customerName
                    });
                    
                    console.log(`ğŸš« Fahrer ${nearestVehicle.name} fÃ¼r 3 Min. gesperrt (bis ${new Date(blockUntil).toLocaleTimeString('de-DE')})`);
                    
                    // ğŸ“œ PROTOKOLL: Timeout + Sperre
                    logActivity('assignment', 'driver_blocked', 
                        `âš ï¸ ${nearestVehicle.name} hat nicht reagiert â†’ 3 Min. Sperre`, {
                        customer: rideData.customerName,
                        driver: nearestVehicle.name,
                        vehicle: nearestVehicle.id,
                        blockedUntil: new Date(blockUntil).toLocaleTimeString('de-DE')
                    });
                    
                    // ğŸ“± TELEGRAM AN ADMIN
                    sendTelegramToAdmin(
                        `âš ï¸ <b>FAHRER REAGIERT NICHT!</b>\n\n` +
                        `ğŸš— Fahrer: ${nearestVehicle.name}\n` +
                        `ğŸ‘¤ Kunde: ${rideData.customerName || 'Unbekannt'}\n` +
                        `ğŸ“ Fahrt: ${rideData.pickup} â†’ ${rideData.destination}\n\n` +
                        `ğŸš« <b>3 Minuten Sperre aktiv</b>\n` +
                        `â° Bis: ${new Date(blockUntil).toLocaleTimeString('de-DE')}`
                    );
                    
                    // Zur Blacklist hinzufÃ¼gen (fÃ¼r diese Fahrt)
                    const blacklist = rideData.assignmentBlacklist || [];
                    blacklist.push(nearestVehicle.id);
                    
                    await db.ref('rides/' + rideId).update({
                        status: 'new',  // ğŸ”„ ZurÃ¼ck auf 'new' fÃ¼r nÃ¤chsten Fahrer!
                        assignedTo: null,
                        assignmentBlacklist: blacklist,
                        lastAssignmentTimeout: Date.now()
                    });
                    
                    // NÃ¤chstes Taxi zuweisen
                    startAutoAssignment(rideId, rideData);
                }
            }, 60000); // 60 Sekunden warten (erhÃ¶ht von 30!)
        }

        // Finde nÃ¤chstes verfÃ¼gbares Taxi nach GPS-Entfernung
        // ğŸ†• v5.19.0: Angepasst fÃ¼r Standby-Modus
        // ğŸ†• v5.21.8: Blacklist-Parameter um abgelehnte Fahrer zu Ã¼berspringen
        // ğŸ†• v5.25.6: TemporÃ¤re Sperre prÃ¼fen
        // Findet Fahrer auch wenn GPS nicht ganz aktuell (< 10 Min)
        function findNearestAvailableVehicle(pickupCoords, blacklist = []) {
            const availableVehicles = [];
            const now = Date.now();
            const MAX_GPS_AGE = 10 * 60 * 1000; // 10 Minuten
            
            // Durchsuche alle Fahrer (nicht nur online!)
            for (const vehicleId in drivers) {
                const driver = drivers[vehicleId];
                
                // ğŸ†• v5.21.8: Blacklist-Check ZUERST!
                if (blacklist.includes(vehicleId)) {
                    console.log(`â›” ${vehicleId}: Auf Blacklist (hat nicht angenommen)`);
                    continue;
                }
                
                // ğŸ†• v5.25.6: TemporÃ¤re Sperre prÃ¼fen
                if (driver.temporaryBlock && driver.temporaryBlock.blockedUntil > now) {
                    const remainingMinutes = Math.ceil((driver.temporaryBlock.blockedUntil - now) / 60000);
                    console.log(`ğŸš« ${vehicleId}: TemporÃ¤r gesperrt (noch ${remainingMinutes} Min.)`);
                    continue;
                }
                
                // PrÃ¼fungen:
                // 1. Hat GPS-Position
                // 2. Position ist nicht Ã¤lter als 10 Minuten
                // 3. Hat keine aktive Fahrt
                if (driver && driver.lat && driver.lon && driver.timestamp) {
                    const gpsAge = now - driver.timestamp;
                    const gpsAgeMinutes = Math.round(gpsAge / 60000);
                    
                    // Position zu alt? Ãœberspringen
                    if (gpsAge > MAX_GPS_AGE) {
                        console.log(`â° ${vehicleId}: GPS zu alt (${gpsAgeMinutes} Min)`);
                        continue;
                    }
                    
                    // PrÃ¼fe ob Fahrzeug bereits eine Fahrt hat
                    const hasActiveRide = rides.some(r => 
                        (r.vehicleId === vehicleId || r.assignedTo === vehicleId) && 
                        (r.status === 'assigned' || r.status === 'accepted' || r.status === 'picked_up')
                    );
                    
                    if (!hasActiveRide) {
                        // Berechne Entfernung
                        const distance = calculateDistance(
                            pickupCoords.lat, pickupCoords.lon,
                            driver.lat, driver.lon
                        );
                        
                        availableVehicles.push({
                            id: vehicleId,
                            name: driver.vehicle || VEHICLES[vehicleId]?.name || vehicleId,
                            distance: distance,
                            lat: driver.lat,
                            lon: driver.lon,
                            gpsAge: gpsAgeMinutes, // ğŸ†• Wie alt ist die Position?
                            isStandby: driver.mode === 'standby' || !driver.online, // ğŸ†• Ist im Standby?
                            telegramChatId: driver.telegramChatId // ğŸ†• FÃ¼r Telegram-Benachrichtigung
                        });
                    }
                }
            }
            
            // Sortiere nach Entfernung (nÃ¤chstes zuerst)
            availableVehicles.sort((a, b) => a.distance - b.distance);
            
            console.log('ğŸ“ VerfÃ¼gbare Taxis:', availableVehicles.length, availableVehicles);
            
            return availableVehicles.length > 0 ? availableVehicles[0] : null;
        }

        // Haversine-Formel fÃ¼r Entfernungsberechnung
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Erdradius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        async function book() {
            // âœ… BUGFIX v5.9.3: Version-Check entfernt!
            // Der alte Check rief nicht-existierende Funktionen auf und blockierte ALLE Buchungen!
            
            const customerName = document.getElementById('customer-name').value.trim();
            const customerPhone = document.getElementById('customer-phone').value.trim();
            
            if (!customerName) {
                alert('âŒ Bitte Name eingeben!');
                return;
            }
            
            if (!customerPhone) {
                alert('âŒ Bitte Telefonnummer eingeben!\n\nDie Telefonnummer wird benÃ¶tigt, damit der Fahrer Sie bei RÃ¼ckfragen erreichen kann.');
                document.getElementById('customer-phone').focus();
                return;
            }
            
            // ğŸ†• v5.30.0: Nutze currentRideType statt pickup-time Select
            let pickupTime = 'Sofort';
            let pickupTimestamp = Date.now() + 5 * 60000; // +5 Min Vorlauf
            let rideStatus = 'new';
            const now = new Date();
            
            if (currentRideType === 'sofort') {
                // âš¡ SOFORT-Buchung
                pickupTime = 'Sofort';
                pickupTimestamp = Date.now() + 5 * 60000;
                rideStatus = 'new';
                
            } else if (currentRideType === 'vorbestellen') {
                // ğŸ“… VORBESTELL-Buchung - Datum & Zeit direkt aus Feldern
                const dateVal = document.getElementById('custom-date').value;
                const hourVal = document.getElementById('custom-hour').value;
                const minuteVal = document.getElementById('custom-minute').value;
                
                if (!dateVal) {
                    alert('âŒ Bitte Datum auswÃ¤hlen!');
                    return;
                }
                
                const selectedDate = new Date(`${dateVal}T${hourVal}:${minuteVal}:00`);
                pickupTimestamp = selectedDate.getTime();
                
                // Formatiere als "22.11.2024, 08:00"
                pickupTime = selectedDate.toLocaleString('de-DE', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                // PrÃ¼fe ob in der Vergangenheit
                if (pickupTimestamp < Date.now()) {
                    alert('âŒ Die Abholzeit liegt in der Vergangenheit!\n\nBitte wÃ¤hle eine Zeit in der Zukunft.');
                    return;
                }
                
                // Warnung wenn sehr weit in der Zukunft (mehr als 7 Tage)
                const daysDiff = (pickupTimestamp - Date.now()) / (1000 * 60 * 60 * 24);
                if (daysDiff > 7) {
                    const confirm = window.confirm(
                        `ğŸ“… Buchung fÃ¼r ${Math.floor(daysDiff)} Tage im Voraus\n\n` +
                        `Abholung: ${pickupTime}\n\n` +
                        `MÃ¶chtest du diese Vorausbuchung bestÃ¤tigen?`
                    );
                    if (!confirm) return;
                }
                
                // ğŸ• Berechne Zeitdifferenz fÃ¼r Vorbestellungs-Logik
                const minutesUntilPickup = (pickupTimestamp - Date.now()) / (1000 * 60);
                
                // âš¡ Sofort (â‰¤15 Min) vs ğŸ“… Vorbestellung (>15 Min)
                rideStatus = minutesUntilPickup <= 15 ? 'new' : 'vorbestellt';
                
            } else {
                // Kein Ride-Type gewÃ¤hlt
                alert('âŒ Bitte wÃ¤hle:\n\nâš¡ SOFORT oder\nğŸ“… VORBESTELLEN');
                return;
            }
            
            // ğŸ• Berechne Zeitdifferenz fÃ¼r Vorbestellungs-Logik
            const minutesUntilPickup = (pickupTimestamp - Date.now()) / (1000 * 60);
            
            // ğŸ†• v5.31.0: Generiere EINDEUTIGE RIDE-ID
            const rideId = generateRideId();
            
            const ride = {
                id: rideId,  // â† EINDEUTIGE UUID!
                customerName,
                customerPhone,
                pickupTime,
                pickupTimestamp,
                pickup: document.getElementById('pickup').value,
                destination: document.getElementById('destination').value,
                passengers: document.getElementById('passengers').value,
                price: window.currentPrice,
                distance: window.currentDistance,
                duration: window.currentDuration,
                pickupCoords, destCoords,
                status: rideStatus,
                time: new Date().toLocaleString('de-DE'),
                createdAt: Date.now(),
                paymentMethod: document.getElementById('payment-method').value // ğŸ’³ Zahlungsmethode
            };
            
            // ğŸ¤– v5.32.5h: AUTO-BOOKING - PrÃ¼fe Zeitslot bei Vorbestellungen
            if (autoBookingEnabled && ride.status === 'vorbestellt') {
                console.log('ğŸ¤– Auto-Booking: PrÃ¼fe Zeitslot-VerfÃ¼gbarkeit...');
                
                const availability = await checkTimeSlotAvailability(ride.pickupTimestamp, pickupCoords);
                
                if (!availability.available) {
                    console.log('âš ï¸ Zeitslot belegt! Berechne Alternativen...');
                    
                    // Berechne alternative Zeiten
                    const alternatives = await calculateAlternativeTimes(
                        availability.conflictingRide,
                        pickupCoords,
                        ride.pickupTimestamp
                    );
                    
                    // Zeige Modal mit VorschlÃ¤gen
                    showAlternativeTimesModal(ride.pickupTimestamp, alternatives, ride);
                    
                    // Abbruch! User muss Alternative wÃ¤hlen
                    return;
                }
                
                console.log('âœ… Zeitslot verfÃ¼gbar, fahre mit Buchung fort');
            }
            
            const savedRide = await saveRide(ride);
            myCurrentRide = savedRide;
            localStorage.setItem('myCurrentRideId', savedRide.firebaseId);
            
            // ğŸ“œ PROTOKOLL: Fahrt gebucht (mit allen Details!)
            const bookingType = savedRide.status === 'vorbestellt' ? 'Vorbestellung' : 'Sofort-Fahrt';
            const pickupDisplay = pickupTime ? pickupTime : 'Sofort';
            logActivity('booking', 'created', 
                `Neue Buchung: ${bookingType} ğŸ‘¤${customerName} ğŸ“${ride.pickup} â†’ ${ride.destination} ğŸ“${customerPhone} ğŸ’°${ride.price}â‚¬${pickupTime ? ' ğŸ•' + pickupTime : ''}`, {
                customer: customerName,
                phone: customerPhone,
                from: ride.pickup,
                to: ride.destination,
                price: ride.price,
                pickupTime: pickupDisplay,
                type: bookingType
            });
            
            // ğŸ“‹ CRM: Kunde automatisch anlegen/aktualisieren
            await updateCustomerCRM(customerName, customerPhone, ride.pickup, ride.price);
            
            // ğŸ“‹ CRM: Stammkunden-Daten aktualisieren wenn Checkbox aktiv
            const saveToCrmCheckbox = document.getElementById('save-to-crm');
            if (currentBookingCustomerId && saveToCrmCheckbox && saveToCrmCheckbox.checked) {
                try {
                    await db.ref('customers/' + currentBookingCustomerId).update({
                        phone: customerPhone,
                        address: ride.pickup
                    });
                    console.log('ğŸ“‹ Stammkunden-Daten aktualisiert:', currentBookingCustomerId);
                } catch (error) {
                    console.error('âŒ Fehler beim Aktualisieren:', error);
                }
            }
            
            // Reset Stammkunden-ID und verstecke Checkbox
            currentBookingCustomerId = null;
            const crmOption = document.getElementById('crm-save-option');
            if (crmOption) crmOption.style.display = 'none';
            
            // ğŸ”„ Aktualisiere Verlauf (damit Vorbestellung sofort sichtbar ist)
            updateHistoryView();
            
            // âœ… BESTÃ„TIGUNG fÃ¼r Nutzer
            if (savedRide.status === 'vorbestellt') {
                // ğŸ“± TELEGRAM fÃ¼r Vorbestellung senden!
                if (isFirebaseReady) {
                    await sendTelegramForNewRide(savedRide);
                    // ğŸ†• v5.32.3: KUNDEN-BENACHRICHTIGUNGEN!
                    await sendCustomerNotifications(savedRide);
                }
                
                // ğŸ†• v5.32.5L: Zeige CARD statt Modal!
                document.getElementById('booking-form').style.display = 'none';
                showRideStatus(savedRide);
            } else {
                // ğŸ“± TELEGRAM fÃ¼r Sofort-Fahrt senden!
                if (isFirebaseReady) {
                    await sendTelegramForNewRide(savedRide);
                    // ğŸ†• v5.32.3: KUNDEN-BENACHRICHTIGUNGEN!
                    await sendCustomerNotifications(savedRide);
                }
                
                alert(
                    'âœ… Buchung erfolgreich!\n\n' +
                    'ğŸ“ Von: ' + ride.pickup + '\n' +
                    'ğŸ¯ Nach: ' + ride.destination + '\n' +
                    'ğŸ’° Preis: ' + ride.price + 'â‚¬\n\n' +
                    'ğŸ“² Sie erhalten SMS + Telegram mit Tracking-Link!\n\n' +
                    'ğŸš• Wir suchen jetzt einen Fahrer fÃ¼r dich!'
                );
            }
            
            // ğŸ¯ AUTO-ZUWEISUNG starten (nur wenn NICHT Vorbestellung)
            if (isFirebaseReady && savedRide.firebaseId && savedRide.status === 'new') {
                startAutoAssignment(savedRide.firebaseId, savedRide);
            }
            
            // ğŸ†• v5.32.5e: VORBESTELLUNGEN â†’ ZurÃ¼ck zu leerem Formular!
            if (savedRide.status === 'vorbestellt') {
                // âœ… Formular zurÃ¼cksetzen
                resetBookingForm();
                
                // âœ… Formular ANZEIGEN (nicht verstecken!)
                document.getElementById('booking-form').style.display = 'block';
                
                // âœ… Sicherstellen dass wir im Fahrgast-Tab sind
                if (typeof showTab === 'function') {
                    showTab('passenger');
                }
                
                console.log('âœ… v5.32.5e: Vorbestellung gespeichert, Formular zurÃ¼ckgesetzt, bereit fÃ¼r nÃ¤chste Buchung!');
                
            } else {
                // âš¡ SOFORT-FAHRTEN: Zeige Status-Ansicht
                document.getElementById('booking-form').style.display = 'none';
                showRideStatus(savedRide);
                
                // Formular trotzdem zurÃ¼cksetzen (fÃ¼r spÃ¤ter)
                resetBookingForm();
                
                if (isFirebaseReady) listenToMyRide(savedRide.firebaseId);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ§¹ v5.32.5: FORMULAR KOMPLETT ZURÃœCKSETZEN
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function resetBookingForm() {
            console.log('ğŸ§¹ Setze Buchungsformular zurÃ¼ck...');
            
            // ğŸ“ ALLE EINGABEFELDER LEEREN
            document.getElementById('customer-name').value = '';
            document.getElementById('customer-phone').value = '';
            document.getElementById('pickup').value = '';
            document.getElementById('destination').value = '';
            document.getElementById('passengers').value = '1';
            
            // ğŸ“… Vorbestell-Felder zurÃ¼cksetzen
            const preorderDateTime = document.getElementById('preorder-datetime');
            if (preorderDateTime) {
                preorderDateTime.value = '';
            }
            
            // ğŸ’³ Zahlungsmethode zurÃ¼cksetzen
            const paymentMethod = document.getElementById('payment-method');
            if (paymentMethod) {
                paymentMethod.value = 'bar';
            }
            
            // ğŸ’° PREIS ZURÃœCKSETZEN
            window.currentPrice = 0;
            window.currentDistance = 0;
            window.currentDuration = 0;
            const priceDisplay = document.getElementById('price-display');
            if (priceDisplay) {
                priceDisplay.innerHTML = '';
                priceDisplay.style.display = 'none'; // âœ… Verstecken!
            }
            const priceContainer = document.getElementById('price-container');
            if (priceContainer) {
                priceContainer.style.display = 'none';
            }
            
            // ğŸ—ºï¸ ROUTE-KARTE VERSTECKEN
            const routeMap = document.getElementById('route-map');
            if (routeMap) {
                routeMap.style.display = 'none';
                // Karte entfernen
                if (routeMapInstance) {
                    routeMapInstance.remove();
                    routeMapInstance = null;
                }
            }
            
            // ğŸ”˜ "BUCHEN"-BUTTON VERSTECKEN
            const bookBtn = document.getElementById('book-btn');
            if (bookBtn) {
                bookBtn.style.display = 'none';
            }
            
            // ğŸ”˜ "PREIS BERECHNEN"-BUTTON ZURÃœCKSETZEN
            const priceBtn = document.getElementById('price-btn');
            if (priceBtn) {
                priceBtn.innerHTML = 'ğŸ’° Preis berechnen';
                priceBtn.classList.remove('btn-danger');
                priceBtn.classList.add('btn-primary');
            }
            priceCalculated = false;
            
            // ğŸ—ºï¸ KARTE ZURÃœCKSETZEN
            if (window.currentRoutePolyline) {
                window.currentRoutePolyline.remove();
                window.currentRoutePolyline = null;
            }
            if (window.pickupMarker) {
                window.pickupMarker.remove();
                window.pickupMarker = null;
            }
            if (window.destinationMarker) {
                window.destinationMarker.remove();
                window.destinationMarker = null;
            }
            
            // ğŸ“ KOORDINATEN ZURÃœCKSETZEN
            window.pickupCoords = null;
            window.destCoords = null;
            
            // ğŸ”˜ BUTTONS ZURÃœCKSETZEN
            const rideTypeContainer = document.getElementById('ride-type-container');
            if (rideTypeContainer) {
                rideTypeContainer.style.display = 'none';
            }
            
            // â° VORBESTELL-CONTAINER VERSTECKEN
            const preorderContainer = document.getElementById('preorder-container');
            if (preorderContainer) {
                preorderContainer.style.display = 'none';
            }
            
            // ğŸ“‹ STAMMKUNDEN-CHECKBOX VERSTECKEN
            const crmOption = document.getElementById('crm-save-option');
            if (crmOption) {
                crmOption.style.display = 'none';
            }
            currentBookingCustomerId = null;
            
            // ğŸ§¹ LOKALSTORAGE FORMULAR-CACHE LEEREN
            localStorage.removeItem('bookingFormData');
            localStorage.removeItem('lastPickup');
            localStorage.removeItem('lastDestination');
            
            console.log('âœ… Formular zurÃ¼ckgesetzt - bereit fÃ¼r nÃ¤chste Buchung!');
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ“… v5.32.5f: VORBESTELL-ÃœBERSICHTS-MODAL
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let lastPreorderRide = null; // Speichert letzte Vorbestellung fÃ¼r Bearbeiten
        
        function showPreorderSummary(ride) {
            console.log('ğŸ“… Zeige Vorbestell-Ãœbersicht:', ride);
            
            lastPreorderRide = ride; // Speichern fÃ¼r Bearbeiten-Funktion
            
            // Formatiere Abholzeit
            const pickupTimeFormatted = ride.pickupTime || 'Sofort';
            
            // ğŸ†• v5.32.5k: ALTES schlichtes Design zurÃ¼ck!
            const summaryHtml = `
                <div style="padding: 20px; font-size: 15px; line-height: 1.8;">
                    <div style="margin-bottom: 15px;">
                        <strong>ğŸ• Abholung:</strong><br>
                        ${pickupTimeFormatted}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>ğŸ‘¤ Name:</strong><br>
                        ${ride.customerName}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>ğŸ“ Telefon:</strong><br>
                        ${ride.customerPhone}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>ğŸ“ Von:</strong><br>
                        ${ride.pickup}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>ğŸ¯ Nach:</strong><br>
                        ${ride.destination}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>ğŸ’° Preis:</strong><br>
                        ${ride.price}â‚¬
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <strong>ğŸ‘¥ Personen:</strong><br>
                        ${ride.passengers || 1}
                    </div>
                    
                    <div style="padding: 15px; background: #dbeafe; border-radius: 8px; margin-bottom: 20px;">
                        <strong>ğŸ“² Sie erhalten SMS + Telegram mit Tracking-Link!</strong>
                    </div>
                </div>
            `;
            
            // FÃ¼ge HTML ein
            document.getElementById('preorder-summary-content').innerHTML = summaryHtml;
            
            // Zeige Modal
            document.getElementById('preorder-summary-modal').style.display = 'block';
        }
        
        function closePreorderSummary() {
            console.log('âœ… OK - SchlieÃŸe Ãœbersicht, zeige leeres Formular');
            
            // Modal schlieÃŸen
            document.getElementById('preorder-summary-modal').style.display = 'none';
            
            // âœ… Formular zurÃ¼cksetzen
            resetBookingForm();
            
            // âœ… Formular ANZEIGEN
            document.getElementById('booking-form').style.display = 'block';
            
            // âœ… ZurÃ¼ck zu Fahrgast-Tab
            if (typeof showTab === 'function') {
                showTab('passenger');
            }
            
            // ğŸ”„ Verlauf aktualisieren (damit neue Vorbestellung sichtbar)
            updateHistoryView();
        }
        
        function editPreorder() {
            console.log('âœï¸ Bearbeiten - Lade Daten zurÃ¼ck ins Formular');
            
            if (!lastPreorderRide) {
                console.error('âŒ Keine Vorbestellung zum Bearbeiten!');
                return;
            }
            
            // Modal schlieÃŸen
            document.getElementById('preorder-summary-modal').style.display = 'none';
            
            // Daten zurÃ¼ck ins Formular laden
            document.getElementById('customer-name').value = lastPreorderRide.customerName || '';
            document.getElementById('customer-phone').value = lastPreorderRide.customerPhone || '';
            document.getElementById('pickup').value = lastPreorderRide.pickup || '';
            document.getElementById('destination').value = lastPreorderRide.destination || '';
            document.getElementById('passengers').value = lastPreorderRide.passengers || 1;
            
            // Koordinaten wiederherstellen
            window.pickupCoords = lastPreorderRide.pickupCoords || null;
            window.destCoords = lastPreorderRide.destCoords || null;
            
            // Zahlungsmethode
            const paymentMethod = document.getElementById('payment-method');
            if (paymentMethod && lastPreorderRide.paymentMethod) {
                paymentMethod.value = lastPreorderRide.paymentMethod;
            }
            
            // Vorbestell-Modus aktivieren
            currentRideType = 'vorbestellen';
            
            // Datum/Zeit zurÃ¼cksetzen wenn vorhanden
            if (lastPreorderRide.pickupTimestamp) {
                const date = new Date(lastPreorderRide.pickupTimestamp);
                
                const dateStr = date.toISOString().split('T')[0];
                const hourStr = String(date.getHours()).padStart(2, '0');
                const minuteStr = String(date.getMinutes()).padStart(2, '0');
                
                const customDate = document.getElementById('custom-date');
                const customHour = document.getElementById('custom-hour');
                const customMinute = document.getElementById('custom-minute');
                
                if (customDate) customDate.value = dateStr;
                if (customHour) customHour.value = hourStr;
                if (customMinute) customMinute.value = minuteStr;
                
                // Vorbestell-Container zeigen
                const preorderContainer = document.getElementById('preorder-container');
                if (preorderContainer) {
                    preorderContainer.style.display = 'block';
                }
            }
            
            // Formular ANZEIGEN
            document.getElementById('booking-form').style.display = 'block';
            
            // ZurÃ¼ck zu Fahrgast-Tab
            if (typeof showTab === 'function') {
                showTab('passenger');
            }
            
            // Alte Fahrt in Firebase lÃ¶schen (wird neu gespeichert beim Buchen)
            if (isFirebaseReady && lastPreorderRide.firebaseId) {
                db.ref('rides/' + lastPreorderRide.firebaseId).remove();
                console.log('ğŸ—‘ï¸ Alte Vorbestellung gelÃ¶scht, wird neu gespeichert');
            }
            
            // Hinweis fÃ¼r User
            alert('âœï¸ Fahrt wurde ins Formular geladen!\n\nBitte passe die Daten an und klicke dann auf "Preis berechnen" und "Taxi buchen".');
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ¤– v5.32.5h: AUTO-BOOKING SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let autoBookingEnabled = true; // ğŸ”§ v5.33.0: IMMER aktiv fÃ¼r ALLE (Admin & FahrgÃ¤ste!)
        let currentBookingData = null; // Speichert aktuelle Buchungsdaten fÃ¼r Retry
        
        // ğŸ†• v5.33.2: Zeitslot-Einstellungen (aus localStorage geladen)
        let timeslotSettings = {
            rideDuration: 10,  // Minuten
            travelTime: 5,     // Minuten
            bufferTime: 3,     // Minuten
            adminOverride: false
        };
        
        // Admin-Schalter
        function toggleAutoBooking() {
            const checkbox = document.getElementById('enable-auto-booking');
            autoBookingEnabled = checkbox.checked;
            
            // In localStorage speichern
            localStorage.setItem('autoBookingEnabled', autoBookingEnabled);
            
            // Status anzeigen
            updateAutoBookingStatus();
            
            console.log('ğŸ¤– Auto-Booking:', autoBookingEnabled ? 'AKTIVIERT' : 'DEAKTIVIERT');
        }
        
        function updateAutoBookingStatus() {
            const statusDiv = document.getElementById('auto-booking-status');
            if (autoBookingEnabled) {
                statusDiv.innerHTML = 'âœ… <span style="color:#059669;font-weight:600;">Aktiviert</span> - System schlÃ¤gt automatisch Alternativen vor';
                statusDiv.style.background = '#d1fae5';
                statusDiv.style.border = '1px solid #10b981';
            } else {
                statusDiv.innerHTML = 'âšª <span style="color:#6b7280;font-weight:600;">Deaktiviert</span> - Keine automatischen VorschlÃ¤ge';
                statusDiv.style.background = '#f3f4f6';
                statusDiv.style.border = '1px solid #d1d5db';
            }
        }
        
        // Beim Laden Auto-Booking Status wiederherstellen
        function loadAutoBookingSettings() {
            // ğŸ”§ v5.33.0: StandardmÃ¤ÃŸig AKTIVIERT fÃ¼r alle!
            const saved = localStorage.getItem('autoBookingEnabled');
            // Nur wenn explizit 'false' gespeichert, dann deaktivieren
            // Sonst: IMMER aktiv!
            autoBookingEnabled = saved === 'false' ? false : true;
            
            const checkbox = document.getElementById('enable-auto-booking');
            if (checkbox) {
                checkbox.checked = autoBookingEnabled;
                updateAutoBookingStatus();
            }
            
            console.log('ğŸ¤– Auto-Booking Status geladen:', autoBookingEnabled, '(Standard: AKTIVIERT fÃ¼r alle!)');
        }
        
        // ğŸ†• v5.33.2: Zeitslot-Einstellungen Management
        function updateTimeslotSettings() {
            // Werte aus Sliders lesen
            const rideDuration = parseInt(document.getElementById('ride-duration-slider').value);
            const travelTime = parseInt(document.getElementById('travel-time-slider').value);
            const bufferTime = parseInt(document.getElementById('buffer-time-slider').value);
            const adminOverride = document.getElementById('admin-override-enabled').checked;
            
            // Anzeige aktualisieren
            document.getElementById('ride-duration-value').textContent = rideDuration + ' Min';
            document.getElementById('travel-time-value').textContent = travelTime + ' Min';
            document.getElementById('buffer-time-value').textContent = bufferTime + ' Min';
            
            // Total Buffer berechnen
            const totalBuffer = rideDuration + travelTime + bufferTime;
            document.getElementById('total-buffer-display').textContent = totalBuffer + ' Min';
            
            console.log('â° Zeitslot-Einstellungen aktualisiert:', {rideDuration, travelTime, bufferTime, totalBuffer, adminOverride});
        }
        
        function saveTimeslotSettings() {
            // Werte aus Sliders lesen
            timeslotSettings.rideDuration = parseInt(document.getElementById('ride-duration-slider').value);
            timeslotSettings.travelTime = parseInt(document.getElementById('travel-time-slider').value);
            timeslotSettings.bufferTime = parseInt(document.getElementById('buffer-time-slider').value);
            timeslotSettings.adminOverride = document.getElementById('admin-override-enabled').checked;
            
            // In localStorage speichern
            localStorage.setItem('timeslotSettings', JSON.stringify(timeslotSettings));
            
            // Status anzeigen
            const statusDiv = document.getElementById('timeslot-save-status');
            statusDiv.innerHTML = '<span style="color:#10b981;font-weight:600;">âœ… Einstellungen gespeichert!</span>';
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
            
            console.log('ğŸ’¾ Zeitslot-Einstellungen gespeichert:', timeslotSettings);
        }
        
        function loadTimeslotSettings() {
            // Aus localStorage laden
            const saved = localStorage.getItem('timeslotSettings');
            if (saved) {
                timeslotSettings = JSON.parse(saved);
            }
            
            // UI aktualisieren
            const rideDurationSlider = document.getElementById('ride-duration-slider');
            const travelTimeSlider = document.getElementById('travel-time-slider');
            const bufferTimeSlider = document.getElementById('buffer-time-slider');
            const adminOverrideCheckbox = document.getElementById('admin-override-enabled');
            
            if (rideDurationSlider) {
                rideDurationSlider.value = timeslotSettings.rideDuration;
                document.getElementById('ride-duration-value').textContent = timeslotSettings.rideDuration + ' Min';
            }
            
            if (travelTimeSlider) {
                travelTimeSlider.value = timeslotSettings.travelTime;
                document.getElementById('travel-time-value').textContent = timeslotSettings.travelTime + ' Min';
            }
            
            if (bufferTimeSlider) {
                bufferTimeSlider.value = timeslotSettings.bufferTime;
                document.getElementById('buffer-time-value').textContent = timeslotSettings.bufferTime + ' Min';
            }
            
            if (adminOverrideCheckbox) {
                adminOverrideCheckbox.checked = timeslotSettings.adminOverride;
            }
            
            // Total Buffer aktualisieren
            const totalBuffer = timeslotSettings.rideDuration + timeslotSettings.travelTime + timeslotSettings.bufferTime;
            const totalBufferDisplay = document.getElementById('total-buffer-display');
            if (totalBufferDisplay) {
                totalBufferDisplay.textContent = totalBuffer + ' Min';
            }
            
            console.log('â° Zeitslot-Einstellungen geladen:', timeslotSettings);
        }
        
        // Beim Laden Einstellungen laden
        setTimeout(() => loadTimeslotSettings(), 1000);
        
        // PrÃ¼ft ob Zeitslot bereits belegt ist
        async function checkTimeSlotAvailability(requestedTimestamp, pickupCoords) {
            if (!isFirebaseReady) return { available: true };
            
            // ğŸ¯ v5.33.2: Admin-Override prÃ¼fen!
            if (timeslotSettings.adminOverride) {
                console.log('ğŸ¯ Admin-Override aktiv - Zeitslot-Check Ã¼bersprungen!');
                return { available: true };
            }
            
            console.log('ğŸ” PrÃ¼fe Zeitslot fÃ¼r:', new Date(requestedTimestamp).toLocaleString('de-DE'));
            
            try {
                const snapshot = await db.ref('rides').once('value');
                const rides = [];
                
                snapshot.forEach(child => {
                    const ride = child.val();
                    ride.firebaseId = child.key;
                    rides.push(ride);
                });
                
                // Filtere nur aktive und vorbestellte Fahrten
                const activeRides = rides.filter(r => 
                    r.status && 
                    ['new', 'assigned', 'vorbestellt', 'picked_up', 'ongoing'].includes(r.status) &&
                    r.pickupTimestamp
                );
                
                // ğŸ†• v5.32.5j: VERBESSERTE PRÃœFUNG - BerÃ¼cksichtigt Fahrtende + Fahrzeit
                for (const ride of activeRides) {
                    console.log('ğŸ” PrÃ¼fe gegen Fahrt:', new Date(ride.pickupTimestamp).toLocaleTimeString('de-DE'));
                    
                    // 1. Berechne ENDE der vorherigen Fahrt
                    let rideDuration = ride.duration || timeslotSettings.rideDuration; // ğŸ”§ v5.33.2: Aus Einstellungen!
                    
                    // Wenn Koordinaten vorhanden, berechne echte Dauer
                    if (ride.pickupCoords && ride.destCoords) {
                        rideDuration = await calculateRouteDuration(
                            ride.pickupCoords,
                            ride.destCoords
                        );
                    }
                    
                    const rideEndTime = ride.pickupTimestamp + (rideDuration * 60 * 1000);
                    console.log('   Fahrt endet:', new Date(rideEndTime).toLocaleTimeString('de-DE'), `(Dauer: ${rideDuration} Min)`);
                    
                    // 2. Wenn gewÃ¼nschte Zeit NACH Ende der Fahrt liegt
                    if (requestedTimestamp > rideEndTime) {
                        // Berechne Fahrzeit vom Ziel der alten Fahrt zum Start der neuen
                        let travelTime = timeslotSettings.travelTime; // ğŸ”§ v5.33.2: Aus Einstellungen!
                        
                        if (ride.destCoords && pickupCoords) {
                            travelTime = await calculateRouteDuration(
                                ride.destCoords,
                                pickupCoords
                            );
                        }
                        
                        console.log('   Fahrzeit zum neuen Start:', travelTime, 'Min');
                        
                        // 3. FrÃ¼hestmÃ¶gliche Zeit = Ende + Fahrzeit + 3 Min Puffer
                        const earliestPossible = rideEndTime + (travelTime * 60 * 1000) + (timeslotSettings.bufferTime * 60 * 1000); // ğŸ”§ v5.33.2: Aus Einstellungen!
                        console.log('   FrÃ¼hestmÃ¶glich:', new Date(earliestPossible).toLocaleTimeString('de-DE'));
                        
                        // 4. Wenn gewÃ¼nschte Zeit VOR frÃ¼hestmÃ¶glich â†’ KONFLIKT!
                        if (requestedTimestamp < earliestPossible) {
                            console.log('âš ï¸ KONFLIKT! GewÃ¼nschte Zeit zu frÃ¼h!');
                            return {
                                available: false,
                                conflictingRide: ride
                            };
                        }
                    }
                    
                    // 5. Wenn gewÃ¼nschte Zeit VOR oder WÃ„HREND der Fahrt liegt â†’ KONFLIKT!
                    // ğŸ”§ v5.32.23: 30-Min-Rule entfernt - wird schon oben geprÃ¼ft!
                    if (requestedTimestamp <= rideEndTime) {
                        console.log('âš ï¸ KONFLIKT! GewÃ¼nschte Zeit liegt wÃ¤hrend laufender Fahrt!');
                        return {
                            available: false,
                            conflictingRide: ride
                        };
                    }
                }
                
                console.log('âœ… Zeitslot verfÃ¼gbar!');
                return { available: true };
                
            } catch (error) {
                console.error('âŒ Fehler bei Zeitslot-PrÃ¼fung:', error);
                return { available: true }; // Im Fehlerfall erlauben
            }
        }
        
        // Berechnet alternative Zeiten
        async function calculateAlternativeTimes(conflictingRide, pickupCoords, requestedTimestamp) {
            console.log('ğŸ’¡ Berechne alternative Zeiten...');
            
            try {
                // 1. Berechne Dauer der konfliktierenden Fahrt
                const rideDuration = await calculateRouteDuration(
                    conflictingRide.pickupCoords,
                    conflictingRide.destCoords
                );
                
                console.log('ğŸš— Konflikt-Fahrt Dauer:', rideDuration, 'Min');
                
                // 2. Ende der konfliktierenden Fahrt
                const rideEndTime = conflictingRide.pickupTimestamp + (rideDuration * 60 * 1000);
                
                // 3. Berechne Fahrzeit vom Ziel zum neuen Start
                const travelTime = await calculateRouteDuration(
                    conflictingRide.destCoords,
                    pickupCoords
                );
                
                console.log('ğŸš• Fahrzeit zum neuen Start:', travelTime, 'Min');
                
                // 4. FrÃ¼hestmÃ¶gliche Zeit = Ende + Fahrzeit + 3 Min Puffer
                let earliestTime = rideEndTime + (travelTime * 60 * 1000) + (timeslotSettings.bufferTime * 60 * 1000); // ğŸ”§ v5.33.2: Aus Einstellungen!
                
                // 5. Auf 5 Min runden (IMMER AUFRUNDEN!)
                earliestTime = roundToNext5Minutes(earliestTime);
                
                console.log('â° FrÃ¼hestmÃ¶glich (gerundet):', new Date(earliestTime).toLocaleTimeString('de-DE'));
                
                // 6. Erstelle 3 VorschlÃ¤ge: +15, +30, +45 Min
                const alternatives = [
                    earliestTime + (15 * 60 * 1000),
                    earliestTime + (30 * 60 * 1000),
                    earliestTime + (45 * 60 * 1000)
                ];
                
                return alternatives.map(ts => ({
                    timestamp: ts,
                    formatted: formatTimeForDisplay(ts)
                }));
                
            } catch (error) {
                console.error('âŒ Fehler bei Alternativ-Berechnung:', error);
                // Fallback: Einfach +15, +30, +45 Min zur gewÃ¼nschten Zeit
                return [15, 30, 45].map(offset => {
                    const ts = requestedTimestamp + (offset * 60 * 1000);
                    return {
                        timestamp: ts,
                        formatted: formatTimeForDisplay(ts)
                    };
                });
            }
        }
        
        // Berechnet Route-Dauer via Google Maps
        async function calculateRouteDuration(fromCoords, toCoords) {
            if (!fromCoords || !toCoords) return 15; // Fallback
            
            try {
                const response = await fetch(
                    `https://maps.googleapis.com/maps/api/directions/json?` +
                    `origin=${fromCoords.lat},${fromCoords.lng}&` +
                    `destination=${toCoords.lat},${toCoords.lng}&` +
                    `key=${GOOGLE_MAPS_API_KEY}`
                );
                
                const data = await response.json();
                
                if (data.routes && data.routes[0]) {
                    const duration = data.routes[0].legs[0].duration.value; // Sekunden
                    return Math.ceil(duration / 60); // Minuten, aufgerundet
                }
            } catch (error) {
                console.error('âŒ Fehler bei Route-Berechnung:', error);
            }
            
            return 15; // Fallback
        }
        
        // Rundet auf nÃ¤chste 5 Minuten AUF
        function roundToNext5Minutes(timestamp) {
            const date = new Date(timestamp);
            const minutes = date.getMinutes();
            const remainder = minutes % 5;
            
            if (remainder === 0) {
                return timestamp; // Schon auf 5 Min
            }
            
            // Aufrunden auf nÃ¤chste 5
            const minutesToAdd = 5 - remainder;
            return timestamp + (minutesToAdd * 60 * 1000);
        }
        
        // Formatiert Zeit fÃ¼r Anzeige
        function formatTimeForDisplay(timestamp) {
            const date = new Date(timestamp);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}.${month}.${date.getFullYear()}, ${hours}:${minutes} Uhr`;
        }
        
        // Zeigt Modal mit Alternativen
        function showAlternativeTimesModal(requestedTime, alternatives, bookingData) {
            console.log('ğŸ“‹ Zeige Alternative-Zeiten-Modal');
            
            // Speichere Buchungsdaten fÃ¼r spÃ¤ter
            currentBookingData = bookingData;
            
            // Zeige gewÃ¼nschte Zeit
            document.getElementById('requested-time-display').textContent = 
                formatTimeForDisplay(requestedTime);
            
            // Erstelle Buttons fÃ¼r Alternativen
            const container = document.getElementById('alternative-times-container');
            container.innerHTML = alternatives.map((alt, idx) => `
                <button onclick="selectAlternativeTime(${alt.timestamp})" 
                    style="padding: 15px; background: white; border: 2px solid #10b981; border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                    onmouseover="this.style.background='#d1fae5'" 
                    onmouseout="this.style.background='white'">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <div style="font-weight: 600; font-size: 15px; color: #1f2937;">
                                â° ${alt.formatted}
                            </div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 3px;">
                                ${idx === 0 ? 'FrÃ¼hestmÃ¶glich' : idx === 1 ? 'Komfortabel' : 'Sicherer Puffer'}
                            </div>
                        </div>
                        <div style="font-size: 20px; color: #10b981;">
                            âœ…
                        </div>
                    </div>
                </button>
            `).join('');
            
            // Zeige Modal
            document.getElementById('auto-booking-modal').style.display = 'block';
        }
        
        // User wÃ¤hlt alternative Zeit
        async function selectAlternativeTime(timestamp) {
            console.log('âœ… Alternative Zeit gewÃ¤hlt:', new Date(timestamp).toLocaleString('de-DE'));
            
            // Modal schlieÃŸen
            closeAutoBookingModal();
            
            if (!currentBookingData) {
                alert('âŒ Fehler: Buchungsdaten verloren!');
                return;
            }
            
            // Aktualisiere Zeitstempel
            currentBookingData.pickupTimestamp = timestamp;
            currentBookingData.pickupTime = formatTimeForDisplay(timestamp);
            
            // Buche mit neuer Zeit
            await executeBooking(currentBookingData);
        }
        
        // SchlieÃŸt Modal
        function closeAutoBookingModal() {
            document.getElementById('auto-booking-modal').style.display = 'none';
            currentBookingData = null;
        }
        
        // Zeigt Zeitauswahl-Formular
        function showCustomTimeSelection() {
            closeAutoBookingModal();
            
            // ZurÃ¼ck zum Vorbestellen-Bereich
            currentRideType = 'vorbestellen';
            document.getElementById('btn-vorbestellen').style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
            document.getElementById('btn-vorbestellen').style.color = 'white';
            document.getElementById('btn-sofort').style.background = 'white';
            document.getElementById('btn-sofort').style.color = '#059669';
            
            // Zeige Vorbestellen-Container
            document.getElementById('vorbestellen-bereich').style.display = 'block';
            document.getElementById('sofort-bereich').style.display = 'none';
            
            alert('ğŸ’¡ Bitte wÃ¤hle eine andere Zeit und klicke dann auf "Taxi buchen".');
        }
        
        // FÃ¼hrt Buchung aus (ohne erneute PrÃ¼fung)
        async function executeBooking(bookingData) {
            console.log('ğŸ“ FÃ¼hre Buchung aus:', bookingData);
            
            // Firebase speichern
            if (isFirebaseReady) {
                const firebaseRide = { ...bookingData };
                delete firebaseRide.firebaseId;
                
                const newRideRef = await db.ref('rides').push(firebaseRide);
                bookingData.firebaseId = newRideRef.key;
                
                console.log('âœ… In Firebase gespeichert:', bookingData.firebaseId);
            }
            
            // localStorage speichern
            rides.push(bookingData);
            localStorage.setItem('rides', JSON.stringify(rides));
            
            // Telegram senden
            if (isFirebaseReady) {
                await sendTelegramForNewRide(bookingData);
                await sendCustomerNotifications(bookingData);
            }
            
            // BestÃ¤tigung zeigen
            if (bookingData.status === 'vorbestellt') {
                // ğŸ†• v5.32.5L: Zeige CARD statt Modal!
                document.getElementById('booking-form').style.display = 'none';
                showRideStatus(bookingData);
            } else {
                alert(
                    'âœ… Buchung erfolgreich!\n\n' +
                    'ğŸ“ Von: ' + bookingData.pickup + '\n' +
                    'ğŸ¯ Nach: ' + bookingData.destination + '\n' +
                    'ğŸ’° Preis: ' + bookingData.price + 'â‚¬\n\n' +
                    'ğŸ“² Sie erhalten SMS + Telegram mit Tracking-Link!\n\n' +
                    'ğŸš• Wir suchen jetzt einen Fahrer fÃ¼r dich!'
                );
                
                document.getElementById('booking-form').style.display = 'none';
                showRideStatus(bookingData);
                resetBookingForm();
                
                if (isFirebaseReady) listenToMyRide(bookingData.firebaseId);
            }
            
            // Auto-Assignment fÃ¼r Sofort-Fahrten
            if (isFirebaseReady && bookingData.firebaseId && bookingData.status === 'new') {
                startAutoAssignment(bookingData.firebaseId, bookingData);
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // ğŸ†• v5.31.1: Track letzten Status um unnÃ¶tige UI-Updates zu vermeiden
        let lastRideStatus = null;
        let lastRideDriverLocation = null;
        
        function listenToMyRide(rideId) {
            if (!isFirebaseReady) return;
            
            // ğŸ†• v5.20.7: Nicht zuhÃ¶ren wenn kÃ¼rzlich storniert!
            if (recentlyCancelledRideIds && recentlyCancelledRideIds.has(rideId)) {
                console.log('ğŸ›¡ï¸ HÃ¶re NICHT auf stornierte Fahrt:', rideId);
                return;
            }
            
            console.log('ğŸ‘‚ HÃ¶re auf Ã„nderungen fÃ¼r Fahrt:', rideId);
            
            db.ref('rides/' + rideId).on('value', (s) => {
                // ğŸ†• v5.20.7: Nochmal prÃ¼fen bei jedem Update!
                if (recentlyCancelledRideIds && recentlyCancelledRideIds.has(rideId)) {
                    console.log('ğŸ›¡ï¸ Ignoriere Update fÃ¼r stornierte Fahrt:', rideId);
                    db.ref('rides/' + rideId).off();
                    return;
                }
                
                const ride = s.val();
                if (ride) {
                    ride.firebaseId = rideId;
                    
                    // ğŸ¯ FIX: PrÃ¼fe ob Fahrt schon abgeschlossen/storniert ist!
                    // ğŸ†• Auch 'cancelled' und 'cancelled_pending_driver' prÃ¼fen
                    const endedStatuses = ['storniert', 'completed', 'cancelled', 'cancelled_pending_driver'];
                    if (endedStatuses.includes(ride.status)) {
                        console.log('âœ… Fahrt ist beendet:', ride.status);
                        
                        // ğŸ†• v5.26.14f: REALTIME FIX - Speichere beendete Fahrt in Verlauf!
                        console.log('ğŸ’¾ Speichere Fahrt in Verlauf...');
                        const rideHistory = JSON.parse(localStorage.getItem('rideHistory') || '[]');
                        
                        // PrÃ¼fe ob schon vorhanden (dedupliziere)
                        const existingIndex = rideHistory.findIndex(r => r.id === ride.id || r.firebaseId === rideId);
                        if (existingIndex >= 0) {
                            // Aktualisiere bestehende Fahrt
                            rideHistory[existingIndex] = ride;
                            console.log('âœ… Fahrt aktualisiert in Verlauf');
                        } else {
                            // FÃ¼ge neue Fahrt hinzu
                            rideHistory.push(ride);
                            console.log('âœ… Fahrt hinzugefÃ¼gt zu Verlauf');
                        }
                        
                        localStorage.setItem('rideHistory', JSON.stringify(rideHistory));
                        
                        // ğŸ”„ Update History-View sofort!
                        if (currentView === 'history') {
                            updateHistoryView();
                        }
                        
                        localStorage.removeItem('myCurrentRideId');
                        myCurrentRide = null;
                        lastRideStatus = null;  // Reset!
                        lastRideDriverLocation = null;
                        document.getElementById('booking-form').style.display = 'block';
                        document.getElementById('ride-status-container').innerHTML = '';
                        // ğŸ†• Formular zurÃ¼cksetzen
                        resetBookingForm();
                        // Stoppe Listener
                        db.ref('rides/' + rideId).off();
                        return;
                    }
                    
                    myCurrentRide = ride;
                    
                    // ğŸ†• v5.31.1: SMART UPDATE - nur bei RELEVANTEN Ã„nderungen!
                    const statusChanged = lastRideStatus !== ride.status;
                    const driverLocationChanged = JSON.stringify(lastRideDriverLocation) !== JSON.stringify(ride.driverLocation);
                    
                    if (statusChanged) {
                        console.log('ğŸ”„ Status geÃ¤ndert:', lastRideStatus, 'â†’', ride.status);
                        lastRideStatus = ride.status;
                        
                        // ğŸ¯ Status-Ã„nderung â†’ VOLLSTÃ„NDIGES UI-Update
                        document.getElementById('booking-form').style.display = 'none';
                        showRideStatus(ride);
                    } else if (driverLocationChanged && ride.status === 'accepted') {
                        console.log('ğŸ“ GPS-Update (kein Status-Change)');
                        lastRideDriverLocation = ride.driverLocation;
                        
                        // ğŸ—ºï¸ NUR Karte updaten, NICHT ganzes UI!
                        if (map && taxiMarker && ride.driverLocation) {
                            taxiMarker.setLatLng([ride.driverLocation.lat, ride.driverLocation.lon]);
                            
                            // Update ETA
                            if (ride.estimatedArrival) {
                                const etaEl = document.getElementById('eta-display');
                                if (etaEl) {
                                    const now = Date.now();
                                    const eta = ride.estimatedArrival;
                                    const minutesLeft = Math.max(0, Math.round((eta - now) / 60000));
                                    etaEl.innerHTML = `<strong>â±ï¸ Ankunft in ca. ${minutesLeft} Min</strong>`;
                                }
                            }
                        }
                    } else {
                        console.log('â­ï¸ Keine relevante Ã„nderung - kein UI-Update');
                    }
                } else {
                    // Fahrt existiert nicht mehr (wurde gelÃ¶scht)
                    console.log('âš ï¸ Fahrt existiert nicht mehr:', rideId);
                    localStorage.removeItem('myCurrentRideId');
                    myCurrentRide = null;
                    lastRideStatus = null;
                    lastRideDriverLocation = null;
                    document.getElementById('booking-form').style.display = 'block';
                    document.getElementById('ride-status-container').innerHTML = '';
                }
            });
        }

        // ğŸ›¡ï¸ Schutz gegen Doppelklick
        let cancelInProgress = false;
        
        // ğŸ†• v5.20.7: Set fÃ¼r kÃ¼rzlich stornierte Fahrten (verhindert Wieder-Anzeige)
        const recentlyCancelledRideIds = new Set();
        
        // ğŸ†• v5.21.9: PERSISTENT Set fÃ¼r bereits angezeigte Stornierung-Alarme
        function loadShownCancelAlarms() {
            try {
                const stored = localStorage.getItem('shownCancelAlarmIds');
                if (stored) {
                    const data = JSON.parse(stored);
                    // LÃ¶sche EintrÃ¤ge Ã¤lter als 7 Tage
                    const now = Date.now();
                    const sevenDays = 7 * 24 * 60 * 60 * 1000;
                    Object.keys(data).forEach(key => {
                        if (now - data[key] > sevenDays) {
                            delete data[key];
                        }
                    });
                    localStorage.setItem('shownCancelAlarmIds', JSON.stringify(data));
                    return data;
                }
            } catch (e) {
                console.error('âŒ Fehler beim Laden von shownCancelAlarmIds:', e);
            }
            return {};
        }
        
        function saveShownCancelAlarm(rideId) {
            try {
                const data = loadShownCancelAlarms();
                data[rideId] = Date.now();
                localStorage.setItem('shownCancelAlarmIds', JSON.stringify(data));
                console.log('âœ… Stornierung-Alarm gespeichert:', rideId);
            } catch (e) {
                console.error('âŒ Fehler beim Speichern von shownCancelAlarmIds:', e);
            }
        }
        
        function hasShownCancelAlarm(rideId) {
            const data = loadShownCancelAlarms();
            return !!data[rideId];
        }
        
        // Initialisiere beim App-Start
        console.log('ğŸ“¦ Lade gespeicherte Stornierung-Alarme...');
        loadShownCancelAlarms();
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ”‹ BATTERIE-SPAR-SYSTEM - VERSION 5.23.0
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const PowerSaveManager = {
            mode: 'NORMAL', // NORMAL, ECO, POWER_SAVE
            autoTimer: null,
            warningTimer: null,
            lastActivity: Date.now(),
            batteryLevel: 100,
            isMobile: /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent),
            isNativeApp: window.Capacitor && window.Capacitor.isNativePlatform(),
            
            // Modi-Konfiguration
            modes: {
                NORMAL: {
                    name: 'Normal',
                    screenBrightness: 1.0,
                    gpsInterval: 10, // Meter
                    icon: 'â˜€ï¸',
                    color: '#10b981'
                },
                ECO: {
                    name: 'Eco',
                    screenBrightness: 0.6,
                    gpsInterval: 30,
                    icon: 'ğŸŒ¤ï¸',
                    color: '#f59e0b'
                },
                POWER_SAVE: {
                    name: 'Power Save',
                    screenBrightness: 0.1,
                    gpsInterval: 50,
                    icon: 'ğŸ’¤',
                    color: '#6366f1'
                }
            },
            
            init: function() {
                console.log('ğŸ”‹ Initialisiere Batterie-Spar-System...');
                console.log(`ğŸ“± Platform: ${this.isMobile ? 'Mobile' : 'Desktop'} | Native App: ${this.isNativeApp ? 'Ja' : 'Nein'}`);
                
                // Hinweis bei Desktop
                if (!this.isMobile) {
                    console.log('ğŸ’» Desktop erkannt - Dark Mode & Screen Dimming deaktiviert (nur GPS-Intervall aktiv)');
                }
                
                // Batterie-Level abfragen (wenn verfÃ¼gbar)
                if ('getBattery' in navigator) {
                    navigator.getBattery().then(battery => {
                        this.batteryLevel = Math.round(battery.level * 100);
                        battery.addEventListener('levelchange', () => {
                            this.batteryLevel = Math.round(battery.level * 100);
                            this.updateBatteryDisplay();
                        });
                        this.updateBatteryDisplay();
                    });
                }
                
                // UI erstellen
                this.createUI();
                
                // Auto-Timer starten wenn Fahrer online geht
                this.startAutoTimer();
                
                console.log('âœ… Batterie-Spar-System bereit');
            },
            
            createUI: function() {
                // Power-Save Button in driver-top-bar einfÃ¼gen
                const topBar = document.getElementById('driver-top-bar');
                if (!topBar) return;
                
                // âš ï¸ DUPLIKAT-CHECK: Nicht nochmal erstellen wenn schon da!
                if (document.getElementById('battery-display')) {
                    console.log('âš ï¸ UI bereits erstellt - Ã¼berspringe');
                    return;
                }
                
                // Batterie-Anzeige
                const batteryDisplay = document.createElement('div');
                batteryDisplay.id = 'battery-display';
                batteryDisplay.style.cssText = `
                    display: flex;
                    align-items: center;
                    gap: 4px;
                    padding: 4px 8px;
                    background: rgba(16,185,129,0.1);
                    border-radius: 12px;
                    font-size: 11px;
                    color: #10b981;
                    font-weight: bold;
                    margin-left: auto;
                `;
                batteryDisplay.innerHTML = 'ğŸ”‹ 100%';
                topBar.appendChild(batteryDisplay);
                
                // Power-Save Button
                const powerButton = document.createElement('button');
                powerButton.id = 'power-save-btn';
                powerButton.style.cssText = `
                    background: #10b981;
                    color: white;
                    border: none;
                    padding: 6px 12px;
                    border-radius: 20px;
                    font-weight: bold;
                    cursor: pointer;
                    font-size: 13px;
                    display: flex;
                    align-items: center;
                    gap: 4px;
                `;
                powerButton.innerHTML = 'â˜€ï¸ Normal';
                powerButton.onclick = () => this.cyclePowerMode();
                topBar.appendChild(powerButton);
                
                // Settings-Button
                const settingsBtn = document.createElement('button');
                settingsBtn.id = 'settings-btn';
                settingsBtn.style.cssText = `
                    background: #6b7280;
                    color: white;
                    border: none;
                    padding: 6px 12px;
                    border-radius: 20px;
                    font-weight: bold;
                    cursor: pointer;
                    font-size: 13px;
                    display: flex;
                    align-items: center;
                    gap: 4px;
                `;
                settingsBtn.innerHTML = 'âš™ï¸';
                settingsBtn.onclick = () => DriverSettingsManager.showSettingsDialog();
                topBar.appendChild(settingsBtn);
                
                // Warnung-Overlay (versteckt)
                const warning = document.createElement('div');
                warning.id = 'power-save-warning';
                warning.style.cssText = `
                    display: none;
                    position: fixed;
                    top: 60px;
                    left: 50%;
                    transform: translateX(-50%);
                    z-index: 9999;
                    background: #fef3c7;
                    border: 2px solid #f59e0b;
                    border-radius: 12px;
                    padding: 16px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    max-width: 300px;
                    text-align: center;
                `;
                warning.innerHTML = `
                    <div style="font-size: 24px; margin-bottom: 8px;">âš¡</div>
                    <div style="font-weight: bold; margin-bottom: 8px;">Power-Save in <span id="countdown">30</span> Sek</div>
                    <div style="font-size: 12px; color: #92400e; margin-bottom: 12px;">Screen wird gedimmt, GPS verlangsamt</div>
                    <button onclick="PowerSaveManager.cancelAuto()" style="
                        background: white;
                        border: 2px solid #f59e0b;
                        color: #f59e0b;
                        padding: 8px 16px;
                        border-radius: 8px;
                        font-weight: bold;
                        cursor: pointer;
                    ">Abbrechen</button>
                `;
                document.body.appendChild(warning);
            },
            
            cyclePowerMode: function() {
                // Modus wechseln: NORMAL â†’ ECO â†’ POWER_SAVE â†’ NORMAL
                const modes = ['NORMAL', 'ECO', 'POWER_SAVE'];
                const currentIndex = modes.indexOf(this.mode);
                const nextMode = modes[(currentIndex + 1) % modes.length];
                
                this.setMode(nextMode, 'manual');
            },
            
            setMode: function(mode, trigger = 'manual') {
                if (!this.modes[mode]) return;
                
                this.mode = mode;
                const config = this.modes[mode];
                
                console.log(`ğŸ”‹ Power-Save Modus: ${config.name} (${trigger}) | Platform: ${this.isMobile ? 'Mobile' : 'Desktop'}`);
                
                // Screen Brightness anpassen (nur auf Mobile!)
                if (this.isMobile) {
                    this.setScreenBrightness(config.screenBrightness);
                } else {
                    console.log('ğŸ’» Desktop erkannt - Screen Brightness Ã¼bersprungen');
                }
                
                // GPS-Intervall anpassen (wird beim nÃ¤chsten GPS-Update angewendet)
                window.currentGPSInterval = config.gpsInterval;
                
                // UI updaten
                const btn = document.getElementById('power-save-btn');
                if (btn) {
                    btn.innerHTML = `${config.icon} ${config.name}`;
                    btn.style.background = config.color;
                }
                
                // Dark Mode bei POWER_SAVE (nur auf Mobile!)
                if (mode === 'POWER_SAVE' && this.isMobile) {
                    this.enableDarkMode();
                } else {
                    this.disableDarkMode();
                }
                
                // Log Activity
                logActivity('system', 'power_mode', `Power-Modus: ${config.name}`, {
                    mode: mode,
                    trigger: trigger,
                    brightness: config.screenBrightness,
                    gpsInterval: config.gpsInterval,
                    platform: this.isMobile ? 'mobile' : 'desktop'
                });
            },
            
            setScreenBrightness: function(level) {
                // Nur auf Mobile!
                if (!this.isMobile) {
                    return; // Ãœberspringe auf Desktop
                }
                
                // CSS Filter fÃ¼r Helligkeit
                const driverView = document.getElementById('driver-view');
                if (driverView) {
                    driverView.style.filter = `brightness(${level})`;
                    console.log(`ğŸ’¡ Screen Brightness: ${Math.round(level * 100)}% (Mobile)`);
                }
                
                // Native Screen Brightness (wenn verfÃ¼gbar)
                if (window.ScreenBrightness) {
                    window.ScreenBrightness.setBrightness(level);
                }
            },
            
            enableDarkMode: function() {
                // Nur auf Mobile aktivieren!
                if (!this.isMobile) {
                    console.log('ğŸ’» Dark Mode Ã¼bersprungen (Desktop)');
                    return;
                }
                
                const style = document.getElementById('dark-mode-style');
                if (style) return; // Bereits aktiv
                
                const darkStyle = document.createElement('style');
                darkStyle.id = 'dark-mode-style';
                darkStyle.textContent = `
                    /* ğŸŒ™ v5.31.4: SCHÃ–NER DARK MODE (nicht mehr komplett schwarz!) */
                    
                    #driver-view {
                        background: linear-gradient(135deg, #1a1d29 0%, #0f1419 100%) !important;
                        color: #e5e7eb !important;
                        transition: background 0.5s ease, color 0.3s ease;
                    }
                    
                    #driver-view .view {
                        background: transparent !important;
                    }
                    
                    #driver-top-bar {
                        background: rgba(15, 20, 25, 0.95) !important;
                        color: #e5e7eb !important;
                        backdrop-filter: blur(10px);
                        border-bottom: 1px solid rgba(102, 126, 234, 0.3);
                    }
                    
                    /* Buttons schÃ¶ner */
                    #driver-view button:not(#power-save-btn):not([style*="background:#10b981"]) {
                        background: linear-gradient(135deg, #374151 0%, #1f2937 100%) !important;
                        color: #e5e7eb !important;
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                    }
                    
                    /* GrÃ¼ne Buttons bleiben grÃ¼n! */
                    #driver-view button[style*="background:#10b981"],
                    #driver-view button[style*="background: #10b981"] {
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
                        color: white !important;
                        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                    }
                    
                    /* Texte besser lesbar */
                    #driver-view h3,
                    #driver-view h4 {
                        color: #f3f4f6 !important;
                    }
                    
                    #driver-view .status-text {
                        color: #d1d5db !important;
                    }
                    
                    /* Karten-Overlays dunkler */
                    #driver-view .leaflet-container {
                        filter: brightness(0.8) saturate(0.9);
                    }
                    
                    /* Smooth Transitions fÃ¼r alles */
                    #driver-view * {
                        transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
                    }
                `;
                document.head.appendChild(darkStyle);
                console.log('ğŸŒ™ Dark Mode aktiviert (SCHÃ–N!)');
            },
            
            disableDarkMode: function() {
                const style = document.getElementById('dark-mode-style');
                if (style) {
                    style.remove();
                    console.log('â˜€ï¸ Dark Mode deaktiviert');
                }
            },
            
            startAutoTimer: function() {
                // Stoppe bestehende Timer
                this.cancelAuto();
                
                // PrÃ¼fe alle 10 Sekunden
                this.autoTimer = setInterval(() => {
                    // Nur wenn Fahrer FREI ist (online, kein aktueller Auftrag)
                    if (!isOnline || !currentVehicle || myCurrentRide) {
                        return;
                    }
                    
                    // Nur wenn NICHT bereits in Power-Save
                    if (this.mode === 'POWER_SAVE') return;
                    
                    // PrÃ¼fe InaktivitÃ¤t
                    const inactiveMinutes = (Date.now() - this.lastActivity) / 60000;
                    
                    // Nach 4.5 Min: Zeige Warnung (30 Sek Countdown)
                    if (inactiveMinutes >= 4.5 && !this.warningTimer) {
                        this.showAutoWarning();
                    }
                }, 10000);
            },
            
            showAutoWarning: function() {
                console.log('âš ï¸ Auto Power-Save Warnung');
                
                const warning = document.getElementById('power-save-warning');
                if (!warning) return;
                
                warning.style.display = 'block';
                let countdown = 30;
                
                this.warningTimer = setInterval(() => {
                    countdown--;
                    const countdownEl = document.getElementById('countdown');
                    if (countdownEl) countdownEl.textContent = countdown;
                    
                    if (countdown <= 0) {
                        this.activateAutoPowerSave();
                    }
                }, 1000);
            },
            
            activateAutoPowerSave: function() {
                this.cancelAuto();
                const warning = document.getElementById('power-save-warning');
                if (warning) warning.style.display = 'none';
                
                console.log('ğŸ”‹ Auto Power-Save aktiviert');
                this.setMode('POWER_SAVE', 'auto');
            },
            
            cancelAuto: function() {
                if (this.warningTimer) {
                    clearInterval(this.warningTimer);
                    this.warningTimer = null;
                }
                
                const warning = document.getElementById('power-save-warning');
                if (warning) warning.style.display = 'none';
                
                // Reset Activity
                this.resetActivity();
            },
            
            resetActivity: function() {
                this.lastActivity = Date.now();
                
                // Wenn in Power-Save und User ist aktiv â†’ zurÃ¼ck zu Normal
                if (this.mode === 'POWER_SAVE') {
                    this.setMode('NORMAL', 'user_activity');
                }
            },
            
            updateBatteryDisplay: function() {
                const display = document.getElementById('battery-display');
                if (!display) return;
                
                const level = this.batteryLevel;
                let color = '#10b981'; // GrÃ¼n
                let icon = 'ğŸ”‹';
                
                if (level <= 20) {
                    color = '#ef4444';
                    icon = 'ğŸª«';
                } else if (level <= 50) {
                    color = '#f59e0b';
                    icon = 'ğŸ”‹';
                }
                
                display.style.color = color;
                display.style.background = `rgba(${color === '#ef4444' ? '239,68,68' : color === '#f59e0b' ? '245,158,11' : '16,185,129'},0.1)`;
                display.innerHTML = `${icon} ${level}%`;
            },
            
            // Bei neuem Auftrag: ZurÃ¼ck zu NORMAL
            onNewRide: function() {
                if (this.mode !== 'NORMAL') {
                    console.log('ğŸ“± Neuer Auftrag â†’ Normal Modus');
                    this.setMode('NORMAL', 'new_ride');
                }
                this.resetActivity();
            }
        };
        
        // Initialisiere Batterie-System beim App-Start
        setTimeout(() => {
            if (currentView === 'driver') {
                PowerSaveManager.init();
            }
        }, 1000);
        
        // AktivitÃ¤t-Tracking (bei jedem Touch)
        document.addEventListener('touchstart', () => {
            if (currentView === 'driver') {
                PowerSaveManager.resetActivity();
            }
        });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function cancelRideConfirm(rideId) {
            // ğŸ›¡ï¸ Verhindere Doppelklick
            if (cancelInProgress) {
                console.log('â³ Stornierung lÃ¤uft bereits...');
                return;
            }
            cancelInProgress = true;
            
            const ride = myCurrentRide;
            
            let confirmMessage = 'ğŸ—‘ï¸ Fahrt wirklich stornieren?\n\nDie Buchung wird gelÃ¶scht.';
            let hasCancellationFee = false;
            
            // ğŸ†• v5.26.13: PROZENTUALE StornogebÃ¼hr (15% vom Fahrpreis)
            const cancellationPercentage = 15; // 15% StornogebÃ¼hr
            const cancellationFee = ride ? (parseFloat(ride.price) * cancellationPercentage / 100) : 0;
            
            // ğŸ†• NEUE REGEL: 60 Minuten vor Abholzeit = kostenpflichtig
            if (ride) {
                const now = Date.now();
                // Abholzeit: pickupTimestamp oder bei Sofort-Fahrten: createdAt
                const pickupTime = ride.pickupTimestamp || ride.createdAt || now;
                const minutesUntilPickup = (pickupTime - now) / 60000;
                
                console.log('â° Minuten bis Abholung:', Math.round(minutesUntilPickup));
                console.log('ğŸ’° Fahrpreis:', ride.price + 'â‚¬');
                console.log('ğŸ“Š StornogebÃ¼hr (15%):', cancellationFee.toFixed(2) + 'â‚¬');
                
                if (minutesUntilPickup <= 60) {
                    // WENIGER ALS 60 MINUTEN - KOSTENPFLICHTIG!
                    hasCancellationFee = true;
                    
                    if (minutesUntilPickup <= 0) {
                        // Sofort-Fahrt oder Abholzeit schon vorbei
                        confirmMessage = 'âš ï¸ KOSTENPFLICHTIGE STORNIERUNG!\n\n' +
                            'ğŸ’¶ StornogebÃ¼hr: ' + cancellationFee.toFixed(2) + 'â‚¬ (' + cancellationPercentage + '% vom Fahrpreis)\n' +
                            '(Wird bei nÃ¤chster Fahrt berechnet)\n\n' +
                            'Trotzdem stornieren?\n\n' +
                            '(Kostenlos stornieren: 038378 / 1234)';
                    } else {
                        confirmMessage = 'âš ï¸ KOSTENPFLICHTIGE STORNIERUNG!\n\n' +
                            'Abholung in ' + Math.round(minutesUntilPickup) + ' Minuten.\n' +
                            '(Kostenlos bis 60 Min. vorher)\n\n' +
                            'ğŸ’¶ StornogebÃ¼hr: ' + cancellationFee.toFixed(2) + 'â‚¬ (' + cancellationPercentage + '% vom Fahrpreis)\n' +
                            '(Wird bei nÃ¤chster Fahrt berechnet)\n\n' +
                            'Trotzdem stornieren?\n\n' +
                            '(Kostenlos stornieren: 038378 / 1234)';
                    }
                } else {
                    // MEHR ALS 60 MINUTEN - KOSTENLOS
                    confirmMessage = 'ğŸ—‘ï¸ Fahrt stornieren?\n\n' +
                        'Abholung in ' + Math.round(minutesUntilPickup) + ' Minuten.\n\n' +
                        'âœ… Stornierung ist kostenlos.\n' +
                        '(Bis 60 Min. vor Abholung)';
                }
            }
            
            const confirmed = confirm(confirmMessage);
            
            if (!confirmed) {
                cancelInProgress = false; // Reset bei Abbruch
                return;
            }
            
            // StornogebÃ¼hr speichern
            if (hasCancellationFee) {
                const cancellation = {
                    rideId: ride.id,
                    customerName: ride.customerName,
                    pickup: ride.pickup,
                    destination: ride.destination,
                    originalPrice: ride.price,
                    cancellationFee: cancellationFee,
                    cancelledAt: Date.now(),
                    reason: 'less_than_60min_before_pickup'
                };
                
                // Speichere Stornierung in Firebase
                if (isFirebaseReady) {
                    await db.ref('cancellations').push(cancellation);
                    console.log('ğŸ’¶ StornogebÃ¼hr gespeichert:', cancellationFee + 'â‚¬');
                }
            }
            
            // ğŸ†• VEREINFACHT: Direkt auf 'cancelled' setzen - Fahrer wird nur benachrichtigt, muss nicht bestÃ¤tigen
            if (isFirebaseReady && rideId) {
                // ğŸ†• v5.20.7: SOFORT zur cancelled-Liste hinzufÃ¼gen BEVOR alles andere!
                recentlyCancelledRideIds.add(rideId);
                console.log('ğŸ›¡ï¸ Ride-ID zu cancelled-Set hinzugefÃ¼gt:', rideId);
                
                // ğŸ†• v5.20.4: ZUERST alle Listener stoppen!
                db.ref('rides/' + rideId).off();
                console.log('ğŸ›‘ Listener fÃ¼r Fahrt gestoppt:', rideId);
                
                // ğŸ†• v5.20.4: TELEGRAM AN FAHRER BEI STORNIERUNG!
                if (ride && ride.assignedTo) {
                    console.log('ğŸ“± Versuche Stornierung-Telegram zu senden an:', ride.assignedTo);
                    
                    const cancelMessage = `ğŸš« <b>FAHRT STORNIERT!</b>\n\n` +
                        `ğŸ‘¤ Kunde: ${ride.customerName}\n` +
                        `ğŸ“ Von: ${ride.pickup}\n` +
                        `ğŸ¯ Nach: ${ride.destination}\n` +
                        `ğŸ’° Preis: ${ride.price}â‚¬\n\n` +
                        `âŒ Der Kunde hat die Fahrt storniert.` +
                        (hasCancellationFee ? `\nğŸ’¶ StornogebÃ¼hr: ${cancellationFee}â‚¬` : '');
                    
                    // ğŸ†• v5.20.9: Mit await und besserem Error-Handling!
                    try {
                        const telegramSuccess = await sendTelegramToDriverCancel(ride.assignedTo, cancelMessage);
                        if (telegramSuccess) {
                            console.log('âœ… Stornierung-Telegram erfolgreich gesendet!');
                        } else {
                            console.log('âš ï¸ Stornierung-Telegram konnte nicht gesendet werden');
                        }
                    } catch (telegramError) {
                        console.error('âŒ Telegram Fehler:', telegramError);
                    }
                } else {
                    console.log('â„¹ï¸ Keine assignedTo fÃ¼r Telegram - Fahrt war nicht zugewiesen');
                }
                
                await updateRide(rideId, {
                    status: 'cancelled',  // ğŸ†• Immer direkt cancelled!
                    cancelledAt: Date.now(),
                    cancelledBy: 'passenger',
                    cancellationFee: cancellationFee,
                    cancellationReason: hasCancellationFee ? 'Fahrer bereits unterwegs - StornogebÃ¼hr' : 'Kunde storniert'
                });
                console.log('âŒ Fahrt storniert in Firebase:', rideId);
                
                // ğŸ†• v5.20.0: Stoppe auch den Assignment-Timer falls aktiv!
                if (assignmentTimers && assignmentTimers[rideId]) {
                    clearTimeout(assignmentTimers[rideId]);
                    delete assignmentTimers[rideId];
                    console.log('ğŸ›‘ Assignment-Timer gestoppt fÃ¼r:', rideId);
                }
                
                // ğŸ“œ PROTOKOLL: Stornierung
                logActivity('status', 'cancelled', `Fahrt storniert${hasCancellationFee ? ' (GebÃ¼hr: ' + cancellationFee + 'â‚¬)' : ''}`, {
                    customer: ride?.customerName,
                    from: ride?.pickup,
                    to: ride?.destination,
                    price: ride?.price,
                    fee: hasCancellationFee ? cancellationFee : 0,
                    driver: ride?.assignedTo
                });
            }
            
            // ğŸ†• v5.20.4: Globale rides-Listener kurz pausieren und neu starten
            // um sicherzustellen dass die stornierte Fahrt nicht wieder angezeigt wird
            
            // âœ… Update auch localStorage!
            const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            const localRide = history.find(r => r.firebaseId === rideId || r.id === rideId);
            if (localRide) {
                localRide.status = 'cancelled';  // ğŸ†• Immer direkt cancelled
                localRide.cancelledAt = Date.now();
                localRide.cancellationFee = cancellationFee;
                localStorage.setItem('rideHistory', JSON.stringify(history));
                console.log('âœ… Fahrt in localStorage storniert');
            }
            
            // Lokalen Status zurÃ¼cksetzen
            localStorage.removeItem('myCurrentRideId');
            myCurrentRide = null;
            document.getElementById('ride-status-container').innerHTML = '';
            document.getElementById('booking-form').style.display = 'block';
            
            // ğŸ†• FORMULAR ZURÃœCKSETZEN nach Stornierung
            resetBookingForm();
            
            if (hasCancellationFee) {
                alert('âœ… Fahrt storniert!\n\nğŸ’¶ StornogebÃ¼hr: ' + cancellationFee.toFixed(2) + 'â‚¬\n\nWird bei deiner nÃ¤chsten Fahrt berechnet.');
            } else {
                alert('âœ… Fahrt storniert!');
            }
            
            // ğŸ›¡ï¸ Reset Doppelklick-Schutz
            cancelInProgress = false;
        }

        // ğŸ†• FORMULAR ZURÃœCKSETZEN (nach Stornierung oder abgeschlossener Fahrt)
        function resetBookingForm() {
            // Felder LEEREN
            document.getElementById('pickup').value = '';
            document.getElementById('destination').value = '';
            
            // ZurÃ¼cksetzen auf Default-Werte
            const oldPickupTime = document.getElementById('pickup-time');
            if (oldPickupTime) oldPickupTime.value = 'jetzt';
            document.getElementById('passengers').value = '1';
            
            // datetime Felder ausblenden falls sichtbar
            document.getElementById('custom-datetime').style.display = 'none';
            document.getElementById('custom-datetime-container').style.display = 'none';
            document.getElementById('datetime-help').style.display = 'none';
            
            // Preis-Anzeige ausblenden
            document.getElementById('price-display').innerHTML = '';
            document.getElementById('price-display').style.display = 'none';
            
            // ğŸ—ºï¸ Route-Karte ausblenden
            const routeMapEl = document.getElementById('route-map');
            if (routeMapEl) {
                routeMapEl.style.display = 'none';
            }
            if (routeMapInstance) {
                routeMapInstance.remove();
                routeMapInstance = null;
            }
            
            // "Taxi buchen" Button verstecken (WICHTIG!)
            const bookBtn = document.getElementById('book-btn');
            if (bookBtn) {
                bookBtn.style.display = 'none';
                bookBtn.style.visibility = 'hidden'; // Doppelt sicher!
            }
            
            // ğŸ†• PREIS-BUTTON ZURÃœCKSETZEN
            const priceBtn = document.getElementById('price-btn');
            if (priceBtn) {
                priceBtn.innerHTML = 'ğŸ’° Preis berechnen';
                priceBtn.classList.remove('btn-danger');
                priceBtn.classList.add('btn-primary');
            }
            priceCalculated = false;
            
            // VerfÃ¼gbare Taxis ausblenden
            document.getElementById('available-taxis-display').innerHTML = '';
            
            // Global Variablen zurÃ¼cksetzen
            window.currentPrice = null;
            window.currentDistance = null;
            window.currentDuration = null;
            pickupCoords = null;  // âœ… Ohne "window."!
            destCoords = null;    // âœ… Ohne "window."!
            
            // Booking-Kunde zurÃ¼cksetzen
            currentBookingCustomerId = null;
            const crmOption = document.getElementById('crm-save-option');
            if (crmOption) crmOption.style.display = 'none';
            
            console.log('âœ… Formular zurÃ¼ckgesetzt');
        }

        async function cancelRide() {
            // Statt zu lÃ¶schen, als "storniert" markieren!
            if (myCurrentRide) {
                const rideId = myCurrentRide.firebaseId || myCurrentRide.id;
                
                // Update Firebase mit updateRide() fÃ¼r Telegram-Benachrichtigung
                if (isFirebaseReady && rideId) {
                    try {
                        await updateRide(rideId, { 
                            status: 'storniert',
                            cancelledAt: Date.now()
                        });
                        console.log('âœ… Sofort-Fahrt in Firebase storniert');
                    } catch (error) {
                        console.error('âŒ Fehler beim Stornieren in Firebase:', error);
                    }
                }
                
                // Update localStorage
                const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
                const ride = history.find(r => r.firebaseId === rideId || r.id === rideId);
                if (ride) {
                    ride.status = 'storniert';
                    ride.cancelledAt = Date.now();
                    localStorage.setItem('rideHistory', JSON.stringify(history));
                    console.log('âœ… Sofort-Fahrt in localStorage storniert');
                }
            }
            
            // UI aufrÃ¤umen
            localStorage.removeItem('myCurrentRideId');
            myCurrentRide = null;
            document.getElementById('ride-status-container').innerHTML = '';
            document.getElementById('booking-form').style.display = 'block';
            
            // ğŸ†• FORMULAR ZURÃœCKSETZEN nach Stornierung
            resetBookingForm();
        }

        // DRIVER FUNCTIONS
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    // Wenn bereits aktiv, nicht neu anfordern
                    if (wakeLock !== null && !wakeLock.released) {
                        console.log('âœ… Wake Lock bereits aktiv');
                        return;
                    }
                    
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('âœ… Screen Wake Lock aktiviert');
                    
                    wakeLock.addEventListener('release', () => {
                        console.log('âš ï¸ Wake Lock freigegeben - versuche sofortige Reaktivierung');
                        wakeLock = null;
                        
                        // SOFORT neu aktivieren wenn noch online
                        if (isOnline) {
                            requestWakeLock();
                        }
                    });
                } else {
                    console.warn('âš ï¸ Wake Lock API nicht verfÃ¼gbar');
                }
            } catch (err) {
                console.error('âŒ Wake Lock Fehler:', err);
                wakeLock = null;
                
                // Bei Fehler sofort nochmal versuchen wenn online
                if (isOnline) {
                    setTimeout(() => {
                        if (wakeLock === null && isOnline) {
                            requestWakeLock();
                        }
                    }, 1000);
                }
            }
        }
        
        // ğŸ”„ Wake Lock alle 30 Sekunden checken & reaktivieren
        setInterval(() => {
            if (isOnline && currentView === 'driver') {
                if (wakeLock === null || wakeLock.released) {
                    console.log('ğŸ”„ Wake Lock Check: Reaktiviere...');
                    requestWakeLock();
                }
            }
        }, 30000); // Alle 30 Sekunden

        function releaseWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release();
                wakeLock = null;
            }
        }

        // ğŸš¨ FAHRER-BENACHRICHTIGUNG BEI STORNIERUNG
        async function notifyDriverOfCancellation(ride) {
            console.log('ğŸš¨ STORNIERUNG ERKANNT:', ride);
            
            // Spiele Sound ab (falls Browser erlaubt)
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ==');
                audio.play().catch(e => console.log('Audio play blocked'));
            } catch (e) {
                console.log('Audio not supported');
            }
            
            // SchlieÃŸe Karte falls offen
            closeDriverMap();
            
            // GroÃŸe Alert-Box
            const feeText = ride.cancellationFee ? `\n\nğŸ’¶ StornogebÃ¼hr: ${ride.cancellationFee.toFixed(2)}â‚¬\n(Wird dem Kunden berechnet)` : '';
            
            alert(
                `ğŸš¨ FAHRT STORNIERT!\n\n` +
                `#${ride.id} - ${ride.customerName || 'Fahrgast'}\n` +
                `Von: ${ride.pickup}\n` +
                `Nach: ${ride.destination}\n\n` +
                `âŒ Kunde hat gerade storniert!${feeText}\n\n` +
                `Fahrt wird archiviert.`
            );
            
            // Markiere als benachrichtigt in Firebase
            if (isFirebaseReady && ride.firebaseId) {
                await db.ref('rides/' + ride.firebaseId).update({
                    driverNotified: true,
                    driverNotifiedAt: Date.now()
                });
                console.log('âœ… Fahrer als benachrichtigt markiert');
            }
            
            // ğŸ”§ WICHTIG: GPS und Wake Lock neu aktivieren!
            console.log('ğŸ”„ Reaktiviere GPS und Wake Lock...');
            if (isOnline && currentVehicle) {
                requestWakeLock();
                // GPS lÃ¤uft schon, nur sicherstellen dass es aktiv ist
                if (!watchId) {
                    startDriverTracking(null);
                }
            }
            
            // Nach 5 Sekunden automatisch zu "completed" verschieben fÃ¼r Archivierung
            setTimeout(async () => {
                if (isFirebaseReady && ride.firebaseId) {
                    await db.ref('rides/' + ride.firebaseId).update({
                        status: 'completed',
                        archivedAsCancel: true
                    });
                    updateViews();
                }
            }, 5000);
        }
        
        // ğŸ“ KUNDE ANRUFEN
        function callCustomer() {
            const ride = rides.find(r => 
                r.vehicleId === currentVehicle && 
                (r.status === 'accepted' || r.status === 'picked_up')
            );
            
            if (!ride) {
                alert('âŒ Keine aktive Fahrt gefunden!');
                return;
            }
            
            if (!ride.customerPhone) {
                alert('âŒ Keine Telefonnummer hinterlegt!\n\nKunde hat keine Nummer angegeben.');
                return;
            }
            
            // Ã–ffne Telefon-App
            window.open('tel:' + ride.customerPhone);
        }
        
        // ğŸ“‹ UPDATE DRIVER INFO TOP
        // ğŸ“‹ UPDATE DRIVER CARDS (A3/B3 Design)
        function updateDriverInfoTop(ride) {
            if (!ride) {
                console.error('âŒ updateDriverInfoTop: Kein ride!');
                return;
            }
            
            console.log('ğŸ“‹ updateDriverInfoTop called with ride:');
            console.log('   - id:', ride.id || ride.firebaseId);
            console.log('   - customerName:', ride.customerName);
            console.log('   - pickup:', ride.pickup);
            console.log('   - destination:', ride.destination);
            console.log('   - status:', ride.status);
            console.log('   - VOLLES OBJEKT:', JSON.stringify(ride));
            
            const rideId = ride.firebaseId || ride.id;
            
            // Customer Name
            const customerName = document.getElementById('driver-customer-name');
            if (customerName) {
                customerName.textContent = 'ğŸ‘¤ ' + (ride.customerName || 'Kunde');
            }
            
            // Call Button
            const callButton = document.getElementById('driver-call-button');
            if (callButton) {
                // Nur zeigen wenn: Telefon DA + noch unterwegs zum Kunden
                if (ride.customerPhone && ride.status === 'accepted') {
                    callButton.style.display = 'block';
                } else {
                    callButton.style.display = 'none';  // Verstecken wenn Kunde an Bord
                }
            }
            
            // Cards Container
            const customerCard = document.getElementById('driver-customer-card');
            const priceCard = document.getElementById('driver-price-card');
            const pickupCard = document.getElementById('driver-pickup-card');
            const destCard = document.getElementById('driver-dest-card');
            
            if (ride.status === 'accepted') {
                // A3 Design: Zum Kunden
                // Zeige: Kunde, Pickup, Destination
                // Verstecke: Preis
                
                if (customerCard) customerCard.style.gridColumn = '1 / -1';
                if (priceCard) priceCard.style.display = 'none';
                if (pickupCard) {
                    pickupCard.style.display = 'block';
                    const pickupValue = document.getElementById('driver-pickup-value');
                    if (pickupValue) pickupValue.textContent = ride.pickup || '-';
                }
                if (destCard) {
                    const destValue = document.getElementById('driver-dest-value');
                    if (destValue) destValue.textContent = ride.destination || '-';
                }
                
            } else if (ride.status === 'picked_up') {
                // B3 Design: Kunde an Bord
                // Zeige: Kunde, Preis, Destination
                // Verstecke: Pickup
                
                const cardsContainer = document.getElementById('driver-cards-container');
                if (cardsContainer) {
                    cardsContainer.style.gridTemplateColumns = '2fr 1fr';
                }
                
                if (customerCard) customerCard.style.gridColumn = '';
                if (priceCard) {
                    priceCard.style.display = 'block';
                    const priceValue = document.getElementById('driver-price-value');
                    if (priceValue) priceValue.textContent = 'ğŸ’° ' + (ride.price || '-') + 'â‚¬';
                }
                if (pickupCard) pickupCard.style.display = 'none';
                if (destCard) {
                    destCard.style.gridColumn = '1 / -1';
                    const destValue = document.getElementById('driver-dest-value');
                    if (destValue) destValue.textContent = ride.destination || '-';
                }
            }
            
            // Action Button
            const actionButton = document.getElementById('driver-action-button');
            if (actionButton) {
                if (ride.status === 'accepted') {
                    actionButton.textContent = 'ğŸš— Beim Kunden angekommen';
                    actionButton.onclick = () => pickupCustomer(rideId);
                    actionButton.style.background = '#667eea';
                } else if (ride.status === 'picked_up') {
                    actionButton.textContent = 'âœ… Ziel erreicht';
                    actionButton.onclick = () => completeRide(rideId);
                    actionButton.style.background = '#10b981';
                }
            }
        }

        // ğŸ†• v5.18.0: FAHRER TELEGRAM-ID SPEICHERN
        // ğŸ†• v5.20.0: Speichert jetzt pro USER (nicht mehr pro Fahrzeug!)
        async function saveDriverTelegramId() {
            // ğŸ†• v5.20.0: PrÃ¼fe ob User eingeloggt ist (Fahrzeug nicht mehr nÃ¶tig!)
            if (!currentUser || !currentUser.uid) {
                alert('âŒ Bitte erst einloggen!');
                return;
            }
            
            const chatId = document.getElementById('driver-telegram-id').value.trim();
            if (!chatId) {
                alert('âŒ Bitte Chat-ID eingeben!');
                return;
            }
            
            // Validiere dass es eine Zahl ist
            if (!/^-?\d+$/.test(chatId)) {
                alert('âŒ UngÃ¼ltige Chat-ID!\n\nDie Chat-ID besteht nur aus Zahlen (z.B. 123456789)');
                return;
            }
            
            if (!isFirebaseReady) {
                alert('âŒ Firebase nicht verbunden!');
                return;
            }
            
            // ğŸ†• v5.19.0: PrÃ¼fe ob User eingeloggt ist
            if (!currentUser || !currentUser.uid) {
                alert('âŒ Bitte erst einloggen!');
                return;
            }
            
            try {
                // ğŸ†• v5.19.0: Speichere Telegram-ID beim USER (nicht Fahrzeug!)
                const userContact = currentUser.email || currentUser.phoneNumber || 'Unbekannt';
                await db.ref('users/' + currentUser.uid + '/telegramChatId').set(chatId);
                
                // Update Status-Anzeige
                document.getElementById('driver-telegram-status').innerHTML = 
                    'âœ… <span style="color:#10b981">Telegram aktiv fÃ¼r ' + userContact + '</span>';
                
                // Speichere auch lokal
                localStorage.setItem('driverTelegramId_' + currentUser.uid, chatId);
                
                console.log('âœ… Telegram-ID gespeichert fÃ¼r User', userContact, ':', chatId);
                alert('âœ… Telegram-ID gespeichert!\n\nDu bekommst jetzt Fahrt-Alarme direkt aufs Handy - egal welches Fahrzeug du fÃ¤hrst!');
                
            } catch (error) {
                console.error('âŒ Fehler beim Speichern:', error);
                alert('âŒ Fehler beim Speichern: ' + error.message);
            }
        }
        
        // ğŸ†• v5.18.0: TEST TELEGRAM AN FAHRER
        async function testDriverTelegram() {
            // ğŸ†• v5.19.0: PrÃ¼fe User statt Fahrzeug
            if (!currentUser || !currentUser.uid) {
                alert('âŒ Bitte erst einloggen!');
                return;
            }
            
            const chatId = document.getElementById('driver-telegram-id').value.trim();
            if (!chatId) {
                alert('âŒ Bitte erst Chat-ID eingeben und speichern!');
                return;
            }
            
            const userContact = currentUser.email || currentUser.phoneNumber || 'Unbekannt';
            const testMessage = `âœ… <b>Test erfolgreich!</b>\n\n` +
                `Du erhÃ¤ltst jetzt Fahrt-Alarme fÃ¼r: ${userContact}\n\n` +
                `ğŸš• Funk Taxi Heringsdorf`;
            
            const success = await sendTelegramMessage(chatId, testMessage);
            
            if (success) {
                alert('âœ… Test-Nachricht gesendet!\n\nPrÃ¼fe dein Telegram!');
            } else {
                alert('âŒ Fehler beim Senden!\n\nIst die Chat-ID korrekt?');
            }
        }
        
        // ğŸ†• v5.19.0: TELEGRAM-ID VOM USER LADEN (nicht mehr vom Fahrzeug!)
        async function loadDriverTelegramId() {
            if (!currentUser || !currentUser.uid || !isFirebaseReady) return;
            
            try {
                const snapshot = await db.ref('users/' + currentUser.uid + '/telegramChatId').once('value');
                const chatId = snapshot.val();
                
                const input = document.getElementById('driver-telegram-id');
                const status = document.getElementById('driver-telegram-status');
                const userContact = currentUser.email || currentUser.phoneNumber || 'Unbekannt';
                
                if (chatId && input && status) {
                    input.value = chatId;
                    status.innerHTML = 'âœ… <span style="color:#10b981">Telegram aktiv fÃ¼r ' + userContact + '</span>';
                } else if (input && status) {
                    input.value = '';
                    status.innerHTML = 'â“ Noch nicht eingerichtet';
                }
            } catch (error) {
                console.error('Fehler beim Laden der Telegram-ID:', error);
            }
        }

        function toggleOnline() {
            isOnline = document.getElementById('online-toggle').checked;
            
            // ğŸ†• v5.20.2: Online-Status speichern fÃ¼r Auto-Restore
            if (currentUser && currentUser.uid) {
                localStorage.setItem('lastOnlineStatus_' + currentUser.uid, isOnline ? 'true' : 'false');
                console.log('ğŸ’¾ Online-Status gespeichert:', isOnline);
            }
            
            // ğŸ“œ PROTOKOLL: Fahrer Online/Offline (mit Grund + Email!)
            const vehicleName = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle;
            const userContact = currentUser ? (currentUser.email || currentUser.phoneNumber || 'Unbekannt') : 'Unbekannt';
            const reason = isOnline ? '' : ' (Toggle)';
            logActivity('driver', isOnline ? 'online' : 'offline', 
                `Fahrer ${userContact} (${vehicleName}) ist jetzt ${isOnline ? 'ONLINE' : 'OFFLINE'}${reason}`, {
                vehicle: currentVehicle,
                driver: vehicleName,
                email: userContact,
                reason: isOnline ? 'toggle_on' : 'toggle_off'
            });
            
            // âœ… Sichere Zugriffe auf optionale Elemente
            const statusText = document.getElementById('online-status-text');
            if (statusText) {
                statusText.textContent = isOnline ? 'Online' : 'Offline';
                statusText.style.color = isOnline ? '#10b981' : '#666';
            }
            
            const gpsIndicator = document.getElementById('gps-indicator');
            const gpsDot = document.getElementById('gps-dot');
            const gpsStatus = document.getElementById('gps-status');
            
            if (isOnline) {
                if (gpsIndicator) gpsIndicator.style.display = 'flex';
                if (gpsDot) {
                    gpsDot.style.background = '#10b981';
                    gpsDot.classList.add('online');
                }
                if (gpsStatus) gpsStatus.textContent = 'ğŸ“ GPS On';
                requestWakeLock();
            } else {
                if (gpsDot) {
                    gpsDot.style.background = '#6b7280';
                    gpsDot.classList.remove('online');
                }
                if (gpsStatus) gpsStatus.textContent = 'ğŸ“ GPS Off';
                releaseWakeLock();
            }
            
            if (isOnline && currentVehicle) {
                // ğŸ†• v5.19.0: Starte STANDBY-Modus (nicht aktives GPS!)
                startStandbyTracking();
            }
            else {
                stopDriverTracking();
                // Stoppe auch Standby
                if (standbyIntervalId) {
                    clearInterval(standbyIntervalId);
                    standbyIntervalId = null;
                }
                gpsMode = 'off';
                // ğŸ“Š WICHTIG: Sende offline-Status an Firebase!
                if (currentVehicle && isFirebaseReady) {
                    db.ref('drivers/' + currentVehicle).update({
                        online: false,
                        lastOffline: Date.now()
                    }).then(() => {
                        console.log('ğŸ“´ Fahrer als OFFLINE in Firebase markiert');
                    }).catch(err => {
                        console.error('âŒ Fehler beim Offline-Setzen:', err);
                    });
                }
            }
        }

        function setVehicle() {
            const previousVehicle = currentVehicle;
            const vehicleId = document.getElementById('vehicle').value;
            
            // âœ… Stoppe GPS wenn Fahrzeug wechselt
            if (previousVehicle && previousVehicle !== vehicleId) {
                console.log('ğŸ”„ Fahrzeugwechsel erkannt - stoppe GPS');
                stopDriverTracking();
                stopGPSMonitoring();
                
                // ğŸ“´ WICHTIG: Altes Fahrzeug in Firebase offline setzen!
                if (isFirebaseReady) {
                    db.ref('drivers/' + previousVehicle).update({
                        online: false,
                        lastOffline: Date.now()
                    }).then(() => {
                        console.log('ğŸ“´ Altes Fahrzeug offline gesetzt:', previousVehicle);
                    });
                    
                    // Log-Eintrag
                    const prevName = VEHICLES[previousVehicle] ? VEHICLES[previousVehicle].name : previousVehicle;
                    const userContact = currentUser ? (currentUser.email || currentUser.phoneNumber || 'Unbekannt') : 'Unbekannt';
                    logActivity('driver', 'offline', 
                        `Fahrer ${userContact} (${prevName}) ist jetzt OFFLINE (Fahrzeugwechsel)`, {
                        vehicle: previousVehicle,
                        driver: prevName,
                        email: userContact
                    });
                }
            }
            
            currentVehicle = vehicleId;
            console.log('ğŸš— Fahrzeug gewÃ¤hlt:', currentVehicle);
            
            // ğŸ†• v5.20.1: Fahrzeug in localStorage speichern (fÃ¼r Wiederherstellung)
            if (currentVehicle && currentUser) {
                localStorage.setItem('lastVehicle_' + currentUser.uid, currentVehicle);
                console.log('ğŸ’¾ Fahrzeug gespeichert fÃ¼r User:', currentUser.uid);
            }
            
            // ğŸ”’ NEUE LOGIK: Toggle nur aktivieren wenn Fahrzeug gewÃ¤hlt!
            const toggle = document.getElementById('online-toggle');
            if (toggle) {
                if (currentVehicle) {
                    toggle.disabled = false;
                    toggle.style.opacity = '1';
                    toggle.style.cursor = 'pointer';
                    console.log('âœ… Online-Toggle aktiviert');
                } else {
                    toggle.disabled = true;
                    toggle.checked = false;
                    toggle.style.opacity = '0.5';
                    toggle.style.cursor = 'not-allowed';
                    isOnline = false;
                    console.log('ğŸ”’ Online-Toggle gesperrt - kein Fahrzeug');
                    
                    // GPS stoppen wenn kein Fahrzeug
                    if (watchId) {
                        stopDriverTracking();
                    }
                }
            }
            
            if (currentVehicle && isOnline) startDriverTracking(null);
            
            // ğŸ†• v5.18.0: Telegram-ID fÃ¼r dieses Fahrzeug laden
            if (currentVehicle) {
                loadDriverTelegramId();
                
                // âš™ï¸ v5.24.0: Driver-Settings laden
                if (typeof DriverSettingsManager !== 'undefined') {
                    DriverSettingsManager.init(currentVehicle);
                }
            }
            
            updateViews();
        }

        // ğŸ†• v5.20.2: GESPEICHERTES FAHRZEUG + STATUS LADEN (aus localStorage)
        async function loadSavedVehicle() {
            if (!currentUser || !currentUser.uid) {
                console.log('â³ Warte auf Login fÃ¼r Fahrzeug-Wiederherstellung...');
                return;
            }
            
            const savedVehicle = localStorage.getItem('lastVehicle_' + currentUser.uid);
            const savedOnlineStatus = localStorage.getItem('lastOnlineStatus_' + currentUser.uid);
            
            if (!savedVehicle) {
                console.log('â„¹ï¸ Kein gespeichertes Fahrzeug gefunden');
                return;
            }
            
            console.log('ğŸ”„ Gespeichertes Fahrzeug gefunden:', savedVehicle, 'Online:', savedOnlineStatus);
            
            // PrÃ¼fe ob Fahrzeug von jemand anderem benutzt wird
            if (isFirebaseReady) {
                try {
                    const driverSnapshot = await db.ref('drivers/' + savedVehicle).once('value');
                    const driverData = driverSnapshot.val();
                    
                    if (driverData && driverData.online && driverData.userId && driverData.userId !== currentUser.uid) {
                        // Fahrzeug wird von jemand anderem benutzt!
                        console.log('âš ï¸ Fahrzeug wird von anderem User benutzt:', driverData.userId);
                        alert('âš ï¸ Dein letztes Fahrzeug (' + (VEHICLES[savedVehicle]?.name || savedVehicle) + ') wird gerade von einem anderen Fahrer benutzt.\n\nBitte wÃ¤hle ein anderes Fahrzeug.');
                        return;
                    }
                    
                    // Fahrzeug ist frei - automatisch auswÃ¤hlen
                    const dropdown = document.getElementById('vehicle');
                    if (dropdown) {
                        dropdown.value = savedVehicle;
                        currentVehicle = savedVehicle;
                        console.log('âœ… Fahrzeug automatisch wiederhergestellt:', savedVehicle);
                        
                        // Toggle aktivieren
                        const toggle = document.getElementById('online-toggle');
                        if (toggle) {
                            toggle.disabled = false;
                            toggle.style.opacity = '1';
                            toggle.style.cursor = 'pointer';
                            
                            // ğŸ†• v5.20.2: War der Fahrer vorher online? Dann automatisch wieder online!
                            if (savedOnlineStatus === 'true') {
                                console.log('ğŸŸ¢ Fahrer war online - stelle Status wieder her...');
                                toggle.checked = true;
                                isOnline = true;
                                
                                // GPS starten
                                startDriverTracking(null);
                                
                                // In Firebase als online markieren
                                const userContact = currentUser.email || currentUser.phoneNumber || 'Unbekannt';
                                db.ref('drivers/' + savedVehicle).update({
                                    online: true,
                                    userId: currentUser.uid,
                                    userEmail: userContact,
                                    lastOnline: Date.now()
                                });
                                
                                console.log('âœ… Fahrer automatisch wieder ONLINE!');
                                
                                // Protokoll
                                const vehicleName = VEHICLES[savedVehicle]?.name || savedVehicle;
                                logActivity('driver', 'online', 
                                    `Fahrer ${userContact} (${vehicleName}) ist jetzt ONLINE (Auto-Restore)`, {
                                    vehicle: savedVehicle,
                                    driver: vehicleName,
                                    email: userContact
                                });
                            }
                        }
                        
                        // Telegram-ID laden
                        loadDriverTelegramId();
                        
                        updateViews();
                    }
                    
                } catch (error) {
                    console.error('âŒ Fehler beim PrÃ¼fen des Fahrzeugs:', error);
                }
            }
        }

        // ğŸ”„ TOGGLE STATE SYNCHRONISIEREN
        function syncToggleState() {
            const toggle = document.getElementById('online-toggle');
            if (!toggle) return;
            
            console.log('ğŸ”„ Synchronisiere Toggle-State...');
            console.log('  - watchId:', watchId);
            console.log('  - isOnline:', isOnline);
            console.log('  - currentVehicle:', currentVehicle);
            
            // PrÃ¼fe ob GPS wirklich lÃ¤uft
            if (watchId && currentVehicle) {
                // GPS lÃ¤uft - soll online sein
                if (!isOnline || !toggle.checked) {
                    console.log('âœ… GPS lÃ¤uft, aber Toggle off â†’ Korrigiere auf ON');
                    isOnline = true;
                    toggle.checked = true;
                    
                    // Update UI
                    const statusText = document.getElementById('online-status-text');
                    if (statusText) {
                        statusText.textContent = 'Online';
                        statusText.style.color = '#10b981';
                    }
                }
            } else {
                // Kein GPS - soll offline sein
                if (isOnline || toggle.checked) {
                    console.log('âš ï¸ Kein GPS, aber Toggle on â†’ Korrigiere auf OFF');
                    isOnline = false;
                    toggle.checked = false;
                    
                    // Update UI
                    const statusText = document.getElementById('online-status-text');
                    if (statusText) {
                        statusText.textContent = 'Offline';
                        statusText.style.color = '#666';
                    }
                }
            }
            
            console.log('âœ… Toggle-State synchronisiert:', isOnline ? 'ON' : 'OFF');
        }

        // ğŸ†• v5.19.0: STANDBY-MODUS (LTE/WiFi - grobe Position)
        // LÃ¤uft im Hintergrund, geringer Akku, reicht fÃ¼r Auftragsvermittlung!
        function startStandbyTracking() {
            if (!currentVehicle) {
                console.error('âŒ Kein Fahrzeug ausgewÃ¤hlt!');
                return;
            }
            
            // Stoppe evtl. laufendes aktives GPS
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            // Stoppe evtl. laufendes Standby-Interval
            if (standbyIntervalId) {
                clearInterval(standbyIntervalId);
                standbyIntervalId = null;
            }
            
            gpsMode = 'standby';
            console.log('ğŸ“¡ STANDBY-MODUS gestartet (LTE/WiFi, alle 2 Min)');
            
            // Update UI
            const statusDiv = document.getElementById('gps-status-compact');
            const iconSpan = document.getElementById('gps-icon-compact');
            const textSpan = document.getElementById('gps-text-compact');
            if (statusDiv && iconSpan && textSpan) {
                statusDiv.style.background = 'rgba(59,130,246,0.1)';
                statusDiv.style.color = '#3b82f6';
                iconSpan.textContent = 'ğŸ“¡';
                textSpan.textContent = 'Standby';
            }
            
            // ğŸ“œ PROTOKOLL
            const vehicleName = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle;
            logActivity('gps', 'standby', `ğŸ“¡ Standby-Modus: ${vehicleName}`, {
                vehicle: currentVehicle,
                driver: vehicleName,
                mode: 'standby'
            });
            
            // SOFORT erste Position holen (grob)
            getStandbyPosition();
            
            // ğŸ†• v5.20.6: Alle 2 Minuten (statt 5) fÃ¼r bessere ZuverlÃ¤ssigkeit
            standbyIntervalId = setInterval(() => {
                if (isOnline && currentVehicle && gpsMode === 'standby') {
                    getStandbyPosition();
                }
            }, 2 * 60 * 1000); // 2 Minuten
            
            console.log('âœ… Standby-Interval gestartet (alle 2 Min)');
        }
        
        // ğŸ†• Grobe Position holen (Mobilfunk/WiFi)
        function getStandbyPosition() {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const location = { 
                        lat: pos.coords.latitude, 
                        lon: pos.coords.longitude, 
                        timestamp: Date.now(), 
                        vehicleId: currentVehicle,
                        vehicle: VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle,
                        online: isOnline,
                        accuracy: pos.coords.accuracy,
                        mode: 'standby', // ğŸ†• Markiere als Standby-Position
                        userEmail: currentUser ? (currentUser.email || currentUser.phoneNumber || '') : '',
                        userId: currentUser ? currentUser.uid : ''
                    };
                    
                    console.log('ğŸ“¡ Standby-Position:', location.lat.toFixed(4), location.lon.toFixed(4), 
                                'Genauigkeit:', Math.round(location.accuracy), 'm');
                    
                    // Update UI
                    const statusDiv = document.getElementById('gps-status-compact');
                    const iconSpan = document.getElementById('gps-icon-compact');
                    const textSpan = document.getElementById('gps-text-compact');
                    if (statusDiv && iconSpan && textSpan) {
                        statusDiv.style.background = 'rgba(16,185,129,0.1)';
                        statusDiv.style.color = '#10b981';
                        iconSpan.textContent = 'ğŸ“¡';
                        textSpan.textContent = Math.round(location.accuracy) + 'm';
                    }
                    
                    // In Firebase speichern
                    if (isFirebaseReady) {
                        db.ref('drivers/' + currentVehicle).set(location).then(() => {
                            console.log('âœ… Standby-Position â†’ Firebase');
                        }).catch(err => {
                            console.error('âŒ Standby-Upload Fehler:', err);
                        });
                    }
                    
                    // Update lastGPSUpdate
                    lastGPSUpdate = Date.now();
                },
                (err) => {
                    console.warn('âš ï¸ Standby-Position Fehler:', err.message);
                    
                    // Update UI
                    const statusDiv = document.getElementById('gps-status-compact');
                    const iconSpan = document.getElementById('gps-icon-compact');
                    const textSpan = document.getElementById('gps-text-compact');
                    if (statusDiv && iconSpan && textSpan) {
                        statusDiv.style.background = 'rgba(239,68,68,0.1)';
                        statusDiv.style.color = '#ef4444';
                        iconSpan.textContent = 'âŒ';
                        textSpan.textContent = 'Fehler';
                    }
                },
                { 
                    enableHighAccuracy: false,  // ğŸ”‘ WICHTIG: Nutzt LTE/WiFi statt GPS!
                    maximumAge: 5 * 60 * 1000,  // Akzeptiere 5 Min alte Position
                    timeout: 30000               // 30 Sek Timeout
                }
            );
        }
        
        // ğŸ†• v5.19.0: AKTIV-MODUS (GPS prÃ¤zise - fÃ¼r laufende Fahrt)
        function startActiveTracking(rideId) {
            if (!currentVehicle) {
                console.error('âŒ Kein Fahrzeug ausgewÃ¤hlt!');
                return;
            }
            
            // Stoppe Standby-Modus
            if (standbyIntervalId) {
                clearInterval(standbyIntervalId);
                standbyIntervalId = null;
            }
            
            gpsMode = 'active';
            currentTrackingRideId = rideId || null;
            console.log('ğŸ¯ AKTIV-MODUS gestartet (GPS prÃ¤zise)' + (rideId ? ' fÃ¼r Fahrt: ' + rideId : ''));
            
            // Update UI
            const statusDiv = document.getElementById('gps-status-compact');
            const iconSpan = document.getElementById('gps-icon-compact');
            const textSpan = document.getElementById('gps-text-compact');
            if (statusDiv && iconSpan && textSpan) {
                statusDiv.style.background = 'rgba(102,126,234,0.1)';
                statusDiv.style.color = '#667eea';
                iconSpan.textContent = 'ğŸ”„';
                textSpan.textContent = 'GPS...';
            }
            
            // Rufe die bestehende GPS-Funktion auf
            startDriverTracking(rideId);
        }
        
        // ğŸ†• v5.19.0: ZurÃ¼ck zu Standby nach Fahrt
        function switchToStandby() {
            if (!isOnline || !currentVehicle) return;
            
            console.log('ğŸ”„ Wechsle zurÃ¼ck zu Standby-Modus...');
            
            // Stoppe aktives GPS
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            // Stoppe Intervalle
            if (window.gpsRegularInterval) {
                clearInterval(window.gpsRegularInterval);
                window.gpsRegularInterval = null;
            }
            
            currentTrackingRideId = null;
            
            // Starte Standby
            startStandbyTracking();
        }

        function startDriverTracking(rideId) {
            if (!currentVehicle) {
                console.error('âŒ Kein Fahrzeug ausgewÃ¤hlt!');
                return;
            }
            
            // ğŸ†• Speichere aktuelle Fahrt-ID fÃ¼r GPS-Tracking
            currentTrackingRideId = rideId || null;
            
            // âœ… WICHTIG: Alte watchId IMMER cleanen BEVOR neu gestartet wird!
            if (watchId) {
                console.log('âš ï¸ GPS lÃ¤uft bereits - watchId:', watchId, '- STOPPE ERST!');
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                console.log('âœ… Alte watchId cleared');
            }
            
            console.log('ğŸš€ Starte GPS-Tracking' + (rideId ? ' fÃ¼r Fahrt: ' + rideId : ''));
            
            // ğŸ†• SOFORT: Status auf "Suche..." setzen
            const gpsIndicator = document.getElementById('gps-indicator');
            const gpsDot = document.getElementById('gps-dot');
            const gpsStatus = document.getElementById('gps-status');
            if (gpsIndicator && gpsDot && gpsStatus) {
                gpsIndicator.style.display = 'flex';
                gpsDot.classList.remove('online');
                gpsStatus.textContent = 'ğŸ“ GPS Suche...';
            }
            const statusDiv = document.getElementById('gps-status-compact');
            const iconSpan = document.getElementById('gps-icon-compact');
            const textSpan = document.getElementById('gps-text-compact');
            if (statusDiv && iconSpan && textSpan) {
                statusDiv.style.background = 'rgba(59,130,246,0.1)';
                statusDiv.style.color = '#3b82f6';
                iconSpan.textContent = 'ğŸ”„';
                textSpan.textContent = 'Suche';
            }
            
            // ğŸ“œ PROTOKOLL: GPS gestartet
            const vehicleName = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle;
            logActivity('gps', 'active', `GPS aktiviert: ${vehicleName}`, {
                vehicle: currentVehicle,
                driver: vehicleName,
                forRide: rideId || 'Standby'
            });
            
            // ğŸ†• ERST: Schnelle erste Position holen (mit niedrigerer Genauigkeit)
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    console.log('âš¡ SCHNELLE erste GPS-Position erhalten!');
                    handleGPSPosition(pos, rideId);
                },
                (err) => {
                    console.warn('âš ï¸ Schnelle Position fehlgeschlagen:', err.message);
                    // Nicht schlimm - watchPosition wird es holen
                },
                { 
                    enableHighAccuracy: false,  // Schneller!
                    maximumAge: 60000,          // Akzeptiere 1 Min alte Position
                    timeout: 5000               // Nur 5 Sek warten
                }
            );
            
            // DANN: watchPosition mit HIGH ACCURACY fÃ¼r kontinuierliche Updates
            watchId = navigator.geolocation.watchPosition(
                (pos) => {
                    handleGPSPosition(pos, rideId);
                },
                (err) => {
                    console.error('âŒ GPS Fehler:', err.message, err.code);
                    
                    // ğŸ“œ PROTOKOLL: GPS-Fehler
                    let errorReason = 'Unbekannter Fehler';
                    if (err.code === 1) errorReason = 'Berechtigung verweigert';
                    else if (err.code === 2) errorReason = 'Position nicht verfÃ¼gbar';
                    else if (err.code === 3) errorReason = 'Timeout';
                    
                    const vehicleName = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle;
                    logActivity('gps', 'error', `GPS-Fehler: ${errorReason}`, {
                        vehicle: currentVehicle,
                        driver: vehicleName,
                        errorCode: err.code,
                        errorMessage: err.message
                    });
                    
                    // Update GPS-Indicator
                    const gpsIndicator = document.getElementById('gps-indicator');
                    const gpsDot = document.getElementById('gps-dot');
                    const gpsStatus = document.getElementById('gps-status');
                    if (gpsIndicator && gpsDot && gpsStatus) {
                        gpsIndicator.style.display = 'flex';
                        gpsDot.classList.remove('online');
                        gpsStatus.textContent = 'ğŸ“ GPS: Fehler';
                    }
                    
                    // Bei Timeout (Code 3) -> Automatisch neu versuchen
                    if (err.code === 3 && isOnline) {
                        console.log('â±ï¸ GPS Timeout - versuche erneut in 5 Sekunden...');
                        setTimeout(() => {
                            if (isOnline && !watchId) {
                                console.log('ğŸ”„ GPS-Tracking neu starten...');
                                startDriverTracking(rideId);
                            }
                        }, 5000);
                    } else if (err.code === 1) {
                        // Berechtigung verweigert
                        alert('âŒ GPS-Berechtigung verweigert!\n\nBitte in den Einstellungen die Standort-Berechtigung fÃ¼r diese App aktivieren.');
                    }
                },
                { 
                    enableHighAccuracy: true, 
                    maximumAge: 10000,  // Akzeptiere max. 10 Sek alte Position
                    timeout: 30000      // 30 Sekunden Timeout
                }
            );
            
            console.log('ğŸ¯ GPS watchId:', watchId);
            
            // ğŸ†• Intervall alle 30 Sekunden - NUR wenn watchPosition kein Update liefert!
            window.gpsRegularInterval = setInterval(() => {
                if (!isOnline || !currentVehicle) {
                    return;
                }
                
                // PrÃ¼fe ob watchPosition kÃ¼rzlich ein Update geliefert hat
                const timeSinceLastUpdate = Date.now() - (lastGPSUpdate || 0);
                if (timeSinceLastUpdate < 25000) {
                    // watchPosition funktioniert - kein zusÃ¤tzliches Update nÃ¶tig
                    console.log('ğŸ“ GPS (30s Check): watchPosition aktiv, Ã¼berspringe');
                    return;
                }
                
                // watchPosition hat lÃ¤nger nicht gesendet - hole manuell Position
                console.log('ğŸ“ GPS (30s Intervall): Hole Position manuell...');
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        handleGPSPosition(pos, currentTrackingRideId);
                        console.log('ğŸ“ GPS (30s Intervall): Position erhalten');
                    },
                    (err) => {
                        console.warn('âš ï¸ GPS 30s Intervall-Fehler:', err.message);
                    },
                    { enableHighAccuracy: true, maximumAge: 10000, timeout: 10000 }
                );
            }, 30000); // Alle 30 Sekunden prÃ¼fen
            
            console.log('âœ… GPS 30s Intervall gestartet');
        }
        
        // ğŸ†• Separate Funktion fÃ¼r GPS-Position-Handling
        function handleGPSPosition(pos, rideId) {
            const location = { 
                lat: pos.coords.latitude, 
                lon: pos.coords.longitude, 
                timestamp: Date.now(), 
                vehicleId: currentVehicle,
                vehicle: VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle,
                online: isOnline,
                accuracy: pos.coords.accuracy,
                userEmail: currentUser ? (currentUser.email || currentUser.phoneNumber || '') : '',
                userId: currentUser ? currentUser.uid : ''
            };
            
            // ğŸ¯ Update lastGPSUpdate fÃ¼r Monitoring
            lastGPSUpdate = Date.now();
            
            console.log('ğŸ“ GPS:', location.lat.toFixed(4), location.lon.toFixed(4), 'Genauigkeit:', Math.round(location.accuracy), 'm');
            
            // Update GPS-Indicator
            const gpsIndicator = document.getElementById('gps-indicator');
            const gpsDot = document.getElementById('gps-dot');
            const gpsStatus = document.getElementById('gps-status');
            if (gpsIndicator && gpsDot && gpsStatus) {
                gpsIndicator.style.display = 'flex';
                gpsDot.classList.add('online');
                gpsStatus.textContent = 'ğŸ“ GPS: ' + Math.round(location.accuracy) + 'm';
            }
            
            // ğŸ†• Update AUCH Compact-GPS-Status in der Toolbar!
            const statusDiv = document.getElementById('gps-status-compact');
            const iconSpan = document.getElementById('gps-icon-compact');
            const textSpan = document.getElementById('gps-text-compact');
            if (statusDiv && iconSpan && textSpan) {
                statusDiv.style.background = 'rgba(16,185,129,0.1)';
                statusDiv.style.color = '#10b981';
                iconSpan.textContent = 'ğŸ“';
                textSpan.textContent = Math.round(location.accuracy) + 'm';
            }
            
            if (!isFirebaseReady) {
                console.error('âŒ Firebase nicht bereit!');
                return;
            }
            
            // Immer in drivers/ speichern
            db.ref('drivers/' + currentVehicle).set(location).then(() => {
                console.log('âœ… GPS â†’ drivers/' + currentVehicle);
            }).catch(err => {
                console.error('âŒ Fehler beim GPS-Upload:', err);
            });
            
            // Wenn rideId vorhanden, auch in Fahrt speichern
            if (rideId) {
                db.ref('rides/' + rideId + '/driverLocation').set(location).then(() => {
                    console.log('âœ… GPS â†’ rides/' + rideId + '/driverLocation');
                }).catch(err => {
                    console.error('âŒ Fehler beim GPS-Upload zur Fahrt:', err);
                });
            }
        }

        function stopDriverTracking() {
            if (watchId) { 
                navigator.geolocation.clearWatch(watchId); 
                watchId = null; 
                console.log('ğŸ›‘ GPS gestoppt');
                
                // ğŸ“œ PROTOKOLL: GPS deaktiviert
                const vehicleName = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle;
                logActivity('gps', 'inactive', `GPS deaktiviert: ${vehicleName || 'Unbekannt'}`, {
                    vehicle: currentVehicle,
                    driver: vehicleName
                });
            }
            
            // Stoppe auch Fallback-Intervall
            if (window.gpsIntervalId) {
                clearInterval(window.gpsIntervalId);
                window.gpsIntervalId = null;
                console.log('ğŸ›‘ GPS Fallback-Intervall gestoppt');
            }
            
            // ğŸ†• Stoppe 30s Intervall
            if (window.gpsRegularInterval) {
                clearInterval(window.gpsRegularInterval);
                window.gpsRegularInterval = null;
                console.log('ğŸ›‘ GPS 30s Intervall gestoppt');
            }
            
            if (isFirebaseReady && currentVehicle) {
                db.ref('drivers/' + currentVehicle).remove();
                console.log('ğŸ—‘ï¸ GPS aus drivers/ entfernt');
            }
        }

        // ğŸ¯ ALIAS-FUNKTIONEN fÃ¼r bessere Lesbarkeit
        function startGPSTracking() {
            startDriverTracking();
        }
        
        function stopGPSTracking() {
            stopDriverTracking();
        }

        async function acceptRide(rideId) {
            if (!currentVehicle) {
                alert('âŒ Bitte Fahrzeug wÃ¤hlen!');
                return;
            }
            
            // âœ… SCHLIESSE FULLSCREEN wenn offen
            closeNewRideFullscreen();
            stopRepeatingVibration();
            
            // ğŸ”‹ Aktiviere Normal-Modus bei neuem Auftrag
            if (typeof PowerSaveManager !== 'undefined') {
                PowerSaveManager.onNewRide();
            }
            
            const ride = rides.find(r => r.firebaseId === rideId);
            if (!ride) {
                alert('âŒ Fahrt nicht gefunden!');
                return;
            }
            
            // âœ… CHECK: Wurde Fahrt storniert?
            if (ride.status === 'storniert' || ride.cancelledBy || ride.cancelledAt) {
                alert('ğŸš¨ STORNIERT!\n\n' +
                      'Diese Fahrt wurde bereits storniert.\n\n' +
                      (ride.cancellationReason ? `Grund: ${ride.cancellationReason}\n\n` : '') +
                      'Du kannst diese Fahrt nicht mehr annehmen.');
                closeNewRideFullscreen();
                return;
            }
            
            // Zeitwarnung
            if (ride.pickupTimestamp && ride.pickupTimestamp > Date.now()) {
                const minutesUntilPickup = Math.round((ride.pickupTimestamp - Date.now()) / 60000);
                const pickupTimeStr = ride.pickupTime || 'spÃ¤ter';
                
                const confirm = window.confirm(
                    `âš ï¸ ACHTUNG!\n\n` +
                    `Abholung erst um ${pickupTimeStr}\n` +
                    `Das ist in ${minutesUntilPickup} Minuten!\n\n` +
                    `Trotzdem jetzt annehmen und losfahren?`
                );
                
                if (!confirm) return;
            }
            
            // Auto-Online wenn offline
            if (!isOnline) {
                document.getElementById('online-toggle').checked = true;
                toggleOnline();
            }
            
            // ğŸ†• v5.19.0: Wechsle zu AKTIV-MODUS (prÃ¤zises GPS fÃ¼r Kunde!)
            if (gpsMode !== 'active') {
                console.log('ğŸ¯ Fahrt angenommen â†’ Wechsle zu Aktiv-GPS');
                startActiveTracking(rideId);
            }
            
            const vehicleName = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle;
            const vehiclePlate = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].plate : '';
            
            console.log('ğŸ“ Akzeptiere Fahrt:', rideId);
            
            // ğŸš¨ Admin-Alarm: Fahrt wurde zugewiesen
            if (typeof acknowledgedRides !== 'undefined') {
                acknowledgedRides.add(ride.id);
            }
            
            // ğŸ›‘ KRITISCH: Stoppe Assignment-Timer um Timeout zu verhindern!
            if (assignmentTimers[rideId]) {
                clearTimeout(assignmentTimers[rideId]);
                delete assignmentTimers[rideId];
                console.log('â° âœ… Assignment-Timer erfolgreich gestoppt fÃ¼r rideId:', rideId);
            } else {
                console.log('â° â„¹ï¸ Kein Assignment-Timer gefunden fÃ¼r rideId:', rideId, '(evtl. manuell zugewiesen)');
            }
            
            // Update Fahrt in Firebase
            await updateRide(rideId, { 
                status: 'accepted', 
                vehicleId: currentVehicle,
                vehicle: vehicleName,
                vehiclePlate: vehiclePlate,
                driver: vehicleName,
                acceptedAt: Date.now(),
                assignedTo: null, // ZurÃ¼cksetzen
                assignmentExpiresAt: null
            });
            
            // ğŸ“œ PROTOKOLL: Fahrt angenommen
            logActivity('status', 'accepted', `Fahrt angenommen von ${vehicleName}`, {
                customer: ride.customerName,
                driver: vehicleName,
                vehicle: currentVehicle,
                from: ride.pickup,
                to: ride.destination,
                price: ride.price
            });
            
            // GPS komplett neu starten mit rideId
            if (watchId) {
                console.log('ğŸ›‘ Stoppe altes GPS');
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            setTimeout(() => {
                startDriverTracking(rideId);
                initDriverMap(rideId);  // Ãœbergebe rideId - wird aus Firebase geladen
            }, 100);
            
            alert('âœ… Auftrag angenommen! GPS lÃ¤uft...');
        }

        async function pickupCustomer(rideId) {
            await updateRide(rideId, { 
                status: 'picked_up',
                pickedUpAt: Date.now() 
            });
            
            // Lade ride NEU aus Firebase und update Display
            const snapshot = await db.ref('rides/' + rideId).once('value');
            const ride = snapshot.val();
            if (ride) {
                ride.firebaseId = rideId;
                updateDriverInfoTop(ride);
                
                // ğŸ“œ PROTOKOLL: Kunde eingestiegen
                const vehicleName = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle;
                logActivity('status', 'picked_up', `Kunde eingestiegen`, {
                    customer: ride.customerName,
                    driver: vehicleName,
                    from: ride.pickup,
                    to: ride.destination,
                    price: ride.price
                });
            }
            
            alert('âœ… Kunde eingestiegen! Navigation zum Ziel lÃ¤uft.');
        }

        async function completeRide(rideId) {
            // Hole Fahrt-Daten vor dem Abschluss
            const rideSnapshot = await db.ref('rides/' + rideId).once('value');
            const rideData = rideSnapshot.val();
            
            await updateRide(rideId, { 
                status: 'completed', 
                driverLocation: null,
                completedAt: Date.now()
            });
            
            // ğŸ†• v5.26.14f: REALTIME FIX - Speichere abgeschlossene Fahrt in localStorage!
            if (rideData) {
                console.log('ğŸ’¾ Speichere Fahrt in Verlauf...');
                const rideHistory = JSON.parse(localStorage.getItem('rideHistory') || '[]');
                
                // PrÃ¼fe ob schon vorhanden (dedupliziere)
                const existingIndex = rideHistory.findIndex(r => r.id === rideData.id || r.firebaseId === rideId);
                if (existingIndex >= 0) {
                    // Aktualisiere bestehende Fahrt
                    rideHistory[existingIndex] = {
                        ...rideData,
                        firebaseId: rideId,
                        status: 'completed',
                        completedAt: Date.now()
                    };
                    console.log('âœ… Fahrt aktualisiert in Verlauf');
                } else {
                    // FÃ¼ge neue Fahrt hinzu
                    rideHistory.push({
                        ...rideData,
                        firebaseId: rideId,
                        status: 'completed',
                        completedAt: Date.now()
                    });
                    console.log('âœ… Fahrt hinzugefÃ¼gt zu Verlauf');
                }
                
                localStorage.setItem('rideHistory', JSON.stringify(rideHistory));
                
                // ğŸ”„ Update History-View sofort!
                if (currentView === 'history') {
                    updateHistoryView();
                }
            }
            
            // ğŸ“œ PROTOKOLL: Fahrt abgeschlossen
            logActivity('status', 'completed', `Fahrt abgeschlossen`, {
                customer: rideData?.customerName,
                driver: rideData?.vehicle || currentVehicle,
                from: rideData?.pickup,
                to: rideData?.destination,
                price: rideData?.price
            });
            
            // SchlieÃŸe Karte
            closeDriverMap();
            
            if (etaUpdateInterval) { 
                clearInterval(etaUpdateInterval); 
                etaUpdateInterval = null; 
            }
            
            console.log('âœ… Fahrt abgeschlossen');
            
            // WICHTIG: Erst komplett stoppen
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                console.log('ğŸ›‘ GPS gestoppt');
            }
            
            // ğŸ†• v5.19.0: ZurÃ¼ck zu Standby-Modus!
            if (isOnline && currentVehicle) {
                console.log('ğŸ”„ Wechsle zurÃ¼ck zu Standby-Modus');
                setTimeout(() => {
                    switchToStandby();
                }, 100);
            }
            
            alert('âœ… Fahrt abgeschlossen! Sie sind wieder verfÃ¼gbar.');
        }

        async function resetDatabase() {
            if (!confirm('âš ï¸ WIRKLICH alle Fahrten lÃ¶schen?\n\nLÃ¶scht ALLES:\n- Alle Firebase Fahrten\n- localStorage Verlauf\n- Komplett leere Datenbank')) return;
            if (!confirm('âš ï¸ LETZTE WARNUNG!\n\nDies kann nicht rÃ¼ckgÃ¤ngig gemacht werden!')) return;
            
            if (isFirebaseReady) {
                try {
                    console.log('ğŸ—‘ï¸ LÃ¶sche ALLE Fahrten...');
                    
                    // 1. Firebase komplett leeren
                    await db.ref('rides').remove();
                    console.log('âœ… Firebase rides/ gelÃ¶scht');
                    
                    // 2. Lokales Array leeren
                    rides = [];
                    
                    // 3. localStorage leeren
                    localStorage.removeItem('rideHistory');
                    localStorage.removeItem('myCurrentRideId');
                    console.log('âœ… localStorage geleert');
                    
                    // 4. Current Ride zurÃ¼cksetzen
                    myCurrentRide = null;
                    
                    alert(
                        'âœ… Datenbank komplett gelÃ¶scht!\n\n' +
                        'ğŸ”¥ Alle Fahrten entfernt\n' +
                        'ğŸ”¥ localStorage geleert\n' +
                        'ğŸ”¥ Komplett sauber!\n\n' +
                        'Seite lÃ¤dt neu...'
                    );
                    
                    // Auto-Reload nach 1 Sekunde
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                    
                } catch (error) {
                    console.error('âŒ Fehler beim LÃ¶schen:', error);
                    alert('âŒ Fehler beim LÃ¶schen: ' + error.message);
                }
            } else {
                alert('âŒ Firebase nicht bereit!');
            }
        }
        
        // ğŸ“‚ ADMIN SECTION TOGGLE
        function toggleAdminSection(section) {
            const content = document.getElementById(section + '-content');
            const toggle = document.getElementById(section + '-toggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = 'â–²';
                
                // Spezielle Aktionen beim Ã–ffnen
                if (section === 'telegram') {
                    updateTelegramStatus();
                } else if (section === 'prebookings') {
                    updatePrebookingsList();
                } else if (section === 'activitylog') {
                    loadActivityLog();
                } else if (section === 'deleted') {
                    loadDeletedRides();
                } else if (section === 'fleetmap') {
                    setTimeout(() => initFleetMap(), 100); // Kleine VerzÃ¶gerung fÃ¼r DOM
                } else if (section === 'vehicles') {
                    renderVehicles();
                } else if (section === 'activerides') {
                    loadActiveRides();
                } else if (section === 'booking-system') {
                    // ğŸ†• v5.38.2: Buchungssystem-UI updaten
                    updateBookingSystemUI();
                } else if (section === 'oepnv') {
                    loadOEPNVSettings();
                } else if (section === 'calendar') {
                    // ğŸ†• v5.27.1: Kalender rendern
                    setTimeout(() => renderCalendar(), 100);
                } else if (section === 'antifraud') {
                    // ğŸ†• v5.28.0: Anti-Betrugs-Alarme laden
                    loadAntiFraudAlerts();
                }
            } else {
                content.style.display = 'none';
                toggle.textContent = 'â–¼';
                
                // Stoppe Live-Log wenn geschlossen
                if (section === 'livelog' && liveLogActive) {
                    stopLiveLog();
                }
                
                // Stoppe Fleet-Auto-Update wenn geschlossen
                if (section === 'fleetmap' && fleetAutoRefresh) {
                    clearInterval(fleetAutoRefresh);
                    fleetAutoRefresh = null;
                    const btn = document.getElementById('fleet-auto-btn');
                    if (btn) {
                        btn.textContent = 'â–¶ï¸ Auto-Update';
                        btn.style.background = '#10b981';
                    }
                }
            }
        }
        
        // ğŸ—ºï¸ FAHRZEUG-KARTE SYSTEM
        let fleetMap = null;
        let fleetMarkers = {};
        let fleetRoutes = {};
        
        // ğŸš¨ AKTIVE FAHRTEN SYSTEM
        async function loadActiveRides() {
            const container = document.getElementById('active-rides-list');
            const countBadge = document.getElementById('active-rides-count');
            
            if (!db) {
                container.innerHTML = '<div style="padding:20px;text-align:center;color:#ef4444;">âŒ Firebase nicht verbunden</div>';
                return;
            }
            
            container.innerHTML = '<div style="padding:20px;text-align:center;color:#999;">â³ Lade...</div>';
            
            try {
                const snapshot = await db.ref('rides').once('value');
                const allRides = snapshot.val() || {};
                
                // Aktive Status definieren
                const activeStatuses = ['new', 'assigned', 'accepted', 'picked_up', 'vorbestellt'];
                const finishedStatuses = ['completed', 'cancelled', 'storniert', 'abgeschlossen'];
                
                // Fahrten sortieren
                const activeRides = [];
                const recentFinished = [];
                const now = Date.now();
                const oneHourAgo = now - (60 * 60 * 1000);
                
                for (const rideId in allRides) {
                    const ride = allRides[rideId];
                    ride.firebaseId = rideId;
                    
                    if (activeStatuses.includes(ride.status)) {
                        activeRides.push(ride);
                    } else if (finishedStatuses.includes(ride.status) && (ride.completedAt || ride.cancelledAt || ride.createdAt) > oneHourAgo) {
                        recentFinished.push(ride);
                    }
                }
                
                // Sortieren nach Zeit
                activeRides.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                recentFinished.sort((a, b) => (b.completedAt || b.cancelledAt || b.createdAt || 0) - (a.completedAt || a.cancelledAt || a.createdAt || 0));
                
                countBadge.textContent = activeRides.length;
                
                let html = '';
                
                // AKTIVE FAHRTEN
                if (activeRides.length > 0) {
                    html += '<div style="background:#fef3c7;padding:10px;font-weight:bold;border-bottom:1px solid #e5e7eb;">ğŸš¨ AKTIVE FAHRTEN (' + activeRides.length + ')</div>';
                    activeRides.forEach(ride => {
                        html += renderActiveRideRow(ride, true);
                    });
                } else {
                    html += '<div style="background:#d1fae5;padding:15px;text-align:center;color:#059669;">âœ… Keine aktiven Fahrten - alles abgearbeitet!</div>';
                }
                
                // KÃœRZLICH ABGESCHLOSSEN (letzte Stunde)
                if (recentFinished.length > 0) {
                    html += '<div style="background:#e0e7ff;padding:10px;font-weight:bold;border-bottom:1px solid #e5e7eb;margin-top:10px;">ğŸ“‹ KÃœRZLICH ABGESCHLOSSEN (' + recentFinished.length + ')</div>';
                    recentFinished.forEach(ride => {
                        html += renderActiveRideRow(ride, false);
                    });
                }
                
                container.innerHTML = html || '<div style="padding:20px;text-align:center;color:#999;">Keine Fahrten gefunden</div>';
                
            } catch (error) {
                console.error('âŒ Fehler beim Laden aktiver Fahrten:', error);
                container.innerHTML = '<div style="padding:20px;text-align:center;color:#ef4444;">âŒ Fehler: ' + error.message + '</div>';
            }
        }
        
        function renderActiveRideRow(ride, isActive) {
            const createdTime = ride.createdAt ? formatDateTime(ride.createdAt) : 'Unbekannt';
            const pickupTime = ride.pickupTimestamp ? formatDateTime(ride.pickupTimestamp) : createdTime;
            
            // Status-Farbe und Text
            let statusColor, statusText, statusEmoji;
            switch(ride.status) {
                case 'new':
                    statusColor = '#3b82f6'; statusText = 'Neu'; statusEmoji = 'ğŸ†•';
                    break;
                case 'assigned':
                    statusColor = '#f59e0b'; statusText = 'Zugewiesen'; statusEmoji = 'â³';
                    break;
                case 'accepted':
                    statusColor = '#10b981'; statusText = 'Angenommen'; statusEmoji = 'âœ…';
                    break;
                case 'picked_up':
                    statusColor = '#8b5cf6'; statusText = 'Unterwegs'; statusEmoji = 'ğŸš—';
                    break;
                case 'vorbestellt':
                    statusColor = '#ec4899'; statusText = 'Vorbestellt'; statusEmoji = 'ğŸ“…';
                    break;
                case 'completed':
                    statusColor = '#059669'; statusText = 'Abgeschlossen'; statusEmoji = 'âœ”ï¸';
                    break;
                case 'cancelled':
                case 'storniert':
                    statusColor = '#dc2626'; statusText = 'Storniert'; statusEmoji = 'âŒ';
                    break;
                default:
                    statusColor = '#6b7280'; statusText = ride.status; statusEmoji = 'â“';
            }
            
            // Zeit seit Erstellung
            const ageMinutes = Math.round((Date.now() - (ride.createdAt || 0)) / 60000);
            const ageText = ageMinutes < 60 ? ageMinutes + ' Min' : Math.round(ageMinutes / 60) + ' Std';
            
            return `
                <div style="padding:12px;border-bottom:1px solid #e5e7eb;${isActive ? 'background:#fffbeb;' : ''}">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
                        <div>
                            <span style="background:${statusColor};color:white;padding:3px 8px;border-radius:4px;font-size:12px;font-weight:bold;">
                                ${statusEmoji} ${statusText}
                            </span>
                            <span style="margin-left:8px;font-size:11px;color:#6b7280;">vor ${ageText}</span>
                        </div>
                        ${isActive ? `
                            <button onclick="forceCompleteRide('${ride.firebaseId}')" style="background:#ef4444;color:white;border:none;padding:5px 10px;border-radius:4px;font-size:11px;cursor:pointer;">
                                ğŸ—‘ï¸ LÃ¶schen
                            </button>
                        ` : ''}
                    </div>
                    <div style="font-size:13px;">
                        <div><strong>ğŸ‘¤ ${ride.customerName || 'Unbekannt'}</strong> ${ride.customerPhone ? 'ğŸ“ ' + ride.customerPhone : ''}</div>
                        <div style="color:#6b7280;margin-top:4px;">
                            ğŸ“ ${ride.pickup || '?'} â†’ ${ride.destination || '?'}
                        </div>
                        <div style="color:#6b7280;margin-top:4px;font-size:11px;">
                            ğŸ• Erstellt: ${createdTime}
                            ${ride.assignedTo ? ' | ğŸš— ' + (ride.assignedVehicleName || ride.assignedTo) : ''}
                            ${ride.price ? ' | ğŸ’° ' + ride.price + 'â‚¬' : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function formatDateTime(timestamp) {
            if (!timestamp) return 'Unbekannt';
            const date = new Date(timestamp);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}.${month}. ${hours}:${minutes}`;
        }
        
        async function forceCompleteRide(rideId) {
            if (!confirm('Fahrt wirklich lÃ¶schen/stornieren?')) return;
            
            try {
                await db.ref('rides/' + rideId).update({
                    status: 'cancelled',
                    cancelledAt: Date.now(),
                    cancelReason: 'Admin: Manuell gelÃ¶scht',
                    forceClosed: true
                });
                
                console.log('âœ… Fahrt ' + rideId + ' gelÃ¶scht');
                loadActiveRides(); // Neu laden
                
                logActivity('admin', 'force_cancel', 'Admin hat Fahrt manuell gelÃ¶scht', {
                    rideId: rideId
                });
            } catch (error) {
                console.error('âŒ Fehler:', error);
                alert('Fehler beim LÃ¶schen: ' + error.message);
            }
        }
        
        async function cleanupAllStuckRides() {
            if (!confirm('Alle hÃ¤ngenden "assigned" Fahrten zurÃ¼cksetzen?')) return;
            
            try {
                const snapshot = await db.ref('rides').orderByChild('status').equalTo('assigned').once('value');
                const stuckRides = snapshot.val();
                
                if (!stuckRides) {
                    alert('Keine hÃ¤ngenden Fahrten gefunden!');
                    return;
                }
                
                let count = 0;
                for (const rideId in stuckRides) {
                    await db.ref('rides/' + rideId).update({
                        status: 'new',
                        assignedTo: null,
                        assignedVehicleName: null,
                        cleanedUp: true,
                        cleanedUpAt: Date.now()
                    });
                    count++;
                }
                
                alert(`âœ… ${count} Fahrt(en) zurÃ¼ckgesetzt!`);
                loadActiveRides();
                
                logActivity('admin', 'bulk_cleanup', `Admin hat ${count} hÃ¤ngende Fahrten zurÃ¼ckgesetzt`, {});
            } catch (error) {
                console.error('âŒ Fehler:', error);
                alert('Fehler: ' + error.message);
            }
        }
        let fleetAutoRefresh = null;
        let fleetMapInitialized = false;
        
        function initFleetMap() {
            if (fleetMapInitialized) return;
            
            const mapContainer = document.getElementById('fleet-map');
            if (!mapContainer) return;
            
            // Karte initialisieren (Usedom-Zentrum)
            fleetMap = L.map('fleet-map').setView([53.95, 14.05], 11);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap'
            }).addTo(fleetMap);
            
            fleetMapInitialized = true;
            console.log('ğŸ—ºï¸ Fahrzeug-Karte initialisiert');
            
            // Erste Daten laden
            refreshFleetMap();
        }
        
        async function refreshFleetMap() {
            if (!isFirebaseReady) {
                console.log('âŒ Firebase nicht bereit');
                return;
            }
            
            if (!fleetMapInitialized) {
                initFleetMap();
                return;
            }
            
            try {
                // Lade alle Fahrer-Positionen
                const driversSnapshot = await db.ref('drivers').once('value');
                const driversData = driversSnapshot.val() || {};
                
                // Lade alle aktiven Fahrten
                const ridesSnapshot = await db.ref('rides').once('value');
                const ridesData = ridesSnapshot.val() || {};
                
                // Finde aktive Fahrten pro Fahrzeug
                const vehicleRides = {};
                for (const rideId in ridesData) {
                    const ride = ridesData[rideId];
                    if (ride.vehicleId && ['accepted', 'picked_up', 'assigned'].includes(ride.status)) {
                        vehicleRides[ride.vehicleId] = {
                            ...ride,
                            firebaseId: rideId
                        };
                    }
                }
                
                // Alte Marker und Routen entfernen
                for (const id in fleetMarkers) {
                    fleetMap.removeLayer(fleetMarkers[id]);
                }
                for (const id in fleetRoutes) {
                    fleetMap.removeLayer(fleetRoutes[id]);
                }
                fleetMarkers = {};
                fleetRoutes = {};
                
                let onlineCount = 0;
                let busyCount = 0;
                let vehicleListHtml = '';
                
                // Marker fÃ¼r jedes Fahrzeug erstellen
                for (const vehicleId in driversData) {
                    const driver = driversData[vehicleId];
                    // PrÃ¼fe ob Fahrer WIRKLICH online ist (nicht nur Position vorhanden)
                    if (!driver || !driver.lat || !driver.lon || driver.online === false) continue;
                    
                    onlineCount++;
                    
                    const vehicleName = driver.vehicle || VEHICLES[vehicleId]?.name || vehicleId;
                    const activeRide = vehicleRides[vehicleId];
                    
                    // Status bestimmen
                    let status = 'frei';
                    let color = '#22c55e'; // GrÃ¼n
                    let statusText = 'ğŸŸ¢ Frei';
                    
                    if (activeRide) {
                        busyCount++;
                        if (activeRide.status === 'assigned') {
                            status = 'zugewiesen';
                            color = '#f59e0b'; // Orange
                            statusText = 'ğŸŸ  Zugewiesen';
                        } else {
                            status = 'besetzt';
                            color = '#ef4444'; // Rot
                            statusText = 'ğŸ”´ Besetzt';
                        }
                    }
                    
                    // Custom Icon erstellen
                    const icon = L.divIcon({
                        className: 'fleet-marker',
                        html: `
                            <div style="
                                background: ${color};
                                width: 36px;
                                height: 36px;
                                border-radius: 50%;
                                border: 3px solid white;
                                box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 18px;
                            ">ğŸš•</div>
                        `,
                        iconSize: [36, 36],
                        iconAnchor: [18, 18]
                    });
                    
                    // Popup-Inhalt
                    let popupContent = `
                        <div style="min-width:200px;">
                            <div style="font-weight:bold;font-size:14px;margin-bottom:5px;">
                                ğŸš— ${vehicleName}
                            </div>
                            <div style="color:${color};font-weight:600;margin-bottom:8px;">
                                ${statusText}
                            </div>
                    `;
                    
                    if (activeRide) {
                        popupContent += `
                            <div style="background:#f3f4f6;padding:8px;border-radius:6px;font-size:12px;">
                                <div><strong>ğŸ‘¤ ${activeRide.customerName || 'Kunde'}</strong></div>
                                <div>ğŸ“ ${activeRide.pickup || '?'}</div>
                                <div>â¡ï¸ ${activeRide.destination || '?'}</div>
                                <div>ğŸ’° ${activeRide.price || '?'}â‚¬</div>
                            </div>
                        `;
                        
                        // Route zum Ziel einzeichnen (wenn picked_up)
                        if (activeRide.status === 'picked_up' && activeRide.destCoords) {
                            drawRouteToDestination(vehicleId, driver, activeRide, color);
                        } else if (activeRide.pickupCoords) {
                            // Route zum Abholort
                            drawRouteToPickup(vehicleId, driver, activeRide, color);
                        }
                    }
                    
                    popupContent += `
                        <div style="font-size:10px;color:#888;margin-top:5px;">
                            ğŸ“ ${driver.lat.toFixed(4)}, ${driver.lon.toFixed(4)}
                        </div>
                    </div>`;
                    
                    // Marker erstellen
                    const marker = L.marker([driver.lat, driver.lon], { icon })
                        .bindPopup(popupContent)
                        .addTo(fleetMap);
                    
                    fleetMarkers[vehicleId] = marker;
                    
                    // Fahrzeug-Liste erstellen
                    const lastUpdate = driver.timestamp ? new Date(driver.timestamp).toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit', second:'2-digit'}) : '?';
                    
                    // ğŸ†• v5.20.5: GPS-Alter berechnen und farbig anzeigen
                    let gpsAgeMinutes = 0;
                    let gpsAgeColor = '#10b981'; // GrÃ¼n = frisch
                    let gpsAgeIcon = 'ğŸŸ¢';
                    let isStale = false;
                    
                    if (driver.timestamp) {
                        gpsAgeMinutes = Math.floor((Date.now() - driver.timestamp) / 60000);
                        
                        if (gpsAgeMinutes < 6) {
                            gpsAgeColor = '#10b981'; // GrÃ¼n
                            gpsAgeIcon = 'ğŸŸ¢';
                        } else if (gpsAgeMinutes < 11) {
                            gpsAgeColor = '#f59e0b'; // Gelb/Orange
                            gpsAgeIcon = 'ğŸŸ¡';
                        } else {
                            gpsAgeColor = '#ef4444'; // Rot
                            gpsAgeIcon = 'ğŸ”´';
                            isStale = true;
                        }
                    }
                    
                    // ğŸ†• Status-Farbe und Text anpassen wenn GPS veraltet
                    let displayStatus = status;
                    let displayColor = color;
                    if (isStale && status === 'frei') {
                        displayStatus = 'stale';
                        displayColor = '#9ca3af'; // Grau
                    }
                    
                    vehicleListHtml += `
                        <div onclick="focusVehicle('${vehicleId}')" style="
                            display:flex;
                            justify-content:space-between;
                            align-items:center;
                            padding:10px;
                            background:white;
                            border:1px solid #e0e0e0;
                            border-left:4px solid ${displayColor};
                            border-radius:6px;
                            margin-bottom:6px;
                            cursor:pointer;
                        ">
                            <div>
                                <div style="font-weight:600;">ğŸš— ${vehicleName}</div>
                                ${activeRide ? `
                                    <div style="font-size:12px;color:#666;">
                                        ğŸ‘¤ ${activeRide.customerName || 'Kunde'} Â· 
                                        ${activeRide.destination || '?'}
                                    </div>
                                ` : `
                                    <div style="font-size:11px;color:${gpsAgeColor};">
                                        ${gpsAgeIcon} GPS: ${lastUpdate}
                                        ${gpsAgeMinutes > 0 ? `<span style="color:#888;font-size:10px;">(${gpsAgeMinutes} Min)</span>` : ''}
                                    </div>
                                `}
                            </div>
                            <div style="
                                background:${displayColor};
                                color:white;
                                padding:4px 10px;
                                border-radius:15px;
                                font-size:11px;
                                font-weight:600;
                            ">${displayStatus === 'frei' ? 'FREI' : displayStatus === 'zugewiesen' ? 'ZUGEWIESEN' : displayStatus === 'stale' ? 'GPS ALT!' : 'BESETZT'}</div>
                        </div>
                    `;
                }
                
                // Offline-Fahrzeuge aus VEHICLES hinzufÃ¼gen
                for (const vehicleId in VEHICLES) {
                    // Zeige als OFFLINE wenn: nicht in driversData ODER online === false
                    const driver = driversData[vehicleId];
                    const isOffline = !driver || !driver.lat || !driver.lon || driver.online === false;
                    
                    if (isOffline) {
                        // Letzter bekannter Zeitstempel
                        let lastSeenText = '';
                        if (driver) {
                            const lastTime = driver.lastOffline || driver.timestamp;
                            if (lastTime) {
                                const lastDate = new Date(lastTime);
                                const now = new Date();
                                const diffMs = now - lastDate;
                                const diffMins = Math.floor(diffMs / 60000);
                                const diffHours = Math.floor(diffMs / 3600000);
                                const diffDays = Math.floor(diffMs / 86400000);
                                
                                if (diffMins < 60) {
                                    lastSeenText = `vor ${diffMins} Min`;
                                } else if (diffHours < 24) {
                                    lastSeenText = `vor ${diffHours} Std`;
                                } else {
                                    lastSeenText = `vor ${diffDays} Tag${diffDays > 1 ? 'en' : ''}`;
                                }
                            }
                        }
                        
                        vehicleListHtml += `
                            <div style="
                                display:flex;
                                justify-content:space-between;
                                align-items:center;
                                padding:10px;
                                background:#f9fafb;
                                border:1px solid #e0e0e0;
                                border-left:4px solid #6b7280;
                                border-radius:6px;
                                margin-bottom:6px;
                                opacity:0.6;
                            ">
                                <div>
                                    <div style="font-weight:600;">ğŸš— ${VEHICLES[vehicleId].name}</div>
                                    <div style="font-size:11px;color:#888;">${VEHICLES[vehicleId].plate}${lastSeenText ? ` Â· ğŸ• ${lastSeenText}` : ''}</div>
                                </div>
                                <div style="
                                    background:#6b7280;
                                    color:white;
                                    padding:4px 10px;
                                    border-radius:15px;
                                    font-size:11px;
                                    font-weight:600;
                                ">OFFLINE</div>
                            </div>
                        `;
                    }
                }
                
                // Update UI
                document.getElementById('fleet-vehicle-list').innerHTML = vehicleListHtml || 
                    '<div style="text-align:center;color:#888;padding:20px;">Keine Fahrzeuge online</div>';
                
                document.getElementById('fleet-status').textContent = 
                    `(${onlineCount} online, ${busyCount} besetzt)`;
                
                // Karte auf alle Marker zentrieren
                if (Object.keys(fleetMarkers).length > 0) {
                    const group = L.featureGroup(Object.values(fleetMarkers));
                    fleetMap.fitBounds(group.getBounds().pad(0.1));
                }
                
                console.log('ğŸ—ºï¸ Fahrzeug-Karte aktualisiert:', onlineCount, 'online,', busyCount, 'besetzt');
                
            } catch (error) {
                console.error('âŒ Fehler beim Laden der Fahrzeug-Daten:', error);
            }
        }
        
        async function drawRouteToDestination(vehicleId, driver, ride, color) {
            if (!ride.destCoords) return;
            
            try {
                const response = await fetch(
                    `https://router.project-osrm.org/route/v1/driving/` +
                    `${driver.lon},${driver.lat};${ride.destCoords.lon},${ride.destCoords.lat}` +
                    `?overview=full&geometries=geojson`
                );
                const data = await response.json();
                
                if (data.routes && data.routes[0]) {
                    const coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                    const route = L.polyline(coords, {
                        color: color,
                        weight: 4,
                        opacity: 0.7,
                        dashArray: '10, 10'
                    }).addTo(fleetMap);
                    
                    // Ziel-Marker
                    const destIcon = L.divIcon({
                        className: 'dest-marker',
                        html: `<div style="font-size:24px;">ğŸ“</div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 24]
                    });
                    
                    const destMarker = L.marker([ride.destCoords.lat, ride.destCoords.lon], { icon: destIcon })
                        .bindPopup(`<strong>Ziel:</strong><br>${ride.destination}`)
                        .addTo(fleetMap);
                    
                    fleetRoutes[vehicleId] = L.layerGroup([route, destMarker]);
                    fleetRoutes[vehicleId].addTo(fleetMap);
                }
            } catch (error) {
                console.error('Route Fehler:', error);
            }
        }
        
        async function drawRouteToPickup(vehicleId, driver, ride, color) {
            if (!ride.pickupCoords) return;
            
            try {
                const response = await fetch(
                    `https://router.project-osrm.org/route/v1/driving/` +
                    `${driver.lon},${driver.lat};${ride.pickupCoords.lon},${ride.pickupCoords.lat}` +
                    `?overview=full&geometries=geojson`
                );
                const data = await response.json();
                
                if (data.routes && data.routes[0]) {
                    const coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                    const route = L.polyline(coords, {
                        color: color,
                        weight: 4,
                        opacity: 0.7,
                        dashArray: '5, 10'
                    }).addTo(fleetMap);
                    
                    // Abholort-Marker
                    const pickupIcon = L.divIcon({
                        className: 'pickup-marker',
                        html: `<div style="font-size:24px;">ğŸ‘¤</div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 24]
                    });
                    
                    const pickupMarker = L.marker([ride.pickupCoords.lat, ride.pickupCoords.lon], { icon: pickupIcon })
                        .bindPopup(`<strong>Abholort:</strong><br>${ride.pickup}<br><strong>Kunde:</strong> ${ride.customerName}`)
                        .addTo(fleetMap);
                    
                    fleetRoutes[vehicleId] = L.layerGroup([route, pickupMarker]);
                    fleetRoutes[vehicleId].addTo(fleetMap);
                }
            } catch (error) {
                console.error('Route Fehler:', error);
            }
        }
        
        function focusVehicle(vehicleId) {
            const marker = fleetMarkers[vehicleId];
            if (marker && fleetMap) {
                fleetMap.setView(marker.getLatLng(), 14);
                marker.openPopup();
            }
        }
        
        function toggleFleetAutoRefresh() {
            const btn = document.getElementById('fleet-auto-btn');
            
            if (fleetAutoRefresh) {
                // Stoppen
                clearInterval(fleetAutoRefresh);
                fleetAutoRefresh = null;
                if (btn) {
                    btn.textContent = 'â–¶ï¸ Auto-Update';
                    btn.style.background = '#10b981';
                }
                console.log('â¹ï¸ Auto-Update gestoppt');
            } else {
                // Starten (alle 10 Sekunden)
                fleetAutoRefresh = setInterval(refreshFleetMap, 10000);
                if (btn) {
                    btn.textContent = 'â¹ï¸ Auto-Update';
                    btn.style.background = '#ef4444';
                }
                console.log('â–¶ï¸ Auto-Update gestartet (10s)');
                refreshFleetMap(); // Sofort aktualisieren
            }
        }
        
        // ğŸ”´ LIVE-LOG SYSTEM
        let liveLogActive = false;
        let liveLogListener = null;
        let liveLogFilters = {
            booking: true,
            driver: true,
            assignment: true,
            status: true,
            gps: false,
            system: true
        };
        let liveLogEntries = [];
        
        function toggleLiveLog() {
            if (liveLogActive) {
                stopLiveLog();
            } else {
                startLiveLog();
            }
        }
        
        async function startLiveLog() {
            if (!isFirebaseReady) {
                addLiveLogEntry('error', 'âŒ Firebase nicht verbunden!');
                return;
            }
            
            liveLogActive = true;
            
            // Update UI
            const btn = document.getElementById('live-log-toggle-btn');
            const status = document.getElementById('live-log-status');
            if (btn) {
                btn.textContent = 'â¹ï¸ Stoppen';
                btn.style.background = '#dc2626';
            }
            if (status) {
                status.textContent = '(ğŸ”´ LIVE)';
                status.style.color = '#ff6b6b';
            }
            
            addLiveLogEntry('system', 'ğŸŸ¢ Live-Log gestartet...');
            
            // ğŸ“œ ZUERST: Letzte Logs laden (letzte 2 STUNDEN oder max 100)
            // ğŸ†• v5.21.2: Von 30 Min auf 120 Min erweitert!
            const twoHoursAgo = Date.now() - (120 * 60 * 1000);
            try {
                const recentSnapshot = await db.ref('activityLog')
                    .orderByChild('timestamp')
                    .startAt(twoHoursAgo)
                    .limitToLast(100)
                    .once('value');
                
                const recentLogs = [];
                recentSnapshot.forEach(child => {
                    recentLogs.push(child.val());
                });
                
                if (recentLogs.length > 0) {
                    addLiveLogEntry('system', `ğŸ“œ ${recentLogs.length} Ereignisse aus den letzten 2 Stunden geladen:`);
                    recentLogs.forEach(log => {
                        if (log && shouldShowLiveLog(log.type)) {
                            displayLiveLogEntry(log);
                        }
                    });
                    addLiveLogEntry('system', 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Live-Modus aktiv â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
                } else {
                    addLiveLogEntry('system', 'ğŸ“­ Keine Ereignisse in den letzten 2 Stunden');
                }
            } catch (error) {
                console.error('âŒ Fehler beim Laden der letzten Logs:', error);
            }
            
            // Firebase Listener fÃ¼r NEUE Log-EintrÃ¤ge
            const now = Date.now();
            liveLogListener = db.ref('activityLog')
                .orderByChild('timestamp')
                .startAt(now)
                .on('child_added', (snapshot) => {
                    const log = snapshot.val();
                    if (log && shouldShowLiveLog(log.type)) {
                        displayLiveLogEntry(log);
                    }
                });
            
            console.log('ğŸ”´ Live-Log gestartet');
        }
        
        function stopLiveLog() {
            liveLogActive = false;
            
            // Firebase Listener entfernen
            if (liveLogListener && isFirebaseReady) {
                db.ref('activityLog').off('child_added', liveLogListener);
                liveLogListener = null;
            }
            
            // Update UI
            const btn = document.getElementById('live-log-toggle-btn');
            const status = document.getElementById('live-log-status');
            if (btn) {
                btn.textContent = 'â–¶ï¸ Starten';
                btn.style.background = '#10b981';
            }
            if (status) {
                status.textContent = '(gestoppt)';
                status.style.color = 'rgba(255,255,255,0.8)';
            }
            
            addLiveLogEntry('system', 'â¹ï¸ Live-Log gestoppt');
            
            console.log('â¹ï¸ Live-Log gestoppt');
        }
        
        function shouldShowLiveLog(type) {
            return liveLogFilters[type] === true;
        }
        
        function updateLiveFilters() {
            liveLogFilters = {
                booking: document.getElementById('live-filter-booking')?.checked ?? true,
                driver: document.getElementById('live-filter-driver')?.checked ?? true,
                assignment: document.getElementById('live-filter-assignment')?.checked ?? true,
                status: document.getElementById('live-filter-status')?.checked ?? true,
                gps: document.getElementById('live-filter-gps')?.checked ?? false,
                system: document.getElementById('live-filter-system')?.checked ?? true
            };
            console.log('ğŸ“‹ Live-Filter aktualisiert:', liveLogFilters);
        }
        
        function displayLiveLogEntry(log) {
            const time = new Date(log.timestamp).toLocaleTimeString('de-DE', {
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
            
            // Farbe basierend auf Typ
            let color = '#00ff00';
            let icon = 'ğŸ“';
            
            switch(log.type) {
                case 'booking':
                    color = '#60a5fa'; // blau
                    icon = 'ğŸ“±';
                    break;
                case 'driver':
                    color = log.action === 'online' ? '#34d399' : '#f87171'; // grÃ¼n/rot
                    icon = 'ğŸš—';
                    break;
                case 'assignment':
                    color = '#fbbf24'; // gelb
                    icon = 'ğŸ¯';
                    break;
                case 'status':
                    if (log.action === 'completed') {
                        color = '#34d399'; // grÃ¼n
                        icon = 'âœ…';
                    } else if (log.action === 'cancelled') {
                        color = '#f87171'; // rot
                        icon = 'âŒ';
                    } else if (log.action === 'deleted') {
                        color = '#dc2626'; // dunkelrot
                        icon = 'ğŸ—‘ï¸';
                    } else {
                        color = '#a78bfa'; // lila
                        icon = 'ğŸ“Š';
                    }
                    break;
                case 'gps':
                    color = log.action === 'active' ? '#34d399' : '#f87171';
                    icon = log.action === 'active' ? 'ğŸ“' : 'âŒ';
                    break;
                case 'system':
                    // Spezielle Farben fÃ¼r Login/Logout/Telegram
                    if (log.action === 'login') {
                        color = '#22c55e'; // grÃ¼n
                        icon = 'ğŸ”';
                    } else if (log.action === 'logout') {
                        color = '#f97316'; // orange
                        icon = 'ğŸšª';
                    } else if (log.action === 'telegram') {
                        color = '#0088cc'; // telegram-blau
                        icon = 'ğŸ“±';
                    } else if (log.action === 'connection_lost') {
                        color = '#ef4444'; // rot
                        icon = 'âš ï¸';
                    } else if (log.action === 'connection_restored') {
                        color = '#22c55e'; // grÃ¼n
                        icon = 'âœ…';
                    } else {
                        color = '#f472b6'; // pink
                        icon = 'âš™ï¸';
                    }
                    break;
            }
            
            // Device-Info falls vorhanden
            let deviceInfo = '';
            if (log.device) {
                deviceInfo = ` [${log.device.os}/${log.device.browser}]`;
            }
            
            // App-Version falls vorhanden
            let versionInfo = '';
            if (log.data && log.data.appVersion) {
                versionInfo = ` v${log.data.appVersion}`;
            }
            
            // ZusÃ¤tzliche Daten
            let extraInfo = '';
            if (log.data) {
                if (log.data.customer) extraInfo += ` ğŸ‘¤${log.data.customer}`;
                // E-Mail bei Fahrer-Logs anzeigen (falls nicht schon in message)
                if (log.data.email && log.type === 'driver' && !log.message.includes(log.data.email)) {
                    extraInfo += ` ğŸ“§${log.data.email}`;
                }
                if (log.data.driver) extraInfo += ` ğŸš—${log.data.driver}`;
                if (log.data.price) extraInfo += ` ğŸ’°${log.data.price}â‚¬`;
            }
            
            const entry = `[${time}] ${icon} ${log.message}${extraInfo}${deviceInfo}${versionInfo}`;
            addLiveLogEntry(log.type, entry, color);
        }
        
        function addLiveLogEntry(type, text, color = '#888') {
            const console = document.getElementById('live-log-console');
            if (!console) return;
            
            const entry = document.createElement('div');
            entry.style.color = color;
            entry.style.marginBottom = '4px';
            entry.style.borderLeft = `3px solid ${color}`;
            entry.style.paddingLeft = '8px';
            entry.textContent = text;
            
            console.appendChild(entry);
            
            // Speichere fÃ¼r Export
            liveLogEntries.push({ time: new Date().toISOString(), type, text });
            
            // Max 200 EintrÃ¤ge behalten
            while (console.children.length > 200) {
                console.removeChild(console.firstChild);
            }
            
            // Auto-Scroll nach unten
            console.scrollTop = console.scrollHeight;
        }
        
        function clearLiveLogConsole() {
            const console = document.getElementById('live-log-console');
            if (console) {
                console.innerHTML = '<div style="color:#888;">// Console geleert...</div>';
            }
            liveLogEntries = [];
        }
        
        function exportLiveLog() {
            const console = document.getElementById('live-log-console');
            if (!console) return;
            
            const text = console.innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert('âœ… Live-Log in Zwischenablage kopiert!');
            }).catch(() => {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('âœ… Live-Log kopiert!');
            });
        }
        
        // ğŸ“œ AKTIVITÃ„TS-PROTOKOLL SYSTEM
        
        /**
         * AktivitÃ¤t loggen
         * @param {string} type - Typ: booking, driver, assignment, status, gps, system
         * @param {string} action - Aktion: created, online, offline, assigned, accepted, etc.
         * @param {string} message - Beschreibung
         * @param {object} data - ZusÃ¤tzliche Daten
         */
        // ğŸ“Š DEVICE INFO SAMMELN
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            
            // Betriebssystem erkennen
            let os = 'Unbekannt';
            if (/Android/i.test(ua)) os = 'Android';
            else if (/iPhone|iPad|iPod/i.test(ua)) os = 'iOS';
            else if (/Windows/i.test(ua)) os = 'Windows';
            else if (/Mac/i.test(ua)) os = 'macOS';
            else if (/Linux/i.test(ua)) os = 'Linux';
            
            // Browser erkennen
            let browser = 'Unbekannt';
            if (/Chrome/i.test(ua) && !/Edge/i.test(ua)) browser = 'Chrome';
            else if (/Safari/i.test(ua) && !/Chrome/i.test(ua)) browser = 'Safari';
            else if (/Firefox/i.test(ua)) browser = 'Firefox';
            else if (/Edge/i.test(ua)) browser = 'Edge';
            else if (/Opera|OPR/i.test(ua)) browser = 'Opera';
            
            // Device-Typ
            let device = 'Desktop';
            if (/Mobile|Android|iPhone/i.test(ua)) device = 'Mobile';
            else if (/iPad|Tablet/i.test(ua)) device = 'Tablet';
            
            // Login-Status
            let loginStatus = 'Gast';
            if (currentUser) {
                if (userRole === 'admin') loginStatus = 'Admin';
                else if (userRole === 'driver') loginStatus = 'Fahrer';
                else loginStatus = 'Eingeloggt';
            }
            
            return {
                os: os,
                browser: browser,
                device: device,
                loginStatus: loginStatus,
                appVersion: APP_VERSION,
                screenWidth: window.innerWidth,
                screenHeight: window.innerHeight,
                online: navigator.onLine
            };
        }
        
        async function logActivity(type, action, message, data = {}) {
            if (!isFirebaseReady) {
                console.log('ğŸ“œ Log (offline):', type, action, message);
                return;
            }
            
            // ğŸ“Š Device-Infos hinzufÃ¼gen
            const deviceInfo = getDeviceInfo();
            
            const logEntry = {
                timestamp: Date.now(),
                type: type,
                action: action,
                message: message,
                data: data,
                date: new Date().toISOString().split('T')[0],
                // ğŸ“Š NEU: Device-Infos
                device: deviceInfo
            };
            
            try {
                await db.ref('activityLog').push(logEntry);
                console.log('ğŸ“œ Logged:', type, action, message);
            } catch (error) {
                console.error('âŒ Log Fehler:', error);
            }
        }
        
        // Protokoll laden
        async function loadActivityLog() {
            if (!isFirebaseReady) {
                document.getElementById('activity-log-list').innerHTML = 
                    '<p style="text-align:center;color:#999;">Firebase nicht verbunden</p>';
                return;
            }
            
            try {
                const snapshot = await db.ref('activityLog')
                    .orderByChild('timestamp')
                    .limitToLast(200)
                    .once('value');
                
                const logs = [];
                snapshot.forEach(child => {
                    const log = child.val();
                    log.id = child.key;
                    logs.push(log);
                });
                
                // Neueste zuerst
                logs.reverse();
                
                renderActivityLog(logs);
                updateLogStats(logs);
                
            } catch (error) {
                console.error('âŒ Log laden Fehler:', error);
            }
        }
        
        // ğŸ—‘ï¸ GELÃ–SCHTE FAHRTEN LADEN
        async function loadDeletedRides() {
            const container = document.getElementById('deleted-rides-list');
            const filterTime = document.getElementById('deleted-filter-time').value;
            
            if (!container) return;
            container.innerHTML = '<p style="text-align:center;color:#666;">â³ Lade gelÃ¶schte Fahrten...</p>';
            
            if (!isFirebaseReady) {
                container.innerHTML = '<p style="text-align:center;color:#ef4444;">âŒ Firebase nicht verbunden</p>';
                return;
            }
            
            try {
                // Lade aus activityLog wo action === 'deleted'
                const snapshot = await db.ref('activityLog')
                    .orderByChild('action')
                    .equalTo('deleted')
                    .once('value');
                
                if (!snapshot.exists()) {
                    container.innerHTML = '<p style="text-align:center;color:#999;">Keine gelÃ¶schten Fahrten gefunden</p>';
                    return;
                }
                
                let deletedRides = [];
                snapshot.forEach(child => {
                    deletedRides.push({
                        id: child.key,
                        ...child.val()
                    });
                });
                
                // Nach Zeit sortieren (neueste zuerst)
                deletedRides.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                
                // Zeit-Filter anwenden
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                const yesterday = today - 86400000;
                const weekAgo = today - 7 * 86400000;
                
                if (filterTime === 'today') {
                    deletedRides = deletedRides.filter(r => r.timestamp >= today);
                } else if (filterTime === 'yesterday') {
                    deletedRides = deletedRides.filter(r => r.timestamp >= yesterday && r.timestamp < today);
                } else if (filterTime === 'week') {
                    deletedRides = deletedRides.filter(r => r.timestamp >= weekAgo);
                }
                
                if (deletedRides.length === 0) {
                    container.innerHTML = '<p style="text-align:center;color:#999;">Keine gelÃ¶schten Fahrten im gewÃ¤hlten Zeitraum</p>';
                    return;
                }
                
                // Render
                let html = '';
                deletedRides.forEach(ride => {
                    const data = ride.data || {};
                    const time = new Date(ride.timestamp);
                    const timeStr = time.toLocaleString('de-DE', {
                        day: '2-digit', month: '2-digit', year: '2-digit',
                        hour: '2-digit', minute: '2-digit'
                    });
                    
                    html += `
                        <div style="background:#fee2e2;padding:12px;border-radius:8px;margin-bottom:10px;border-left:4px solid #ef4444;">
                            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
                                <strong style="color:#dc2626;">ğŸ—‘ï¸ GelÃ¶scht am ${timeStr}</strong>
                            </div>
                            <div style="font-size:13px;color:#333;">
                                <div style="margin-bottom:4px;">ğŸ‘¤ <strong>Kunde:</strong> ${data.customer || 'Unbekannt'}</div>
                                <div style="margin-bottom:4px;">ğŸ“ <strong>Telefon:</strong> ${data.phone || '-'}</div>
                                <div style="margin-bottom:4px;">ğŸ“ <strong>Von:</strong> ${data.pickup || data.from || '-'}</div>
                                <div style="margin-bottom:4px;">ğŸ“ <strong>Nach:</strong> ${data.destination || data.to || '-'}</div>
                                <div style="margin-bottom:4px;">ğŸ’° <strong>Preis:</strong> ${data.price ? data.price + 'â‚¬' : '-'}</div>
                                <div style="margin-bottom:4px;">ğŸš• <strong>Status war:</strong> ${data.status || '-'}</div>
                                ${data.vehicle ? `<div style="margin-bottom:4px;">ğŸš— <strong>Fahrzeug:</strong> ${data.vehicle}</div>` : ''}
                            </div>
                            <div style="margin-top:8px;padding-top:8px;border-top:1px dashed #fca5a5;font-size:11px;color:#991b1b;">
                                ğŸ—‘ï¸ <strong>GelÃ¶scht von:</strong> ${data.deletedBy || 'Unbekannt'}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = `<div style="font-size:12px;color:#666;margin-bottom:10px;">ğŸ“Š ${deletedRides.length} gelÃ¶schte Fahrt${deletedRides.length > 1 ? 'en' : ''} gefunden</div>` + html;
                
            } catch (error) {
                console.error('âŒ Fehler beim Laden gelÃ¶schter Fahrten:', error);
                container.innerHTML = '<p style="text-align:center;color:#ef4444;">âŒ Fehler beim Laden</p>';
            }
        }
        
        // Protokoll rendern
        function renderActivityLog(logs) {
            const container = document.getElementById('activity-log-list');
            const filterType = document.getElementById('log-filter-type').value;
            const filterTime = document.getElementById('log-filter-time').value;
            
            // Filtern
            let filtered = logs;
            
            // Nach Typ filtern
            if (filterType !== 'all') {
                if (filterType === 'deleted') {
                    // Spezialfall: GelÃ¶schte Fahrten (action === 'deleted')
                    filtered = filtered.filter(l => l.action === 'deleted');
                } else {
                    filtered = filtered.filter(l => l.type === filterType);
                }
            }
            
            // Nach Zeit filtern
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const yesterday = today - 86400000;
            const weekAgo = today - 7 * 86400000;
            
            if (filterTime === 'today') {
                filtered = filtered.filter(l => l.timestamp >= today);
            } else if (filterTime === 'yesterday') {
                filtered = filtered.filter(l => l.timestamp >= yesterday && l.timestamp < today);
            } else if (filterTime === 'week') {
                filtered = filtered.filter(l => l.timestamp >= weekAgo);
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#999;">Keine EintrÃ¤ge gefunden</p>';
                return;
            }
            
            let html = '';
            filtered.forEach(log => {
                const time = new Date(log.timestamp);
                const timeStr = time.toLocaleString('de-DE', {
                    day: '2-digit', month: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                });
                
                // Icon basierend auf Typ
                let icon = 'ğŸ“';
                let bgColor = '#f3f4f6';
                
                switch(log.type) {
                    case 'booking':
                        icon = 'ğŸ“±';
                        bgColor = '#dbeafe';
                        break;
                    case 'driver':
                        icon = 'ğŸš—';
                        bgColor = log.action === 'online' ? '#dcfce7' : '#fee2e2';
                        break;
                    case 'assignment':
                        icon = 'ğŸ¯';
                        bgColor = '#fef3c7';
                        break;
                    case 'status':
                        if (log.action === 'completed') {
                            icon = 'âœ…';
                            bgColor = '#dcfce7';
                        } else if (log.action === 'cancelled') {
                            icon = 'âŒ';
                            bgColor = '#fee2e2';
                        } else if (log.action === 'deleted') {
                            icon = 'ğŸ—‘ï¸';
                            bgColor = '#fecaca'; // dunkleres Rot fÃ¼r LÃ¶schung
                        } else {
                            icon = 'ğŸ“Š';
                            bgColor = '#e0e7ff';
                        }
                        break;
                    case 'gps':
                        icon = log.action === 'active' ? 'ğŸ“' : 'âŒ';
                        bgColor = log.action === 'active' ? '#dcfce7' : '#fee2e2';
                        break;
                    case 'system':
                        icon = 'âš™ï¸';
                        bgColor = '#f3e8ff';
                        break;
                }
                
                html += `
                    <div style="background:${bgColor};padding:10px;border-radius:6px;margin-bottom:8px;font-size:13px;">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                            <div>
                                <span style="font-size:16px;">${icon}</span>
                                <strong>${log.message}</strong>
                            </div>
                            <span style="font-size:11px;color:#666;white-space:nowrap;">${timeStr}</span>
                        </div>
                        ${log.data && Object.keys(log.data).length > 0 ? `
                            <div style="font-size:11px;color:#666;margin-top:5px;">
                                ${log.data.customer ? `ğŸ‘¤ ${log.data.customer}` : ''}
                                ${log.data.email ? `ğŸ“§ ${log.data.email}` : ''}
                                ${log.data.phone ? ` â€¢ ğŸ“ ${log.data.phone}` : ''}
                                ${log.data.driver ? ` â€¢ ğŸš— ${log.data.driver}` : ''}
                                ${log.data.vehicle ? ` â€¢ ${log.data.vehicle}` : ''}
                                ${log.data.price ? ` â€¢ ğŸ’° ${log.data.price}â‚¬` : ''}
                                ${log.data.from || log.data.pickup ? `<br>ğŸ“ ${log.data.from || log.data.pickup}` : ''}
                                ${log.data.to || log.data.destination ? ` â†’ ${log.data.to || log.data.destination}` : ''}
                                ${log.data.deletedBy ? `<br>ğŸ—‘ï¸ <strong>GelÃ¶scht von:</strong> ${log.data.deletedBy}` : ''}
                                ${log.data.reason ? `<br>â„¹ï¸ Grund: ${log.data.reason}` : ''}
                            </div>
                        ` : ''}
                        ${log.device ? `
                            <div style="font-size:10px;color:#999;margin-top:5px;padding-top:5px;border-top:1px dashed #ddd;">
                                ğŸ“± ${log.device.os} (${log.device.browser}) â€¢ 
                                ${log.device.device} â€¢ 
                                ğŸ” ${log.device.loginStatus} â€¢ 
                                ğŸ“¦ v${log.device.appVersion}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Statistiken aktualisieren
        function updateLogStats(logs) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayTimestamp = today.getTime();
            
            const todayLogs = logs.filter(l => l.timestamp >= todayTimestamp);
            
            const bookings = todayLogs.filter(l => l.type === 'booking' && l.action === 'created').length;
            const completed = todayLogs.filter(l => l.type === 'status' && l.action === 'completed').length;
            const deleted = todayLogs.filter(l => l.action === 'deleted').length;
            
            // Fahrer online zÃ¤hlen (aus drivers-Objekt)
            let onlineCount = 0;
            if (typeof drivers !== 'undefined') {
                for (const id in drivers) {
                    if (drivers[id] && drivers[id].online) onlineCount++;
                }
            }
            
            document.getElementById('log-stat-bookings').textContent = bookings;
            document.getElementById('log-stat-completed').textContent = completed;
            document.getElementById('log-stat-online').textContent = onlineCount;
            document.getElementById('log-stat-deleted').textContent = deleted;
        }
        
        // Filter anwenden
        function filterActivityLog() {
            loadActivityLog();
        }
        
        // Protokoll exportieren
        async function exportActivityLog() {
            if (!isFirebaseReady) return;
            
            try {
                const snapshot = await db.ref('activityLog')
                    .orderByChild('timestamp')
                    .once('value');
                
                const logs = [];
                snapshot.forEach(child => {
                    logs.push(child.val());
                });
                
                // Als CSV mit Device-Infos
                let csv = 'Datum;Uhrzeit;Typ;Aktion;Nachricht;Kunde;Fahrer;Preis;Betriebssystem;Browser;GerÃ¤t;Login-Status;App-Version\n';
                logs.forEach(log => {
                    const time = new Date(log.timestamp);
                    csv += `${time.toLocaleDateString('de-DE')};`;
                    csv += `${time.toLocaleTimeString('de-DE')};`;
                    csv += `${log.type};`;
                    csv += `${log.action};`;
                    csv += `"${log.message}";`;
                    csv += `${log.data?.customer || ''};`;
                    csv += `${log.data?.driver || ''};`;
                    csv += `${log.data?.price || ''};`;
                    // Device-Infos
                    csv += `${log.device?.os || ''};`;
                    csv += `${log.device?.browser || ''};`;
                    csv += `${log.device?.device || ''};`;
                    csv += `${log.device?.loginStatus || ''};`;
                    csv += `${log.device?.appVersion || ''}\n`;
                });
                
                // Download
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `aktivitaetsprotokoll_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                
                alert('âœ… Protokoll exportiert!');
                
            } catch (error) {
                console.error('âŒ Export Fehler:', error);
                alert('âŒ Export fehlgeschlagen');
            }
        }
        
        // Protokoll leeren
        async function clearActivityLog() {
            if (!confirm('ğŸ—‘ï¸ Gesamtes AktivitÃ¤ts-Protokoll wirklich lÃ¶schen?\n\nDiese Aktion kann nicht rÃ¼ckgÃ¤ngig gemacht werden!')) {
                return;
            }
            
            try {
                await db.ref('activityLog').remove();
                loadActivityLog();
                alert('âœ… Protokoll gelÃ¶scht!');
                
                // Selbst loggen
                logActivity('system', 'cleared', 'Protokoll wurde geleert');
                
            } catch (error) {
                console.error('âŒ LÃ¶schen Fehler:', error);
                alert('âŒ LÃ¶schen fehlgeschlagen');
            }
        }
        
        // ğŸš— FAHRZEUG-VERWALTUNG
        async function loadVehiclesFromFirebase() {
            if (!isFirebaseReady) return;
            
            try {
                const snapshot = await db.ref('vehicles').once('value');
                const data = snapshot.val();
                
                if (data && Object.keys(data).length > 0) {
                    VEHICLES = data;
                    console.log('ğŸš— Fahrzeuge aus Firebase geladen:', Object.keys(VEHICLES).length);
                } else {
                    // Initialisiere Firebase mit Default-Fahrzeugen
                    await db.ref('vehicles').set(DEFAULT_VEHICLES);
                    VEHICLES = { ...DEFAULT_VEHICLES };
                    console.log('ğŸš— Default-Fahrzeuge in Firebase gespeichert');
                }
                
                // Aktualisiere Fahrer-Dropdown falls vorhanden
                updateVehicleDropdowns();
                
            } catch (error) {
                console.error('âŒ Fehler beim Laden der Fahrzeuge:', error);
            }
        }
        
        function updateVehicleDropdowns() {
            // Aktualisiere alle Fahrzeug-Dropdowns in der App
            const selects = document.querySelectorAll('#edit-ride-modal select, .vehicle-select');
            selects.forEach(select => {
                if (select.id === 'edit-vehicle' || select.classList.contains('vehicle-select')) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">-- Fahrzeug wÃ¤hlen --</option>';
                    Object.values(VEHICLES).forEach(v => {
                        select.innerHTML += `<option value="${v.id}" ${v.id === currentValue ? 'selected' : ''}>${v.name} (${v.plate})</option>`;
                    });
                }
            });
        }
        
        function renderVehicles() {
            const container = document.getElementById('vehicles-list');
            if (!container) return;
            
            if (Object.keys(VEHICLES).length === 0) {
                container.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">Keine Fahrzeuge vorhanden</div>';
                return;
            }
            
            let html = '';
            Object.values(VEHICLES).forEach(v => {
                html += `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:#f8fafc;border-radius:8px;margin-bottom:8px;border-left:4px solid #f59e0b;">
                        <div>
                            <div style="font-weight:600;color:#1e293b;">${v.name}</div>
                            <div style="font-size:13px;color:#64748b;">ğŸš— ${v.plate}</div>
                        </div>
                        <div style="display:flex;gap:8px;">
                            <button onclick="editVehicle('${v.id}')" style="padding:8px 12px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;">âœï¸</button>
                            <button onclick="deleteVehicle('${v.id}')" style="padding:8px 12px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function showAddVehicleModal(vehicleId = null) {
            const vehicle = vehicleId ? VEHICLES[vehicleId] : null;
            const isEdit = !!vehicle;
            
            const modal = document.createElement('div');
            modal.id = 'vehicle-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;';
            
            modal.innerHTML = `
                <div style="background:white;padding:25px;border-radius:12px;width:90%;max-width:400px;box-shadow:0 10px 40px rgba(0,0,0,0.3);">
                    <h3 style="margin:0 0 20px 0;">${isEdit ? 'âœï¸ Fahrzeug bearbeiten' : 'â• Neues Fahrzeug'}</h3>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block;font-weight:600;margin-bottom:5px;">Fahrzeug-Name *</label>
                        <input type="text" id="vehicle-name" value="${vehicle ? vehicle.name : ''}" placeholder="z.B. Tesla Model 3 #1" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;box-sizing:border-box;">
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block;font-weight:600;margin-bottom:5px;">Kennzeichen *</label>
                        <input type="text" id="vehicle-plate" value="${vehicle ? vehicle.plate : ''}" placeholder="z.B. PW-TX 111" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;box-sizing:border-box;">
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <label style="display:block;font-weight:600;margin-bottom:5px;">Fahrzeug-ID</label>
                        <input type="text" id="vehicle-id" value="${vehicle ? vehicle.id : ''}" placeholder="z.B. tesla_model3_1" ${isEdit ? 'readonly style="background:#f3f4f6;"' : ''} style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;box-sizing:border-box;">
                        <div style="font-size:11px;color:#666;margin-top:4px;">Eindeutige ID (ohne Leerzeichen)</div>
                    </div>
                    
                    <div style="display:flex;gap:10px;">
                        <button onclick="document.getElementById('vehicle-modal').remove()" style="flex:1;padding:12px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Abbrechen</button>
                        <button onclick="saveVehicle('${vehicleId || ''}')" style="flex:1;padding:12px;background:#f59e0b;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">${isEdit ? 'Speichern' : 'HinzufÃ¼gen'}</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function editVehicle(vehicleId) {
            showAddVehicleModal(vehicleId);
        }
        
        async function saveVehicle(existingId) {
            const name = document.getElementById('vehicle-name').value.trim();
            const plate = document.getElementById('vehicle-plate').value.trim();
            let id = document.getElementById('vehicle-id').value.trim();
            
            if (!name || !plate) {
                alert('âŒ Bitte Name und Kennzeichen eingeben!');
                return;
            }
            
            // Generiere ID falls nicht vorhanden
            if (!id) {
                id = name.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_');
            }
            
            // PrÃ¼fe ob ID schon existiert (nur bei neuem Fahrzeug)
            if (!existingId && VEHICLES[id]) {
                alert('âŒ Diese Fahrzeug-ID existiert bereits!');
                return;
            }
            
            const vehicle = { id, name, plate };
            
            try {
                // Speichere in Firebase
                await db.ref('vehicles/' + id).set(vehicle);
                
                // LÃ¶sche altes Fahrzeug falls ID geÃ¤ndert wurde
                if (existingId && existingId !== id) {
                    await db.ref('vehicles/' + existingId).remove();
                    delete VEHICLES[existingId];
                }
                
                VEHICLES[id] = vehicle;
                
                console.log('âœ… Fahrzeug gespeichert:', vehicle);
                alert('âœ… Fahrzeug gespeichert!');
                
                document.getElementById('vehicle-modal').remove();
                renderVehicles();
                updateVehicleDropdowns();
                
            } catch (error) {
                console.error('âŒ Fehler beim Speichern:', error);
                alert('âŒ Fehler beim Speichern!');
            }
        }
        
        async function deleteVehicle(vehicleId) {
            const vehicle = VEHICLES[vehicleId];
            if (!vehicle) return;
            
            if (!confirm(`ğŸ—‘ï¸ Fahrzeug "${vehicle.name}" wirklich lÃ¶schen?`)) return;
            
            try {
                await db.ref('vehicles/' + vehicleId).remove();
                delete VEHICLES[vehicleId];
                
                console.log('ğŸ—‘ï¸ Fahrzeug gelÃ¶scht:', vehicleId);
                alert('âœ… Fahrzeug gelÃ¶scht!');
                
                renderVehicles();
                updateVehicleDropdowns();
                
            } catch (error) {
                console.error('âŒ Fehler beim LÃ¶schen:', error);
                alert('âŒ Fehler beim LÃ¶schen!');
            }
        }
        
        // ğŸ‘¥ BENUTZER-VERWALTUNG
        let allUsers = [];
        
        async function loadAllUsers() {
            if (!isFirebaseReady) {
                alert('âŒ Firebase nicht verbunden!');
                return;
            }
            
            try {
                const snapshot = await db.ref('users').once('value');
                allUsers = [];
                snapshot.forEach(child => {
                    const user = child.val();
                    user.uid = child.key;
                    allUsers.push(user);
                });
                
                console.log('ğŸ‘¥ Benutzer geladen:', allUsers.length);
                renderUsersList(allUsers);
            } catch (error) {
                console.error('âŒ Fehler beim Laden der Benutzer:', error);
                alert('âŒ Fehler beim Laden der Benutzer');
            }
        }
        
        function searchUsers() {
            const query = document.getElementById('user-search').value.toLowerCase();
            const filtered = allUsers.filter(u => 
                (u.email && u.email.toLowerCase().includes(query)) ||
                (u.displayName && u.displayName.toLowerCase().includes(query))
            );
            renderUsersList(filtered);
        }
        
        // ğŸš— Fahrzeug-Liste
        const vehicles = ['Tesla #1', 'Tesla #2', 'Tesla #3', 'Tesla #4', 'Tesla #5'];
        
        // â• NEUER MITARBEITER
        function showAddUserModal() {
            const modal = document.createElement('div');
            modal.id = 'add-user-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;width:90%;max-width:400px;">
                    <h3 style="margin:0 0 15px 0;">â• Neuer Mitarbeiter</h3>
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        <div>
                            <label style="font-size:12px;color:#666;">Name *</label>
                            <input type="text" id="new-user-name" placeholder="Max Mustermann" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                        </div>
                        <div>
                            <label style="font-size:12px;color:#666;">Email *</label>
                            <input type="email" id="new-user-email" placeholder="fahrer@gmail.com" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                        </div>
                        <div>
                            <label style="font-size:12px;color:#666;">Telefon</label>
                            <input type="text" id="new-user-phone" placeholder="0173 1234567" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                        </div>
                        <div>
                            <label style="font-size:12px;color:#666;">Rolle *</label>
                            <select id="new-user-role" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                                <option value="fahrgast">Fahrgast</option>
                                <option value="fahrer" selected>Fahrer</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size:12px;color:#666;">Fahrzeug (fÃ¼r Fahrer)</label>
                            <select id="new-user-vehicle" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                                <option value="">-- Kein Fahrzeug --</option>
                                ${vehicles.map(v => `<option value="${v}">${v}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div style="background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;padding:10px;margin-top:15px;font-size:12px;">
                        âš ï¸ Der Mitarbeiter muss sich spÃ¤ter selbst mit dieser Email registrieren. Die Rolle wird automatisch zugewiesen.
                    </div>
                    <div style="display:flex;gap:10px;margin-top:15px;">
                        <button onclick="saveNewUser()" style="flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">ğŸ’¾ Speichern</button>
                        <button onclick="closeAddUserModal()" style="flex:1;padding:12px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Abbrechen</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeAddUserModal() {
            const modal = document.getElementById('add-user-modal');
            if (modal) modal.remove();
        }
        
        async function saveNewUser() {
            const name = document.getElementById('new-user-name').value.trim();
            const email = document.getElementById('new-user-email').value.trim();
            const role = document.getElementById('new-user-role').value;
            
            if (!name || !email) {
                alert('âŒ Name und Email sind erforderlich!');
                return;
            }
            
            // Erstelle vorab einen Eintrag - wird mit echtem UID verknÃ¼pft wenn User sich registriert
            const userData = {
                displayName: name,
                email: email,
                phone: document.getElementById('new-user-phone').value.trim(),
                role: role,
                vehicle: document.getElementById('new-user-vehicle').value,
                preRegistered: true,
                createdAt: Date.now()
            };
            
            try {
                // Speichere unter Email als Key (wird spÃ¤ter mit UID verknÃ¼pft)
                const emailKey = email.replace(/\./g, '_').replace(/@/g, '_at_');
                await db.ref('preRegisteredUsers/' + emailKey).set(userData);
                console.log('âœ… Mitarbeiter vorregistriert:', email);
                closeAddUserModal();
                alert('âœ… Mitarbeiter "' + name + '" wurde angelegt!\n\nDer Mitarbeiter kann sich jetzt mit ' + email + ' registrieren und bekommt automatisch die Rolle "' + role + '".');
            } catch (error) {
                console.error('âŒ Fehler:', error);
                alert('âŒ Fehler beim Speichern');
            }
        }
        
        function renderUsersList(users) {
            const container = document.getElementById('users-list');
            
            if (users.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">Keine Benutzer gefunden</div>';
                return;
            }
            
            container.innerHTML = users.map(user => {
                const roleOptions = ['fahrgast', 'fahrer', 'admin'];
                const currentRole = user.role || 'fahrgast';
                
                return `
                    <div style="background:white;border:1px solid #e0e0e0;border-radius:8px;padding:12px;margin-bottom:10px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div style="flex:1;">
                                <div style="font-weight:600;">${user.displayName || 'Unbekannt'}</div>
                                <div style="font-size:12px;color:#666;">${user.email}</div>
                                ${user.phone ? `<div style="font-size:11px;color:#888;">ğŸ“ ${user.phone}</div>` : ''}
                                ${user.vehicle ? `<div style="font-size:11px;color:#10b981;">ğŸš— ${user.vehicle}</div>` : ''}
                                <div style="font-size:10px;color:#999;">Letzter Login: ${user.lastLogin ? new Date(user.lastLogin).toLocaleString('de-DE') : 'Nie'}</div>
                            </div>
                            <div style="display:flex;flex-direction:column;gap:5px;align-items:flex-end;">
                                <select onchange="changeUserRole('${user.uid}', this.value)" style="padding:6px;border:2px solid #e0e0e0;border-radius:6px;font-size:12px;">
                                    ${roleOptions.map(role => `<option value="${role}" ${currentRole === role ? 'selected' : ''}>${role.charAt(0).toUpperCase() + role.slice(1)}</option>`).join('')}
                                </select>
                                <button onclick="editUser('${user.uid}')" style="padding:6px 10px;background:#3b82f6;color:white;border:none;border-radius:6px;font-size:11px;cursor:pointer;">
                                    âœï¸ Bearbeiten
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function editUser(uid) {
            const user = allUsers.find(u => u.uid === uid);
            if (!user) return;
            
            const currentVehicle = user.vehicle || '';
            
            const modal = document.createElement('div');
            modal.id = 'edit-user-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;width:90%;max-width:400px;">
                    <h3 style="margin:0 0 15px 0;">âœï¸ Mitarbeiter bearbeiten</h3>
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        <div>
                            <label style="font-size:12px;color:#666;">Name</label>
                            <input type="text" id="edit-user-name" value="${user.displayName || ''}" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                        </div>
                        <div>
                            <label style="font-size:12px;color:#666;">Email (nicht Ã¤nderbar)</label>
                            <input type="text" value="${user.email}" disabled style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;background:#f3f4f6;">
                        </div>
                        <div>
                            <label style="font-size:12px;color:#666;">Telefon</label>
                            <input type="text" id="edit-user-phone" value="${user.phone || ''}" placeholder="0173 1234567" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                        </div>
                        <div>
                            <label style="font-size:12px;color:#666;">Fahrzeug (fÃ¼r Fahrer)</label>
                            <select id="edit-user-vehicle" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                                <option value="">-- Kein Fahrzeug --</option>
                                ${vehicles.map(v => `<option value="${v}" ${currentVehicle === v ? 'selected' : ''}>${v}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div style="display:flex;gap:10px;margin-top:15px;">
                        <button onclick="saveUser('${uid}')" style="flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">ğŸ’¾ Speichern</button>
                        <button onclick="closeEditUserModal()" style="flex:1;padding:12px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Abbrechen</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeEditUserModal() {
            const modal = document.getElementById('edit-user-modal');
            if (modal) modal.remove();
        }
        
        async function saveUser(uid) {
            const updates = {
                displayName: document.getElementById('edit-user-name').value.trim(),
                phone: document.getElementById('edit-user-phone').value.trim(),
                vehicle: document.getElementById('edit-user-vehicle').value
            };
            
            try {
                await db.ref('users/' + uid).update(updates);
                console.log('âœ… Benutzer aktualisiert');
                closeEditUserModal();
                loadAllUsers();
                alert('âœ… Benutzer aktualisiert!');
            } catch (error) {
                console.error('âŒ Fehler:', error);
                alert('âŒ Fehler beim Speichern');
            }
        }
        
        async function changeUserRole(uid, newRole) {
            if (!isFirebaseReady) return;
            
            try {
                await db.ref('users/' + uid).update({ role: newRole });
                console.log('âœ… Rolle geÃ¤ndert:', uid, 'â†’', newRole);
                
                // Update lokale Liste
                const user = allUsers.find(u => u.uid === uid);
                if (user) user.role = newRole;
                
                alert('âœ… Rolle geÃ¤ndert zu: ' + newRole);
            } catch (error) {
                console.error('âŒ Fehler beim Ã„ndern der Rolle:', error);
                alert('âŒ Fehler beim Ã„ndern der Rolle');
            }
        }
        
        // ğŸ“‹ STAMMKUNDEN-CRM FUNKTIONEN
        let allCustomers = [];
        let allAppUsers = [];
        let currentCrmTab = 'customers';
        
        function switchCrmTab(tab) {
            currentCrmTab = tab;
            const customersTab = document.getElementById('crm-tab-customers');
            const usersTab = document.getElementById('crm-tab-users');
            
            if (tab === 'customers') {
                customersTab.style.background = '#10b981';
                customersTab.style.color = 'white';
                usersTab.style.background = '#f3f4f6';
                usersTab.style.color = '#333';
                loadAllCustomers();
            } else {
                usersTab.style.background = '#3b82f6';
                usersTab.style.color = 'white';
                customersTab.style.background = '#f3f4f6';
                customersTab.style.color = '#333';
                loadAllAppUsers();
            }
        }
        
        async function loadAllAppUsers() {
            if (!isFirebaseReady) {
                alert('âŒ Firebase nicht verbunden!');
                return;
            }
            
            const container = document.getElementById('customers-list');
            container.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">â³ Lade App-User...</div>';
            
            try {
                const snapshot = await db.ref('users').once('value');
                allAppUsers = [];
                snapshot.forEach(child => {
                    const user = child.val();
                    user.uid = child.key;
                    allAppUsers.push(user);
                });
                
                // Sortiere nach Registrierung (neueste zuerst)
                allAppUsers.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                
                console.log('ğŸ“± App-User geladen:', allAppUsers.length);
                renderAppUsersList(allAppUsers);
            } catch (error) {
                console.error('âŒ Fehler beim Laden der User:', error);
                container.innerHTML = '<div style="text-align:center;color:red;padding:20px;">âŒ Fehler beim Laden</div>';
            }
        }
        
        function renderAppUsersList(users) {
            const container = document.getElementById('customers-list');
            
            if (users.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">Keine App-User gefunden</div>';
                return;
            }
            
            container.innerHTML = users.map(u => {
                const createdDate = u.createdAt ? new Date(u.createdAt).toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'}) : 'Unbekannt';
                const lastLogin = u.lastLogin ? new Date(u.lastLogin).toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'}) : 'Nie';
                
                // Login-Methode ermitteln
                let loginMethod = 'â“';
                if (u.phone) loginMethod = 'ğŸ“± Telefon';
                else if (u.email && u.email.includes('@')) loginMethod = 'âœ‰ï¸ E-Mail';
                if (u.providerId === 'google.com') loginMethod = 'ğŸ”µ Google';
                
                // Rolle mit Farbe
                let roleColor = '#666';
                let roleText = u.role || 'Fahrgast';
                if (u.role === 'admin') { roleColor = '#dc2626'; roleText = 'ğŸ‘‘ Admin'; }
                else if (u.role === 'driver') { roleColor = '#2563eb'; roleText = 'ğŸš— Fahrer'; }
                else { roleText = 'ğŸ‘¤ Fahrgast'; }
                
                return `
                    <div style="background:white;border:1px solid #e0e0e0;border-radius:8px;padding:12px;margin-bottom:10px;">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                            <div style="flex:1;">
                                <div style="font-weight:600;font-size:15px;">${u.displayName || u.name || 'Unbekannt'}</div>
                                ${u.phone ? `<div style="font-size:13px;color:#666;">ğŸ“ ${u.phone}</div>` : ''}
                                ${u.email ? `<div style="font-size:12px;color:#888;">ğŸ“§ ${u.email}</div>` : ''}
                                <div style="display:flex;gap:10px;margin-top:6px;flex-wrap:wrap;">
                                    <span style="font-size:11px;background:#f3f4f6;padding:2px 8px;border-radius:4px;">${loginMethod}</span>
                                    <span style="font-size:11px;background:${roleColor}22;color:${roleColor};padding:2px 8px;border-radius:4px;font-weight:600;">${roleText}</span>
                                </div>
                                <div style="font-size:11px;color:#999;margin-top:6px;">
                                    ğŸ“… Registriert: ${createdDate}<br>
                                    ğŸ• Letzter Login: ${lastLogin}
                                </div>
                            </div>
                            <div style="display:flex;flex-direction:column;gap:5px;">
                                <button onclick="addUserToCustomers('${u.uid}')" style="padding:8px 12px;background:#10b981;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;">
                                    â• Ins CRM
                                </button>
                                <button onclick="bookForAppUser('${u.uid}')" style="padding:8px 12px;background:#8b5cf6;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;">
                                    ğŸš• Buchen
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // App-User ins CRM Ã¼bernehmen
        async function addUserToCustomers(uid) {
            const user = allAppUsers.find(u => u.uid === uid);
            if (!user) return;
            
            try {
                // PrÃ¼fe ob schon im CRM (per Telefon oder Email)
                const existingCustomer = allCustomers.find(c => 
                    (user.phone && c.phone === user.phone) ||
                    (user.email && c.email === user.email)
                );
                
                if (existingCustomer) {
                    alert('â„¹ï¸ Dieser User ist bereits im CRM vorhanden!');
                    return;
                }
                
                // Ins CRM eintragen
                const customerId = user.phone ? user.phone.replace(/[^0-9]/g, '') : uid;
                await db.ref('customers/' + customerId).set({
                    name: user.displayName || user.name || 'Unbekannt',
                    phone: user.phone || '',
                    email: user.email || '',
                    address: user.address || '',
                    totalRides: 0,
                    totalRevenue: 0,
                    createdAt: Date.now(),
                    source: 'app-registration'
                });
                
                alert('âœ… User wurde ins CRM Ã¼bernommen!');
                
                // Wechsle zum CRM Tab
                switchCrmTab('customers');
                
            } catch (error) {
                console.error('Fehler:', error);
                alert('âŒ Fehler: ' + error.message);
            }
        }
        
        // Fahrt fÃ¼r App-User buchen
        function bookForAppUser(uid) {
            const user = allAppUsers.find(u => u.uid === uid);
            if (!user) return;
            
            // Formular ausfÃ¼llen
            if (user.displayName || user.name) {
                document.getElementById('customer-name').value = user.displayName || user.name;
            }
            if (user.phone) {
                document.getElementById('customer-phone').value = user.phone;
            }
            
            // Zum Buchungsformular scrollen
            document.getElementById('booking-section').scrollIntoView({ behavior: 'smooth' });
            
            alert('âœ… Kundendaten Ã¼bernommen!\n\nBitte Abholadresse eingeben.');
        }
        
        async function loadAllCustomers() {
            if (!isFirebaseReady) {
                alert('âŒ Firebase nicht verbunden!');
                return;
            }
            
            try {
                const snapshot = await db.ref('customers').once('value');
                allCustomers = [];
                snapshot.forEach(child => {
                    const customer = child.val();
                    customer.id = child.key;
                    allCustomers.push(customer);
                });
                
                // Sortiere nach letzter Fahrt (neueste zuerst)
                allCustomers.sort((a, b) => (b.lastRide || 0) - (a.lastRide || 0));
                
                console.log('ğŸ“‹ Kunden geladen:', allCustomers.length);
                renderCustomersList(allCustomers);
            } catch (error) {
                console.error('âŒ Fehler beim Laden der Kunden:', error);
                alert('âŒ Fehler beim Laden der Kunden');
            }
        }
        
        function searchCustomers() {
            const query = document.getElementById('customer-search').value.toLowerCase();
            
            if (currentCrmTab === 'customers') {
                const filtered = allCustomers.filter(c => 
                    (c.name && c.name.toLowerCase().includes(query)) ||
                    (c.email && c.email.toLowerCase().includes(query)) ||
                    (c.phone && c.phone.includes(query)) ||
                    (c.address && c.address.toLowerCase().includes(query))
                );
                renderCustomersList(filtered);
            } else {
                const filtered = allAppUsers.filter(u => 
                    (u.displayName && u.displayName.toLowerCase().includes(query)) ||
                    (u.name && u.name.toLowerCase().includes(query)) ||
                    (u.email && u.email.toLowerCase().includes(query)) ||
                    (u.phone && u.phone.includes(query))
                );
                renderAppUsersList(filtered);
            }
        }
        
        function renderCustomersList(customers) {
            const container = document.getElementById('customers-list');
            
            if (customers.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">Keine Kunden gefunden</div>';
                return;
            }
            
            container.innerHTML = customers.map(c => {
                const lastRideDate = c.lastRide ? new Date(c.lastRide).toLocaleDateString('de-DE') : 'Nie';
                return `
                    <div style="background:white;border:1px solid #e0e0e0;border-radius:8px;padding:12px;margin-bottom:10px;">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                            <div style="flex:1;">
                                <div style="font-weight:600;font-size:15px;">${c.name || 'Unbekannt'}</div>
                                ${c.phone ? `<div style="font-size:13px;color:#666;">ğŸ“ ${c.phone}</div>` : ''}
                                ${c.email ? `<div style="font-size:12px;color:#888;">ğŸ“§ ${c.email}</div>` : ''}
                                ${c.address ? `<div style="font-size:12px;color:#888;">ğŸ“ ${c.address}</div>` : ''}
                                <div style="font-size:11px;color:#999;margin-top:4px;">
                                    ğŸš• ${c.totalRides || 0} Fahrten Â· ğŸ’° ${(c.totalRevenue || 0).toFixed(2)}â‚¬ Â· ğŸ“… ${lastRideDate}
                                </div>
                            </div>
                            <div style="display:flex;flex-direction:column;gap:5px;">
                                <button onclick="bookForCustomer('${c.id}')" style="padding:8px 12px;background:#10b981;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;">
                                    ğŸš• Buchen
                                </button>
                                <button onclick="showCustomerHistory('${c.id}', '${(c.name || '').replace(/'/g, "\\'")}', '${(c.phone || '').replace(/'/g, "\\'")}')" style="padding:8px 12px;background:#8b5cf6;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;">
                                    ğŸ“‹ Verlauf
                                </button>
                                <button onclick="editCustomer('${c.id}')" style="padding:8px 12px;background:#3b82f6;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;">
                                    âœï¸ Bearbeiten
                                </button>
                            </div>
                        </div>
                        ${c.notes ? `<div style="font-size:11px;color:#666;margin-top:8px;padding:8px;background:#f9fafb;border-radius:4px;">ğŸ“ ${c.notes}</div>` : ''}
                        <div id="customer-history-${c.id}" style="display:none;margin-top:10px;"></div>
                    </div>
                `;
            }).join('');
        }
        
        // ğŸ“ Stammkunden-Erkennung bei Telefonnummer-Eingabe (NUR FÃœR EINGELOGGTE!)
        let phoneCheckTimeout = null;
        let lastCheckedPhone = '';
        
        // ğŸ“‹ KUNDEN-FAHRTVERLAUF ANZEIGEN
        async function showCustomerHistory(customerId, customerName, customerPhone) {
            const historyDiv = document.getElementById('customer-history-' + customerId);
            if (!historyDiv) return;
            
            // Toggle: Wenn schon offen, schlieÃŸen
            if (historyDiv.style.display === 'block') {
                historyDiv.style.display = 'none';
                return;
            }
            
            historyDiv.innerHTML = '<div style="text-align:center;padding:10px;color:#666;">â³ Lade Fahrtverlauf...</div>';
            historyDiv.style.display = 'block';
            
            if (!isFirebaseReady) {
                historyDiv.innerHTML = '<div style="color:red;padding:10px;">âŒ Firebase nicht verbunden</div>';
                return;
            }
            
            try {
                const snapshot = await db.ref('rides').orderByChild('createdAt').once('value');
                const customerRides = [];
                
                // Normalisiere Telefonnummer fÃ¼r Vergleich
                const normalizedPhone = customerPhone ? customerPhone.replace(/\D/g, '').slice(-10) : '';
                const normalizedName = customerName ? customerName.toLowerCase().trim() : '';
                
                snapshot.forEach(child => {
                    const ride = child.val();
                    ride.firebaseId = child.key;
                    
                    // PrÃ¼fe ob Fahrt zu diesem Kunden gehÃ¶rt
                    let isMatch = false;
                    
                    // Match Ã¼ber Telefonnummer
                    if (normalizedPhone && ride.customerPhone) {
                        const ridePhone = ride.customerPhone.replace(/\D/g, '').slice(-10);
                        if (ridePhone === normalizedPhone) {
                            isMatch = true;
                        }
                    }
                    
                    // Match Ã¼ber Name (falls Telefon nicht passt)
                    if (!isMatch && normalizedName && ride.customerName) {
                        if (ride.customerName.toLowerCase().trim() === normalizedName) {
                            isMatch = true;
                        }
                    }
                    
                    if (isMatch) {
                        customerRides.push(ride);
                    }
                });
                
                // Sortiere nach Datum (neueste zuerst)
                customerRides.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                
                if (customerRides.length === 0) {
                    historyDiv.innerHTML = `
                        <div style="background:#f9fafb;border-radius:6px;padding:15px;text-align:center;">
                            <div style="font-size:24px;margin-bottom:5px;">ğŸ“­</div>
                            <div style="color:#666;">Keine Fahrten gefunden</div>
                        </div>
                    `;
                    return;
                }
                
                // Statistiken berechnen
                let totalRevenue = 0;
                let completedRides = 0;
                let cancelledRides = 0;
                
                customerRides.forEach(r => {
                    if (r.status === 'completed') {
                        completedRides++;
                        totalRevenue += parseFloat(r.price) || 0;
                    } else if (r.status === 'storniert' || r.status === 'cancelled') {
                        cancelledRides++;
                    }
                });
                
                // HTML erstellen
                let html = `
                    <div style="background:#f0fdf4;border-radius:6px;padding:10px;margin-bottom:10px;">
                        <div style="font-weight:600;margin-bottom:5px;">ğŸ“Š Statistik fÃ¼r ${customerName}</div>
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;font-size:12px;">
                            <div style="text-align:center;">
                                <div style="font-size:18px;font-weight:bold;color:#16a34a;">${completedRides}</div>
                                <div style="color:#666;">Abgeschlossen</div>
                            </div>
                            <div style="text-align:center;">
                                <div style="font-size:18px;font-weight:bold;color:#dc2626;">${cancelledRides}</div>
                                <div style="color:#666;">Storniert</div>
                            </div>
                            <div style="text-align:center;">
                                <div style="font-size:18px;font-weight:bold;color:#2563eb;">${totalRevenue.toFixed(2)}â‚¬</div>
                                <div style="color:#666;">Umsatz</div>
                            </div>
                        </div>
                    </div>
                    <div style="font-weight:600;margin-bottom:8px;">ğŸ“‹ Letzte ${Math.min(customerRides.length, 10)} Fahrten:</div>
                `;
                
                // Zeige max 10 Fahrten
                const displayRides = customerRides.slice(0, 10);
                
                displayRides.forEach(ride => {
                    const date = ride.createdAt ? new Date(ride.createdAt).toLocaleDateString('de-DE', {
                        day: '2-digit', month: '2-digit', year: '2-digit'
                    }) : '?';
                    const time = ride.createdAt ? new Date(ride.createdAt).toLocaleTimeString('de-DE', {
                        hour: '2-digit', minute: '2-digit'
                    }) : '';
                    
                    let statusColor = '#666';
                    let statusIcon = 'â³';
                    if (ride.status === 'completed') {
                        statusColor = '#16a34a';
                        statusIcon = 'âœ…';
                    } else if (ride.status === 'storniert' || ride.status === 'cancelled') {
                        statusColor = '#dc2626';
                        statusIcon = 'âŒ';
                    } else if (ride.status === 'accepted' || ride.status === 'picked_up') {
                        statusColor = '#2563eb';
                        statusIcon = 'ğŸš—';
                    }
                    
                    // Escape fÃ¼r onclick
                    const pickupEsc = (ride.pickup || '').replace(/'/g, "\\'");
                    const destEsc = (ride.destination || '').replace(/'/g, "\\'");
                    const nameEsc = (ride.customerName || customerName || '').replace(/'/g, "\\'");
                    const phoneEsc = (ride.customerPhone || customerPhone || '').replace(/'/g, "\\'");
                    
                    html += `
                        <div style="background:white;border:1px solid #e5e7eb;border-radius:6px;padding:8px;margin-bottom:6px;font-size:12px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <div>
                                    <span style="color:${statusColor};font-weight:600;">${statusIcon}</span>
                                    <span style="color:#666;">${date} ${time}</span>
                                </div>
                                <div style="display:flex;align-items:center;gap:8px;">
                                    <span style="font-weight:600;color:#16a34a;">${ride.price || '?'}â‚¬</span>
                                    <button onclick="rebookFromHistory('${pickupEsc}', '${destEsc}', '${nameEsc}', '${phoneEsc}')" style="padding:4px 8px;background:#10b981;color:white;border:none;border-radius:4px;font-size:11px;cursor:pointer;">
                                        ğŸ” Buchen
                                    </button>
                                </div>
                            </div>
                            <div style="color:#333;margin-top:4px;">
                                ğŸ“ ${ride.pickup || '?'} â†’ ${ride.destination || '?'}
                            </div>
                            ${ride.vehicle ? `<div style="color:#888;font-size:11px;">ğŸš— ${ride.vehicle}</div>` : ''}
                        </div>
                    `;
                });
                
                if (customerRides.length > 10) {
                    html += `<div style="text-align:center;color:#666;font-size:11px;padding:5px;">... und ${customerRides.length - 10} weitere Fahrten</div>`;
                }
                
                historyDiv.innerHTML = html;
                
            } catch (error) {
                console.error('âŒ Fehler beim Laden des Verlaufs:', error);
                historyDiv.innerHTML = '<div style="color:red;padding:10px;">âŒ Fehler beim Laden</div>';
            }
        }
        
        // ğŸ” FAHRT AUS KUNDENVERLAUF WIEDER BUCHEN
        function rebookFromHistory(pickup, destination, customerName, customerPhone) {
            // Wechsle zum Fahrgast-Tab
            switchView('passenger');
            
            // FÃ¼lle das Buchungsformular
            const pickupField = document.getElementById('pickup');
            const destField = document.getElementById('destination');
            const nameField = document.getElementById('customer-name');
            const phoneField = document.getElementById('customer-phone');
            
            if (pickupField) pickupField.value = pickup;
            if (destField) destField.value = destination;
            if (nameField) nameField.value = customerName;
            if (phoneField) phoneField.value = customerPhone;
            
            // Berechne Route neu
            if (pickup && destination) {
                calculateRoute();
            }
            
            // Scroll zum Formular
            const form = document.getElementById('booking-form');
            if (form) {
                form.scrollIntoView({ behavior: 'smooth' });
            }
            
            // BestÃ¤tigung
            alert('âœ… Daten Ã¼bernommen!\n\nğŸ“ ' + pickup + ' â†’ ' + destination + '\nğŸ‘¤ ' + customerName + '\n\nBitte Abholzeit wÃ¤hlen und buchen.');
        }
        
        async function checkPhoneInCRM() {
            const phoneInput = document.getElementById('customer-phone');
            const greetingDiv = document.getElementById('crm-greeting');
            if (!phoneInput || !greetingDiv) return;
            
            // ğŸ”’ NUR fÃ¼r eingeloggte User (Datenschutz!)
            if (!currentUser) {
                greetingDiv.style.display = 'none';
                return;
            }
            
            const phone = phoneInput.value.trim();
            
            // Mindestens 10 Ziffern fÃ¼r Suche (komplette Nummer)
            const digits = phone.replace(/\D/g, '');
            if (digits.length < 10) {
                greetingDiv.style.display = 'none';
                lastCheckedPhone = '';
                return;
            }
            
            // Nicht erneut prÃ¼fen wenn gleiche Nummer
            if (digits === lastCheckedPhone) return;
            
            // Debounce: Warte 500ms nach letzter Eingabe
            clearTimeout(phoneCheckTimeout);
            phoneCheckTimeout = setTimeout(async () => {
                if (!isFirebaseReady) return;
                
                try {
                    const snapshot = await db.ref('customers').once('value');
                    let foundCustomer = null;
                    
                    // Letzte 10 Ziffern der eingegebenen Nummer
                    const inputLast10 = digits.slice(-10);
                    
                    snapshot.forEach(child => {
                        const customer = child.val();
                        if (customer.phone) {
                            // PrÃ¼fe alle Nummern (kÃ¶nnen mit / getrennt sein)
                            const customerPhones = customer.phone.split('/').map(p => p.replace(/\D/g, ''));
                            for (const cp of customerPhones) {
                                if (cp && cp.length >= 10) {
                                    // Vergleiche letzte 10 Ziffern (exakt!)
                                    const cpLast10 = cp.slice(-10);
                                    if (cpLast10 === inputLast10) {
                                        foundCustomer = customer;
                                        return true; // break forEach
                                    }
                                }
                            }
                        }
                    });
                    
                    lastCheckedPhone = digits;
                    
                    if (foundCustomer) {
                        // Stammkunde gefunden! ğŸ‰
                        const rideText = foundCustomer.totalRides === 1 ? 'Fahrt' : 'Fahrten';
                        greetingDiv.innerHTML = `
                            <div style="font-weight:600;font-size:16px;">ğŸ‘‹ Willkommen zurÃ¼ck, ${foundCustomer.name}!</div>
                            <div style="margin-top:4px;opacity:0.9;">â­ ${foundCustomer.totalRides || 0} ${rideText} | ğŸ’° ${(foundCustomer.totalRevenue || 0).toFixed(2)}â‚¬ Umsatz</div>
                        `;
                        greetingDiv.style.display = 'block';
                        
                        // Daten automatisch ausfÃ¼llen
                        const nameInput = document.getElementById('customer-name');
                        const pickupInput = document.getElementById('pickup');
                        
                        if (nameInput && !nameInput.value.trim()) {
                            nameInput.value = foundCustomer.name;
                        }
                        if (pickupInput && !pickupInput.value.trim() && foundCustomer.address) {
                            pickupInput.value = foundCustomer.address;
                        }
                    } else {
                        greetingDiv.style.display = 'none';
                    }
                } catch (error) {
                    console.error('CRM-Check Fehler:', error);
                }
            }, 500);
        }
        
        // ğŸ‘¤ MEIN PROFIL - Funktionen fÃ¼r eingeloggte Kunden
        let myProfileData = null;
        
        async function loadMyProfile() {
            if (!currentUser || !isFirebaseReady) {
                document.getElementById('my-profile-box').style.display = 'none';
                return;
            }
            
            try {
                // Suche Profil basierend auf E-Mail
                const snapshot = await db.ref('customers').once('value');
                let foundProfile = null;
                let foundProfileId = null;
                
                snapshot.forEach(child => {
                    const customer = child.val();
                    if (customer.email && customer.email.toLowerCase() === currentUser.email.toLowerCase()) {
                        foundProfile = customer;
                        foundProfileId = child.key;
                        return true;
                    }
                });
                
                if (foundProfile) {
                    myProfileData = { ...foundProfile, id: foundProfileId };
                } else {
                    // Neues Profil anlegen
                    myProfileData = {
                        name: currentUser.displayName || '',
                        email: currentUser.email,
                        phone: '',
                        address: '',
                        notes: '',
                        totalRides: 0,
                        totalRevenue: 0,
                        createdAt: Date.now()
                    };
                    const newRef = await db.ref('customers').push(myProfileData);
                    myProfileData.id = newRef.key;
                }
                
                // Box anzeigen
                const box = document.getElementById('my-profile-box');
                const info = document.getElementById('my-profile-info');
                
                // Rechnungsadresse formatieren
                let billingInfo = '';
                if (myProfileData.billingName || myProfileData.billingStreet) {
                    billingInfo = `<div style="margin-top:4px;padding-top:4px;border-top:1px solid rgba(255,255,255,0.2);font-size:11px;">
                        ğŸ§¾ ${myProfileData.billingName || ''}${myProfileData.billingStreet ? ', ' + myProfileData.billingStreet : ''}${myProfileData.billingZip ? ', ' + myProfileData.billingZip : ''} ${myProfileData.billingCity || ''}
                    </div>`;
                }
                
                info.innerHTML = `
                    <div><strong>${myProfileData.name || 'Name nicht gesetzt'}</strong></div>
                    ${myProfileData.phone ? `<div>ğŸ“ ${myProfileData.phone}</div>` : '<div style="opacity:0.7">ğŸ“ Telefon nicht gesetzt</div>'}
                    ${myProfileData.address ? `<div>ğŸ  ${myProfileData.address}</div>` : '<div style="opacity:0.7">ğŸ  Adresse nicht gesetzt</div>'}
                    ${billingInfo}
                `;
                box.style.display = 'block';
                
            } catch (error) {
                console.error('Profil laden Fehler:', error);
            }
        }
        
        function showMyProfileModal() {
            if (!myProfileData) return;
            
            const modal = document.createElement('div');
            modal.id = 'my-profile-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;width:90%;max-width:400px;max-height:90vh;overflow-y:auto;">
                    <h3 style="margin:0 0 15px 0;">ğŸ‘¤ Meine Daten bearbeiten</h3>
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        <input type="text" id="my-profile-name" value="${myProfileData.name || ''}" placeholder="Name *" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;">
                        <input type="tel" id="my-profile-phone" value="${myProfileData.phone || ''}" placeholder="Telefonnummer *" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;">
                        
                        <div style="margin-top:5px;font-size:12px;color:#666;font-weight:600;">ğŸ“ Abholadresse (Standard)</div>
                        <div class="input-group" style="position:relative;margin:0;">
                            <input type="text" id="my-profile-address" value="${myProfileData.address || ''}" placeholder="Meine Adresse (Abholort)" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;width:100%;box-sizing:border-box;">
                            <div class="autocomplete-dropdown" id="my-profile-address-dropdown" style="z-index:10001;"></div>
                        </div>
                        
                        <div style="margin-top:10px;display:flex;align-items:center;gap:10px;">
                            <div style="font-size:12px;color:#666;font-weight:600;">ğŸ§¾ Rechnungsadresse</div>
                            <button onclick="copyAddressToBilling()" type="button" style="font-size:11px;padding:4px 8px;background:#e0e7ff;color:#4338ca;border:none;border-radius:4px;cursor:pointer;">
                                ğŸ“ Abholadresse Ã¼bernehmen
                            </button>
                        </div>
                        <input type="text" id="my-profile-billing-name" value="${myProfileData.billingName || ''}" placeholder="Name / Firma fÃ¼r Rechnung" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;">
                        
                        <!-- Autocomplete fÃ¼r Rechnungsadresse -->
                        <div class="input-group" style="position:relative;margin:0;">
                            <input type="text" id="my-profile-billing-search" placeholder="ğŸ” Adresse suchen..." style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;width:100%;box-sizing:border-box;">
                            <div class="autocomplete-dropdown" id="my-profile-billing-dropdown" style="z-index:10002;"></div>
                        </div>
                        
                        <input type="text" id="my-profile-billing-street" value="${myProfileData.billingStreet || ''}" placeholder="StraÃŸe und Hausnummer" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;">
                        <div style="display:flex;gap:10px;">
                            <input type="text" id="my-profile-billing-zip" value="${myProfileData.billingZip || ''}" placeholder="PLZ" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;width:100px;">
                            <input type="text" id="my-profile-billing-city" value="${myProfileData.billingCity || ''}" placeholder="Ort" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;flex:1;">
                        </div>
                        
                        <div style="font-size:12px;color:#666;padding:8px;background:#f3f4f6;border-radius:6px;margin-top:5px;">
                            ğŸ“§ ${myProfileData.email}<br>
                            â­ ${myProfileData.totalRides || 0} Fahrten | ğŸ’° ${(myProfileData.totalRevenue || 0).toFixed(2)}â‚¬
                        </div>
                    </div>
                    <div style="display:flex;gap:10px;margin-top:15px;">
                        <button onclick="document.getElementById('my-profile-modal').remove()" style="flex:1;padding:12px;background:#e5e7eb;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                            Abbrechen
                        </button>
                        <button onclick="saveMyProfile()" style="flex:1;padding:12px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                            ğŸ’¾ Speichern
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Autocomplete fÃ¼r Adresse (wie bei Abholort)
            const input = document.getElementById('my-profile-address');
            const dropdown = document.getElementById('my-profile-address-dropdown');
            let timeout = null;
            
            input.addEventListener('input', (e) => {
                clearTimeout(timeout);
                const value = e.target.value.trim();
                
                if (value.length < 3) {
                    dropdown.style.display = 'none';
                    return;
                }
                
                // Zeige "LÃ¤dt..." sofort
                dropdown.innerHTML = '<div class="autocomplete-item" style="color:#999;">Suche...</div>';
                dropdown.style.display = 'block';
                
                // VerzÃ¶gerte Suche (Debounce)
                timeout = setTimeout(() => {
                    searchProfileAddress(value, dropdown, input);
                }, 300);
            });
            
            // SchlieÃŸe Dropdown wenn auÃŸerhalb geklickt
            modal.addEventListener('click', (e) => {
                if (e.target !== input && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
                // Auch Billing-Dropdown schlieÃŸen
                const billingDropdown = document.getElementById('my-profile-billing-dropdown');
                const billingInput = document.getElementById('my-profile-billing-search');
                if (billingDropdown && e.target !== billingInput && !billingDropdown.contains(e.target)) {
                    billingDropdown.style.display = 'none';
                }
            });
            
            // ğŸ§¾ Autocomplete fÃ¼r RECHNUNGSADRESSE
            const billingInput = document.getElementById('my-profile-billing-search');
            const billingDropdown = document.getElementById('my-profile-billing-dropdown');
            let billingTimeout = null;
            
            billingInput.addEventListener('input', (e) => {
                clearTimeout(billingTimeout);
                const value = e.target.value.trim();
                
                if (value.length < 3) {
                    billingDropdown.style.display = 'none';
                    return;
                }
                
                billingDropdown.innerHTML = '<div class="autocomplete-item" style="color:#999;">Suche...</div>';
                billingDropdown.style.display = 'block';
                
                billingTimeout = setTimeout(() => {
                    searchBillingAddress(value, billingDropdown);
                }, 300);
            });
        }
        
        async function searchProfileAddress(query, dropdown, input) {
            try {
                const response = await fetch(
                    'https://nominatim.openstreetmap.org/search?' +
                    'format=json&' +
                    'q=' + encodeURIComponent(query) + '&' +
                    'countrycodes=de&' +
                    'limit=8&' +
                    'addressdetails=1'
                );
                
                const results = await response.json();
                
                if (results.length === 0) {
                    dropdown.innerHTML = '<div class="autocomplete-item" style="color:#999;">Keine Ergebnisse</div>';
                    return;
                }
                
                // Filtere nur Usedom-relevante Ergebnisse
                const usedomResults = results.filter(r => {
                    const display = r.display_name.toLowerCase();
                    return display.includes('usedom') || 
                           display.includes('heringsdorf') || 
                           display.includes('ahlbeck') ||
                           display.includes('bansin') ||
                           display.includes('zinnowitz') ||
                           display.includes('karlshagen') ||
                           display.includes('peenemÃ¼nde') ||
                           display.includes('koserow') ||
                           display.includes('Ã¼ckeritz') ||
                           display.includes('loddin') ||
                           display.includes('zempin') ||
                           display.includes('trassenheide');
                });
                
                const resultsToShow = usedomResults.length > 0 ? usedomResults : results;
                
                dropdown.innerHTML = resultsToShow.map(r => {
                    const address = r.address;
                    let displayText = '';
                    let fullAddress = '';
                    
                    // ğŸ¨ HOTEL, RESTAURANT, POI Namen
                    const poiName = address.amenity || address.tourism || address.building || r.name;
                    
                    // Baue Haupt-Adresszeile
                    if (address.road) {
                        fullAddress = address.road;
                        if (address.house_number) fullAddress += ' ' + address.house_number;
                    }
                    
                    // Ort
                    let city = '';
                    if (address.village) city = address.village;
                    else if (address.town) city = address.town;
                    else if (address.city) city = address.city;
                    else if (address.municipality) city = address.municipality;
                    
                    // PLZ
                    const zip = address.postcode || '';
                    
                    // ğŸ¨ Baue schÃ¶ne Anzeige
                    if (poiName && poiName !== fullAddress && poiName !== city) {
                        displayText = '<div style="font-weight:600;color:#667eea;">ğŸ¨ ' + poiName + '</div>';
                        displayText += '<div style="font-size:13px;color:#666;margin-top:2px;padding-left:20px;">';
                        if (fullAddress) displayText += fullAddress;
                        if (zip) displayText += ', ' + zip;
                        if (city) displayText += ' ' + city;
                        displayText += '</div>';
                    } else {
                        if (fullAddress) {
                            displayText = fullAddress;
                            if (zip) displayText += ', ' + zip;
                            if (city) displayText += ' ' + city;
                        } else {
                            displayText = r.display_name;
                        }
                    }
                    
                    // VollstÃ¤ndige Adresse als String
                    let addressString = '';
                    if (poiName && poiName !== fullAddress && poiName !== city) {
                        addressString = poiName + ' ';
                    }
                    if (fullAddress) addressString += fullAddress;
                    if (zip) addressString += ', ' + zip;
                    if (city) addressString += ' ' + city;
                    
                    if (!addressString) addressString = r.display_name;
                    
                    return '<div class="autocomplete-item" onclick="selectProfileAddress(\'' + addressString.replace(/'/g, "\\'") + '\')">' + displayText + '</div>';
                }).join('');
                
            } catch (e) {
                console.error('Autocomplete Fehler:', e);
                dropdown.innerHTML = '<div class="autocomplete-item" style="color:#ef4444;">Fehler bei der Suche</div>';
            }
        }
        
        function selectProfileAddress(address) {
            document.getElementById('my-profile-address').value = address;
            document.getElementById('my-profile-address-dropdown').style.display = 'none';
        }
        
        // ğŸ§¾ Rechnungsadresse suchen (deutschlandweit, ohne Usedom-Filter)
        async function searchBillingAddress(query, dropdown) {
            try {
                const response = await fetch(
                    'https://nominatim.openstreetmap.org/search?' +
                    'format=json&' +
                    'q=' + encodeURIComponent(query) + '&' +
                    'countrycodes=de&' +
                    'limit=8&' +
                    'addressdetails=1'
                );
                
                const results = await response.json();
                
                if (results.length === 0) {
                    dropdown.innerHTML = '<div class="autocomplete-item" style="color:#999;">Keine Ergebnisse</div>';
                    return;
                }
                
                dropdown.innerHTML = results.map(r => {
                    const address = r.address;
                    const street = address.road || '';
                    const houseNumber = address.house_number || '';
                    const zip = address.postcode || '';
                    const city = address.city || address.town || address.village || address.municipality || '';
                    
                    const fullStreet = street + (houseNumber ? ' ' + houseNumber : '');
                    
                    // Anzeige formatieren
                    let displayText = '';
                    if (fullStreet) displayText += fullStreet;
                    if (zip) displayText += ', ' + zip;
                    if (city) displayText += ' ' + city;
                    if (!displayText) displayText = r.display_name;
                    
                    // Daten fÃ¼r Auswahl
                    const data = JSON.stringify({
                        street: fullStreet,
                        zip: zip,
                        city: city
                    }).replace(/"/g, '&quot;');
                    
                    return '<div class="autocomplete-item" onclick="selectBillingAddress(' + "'" + data + "'" + ')">' + displayText + '</div>';
                }).join('');
                
            } catch (e) {
                console.error('Billing Autocomplete Fehler:', e);
                dropdown.innerHTML = '<div class="autocomplete-item" style="color:#ef4444;">Fehler bei der Suche</div>';
            }
        }
        
        function selectBillingAddress(dataStr) {
            try {
                const data = JSON.parse(dataStr.replace(/&quot;/g, '"'));
                
                document.getElementById('my-profile-billing-street').value = data.street || '';
                document.getElementById('my-profile-billing-zip').value = data.zip || '';
                document.getElementById('my-profile-billing-city').value = data.city || '';
                document.getElementById('my-profile-billing-search').value = '';
                document.getElementById('my-profile-billing-dropdown').style.display = 'none';
                
                console.log('ğŸ§¾ Rechnungsadresse ausgewÃ¤hlt:', data);
            } catch (e) {
                console.error('Fehler beim Parsen:', e);
            }
        }
        
        async function saveMyProfile() {
            if (!myProfileData || !myProfileData.id) return;
            
            const name = document.getElementById('my-profile-name').value.trim();
            const phone = document.getElementById('my-profile-phone').value.trim();
            const address = document.getElementById('my-profile-address').value.trim();
            
            // Rechnungsadresse
            const billingName = document.getElementById('my-profile-billing-name').value.trim();
            const billingStreet = document.getElementById('my-profile-billing-street').value.trim();
            const billingZip = document.getElementById('my-profile-billing-zip').value.trim();
            const billingCity = document.getElementById('my-profile-billing-city').value.trim();
            
            if (!name) {
                alert('âŒ Bitte Name eingeben!');
                return;
            }
            
            try {
                await db.ref('customers/' + myProfileData.id).update({
                    name: name,
                    phone: phone,
                    address: address,
                    billingName: billingName,
                    billingStreet: billingStreet,
                    billingZip: billingZip,
                    billingCity: billingCity
                });
                
                myProfileData.name = name;
                myProfileData.phone = phone;
                myProfileData.address = address;
                myProfileData.billingName = billingName;
                myProfileData.billingStreet = billingStreet;
                myProfileData.billingZip = billingZip;
                myProfileData.billingCity = billingCity;
                
                document.getElementById('my-profile-modal').remove();
                loadMyProfile(); // Box aktualisieren
                
                alert('âœ… Daten gespeichert!');
            } catch (error) {
                console.error('Speichern Fehler:', error);
                alert('âŒ Fehler beim Speichern: ' + error.message);
            }
        }
        
        // Abholadresse als Rechnungsadresse Ã¼bernehmen
        function copyAddressToBilling() {
            const address = document.getElementById('my-profile-address').value.trim();
            const name = document.getElementById('my-profile-name').value.trim();
            
            if (!address) {
                alert('âŒ Bitte zuerst Abholadresse eingeben!');
                return;
            }
            
            // Name Ã¼bernehmen
            document.getElementById('my-profile-billing-name').value = name;
            
            // Adresse parsen (versuche StraÃŸe, PLZ, Ort zu extrahieren)
            // Format oft: "StraÃŸe Nr, PLZ Ort" oder "StraÃŸe Nr, Ort"
            const parts = address.split(',').map(p => p.trim());
            
            if (parts.length >= 2) {
                // StraÃŸe ist der erste Teil
                document.getElementById('my-profile-billing-street').value = parts[0];
                
                // PLZ und Ort aus dem zweiten Teil
                const lastPart = parts[parts.length - 1];
                const plzMatch = lastPart.match(/(\d{5})\s*(.*)/);
                
                if (plzMatch) {
                    document.getElementById('my-profile-billing-zip').value = plzMatch[1];
                    document.getElementById('my-profile-billing-city').value = plzMatch[2] || '';
                } else {
                    // Kein PLZ gefunden - alles als Ort
                    document.getElementById('my-profile-billing-city').value = lastPart;
                }
            } else {
                // Nur ein Teil - als StraÃŸe Ã¼bernehmen
                document.getElementById('my-profile-billing-street').value = address;
            }
            
            console.log('ğŸ“ Abholadresse Ã¼bernommen');
        }
        
        function useMyProfileData() {
            if (!myProfileData) return;
            
            if (myProfileData.name) {
                document.getElementById('customer-name').value = myProfileData.name;
            }
            if (myProfileData.phone) {
                document.getElementById('customer-phone').value = myProfileData.phone;
            }
            if (myProfileData.address) {
                document.getElementById('pickup').value = myProfileData.address;
            }
            
            // Scroll zum Formular
            document.getElementById('booking-form').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Autocomplete Setup fÃ¼r Profil-Adresse
        
        // ğŸ—‘ï¸ Alle Kunden lÃ¶schen (fÃ¼r Neu-Import)
        async function deleteAllCustomers() {
            if (!isFirebaseReady) {
                alert('âŒ Firebase nicht verbunden!');
                return;
            }
            
            // Sicherheitsabfrage
            const confirm1 = confirm('âš ï¸ ACHTUNG!\n\nAlle Kunden im CRM werden gelÃ¶scht!\n\nDies kann nicht rÃ¼ckgÃ¤ngig gemacht werden.\n\nFortfahren?');
            if (!confirm1) return;
            
            const confirm2 = confirm('ğŸ”´ LETZTE WARNUNG!\n\nAlle Kunden werden UNWIDERRUFLICH gelÃ¶scht!\n\nTippe OK um zu lÃ¶schen.');
            if (!confirm2) return;
            
            try {
                await db.ref('customers').remove();
                alert('âœ… Alle Kunden wurden gelÃ¶scht!\n\nDu kannst jetzt die CSV neu importieren.');
                
                // Liste leeren (falls vorhanden)
                const crmList = document.getElementById('crm-list');
                if (crmList) {
                    crmList.innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Keine Kunden vorhanden</div>';
                }
            } catch (error) {
                console.error('âŒ Fehler beim LÃ¶schen:', error);
                alert('âŒ Fehler: ' + error.message);
            }
        }
        
        function showAddCustomerModal() {
            const modal = document.createElement('div');
            modal.id = 'add-customer-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;width:90%;max-width:400px;max-height:90vh;overflow-y:auto;">
                    <h3 style="margin:0 0 15px 0;">â• Neuer Kunde</h3>
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        <input type="text" id="new-customer-name" placeholder="Name *" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;">
                        <input type="text" id="new-customer-phone" placeholder="Telefon" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;">
                        <input type="email" id="new-customer-email" placeholder="Email" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;">
                        <div style="position:relative;">
                            <input type="text" id="new-customer-address" placeholder="ğŸ  Wohnanschrift" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;width:100%;">
                            <div id="new-customer-address-dropdown" style="position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #e0e0e0;border-radius:8px;max-height:200px;overflow-y:auto;display:none;z-index:10000;box-shadow:0 4px 6px rgba(0,0,0,0.1);"></div>
                        </div>
                        <textarea id="new-customer-notes" placeholder="Notizen (z.B. Kindersitz, Rollstuhl)" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;min-height:60px;"></textarea>
                    </div>
                    <div style="display:flex;gap:10px;margin-top:15px;">
                        <button onclick="saveNewCustomer()" style="flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">ğŸ’¾ Speichern</button>
                        <button onclick="closeAddCustomerModal()" style="flex:1;padding:12px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Abbrechen</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Autocomplete aktivieren nach Modal erscheint
            setTimeout(() => {
                setupCustomerAddressAutocomplete('new-customer-address', 'new-customer-address-dropdown');
            }, 100);
        }
        
        // ğŸ  Autocomplete fÃ¼r Kunden-Wohnanschrift - nutzt GLEICHE Funktion wie Abholort/Zielort
        let customerAddressTimeout = null;
        
        function setupCustomerAddressAutocomplete(inputId, suggestionsId) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(suggestionsId);
            if (!input || !dropdown) return;
            
            input.addEventListener('input', (e) => {
                clearTimeout(customerAddressTimeout);
                const value = e.target.value.trim();
                
                if (value.length < 3) {
                    dropdown.style.display = 'none';
                    return;
                }
                
                // Zeige "LÃ¤dt..." sofort
                dropdown.innerHTML = '<div style="padding:10px;color:#999;font-size:13px;">Suche...</div>';
                dropdown.style.display = 'block';
                
                // VerzÃ¶gerte Suche (Debounce)
                customerAddressTimeout = setTimeout(() => {
                    searchCustomerAddresses(value, inputId, suggestionsId);
                }, 300);
            });
            
            // SchlieÃŸe Dropdown wenn auÃŸerhalb geklickt
            document.addEventListener('click', (e) => {
                if (e.target !== input && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }
        
        async function searchCustomerAddresses(query, inputId, suggestionsId) {
            const dropdown = document.getElementById(suggestionsId);
            
            try {
                // GLEICHE Suche wie bei Abholort/Zielort!
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?` +
                    `format=json&` +
                    `q=${encodeURIComponent(query)}&` +
                    `countrycodes=de&` +
                    `limit=8&` +
                    `addressdetails=1`
                );
                
                const results = await response.json();
                
                if (results.length === 0) {
                    dropdown.innerHTML = '<div style="padding:10px;color:#999;font-size:13px;">Keine Ergebnisse gefunden</div>';
                    return;
                }
                
                // Filtere Usedom-relevante Ergebnisse (wie bei Abholort)
                const usedomResults = results.filter(r => {
                    const display = r.display_name.toLowerCase();
                    return display.includes('usedom') || 
                           display.includes('heringsdorf') || 
                           display.includes('ahlbeck') ||
                           display.includes('bansin') ||
                           display.includes('zinnowitz') ||
                           display.includes('karlshagen') ||
                           display.includes('peenemÃ¼nde') ||
                           display.includes('koserow') ||
                           display.includes('Ã¼ckeritz') ||
                           display.includes('loddin') ||
                           display.includes('zempin') ||
                           display.includes('trassenheide');
                });
                
                const resultsToShow = usedomResults.length > 0 ? usedomResults : results;
                
                dropdown.innerHTML = resultsToShow.map(r => {
                    const address = r.address;
                    let displayText = '';
                    
                    // StraÃŸe + Hausnummer
                    if (address.road) {
                        displayText = address.road;
                        if (address.house_number) displayText += ' ' + address.house_number;
                    }
                    
                    // PLZ + Ort
                    let location = '';
                    if (address.postcode) location = address.postcode + ' ';
                    location += address.village || address.town || address.city || address.municipality || '';
                    
                    if (location && displayText) {
                        displayText += ', ' + location.trim();
                    } else if (location) {
                        displayText = location.trim();
                    } else if (r.display_name) {
                        displayText = r.display_name.split(',').slice(0, 3).join(',');
                    }
                    
                    return `
                        <div onclick="document.getElementById('${inputId}').value='${displayText.replace(/'/g, "\\'")}'; document.getElementById('${suggestionsId}').style.display='none';" 
                             style="padding:10px;cursor:pointer;border-bottom:1px solid #eee;font-size:13px;"
                             onmouseover="this.style.background='#f3f4f6'" 
                             onmouseout="this.style.background='white'">
                            ğŸ“ ${displayText}
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Autocomplete Fehler:', error);
                dropdown.innerHTML = '<div style="padding:10px;color:#ef4444;font-size:13px;">Fehler bei der Suche</div>';
            }
        }
        
        function closeAddCustomerModal() {
            const modal = document.getElementById('add-customer-modal');
            if (modal) modal.remove();
        }
        
        // ğŸ“¥ Google Kontakte CSV Import
        async function importGoogleCSV(input) {
            const file = input.files[0];
            if (!file) return;
            
            if (!isFirebaseReady) {
                alert('âŒ Firebase nicht verbunden!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const csv = e.target.result;
                    
                    // NEUER CSV-Parser der mehrzeilige Felder unterstÃ¼tzt
                    const rows = parseCSVMultiline(csv);
                    
                    if (rows.length < 2) {
                        alert('âŒ CSV-Datei ist leer!');
                        return;
                    }
                    
                    // Header parsen (erste Zeile)
                    const headers = rows[0];
                    console.log('ğŸ“¥ CSV Headers:', headers);
                    
                    // Finde relevante Spalten (Google CSV Format)
                    const firstNameIdx = headers.findIndex(h => h === 'First Name');
                    const lastNameIdx = headers.findIndex(h => h === 'Last Name');
                    const orgNameIdx = headers.findIndex(h => h === 'Organization Name');
                    const phone1Idx = headers.findIndex(h => h === 'Phone 1 - Value');
                    const phone2Idx = headers.findIndex(h => h === 'Phone 2 - Value');
                    const phone3Idx = headers.findIndex(h => h === 'Phone 3 - Value');
                    const email1Idx = headers.findIndex(h => h === 'E-mail 1 - Value');
                    const addressIdx = headers.findIndex(h => h === 'Address 1 - Formatted');
                    const streetIdx = headers.findIndex(h => h === 'Address 1 - Street');
                    const cityIdx = headers.findIndex(h => h === 'Address 1 - City');
                    const postalIdx = headers.findIndex(h => h === 'Address 1 - Postal Code');
                    
                    console.log('ğŸ“¥ Spalten: FirstName=' + firstNameIdx + ', LastName=' + lastNameIdx + ', Org=' + orgNameIdx + ', Phone1=' + phone1Idx + ', Phone2=' + phone2Idx + ', Phone3=' + phone3Idx);
                    
                    let imported = 0;
                    let skipped = 0;
                    
                    // Lade existierende Kunden einmal
                    const existingSnapshot = await db.ref('customers').once('value');
                    const existingCustomers = [];
                    existingSnapshot.forEach(child => {
                        existingCustomers.push(child.val());
                    });
                    
                    // Daten parsen (ab Zeile 2)
                    for (let i = 1; i < rows.length; i++) {
                        const values = rows[i];
                        if (!values || values.length === 0) continue;
                        
                        // Name zusammenbauen
                        let name = '';
                        const firstName = firstNameIdx >= 0 ? (values[firstNameIdx] || '').trim() : '';
                        const lastName = lastNameIdx >= 0 ? (values[lastNameIdx] || '').trim() : '';
                        const orgName = orgNameIdx >= 0 ? (values[orgNameIdx] || '').trim() : '';
                        
                        // PrioritÃ¤t: Vorname+Nachname, dann Organisation
                        if (firstName || lastName) {
                            name = (firstName + ' ' + lastName).trim();
                        } else if (orgName) {
                            name = orgName;
                        }
                        
                        // Telefon (ALLE gefundenen sammeln)
                        let phones = [];
                        if (phone1Idx >= 0 && values[phone1Idx]) {
                            const p = values[phone1Idx].trim().replace(/[^\d+\s-]/g, '').trim();
                            if (p) phones.push(p);
                        }
                        if (phone2Idx >= 0 && values[phone2Idx]) {
                            const p = values[phone2Idx].trim().replace(/[^\d+\s-]/g, '').trim();
                            if (p) phones.push(p);
                        }
                        if (phone3Idx >= 0 && values[phone3Idx]) {
                            const p = values[phone3Idx].trim().replace(/[^\d+\s-]/g, '').trim();
                            if (p) phones.push(p);
                        }
                        const phone = phones.join(' / ');
                        
                        // Debug: Zeige gefundene Telefonnummern
                        if (phones.length > 1) {
                            console.log('ğŸ“± Mehrere Nummern fÃ¼r ' + name + ':', phones);
                        }
                        
                        // Email
                        const email = email1Idx >= 0 ? (values[email1Idx] || '').trim() : '';
                        
                        // Adresse zusammenbauen
                        let address = '';
                        if (addressIdx >= 0) {
                            address = (values[addressIdx] || '').trim().replace(/\n/g, ', ');
                        }
                        if (!address && streetIdx >= 0) {
                            const street = (values[streetIdx] || '').trim();
                            const city = cityIdx >= 0 ? (values[cityIdx] || '').trim() : '';
                            const postal = postalIdx >= 0 ? (values[postalIdx] || '').trim() : '';
                            if (street) {
                                address = street;
                                if (postal || city) address += ', ' + (postal + ' ' + city).trim();
                            }
                        }
                        
                        // Nur importieren wenn Name vorhanden
                        if (!name) {
                            skipped++;
                            continue;
                        }
                        
                        // PrÃ¼fe ob Kunde schon existiert (per Telefon, Email oder Name)
                        let exists = false;
                        for (const c of existingCustomers) {
                            // PrÃ¼fe jede importierte Nummer gegen existierende
                            if (phones.length > 0 && c.phone) {
                                const existingPhones = c.phone.replace(/\D/g, '');
                                for (const p of phones) {
                                    if (p.replace(/\D/g, '') && existingPhones.includes(p.replace(/\D/g, ''))) {
                                        exists = true;
                                        break;
                                    }
                                }
                            }
                            if (exists) break;
                            if (email && c.email && c.email.toLowerCase() === email.toLowerCase()) {
                                exists = true;
                                break;
                            }
                        }
                        
                        if (exists) {
                            skipped++;
                            continue;
                        }
                        
                        // Neuen Kunden anlegen
                        const newCustomer = {
                            name: name,
                            phone: phone,
                            email: email,
                            address: address,
                            notes: 'Importiert aus Google Kontakte',
                            totalRides: 0,
                            totalRevenue: 0,
                            lastRide: null,
                            createdAt: Date.now(),
                            importedFrom: 'google_csv'
                        };
                        
                        await db.ref('customers').push(newCustomer);
                        existingCustomers.push(newCustomer); // FÃ¼r Duplikat-Check
                        imported++;
                    }
                    
                    // Ergebnis anzeigen
                    alert(
                        'ğŸ“¥ Import abgeschlossen!\n\n' +
                        'âœ… Importiert: ' + imported + ' Kontakte\n' +
                        'â­ï¸ Ãœbersprungen: ' + skipped + ' (bereits vorhanden oder ohne Name)\n\n' +
                        'Klicke "ğŸ”„ Kunden laden" um die Liste zu aktualisieren.'
                    );
                    
                    // Input zurÃ¼cksetzen
                    input.value = '';
                    
                } catch (error) {
                    console.error('âŒ Import Fehler:', error);
                    alert('âŒ Fehler beim Import: ' + error.message);
                }
            };
            
            reader.readAsText(file, 'UTF-8');
        }
        
        // CSV Zeile parsen (berÃ¼cksichtigt AnfÃ¼hrungszeichen)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            
            return result;
        }
        
        // NEUER CSV-Parser fÃ¼r mehrzeilige Felder (z.B. Adressen mit ZeilenumbrÃ¼chen)
        function parseCSVMultiline(csv) {
            const rows = [];
            let currentRow = [];
            let currentField = '';
            let inQuotes = false;
            
            for (let i = 0; i < csv.length; i++) {
                const char = csv[i];
                const nextChar = csv[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // Escaped quote ("") -> single quote
                        currentField += '"';
                        i++; // Skip next quote
                    } else {
                        // Toggle quote mode
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // End of field
                    currentRow.push(currentField.trim());
                    currentField = '';
                } else if ((char === '\n' || (char === '\r' && nextChar === '\n')) && !inQuotes) {
                    // End of row (nur wenn nicht in AnfÃ¼hrungszeichen!)
                    if (char === '\r') i++; // Skip \n after \r
                    currentRow.push(currentField.trim());
                    if (currentRow.some(f => f !== '')) { // Nur nicht-leere Zeilen
                        rows.push(currentRow);
                    }
                    currentRow = [];
                    currentField = '';
                } else if (char === '\r' && !inQuotes) {
                    // Standalone \r = end of row
                    currentRow.push(currentField.trim());
                    if (currentRow.some(f => f !== '')) {
                        rows.push(currentRow);
                    }
                    currentRow = [];
                    currentField = '';
                } else {
                    currentField += char;
                }
            }
            
            // Letzte Zeile nicht vergessen
            if (currentField || currentRow.length > 0) {
                currentRow.push(currentField.trim());
                if (currentRow.some(f => f !== '')) {
                    rows.push(currentRow);
                }
            }
            
            console.log('ğŸ“¥ CSV geparst: ' + rows.length + ' Zeilen');
            return rows;
        }
        
        // ğŸ“‹ CRM: Kunde automatisch anlegen/aktualisieren bei Buchung
        async function updateCustomerCRM(name, phone, address, price) {
            if (!isFirebaseReady) return;
            if (!name || name.trim() === '') return;
            
            const cleanName = name.trim();
            const cleanPhone = phone ? phone.trim() : '';
            const cleanAddress = address ? address.trim() : '';
            const ridePrice = parseFloat(price) || 0;
            
            try {
                // Suche existierenden Kunden (per Telefon ODER Name)
                const snapshot = await db.ref('customers').once('value');
                let existingCustomerId = null;
                let existingCustomer = null;
                
                snapshot.forEach(child => {
                    const customer = child.val();
                    // PrioritÃ¤t 1: Telefonnummer stimmt Ã¼berein (wenn vorhanden)
                    if (cleanPhone && customer.phone && customer.phone === cleanPhone) {
                        existingCustomerId = child.key;
                        existingCustomer = customer;
                    }
                    // PrioritÃ¤t 2: Name stimmt Ã¼berein (wenn keine Telefonnummer)
                    if (!existingCustomerId && customer.name && customer.name.toLowerCase() === cleanName.toLowerCase()) {
                        existingCustomerId = child.key;
                        existingCustomer = customer;
                    }
                });
                
                if (existingCustomerId) {
                    // âœ… Kunde existiert â†’ Update
                    const updates = {
                        totalRides: (existingCustomer.totalRides || 0) + 1,
                        totalRevenue: (existingCustomer.totalRevenue || 0) + ridePrice,
                        lastRide: Date.now()
                    };
                    
                    // Update Adresse nur wenn leer
                    if (!existingCustomer.address && cleanAddress) {
                        updates.address = cleanAddress;
                    }
                    // Update Telefon nur wenn leer
                    if (!existingCustomer.phone && cleanPhone) {
                        updates.phone = cleanPhone;
                    }
                    
                    await db.ref('customers/' + existingCustomerId).update(updates);
                    console.log('ğŸ“‹ CRM: Kunde aktualisiert:', cleanName, 'â†’', updates.totalRides, 'Fahrten');
                    
                } else {
                    // ğŸ†• Neuer Kunde â†’ Anlegen
                    const newCustomer = {
                        name: cleanName,
                        phone: cleanPhone,
                        email: '',
                        address: cleanAddress,
                        notes: '',
                        totalRides: 1,
                        totalRevenue: ridePrice,
                        lastRide: Date.now(),
                        createdAt: Date.now(),
                        autoCreated: true // Markiert als automatisch erstellt
                    };
                    
                    await db.ref('customers').push(newCustomer);
                    console.log('ğŸ“‹ CRM: Neuer Kunde angelegt:', cleanName);
                }
                
            } catch (error) {
                console.error('ğŸ“‹ CRM Fehler:', error);
                // Fehler nicht an User zeigen - Buchung soll trotzdem funktionieren
            }
        }
        
        async function saveNewCustomer() {
            const name = document.getElementById('new-customer-name').value.trim();
            if (!name) {
                alert('âŒ Name ist erforderlich!');
                return;
            }
            
            const customer = {
                name: name,
                phone: document.getElementById('new-customer-phone').value.trim(),
                email: document.getElementById('new-customer-email').value.trim(),
                address: document.getElementById('new-customer-address').value.trim(),
                notes: document.getElementById('new-customer-notes').value.trim(),
                totalRides: 0,
                totalRevenue: 0,
                createdAt: Date.now()
            };
            
            try {
                await db.ref('customers').push(customer);
                console.log('âœ… Kunde gespeichert:', customer.name);
                closeAddCustomerModal();
                loadAllCustomers();
                alert('âœ… Kunde "' + name + '" wurde angelegt!');
            } catch (error) {
                console.error('âŒ Fehler beim Speichern:', error);
                alert('âŒ Fehler beim Speichern');
            }
        }
        
        function bookForCustomer(customerId) {
            const customer = allCustomers.find(c => c.id === customerId);
            if (!customer) return;
            
            // Speichere Kunden-ID fÃ¼r spÃ¤tere CRM-Aktualisierung
            currentBookingCustomerId = customerId;
            
            // Wechsel zum Fahrgast-Tab und fÃ¼lle Daten aus
            switchView('passenger');
            
            // ğŸ†• v5.34.0: Umfassende DatenÃ¼bernahme!
            if (customer.name) document.getElementById('customer-name').value = customer.name;
            if (customer.phone) document.getElementById('customer-phone').value = customer.phone;
            if (customer.address) document.getElementById('pickup').value = customer.address;
            if (customer.favoriteDestination) document.getElementById('destination').value = customer.favoriteDestination;
            
            // Zeige CRM-Speicher-Option
            const crmOption = document.getElementById('crm-save-option');
            if (crmOption) {
                crmOption.style.display = 'block';
                document.getElementById('save-to-crm').checked = true;
            }
            
            // Zeige BestÃ¤tigung
            const filledFields = [];
            if (customer.name) filledFields.push('Name');
            if (customer.phone) filledFields.push('Telefon');
            if (customer.address) filledFields.push('Abholort');
            if (customer.favoriteDestination) filledFields.push('Zielort');
            
            alert('âœ… Daten von "' + customer.name + '" eingefÃ¼llt!\n\n' + 
                  'ğŸ“‹ Ãœbernommen: ' + filledFields.join(', ') + '\n\n' +
                  (customer.favoriteDestination ? 'Preis kann jetzt berechnet werden!' : 'Bitte Zielort eingeben!'));
        }
        
        // ğŸ†• v5.34.0: SCHNELLBUCHUNG MODAL
        async function openQuickBookingModal() {
            if (!isFirebaseReady) {
                alert('âŒ Firebase nicht verbunden!');
                return;
            }
            
            // Lade Kunden wenn noch nicht geladen
            if (allCustomers.length === 0) {
                console.log('â³ Lade Kunden fÃ¼r Schnellbuchung...');
                await loadAllCustomers();
                console.log('âœ… Kunden geladen:', allCustomers.length);
            }
            
            const modal = document.createElement('div');
            modal.id = 'quick-booking-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;padding:15px;';
            
            // Aktuelle Zeit + 15 Minuten als Default
            const now = new Date();
            now.setMinutes(now.getMinutes() + 15);
            const defaultDate = now.toISOString().slice(0, 16);
            
            modal.innerHTML = `
                <div style="background:white;border-radius:16px;padding:20px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h3 style="margin:0;font-size:20px;">âš¡ Schnellbuchung</h3>
                        <button onclick="document.getElementById('quick-booking-modal').remove()" style="background:none;border:none;font-size:28px;cursor:pointer;color:#999;line-height:1;">Ã—</button>
                    </div>
                    
                    <div style="display:flex;flex-direction:column;gap:15px;">
                        <!-- Kunde auswÃ¤hlen -->
                        <div>
                            <label style="display:block;font-weight:600;margin-bottom:8px;">ğŸ‘¤ Kunde</label>
                            <select id="quick-booking-customer" onchange="loadQuickBookingCustomerData()" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;">
                                <option value="">Kunde auswÃ¤hlen...</option>
                                ${allCustomers.map(c => `<option value="${c.id}">${c.name || 'Unbekannt'} ${c.phone ? '(' + c.phone + ')' : ''}</option>`).join('')}
                            </select>
                        </div>
                        
                        <!-- Datum & Zeit -->
                        <div>
                            <label style="display:block;font-weight:600;margin-bottom:8px;">ğŸ“… Datum & Zeit</label>
                            <input type="datetime-local" id="quick-booking-datetime" value="${defaultDate}" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;">
                        </div>
                        
                        <!-- Abholort -->;
                        <div style="position:relative;">
                            <label style="display:block;font-weight:600;margin-bottom:8px;">ğŸ“ Abholort</label>
                            <input type="text" id="quick-booking-pickup" placeholder="Adresse eingeben..." style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;">
                            <div id="quick-booking-pickup-dropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #e5e7eb;border-radius:8px;max-height:200px;overflow-y:auto;z-index:1000;margin-top:5px;box-shadow:0 4px 12px rgba(0,0,0,0.1);"></div>
                        </div>
                        
                        <!-- ğŸ†• v5.36.0: SWAP-BUTTON -->
                        <div style="text-align:center;margin:15px 0;">
                            <button onclick="swapQuickBookingLocations()" style="
                                padding:10px 20px;
                                background:linear-gradient(135deg, #10b981 0%, #059669 100%);
                                color:white;
                                border:none;
                                border-radius:8px;
                                font-weight:600;
                                cursor:pointer;
                                font-size:14px;
                                box-shadow:0 2px 8px rgba(16, 185, 129, 0.3);
                                transition:transform 0.2s;
                            " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                â‡„ Vertauschen
                            </button>
                        </div>
                        
                        <!-- Zielort -->
                        <div style="position:relative;">
                            <label style="display:block;font-weight:600;margin-bottom:8px;">ğŸ¯ Zielort</label>
                            <input type="text" id="quick-booking-destination" placeholder="Adresse eingeben..." style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;">
                            <div id="quick-booking-destination-dropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #e5e7eb;border-radius:8px;max-height:200px;overflow-y:auto;z-index:1000;margin-top:5px;box-shadow:0 4px 12px rgba(0,0,0,0.1);"></div>
                        </div>
                        
                        <!-- ğŸ†• v5.38.4: FAVORITEN -->
                        <div style="margin-bottom:10px;">
                            <button onclick="showQuickBookingFavorites()" style="width:100%;padding:10px;background:#f3f4f6;color:#666;border:1px solid #e5e7eb;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;">
                                â­ Favoriten verwenden
                            </button>
                        </div>
                        
                        <!-- Personen -->
                        <div>
                            <label style="display:block;font-weight:600;margin-bottom:8px;">ğŸ‘¥ Anzahl Personen</label>
                            <select id="quick-booking-passengers" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;">
                                <option value="1">1 Person</option>
                                <option value="2">2 Personen</option>
                                <option value="3">3 Personen</option>
                                <option value="4">4 Personen</option>
                                <option value="5">5 Personen</option>
                                <option value="6">6 Personen</option>
                                <option value="7">7 Personen</option>
                                <option value="8">8 Personen</option>
                            </select>
                        </div>
                        
                        <!-- Fahrzeug (optional) -->
                        <div>
                            <label style="display:block;font-weight:600;margin-bottom:8px;">ğŸš— Fahrzeug (optional)</label>
                            <select id="quick-booking-vehicle" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;">
                                <option value="">Automatisch zuweisen</option>
                                <!-- Wird dynamisch gefÃ¼llt -->
                            </select>
                        </div>
                        
                        <!-- Notizen -->
                        <div>
                            <label style="display:block;font-weight:600;margin-bottom:8px;">ğŸ“ Notizen (optional)</label>
                            <textarea id="quick-booking-notes" placeholder="z.B. Rollstuhl, Kindersitz..." style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;min-height:60px;"></textarea>
                        </div>
                        
                        
                        <!-- Favorit speichern -->
                        <div style="margin-top:10px;">
                            <button onclick="saveQuickBookingAsFavorite()" style="width:100%;padding:10px;background:#fbbf24;color:#78350f;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;">
                                â­ Als Favorit speichern
                            </button>
                        </div>
                        
                        <!-- Buttons -->
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
                            <button onclick="document.getElementById('quick-booking-modal').remove()" style="padding:14px;background:#f3f4f6;color:#6b7280;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                                Abbrechen
                            </button>
                            <button onclick="submitQuickBooking()" style="padding:14px;background:linear-gradient(135deg, #10b981 0%, #059669 100%);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px;box-shadow:0 2px 8px rgba(16, 185, 129, 0.3);">
                                âš¡ Jetzt buchen
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ğŸ†• v5.38.4: Setup Autocomplete fÃ¼r Schnellbuchung
            setupQuickBookingAutocomplete();
            
            // ğŸ†• v5.38.4: Lade Fahrzeuge
            loadQuickBookingVehicles();
        }
        
        function loadQuickBookingCustomerData() {
            const customerId = document.getElementById('quick-booking-customer').value;
            if (!customerId) return;
            
            const customer = allCustomers.find(c => c.id === customerId);
            if (!customer) return;
            
            // Lade Kundendaten ins Formular
            if (customer.address) {
                document.getElementById('quick-booking-pickup').value = customer.address;
            }
            if (customer.favoriteDestination) {
                document.getElementById('quick-booking-destination').value = customer.favoriteDestination;
            }
        }
        
        // ğŸ†• v5.36.0: Vertausche Abholort und Zielort
        function swapQuickBookingLocations() {
            const pickupField = document.getElementById('quick-booking-pickup');
            const destinationField = document.getElementById('quick-booking-destination');
            
            if (!pickupField || !destinationField) return;
            
            // Werte tauschen
            const temp = pickupField.value;
            pickupField.value = destinationField.value;
            destinationField.value = temp;
            
            console.log('â‡„ Orte vertauscht!');
            console.log('  Abholort:', pickupField.value);
            console.log('  Zielort:', destinationField.value);
        }
        
        // ğŸ†• v5.38.4: AUTOCOMPLETE FÃœR SCHNELLBUCHUNG
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let quickBookingPickupCoords = null;
        let quickBookingDestCoords = null;
        let quickBookingAutocompleteTimeout = null;
        
        function setupQuickBookingAutocomplete() {
            ['quick-booking-pickup', 'quick-booking-destination'].forEach(fieldId => {
                const input = document.getElementById(fieldId);
                const dropdown = document.getElementById(fieldId + '-dropdown');
                
                if (!input || !dropdown) return;
                
                input.addEventListener('input', (e) => {
                    // Reset coords
                    if (fieldId === 'quick-booking-pickup') quickBookingPickupCoords = null;
                    else quickBookingDestCoords = null;
                    
                    clearTimeout(quickBookingAutocompleteTimeout);
                    const value = e.target.value.trim();
                    
                    if (value.length < 3) {
                        dropdown.style.display = 'none';
                        return;
                    }
                    
                    dropdown.innerHTML = '<div style="padding:10px;color:#999;">Suche...</div>';
                    dropdown.style.display = 'block';
                    
                    quickBookingAutocompleteTimeout = setTimeout(() => {
                        searchQuickBookingAddresses(value, fieldId);
                    }, 300);
                });
                
                // SchlieÃŸe Dropdown
                document.addEventListener('click', (e) => {
                    if (e.target !== input && !dropdown.contains(e.target)) {
                        dropdown.style.display = 'none';
                    }
                });
            });
        }
        
        async function searchQuickBookingAddresses(query, fieldId) {
            const dropdown = document.getElementById(fieldId + '-dropdown');
            
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?` +
                    `format=json&` +
                    `q=${encodeURIComponent(query)}&` +
                    `countrycodes=de&` +
                    `limit=8&` +
                    `addressdetails=1`
                );
                
                const results = await response.json();
                
                if (results.length === 0) {
                    dropdown.innerHTML = '<div style="padding:10px;color:#999;">Keine Ergebnisse</div>';
                    return;
                }
                
                // Filter Usedom-Ergebnisse
                const usedomResults = results.filter(r => {
                    const display = r.display_name.toLowerCase();
                    return display.includes('usedom') || 
                           display.includes('heringsdorf') || 
                           display.includes('ahlbeck') ||
                           display.includes('bansin') ||
                           display.includes('zinnowitz') ||
                           display.includes('karlshagen') ||
                           display.includes('peenemÃ¼nde') ||
                           display.includes('koserow') ||
                           display.includes('Ã¼ckeritz') ||
                           display.includes('loddin') ||
                           display.includes('zempin') ||
                           display.includes('trassenheide');
                });
                
                const resultsToShow = usedomResults.length > 0 ? usedomResults : results;
                
                dropdown.innerHTML = resultsToShow.map(r => {
                    const address = r.address;
                    const poiName = address.amenity || address.tourism || address.building || r.name;
                    
                    let displayText = '';
                    if (poiName) displayText += poiName + ', ';
                    if (address.road) displayText += address.road + ' ';
                    if (address.house_number) displayText += address.house_number + ', ';
                    if (address.village || address.town || address.city) {
                        displayText += (address.village || address.town || address.city);
                    }
                    
                    return `
                        <div class="autocomplete-item" onclick="selectQuickBookingAddress('${fieldId}', '${displayText.replace(/'/g, "\\'")}', ${r.lat}, ${r.lon})" style="
                            padding:12px;
                            cursor:pointer;
                            border-bottom:1px solid #f0f0f0;
                            transition:background 0.2s;
                        " onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                            <div style="font-weight:600;font-size:14px;">${displayText}</div>
                            <div style="font-size:11px;color:#999;">${r.display_name}</div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Autocomplete Fehler:', error);
                dropdown.innerHTML = '<div style="padding:10px;color:#ef4444;">Fehler bei der Suche</div>';
            }
        }
        
        function selectQuickBookingAddress(fieldId, address, lat, lon) {
            const input = document.getElementById(fieldId);
            const dropdown = document.getElementById(fieldId + '-dropdown');
            
            input.value = address;
            dropdown.style.display = 'none';
            
            // Speichere Koordinaten
            if (fieldId === 'quick-booking-pickup') {
                quickBookingPickupCoords = { lat, lon };
            } else {
                quickBookingDestCoords = { lat, lon };
            }
            
            console.log('ğŸ“ Adresse gewÃ¤hlt:', address, {lat, lon});
        }
        
        // ğŸ†• v5.38.4: FAHRZEUG-LISTE LADEN
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function loadQuickBookingVehicles() {
            const select = document.getElementById('quick-booking-vehicle');
            if (!select) return;
            
            if (isFirebaseReady) {
                db.ref('vehicles').once('value').then(snapshot => {
                    const vehicles = [];
                    snapshot.forEach(child => {
                        const v = child.val();
                        v.id = child.key;
                        vehicles.push(v);
                    });
                    
                    // Sortiere: Online zuerst
                    vehicles.sort((a, b) => {
                        if (a.isOnline && !b.isOnline) return -1;
                        if (!a.isOnline && b.isOnline) return 1;
                        return (a.name || '').localeCompare(b.name || '');
                    });
                    
                    // FÃ¼lle Dropdown
                    select.innerHTML = '<option value="">Automatisch zuweisen</option>' +
                        vehicles.map(v => {
                            const onlineText = v.isOnline ? 'ğŸŸ¢' : 'ğŸ”´';
                            return `<option value="${v.id}">${onlineText} ${v.name || v.id}</option>`;
                        }).join('');
                    
                    console.log('ğŸš— Fahrzeuge geladen:', vehicles.length);
                });
            }
        }
        
        // ğŸ†• v5.38.4: FAVORITEN SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function showQuickBookingFavorites() {
            const favorites = JSON.parse(localStorage.getItem('quickBookingFavorites') || '[]');
            
            if (favorites.length === 0) {
                alert('â„¹ï¸ Noch keine Favoriten gespeichert!\n\nFÃ¼lle Abholort und Zielort aus und klicke auf "Als Favorit speichern".');
                return;
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10001;padding:15px;';
            
            modal.innerHTML = `
                <div style="background:white;border-radius:16px;padding:20px;width:100%;max-width:500px;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h3 style="margin:0;font-size:18px;">â­ Favoriten</h3>
                        <button onclick="this.closest('div[style*=\"fixed\"]').remove()" style="background:none;border:none;font-size:28px;cursor:pointer;color:#999;line-height:1;">Ã—</button>
                    </div>
                    
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        ${favorites.map((fav, index) => `
                            <div style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:12px;">
                                <div style="font-size:13px;margin-bottom:8px;">
                                    <div><strong>ğŸ“ Von:</strong> ${fav.pickup}</div>
                                    <div><strong>ğŸ¯ Nach:</strong> ${fav.destination}</div>
                                </div>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;">
                                    <button onclick="useQuickBookingFavorite(${index})" style="padding:8px;background:#10b981;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;font-weight:600;">
                                        âœ… Verwenden
                                    </button>
                                    <button onclick="deleteQuickBookingFavorite(${index})" style="padding:8px;background:#ef4444;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;font-weight:600;">
                                        ğŸ—‘ï¸ LÃ¶schen
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <button onclick="this.closest('div[style*=\"fixed\"]').remove()" style="width:100%;margin-top:15px;padding:12px;background:#f3f4f6;color:#666;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                        SchlieÃŸen
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function useQuickBookingFavorite(index) {
            const favorites = JSON.parse(localStorage.getItem('quickBookingFavorites') || '[]');
            const fav = favorites[index];
            
            if (!fav) return;
            
            document.getElementById('quick-booking-pickup').value = fav.pickup;
            document.getElementById('quick-booking-destination').value = fav.destination;
            
            // Speichere Koordinaten falls vorhanden
            if (fav.pickupCoords) quickBookingPickupCoords = fav.pickupCoords;
            if (fav.destCoords) quickBookingDestCoords = fav.destCoords;
            
            // SchlieÃŸe Modal
            document.querySelectorAll('div[style*="z-index:10001"]').forEach(m => m.remove());
            
            console.log('â­ Favorit verwendet:', fav);
        }
        
        function deleteQuickBookingFavorite(index) {
            if (!confirm('Favorit wirklich lÃ¶schen?')) return;
            
            const favorites = JSON.parse(localStorage.getItem('quickBookingFavorites') || '[]');
            favorites.splice(index, 1);
            localStorage.setItem('quickBookingFavorites', JSON.stringify(favorites));
            
            // Refresh Modal
            document.querySelectorAll('div[style*="z-index:10001"]').forEach(m => m.remove());
            showQuickBookingFavorites();
        }
        
        function saveQuickBookingAsFavorite() {
            const pickup = document.getElementById('quick-booking-pickup').value.trim();
            const destination = document.getElementById('quick-booking-destination').value.trim();
            
            if (!pickup || !destination) {
                alert('âŒ Bitte Abholort und Zielort ausfÃ¼llen!');
                return;
            }
            
            const favorites = JSON.parse(localStorage.getItem('quickBookingFavorites') || '[]');
            
            // Check Duplikat
            const exists = favorites.some(f => f.pickup === pickup && f.destination === destination);
            if (exists) {
                alert('â„¹ï¸ Dieser Favorit existiert bereits!');
                return;
            }
            
            favorites.push({
                pickup,
                destination,
                pickupCoords: quickBookingPickupCoords,
                destCoords: quickBookingDestCoords,
                created: Date.now()
            });
            
            localStorage.setItem('quickBookingFavorites', JSON.stringify(favorites));
            alert('âœ… Als Favorit gespeichert!');
        }
        
        async function submitQuickBooking() {
            const customerId = document.getElementById('quick-booking-customer').value;
            const datetime = document.getElementById('quick-booking-datetime').value;
            const pickup = document.getElementById('quick-booking-pickup').value;
            const destination = document.getElementById('quick-booking-destination').value;
            const passengers = parseInt(document.getElementById('quick-booking-passengers').value);
            const vehicle = document.getElementById('quick-booking-vehicle').value;
            const notes = document.getElementById('quick-booking-notes').value;
            
            // Validierung
            if (!customerId) {
                alert('âŒ Bitte Kunde auswÃ¤hlen!');
                return;
            }
            if (!datetime) {
                alert('âŒ Bitte Datum & Zeit eingeben!');
                return;
            }
            if (!pickup) {
                alert('âŒ Bitte Abholort eingeben!');
                return;
            }
            if (!destination) {
                alert('âŒ Bitte Zielort eingeben!');
                return;
            }
            
            const customer = allCustomers.find(c => c.id === customerId);
            if (!customer) {
                alert('âŒ Kunde nicht gefunden!');
                return;
            }
            
            // Erstelle Fahrt
            const pickupTimestamp = new Date(datetime).getTime();
            
            const ride = {
                customerName: customer.name || 'Unbekannt',
                customerPhone: customer.phone || '',
                pickup: pickup,
                destination: destination,
                pickupTimestamp: pickupTimestamp,
                passengers: passengers,
                createdAt: Date.now(),
                status: 'vorbestellt',
                bookedBy: 'admin',
                notes: notes || '',
                customerId: customerId
            };
            
            // Fahrzeug zuweisen wenn ausgewÃ¤hlt
            if (vehicle) {
                ride.assignedTo = vehicle;
            }
            
            try {
                // Speichere in Firebase
                const rideRef = await db.ref('rides').push(ride);
                console.log('âœ… Schnellbuchung erstellt:', rideRef.key);
                
                // CRM aktualisieren
                await db.ref('customers/' + customerId).update({
                    lastRide: Date.now(),
                    totalRides: (customer.totalRides || 0) + 1
                });
                
                // SchlieÃŸe Modal
                document.getElementById('quick-booking-modal').remove();
                
                // Zeige Erfolg
                alert('âœ… Fahrt erfolgreich gebucht!\n\n' +
                      'ğŸ‘¤ ' + customer.name + '\n' +
                      'ğŸ“… ' + new Date(pickupTimestamp).toLocaleString('de-DE') + '\n' +
                      'ğŸ“ ' + pickup + '\n' +
                      'ğŸ¯ ' + destination);
                
                // Aktualisiere Views
                updateViews();
                
            } catch (error) {
                console.error('âŒ Fehler beim Buchen:', error);
                alert('âŒ Fehler beim Buchen: ' + error.message);
            }
        }
        
        function editCustomer(customerId) {
            const customer = allCustomers.find(c => c.id === customerId);
            if (!customer) return;
            
            const modal = document.createElement('div');
            modal.id = 'edit-customer-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;width:90%;max-width:400px;max-height:90vh;overflow-y:auto;">
                    <h3 style="margin:0 0 15px 0;">âœï¸ Kunde bearbeiten</h3>
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        <input type="text" id="edit-customer-name" value="${customer.name || ''}" placeholder="Name *" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;">
                        <input type="text" id="edit-customer-phone" value="${customer.phone || ''}" placeholder="Telefon" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;">
                        <input type="email" id="edit-customer-email" value="${customer.email || ''}" placeholder="Email" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;">
                        <div style="position:relative;">
                            <input type="text" id="edit-customer-address" value="${customer.address || ''}" placeholder="ğŸ  Wohnanschrift" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;width:100%;">
                            <div id="edit-customer-address-dropdown" style="position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #e0e0e0;border-radius:8px;max-height:200px;overflow-y:auto;display:none;z-index:10000;box-shadow:0 4px 6px rgba(0,0,0,0.1);"></div>
                        </div>
                        <textarea id="edit-customer-notes" placeholder="Notizen" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;min-height:60px;">${customer.notes || ''}</textarea>
                    </div>
                    <div style="font-size:12px;color:#666;margin-top:10px;padding:10px;background:#f9fafb;border-radius:6px;">
                        ğŸš• ${customer.totalRides || 0} Fahrten Â· ğŸ’° ${(customer.totalRevenue || 0).toFixed(2)}â‚¬
                    </div>
                    <div style="display:flex;gap:10px;margin-top:15px;">
                        <button onclick="updateCustomer('${customerId}')" style="flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">ğŸ’¾ Speichern</button>
                        <button onclick="closeEditCustomerModal()" style="flex:1;padding:12px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Abbrechen</button>
                    </div>
                    <button onclick="deleteCustomer('${customerId}')" style="width:100%;margin-top:10px;padding:12px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">ğŸ—‘ï¸ Kunde lÃ¶schen</button>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Autocomplete aktivieren nach Modal erscheint
            setTimeout(() => {
                setupCustomerAddressAutocomplete('edit-customer-address', 'edit-customer-address-dropdown');
            }, 100);
        }
        
        function closeEditCustomerModal() {
            const modal = document.getElementById('edit-customer-modal');
            if (modal) modal.remove();
        }
        
        async function updateCustomer(customerId) {
            const name = document.getElementById('edit-customer-name').value.trim();
            if (!name) {
                alert('âŒ Name ist erforderlich!');
                return;
            }
            
            const updates = {
                name: name,
                phone: document.getElementById('edit-customer-phone').value.trim(),
                email: document.getElementById('edit-customer-email').value.trim(),
                address: document.getElementById('edit-customer-address').value.trim(),
                notes: document.getElementById('edit-customer-notes').value.trim()
            };
            
            try {
                await db.ref('customers/' + customerId).update(updates);
                console.log('âœ… Kunde aktualisiert:', name);
                closeEditCustomerModal();
                loadAllCustomers();
                alert('âœ… Kunde aktualisiert!');
            } catch (error) {
                console.error('âŒ Fehler beim Aktualisieren:', error);
                alert('âŒ Fehler beim Aktualisieren');
            }
        }
        
        async function deleteCustomer(customerId) {
            if (!confirm('âš ï¸ Kunde wirklich lÃ¶schen?\n\nDiese Aktion kann nicht rÃ¼ckgÃ¤ngig gemacht werden!')) return;
            
            try {
                await db.ref('customers/' + customerId).remove();
                console.log('ğŸ—‘ï¸ Kunde gelÃ¶scht');
                closeEditCustomerModal();
                loadAllCustomers();
                alert('âœ… Kunde gelÃ¶scht!');
            } catch (error) {
                console.error('âŒ Fehler beim LÃ¶schen:', error);
                alert('âŒ Fehler beim LÃ¶schen');
            }
        }
        
        // ğŸ§¹ CACHE LEEREN FUNKTION
        async function clearAppCache() {
            if (!confirm('ğŸ§¹ Cache leeren?\n\nDies hilft bei Problemen mit alten Versionen.\nDie App wird neu geladen.')) return;
            
            try {
                // 1. Service Worker deregistrieren
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                        console.log('âœ… Service Worker deregistriert');
                    }
                }
                
                // 2. Cache Storage leeren
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    for (let name of cacheNames) {
                        await caches.delete(name);
                        console.log('âœ… Cache gelÃ¶scht:', name);
                    }
                }
                
                // 3. LocalStorage NICHT lÃ¶schen (Stammkunden-Daten behalten!)
                // localStorage.clear(); // NICHT ausfÃ¼hren!
                
                alert('âœ… Cache geleert!\n\nDie App wird jetzt neu geladen.');
                
                // 4. Hard Reload
                window.location.reload(true);
                
            } catch (error) {
                console.error('âŒ Fehler beim Cache leeren:', error);
                alert('âŒ Fehler beim Cache leeren!\n\nVersuche es manuell:\nEinstellungen â†’ Datenschutz â†’ Browserdaten lÃ¶schen');
            }
        }

        // ğŸ“‹ DEBUG LOGS EXPORTIEREN
        let consoleLogHistory = []; // Speichere alle Console-Logs
        
        // Console-Logs abfangen und speichern
        (function() {
            const originalLog = console.log;
            const originalError = console.error;
            const originalWarn = console.warn;
            
            console.log = function(...args) {
                consoleLogHistory.push({ type: 'log', time: new Date().toISOString(), message: args.join(' ') });
                originalLog.apply(console, args);
            };
            
            console.error = function(...args) {
                consoleLogHistory.push({ type: 'error', time: new Date().toISOString(), message: args.join(' ') });
                originalError.apply(console, args);
            };
            
            console.warn = function(...args) {
                consoleLogHistory.push({ type: 'warn', time: new Date().toISOString(), message: args.join(' ') });
                originalWarn.apply(console, args);
            };
        })();
        
        function exportDebugLogs() {
            try {
                // Sammle ALLE Debug-Infos
                const allRides = rides.map(r => ({
                    id: r.id,
                    status: r.status,
                    pickup: r.pickup,
                    destination: r.destination,
                    customerName: r.customerName,
                    price: r.price,
                    createdAt: r.createdAt
                }));
                
                const allDrivers = Object.keys(drivers).map(id => ({
                    id: id,
                    vehicle: drivers[id].vehicle,
                    online: drivers[id].online,
                    lat: drivers[id].lat,
                    lng: drivers[id].lng,
                    timestamp: drivers[id].timestamp
                }));
                
                const localStorageData = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    localStorageData[key] = localStorage.getItem(key);
                }
                
                const debugInfo = {
                    timestamp: new Date().toISOString(),
                    version: "4.2.1",
                    userAgent: navigator.userAgent,
                    
                    // App-Status
                    currentView: currentView,
                    isOnline: isOnline,
                    isFirebaseReady: isFirebaseReady,
                    currentUser: currentUser ? { uid: currentUser.uid, email: currentUser.email, name: currentUser.displayName } : null,
                    
                    // Daten
                    rides_count: rides.length,
                    all_rides: allRides,
                    drivers_count: Object.keys(drivers).length,
                    all_drivers: allDrivers,
                    localStorage_complete: localStorageData,
                    regularCustomer: regularCustomer,
                    
                    // GPS
                    pickupCoords: pickupCoords,
                    destCoords: destCoords,
                    watchId: watchId,
                    
                    // Wake Lock
                    wakeLock_active: wakeLock !== null,
                    
                    // Console Logs (letzte 100)
                    console_logs: consoleLogHistory.slice(-100)
                };
                
                // Formatiere als JSON fÃ¼r einfaches Kopieren
                const debugJSON = JSON.stringify(debugInfo, null, 2);
                
                // Formatiere auch als lesbaren Text
                const debugText = `
ğŸš• TAXI-APP MEGA DEBUG EXPORT
========================
Version: ${debugInfo.version}
Zeitpunkt: ${debugInfo.timestamp}

ğŸ“± GERÃ„T:
${debugInfo.userAgent}

ğŸ‘¤ USER:
- Angemeldet: ${debugInfo.currentUser ? 'Ja (' + debugInfo.currentUser.email + ')' : 'Nein'}
- Stammkunde: ${debugInfo.regularCustomer ? debugInfo.regularCustomer.name + ' (' + debugInfo.regularCustomer.rideCount + ' Fahrten)' : 'Nein'}

ğŸ“Š STATUS:
- Ansicht: ${debugInfo.currentView}
- Online: ${debugInfo.isOnline}
- Firebase: ${debugInfo.isFirebaseReady}
- Wake Lock: ${debugInfo.wakeLock_active ? 'Aktiv' : 'Inaktiv'}

ğŸ—ƒï¸ DATEN:
- Fahrten in Firebase: ${debugInfo.rides_count}
- Fahrer registriert: ${debugInfo.drivers_count}
- Fahrer online: ${allDrivers.filter(d => d.online).length}

ğŸš— ALLE FAHRER:
${allDrivers.map(d => `- ${d.vehicle} | Online: ${d.online} | GPS: ${d.lat ? 'Ja' : 'Nein'}`).join('\n') || '(keine)'}

ğŸš– LETZTE 10 FAHRTEN:
${allRides.slice(-10).map(r => `- #${r.id} | ${r.status} | ${r.pickup} â†’ ${r.destination} | ${r.price}â‚¬`).join('\n') || '(keine)'}

ğŸ“ CONSOLE LOGS (letzte 20):
${consoleLogHistory.slice(-20).map(l => `[${l.type.toUpperCase()}] ${l.time}: ${l.message}`).join('\n') || '(keine)'}

ğŸ’¾ LOCALSTORAGE KEYS:
${Object.keys(localStorageData).join(', ')}

========================

ğŸ“¦ KOMPLETTE DATEN ALS JSON:
Siehe unten fÃ¼r vollstÃ¤ndigen JSON-Export...

${debugJSON}
`;
                
                // Erstelle Blob fÃ¼r Download
                const blob = new Blob([debugText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `taxi-app-debug-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
                
                // Zeige Options-Dialog
                const choice = confirm(
                    'ğŸ“‹ DEBUG EXPORT\n\n' +
                    'WÃ¤hle eine Option:\n\n' +
                    '[OK] = In Zwischenablage kopieren\n' +
                    '[Abbrechen] = Als Datei herunterladen'
                );
                
                if (choice) {
                    // Kopiere in Zwischenablage
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(debugText).then(() => {
                            alert('âœ… Mega-Debug-Export kopiert!\n\nAlles ist in deiner Zwischenablage:\n- Console Logs\n- Alle Fahrten\n- Alle Fahrer\n- localStorage\n- etc.');
                        }).catch(err => {
                            prompt('ğŸ“‹ Debug-Export (Strg+C zum Kopieren):', debugText);
                        });
                    } else {
                        prompt('ğŸ“‹ Debug-Export (Strg+C zum Kopieren):', debugText);
                    }
                } else {
                    // Download als Datei
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    alert('âœ… Debug-Export heruntergeladen!\n\nSiehe Downloads-Ordner.');
                }
                
            } catch (error) {
                console.error('âŒ Fehler beim Exportieren:', error);
                alert('âŒ Fehler beim Exportieren der Logs!');
            }
        }
        
        // ğŸ› SUPER DEBUG EXPORT
        function exportSuperDebug() {
            try {
                const now = new Date().toISOString();
                
                // System Info
                const systemInfo = {
                    version: "4.7.1",
                    build: "20251123-0800",
                    timestamp: now,
                    userAgent: navigator.userAgent,
                    currentView: currentView,
                    isOnline: isOnline,
                    isFirebaseReady: isFirebaseReady,
                    currentUser: currentUser ? {
                        uid: currentUser.uid,
                        email: currentUser.email,
                        name: currentUser.displayName
                    } : null
                };
                
                // Erstelle Text-Export
                let debugText = `
=====================================
ğŸ› SUPER DEBUG EXPORT
=====================================
Version: ${systemInfo.version}
Build: ${systemInfo.build}
Zeit: ${systemInfo.timestamp}
User: ${systemInfo.currentUser?.email || 'Nicht eingeloggt'}

ğŸ“Š SYSTEM:
- Browser: ${systemInfo.userAgent}
- View: ${systemInfo.currentView}
- Online: ${systemInfo.isOnline}
- Firebase: ${systemInfo.isFirebaseReady}

ğŸ”´ FEHLER (${debugErrors.length}):
`;
                
                if (debugErrors.length === 0) {
                    debugText += 'âœ… Keine Fehler aufgetreten!\n';
                } else {
                    debugErrors.forEach((err, i) => {
                        debugText += `
[${i+1}] ${err.time}
Message: ${err.message}
File: ${err.filename}:${err.line}:${err.column}
Stack: ${err.stack}
---
`;
                    });
                }
                
                debugText += `
ğŸ“‹ CONSOLE LOGS (letzte ${Math.min(debugLogs.length, 100)}):
`;
                debugLogs.slice(-100).forEach(log => {
                    const icon = log.type === 'error' ? 'ğŸ”´' : log.type === 'warn' ? 'âš ï¸' : 'ğŸ“';
                    debugText += `[${log.time}] ${icon} ${log.message}\n`;
                });
                
                debugText += `
ğŸ” FIREBASE QUERIES (${debugFirebaseQueries.length}):
`;
                if (debugFirebaseQueries.length === 0) {
                    debugText += 'Keine Queries aufgezeichnet\n';
                } else {
                    debugFirebaseQueries.slice(-20).forEach(query => {
                        debugText += `[${query.time}] ${query.path}\n  â†’ ${query.result}\n`;
                    });
                }
                
                debugText += `
âš¡ STATE CHANGES (${debugStateChanges.length}):
`;
                if (debugStateChanges.length === 0) {
                    debugText += 'Keine State Changes aufgezeichnet\n';
                } else {
                    debugStateChanges.slice(-20).forEach(change => {
                        debugText += `[${change.time}] ${change.description}\n  ${change.oldValue} â†’ ${change.newValue}\n`;
                    });
                }
                
                debugText += `
ğŸ’¾ AKTUELLER STATE:
- Rides in Array: ${rides.length}
- Drivers online: ${Object.values(drivers).filter(d => d.online).length}
- Current Vehicle: ${currentVehicle || 'none'}
- Current Ride: ${myCurrentRide?.id || 'none'}
- Pickup Coords: ${pickupCoords ? 'Set' : 'None'}
- Dest Coords: ${destCoords ? 'Set' : 'None'}

ğŸ“¦ FAHRTEN (letzte 10):
`;
                rides.slice(-10).forEach(r => {
                    debugText += `#${r.id} | ${r.status} | ${r.customerName || 'N/A'} | ${r.pickup} â†’ ${r.destination}\n`;
                });
                
                debugText += `
=====================================
`;
                
                // Download als Datei
                const blob = new Blob([debugText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `super-debug-${now.slice(0,19).replace(/:/g,'-')}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert(
                    'ğŸ› Super Debug Export erstellt!\n\n' +
                    `ğŸ“Š ${debugErrors.length} Fehler\n` +
                    `ğŸ“‹ ${debugLogs.length} Console Logs\n` +
                    `ğŸ” ${debugFirebaseQueries.length} Firebase Queries\n` +
                    `âš¡ ${debugStateChanges.length} State Changes\n\n` +
                    'âœ… Datei heruntergeladen!\n' +
                    'Schicke mir diese Datei und ich kann ALLES sehen!'
                );
                
            } catch (error) {
                console.error('âŒ Fehler beim Super Debug Export:', error);
                alert('âŒ Fehler beim Export: ' + error.message);
            }
        }

        // SOUNDS
        // ğŸ”Š ALERT STATUS TRACKING
        let soundAvailable = false;
        let vibrationAvailable = false;
        
        function playDriverNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const beeps = [0, 0.25, 0.5, 0.75, 1.0, 1.25, 1.5, 1.75];
                
                beeps.forEach((time) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 1400;
                    oscillator.type = 'square';
                    
                    gainNode.gain.setValueAtTime(0.8, audioContext.currentTime + time);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + time + 0.15);
                    
                    oscillator.start(audioContext.currentTime + time);
                    oscillator.stop(audioContext.currentTime + time + 0.15);
                });
                
                soundAvailable = true;
                updateAlertStatus();
                return true;
            } catch (e) {
                console.error('Sound Fehler:', e);
                soundAvailable = false;
                updateAlertStatus();
                return false;
            }
        }
        
        // ğŸ§ª TEST FUNKTIONEN
        function testSound() {
            const success = playDriverNotificationSound();
            if (success) {
                setTimeout(() => alert('âœ… Sound funktioniert!'), 500);
            } else {
                alert('âŒ Sound blockiert!\n\nBitte in Browser-Einstellungen:\nSound erlauben');
            }
        }
        
        function testVibration() {
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 400, 100, 200]);
                vibrationAvailable = true;
                updateAlertStatus();
                setTimeout(() => alert('âœ… Vibration funktioniert!'), 500);
            } else {
                vibrationAvailable = false;
                updateAlertStatus();
                alert('âŒ Vibration nicht verfÃ¼gbar!\n\nGerÃ¤t unterstÃ¼tzt keine Vibration.');
            }
        }
        
        // ğŸ“Š UPDATE STATUS INDICATORS
        function updateAlertStatus() {
            const soundIcon = document.getElementById('sound-status');
            const vibrationIcon = document.getElementById('vibration-status');
            const alertsIndicator = document.getElementById('alerts-indicator');
            
            if (currentView === 'driver' && (currentVehicle || isOnline)) {
                alertsIndicator.style.display = 'flex';
                
                if (soundIcon) {
                    soundIcon.textContent = soundAvailable ? 'ğŸ”Š' : 'ğŸ”‡';
                    soundIcon.title = soundAvailable ? 'Sound: OK' : 'Sound: Inaktiv';
                }
                
                if (vibrationIcon) {
                    vibrationIcon.textContent = vibrationAvailable ? 'ğŸ“³' : 'ğŸ“µ';
                    vibrationIcon.title = vibrationAvailable ? 'Vibration: OK' : 'Vibration: Inaktiv';
                }
            } else {
                alertsIndicator.style.display = 'none';
            }
        }
        
        // ğŸ†• v5.20.8: STORNIERUNG-ALARM FÃœR FAHRER
        function showCancellationAlarm(ride) {
            if (!ride) return;
            
            console.log('ğŸš¨ Zeige Stornierung-Alarm fÃ¼r:', ride.id);
            
            // Vibration
            if (navigator.vibrate) {
                navigator.vibrate([500, 200, 500, 200, 500]); // SOS Pattern
            }
            
            // Sound
            playDriverNotificationSound();
            
            // ğŸš¨ FULLSCREEN STORNIERUNG-ALARM
            const overlay = document.createElement('div');
            overlay.id = 'cancellation-alarm-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(220, 38, 38, 0.95);
                z-index: 99999;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                padding: 20px;
                animation: pulseRed 0.5s ease-in-out infinite alternate;
            `;
            
            // Animation CSS hinzufÃ¼gen
            const style = document.createElement('style');
            style.textContent = `
                @keyframes pulseRed {
                    from { background: rgba(220, 38, 38, 0.9); }
                    to { background: rgba(185, 28, 28, 0.95); }
                }
            `;
            document.head.appendChild(style);
            
            overlay.innerHTML = `
                <div style="text-align: center; color: white; max-width: 400px;">
                    <div style="font-size: 80px; margin-bottom: 20px;">ğŸš«</div>
                    <div style="font-size: 28px; font-weight: bold; margin-bottom: 20px;">
                        FAHRT STORNIERT!
                    </div>
                    
                    <div style="
                        background: rgba(255,255,255,0.15);
                        padding: 20px;
                        border-radius: 12px;
                        margin-bottom: 25px;
                        text-align: left;
                    ">
                        ${ride.customerName ? `<div style="font-size: 18px; margin-bottom: 10px;">ğŸ‘¤ ${ride.customerName}</div>` : ''}
                        <div style="font-size: 14px; margin-bottom: 8px;">ğŸ“ Von: ${ride.pickup}</div>
                        <div style="font-size: 14px; margin-bottom: 8px;">ğŸ¯ Nach: ${ride.destination}</div>
                        <div style="font-size: 16px; font-weight: bold;">ğŸ’° ${ride.price}â‚¬</div>
                    </div>
                    
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 25px;">
                        Der Kunde hat die Fahrt storniert.
                    </div>
                    
                    <button onclick="closeCancellationAlarm()" style="
                        padding: 15px 40px;
                        background: white;
                        color: #dc2626;
                        border: none;
                        border-radius: 10px;
                        font-size: 18px;
                        font-weight: bold;
                        cursor: pointer;
                    ">
                        âœ“ Verstanden
                    </button>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Auch im AktivitÃ¤ts-Protokoll loggen
            logActivity('status', 'cancel_alert', `ğŸš¨ Stornierung-Alarm: ${ride.customerName || 'Kunde'}`, {
                customer: ride.customerName,
                from: ride.pickup,
                to: ride.destination,
                price: ride.price
            });
        }
        
        function closeCancellationAlarm() {
            const overlay = document.getElementById('cancellation-alarm-overlay');
            if (overlay) {
                overlay.remove();
            }
            // Aktualisiere stornierte Fahrten Liste
            loadCancelledRides();
            updateViews();
        }
        
        // ğŸš• FULLSCREEN POPUP FUNKTIONEN
        function showNewRideFullscreen() {
            if (!currentVehicle) return;
            
            // Zeige neue AuftrÃ¤ge die:
            // 1. Status 'new' haben UND (keine vehicleId ODER mir zugewiesen)
            // 2. ODER mir zugewiesen sind (assignedTo)
            const myRides = rides.filter(r => {
                const isNew = r.status === 'new';
                const isUnassigned = !r.vehicleId;
                const isAssignedToMe = r.assignedTo === currentVehicle;
                const isMyRide = r.vehicleId === currentVehicle || r.vehicle === (VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle);
                
                // ğŸ†• v5.26.14h: Nur zeigen wenn noch NICHT gezeigt!
                const notShownYet = !shownRidePopups.has(r.firebaseId || r.id);
                
                return (isNew && (isUnassigned || isMyRide || isAssignedToMe) && notShownYet);
            });
            
            if (myRides.length === 0) return;
            
            // Zeige ersten neuen Auftrag
            const ride = myRides[0];
            
            // ğŸ†• v5.26.14h: Merke dass wir diese Fahrt gezeigt haben!
            shownRidePopups.add(ride.firebaseId || ride.id);
            console.log('âœ… Zeige Popup fÃ¼r Fahrt:', ride.firebaseId || ride.id);
            
            const content = `
                <div style="background: #f3f4f6; padding: 12px; border-radius: 10px; margin-bottom: 12px;">
                    ${ride.customerName ? `
                    <div style="background: #dbeafe; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                        <div style="font-size: 16px; font-weight: 600; color: #1e3a8a;">
                            ğŸ‘¤ ${ride.customerName}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 8px;">
                        <span style="font-size: 11px; color: #666;">ğŸ“</span>
                        <span style="font-size: 14px; font-weight: 500;">${ride.pickup}</span>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <span style="font-size: 11px; color: #666;">ğŸ¯</span>
                        <span style="font-size: 14px; font-weight: 500;">${ride.destination}</span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                        <div>
                            <span style="font-size: 11px; color: #666;">â°</span>
                            <span style="font-size: 14px; font-weight: 600;">${ride.pickupTime || 'Sofort'}</span>
                        </div>
                        <div>
                            <span style="font-size: 14px; font-weight: 700; color: #10b981;">ğŸ’° ${ride.price}â‚¬</span>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button onclick="rejectRide('${ride.firebaseId || ride.id}')" style="
                        padding: 14px;
                        background: white;
                        color: #ef4444;
                        border: 2px solid #ef4444;
                        border-radius: 10px;
                        font-size: 14px;
                        font-weight: 700;
                        cursor: pointer;
                    ">
                        âŒ Nein
                    </button>
                    <button onclick="acceptRideFromFullscreen('${ride.firebaseId || ride.id}')" style="
                        padding: 14px;
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        font-size: 14px;
                        font-weight: 700;
                        cursor: pointer;
                    ">
                        âœ… Ja
                    </button>
                </div>
            `;
            
            document.getElementById('new-ride-fullscreen-content').innerHTML = content;
            document.getElementById('new-ride-fullscreen').style.display = 'block';
            
            // ğŸ“³ WIEDERKEHRENDE VIBRATION BIS REAKTION!
            startRepeatingVibration();
        }
        
        // ğŸ†• v5.26.14h: POPUP-DEDUPLIZIERUNG
        const shownRidePopups = new Set(); // Merke bereits gezeigte Fahrten
        
        // ğŸ“³ VIBRATIONS-SYSTEM
        let vibrationInterval = null;
        let vibrationCount = 0;
        
        function startRepeatingVibration() {
            // Stoppe alte Vibration falls vorhanden
            stopRepeatingVibration();
            
            vibrationCount = 0;
            
            // Sofort erste Vibration
            doVibration();
            
            // Wiederhole alle 3 Sekunden, maximal 10 Mal
            vibrationInterval = setInterval(() => {
                vibrationCount++;
                
                if (vibrationCount >= 10) {
                    stopRepeatingVibration();
                    return;
                }
                
                doVibration();
            }, 3000); // Alle 3 Sekunden
        }
        
        function doVibration() {
            if (navigator.vibrate) {
                // Kurz-Lang-Kurz-Lang-Kurz Pattern
                navigator.vibrate([200, 100, 400, 100, 200]);
            }
        }
        
        function stopRepeatingVibration() {
            if (vibrationInterval) {
                clearInterval(vibrationInterval);
                vibrationInterval = null;
            }
            vibrationCount = 0;
        }
        
        function closeNewRideFullscreen() {
            stopRepeatingVibration(); // Stoppe Vibration!
            document.getElementById('new-ride-fullscreen').style.display = 'none';
        }
        
        async function acceptRideFromFullscreen(rideId) {
            stopRepeatingVibration(); // Stoppe Vibration!
            closeNewRideFullscreen();
            // Nutze existierende acceptRide Funktion
            await acceptRide(rideId);
        }
        
        async function rejectRide(rideId) {
            if (!confirm('Auftrag wirklich ablehnen?\n\nDer Auftrag bleibt im System und kann anderen Fahrern zugewiesen werden.')) {
                return;
            }
            
            stopRepeatingVibration(); // Stoppe Vibration!
            
            try {
                const ride = rides.find(r => (r.firebaseId || r.id) === rideId);
                if (!ride) {
                    alert('âŒ Fahrt nicht gefunden!');
                    return;
                }
                
                // Update in Firebase
                const updates = {
                    status: 'rejected',
                    rejectedBy: currentVehicle,
                    rejectedAt: new Date().toISOString(),
                    rejectedByDriver: VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle
                };
                
                if (isFirebaseReady) {
                    await db.ref('rides/' + rideId).update(updates);
                    console.log('âŒ Auftrag abgelehnt:', rideId);
                }
                
                // Update lokal
                Object.assign(ride, updates);
                saveRides();
                
                closeNewRideFullscreen();
                updateViews();
                
                alert('âœ… Auftrag abgelehnt!\n\nDer Auftrag bleibt im System fÃ¼r andere Fahrer.');
                
            } catch (error) {
                console.error('âŒ Fehler beim Ablehnen:', error);
                alert('âŒ Fehler: ' + error.message);
            }
        }

        function playArrivalSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const beeps = [0, 0.15, 0.3];
                
                beeps.forEach((time) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime + time);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + time + 0.1);
                    
                    oscillator.start(audioContext.currentTime + time);
                    oscillator.stop(audioContext.currentTime + time + 0.1);
                });
            } catch (e) {
                console.error('Sound Fehler:', e);
            }
        }

        // HISTORY
        function saveToHistory(ride) {
            try {
                let history = JSON.parse(localStorage.getItem('ride-history') || '[]');
                
                if (!history.find(r => r.id === ride.id)) {
                    history.unshift({
                        id: ride.id,
                        customerName: ride.customerName,
                        pickup: ride.pickup,
                        destination: ride.destination,
                        pickupLat: ride.pickupCoords?.lat,
                        pickupLon: ride.pickupCoords?.lon,
                        destLat: ride.destCoords?.lat,
                        destLon: ride.destCoords?.lon,
                        vehicle: ride.vehicle,
                        price: ride.price,
                        distance: ride.distance,
                        time: ride.time,
                        completedAt: new Date().toLocaleString('de-DE')
                    });
                    
                    if (history.length > 50) history = history.slice(0, 50);
                    localStorage.setItem('ride-history', JSON.stringify(history));
                }
            } catch (e) {
                console.error('Fehler beim Speichern der Historie:', e);
            }
        }

        // ğŸ”„ ROUTE UMDREHEN
        function reverseRoute(pickup, destination, pickupLat, pickupLon, destLat, destLon) {
            // Tausche Abholort und Zielort
            document.getElementById('pickup').value = destination;
            document.getElementById('destination').value = pickup;
            
            // Tausche Koordinaten
            if (destLat && destLon) {
                pickupCoords = { lat: parseFloat(destLat), lon: parseFloat(destLon) };
            }
            if (pickupLat && pickupLon) {
                destCoords = { lat: parseFloat(pickupLat), lon: parseFloat(pickupLon) };
            }
            
            // Wechsle zur Fahrgast-Ansicht
            switchView('passenger');
            
            // Zeige BestÃ¤tigung
            const banner = document.createElement('div');
            banner.style.cssText = 'background:#667eea;color:white;padding:15px;border-radius:8px;margin-bottom:15px;text-align:center;';
            banner.innerHTML = 'ğŸ”„ <strong>Route wurde umgedreht!</strong><br><span style="font-size:13px;">ÃœberprÃ¼fe die Adressen und berechne den Preis.</span>';
            
            const bookingForm = document.getElementById('booking-form');
            bookingForm.insertBefore(banner, bookingForm.firstChild);
            setTimeout(() => banner.remove(), 4000);
        }

        // ğŸ“‹ NOCHMAL BUCHEN
        function bookAgain(pickup, destination, pickupLat, pickupLon, destLat, destLon) {
            // FÃ¼lle Felder aus
            document.getElementById('pickup').value = pickup;
            document.getElementById('destination').value = destination;
            
            // Setze Koordinaten
            if (pickupLat && pickupLon) {
                pickupCoords = { lat: parseFloat(pickupLat), lon: parseFloat(pickupLon) };
            }
            if (destLat && destLon) {
                destCoords = { lat: parseFloat(destLat), lon: parseFloat(destLon) };
            }
            
            // Wechsle zur Fahrgast-Ansicht
            switchView('passenger');
            
            // Zeige BestÃ¤tigung
            const banner = document.createElement('div');
            banner.style.cssText = 'background:#10b981;color:white;padding:15px;border-radius:8px;margin-bottom:15px;text-align:center;';
            banner.innerHTML = 'ğŸ“‹ <strong>Route wurde geladen!</strong><br><span style="font-size:13px;">ÃœberprÃ¼fe die Adressen und berechne den Preis.</span>';
            
            const bookingForm = document.getElementById('booking-form');
            bookingForm.insertBefore(banner, bookingForm.firstChild);
            setTimeout(() => banner.remove(), 4000);
        }

        // â­ ALS FAVORIT SPEICHERN
        function addToFavorites(pickup, destination, pickupLat, pickupLon, destLat, destLon) {
            try {
                let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
                
                // PrÃ¼fe ob bereits vorhanden
                const exists = favorites.some(f => 
                    f.pickup === pickup && f.destination === destination
                );
                
                if (exists) {
                    alert('â­ Diese Route ist bereits in deinen Favoriten!');
                    return;
                }
                
                // FÃ¼ge zu Favoriten hinzu
                favorites.push({
                    pickup: pickup,
                    destination: destination,
                    pickupLat: pickupLat,
                    pickupLon: pickupLon,
                    destLat: destLat,
                    destLon: destLon,
                    addedAt: Date.now()
                });
                
                localStorage.setItem('favorites', JSON.stringify(favorites));
                
                alert('â­ Favorit gespeichert!\n\nDiese Route findest du jetzt in deinen Favoriten.');
                
                console.log('â­ Favorit gespeichert:', { pickup, destination });
            } catch (e) {
                console.error('âŒ Fehler beim Speichern des Favoriten:', e);
                alert('âŒ Fehler beim Speichern');
            }
        }

        // ğŸ”— TRACKING-LINK KOPIEREN
        // ğŸ†• v5.30.4: Tracking-Link teilen (optional)
        function shareTrackingLink(link) {
            // Kopiere Link
            navigator.clipboard.writeText(link).then(() => {
                showNotification('âœ… Link kopiert! Du kannst ihn jetzt teilen.', 'success');
            }).catch(() => {
                // Fallback fÃ¼r Ã¤ltere Browser
                const input = document.createElement('input');
                input.value = link;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                showNotification('âœ… Link kopiert!', 'success');
            });
        }
        
        // ğŸ†• v5.32.4: Tracking-Link direkt Ã¶ffnen
        function openTrackingLink(link) {
            window.open(link, '_blank');
        }
        
        // ALTE FUNKTION (bleibt fÃ¼r RÃ¼ckwÃ¤rts-KompatibilitÃ¤t)
        function copyTrackingLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                alert('âœ… Link kopiert!\n\nDu kannst diesen Link speichern oder per WhatsApp teilen.');
            }).catch(() => {
                // Fallback fÃ¼r Ã¤ltere Browser
                const input = document.createElement('input');
                input.value = link;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                alert('âœ… Link kopiert!');
            });
        }
        
        async function closeRide() {
            // ğŸ†• Setze Fahrt auf "completed" in Firebase damit sie nicht wieder auftaucht!
            if (myCurrentRide && myCurrentRide.firebaseId && isFirebaseReady) {
                try {
                    await updateRide(myCurrentRide.firebaseId, {
                        status: 'completed',
                        completedAt: Date.now()
                    });
                    console.log('âœ… Fahrt auf completed gesetzt');
                } catch (error) {
                    console.error('âŒ Fehler beim SchlieÃŸen:', error);
                }
            }
            
            localStorage.removeItem('myCurrentRideId');
            myCurrentRide = null;
            document.getElementById('ride-status-container').innerHTML = '';
            document.getElementById('booking-form').style.display = 'block';
            
            // ğŸ†• FORMULAR KOMPLETT ZURÃœCKSETZEN
            resetBookingForm();
            
            document.getElementById('confirm').innerHTML = '<div class="alert-success">âœ“ Fahrt wurde in Ihrem Verlauf gespeichert</div>';
            setTimeout(() => document.getElementById('confirm').innerHTML = '', 3000);
        }
        
        function closeFutureRide(rideId) {
            // ğŸ†• v5.32.5n: ALLES lÃ¶schen - KOMPLETT wie Abbrechen!
            console.log('âœ… OK - LÃ¶sche ALLE Felder im Fahrgast-Bereich');
            
            // 1. Card schlieÃŸen
            localStorage.removeItem('myCurrentRideId');
            myCurrentRide = null;
            document.getElementById('ride-status-container').innerHTML = '';
            document.getElementById('booking-form').style.display = 'block';
            
            // 2. ALLE Eingabefelder leeren
            document.getElementById('customer-name').value = '';
            document.getElementById('customer-phone').value = '';
            document.getElementById('pickup').value = '';
            document.getElementById('destination').value = '';
            document.getElementById('passengers').value = '1';
            
            // 3. VORBESTELL-FELDER leeren
            document.getElementById('custom-date').value = '';
            document.getElementById('custom-hour').value = '00';
            document.getElementById('custom-minute').value = '00';
            
            // 4. Karte verstecken
            const routeMap = document.getElementById('route-map');
            if (routeMap) routeMap.style.display = 'none';
            
            // 5. Preis verstecken
            document.getElementById('price-display').innerHTML = '';
            
            // 6. Taxi buchen Button verstecken
            document.getElementById('book-btn').style.display = 'none';
            
            // 7. VerfÃ¼gbare Taxis verstecken
            document.getElementById('available-taxis-display').innerHTML = '';
            
            // 8. Button zurÃ¼ck zu "Preis berechnen"
            const priceBtn = document.getElementById('price-btn');
            priceBtn.innerHTML = 'ğŸ’° Preis berechnen';
            priceBtn.classList.remove('btn-danger');
            priceBtn.classList.add('btn-primary');
            
            // 9. Status zurÃ¼cksetzen
            priceCalculated = false;
            window.currentPrice = null;
            window.currentDistance = null;
            window.currentDuration = null;
            pickupCoords = null;
            destCoords = null;
            
            // 10. ZurÃ¼ck zu SOFORT-Modus
            selectRideType('sofort');
            
            // 11. Verlauf aktualisieren
            updateHistoryView();
            
            console.log('âœ… ALLES gelÃ¶scht - Fahrgast-Bereich komplett zurÃ¼ckgesetzt!');
        }

        function loadHistory() {
            try {
                const history = JSON.parse(localStorage.getItem('ride-history') || '[]');
                const container = document.getElementById('history-list');
                
                if (history.length === 0) {
                    container.innerHTML = '<div style="padding:40px 20px;text-align:center;color:#999;">Noch keine Fahrten</div>';
                    return;
                }
                
                container.innerHTML = history.map(r => `
                    <div class="ride-card">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <strong style="color:#667eea;">#${r.id}</strong>
                            <span style="background:#d1fae5;padding:4px 8px;border-radius:12px;font-size:12px;color:#065f46;">Abgeschlossen</span>
                        </div>
                        ${r.customerName ? `<div style="font-size:15px;font-weight:600;margin-bottom:8px;">ğŸ‘¤ ${r.customerName}</div>` : ''}
                        <div style="font-size:14px;color:#666;line-height:1.8;">
                            <strong>Von:</strong> ${r.pickup}<br>
                            <strong>Nach:</strong> ${r.destination}<br>
                            <strong>Fahrzeug:</strong> ${r.vehicle || 'Taxi'}<br>
                            <strong>Distanz:</strong> ${r.distance} km<br>
                            <strong>Preis:</strong> ${r.price}â‚¬<br>
                            <small style="opacity:0.7;">Abgeschlossen: ${r.completedAt || r.time}</small>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:15px;">
                            <button onclick="reverseRoute('${r.pickup.replace(/'/g, "\\'")}', '${r.destination.replace(/'/g, "\\'")}', ${r.pickupLat || 'null'}, ${r.pickupLon || 'null'}, ${r.destLat || 'null'}, ${r.destLon || 'null'})" 
                                style="padding:10px;border:2px solid #667eea;background:white;color:#667eea;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;">
                                ğŸ”„ Route umdrehen
                            </button>
                            <button onclick="bookAgain('${r.pickup.replace(/'/g, "\\'")}', '${r.destination.replace(/'/g, "\\'")}', ${r.pickupLat || 'null'}, ${r.pickupLon || 'null'}, ${r.destLat || 'null'}, ${r.destLon || 'null'})" 
                                style="padding:10px;border:2px solid #10b981;background:white;color:#10b981;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;">
                                ğŸ“‹ Nochmal buchen
                            </button>
                        </div>
                        <button onclick="addToFavorites('${r.pickup.replace(/'/g, "\\'")}', '${r.destination.replace(/'/g, "\\'")}', ${r.pickupLat || 'null'}, ${r.pickupLon || 'null'}, ${r.destLat || 'null'}, ${r.destLon || 'null'})" 
                            style="padding:10px;border:2px solid #f59e0b;background:white;color:#f59e0b;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;width:100%;margin-top:8px;">
                            â­ Als Favorit speichern
                        </button>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Fehler beim Laden der Historie:', e);
            }
        }

        // RIDE STATUS & TRACKING
        function showRideStatus(ride) {
            const container = document.getElementById('ride-status-container');
            
            // ğŸ“… CHECK: Ist die Fahrt in der Zukunft?
            const now = Date.now();
            // Fahrer-Zuweisung beginnt 30 Min vor Abholung
            const isFutureRide = ride.pickupTimestamp && ride.pickupTimestamp > now + (30 * 60000); // 30 Min Vorlauf
            
            // ğŸ†• VORBESTELLT: Zeige Status fÃ¼r Vorbestellungen
            if (ride.status === 'vorbestellt') {
                const pickupDate = new Date(ride.pickupTimestamp);
                const formattedDate = pickupDate.toLocaleDateString('de-DE', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                const formattedTime = pickupDate.toLocaleTimeString('de-DE', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                // ğŸ”— Tracking-Link erstellen
                const trackingLink = `${window.location.origin}${window.location.pathname}?ride=${ride.firebaseId}`;
                
                container.innerHTML = `
                    <div class="ride-status-box" style="background:#e0f2fe;border:2px solid #0ea5e9;">
                        <div style="font-size: 40px; margin-bottom: 8px;">ğŸ“…</div>
                        <h3 style="font-size: 18px; margin-bottom: 10px;">Vorbestellung bestÃ¤tigt!</h3>
                        <div style="margin-top: 12px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                            <div style="font-size: 16px; font-weight: 600; color: #0c4a6e; margin-bottom: 8px;">
                                ğŸ• ${formattedDate}<br>
                                um ${formattedTime} Uhr
                            </div>
                        </div>
                        <div style="margin-top: 12px; font-size: 13px; color: #0c4a6e;">
                            <strong>ğŸ“ Von:</strong> ${ride.pickup}<br>
                            <strong>ğŸ¯ Nach:</strong> ${ride.destination}<br>
                            <strong>ğŸ’° Preis:</strong> ${ride.price}â‚¬
                        </div>
                        
                        <div style="margin-top: 12px; padding: 10px; background: #dcfce7; border-radius: 6px; font-size: 12px; color: #14532d;">
                            âœ… 15 Minuten vor der Abholung wird ein Fahrer zugewiesen.
                        </div>
                        <div style="display:flex;gap:6px;margin-top:12px;">
                            <button onclick="closeFutureRide('${ride.firebaseId}')" style="flex:1;padding:10px;border:none;background:#10b981;color:white;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;">âœ“ OK</button>
                            <button onclick="shareTrackingLink('${trackingLink}')" style="flex:1;padding:10px;border:none;background:#3b82f6;color:white;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;">ğŸ”— Teilen</button>
                            <button onclick="cancelRideConfirm('${ride.firebaseId}')" style="flex:1;padding:10px;border:none;background:#ef4444;color:white;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;">âŒ</button>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Wenn Fahrt in der Zukunft und Status 'new', zeige Vormerkung
            if (ride.status === 'new' && isFutureRide) {
                const pickupDate = new Date(ride.pickupTimestamp);
                const formattedDate = pickupDate.toLocaleDateString('de-DE', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                const formattedTime = pickupDate.toLocaleTimeString('de-DE', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                container.innerHTML = `
                    <div class="ride-status-box" style="background:#e0f2fe;border:2px solid #0ea5e9;">
                        <div style="font-size: 40px; margin-bottom: 8px;">ğŸ“…</div>
                        <h3 style="font-size: 18px; margin-bottom: 10px;">Fahrt vorgemerkt!</h3>
                        <div style="margin-top: 12px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                            <div style="font-size: 16px; font-weight: 600; color: #0c4a6e; margin-bottom: 8px;">
                                ğŸ• ${formattedDate}<br>
                                um ${formattedTime} Uhr
                            </div>
                        </div>
                        <div style="margin-top: 12px; font-size: 13px; color: #0c4a6e;">
                            <strong>ğŸ“ Von:</strong> ${ride.pickup}<br>
                            <strong>ğŸ¯ Nach:</strong> ${ride.destination}<br>
                            <strong>ğŸ’° Preis:</strong> ${ride.price}â‚¬
                        </div>
                        <div style="margin-top: 12px; padding: 10px; background: #dcfce7; border-radius: 6px; font-size: 12px; color: #14532d;">
                            âœ… Du erhÃ¤ltst 30 Minuten vor der Abholung eine Benachrichtigung, wenn der Fahrer zugewiesen wurde.
                        </div>
                        <div style="display:flex;gap:6px;margin-top:12px;">
                            <button onclick="closeFutureRide('${ride.firebaseId}')" style="flex:1;padding:10px;border:none;background:#10b981;color:white;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;">âœ“ OK</button>
                            <button onclick="cancelRideConfirm('${ride.firebaseId}')" style="flex:1;padding:10px;border:none;background:#ef4444;color:white;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;">âŒ Stornieren</button>
                        </div>
                    </div>
                `;
                return;
            }
            
            if (ride.status === 'completed') {
                container.innerHTML = `
                    <div class="ride-status-box" style="background:#d1fae5;border:2px solid:#10b981;">
                        <div style="font-size: 40px; margin-bottom: 8px;">âœ…</div>
                        <h3 style="font-size: 18px; margin-bottom: 8px;">Fahrt abgeschlossen!</h3>
                        <p style="margin-top: 8px; font-size: 14px;">Vielen Dank fÃ¼r Ihre Fahrt</p>
                        <div style="margin-top: 12px; font-size: 13px; color: #065f46;">
                            <strong>Fahrzeug:</strong> ${ride.vehicle || 'Taxi'}${ride.vehiclePlate ? ` (ğŸš— ${ride.vehiclePlate})` : ''}<br>
                            <strong>Von:</strong> ${ride.pickup}<br>
                            <strong>Nach:</strong> ${ride.destination}<br>
                            <strong>Preis:</strong> ${ride.price}â‚¬
                        </div>
                        <button onclick="closeRide()" class="btn btn-primary" style="margin-top:15px;">âœ“ Neue Fahrt buchen</button>
                        <div style="margin-top:8px;font-size:11px;color:#666;">
                            (oder warte 5 Sekunden...)
                        </div>
                    </div>
                `;
                saveToHistory(ride);
                
                // ğŸ†• AUTO-CLOSE nach 5 Sekunden
                setTimeout(() => {
                    console.log('â±ï¸ Auto-Close nach 5 Sekunden');
                    closeRide();
                }, 5000);
                
                return;
            }
            
            if (ride.status === 'picked_up') {
                container.innerHTML = `
                    <div class="ride-status-box" style="background:#dcfce7;border:2px solid #10b981;">
                        <div style="font-size: 40px; margin-bottom: 8px;">ğŸš—</div>
                        <h3 style="font-size: 18px; margin-bottom: 8px;">Gute Fahrt!</h3>
                        <p style="margin-top: 8px; font-size: 14px; color: #047857;">
                            ${ride.vehicle || 'Ihr Taxi'}${ride.vehiclePlate ? ` (ğŸš— ${ride.vehiclePlate})` : ''} fÃ¤hrt Sie zu Ihrem Ziel
                        </p>
                        <div style="margin-top: 12px; font-size: 13px; color: #065f46;">
                            <strong>Von:</strong> ${ride.pickup}<br>
                            <strong>Nach:</strong> ${ride.destination}<br>
                            <strong>Distanz:</strong> ${ride.distance} km<br>
                            <strong>Preis:</strong> ${ride.price}â‚¬
                        </div>
                    </div>
                `;
                
                if (!window.lastPickedUpRide || window.lastPickedUpRide !== ride.id) {
                    playArrivalSound();
                    window.lastPickedUpRide = ride.id;
                }
                return;
            }
            
            if (ride.status === 'new' || ride.status === 'assigned') {
                // ğŸ”§ FIX: assigned Status genauso behandeln wie new - Fahrt wurde noch nicht akzeptiert!
                const statusText = ride.status === 'assigned' ? 'Wird vermittelt...' : 'Warte auf Fahrer...';
                const statusIcon = ride.status === 'assigned' ? 'ğŸ”„' : 'â³';
                
                // Formatiere Bestellzeit
                const createdTime = new Date(ride.createdAt || Date.now());
                const createdTimeStr = createdTime.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                
                // Formatiere Abholzeit
                let pickupTimeStr;
                const now = new Date();
                if (ride.pickupTimestamp) {
                    const pickupDate = new Date(ride.pickupTimestamp);
                    const isToday = pickupDate.toDateString() === now.toDateString();
                    
                    if (isToday) {
                        const time = pickupDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                        pickupTimeStr = `Heute ${time}`;
                    } else {
                        const date = pickupDate.toLocaleDateString('de-DE', { 
                            day: '2-digit', 
                            month: '2-digit',
                            year: '2-digit'
                        });
                        const time = pickupDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                        pickupTimeStr = `${date} ${time}`;
                    }
                } else {
                    pickupTimeStr = 'SOFORT';
                }
                
                // ğŸ”— Tracking-Link erstellen
                const trackingLink = `${window.location.origin}${window.location.pathname}?ride=${ride.firebaseId}`;
                
                container.innerHTML = `
                    <div class="ride-status-box" style="background:#fef3c7;border:2px solid #f59e0b;">
                        <div style="font-size: 40px; margin-bottom: 8px;">âœ…</div>
                        <h3 style="font-size: 18px; margin: 0 0 12px 0;">Fahrt bestellt!</h3>
                        
                        <div style="background:#fffbeb;padding:12px;border-radius:8px;margin-bottom:12px;text-align:left;">
                            <div style="font-size:13px;line-height:1.7;color:#92400e;">
                                <strong>ğŸ“ Von:</strong> ${ride.pickup}<br>
                                <strong>ğŸ¯ Nach:</strong> ${ride.destination}<br>
                                <strong>ğŸ• Bestellt:</strong> ${createdTimeStr} Uhr<br>
                                <strong>ğŸš• Abholung:</strong> ${pickupTimeStr}<br>
                                <strong>ğŸ’° Preis:</strong> ${ride.price}â‚¬
                            </div>
                        </div>
                        
                        <div style="font-size:28px;margin:12px 0;">${statusIcon}</div>
                        <p style="font-size:14px;color:#92400e;margin:8px 0;">${statusText}</p>
                        
                        <div style="display:flex;gap:6px;margin-top:12px;">
                            <button onclick="shareTrackingLink('${trackingLink}')" style="flex:1;padding:10px;border:none;background:#3b82f6;color:white;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;">ğŸ”— Teilen</button>
                            <button onclick="cancelRideConfirm('${ride.firebaseId}')" style="flex:1;padding:10px;border:none;background:#ef4444;color:white;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;">âŒ Stornieren</button>
                        </div>
                    </div>
                `;
            } else if (ride.status === 'accepted' && ride.driverLocation) {
                updateRideTracking(ride);
            } else if (ride.status === 'accepted' && !ride.driverLocation) {
                container.innerHTML = `
                    <div class="ride-status-box" style="background:#dbeafe;border:2px solid #3b82f6;">
                        <div style="font-size: 28px; margin-bottom: 6px;">âœ…</div>
                        <h3 style="font-size: 16px; margin: 6px 0;">${ride.vehicle || 'Fahrer'} hat angenommen!</h3>
                        <p style="margin-top: 6px; font-size: 13px;">Warte auf GPS-Position...</p>
                        <div style="margin-top: 10px; font-size: 12px;">
                            <strong>Fahrzeug:</strong> ${ride.vehicle}${ride.vehiclePlate ? ` (${ride.vehiclePlate})` : ''}<br>
                            <strong>Von:</strong> ${ride.pickup}<br>
                            <strong>Nach:</strong> ${ride.destination}<br>
                            <strong>Preis:</strong> ${ride.price}â‚¬
                        </div>
                        <div style="margin-top:12px;padding-top:10px;border-top:1px solid #e5e7eb;">
                            <button onclick="cancelRideConfirm('${ride.firebaseId}')" style="padding:5px 12px;border:1px solid #ef4444;background:white;color:#ef4444;border-radius:6px;cursor:pointer;font-size:11px;font-weight:500;">âš ï¸ Kostenpflichtig stornieren</button>
                        </div>
                    </div>
                `;
            }
        }

        async function updateRideTracking(ride) {
            const driverLoc = ride.driverLocation;
            
            // ğŸ›¡ï¸ PrÃ¼fe ob pickupCoords existiert
            if (!ride.pickupCoords || !ride.pickupCoords.lat || !ride.pickupCoords.lon) {
                console.warn('âš ï¸ Keine pickupCoords fÃ¼r Fahrt - zeige einfache Ansicht');
                const container = document.getElementById('ride-status-container');
                container.innerHTML = `
                    <div class="ride-status-box" style="background:#dbeafe;border:2px solid #3b82f6;">
                        <div style="font-size: 28px; margin-bottom: 6px;">ğŸš•</div>
                        <h3 style="font-size: 16px; margin: 6px 0;">${ride.vehicle || 'Fahrer'} ist unterwegs!</h3>
                        <p style="margin-top: 6px; font-size: 13px; color: #1e40af;">Der Fahrer kommt zu Ihnen.</p>
                        <div style="margin-top: 10px; font-size: 12px;">
                            <strong>Fahrzeug:</strong> ${ride.vehicle}${ride.vehiclePlate ? ` (${ride.vehiclePlate})` : ''}<br>
                            <strong>Von:</strong> ${ride.pickup}<br>
                            <strong>Nach:</strong> ${ride.destination}<br>
                            <strong>Preis:</strong> ${ride.price}â‚¬
                        </div>
                        <div style="margin-top:12px;padding-top:10px;border-top:1px solid #e5e7eb;">
                            <button onclick="cancelRideConfirm('${ride.firebaseId}')" style="padding:5px 12px;border:1px solid #ef4444;background:white;color:#ef4444;border-radius:6px;cursor:pointer;font-size:11px;font-weight:500;">âš ï¸ Kostenpflichtig stornieren</button>
                        </div>
                    </div>
                `;
                return;
            }
            
            const route = await calculateRoute(driverLoc, ride.pickupCoords);
            const distanceKm = route.distance;
            const durationMin = route.duration;
            
            const eta = new Date(Date.now() + durationMin * 60000);
            const etaTime = eta.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            
            let statusIcon = 'ğŸš•', statusText = ride.vehicle + ' ist unterwegs', statusClass = 'status-coming';
            let etaClass = 'green', progressColor = '#10b981', progress = 80;
            
            if (durationMin <= 2) {
                statusIcon = 'ğŸ¯';
                statusText = ride.vehicle + ' ist gleich da!';
                etaClass = 'green';
                progress = 95;
                if (lastSoundDistance > 2) {
                    playArrivalSound();
                    lastSoundDistance = durationMin;
                }
            } else if (durationMin <= 5) {
                etaClass = 'yellow';
                progressColor = '#f59e0b';
                progress = 60;
            } else {
                etaClass = 'red';
                progressColor = '#ef4444';
                progress = 30;
            }
            
            const container = document.getElementById('ride-status-container');
            
            // ğŸ†• PRÃœFE: Existiert die Karte schon? Dann nur Update!
            const existingMap = document.getElementById('passenger-tracking-map');
            if (existingMap && map) {
                // âœ… Karte existiert - nur Marker und Info aktualisieren
                console.log('ğŸ”„ Karte Update (Marker bewegen)');
                
                // Update Info-Box Elemente
                const statusBox = container.querySelector('.ride-status-box');
                if (statusBox) {
                    // Status Icon
                    const iconEl = statusBox.querySelector('div');
                    if (iconEl) iconEl.textContent = statusIcon;
                    
                    // Status Text
                    const h3El = statusBox.querySelector('h3');
                    if (h3El) h3El.textContent = statusText;
                    
                    // ETA Display
                    const etaEl = statusBox.querySelector('.eta-display');
                    if (etaEl) {
                        etaEl.innerHTML = `${distanceKm} km â€¢ ${durationMin} Min`;
                        etaEl.className = `eta-display ${etaClass}`;
                    }
                    
                    // Progress Bar
                    const progressEl = statusBox.querySelector('.progress-fill');
                    if (progressEl) {
                        progressEl.style.width = `${progress}%`;
                        progressEl.style.background = progressColor;
                    }
                }
                
                // Update Taxi-Marker Position
                if (taxiMarker) {
                    taxiMarker.setLatLng([driverLoc.lat, driverLoc.lon]);
                }
                
                // Update Route-Linie
                if (route.geometry && route.geometry.length > 0) {
                    const routeCoords = route.geometry.map(coord => [coord[1], coord[0]]);
                    if (window.passengerRouteLine) {
                        map.removeLayer(window.passengerRouteLine);
                    }
                    window.passengerRouteLine = L.polyline(routeCoords, {
                        color: '#3b82f6',
                        weight: 5,
                        opacity: 0.8
                    }).addTo(map);
                }
                
                return; // Fertig - keine neue Karte nÃ¶tig!
            }
            
            // ğŸ†• Karte existiert noch nicht - neu erstellen
            console.log('ğŸ—ºï¸ Erstelle neue Tracking-Karte');
            
            container.innerHTML = `
                <div class="ride-status-box ${statusClass}">
                    <div style="font-size: 28px; margin-bottom: 6px;">${statusIcon}</div>
                    <h3 style="font-size: 16px; margin: 6px 0;">${statusText}</h3>
                    <div class="eta-display ${etaClass}" style="font-size: 15px;">${distanceKm} km â€¢ ${durationMin} Min</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-bottom: 10px;">
                        Ankunft ca. ${etaTime} Uhr
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%; background: ${progressColor};"></div>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px;">
                        <strong>Fahrzeug:</strong> ${ride.vehicle}${ride.vehiclePlate ? ` (ğŸš— ${ride.vehiclePlate})` : ''}<br>
                        <strong>Von:</strong> ${ride.pickup}<br>
                        <strong>Nach:</strong> ${ride.destination}<br>
                        <strong>Preis:</strong> ${ride.price}â‚¬
                    </div>
                </div>
                <div id="passenger-tracking-map" style="width:100%;height:300px;margin-top:15px;border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,0.1);background:#e5e7eb;"></div>
                <div style="margin-top:12px;text-align:center;">
                    <button onclick="cancelRideConfirm('${ride.firebaseId}')" style="padding:5px 12px;border:1px solid #ef4444;background:white;color:#ef4444;border-radius:6px;cursor:pointer;font-size:11px;font-weight:500;">âš ï¸ Kostenpflichtig stornieren</button>
                </div>
            `;
            
            // ğŸ—ºï¸ Karte initialisieren mit try-catch
            try {
                const mapEl = document.getElementById('passenger-tracking-map');
                if (!mapEl) {
                    console.error('âŒ Map Element nicht gefunden!');
                    return;
                }
                
                // Alte Karte entfernen falls vorhanden
                if (map) {
                    map.remove();
                    map = null;
                }
                
                setTimeout(() => {
                    try {
                        map = L.map('passenger-tracking-map').setView([driverLoc.lat, driverLoc.lon], 14);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: 'Â© OpenStreetMap'
                        }).addTo(map);
                        
                        // Taxi Marker
                        taxiMarker = L.marker([driverLoc.lat, driverLoc.lon]).addTo(map)
                            .bindPopup('ğŸš• ' + ride.vehicle).openPopup();
                        
                        // Abholort Marker
                        pickupMarker = L.marker([ride.pickupCoords.lat, ride.pickupCoords.lon]).addTo(map)
                            .bindPopup('ğŸ“ ' + ride.pickup);
                        
                        // Route-Linie zeichnen
                        if (route.geometry && route.geometry.length > 0) {
                            const routeCoords = route.geometry.map(coord => [coord[1], coord[0]]);
                            window.passengerRouteLine = L.polyline(routeCoords, {
                                color: '#3b82f6',
                                weight: 5,
                                opacity: 0.8
                            }).addTo(map);
                        }
                        
                        // Zoom auf beide Punkte
                        const bounds = L.latLngBounds(
                            [driverLoc.lat, driverLoc.lon],
                            [ride.pickupCoords.lat, ride.pickupCoords.lon]
                        );
                        map.fitBounds(bounds, { padding: [50, 50] });
                        
                        console.log('âœ… Tracking-Karte initialisiert');
                    } catch (mapError) {
                        console.error('âŒ Karten-Fehler:', mapError);
                    }
                }, 200);
            } catch (error) {
                console.error('âŒ Map Setup Fehler:', error);
            }
        }

        // ==========================================
        // DRIVER MAP FUNCTIONS
        // ==========================================
        let driverMap = null;
        let driverMarker = null;
        let customerMarker = null;
        let routeLine = null;
        let driverMapUpdateInterval = null;

        async function initDriverMap(rideOrId) {
            // Kann entweder ride Objekt ODER rideId sein
            const rideId = (typeof rideOrId === 'string') ? rideOrId : (rideOrId.firebaseId || rideOrId.id);
            
            console.log('â„¹ï¸ Lade Fahrt-Info aus Firebase:', rideId);
            
            // LADE DIREKT AUS FIREBASE!
            const snapshot = await db.ref('rides/' + rideId).once('value');
            const ride = snapshot.val();
            
            if (!ride) {
                console.error('âŒ Fahrt nicht in Firebase gefunden!');
                alert('âŒ Fehler: Fahrt nicht gefunden!');
                return;
            }
            
            // FÃ¼ge firebaseId hinzu
            ride.firebaseId = rideId;
            
            console.log('âœ… Fahrt aus Firebase geladen:', ride);
            
            // ğŸ“‹ Update Info Box oben
            updateDriverInfoTop(ride);
            
            // Verstecke Ready-State, Zeige Info-Container
            document.getElementById('driver-ready').style.display = 'none';
            document.getElementById('driver-route-info').style.display = 'block';
            
            // âŒ KEINE KARTE! Nur Info-Anzeige
        }

        async function updateDriverRoute(ride) {
            const driver = drivers[currentVehicle];
            if (!driver || !driver.lat || !driver.lon || !driverMap) return;
            
            // FLEXIBEL: Navigation zum Abholort ODER zum Ziel!
            let targetCoords, targetLabel, routeTitle;
            if (ride.status === 'picked_up') {
                // Kunde ist drin â†’ Navigation zum ZIEL
                targetCoords = ride.destCoords;
                targetLabel = 'ğŸ¯ Ziel';
                routeTitle = 'ğŸ¯ Navigation zum Ziel';
            } else {
                // Fahrt angenommen â†’ Navigation zum ABHOLORT
                targetCoords = ride.pickupCoords;
                targetLabel = 'ğŸ“ Fahrgast';
                routeTitle = 'ğŸ“ Navigation zum Fahrgast';
            }
            
            // Update Titel
            document.getElementById('route-title').textContent = routeTitle;
            
            // Update Fahrer-Position
            if (driverMarker) {
                driverMarker.setLatLng([driver.lat, driver.lon]);
            }
            
            // Update Ziel-Marker
            if (customerMarker && ride.status === 'picked_up') {
                // Ã„ndere Marker zum Ziel
                customerMarker.setLatLng([targetCoords.lat, targetCoords.lon]);
                const destIcon = L.divIcon({
                    html: '<div style="background:#10b981;color:white;padding:8px 12px;border-radius:20px;font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,0.3);">ğŸ¯ Ziel</div>',
                    className: '',
                    iconSize: [100, 40]
                });
                customerMarker.setIcon(destIcon);
            }
            
            // Berechne Route
            const route = await calculateRoute(
                { lat: driver.lat, lon: driver.lon },
                { lat: targetCoords.lat, lon: targetCoords.lon }
            );
            
            // Update Info-Box
            document.getElementById('route-distance').textContent = route.distance;
            document.getElementById('route-duration').textContent = route.duration;
            
            const eta = new Date(Date.now() + route.duration * 60000);
            document.getElementById('route-eta').textContent = eta.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            
            // Hole detaillierte Route MIT TURN-BY-TURN ANWEISUNGEN!
            try {
                const response = await fetch(
                    `https://router.project-osrm.org/route/v1/driving/${driver.lon},${driver.lat};${targetCoords.lon},${targetCoords.lat}?overview=full&geometries=geojson&steps=true`
                );
                const data = await response.json();
                
                if (data.routes && data.routes.length > 0) {
                    const routeData = data.routes[0];
                    const coords = routeData.geometry.coordinates;
                    const latLngs = coords.map(c => [c[1], c[0]]);  // [lon,lat] â†’ [lat,lon]
                    
                    // Entferne alte Linie
                    if (routeLine) {
                        driverMap.removeLayer(routeLine);
                    }
                    
                    // Zeichne neue Route
                    routeLine = L.polyline(latLngs, {
                        color: '#667eea',
                        weight: 5,
                        opacity: 0.8
                    }).addTo(driverMap);
                    
                    // ğŸ¯ TURN-BY-TURN ANWEISUNGEN!
                    if (routeData.legs && routeData.legs[0].steps) {
                        const steps = routeData.legs[0].steps;
                        const currentStep = steps[0]; // NÃ¤chste Anweisung
                        
                        if (currentStep) {
                            updateTurnByTurnDisplay(currentStep);
                        }
                    }
                    
                    console.log('âœ… Route gezeichnet:', route.distance, 'km,', route.duration, 'min');
                }
            } catch (e) {
                console.error('âŒ Route-Fehler:', e);
            }
        }

        function updateTurnByTurnDisplay(step) {
            const maneuver = step.maneuver;
            const distance = step.distance;
            const name = step.name || 'StraÃŸe';
            
            // Berechne Distanz in Metern
            const distanceMeters = Math.round(distance);
            const distanceText = distanceMeters >= 1000 
                ? `${(distanceMeters / 1000).toFixed(1)} km` 
                : `${distanceMeters} m`;
            
            // Bestimme Icon und Text basierend auf ManÃ¶ver-Typ
            let icon = 'â†‘';
            let instruction = 'Geradeaus weiter';
            
            const type = maneuver.type;
            const modifier = maneuver.modifier;
            
            if (type === 'turn') {
                if (modifier === 'left') {
                    icon = 'â†';
                    instruction = 'LINKS abbiegen';
                } else if (modifier === 'right') {
                    icon = 'â†’';
                    instruction = 'RECHTS abbiegen';
                } else if (modifier === 'slight left') {
                    icon = 'â†–';
                    instruction = 'Leicht links';
                } else if (modifier === 'slight right') {
                    icon = 'â†—';
                    instruction = 'Leicht rechts';
                } else if (modifier === 'sharp left') {
                    icon = 'â¬…';
                    instruction = 'SCHARF LINKS';
                } else if (modifier === 'sharp right') {
                    icon = 'â¡';
                    instruction = 'SCHARF RECHTS';
                }
            } else if (type === 'depart') {
                icon = 'ğŸš—';
                instruction = 'Losfahren';
            } else if (type === 'arrive') {
                icon = 'ğŸ¯';
                instruction = 'ZIEL ERREICHT!';
            } else if (type === 'roundabout') {
                icon = 'â­•';
                instruction = 'Kreisverkehr';
                if (modifier === 'left') instruction += ' - 3. Ausfahrt';
                else if (modifier === 'right') instruction += ' - 1. Ausfahrt';
                else instruction += ' - 2. Ausfahrt';
            } else if (type === 'merge') {
                icon = 'â¤´';
                instruction = 'EinfÃ¤deln';
            } else if (type === 'continue') {
                icon = 'â†‘';
                instruction = 'Weiter geradeaus';
            }
            
            // Update UI
            document.getElementById('turn-icon').textContent = icon;
            document.getElementById('turn-distance').textContent = distanceText;
            document.getElementById('turn-instruction').textContent = instruction;
            document.getElementById('turn-street').textContent = `auf ${name}`;
            
            // FÃ¤rbe Box basierend auf Distanz
            const turnBox = document.getElementById('turn-by-turn');
            if (distanceMeters < 50) {
                turnBox.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'; // ROT - JETZT!
            } else if (distanceMeters < 200) {
                turnBox.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'; // ORANGE - Gleich!
            } else {
                turnBox.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'; // BLAU - Normal
            }
            
            console.log(`ğŸ§­ NÃ¤chste Anweisung: ${instruction} in ${distanceText} auf ${name}`);
        }

        function closeDriverMap() {
            console.log('ğŸ—ºï¸ SchlieÃŸe Fahrer-Karte');
            
            // Stoppe Updates
            if (driverMapUpdateInterval) {
                clearInterval(driverMapUpdateInterval);
                driverMapUpdateInterval = null;
            }
            
            // Entferne Karte
            if (driverMap) {
                driverMap.remove();
                driverMap = null;
                driverMarker = null;
                customerMarker = null;
                routeLine = null;
            }
            
            // Verstecke Container, Zeige Ready
            document.getElementById('driver-route-info').style.display = 'none';
            document.getElementById('driver-ready').style.display = 'block';
        }

        function openGoogleMapsNavigation(rideId, destination) {
            const ride = rides.find(r => r.firebaseId === rideId);
            if (!ride) {
                alert('âŒ Fahrt nicht gefunden!');
                return;
            }
            
            let targetLat, targetLon, targetName;
            
            if (destination === 'pickup') {
                // Navigation zum Kunden (Abholort)
                targetLat = ride.pickupCoords.lat;
                targetLon = ride.pickupCoords.lon;
                targetName = ride.pickup;
            } else {
                // Navigation zum Ziel
                targetLat = ride.destCoords.lat;
                targetLon = ride.destCoords.lon;
                targetName = ride.destination;
            }
            
            // Google Maps URL fÃ¼r Navigation
            // FÃ¼r Mobile: google.navigation:q=lat,lon
            // FÃ¼r Desktop/Fallback: https://www.google.com/maps/dir/?api=1&destination=lat,lon
            
            const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
            let mapsUrl;
            
            if (isMobile) {
                // Mobile: Ã–ffne Google Maps App direkt mit Navigation
                mapsUrl = `google.navigation:q=${targetLat},${targetLon}`;
                
                // Fallback fÃ¼r iOS oder wenn Google Maps nicht installiert
                setTimeout(() => {
                    window.location.href = `https://www.google.com/maps/dir/?api=1&destination=${targetLat},${targetLon}&travelmode=driving`;
                }, 500);
            } else {
                // Desktop: Ã–ffne Google Maps im Browser
                mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${targetLat},${targetLon}&travelmode=driving`;
            }
            
            console.log('ğŸ—ºï¸ Ã–ffne Google Maps Navigation zu:', targetName);
            console.log('ğŸ“ Koordinaten:', targetLat, targetLon);
            
            // Ã–ffne Maps
            window.open(mapsUrl, '_blank');
            
            // BestÃ¤tigungsmeldung
            alert(`âœ… Google Maps Navigation gestartet!\n\nZiel: ${targetName}\n\nğŸ’¡ Tipp: Die Navigation Ã¶ffnet sich in der Google Maps App.`);
        }

        // ğŸ” LOGIN SYSTEM FUNCTIONS
        
        function showLoginModal() {
            document.getElementById('register-modal').style.display = 'none';
            document.getElementById('login-modal').style.display = 'block';
            // Reset auf E-Mail Tab
            switchLoginTab('email');
        }
        
        function closeLoginModal() {
            document.getElementById('login-modal').style.display = 'none';
            resetPhoneLogin();
        }
        
        // ğŸ“± TELEFON-LOGIN SYSTEM
        let recaptchaVerifier = null;
        let confirmationResult = null;
        
        function switchLoginTab(tab) {
            const emailTab = document.getElementById('login-tab-email');
            const phoneTab = document.getElementById('login-tab-phone');
            const emailSection = document.getElementById('login-email-section');
            const phoneSection = document.getElementById('login-phone-section');
            
            if (tab === 'email') {
                emailTab.style.background = '#667eea';
                emailTab.style.color = 'white';
                phoneTab.style.background = '#f3f4f6';
                phoneTab.style.color = '#333';
                emailSection.style.display = 'block';
                phoneSection.style.display = 'none';
            } else {
                phoneTab.style.background = '#10b981';
                phoneTab.style.color = 'white';
                emailTab.style.background = '#f3f4f6';
                emailTab.style.color = '#333';
                emailSection.style.display = 'none';
                phoneSection.style.display = 'block';
                
                // reCAPTCHA initialisieren wenn noch nicht geschehen
                initRecaptcha();
            }
        }
        
        function initRecaptcha() {
            if (recaptchaVerifier) {
                console.log('âœ… reCAPTCHA bereits initialisiert');
                return;
            }
            
            if (!auth) {
                console.error('âŒ Firebase Auth nicht verfÃ¼gbar');
                return;
            }
            
            // Container prÃ¼fen - nutze den im Login-Modal
            const containerId = document.getElementById('login-recaptcha-container') ? 'login-recaptcha-container' : 'recaptcha-container';
            const container = document.getElementById(containerId);
            
            if (!container) {
                console.error('âŒ reCAPTCHA Container nicht gefunden:', containerId);
                return;
            }
            
            try {
                console.log('ğŸ”„ Initialisiere invisible reCAPTCHA...');
                
                // Container leeren (falls vorher was drin war)
                container.innerHTML = '';
                
                recaptchaVerifier = new firebase.auth.RecaptchaVerifier(containerId, {
                    'size': 'invisible',  // UNSICHTBAR - lÃ¤uft im Hintergrund!
                    'callback': (response) => {
                        console.log('âœ… reCAPTCHA automatisch gelÃ¶st:', response);
                    },
                    'expired-callback': () => {
                        console.log('âš ï¸ reCAPTCHA abgelaufen - neu initialisieren');
                        recaptchaVerifier = null;
                        setTimeout(() => initRecaptcha(), 500);
                    },
                    'error-callback': (error) => {
                        console.error('âŒ reCAPTCHA Error Callback:', error);
                        recaptchaVerifier = null;
                    }
                });
                
                // Render mit Error Handling
                recaptchaVerifier.render().then(widgetId => {
                    console.log('âœ… Invisible reCAPTCHA erfolgreich gerendert! Widget ID:', widgetId);
                }).catch(error => {
                    console.error('âŒ reCAPTCHA Render Fehler:', error);
                    recaptchaVerifier = null;
                    
                    // Retry nach 1 Sekunde
                    setTimeout(() => {
                        console.log('ğŸ”„ Versuche reCAPTCHA erneut...');
                        initRecaptcha();
                    }, 1000);
                });
                
            } catch (error) {
                console.error('âŒ reCAPTCHA Init Fehler:', error);
                recaptchaVerifier = null;
            }
        }
        
        async function sendPhoneCode() {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ“± SENDPHONECODE GESTARTET');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            const countryCode = document.getElementById('phone-country').value;
            const phoneNumber = document.getElementById('phone-number').value.trim().replace(/\s/g, '');
            
            console.log('ğŸ“ Telefonnummer:', countryCode, phoneNumber);
            
            if (!phoneNumber) {
                alert('âŒ Bitte Telefonnummer eingeben!');
                return;
            }
            
            // Formatiere Telefonnummer
            const fullPhoneNumber = countryCode + (phoneNumber.startsWith('0') ? phoneNumber.slice(1) : phoneNumber);
            console.log('ğŸ“ VollstÃ¤ndige Nummer:', fullPhoneNumber);
            
            if (!auth) {
                alert('âŒ Firebase Auth nicht verfÃ¼gbar');
                return;
            }
            
            // reCAPTCHA Check und Auto-Init
            if (!recaptchaVerifier) {
                console.log('âš ï¸ reCAPTCHA noch nicht bereit - initialisiere jetzt...');
                initRecaptcha();
                
                // Warte kurz bis reCAPTCHA bereit ist
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                if (!recaptchaVerifier) {
                    alert('âŒ reCAPTCHA konnte nicht geladen werden!\n\nBitte lade die Seite neu (F5) und versuche es erneut.');
                    return;
                }
            }
            
            const btn = document.getElementById('send-code-btn');
            btn.disabled = true;
            btn.textContent = 'â³ Sende SMS...';
            
            // âœ… ZEIGE CODE-EINGABE SOFORT! (nicht erst nach SMS-Erfolg)
            console.log('âœ… Zeige Code-Eingabefeld SOFORT...');
            const step1 = document.getElementById('phone-step-1');
            const step2 = document.getElementById('phone-step-2');
            
            if (!step1 || !step2) {
                console.error('âŒ FEHLER: phone-step-1 oder phone-step-2 nicht gefunden!');
                console.log('step1:', step1);
                console.log('step2:', step2);
                alert('âŒ Fehler: UI-Elemente nicht gefunden. Bitte Seite neu laden.');
                btn.disabled = false;
                btn.textContent = 'ğŸ“² SMS-Code senden';
                return;
            }
            
            step1.style.display = 'none';
            step2.style.display = 'block';
            document.getElementById('phone-display').textContent = fullPhoneNumber;
            console.log('âœ… Code-Eingabefeld ist jetzt SICHTBAR!');
            
            try {
                console.log('ğŸ“¤ Starte SMS-Versand via Firebase...');
                confirmationResult = await auth.signInWithPhoneNumber(fullPhoneNumber, recaptchaVerifier);
                console.log('âœ… SMS ERFOLGREICH GESENDET an:', fullPhoneNumber);
                console.log('âœ… confirmationResult:', confirmationResult);
                
                // Fokus auf Code-Eingabe + Auto-Fill vorbereiten
                const codeInput = document.getElementById('phone-code');
                codeInput.value = ''; // Leere Feld
                codeInput.focus();
                console.log('âœ… Fokus auf Code-Eingabefeld gesetzt');
                
                // ğŸ¯ WEB OTP API - Automatisches SMS AusfÃ¼llen!
                if ('OTPCredential' in window) {
                    console.log('âœ… Web OTP API verfÃ¼gbar - aktiviere Auto-Fill');
                    navigator.credentials.get({
                        otp: { transport: ['sms'] },
                        signal: AbortSignal.timeout(60000) // 60 Sekunden timeout
                    }).then(otp => {
                        if (otp && otp.code) {
                            console.log('ğŸ‰ SMS-Code automatisch empfangen:', otp.code);
                            codeInput.value = otp.code;
                            alert('âœ… Code automatisch empfangen: ' + otp.code + '\n\nBitte auf "Code bestÃ¤tigen" klicken.');
                        }
                    }).catch(err => {
                        console.log('âš ï¸ Web OTP Fehler:', err.message);
                    });
                } else {
                    console.log('â„¹ï¸ Web OTP API nicht unterstÃ¼tzt - manuelles Eingeben nÃ¶tig');
                }
                
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('âœ… SENDPHONECODE ERFOLGREICH ABGESCHLOSSEN');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
            } catch (error) {
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.error('âŒ SMS FEHLER!');
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.error('Error:', error);
                console.error('Error Code:', error.code);
                console.error('Error Message:', error.message);
                
                // Verstecke Code-Eingabe wieder bei Fehler
                step1.style.display = 'block';
                step2.style.display = 'none';
                
                btn.disabled = false;
                btn.textContent = 'ğŸ“² SMS-Code senden';
                
                if (error.code === 'auth/invalid-phone-number') {
                    alert('âŒ UngÃ¼ltige Telefonnummer!\n\nBitte im Format "170 1234567" eingeben.');
                } else if (error.code === 'auth/too-many-requests') {
                    alert('âŒ Zu viele Versuche!\n\nBitte warte einige Minuten.');
                } else if (error.code === 'auth/captcha-check-failed') {
                    alert('âŒ reCAPTCHA fehlgeschlagen!\n\nBitte lade die Seite neu.');
                    resetPhoneLogin();
                } else {
                    alert('âŒ Fehler beim SMS-Versand:\n\n' + error.message + '\n\nCode: ' + error.code + '\n\nBitte versuche es erneut oder lade die Seite neu.');
                }
                
                // reCAPTCHA zurÃ¼cksetzen
                if (recaptchaVerifier) {
                    try {
                        recaptchaVerifier.clear();
                    } catch (e) {}
                    recaptchaVerifier = null;
                }
                initRecaptcha();
            }
        }
        
        async function verifyPhoneCode() {
            const code = document.getElementById('phone-code').value.trim();
            
            if (!code || code.length !== 6) {
                alert('âŒ Bitte 6-stelligen Code eingeben!');
                return;
            }
            
            if (!confirmationResult) {
                alert('âŒ Keine SMS gesendet. Bitte neu starten.');
                resetPhoneLogin();
                return;
            }
            
            try {
                const result = await confirmationResult.confirm(code);
                console.log('âœ… Telefon-Login erfolgreich:', result.user.phoneNumber);
                
                // PrÃ¼fe ob User neu ist und Name braucht
                if (result.additionalUserInfo && result.additionalUserInfo.isNewUser) {
                    // Neuer User - frage nach Name
                    const name = prompt('Willkommen! Wie heiÃŸt du?');
                    if (name && result.user) {
                        await result.user.updateProfile({ displayName: name });
                        
                        // In Firebase speichern
                        if (isFirebaseReady) {
                            await db.ref('users/' + result.user.uid).update({
                                phone: result.user.phoneNumber,
                                displayName: name,
                                createdAt: Date.now()
                            });
                        }
                    }
                }
                
                closeLoginModal();
                alert('âœ… Erfolgreich angemeldet!\n\nğŸ“± ' + result.user.phoneNumber);
                
            } catch (error) {
                console.error('âŒ Code-Verifizierung Fehler:', error);
                
                if (error.code === 'auth/invalid-verification-code') {
                    alert('âŒ Falscher Code!\n\nBitte prÃ¼fe die SMS und versuche es erneut.');
                } else if (error.code === 'auth/code-expired') {
                    alert('âŒ Code abgelaufen!\n\nBitte fordere einen neuen Code an.');
                    resetPhoneLogin();
                } else {
                    alert('âŒ Fehler: ' + error.message);
                }
            }
        }
        
        function resetPhoneLogin() {
            // ZurÃ¼ck zu Schritt 1
            document.getElementById('phone-step-1').style.display = 'block';
            document.getElementById('phone-step-2').style.display = 'none';
            document.getElementById('phone-number').value = '';
            document.getElementById('phone-code').value = '';
            
            const btn = document.getElementById('send-code-btn');
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'ğŸ“² SMS-Code senden';
            }
            
            // reCAPTCHA zurÃ¼cksetzen
            if (recaptchaVerifier) {
                try {
                    recaptchaVerifier.clear();
                } catch (e) {}
                recaptchaVerifier = null;
            }
            confirmationResult = null;
            
            // Container leeren und neu initialisieren
            const container = document.getElementById('recaptcha-container');
            if (container) {
                container.innerHTML = '';
            }
        }
        
        function showRegisterModal() {
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('register-modal').style.display = 'block';
        }
        
        function closeRegisterModal() {
            document.getElementById('register-modal').style.display = 'none';
        }
        
        async function loginWithGoogle() {
            if (!auth) {
                // Versuche Firebase Auth nochmal zu initialisieren
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    auth = firebase.auth();
                } else {
                    alert('âŒ Firebase Auth ist nicht verfÃ¼gbar.\n\nBitte lade die Seite neu (Strg+F5) und versuche es nochmal.');
                    return;
                }
            }
            
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
                closeLoginModal();
            } catch (error) {
                console.error('Google Login Fehler:', error);
                if (error.code === 'auth/popup-blocked') {
                    alert('âŒ Popup wurde blockiert!\n\nBitte erlaube Popups fÃ¼r diese Seite.');
                } else {
                    alert('âŒ Google Login fehlgeschlagen: ' + error.message);
                }
            }
        }
        
        async function loginWithEmail() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                alert('Bitte E-Mail und Passwort eingeben');
                return;
            }
            
            if (!auth) {
                alert('Firebase Auth nicht verfÃ¼gbar');
                return;
            }
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                closeLoginModal();
            } catch (error) {
                console.error('Login Fehler:', error);
                alert('Login fehlgeschlagen: ' + error.message);
            }
        }
        
        async function registerWithEmail() {
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            if (!name || !email || !password) {
                alert('Bitte alle Felder ausfÃ¼llen');
                return;
            }
            
            if (!auth) {
                alert('Firebase Auth nicht verfÃ¼gbar');
                return;
            }
            
            try {
                const result = await auth.createUserWithEmailAndPassword(email, password);
                await result.user.updateProfile({ displayName: name });
                closeRegisterModal();
                alert('Registrierung erfolgreich! Willkommen, ' + name + '!');
            } catch (error) {
                console.error('Registrierung Fehler:', error);
                alert('Registrierung fehlgeschlagen: ' + error.message);
            }
        }
        
        async function logoutUser() {
            if (!auth || !currentUser) return;
            
            // ğŸ†• v5.20.3: Gespeicherten Online-Status lÃ¶schen bei Logout!
            if (currentUser.uid) {
                localStorage.setItem('lastOnlineStatus_' + currentUser.uid, 'false');
                console.log('ğŸ’¾ Online-Status auf FALSE gesetzt (Logout)');
            }
            
            // ğŸš— WICHTIG: Fahrzeug offline setzen VOR dem Logout!
            if (currentVehicle && isFirebaseReady && isOnline) {
                try {
                    const vehicleName = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle;
                    
                    // Fahrzeug offline setzen
                    await db.ref('drivers/' + currentVehicle).update({
                        online: false,
                        lastOffline: Date.now()
                    });
                    
                    // Log-Eintrag
                    const userContact = currentUser ? (currentUser.email || currentUser.phoneNumber || 'Unbekannt') : 'Unbekannt';
                    logActivity('driver', 'offline', 
                        `Fahrer ${userContact} (${vehicleName}) ist jetzt OFFLINE (Logout)`, {
                        vehicle: currentVehicle,
                        driver: vehicleName,
                        email: userContact
                    });
                    
                    console.log('ğŸ“´ Fahrzeug offline gesetzt vor Logout:', currentVehicle);
                    
                    // GPS stoppen
                    stopDriverTracking();
                    
                    // Stoppe auch Standby
                    if (standbyIntervalId) {
                        clearInterval(standbyIntervalId);
                        standbyIntervalId = null;
                    }
                    gpsMode = 'off';
                    
                    isOnline = false;
                    
                } catch (error) {
                    console.error('âŒ Fehler beim Offline-Setzen:', error);
                }
            }
            
            try {
                await auth.signOut();
                console.log('âœ… Logout erfolgreich');
            } catch (error) {
                console.error('âŒ Logout-Fehler:', error);
                alert('Logout fehlgeschlagen: ' + error.message);
            }
        }
        
        // ğŸ†• Stammkunden-Daten lÃ¶schen
        function clearRegularCustomer() {
            if (confirm('Stammkunden-Daten lÃ¶schen?\n\nDeine gespeicherten Daten (Name, Adresse, Fahrten-Anzahl) werden entfernt.')) {
                localStorage.removeItem('regularCustomer');
                updateUserProfile();
                console.log('ğŸ—‘ï¸ Stammkunden-Daten gelÃ¶scht');
            }
        }
        
        // ğŸ” ROLLEN-SYSTEM
        let userRole = 'fahrgast'; // Standard-Rolle
        
        async function getUserRole(user) {
            // Admin per Email
            if (user.email === 'funktaxi.pw@gmail.com') {
                return 'admin';
            }
            
            // PrÃ¼fe Firebase fÃ¼r zugewiesene Rollen
            if (isFirebaseReady) {
                try {
                    // Erst normale User-Tabelle prÃ¼fen
                    const snapshot = await db.ref('users/' + user.uid).once('value');
                    const userData = snapshot.val();
                    if (userData && userData.role) {
                        return userData.role;
                    }
                    
                    // Dann vorregistrierte Mitarbeiter prÃ¼fen
                    const emailKey = user.email.replace(/\./g, '_').replace(/@/g, '_at_');
                    const preRegSnapshot = await db.ref('preRegisteredUsers/' + emailKey).once('value');
                    const preRegData = preRegSnapshot.val();
                    if (preRegData && preRegData.role) {
                        // Ãœbertrage Daten zum echten User
                        await db.ref('users/' + user.uid).update({
                            role: preRegData.role,
                            vehicle: preRegData.vehicle || '',
                            phone: preRegData.phone || '',
                            preRegisteredAt: preRegData.createdAt
                        });
                        console.log('âœ… Vorregistrierten Mitarbeiter aktiviert:', user.email, 'â†’', preRegData.role);
                        return preRegData.role;
                    }
                } catch (error) {
                    console.error('âŒ Fehler beim Laden der Rolle:', error);
                }
            }
            
            return 'fahrgast'; // Standard
        }
        
        function applyRoleRestrictions(role) {
            console.log('ğŸ” Rolle anwenden:', role);
            userRole = role;
            
            const fahrgastBtn = document.getElementById('passenger-tab-btn');
            const verlaufBtn = document.getElementById('history-tab-btn');
            const fahrerBtn = document.getElementById('driver-tab-btn');
            const adminBtn = document.getElementById('admin-tab-btn');
            
            // Alle verstecken erstmal
            if (fahrgastBtn) fahrgastBtn.style.display = 'none';
            if (verlaufBtn) verlaufBtn.style.display = 'none';
            if (fahrerBtn) fahrerBtn.style.display = 'none';
            if (adminBtn) adminBtn.style.display = 'none';
            
            // Je nach Rolle anzeigen
            if (role === 'fahrgast') {
                // Fahrgast sieht: Fahrgast + Verlauf
                if (fahrgastBtn) fahrgastBtn.style.display = 'block';
                if (verlaufBtn) verlaufBtn.style.display = 'block'; // âœ… IMMER anzeigen!
                switchView('passenger');
            } else if (role === 'fahrer') {
                // Fahrer sieht: Fahrgast + Verlauf + Fahrer
                if (fahrgastBtn) fahrgastBtn.style.display = 'block';
                if (verlaufBtn) verlaufBtn.style.display = 'block';
                if (fahrerBtn) fahrerBtn.style.display = 'block';
                switchView('driver');
            } else if (role === 'admin') {
                // Admin sieht: ALLES
                if (fahrgastBtn) fahrgastBtn.style.display = 'block';
                if (verlaufBtn) verlaufBtn.style.display = 'block';
                if (fahrerBtn) fahrerBtn.style.display = 'block';
                if (adminBtn) adminBtn.style.display = 'block';
                
                // ğŸ†• Starte Checker fÃ¼r offene Fahrten (nur fÃ¼r Admin)
                startOpenRideChecker();
                
                // ğŸ†• Starte Vorbestellungs-Aktivierer (aktiviert 15 Min vor Abholung)
                startPrebookingActivator();
            } else {
                // ğŸ†• v5.26.14d: Nicht eingeloggt: Fahrgast + Verlauf BEIDE anzeigen!
                if (fahrgastBtn) fahrgastBtn.style.display = 'block';
                if (verlaufBtn) verlaufBtn.style.display = 'block'; // âœ… AUCH ohne Login!
                switchView('passenger');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.26.0: TELEFON-AUTHENTIFIZIERUNG
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let phoneConfirmationResult = null;
        let phoneRecaptchaVerifier = null;
        let phoneResendTimer = null;
        
        // PrÃ¼fe ob Fahrgast eingeloggt ist - zeige Login-Screen wenn nicht
        function checkPassengerAuth() {
            const user = firebase.auth().currentUser;
            const authScreen = document.getElementById('phone-auth-screen');
            
            // Wenn User Ã¼ber Firebase Auth eingeloggt ist â†’ verstecke Login-Screen
            if (user) {
                console.log('âœ… Firebase User eingeloggt:', user.phoneNumber || user.email);
                if (authScreen) authScreen.style.display = 'none';
                return true;
            }
            
        // ğŸ†• PrÃ¼fe ob "Quick Login" (bekannter Kunde ohne Firebase Auth)
            const quickLoginPhone = localStorage.getItem('loggedInPhone');
            if (quickLoginPhone) {
                console.log('âœ… Quick-Login aktiv:', quickLoginPhone);
                if (authScreen) authScreen.style.display = 'none';
                
                // Quick-Login Box anzeigen
                const quickBox = document.getElementById('quick-login-box');
                if (quickBox) {
                    quickBox.style.display = 'block';
                    document.getElementById('quick-login-phone').textContent = quickLoginPhone;
                }
                
                // âœ… FIX: Anmelden-Button verstecken wenn eingeloggt!
                const loginButton = document.querySelector('button[onclick="showLoginModal()"]');
                if (loginButton) {
                    loginButton.style.display = 'none';
                    console.log('âœ… Anmelden-Button ausgeblendet (User ist eingeloggt)');
                }
                
                // Telefon ins Formular Ã¼bernehmen falls leer
                const phoneField = document.getElementById('customer-phone');
                if (phoneField && !phoneField.value) phoneField.value = quickLoginPhone;
                
                const savedName = localStorage.getItem('loggedInUserName');
                const nameField = document.getElementById('customer-name');
                if (nameField && !nameField.value && savedName) nameField.value = savedName;
                
                return true;
            }
            
            // Kein User â†’ zeige Login-Screen nur fÃ¼r Fahrgast-Tab
            console.log('ğŸ”’ Kein User eingeloggt - zeige Login-Screen');
            
            // âœ… FIX: Anmelden-Button ANZEIGEN wenn nicht eingeloggt!
            const loginButton = document.querySelector('button[onclick="showLoginModal()"]');
            if (loginButton) {
                loginButton.style.display = 'inline-block';
                console.log('âœ… Anmelden-Button angezeigt (User nicht eingeloggt)');
            }
            
            if (authScreen && currentView === 'passenger') {
                authScreen.style.display = 'block';
                initAuthScreenRecaptcha();
            }
            return false;
        }
        
        // reCAPTCHA initialisieren fÃ¼r Auth-Screen (nÃ¶tig fÃ¼r Firebase Phone Auth)
        function initAuthScreenRecaptcha() {
            if (phoneRecaptchaVerifier) return;
            
            try {
                phoneRecaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                    'size': 'invisible',
                    'callback': (response) => {
                        console.log('âœ… Auth-Screen reCAPTCHA gelÃ¶st');
                    },
                    'expired-callback': () => {
                        console.log('âš ï¸ Auth-Screen reCAPTCHA abgelaufen');
                        phoneRecaptchaVerifier = null;
                    }
                });
                phoneRecaptchaVerifier.render();
                console.log('âœ… Auth-Screen reCAPTCHA initialisiert');
            } catch (error) {
                console.error('âŒ Auth-Screen reCAPTCHA Fehler:', error);
            }
        }
        
        // PrÃ¼fe ob Kunde schon registriert ist und logge ein oder starte SMS-Verifizierung
        async function checkAndLogin() {
            const countryCode = document.getElementById('phone-country-code').value;
            const phoneNumber = document.getElementById('phone-number-input').value.trim();
            const errorDiv = document.getElementById('phone-auth-error');
            const loginBtn = document.getElementById('check-login-btn');
            
            // Validierung
            if (!phoneNumber || phoneNumber.length < 6) {
                errorDiv.textContent = 'âŒ Bitte gÃ¼ltige Telefonnummer eingeben';
                errorDiv.style.display = 'block';
                return;
            }
            
            // FÃ¼hrende 0 entfernen
            const cleanNumber = phoneNumber.replace(/^0+/, '');
            const fullPhoneNumber = countryCode + cleanNumber;
            
            console.log('ğŸ” PrÃ¼fe Telefonnummer:', fullPhoneNumber);
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'â³ PrÃ¼fe...';
            errorDiv.style.display = 'none';
            
            try {
                // PrÃ¼fe in Firebase ob diese Telefonnummer schon registriert ist
                const usersSnapshot = await db.ref('users').orderByChild('phone').equalTo(fullPhoneNumber).once('value');
                const existingUser = usersSnapshot.val();
                
                if (existingUser) {
                    // âœ… BEKANNTER KUNDE - Direkt einloggen ohne SMS!
                    console.log('âœ… Bekannter Kunde gefunden!', existingUser);
                    
                    // Hole User-Daten
                    const userId = Object.keys(existingUser)[0];
                    const userData = existingUser[userId];
                    
                    // Speichere als "eingeloggt" (ohne echten Firebase Auth)
                    localStorage.setItem('loggedInPhone', fullPhoneNumber);
                    localStorage.setItem('loggedInUserId', userId);
                    localStorage.setItem('loggedInUserName', userData.displayName || '');
                    
                    // Login-Screen verstecken
                    document.getElementById('phone-auth-screen').style.display = 'none';
                    
                    // Telefon + Name ins Formular Ã¼bernehmen
                    const phoneField = document.getElementById('customer-phone');
                    if (phoneField) phoneField.value = fullPhoneNumber;
                    
                    const nameField = document.getElementById('customer-name');
                    if (nameField && userData.displayName) nameField.value = userData.displayName;
                    
                    // Log
                    logActivity('system', 'quick_login', `Schnell-Login: ${fullPhoneNumber}`, {
                        phone: fullPhoneNumber,
                        userId: userId,
                        name: userData.displayName || ''
                    });
                    
                    console.log('ğŸ‰ Schnell-Login erfolgreich!');
                    
                } else {
                    // ğŸ†• NEUER KUNDE - SMS-Verifizierung nÃ¶tig
                    console.log('ğŸ†• Neuer Kunde - starte SMS-Verifizierung');
                    
                    // Wechsel zur SMS-Verifizierung
                    loginBtn.textContent = 'ğŸ“¤ SMS wird gesendet...';
                    await sendVerificationCode();
                }
                
            } catch (error) {
                console.error('âŒ Login-Fehler:', error);
                
                // Bei Fehler: Fallback auf SMS-Verifizierung
                console.log('âš ï¸ Fallback auf SMS-Verifizierung');
                await sendVerificationCode();
            }
            
            loginBtn.disabled = false;
            loginBtn.textContent = 'ğŸ”“ Anmelden';
        }
        
        // SMS-Code anfordern
        async function sendVerificationCode() {
            const countryCode = document.getElementById('phone-country-code').value;
            const phoneNumber = document.getElementById('phone-number-input').value.trim();
            const errorDiv = document.getElementById('phone-auth-error');
            const sendBtn = document.getElementById('send-code-btn');
            
            // Validierung
            if (!phoneNumber || phoneNumber.length < 6) {
                errorDiv.textContent = 'âŒ Bitte gÃ¼ltige Telefonnummer eingeben';
                errorDiv.style.display = 'block';
                return;
            }
            
            // FÃ¼hrende 0 entfernen
            const cleanNumber = phoneNumber.replace(/^0+/, '');
            const fullPhoneNumber = countryCode + cleanNumber;
            
            console.log('ğŸ“± Sende Code an:', fullPhoneNumber);
            
            sendBtn.disabled = true;
            sendBtn.textContent = 'â³ Sende...';
            errorDiv.style.display = 'none';
            
            try {
                // reCAPTCHA neu initialisieren falls nÃ¶tig
                if (!phoneRecaptchaVerifier) {
                    initAuthScreenRecaptcha();
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                phoneConfirmationResult = await firebase.auth().signInWithPhoneNumber(
                    fullPhoneNumber, 
                    phoneRecaptchaVerifier
                );
                
                console.log('âœ… SMS gesendet!');
                
                // Wechsel zu Schritt 2
                document.getElementById('phone-step-1').style.display = 'none';
                document.getElementById('phone-step-2').style.display = 'block';
                document.getElementById('phone-sent-to').textContent = 'Code gesendet an ' + fullPhoneNumber;
                
                // Fokus auf erstes Code-Feld
                document.getElementById('code-1').focus();
                
                // Resend-Timer starten
                startResendTimer();
                
            } catch (error) {
                console.error('âŒ SMS Fehler:', error);
                
                let errorMessage = 'âŒ Fehler beim Senden der SMS';
                if (error.code === 'auth/invalid-phone-number') {
                    errorMessage = 'âŒ UngÃ¼ltige Telefonnummer';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'âŒ Zu viele Versuche. Bitte spÃ¤ter erneut versuchen.';
                } else if (error.code === 'auth/captcha-check-failed') {
                    errorMessage = 'âŒ SicherheitsprÃ¼fung fehlgeschlagen. Bitte neu laden.';
                    phoneRecaptchaVerifier = null;
                }
                
                errorDiv.textContent = errorMessage;
                errorDiv.style.display = 'block';
                
                sendBtn.disabled = false;
                sendBtn.textContent = 'ğŸ“¤ SMS-Code anfordern';
            }
        }
        
        // Code-Eingabe: automatisch zum nÃ¤chsten Feld
        function moveToNext(current, nextId) {
            if (current.value.length === 1) {
                const nextInput = document.getElementById(nextId);
                if (nextInput) nextInput.focus();
            }
        }
        
        // Automatisch verifizieren wenn alle 6 Ziffern eingegeben
        function verifyCodeAuto() {
            const code = getEnteredCode();
            if (code.length === 6) {
                verifyCode();
            }
        }
        
        // Eingegebenen Code auslesen
        function getEnteredCode() {
            let code = '';
            for (let i = 1; i <= 6; i++) {
                code += document.getElementById('code-' + i).value;
            }
            return code;
        }
        
        // Code verifizieren
        async function verifyCode() {
            const code = getEnteredCode();
            const errorDiv = document.getElementById('phone-auth-error');
            const verifyBtn = document.getElementById('verify-code-btn');
            
            if (code.length !== 6) {
                errorDiv.textContent = 'âŒ Bitte 6-stelligen Code eingeben';
                errorDiv.style.display = 'block';
                return;
            }
            
            verifyBtn.disabled = true;
            verifyBtn.textContent = 'â³ PrÃ¼fe...';
            errorDiv.style.display = 'none';
            
            try {
                const result = await phoneConfirmationResult.confirm(code);
                console.log('âœ… Telefon verifiziert!', result.user);
                
                // Login-Screen verstecken
                document.getElementById('phone-auth-screen').style.display = 'none';
                
                // Telefonnummer ins Formular Ã¼bernehmen
                const phoneField = document.getElementById('customer-phone');
                if (phoneField && result.user.phoneNumber) {
                    phoneField.value = result.user.phoneNumber;
                }
                
                // Erfolgs-Meldung
                alert('âœ… Erfolgreich angemeldet!\n\nDu kannst jetzt Taxis buchen.');
                
            } catch (error) {
                console.error('âŒ Code-Fehler:', error);
                
                let errorMessage = 'âŒ Falscher Code';
                if (error.code === 'auth/invalid-verification-code') {
                    errorMessage = 'âŒ Falscher Code. Bitte erneut versuchen.';
                } else if (error.code === 'auth/code-expired') {
                    errorMessage = 'âŒ Code abgelaufen. Bitte neuen Code anfordern.';
                }
                
                errorDiv.textContent = errorMessage;
                errorDiv.style.display = 'block';
                
                // Code-Felder leeren
                for (let i = 1; i <= 6; i++) {
                    document.getElementById('code-' + i).value = '';
                }
                document.getElementById('code-1').focus();
                
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'âœ… BestÃ¤tigen';
            }
        }
        
        // ZurÃ¼ck zu Schritt 1
        function goBackToPhone() {
            document.getElementById('phone-step-1').style.display = 'block';
            document.getElementById('phone-step-2').style.display = 'none';
            document.getElementById('phone-auth-error').style.display = 'none';
            document.getElementById('send-code-btn').disabled = false;
            document.getElementById('send-code-btn').textContent = 'ğŸ“¤ SMS-Code anfordern';
            
            // Code-Felder leeren
            for (let i = 1; i <= 6; i++) {
                document.getElementById('code-' + i).value = '';
            }
            
            // Timer stoppen
            if (phoneResendTimer) {
                clearInterval(phoneResendTimer);
            }
        }
        
        // Resend-Timer (60 Sekunden warten)
        function startResendTimer() {
            let seconds = 60;
            const timerDiv = document.getElementById('resend-timer');
            
            if (phoneResendTimer) clearInterval(phoneResendTimer);
            
            phoneResendTimer = setInterval(() => {
                seconds--;
                if (seconds > 0) {
                    timerDiv.textContent = `Neuen Code anfordern in ${seconds}s`;
                } else {
                    clearInterval(phoneResendTimer);
                    timerDiv.innerHTML = '<button onclick="goBackToPhone()" style="background:none;border:none;color:#667eea;cursor:pointer;text-decoration:underline;">ğŸ“¤ Neuen Code anfordern</button>';
                }
            }, 1000);
        }
        
        // ğŸ†• v5.26.12: Quick-Login Profil bearbeiten
        function showQuickLoginProfile() {
            console.log('âœï¸ Ã–ffne Quick-Login Profil...');
            
            // Lade gespeicherte Daten
            const phone = localStorage.getItem('loggedInPhone') || '';
            const name = localStorage.getItem('loggedInUserName') || '';
            const address = localStorage.getItem('loggedInUserAddress') || '';
            const billingName = localStorage.getItem('loggedInBillingName') || '';
            const billingStreet = localStorage.getItem('loggedInBillingStreet') || '';
            const billingZip = localStorage.getItem('loggedInBillingZip') || '';
            const billingCity = localStorage.getItem('loggedInBillingCity') || '';
            
            // Erstelle Modal
            const modal = document.createElement('div');
            modal.id = 'quick-login-profile-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;width:100%;max-width:400px;max-height:90vh;overflow-y:auto;">
                    <h3 style="margin:0 0 15px 0;">âœï¸ Meine Daten bearbeiten</h3>
                    
                    <div style="display:flex;flex-direction:column;gap:12px;">
                        <!-- Name -->
                        <div>
                            <label style="display:block;font-size:12px;color:#666;margin-bottom:4px;font-weight:600;">ğŸ‘¤ Name</label>
                            <input type="text" id="quick-profile-name" value="${name}" placeholder="Max Mustermann" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;box-sizing:border-box;font-size:14px;">
                        </div>
                        
                        <!-- Telefon (nicht editierbar) -->
                        <div>
                            <label style="display:block;font-size:12px;color:#666;margin-bottom:4px;font-weight:600;">ğŸ“± Telefonnummer</label>
                            <input type="tel" value="${phone}" disabled style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;background:#f3f4f6;color:#666;box-sizing:border-box;font-size:14px;">
                            <div style="font-size:11px;color:#999;margin-top:4px;">Telefonnummer kann nicht geÃ¤ndert werden</div>
                        </div>
                        
                        <!-- Abholadresse -->
                        <div>
                            <label style="display:block;font-size:12px;color:#666;margin-bottom:4px;font-weight:600;">ğŸ“ Standard-Abholadresse</label>
                            <input type="text" id="quick-profile-address" value="${address}" placeholder="z.B. Bahnhof Heringsdorf" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;box-sizing:border-box;font-size:14px;">
                            <div style="font-size:11px;color:#999;margin-top:4px;">Wird automatisch als Abholort verwendet</div>
                        </div>
                        
                        <!-- Rechnungsadresse Header -->
                        <div style="margin-top:10px;padding-top:15px;border-top:1px solid #e5e7eb;">
                            <div style="font-size:13px;font-weight:600;color:#374151;margin-bottom:8px;">ğŸ§¾ Rechnungsadresse (optional)</div>
                        </div>
                        
                        <!-- Rechnungsname -->
                        <div>
                            <label style="display:block;font-size:12px;color:#666;margin-bottom:4px;font-weight:600;">Name / Firma</label>
                            <input type="text" id="quick-profile-billing-name" value="${billingName}" placeholder="Max Mustermann oder Firma GmbH" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;box-sizing:border-box;font-size:14px;">
                        </div>
                        
                        <!-- RechnungsstraÃŸe -->
                        <div>
                            <label style="display:block;font-size:12px;color:#666;margin-bottom:4px;font-weight:600;">StraÃŸe + Hausnummer</label>
                            <input type="text" id="quick-profile-billing-street" value="${billingStreet}" placeholder="MusterstraÃŸe 123" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;box-sizing:border-box;font-size:14px;">
                        </div>
                        
                        <!-- PLZ + Ort -->
                        <div style="display:flex;gap:10px;">
                            <div style="width:100px;">
                                <label style="display:block;font-size:12px;color:#666;margin-bottom:4px;font-weight:600;">PLZ</label>
                                <input type="text" id="quick-profile-billing-zip" value="${billingZip}" placeholder="17424" maxlength="5" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;box-sizing:border-box;font-size:14px;">
                            </div>
                            <div style="flex:1;">
                                <label style="display:block;font-size:12px;color:#666;margin-bottom:4px;font-weight:600;">Ort</label>
                                <input type="text" id="quick-profile-billing-city" value="${billingCity}" placeholder="Heringsdorf" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;box-sizing:border-box;font-size:14px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Buttons -->
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button onclick="closeQuickProfileModal()" style="flex:1;padding:12px;background:#e5e7eb;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                            âŒ Abbrechen
                        </button>
                        <button onclick="saveQuickLoginProfile()" style="flex:1;padding:12px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">
                            ğŸ’¾ Speichern
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Fokus auf Name-Feld
            setTimeout(() => {
                document.getElementById('quick-profile-name')?.focus();
            }, 100);
        }
        
        function closeQuickProfileModal() {
            const modal = document.getElementById('quick-login-profile-modal');
            if (modal) modal.remove();
        }
        
        function saveQuickLoginProfile() {
            console.log('ğŸ’¾ Speichere Quick-Login Profil...');
            
            // Lese Daten aus Formular
            const name = document.getElementById('quick-profile-name')?.value.trim() || '';
            const address = document.getElementById('quick-profile-address')?.value.trim() || '';
            const billingName = document.getElementById('quick-profile-billing-name')?.value.trim() || '';
            const billingStreet = document.getElementById('quick-profile-billing-street')?.value.trim() || '';
            const billingZip = document.getElementById('quick-profile-billing-zip')?.value.trim() || '';
            const billingCity = document.getElementById('quick-profile-billing-city')?.value.trim() || '';
            
            // Validierung
            if (!name) {
                alert('âŒ Bitte Name eingeben!');
                return;
            }
            
            // Speichere in localStorage
            localStorage.setItem('loggedInUserName', name);
            if (address) localStorage.setItem('loggedInUserAddress', address);
            if (billingName) localStorage.setItem('loggedInBillingName', billingName);
            if (billingStreet) localStorage.setItem('loggedInBillingStreet', billingStreet);
            if (billingZip) localStorage.setItem('loggedInBillingZip', billingZip);
            if (billingCity) localStorage.setItem('loggedInBillingCity', billingCity);
            
            console.log('âœ… Profil gespeichert:', { name, address, billingName, billingStreet, billingZip, billingCity });
            
            // SchlieÃŸe Modal
            closeQuickProfileModal();
            
            // Zeige Erfolg
            alert('âœ… Profil gespeichert!\n\nğŸ‘¤ ' + name + (address ? '\nğŸ“ ' + address : ''));
            
            // Aktualisiere Formularfelder falls leer
            const nameField = document.getElementById('customer-name');
            if (nameField && !nameField.value) nameField.value = name;
            
            const addressField = document.getElementById('pickup-location');
            if (addressField && !addressField.value && address) addressField.value = address;
        }
        
        // ğŸ†• Quick-Login Logout
        function logoutQuickLogin() {
            if (!confirm('Wirklich abmelden?')) return;
            
            // Quick-Login Daten lÃ¶schen
            localStorage.removeItem('loggedInPhone');
            localStorage.removeItem('loggedInUserId');
            localStorage.removeItem('loggedInUserName');
            
            // Quick-Login Box verstecken
            const quickBox = document.getElementById('quick-login-box');
            if (quickBox) quickBox.style.display = 'none';
            
            // âœ… FIX: Anmelden-Button wieder ANZEIGEN nach Logout!
            const loginButton = document.querySelector('button[onclick="showLoginModal()"]');
            if (loginButton) {
                loginButton.style.display = 'inline-block';
                console.log('âœ… Anmelden-Button wieder angezeigt nach Logout');
            }
            
            // Formular leeren
            const phoneField = document.getElementById('customer-phone');
            if (phoneField) phoneField.value = '';
            const nameField = document.getElementById('customer-name');
            if (nameField) nameField.value = '';
            
            // Login-Screen zeigen
            checkPassengerAuth();
            
            console.log('ğŸšª Quick-Login abgemeldet');
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function onUserLoggedIn(user) {
            console.log('ğŸ‘¤ User eingeloggt:', user.email || user.phoneNumber);
            currentUser = user;
            
            // ğŸ†• v5.26.0: Login-Screen verstecken
            const authScreen = document.getElementById('phone-auth-screen');
            if (authScreen) authScreen.style.display = 'none';
            
            // ğŸ§¹ CLEANUP: Alte Fahrzeuge dieses Users offline setzen
            if (isFirebaseReady) {
                try {
                    const driversSnapshot = await db.ref('drivers').once('value');
                    const driversData = driversSnapshot.val() || {};
                    
                    for (const vehicleId in driversData) {
                        const driver = driversData[vehicleId];
                        // PrÃ¼fe ob dieses Fahrzeug dem aktuellen User gehÃ¶rt
                        if (driver && driver.online && 
                            (driver.userId === user.uid || driver.userEmail === (user.email || user.phoneNumber))) {
                            
                            console.log('ğŸ§¹ Altes Fahrzeug gefunden:', vehicleId, '- setze offline');
                            await db.ref('drivers/' + vehicleId).update({
                                online: false,
                                lastOffline: Date.now()
                            });
                            
                            const vehicleName = VEHICLES[vehicleId] ? VEHICLES[vehicleId].name : vehicleId;
                            const userContact = user.email || user.phoneNumber || 'Unbekannt';
                            logActivity('driver', 'offline', 
                                `Fahrer ${userContact} (${vehicleName}) ist jetzt OFFLINE (Neuer Login)`, {
                                vehicle: vehicleId,
                                driver: vehicleName,
                                email: userContact
                            });
                        }
                    }
                } catch (error) {
                    console.error('âŒ Fehler beim Cleanup alter Fahrzeuge:', error);
                }
            }
            
            // ğŸ” Rolle laden und anwenden
            const role = await getUserRole(user);
            applyRoleRestrictions(role);
            
            // ğŸ†• v5.33.6: Update Tab-Visibility nach Rolle
            updateAdminTabsVisibility();
            
            // ğŸ“œ PROTOKOLL: Login (mit App-Version)
            logActivity('system', 'login', `Login: ${user.email || user.phoneNumber} (${role || 'Fahrgast'})`, {
                email: user.email || '',
                phone: user.phoneNumber || '',
                role: role || 'Fahrgast',
                appVersion: APP_VERSION,
                appBuild: APP_BUILD
            });
            
            // ğŸ“Š User in Firebase speichern - IMMER, auch wenn Admin nicht online!
            if (isFirebaseReady) {
                try {
                    // Erst prÃ¼fen ob User schon existiert
                    const userSnapshot = await db.ref('users/' + user.uid).once('value');
                    const existingUser = userSnapshot.val();
                    
                    // Update-Daten vorbereiten
                    const updateData = {
                        lastLogin: Date.now(),
                        displayName: user.displayName || existingUser?.displayName || '',
                    };
                    
                    // E-Mail hinzufÃ¼gen wenn vorhanden
                    if (user.email) {
                        updateData.email = user.email;
                    }
                    
                    // Telefonnummer hinzufÃ¼gen wenn vorhanden
                    if (user.phoneNumber) {
                        updateData.phone = user.phoneNumber;
                    }
                    
                    // Provider-Info (Google, Email, Phone)
                    if (user.providerData && user.providerData[0]) {
                        updateData.providerId = user.providerData[0].providerId;
                    }
                    
                    // createdAt NUR setzen wenn User neu ist
                    if (!existingUser) {
                        updateData.createdAt = Date.now();
                        updateData.role = 'fahrgast'; // Standard-Rolle
                        console.log('ğŸ†• Neuer User wird angelegt:', user.uid);
                    }
                    
                    await db.ref('users/' + user.uid).update(updateData);
                    console.log('ğŸ“Š User-Daten gespeichert:', updateData);
                    
                } catch (error) {
                    console.error('âŒ Fehler beim Speichern der User-Daten:', error);
                }
            }
            
            updateUserProfile();
            
            // ğŸ“ FÃ¼lle Name-Feld NUR wenn NICHT fÃ¼r Kunden gebucht wird
            const nameField = document.getElementById('customer-name');
            if (nameField && user.displayName && !currentBookingCustomerId) {
                nameField.value = user.displayName;
            }
            
            // ğŸ‘¤ Lade "Mein Profil" fÃ¼r eingeloggte Kunden
            loadMyProfile();
            
            // ğŸ†• v5.19.0: Lade Telegram-ID fÃ¼r diesen User
            loadDriverTelegramId();
            
            // ğŸ†• v5.20.1: Lade gespeichertes Fahrzeug
            loadSavedVehicle();
        }
        
        function onUserLoggedOut() {
            // ğŸ†• v5.21.0: Stack Trace um zu sehen WOHER der Logout kommt
            console.log('ğŸ‘¤ onUserLoggedOut aufgerufen');
            console.trace('ğŸ“ Logout Stack Trace:');
            
            // ğŸ“œ PROTOKOLL: Logout (vor dem ZurÃ¼cksetzen!)
            if (currentUser) {
                logActivity('system', 'logout', `ğŸ” Logout: ${currentUser.email}`, {
                    email: currentUser.email,
                    reason: 'auth_state_changed'
                });
            } else {
                // User war schon null - unerwarteter Logout!
                logActivity('system', 'logout', `âš ï¸ Unerwarteter Logout (User war bereits null)`, {
                    reason: 'unexpected'
                });
            }
            
            console.log('ğŸ‘¤ User ausgeloggt');
            currentUser = null;
            userRole = 'fahrgast';
            myProfileData = null;
            
            // ğŸ‘¤ "Mein Profil" Box ausblenden
            const profileBox = document.getElementById('my-profile-box');
            if (profileBox) profileBox.style.display = 'none';
            
            // ğŸ” Nur Fahrgast-Tab fÃ¼r nicht eingeloggte User
            applyRoleRestrictions(null); // null = nicht eingeloggt
            
            updateUserProfile();
        }
        
        function updateUserProfile() {
            const header = document.querySelector('.header');
            if (!header) {
                console.warn('âš ï¸ Header element not found yet');
                return;
            }
            
            let profileBox = document.getElementById('user-profile-box');
            
            if (currentUser) {
                // User ist eingeloggt - zeige Profil + Stammkunden-Info
                const initial = (currentUser.displayName || currentUser.email).charAt(0).toUpperCase();
                const displayName = currentUser.displayName || currentUser.email.split('@')[0];
                
                // Lade Stammkunden-Daten
                const regularCustomer = JSON.parse(localStorage.getItem('regularCustomer') || 'null');
                
                if (!profileBox) {
                    profileBox = document.createElement('div');
                    profileBox.id = 'user-profile-box';
                    profileBox.className = 'user-profile';
                    header.appendChild(profileBox);
                }
                
                // Stammkunden-Info
                let customerStats = '';
                if (regularCustomer && regularCustomer.rideCount > 0) {
                    customerStats = `<div style="font-size: 9px; opacity: 0.8; margin-top: 2px;">ğŸš• ${regularCustomer.rideCount} Fahrt${regularCustomer.rideCount > 1 ? 'en' : ''} Â· ğŸ“ ${regularCustomer.favoritePickup ? regularCustomer.favoritePickup.substring(0, 20) + (regularCustomer.favoritePickup.length > 20 ? '...' : '') : 'Keine Adresse'}</div>`;
                }
                
                profileBox.innerHTML = `
                    <div class="user-avatar">${initial}</div>
                    <div class="user-info">
                        <div style="font-weight: 600; font-size: 11px;">${displayName}</div>
                        <div style="font-size: 9px; opacity: 0.75;">${currentUser.email}</div>
                        ${customerStats}
                    </div>
                    <button class="btn-logout" onclick="logoutUser()">Aus</button>
                `;
            } else {
                // User ist nicht eingeloggt - zeige nur Anmelden Button
                if (!profileBox) {
                    profileBox = document.createElement('div');
                    profileBox.id = 'user-profile-box';
                    header.appendChild(profileBox);
                }
                
                profileBox.className = '';
                profileBox.style.marginTop = '15px';
                profileBox.innerHTML = `
                    <button class="btn btn-primary" onclick="showLoginModal()" style="padding: 10px 20px; font-size: 13px;">
                        ğŸ” Anmelden / Registrieren
                    </button>
                `;
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.26.13: POI / FAVORITEN-ORTE MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Lade gespeicherte Orte beim Start
        function loadSavedLocations() {
            const locations = JSON.parse(localStorage.getItem('savedLocations') || '[]');
            
            // Pickup Orte
            const pickupContainer = document.getElementById('pickup-saved-locations');
            if (locations.length > 0) {
                pickupContainer.style.display = 'flex';
                pickupContainer.style.flexWrap = 'wrap';
                pickupContainer.style.gap = '6px';
                pickupContainer.innerHTML = locations.map(loc => `
                    <button onclick="useSavedLocation('pickup', '${loc.address.replace(/'/g, "\\'")}', ${loc.lat || 'null'}, ${loc.lon || 'null'})" 
                        style="padding:8px 12px;background:#dbeafe;border:2px solid #3b82f6;color:#1e40af;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:4px;">
                        ${loc.icon} ${loc.name}
                    </button>
                `).join('') + `
                    <button onclick="manageLocations()" 
                        style="padding:8px 12px;background:#f3f4f6;border:2px solid #d1d5db;color:#6b7280;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;">
                        âš™ï¸ Verwalten
                    </button>
                `;
            } else {
                pickupContainer.style.display = 'none';
            }
            
            // Destination Orte
            const destContainer = document.getElementById('destination-saved-locations');
            if (locations.length > 0) {
                destContainer.style.display = 'flex';
                destContainer.style.flexWrap = 'wrap';
                destContainer.style.gap = '6px';
                destContainer.innerHTML = locations.map(loc => `
                    <button onclick="useSavedLocation('destination', '${loc.address.replace(/'/g, "\\'")}', ${loc.lat || 'null'}, ${loc.lon || 'null'})" 
                        style="padding:8px 12px;background:#fef3c7;border:2px solid #f59e0b;color:#92400e;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:4px;">
                        ${loc.icon} ${loc.name}
                    </button>
                `).join('') + `
                    <button onclick="manageLocations()" 
                        style="padding:8px 12px;background:#f3f4f6;border:2px solid #d1d5db;color:#6b7280;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;">
                        âš™ï¸ Verwalten
                    </button>
                `;
            } else {
                destContainer.style.display = 'none';
            }
        }
        
        // Ort speichern
        function saveLocationPOI(field) {
            const fieldElement = document.getElementById(field);
            const address = fieldElement.value.trim();
            
            if (!address) {
                alert('âŒ Bitte erst einen Ort eingeben!');
                fieldElement.focus();
                return;
            }
            
            // Modal fÃ¼r Namen & Icon
            const modal = document.createElement('div');
            modal.id = 'location-save-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;width:100%;max-width:400px;">
                    <h3 style="margin:0 0 15px 0;">â­ Ort speichern</h3>
                    
                    <div style="font-size:13px;color:#666;margin-bottom:10px;">
                        <strong>Adresse:</strong><br>
                        ${address}
                    </div>
                    
                    <div style="margin:15px 0;">
                        <label style="display:block;font-size:12px;color:#666;margin-bottom:5px;font-weight:600;">Name (z.B. "Zuhause", "Arbeit")</label>
                        <input type="text" id="location-name" placeholder="Zuhause" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;box-sizing:border-box;font-size:14px;">
                    </div>
                    
                    <div style="margin:15px 0;">
                        <label style="display:block;font-size:12px;color:#666;margin-bottom:5px;font-weight:600;">Icon auswÃ¤hlen</label>
                        <div id="icon-selector" style="display:flex;flex-wrap:wrap;gap:8px;">
                            ${['ğŸ ', 'ğŸ’¼', 'ğŸš‰', 'ğŸ¨', 'ğŸ½ï¸', 'ğŸ¥', 'âœˆï¸', 'ğŸ–ï¸', 'â›ª', 'ğŸ›ï¸', 'ğŸ­', 'ğŸª', 'ğŸ’’', 'ğŸ“', 'ğŸ‹ï¸'].map(icon => `
                                <button onclick="selectIcon('${icon}')" data-icon="${icon}" 
                                    style="width:44px;height:44px;font-size:24px;border:2px solid #e5e7eb;background:white;border-radius:8px;cursor:pointer;">
                                    ${icon}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button onclick="closeLocationModal()" style="flex:1;padding:12px;background:#e5e7eb;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                            Abbrechen
                        </button>
                        <button onclick="saveLocationConfirm('${address.replace(/'/g, "\\'")}', '${field}')" style="flex:1;padding:12px;background:#f59e0b;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                            ğŸ’¾ Speichern
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('location-name').focus();
            
            // WÃ¤hle erstes Icon automatisch
            window.selectedLocationIcon = 'ğŸ ';
            document.querySelector('[data-icon="ğŸ "]').style.background = '#dbeafe';
            document.querySelector('[data-icon="ğŸ "]').style.borderColor = '#3b82f6';
        }
        
        function selectIcon(icon) {
            window.selectedLocationIcon = icon;
            // Reset alle Icons
            document.querySelectorAll('[data-icon]').forEach(btn => {
                btn.style.background = 'white';
                btn.style.borderColor = '#e5e7eb';
            });
            // Markiere gewÃ¤hltes Icon
            document.querySelector(`[data-icon="${icon}"]`).style.background = '#dbeafe';
            document.querySelector(`[data-icon="${icon}"]`).style.borderColor = '#3b82f6';
        }
        
        function closeLocationModal() {
            // SchlieÃŸe POI-Modals mit ID
            const modalById = document.getElementById('location-save-modal') || document.getElementById('location-manage-modal');
            if (modalById) {
                modalById.remove();
                console.log('âœ… Modal geschlossen (per ID)');
                return;
            }
            
            // Fallback: Suche alle Modals
            const allModals = document.querySelectorAll('[style*="position:fixed"][style*="z-index:9999"]');
            allModals.forEach(modal => {
                if (modal.innerHTML.includes('Ort speichern') || 
                    modal.innerHTML.includes('Orte verwalten') ||
                    modal.innerHTML.includes('Icon auswÃ¤hlen')) {
                    modal.remove();
                    console.log('âœ… Modal geschlossen (per Content-Match)');
                }
            });
        }
        
        function saveLocationConfirm(address, field) {
            const name = document.getElementById('location-name').value.trim();
            
            if (!name) {
                alert('âŒ Bitte einen Namen eingeben!');
                return;
            }
            
            const locations = JSON.parse(localStorage.getItem('savedLocations') || '[]');
            
            // PrÃ¼fe ob Ort schon existiert
            if (locations.some(loc => loc.address === address)) {
                alert('âš ï¸ Dieser Ort ist bereits gespeichert!');
                return;
            }
            
            // ğŸ†• v5.26.14h: Hole Koordinaten aus dem entsprechenden Feld!
            let coords = null;
            if (field === 'pickup' && pickupCoords) {
                coords = { lat: pickupCoords.lat, lon: pickupCoords.lon };
            } else if (field === 'destination' && destCoords) {
                coords = { lat: destCoords.lat, lon: destCoords.lon };
            }
            
            // Speichere neuen Ort MIT KOORDINATEN!
            locations.push({
                name,
                address,
                icon: window.selectedLocationIcon || 'ğŸ“',
                createdAt: Date.now(),
                lat: coords ? coords.lat : null,
                lon: coords ? coords.lon : null
            });
            
            localStorage.setItem('savedLocations', JSON.stringify(locations));
            
            console.log('âœ… Ort gespeichert:', { name, address, icon: window.selectedLocationIcon, coords });
            
            closeLocationModal();
            loadSavedLocations();
            
            alert('âœ… Ort gespeichert!\n\n' + window.selectedLocationIcon + ' ' + name + '\n' + address);
        }
        
        function useSavedLocation(field, address, lat, lon) {
            document.getElementById(field).value = address;
            
            // ğŸ”§ v5.30.0: FIX - Wenn KEINE Koordinaten gespeichert, hole sie via Geocoding!
            if (lat !== null && lon !== null) {
                // Koordinaten vorhanden - nutze sie direkt!
                if (field === 'pickup') {
                    pickupCoords = { lat: parseFloat(lat), lon: parseFloat(lon) };
                    console.log('âœ… Pickup-Koordinaten gesetzt:', pickupCoords);
                    
                    // ğŸ†• v5.30.0: NUR bei "Sofort" Taxis laden!
                    if (currentRideType === 'sofort') {
                        const display = document.getElementById('available-taxis-display');
                        display.innerHTML = `
                            <div style="padding:20px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:12px;text-align:center;margin-top:10px;">
                                <div style="font-size:20px;margin-bottom:10px;">ğŸ“</div>
                                <div style="font-weight:600;font-size:16px;margin-bottom:5px;">Position wird geladen...</div>
                                <div style="font-size:13px;opacity:0.9;">ğŸ” Suche verfÃ¼gbare Taxis in der NÃ¤he...</div>
                            </div>
                        `;
                        
                        setTimeout(() => {
                            showAvailableTaxis();
                        }, 1000);
                    }
                } else {
                    destCoords = { lat: parseFloat(lat), lon: parseFloat(lon) };
                    console.log('âœ… Ziel-Koordinaten gesetzt:', destCoords);
                }
            } else {
                // ğŸ†• v5.30.0: KEINE Koordinaten gespeichert - hole sie via Forward Geocoding!
                console.log('âš ï¸ Keine Koordinaten gespeichert - hole via Geocoding:', address);
                
                if (field === 'pickup') {
                    // ğŸ†• v5.30.0: NUR bei "Sofort" Loading zeigen und Taxis laden!
                    if (currentRideType === 'sofort') {
                        const display = document.getElementById('available-taxis-display');
                        display.innerHTML = `
                            <div style="padding:20px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:12px;text-align:center;margin-top:10px;">
                                <div style="font-size:20px;margin-bottom:10px;">ğŸ”</div>
                                <div style="font-weight:600;font-size:16px;margin-bottom:5px;">Suche Koordinaten...</div>
                                <div style="font-size:13px;opacity:0.9;">Bitte warten...</div>
                            </div>
                        `;
                        
                        // Forward Geocoding: Adresse â†’ Koordinaten
                        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data && data.length > 0) {
                                    pickupCoords = { 
                                        lat: parseFloat(data[0].lat), 
                                        lon: parseFloat(data[0].lon) 
                                    };
                                    console.log('âœ… Koordinaten via Geocoding gefunden:', pickupCoords);
                                    
                                    setTimeout(() => {
                                        showAvailableTaxis();
                                    }, 500);
                                } else {
                                    console.error('âŒ Keine Koordinaten gefunden fÃ¼r:', address);
                                    display.innerHTML = `
                                        <div style="padding:15px;background:#fef3c7;border:2px solid #f59e0b;border-radius:12px;margin-top:10px;text-align:center;">
                                            <div style="font-size:18px;margin-bottom:8px;">âš ï¸</div>
                                            <div style="font-weight:600;color:#92400e;margin-bottom:5px;">Adresse nicht gefunden</div>
                                            <div style="font-size:13px;color:#78350f;">Bitte Favorit neu speichern</div>
                                        </div>
                                    `;
                                }
                            })
                            .catch(error => {
                                console.error('âŒ Geocoding-Fehler:', error);
                                display.innerHTML = `
                                    <div style="padding:15px;background:#fef2f2;border:2px solid #ef4444;border-radius:12px;margin-top:10px;text-align:center;">
                                        <div style="font-size:18px;margin-bottom:8px;">âŒ</div>
                                        <div style="font-weight:600;color:#991b1b;margin-bottom:5px;">Fehler beim Laden</div>
                                        <div style="font-size:13px;color:#7f1d1d;">Bitte Favorit neu speichern</div>
                                    </div>
                                `;
                            });
                    } else {
                        // Bei "Vorbestellen": Hole Koordinaten trotzdem (fÃ¼r Distanz-Berechnung), aber zeige keine Taxis
                        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data && data.length > 0) {
                                    pickupCoords = { 
                                        lat: parseFloat(data[0].lat), 
                                        lon: parseFloat(data[0].lon) 
                                    };
                                    console.log('âœ… Koordinaten via Geocoding gefunden:', pickupCoords);
                                }
                            })
                            .catch(error => console.error('âŒ Geocoding-Fehler:', error));
                    }
                } else {
                    // Destination: Auch Koordinaten holen
                    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data && data.length > 0) {
                                destCoords = { 
                                    lat: parseFloat(data[0].lat), 
                                    lon: parseFloat(data[0].lon) 
                                };
                                console.log('âœ… Ziel-Koordinaten via Geocoding gefunden:', destCoords);
                            }
                        })
                        .catch(error => console.error('âŒ Geocoding-Fehler (Ziel):', error));
                }
            }
            
            console.log('âœ… Gespeicherter Ort verwendet:', address);
        }
        
        function manageLocations() {
            const locations = JSON.parse(localStorage.getItem('savedLocations') || '[]');
            
            if (locations.length === 0) {
                alert('ğŸ“ Keine gespeicherten Orte vorhanden.');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'location-manage-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;overflow-y:auto;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;width:100%;max-width:400px;max-height:90vh;overflow-y:auto;">
                    <h3 style="margin:0 0 15px 0;">âš™ï¸ Orte verwalten</h3>
                    
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        ${locations.map((loc, index) => `
                            <div style="padding:12px;background:#f9fafb;border-radius:8px;display:flex;justify-content:space-between;align-items:center;">
                                <div style="flex:1;">
                                    <div style="font-weight:600;margin-bottom:4px;">${loc.icon} ${loc.name}</div>
                                    <div style="font-size:12px;color:#666;">${loc.address}</div>
                                </div>
                                <button onclick="deleteSavedLocation(${index})" style="padding:8px 12px;background:#fee2e2;border:2px solid #ef4444;color:#991b1b;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    
                    <button onclick="closeLocationModal()" style="width:100%;margin-top:15px;padding:12px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">
                        SchlieÃŸen
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function deleteSavedLocation(index) {
            if (!confirm('ğŸ—‘ï¸ Ort wirklich lÃ¶schen?')) return;
            
            const locations = JSON.parse(localStorage.getItem('savedLocations') || '[]');
            locations.splice(index, 1);
            localStorage.setItem('savedLocations', JSON.stringify(locations));
            
            console.log('ğŸ—‘ï¸ Ort gelÃ¶scht');
            
            closeLocationModal();
            loadSavedLocations();
            
            alert('âœ… Ort gelÃ¶scht!');
        }
        
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• v5.27.0: KALENDER-SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let currentCalendarView = 'month'; // 'month', 'week', 'day'
        let currentCalendarDate = new Date(); // Aktuelles Datum im Kalender
        
        function switchCalendarView(view) {
            currentCalendarView = view;
            
            // Update Button-Styling
            ['month', 'week', 'day', 'timeline'].forEach(v => {
                const btn = document.getElementById('cal-' + v + '-btn');
                if (btn) {
                    if (v === view) {
                        if (v === 'timeline') {
                            btn.style.background = '#10b981';
                            btn.style.color = 'white';
                            btn.style.borderColor = '#10b981';
                        } else {
                            btn.style.background = '#667eea';
                            btn.style.color = 'white';
                            btn.style.borderColor = '#667eea';
                        }
                    } else {
                        btn.style.background = 'white';
                        if (v === 'timeline') {
                            btn.style.color = '#10b981';
                            btn.style.borderColor = '#10b981';
                        } else {
                            btn.style.color = '#667eea';
                            btn.style.borderColor = '#667eea';
                        }
                    }
                }
            });
            
            renderCalendar();
        }
        
        function previousPeriod() {
            if (currentCalendarView === 'month') {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            } else if (currentCalendarView === 'week') {
                currentCalendarDate.setDate(currentCalendarDate.getDate() - 7);
            } else {
                currentCalendarDate.setDate(currentCalendarDate.getDate() - 1);
            }
            renderCalendar();
        }
        
        function nextPeriod() {
            if (currentCalendarView === 'month') {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            } else if (currentCalendarView === 'week') {
                currentCalendarDate.setDate(currentCalendarDate.getDate() + 7);
            } else {
                currentCalendarDate.setDate(currentCalendarDate.getDate() + 1);
            }
            renderCalendar();
        }
        
        function getRideColor(status) {
            const statusMap = {
                'completed': '#10b981',      // GrÃ¼n
                'abgeschlossen': '#10b981',
                'cancelled': '#ef4444',      // Rot
                'storniert': '#ef4444',
                'vorbestellt': '#f59e0b',    // Gelb/Orange
                'new': '#f59e0b',
                'accepted': '#3b82f6',       // Blau
                'picked_up': '#3b82f6',
                'akzeptiert': '#3b82f6',
                'unterwegs': '#3b82f6'
            };
            return statusMap[status] || '#9ca3af';
        }
        
        async function renderCalendar() {
            console.log('ğŸ“… Rendere Kalender:', currentCalendarView, currentCalendarDate);
            
            // Lade alle Fahrten
            const localHistory = JSON.parse(localStorage.getItem('rideHistory') || '[]');
            let allRides = [...localHistory];
            
            // ğŸ”¥ Hole auch Firebase-Fahrten wenn eingeloggt
            if (isFirebaseReady && currentUser) {
                try {
                    // ğŸ†• v5.30.5: Admin-Kalender zeigt ALLE Fahrten!
                    // FÃ¼r Admin: Lade ALLE Fahrten (nicht nur eigene)
                    const snapshot = await db.ref('rides').once('value');
                    if (snapshot.exists()) {
                        const firebaseRides = [];
                        snapshot.forEach(childSnapshot => {
                            const ride = childSnapshot.val();
                            ride.firebaseId = childSnapshot.key;
                            firebaseRides.push(ride);
                        });
                        
                        console.log(`ğŸ“… Kalender: ${firebaseRides.length} Fahrten aus Firebase geladen`);
                        
                        // Merge: Firebase hat Vorrang
                        const rideMap = new Map();
                        localHistory.forEach(r => rideMap.set(r.id, r));
                        firebaseRides.forEach(r => rideMap.set(r.id, r));
                        allRides = Array.from(rideMap.values());
                    }
                } catch (e) {
                    console.error('âŒ Fehler beim Laden der Firebase-Fahrten:', e);
                }
            }
            
            if (currentCalendarView === 'month') {
                renderMonthView(allRides);
            } else if (currentCalendarView === 'week') {
                renderWeekView(allRides);
            } else if (currentCalendarView === 'timeline') {
                renderVehicleTimeline(allRides);
            } else {
                renderDayView(allRides);
            }
        }
        
        // ğŸ†• v5.29.0: Analysiere Tag und erkenne Hot-Spots
        function analyzeDayCapacity(rides) {
            const total = rides.length;
            
            // Gruppiere nach Stunden
            const hourly = {};
            rides.forEach(r => {
                const timestamp = r.pickupTimestamp || r.createdAt || 0;
                const date = new Date(timestamp);
                const hour = date.getHours();
                if (!hourly[hour]) hourly[hour] = [];
                hourly[hour].push(r);
            });
            
            // Finde Hot Spots (3+ Fahrten zur gleichen Stunde)
            const hotSpots = [];
            Object.keys(hourly).forEach(hour => {
                if (hourly[hour].length >= 3) {
                    hotSpots.push({
                        hour: parseInt(hour),
                        count: hourly[hour].length,
                        level: hourly[hour].length >= 4 ? 'red' : 'yellow'
                    });
                }
            });
            
            // Gesamte Farb-Level Logik
            let level = 'green';
            let bgColor = '#f0fdf4';
            let borderColor = '#86efac';
            let textColor = '#166534';
            let emoji = 'âœ…';
            
            if (total >= 6) {
                level = 'red';
                bgColor = '#fef2f2';
                borderColor = '#fca5a5';
                textColor = '#991b1b';
                emoji = 'ğŸ”¥';
            } else if (total >= 4) {
                level = 'yellow';
                bgColor = '#fef3c7';
                borderColor = '#fcd34d';
                textColor = '#92400e';
                emoji = 'âš ï¸';
            }
            
            return {
                total,
                level,
                bgColor,
                borderColor,
                textColor,
                emoji,
                hotSpots,
                hourly
            };
        }
        
        function renderMonthView(allRides) {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            // Update Titel
            const monthNames = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            document.getElementById('calendar-period-title').textContent = `${monthNames[month]} ${year}`;
            
            // Erster und letzter Tag des Monats
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            // Starte am Montag (0=So, 1=Mo, ...)
            const startDayOfWeek = (firstDay.getDay() + 6) % 7; // Montag = 0
            
            // Gruppiere Fahrten nach Datum
            const ridesByDate = {};
            allRides.forEach(ride => {
                // ğŸ”§ v5.29.1: FÃœR KALENDER: Nutze pickupTimestamp (Abholzeit) statt createdAt!
                const rideDate = new Date(ride.pickupTimestamp || ride.createdAt || 0);
                if (rideDate.getMonth() === month && rideDate.getFullYear() === year) {
                    const day = rideDate.getDate();
                    if (!ridesByDate[day]) ridesByDate[day] = [];
                    ridesByDate[day].push(ride);
                }
            });
            
            // Erstelle Kalender-Grid
            let html = `
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 10px;">
                    <div style="text-align: center; font-weight: 600; padding: 8px; color: #6b7280; font-size: 13px;">Mo</div>
                    <div style="text-align: center; font-weight: 600; padding: 8px; color: #6b7280; font-size: 13px;">Di</div>
                    <div style="text-align: center; font-weight: 600; padding: 8px; color: #6b7280; font-size: 13px;">Mi</div>
                    <div style="text-align: center; font-weight: 600; padding: 8px; color: #6b7280; font-size: 13px;">Do</div>
                    <div style="text-align: center; font-weight: 600; padding: 8px; color: #6b7280; font-size: 13px;">Fr</div>
                    <div style="text-align: center; font-weight: 600; padding: 8px; color: #6b7280; font-size: 13px;">Sa</div>
                    <div style="text-align: center; font-weight: 600; padding: 8px; color: #6b7280; font-size: 13px;">So</div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;">
            `;
            
            // Leere Zellen vor dem 1. des Monats
            for (let i = 0; i < startDayOfWeek; i++) {
                html += `<div style="background: #f9fafb; padding: 12px; border-radius: 6px; min-height: 60px;"></div>`;
            }
            
            // Tage des Monats
            for (let day = 1; day <= daysInMonth; day++) {
                const rides = ridesByDate[day] || [];
                const today = new Date();
                const isToday = (day === today.getDate() && month === today.getMonth() && year === today.getFullYear());
                
                // ğŸ†• v5.29.0: Hot-Spot Analyse
                const analysis = analyzeDayCapacity(rides);
                
                // Farbige Punkte fÃ¼r Status
                let statusDots = '';
                const statusCounts = {};
                rides.forEach(r => {
                    const color = getRideColor(r.status);
                    statusCounts[color] = (statusCounts[color] || 0) + 1;
                });
                
                Object.entries(statusCounts).forEach(([color, count]) => {
                    statusDots += `<div style="width: 6px; height: 6px; background: ${color}; border-radius: 50%; display: inline-block; margin: 0 1px;" title="${count} Fahrten"></div>`;
                });
                
                // ğŸ†• v5.29.0: Hot-Spot Indikator
                let hotSpotBadge = '';
                if (analysis.hotSpots.length > 0) {
                    const worst = analysis.hotSpots.reduce((a, b) => a.count > b.count ? a : b);
                    hotSpotBadge = `
                        <div style="background:${worst.level === 'red' ? '#fca5a5' : '#fcd34d'};color:#1f2937;font-size:10px;font-weight:700;padding:2px 4px;border-radius:4px;margin-top:2px;">
                            ğŸ”¥ ${worst.hour}:00
                        </div>
                    `;
                }
                
                html += `
                    <div onclick="showDayDetails(${day}, ${month}, ${year})" style="
                        background: ${isToday ? '#dbeafe' : (rides.length > 0 ? analysis.bgColor : 'white')};
                        border: 2px solid ${isToday ? '#3b82f6' : (rides.length > 0 ? analysis.borderColor : '#e5e7eb')};
                        padding: 8px;
                        border-radius: 6px;
                        min-height: 70px;
                        cursor: ${rides.length > 0 ? 'pointer' : 'default'};
                        transition: all 0.2s;
                        position: relative;
                    " ${rides.length > 0 ? 'onmouseenter="this.style.transform=\'scale(1.02)\'" onmouseleave="this.style.transform=\'scale(1)\'"' : ''}>
                        <div style="font-weight: ${isToday ? '700' : '600'}; color: ${isToday ? '#1e40af' : (rides.length > 0 ? analysis.textColor : '#374151')}; margin-bottom: 4px; font-size: 14px;">
                            ${day} ${rides.length > 0 ? analysis.emoji : ''}
                        </div>
                        ${rides.length > 0 ? `
                            <div style="font-size: 12px; color: ${analysis.textColor}; font-weight: 600; margin-bottom: 4px;">
                                ${rides.length} Fahrt${rides.length > 1 ? 'en' : ''}
                            </div>
                            <div style="text-align: center; margin-bottom: 2px;">${statusDots}</div>
                            ${hotSpotBadge}
                        ` : ''}
                    </div>
                `;
            }
            
            html += `</div>`;
            
            document.getElementById('calendar-container').innerHTML = html;
            
            // Statistik
            updateCalendarStats(allRides, 'Monat');
        }
        
        function renderWeekView(allRides) {
            // Aktueller Montag
            const current = new Date(currentCalendarDate);
            const day = current.getDay();
            const diff = current.getDate() - day + (day === 0 ? -6 : 1); // Montag
            const monday = new Date(current.setDate(diff));
            
            // Update Titel
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            const monthNames = ['Jan', 'Feb', 'MÃ¤r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
            document.getElementById('calendar-period-title').textContent = 
                `${monday.getDate()}. ${monthNames[monday.getMonth()]} - ${sunday.getDate()}. ${monthNames[sunday.getMonth()]} ${sunday.getFullYear()}`;
            
            // Gruppiere Fahrten nach Tag
            const ridesByDay = {};
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                // ğŸ”§ v5.30.6: LOKALE ZEIT statt UTC (konsistent mit MonthView/DayView)
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                ridesByDay[key] = {
                    date: new Date(date),
                    rides: []
                };
            }
            
            allRides.forEach(ride => {
                // ğŸ”§ v5.29.1: FÃœR KALENDER: Nutze pickupTimestamp (Abholzeit) statt createdAt!
                const rideDate = new Date(ride.pickupTimestamp || ride.createdAt || 0);
                // ğŸ”§ v5.30.6: LOKALE ZEIT statt UTC (konsistent mit MonthView/DayView)
                const key = `${rideDate.getFullYear()}-${String(rideDate.getMonth() + 1).padStart(2, '0')}-${String(rideDate.getDate()).padStart(2, '0')}`;
                if (ridesByDay[key]) {
                    ridesByDay[key].rides.push(ride);
                }
            });
            
            // Erstelle Wochenansicht
            let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
            
            const dayNames = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];
            Object.entries(ridesByDay).forEach(([key, data], index) => {
                const rides = data.rides;
                const date = data.date;
                const today = new Date();
                const isToday = date.toDateString() === today.toDateString();
                
                html += `
                    <div onclick="showDayDetails(${date.getDate()}, ${date.getMonth()}, ${date.getFullYear()})" style="
                        background: ${isToday ? '#dbeafe' : 'white'};
                        border: ${isToday ? '2px solid #3b82f6' : '1px solid #e5e7eb'};
                        padding: 15px;
                        border-radius: 8px;
                        cursor: pointer;
                        transition: all 0.2s;
                    " onmouseenter="this.style.background='#f0f9ff'" onmouseleave="this.style.background='${isToday ? '#dbeafe' : 'white'}'">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div>
                                <div style="font-weight: 700; font-size: 16px; color: #1f2937;">${dayNames[index]}</div>
                                <div style="font-size: 13px; color: #6b7280;">${date.getDate()}. ${monthNames[date.getMonth()]}</div>
                            </div>
                            <div style="font-size: 20px; font-weight: 700; color: #667eea;">
                                ${rides.length}
                            </div>
                        </div>
                        ${rides.length > 0 ? `
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                ${rides.map(r => `
                                    <div style="display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: ${getRideColor(r.status)}20; border-radius: 4px;">
                                        <div style="width: 8px; height: 8px; background: ${getRideColor(r.status)}; border-radius: 50%;"></div>
                                        <span style="font-size: 12px; color: #374151;">${r.price || 0}â‚¬</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<div style="font-size: 13px; color: #9ca3af;">Keine Fahrten</div>'}
                    </div>
                `;
            });
            
            html += '</div>';
            
            document.getElementById('calendar-container').innerHTML = html;
            updateCalendarStats(Object.values(ridesByDay).flatMap(d => d.rides), 'Woche');
        }
        
        function renderDayView(allRides) {
            const date = new Date(currentCalendarDate);
            
            // Update Titel
            const dayNames = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
            const monthNames = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            document.getElementById('calendar-period-title').textContent = 
                `${dayNames[date.getDay()]}, ${date.getDate()}. ${monthNames[date.getMonth()]} ${date.getFullYear()}`;
            
            // Filtere Fahrten fÃ¼r diesen Tag
            const dayRides = allRides.filter(ride => {
                // ğŸ”§ v5.29.1: FÃœR KALENDER: Nutze pickupTimestamp (Abholzeit) statt createdAt!
                const rideDate = new Date(ride.pickupTimestamp || ride.createdAt || 0);
                return rideDate.toDateString() === date.toDateString();
            }).sort((a, b) => {
                // ğŸ”§ v5.29.1: Sortiere nach Abholzeit
                const timeA = a.pickupTimestamp || a.createdAt || 0;
                const timeB = b.pickupTimestamp || b.createdAt || 0;
                return timeA - timeB;
            });
            
            // ğŸ†• v5.29.0: Analysiere Tag
            const analysis = analyzeDayCapacity(dayRides);
            
            // Erstelle Tagesansicht
            let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';
            
            if (dayRides.length === 0) {
                html += `
                    <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“…</div>
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 5px;">Keine Fahrten</div>
                        <div style="font-size: 14px;">An diesem Tag gab es keine Fahrten</div>
                    </div>
                `;
            } else {
                // ğŸ†• v5.29.0: ZEITFENSTER-ÃœBERSICHT
                html += `
                    <div style="background:${analysis.bgColor};border:2px solid ${analysis.borderColor};padding:20px;border-radius:12px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                            <div>
                                <div style="font-size:28px;margin-bottom:5px;">${analysis.emoji}</div>
                                <div style="font-weight:700;font-size:20px;color:${analysis.textColor};">
                                    ${dayRides.length} Fahrt${dayRides.length > 1 ? 'en' : ''}
                                </div>
                                <div style="font-size:13px;color:${analysis.textColor};opacity:0.8;">
                                    ${analysis.level === 'red' ? 'VIELE FAHRTEN!' : (analysis.level === 'yellow' ? 'KÃ¶nnte eng werden' : 'Entspannte Auslastung')}
                                </div>
                            </div>
                        </div>
                        
                        ${analysis.hotSpots.length > 0 ? `
                            <div style="background:white;padding:12px;border-radius:8px;margin-top:15px;">
                                <div style="font-weight:600;font-size:14px;color:#991b1b;margin-bottom:10px;">
                                    âš ï¸ Hot-Spots erkannt:
                                </div>
                                ${analysis.hotSpots.map(hs => `
                                    <div style="padding:8px;background:${hs.level === 'red' ? '#fef2f2' : '#fef3c7'};border-radius:6px;margin-bottom:6px;">
                                        <div style="font-weight:600;color:#1f2937;">
                                            ğŸ”¥ ${hs.hour}:00 Uhr - ${hs.count} Fahrten
                                        </div>
                                        <div style="font-size:12px;color:#6b7280;margin-top:2px;">
                                            ${hs.level === 'red' ? 'Sehr hohe Auslastung!' : 'ErhÃ¶hte Auslastung'}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <!-- ZEITFENSTER-BALKEN -->
                        <div style="margin-top:15px;">
                            <div style="font-weight:600;font-size:13px;color:${analysis.textColor};margin-bottom:10px;">
                                ğŸ“Š Zeitliche Verteilung:
                            </div>
                            ${Object.keys(analysis.hourly).sort((a, b) => a - b).map(hour => {
                                const count = analysis.hourly[hour].length;
                                const percent = Math.round((count / dayRides.length) * 100);
                                const barColor = count >= 4 ? '#ef4444' : (count >= 3 ? '#f59e0b' : '#10b981');
                                
                                return `
                                    <div style="margin-bottom:8px;">
                                        <div style="display:flex;justify-content:space-between;font-size:12px;color:#4b5563;margin-bottom:4px;">
                                            <span>${hour}:00 - ${parseInt(hour)+1}:00</span>
                                            <span style="font-weight:600;">${count} Fahrt${count > 1 ? 'en' : ''} (${percent}%)</span>
                                        </div>
                                        <div style="background:#e5e7eb;height:8px;border-radius:4px;overflow:hidden;">
                                            <div style="background:${barColor};height:100%;width:${percent}%;transition:width 0.3s;"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
                
                // FAHRT-LISTE
                html += '<div style="font-weight:600;font-size:15px;color:#1f2937;padding:0 5px;">ğŸ“‹ Alle Fahrten:</div>';
                
                dayRides.forEach(ride => {
                    // ğŸ”§ v5.29.1: FÃœR KALENDER: Zeige Abholzeit, nicht Buchungszeit!
                    const time = new Date(ride.pickupTimestamp || ride.createdAt || 0);
                    const timeStr = time.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    const color = getRideColor(ride.status);
                    
                    const statusText = {
                        'completed': 'Abgeschlossen',
                        'abgeschlossen': 'Abgeschlossen',
                        'cancelled': 'Storniert',
                        'storniert': 'Storniert',
                        'vorbestellt': 'Vorbestellt',
                        'new': 'Neu',
                        'accepted': 'Akzeptiert',
                        'picked_up': 'Unterwegs'
                    }[ride.status] || ride.status;
                    
                    html += `
                        <div onclick="viewRideDetails('${ride.firebaseId || ride.id}')" style="
                            background: white;
                            border-left: 4px solid ${color};
                            padding: 15px;
                            border-radius: 8px;
                            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                            cursor: pointer;
                            transition: all 0.2s;
                        " onmouseenter="this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'" onmouseleave="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div style="font-weight: 700; font-size: 18px; color: ${color};">${timeStr}</div>
                                <div style="padding: 4px 10px; background: ${color}20; color: ${color}; border-radius: 6px; font-size: 12px; font-weight: 600;">
                                    ${statusText}
                                </div>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <div style="font-size: 13px; color: #6b7280; margin-bottom: 2px;">ğŸ“ Von:</div>
                                <div style="font-weight: 600; color: #1f2937;">${ride.pickup || 'Unbekannt'}</div>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <div style="font-size: 13px; color: #6b7280; margin-bottom: 2px;">ğŸ¯ Nach:</div>
                                <div style="font-weight: 600; color: #1f2937;">${ride.destination || 'Unbekannt'}</div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid #e5e7eb;">
                                ${ride.customerName ? `<div style="font-size: 13px; color: #6b7280;">ğŸ‘¤ ${ride.customerName}</div>` : '<div></div>'}
                                <div style="font-weight: 700; font-size: 16px; color: #667eea;">ğŸ’° ${ride.price || 0}â‚¬</div>
                            </div>
                            
                            ${(() => {
                                // ğŸ†• v5.32.5: FAHRZEUG-ZUWEISUNG
                                let vehicleHtml = '';
                                
                                if (ride.vehicleId || ride.assignedVehicle) {
                                    // Fahrzeug ist zugewiesen
                                    const vehicleId = ride.vehicleId || ride.assignedVehicle;
                                    vehicleHtml = `
                                        <div style="margin-top: 10px; padding: 8px 12px; background: #d1fae5; border: 2px solid #10b981; border-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <div style="font-size: 18px;">ğŸš—</div>
                                                <div>
                                                    <div style="font-weight: 600; font-size: 13px; color: #047857;">Fahrzeug: ${vehicleId}</div>
                                                    ${ride.driverName ? `<div style="font-size: 11px; color: #059669;">ğŸ‘¤ ${ride.driverName}</div>` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                } else if (ride.status === 'vorbestellt' || ride.status === 'new' || ride.status === 'pending') {
                                    // Keine Zuweisung - Button anzeigen
                                    vehicleHtml = `
                                        <div style="margin-top: 10px; padding: 8px 12px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <div style="font-size: 16px;">âš ï¸</div>
                                                <div style="font-weight: 600; font-size: 12px; color: #92400e;">Nicht zugewiesen</div>
                                            </div>
                                            <button onclick="event.stopPropagation(); openVehicleAssignmentModal('${ride.firebaseId || ride.id}')" 
                                                    style="padding: 6px 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                                                ğŸš• Zuweisen
                                            </button>
                                        </div>
                                    `;
                                }
                                
                                return vehicleHtml;
                            })()}
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            
            document.getElementById('calendar-container').innerHTML = html;
            updateCalendarStats(dayRides, 'Tag');
        }
        
        function updateCalendarStats(rides, period) {
            const completed = rides.filter(r => r.status === 'completed' || r.status === 'abgeschlossen');
            const cancelled = rides.filter(r => r.status === 'cancelled' || r.status === 'storniert');
            
            // ğŸ”§ v5.29.2: FIX - Stelle sicher dass totalRevenue eine Zahl ist!
            const totalRevenue = completed.reduce((sum, r) => {
                const price = parseFloat(r.price) || 0;
                return sum + price;
            }, 0);
            
            document.getElementById('calendar-stats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div>
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">${period} - Gesamt</div>
                        <div style="font-size: 24px; font-weight: 700;">${rides.length}</div>
                        <div style="font-size: 12px; opacity: 0.8;">Fahrten</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">Umsatz</div>
                        <div style="font-size: 24px; font-weight: 700;">${totalRevenue.toFixed(2)}â‚¬</div>
                        <div style="font-size: 12px; opacity: 0.8;">${completed.length} abgeschlossen</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">âœ… Erfolgreich</div>
                        <div style="font-size: 20px; font-weight: 700;">${completed.length}</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">âŒ Storniert</div>
                        <div style="font-size: 20px; font-weight: 700;">${cancelled.length}</div>
                    </div>
                </div>
            `;
        }
        
        function showDayDetails(day, month, year) {
            currentCalendarDate = new Date(year, month, day);
            currentCalendarView = 'day';
            switchCalendarView('day');
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸš—â±ï¸ v5.32.5: FAHRZEUG-TIMELINE MIT ÃœBERLAPPUNGS-ERKENNUNG
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function renderVehicleTimeline(allRides) {
            const date = new Date(currentCalendarDate);
            
            // Update Titel
            const dayNames = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
            const monthNames = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            document.getElementById('calendar-period-title').textContent = 
                `Timeline: ${dayNames[date.getDay()]}, ${date.getDate()}. ${monthNames[date.getMonth()]} ${date.getFullYear()}`;
            
            // Filtere Fahrten fÃ¼r diesen Tag
            const dayRides = allRides.filter(ride => {
                const rideDate = new Date(ride.pickupTimestamp || ride.createdAt || 0);
                const isSameDay = rideDate.toDateString() === date.toDateString();
                
                // ğŸ†• v5.32.5c: NUR AKTIVE FAHRTEN in Timeline!
                const activeStatuses = ['new', 'accepted', 'picked_up', 'assigned', 'vorbestellt'];
                const isActive = activeStatuses.includes(ride.status);
                
                return isSameDay && isActive;
            }).sort((a, b) => {
                const timeA = a.pickupTimestamp || a.createdAt || 0;
                const timeB = b.pickupTimestamp || b.createdAt || 0;
                return timeA - timeB;
            });
            
            // Gruppiere Fahrten nach Fahrzeug
            const vehicleRides = {};
            dayRides.forEach(ride => {
                const vehicleId = ride.vehicleId || ride.assignedVehicle || 'Nicht zugewiesen';
                if (!vehicleRides[vehicleId]) {
                    vehicleRides[vehicleId] = [];
                }
                vehicleRides[vehicleId].push(ride);
            });
            
            let html = '<div style="display: flex; flex-direction: column; gap: 20px;">';
            
            // Header mit Infos
            html += `
                <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(16,185,129,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <div style="font-size: 28px; margin-bottom: 8px;">ğŸš—â±ï¸</div>
                            <div style="font-weight: 700; font-size: 22px; margin-bottom: 6px;">Fahrzeug-Timeline</div>
                            <div style="font-size: 14px; opacity: 0.95;">
                                Ãœbersicht: Fahrzeuge, Zeitfenster & Ãœberlappungen
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 32px; font-weight: 700; margin-bottom: 4px;">
                                ${Object.keys(vehicleRides).length}
                            </div>
                            <div style="font-size: 13px; opacity: 0.9;">
                                Fahrzeug${Object.keys(vehicleRides).length !== 1 ? 'e' : ''} im Einsatz
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ğŸ†• v5.32.5c: Info - Nur aktive Fahrten
            html += `
                <div style="background: #dbeafe; border: 2px solid #3b82f6; padding: 12px 16px; border-radius: 10px; display: flex; align-items: center; gap: 12px;">
                    <div style="font-size: 20px;">â„¹ï¸</div>
                    <div style="font-size: 13px; color: #1e40af;">
                        <strong>Timeline zeigt nur aktive Fahrten:</strong> Neu, Akzeptiert, Unterwegs, Zugewiesen, Vorbestellt
                        <br>
                        <span style="font-size: 12px; opacity: 0.8;">Abgeschlossene und stornierte Fahrten werden nicht angezeigt.</span>
                    </div>
                </div>
            `;
            
            if (dayRides.length === 0) {
                html += `
                    <div style="text-align: center; padding: 80px 20px; color: #9ca3af;">
                        <div style="font-size: 64px; margin-bottom: 15px;">ğŸ“…</div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #6b7280;">
                            Keine aktiven Fahrten an diesem Tag
                        </div>
                        <div style="font-size: 14px;">
                            WÃ¤hle einen anderen Tag oder prÃ¼fe abgeschlossene Fahrten in der Tagesansicht
                        </div>
                    </div>
                `;
            } else {
                // Legende
                html += `
                    <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #e5e7eb;">
                        <div style="font-weight: 700; font-size: 14px; color: #1f2937; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 18px;">ğŸ“Š</span>
                            <span>Legende</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 13px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 30px; height: 12px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 3px;"></div>
                                <span>Fahrt aktiv</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 30px; height: 12px; background: #d1d5db; border-radius: 3px;"></div>
                                <span>Freie Zeit</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 30px; height: 12px; background: repeating-linear-gradient(45deg, #ef4444, #ef4444 10px, #fca5a5 10px, #fca5a5 20px); border-radius: 3px;"></div>
                                <span>âš ï¸ Ãœberlappung!</span>
                            </div>
                        </div>
                    </div>
                `;
                
                // Timeline fÃ¼r jedes Fahrzeug
                Object.keys(vehicleRides).sort().forEach(vehicleId => {
                    const rides = vehicleRides[vehicleId];
                    
                    // Erkenne Ãœberlappungen fÃ¼r dieses Fahrzeug
                    const conflicts = detectTimeConflicts(rides);
                    
                    html += `
                        <div style="background: white; border: 2px solid ${vehicleId === 'Nicht zugewiesen' ? '#f59e0b' : '#10b981'}; border-radius: 12px; padding: 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #f3f4f6;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="font-size: 32px;">${vehicleId === 'Nicht zugewiesen' ? 'âš ï¸' : 'ğŸš—'}</div>
                                    <div>
                                        <div style="font-weight: 700; font-size: 18px; color: #1f2937;">
                                            ${vehicleId}
                                        </div>
                                        <div style="font-size: 13px; color: #6b7280;">
                                            ${rides.length} Fahrt${rides.length !== 1 ? 'en' : ''} heute
                                        </div>
                                    </div>
                                </div>
                                ${conflicts.length > 0 ? `
                                    <div style="background: #fef2f2; border: 2px solid #ef4444; padding: 8px 12px; border-radius: 8px;">
                                        <div style="font-weight: 700; font-size: 14px; color: #991b1b;">
                                            âš ï¸ ${conflicts.length} Konflikt${conflicts.length !== 1 ? 'e' : ''}!
                                        </div>
                                    </div>
                                ` : `
                                    <div style="background: #f0fdf4; border: 2px solid #10b981; padding: 8px 12px; border-radius: 8px;">
                                        <div style="font-weight: 600; font-size: 13px; color: #047857;">
                                            âœ… Keine Konflikte
                                        </div>
                                    </div>
                                `}
                            </div>
                            
                            <!-- Timeline-Balken -->
                            <div style="margin-bottom: 16px;">
                                ${generateTimelineBar(rides, conflicts)}
                            </div>
                            
                            <!-- Fahrten-Liste -->
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                ${rides.map((ride, idx) => {
                                    const time = new Date(ride.pickupTimestamp || ride.createdAt || 0);
                                    const timeStr = time.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                                    const isConflict = conflicts.some(c => c.includes(idx));
                                    
                                    // GeschÃ¤tzte Fahrtdauer (aus Preis oder Standard 30 Min)
                                    const price = parseFloat(ride.price) || 0;
                                    const estimatedMinutes = price > 0 ? Math.max(15, Math.round(price * 2)) : 30;
                                    const endTime = new Date(time.getTime() + estimatedMinutes * 60000);
                                    const endTimeStr = endTime.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                                    
                                    return `
                                        <div onclick="viewRideDetails('${ride.firebaseId || ride.id}')" style="
                                            background: ${isConflict ? 'linear-gradient(135deg, #fef2f2, #fee2e2)' : '#f9fafb'};
                                            border-left: 4px solid ${isConflict ? '#ef4444' : '#10b981'};
                                            padding: 12px 14px;
                                            border-radius: 8px;
                                            cursor: pointer;
                                            transition: all 0.2s;
                                            ${isConflict ? 'border: 2px solid #ef4444;' : ''}
                                        " onmouseenter="this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)'" 
                                           onmouseleave="this.style.boxShadow='none'">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                                <div style="font-weight: 700; font-size: 15px; color: ${isConflict ? '#991b1b' : '#1f2937'};">
                                                    ${isConflict ? 'âš ï¸ ' : ''}${timeStr} - ${endTimeStr}
                                                    <span style="font-size: 11px; color: #6b7280; font-weight: 500; margin-left: 6px;">
                                                        (~${estimatedMinutes} Min)
                                                    </span>
                                                </div>
                                                <div style="font-weight: 700; font-size: 14px; color: #667eea;">
                                                    ğŸ’° ${ride.price || 0}â‚¬
                                                </div>
                                            </div>
                                            <div style="font-size: 12px; color: #4b5563; margin-bottom: 4px;">
                                                ğŸ“ ${ride.pickup || 'Unbekannt'}
                                            </div>
                                            <div style="font-size: 12px; color: #4b5563;">
                                                ğŸ¯ ${ride.destination || 'Unbekannt'}
                                            </div>
                                            ${isConflict ? `
                                                <div style="margin-top: 8px; padding: 6px 10px; background: #fef2f2; border: 1px solid #ef4444; border-radius: 6px; font-size: 11px; color: #991b1b; font-weight: 600;">
                                                    âš ï¸ WARNUNG: Ãœberschneidet sich mit anderer Fahrt!
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            
            document.getElementById('calendar-container').innerHTML = html;
            updateCalendarStats(dayRides, 'Tag');
        }
        
        // Hilfsfunktion: Erkenne Zeitkonflikte
        function detectTimeConflicts(rides) {
            const conflicts = [];
            
            for (let i = 0; i < rides.length; i++) {
                const ride1 = rides[i];
                const time1 = ride1.pickupTimestamp || ride1.createdAt || 0;
                const price1 = parseFloat(ride1.price) || 0;
                const duration1 = price1 > 0 ? Math.max(15, Math.round(price1 * 2)) : 30;
                const end1 = time1 + (duration1 * 60000);
                
                for (let j = i + 1; j < rides.length; j++) {
                    const ride2 = rides[j];
                    const time2 = ride2.pickupTimestamp || ride2.createdAt || 0;
                    
                    // PrÃ¼fe Ãœberlappung
                    if (time2 < end1) {
                        conflicts.push([i, j]);
                    }
                }
            }
            
            return conflicts;
        }
        
        // Hilfsfunktion: Generiere Timeline-Balken
        function generateTimelineBar(rides, conflicts) {
            if (rides.length === 0) return '';
            
            // Finde Zeitspanne (06:00 - 24:00 Uhr)
            const startHour = 6;
            const endHour = 24;
            const totalMinutes = (endHour - startHour) * 60;
            
            let html = '<div style="position: relative; height: 40px; background: #f3f4f6; border-radius: 8px; overflow: hidden;">';
            
            // Zeitmarkierungen
            html += '<div style="position: absolute; top: 0; left: 0; right: 0; height: 100%; display: flex; justify-content: space-between; padding: 0 4px;">';
            for (let h = startHour; h <= endHour; h += 3) {
                html += `
                    <div style="font-size: 9px; color: #9ca3af; padding-top: 2px;">
                        ${h}:00
                    </div>
                `;
            }
            html += '</div>';
            
            // Fahrten-Balken
            rides.forEach((ride, idx) => {
                const time = new Date(ride.pickupTimestamp || ride.createdAt || 0);
                const hour = time.getHours();
                const minute = time.getMinutes();
                const startMinute = (hour - startHour) * 60 + minute;
                
                const price = parseFloat(ride.price) || 0;
                const duration = price > 0 ? Math.max(15, Math.round(price * 2)) : 30;
                
                const leftPercent = (startMinute / totalMinutes) * 100;
                const widthPercent = (duration / totalMinutes) * 100;
                
                const isConflict = conflicts.some(c => c.includes(idx));
                
                html += `
                    <div style="
                        position: absolute;
                        left: ${leftPercent}%;
                        width: ${widthPercent}%;
                        top: 50%;
                        transform: translateY(-50%);
                        height: 24px;
                        background: ${isConflict ? 'repeating-linear-gradient(45deg, #ef4444, #ef4444 10px, #fca5a5 10px, #fca5a5 20px)' : 'linear-gradient(135deg, #667eea, #764ba2)'};
                        border-radius: 6px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        ${isConflict ? 'border: 2px solid #991b1b; z-index: 10;' : ''}
                    "></div>
                `;
            });
            
            html += '</div>';
            
            return html;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸš• v5.32.5: FAHRZEUG-ZUWEISUNG
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let currentRideForAssignment = null;
        
        async function openVehicleAssignmentModal(rideId) {
            currentRideForAssignment = rideId;
            console.log('ğŸš• Ã–ffne Fahrzeug-Zuweisung fÃ¼r Ride:', rideId);
            
            document.getElementById('vehicle-assignment-modal').style.display = 'flex';
            await loadOnlineVehiclesForAssignment(rideId);
        }
        
        function closeVehicleAssignmentModal() {
            document.getElementById('vehicle-assignment-modal').style.display = 'none';
            currentRideForAssignment = null;
        }
        
        async function loadOnlineVehiclesForAssignment(rideId) {
            const content = document.getElementById('vehicle-assignment-content');
            content.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px 20px;">ğŸ”„ Lade Fahrzeuge...</p>';
            
            try {
                const driversSnapshot = await db.ref('drivers').once('value');
                const drivers = driversSnapshot.val() || {};
                
                const rideSnapshot = await db.ref('rides/' + rideId).once('value');
                const ride = rideSnapshot.val();
                
                if (!ride) {
                    content.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 40px 20px;">âŒ Fahrt nicht gefunden!</p>';
                    return;
                }
                
                let html = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; color: white;">
                        <div style="font-size: 16px; font-weight: 700; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">ğŸ“‹</span>
                            <span>Fahrt-Details</span>
                        </div>
                        
                        <div style="display: grid; gap: 12px;">
                            <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">ğŸ“ Von:</div>
                                <div style="font-weight: 600; font-size: 15px;">${ride.pickup || 'Unbekannt'}</div>
                            </div>
                            
                            <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">ğŸ¯ Nach:</div>
                                <div style="font-weight: 600; font-size: 15px;">${ride.destination || 'Unbekannt'}</div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">ğŸ• Abholung:</div>
                                    <div style="font-weight: 600; font-size: 14px;">${ride.pickupTime || 'Sofort'}</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">ğŸ’° Preis:</div>
                                    <div style="font-weight: 700; font-size: 16px;">${ride.price || 0}â‚¬</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h4 style="margin: 0 0 15px 0; color: #1f2937; font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px;">ğŸš—</span>
                        <span>VerfÃ¼gbare Fahrzeuge</span>
                    </h4>
                `;
                
                const onlineVehicles = [];
                const offlineVehicles = [];
                
                for (const [vehicleId, driver] of Object.entries(drivers)) {
                    if (driver.online) {
                        onlineVehicles.push({ vehicleId, driver });
                    } else {
                        offlineVehicles.push({ vehicleId, driver });
                    }
                }
                
                if (onlineVehicles.length > 0) {
                    onlineVehicles.forEach(({ vehicleId, driver }) => {
                        const lastUpdate = driver.lastUpdate ? new Date(driver.lastUpdate).toLocaleTimeString('de-DE') : 'k.A.';
                        const hasGPS = driver.location && driver.location.latitude && driver.location.longitude;
                        
                        html += `
                            <div style="border: 3px solid #10b981; border-radius: 12px; padding: 16px; margin-bottom: 12px; background: linear-gradient(to right, #d1fae5, #f0fdf4); transition: all 0.3s; cursor: pointer;"
                                 onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(16,185,129,0.3)';"
                                 onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <div style="font-weight: 700; font-size: 18px; color: #1f2937; display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 24px;">ğŸš—</span>
                                        <span>${vehicleId}</span>
                                    </div>
                                    <div style="background: #10b981; color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; letter-spacing: 0.5px;">
                                        âœ… ONLINE
                                    </div>
                                </div>
                                
                                ${hasGPS ? `
                                    <div style="font-size: 12px; color: #059669; margin-bottom: 6px; display: flex; align-items: center; gap: 6px;">
                                        <span>ğŸ“</span>
                                        <span>${driver.location.latitude.toFixed(4)}, ${driver.location.longitude.toFixed(4)}</span>
                                    </div>
                                ` : ''}
                                
                                <div style="font-size: 12px; color: #047857; margin-bottom: 14px; display: flex; align-items: center; gap: 6px;">
                                    <span>ğŸ•</span>
                                    <span>Letztes Update: ${lastUpdate}</span>
                                </div>
                                
                                <button onclick="assignVehicleToRide('${rideId}', '${vehicleId}')" 
                                        style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(102,126,234,0.3);"
                                        onmouseenter="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(102,126,234,0.5)';"
                                        onmouseleave="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(102,126,234,0.3)';">
                                    âœ… Dieses Fahrzeug zuweisen
                                </button>
                            </div>
                        `;
                    });
                } else {
                    html += `
                        <div style="background: linear-gradient(135deg, #fef3c7, #fef9c3); border: 3px solid #f59e0b; border-radius: 12px; padding: 25px; text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">âš ï¸</div>
                            <div style="color: #92400e; font-weight: 700; font-size: 16px; margin-bottom: 6px;">
                                Keine Fahrzeuge online!
                            </div>
                            <div style="color: #78350f; font-size: 13px;">
                                Bitte warte bis ein Fahrer online geht oder weise die Fahrt spÃ¤ter zu.
                            </div>
                        </div>
                    `;
                }
                
                if (offlineVehicles.length > 0) {
                    html += `
                        <h4 style="margin: 20px 0 12px 0; color: #6b7280; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 18px;">âšª</span>
                            <span>Offline Fahrzeuge</span>
                        </h4>
                    `;
                    
                    offlineVehicles.forEach(({ vehicleId }) => {
                        html += `
                            <div style="border: 2px solid #d1d5db; border-radius: 8px; padding: 14px; margin-bottom: 8px; background: #f9fafb; opacity: 0.6;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="font-weight: 600; font-size: 15px; color: #6b7280; display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 20px;">ğŸš—</span>
                                        <span>${vehicleId}</span>
                                    </div>
                                    <div style="background: #9ca3af; color: white; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">
                                        âšª OFFLINE
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                content.innerHTML = html;
                
            } catch (error) {
                console.error('âŒ Fehler beim Laden der Fahrzeuge:', error);
                content.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 40px 20px;">âŒ Fehler beim Laden der Fahrzeuge!</p>';
            }
        }
        
        async function assignVehicleToRide(rideId, vehicleId) {
            console.log('ğŸš• Weise Fahrzeug zu:', vehicleId, 'â†’ Ride:', rideId);
            
            try {
                await db.ref('rides/' + rideId).update({
                    vehicleId: vehicleId,
                    assignedVehicle: vehicleId,
                    assignedAt: Date.now(),
                    status: 'assigned'
                });
                
                await db.ref('rides/' + rideId + '/activityLog').push({
                    type: 'vehicle_assigned',
                    vehicleId: vehicleId,
                    timestamp: Date.now(),
                    message: `Fahrzeug ${vehicleId} zugewiesen (Admin)`
                });
                
                console.log('âœ… Fahrzeug erfolgreich zugewiesen!');
                
                closeVehicleAssignmentModal();
                
                alert(`âœ… Fahrzeug ${vehicleId} erfolgreich zugewiesen!`);
                
                if (typeof loadCalendarData === 'function') {
                    await loadCalendarData();
                }
                
            } catch (error) {
                console.error('âŒ Fehler beim Zuweisen:', error);
                alert('âŒ Fehler beim Zuweisen des Fahrzeugs!');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // EVENT LISTENERS
        window.addEventListener('DOMContentLoaded', () => {
            // ğŸ†• v5.38.5: Debug-Icon initialisieren
            const debugIcon = document.getElementById('debug-icon');
            if (debugIcon) {
                debugIcon.textContent = debugMode ? 'ğŸŸ¢' : 'ğŸ›';
                if (debugMode) {
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    console.log('ğŸŸ¢ DEBUG-MODUS ist AKTIV (aus localStorage)');
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                }
            }
            
            // ğŸ†• v5.34.1: schedule-view zur Liste hinzugefÃ¼gt!
            console.log('ğŸ¬ Initialisiere Views...');
            const allViews = ['passenger-view', 'schedule-view', 'history-view', 'driver-view', 'admin-view'];
            allViews.forEach(viewId => {
                const viewEl = document.getElementById(viewId);
                if (viewEl) {
                    if (viewId === 'passenger-view') {
                        viewEl.style.display = 'block';
                        console.log('âœ… passenger-view sichtbar');
                    } else {
                        viewEl.style.display = 'none';
                        console.log('ğŸš« ' + viewId + ' versteckt');
                    }
                }
            });
            
            // ğŸ” STARTSEITE: Nur Fahrgast anzeigen (bis Login)
            applyRoleRestrictions(null); // null = nicht eingeloggt
            
            // ğŸ†• v5.26.13: Lade gespeicherte Orte
            loadSavedLocations();
            
            // ğŸ†• v5.28.0: Update Anti-Betrugs Badge
            updateAntiFraudBadge();
            
            // ğŸ†• v5.31.5: Lade Admin-Alarm Einstellung
            const disableAlarm = localStorage.getItem('disableAdminAlarm') === 'true';
            const alarmCheckbox = document.getElementById('disable-admin-alarm');
            if (alarmCheckbox) {
                alarmCheckbox.checked = disableAlarm;
            }
            
            // ğŸ¤– v5.32.5h: Lade Auto-Booking Einstellung
            loadAutoBookingSettings();
            
            // ğŸ†• TRACKING-LINK: PrÃ¼fe ob ?ride=XXX in URL
            const urlParams = new URLSearchParams(window.location.search);
            const trackingRideId = urlParams.get('ride');
            if (trackingRideId) {
                console.log('ğŸ”— Tracking-Link erkannt:', trackingRideId);
                // Warte auf Firebase, dann lade Fahrt
                // NICHT sofort localStorage setzen - listenToMyRide entscheidet!
                setTimeout(() => {
                    if (isFirebaseReady) {
                        // PrÃ¼fe erst ob Fahrt noch aktiv ist
                        db.ref('rides/' + trackingRideId).once('value').then(snapshot => {
                            const ride = snapshot.val();
                            if (ride && ride.status !== 'completed' && ride.status !== 'storniert') {
                                // Fahrt ist aktiv - speichern und anzeigen
                                localStorage.setItem('myCurrentRideId', trackingRideId);
                                listenToMyRide(trackingRideId);
                                document.getElementById('booking-form').style.display = 'none';
                            } else {
                                // Fahrt ist beendet - Formular anzeigen
                                console.log('â„¹ï¸ Tracking-Link: Fahrt ist bereits beendet');
                                localStorage.removeItem('myCurrentRideId');
                                document.getElementById('booking-form').style.display = 'block';
                                document.getElementById('ride-status-container').innerHTML = '';
                                // URL Parameter entfernen
                                window.history.replaceState({}, '', window.location.pathname);
                            }
                        });
                    }
                }, 1500);
            } else {
                // ğŸ†• v5.30.3: KEINE Tracking-Link, aber vielleicht gespeicherte Fahrt?
                // PrÃ¼fe localStorage('myCurrentRideId') beim App-Start!
                console.log('ğŸ” PrÃ¼fe auf gespeicherte aktive Fahrt...');
                setTimeout(() => {
                    const savedRideId = localStorage.getItem('myCurrentRideId');
                    if (savedRideId && isFirebaseReady) {
                        console.log('ğŸ“² Gespeicherte Fahrt gefunden:', savedRideId);
                        // PrÃ¼fe ob Fahrt noch aktiv ist
                        db.ref('rides/' + savedRideId).once('value').then(snapshot => {
                            const ride = snapshot.val();
                            if (ride) {
                                ride.firebaseId = savedRideId;
                                
                                // PrÃ¼fe Status
                                const endedStatuses = ['storniert', 'completed', 'cancelled', 'cancelled_pending_driver'];
                                if (endedStatuses.includes(ride.status)) {
                                    console.log('âœ… Gespeicherte Fahrt ist beendet:', ride.status);
                                    localStorage.removeItem('myCurrentRideId');
                                    document.getElementById('booking-form').style.display = 'block';
                                    document.getElementById('ride-status-container').innerHTML = '';
                                } else {
                                    console.log('ğŸš• Gespeicherte Fahrt ist aktiv! Starte Listener...');
                                    myCurrentRide = ride;
                                    document.getElementById('booking-form').style.display = 'none';
                                    showRideStatus(ride);
                                    listenToMyRide(savedRideId); // âœ… LISTENER NEU STARTEN!
                                }
                            } else {
                                // Fahrt existiert nicht mehr
                                console.log('âš ï¸ Gespeicherte Fahrt existiert nicht mehr');
                                localStorage.removeItem('myCurrentRideId');
                                document.getElementById('booking-form').style.display = 'block';
                                document.getElementById('ride-status-container').innerHTML = '';
                            }
                        }).catch(error => {
                            console.error('âŒ Fehler beim Laden der gespeicherten Fahrt:', error);
                            localStorage.removeItem('myCurrentRideId');
                        });
                    } else if (!savedRideId) {
                        console.log('â„¹ï¸ Keine gespeicherte Fahrt gefunden');
                    }
                }, 1500);
            }
            
            // ğŸ› Globaler Error Handler fÃ¼r besseres Debugging
            window.addEventListener('error', (e) => {
                console.error('âŒ FEHLER:', {
                    message: e.message,
                    filename: e.filename,
                    lineno: e.lineno,
                    colno: e.colno,
                    error: e.error
                });
            });
            
            setupAutocomplete();
            
            // ğŸ†• BUTTON-LOGIK: Verstecke "Taxi buchen" wenn Felder geÃ¤ndert werden
            const pickupField = document.getElementById('pickup');
            const destField = document.getElementById('destination');
            const bookBtn = document.getElementById('book-btn');
            
            function hideBookButton() {
                if (bookBtn) {
                    bookBtn.style.display = 'none';
                    bookBtn.style.visibility = 'hidden';
                    console.log('ğŸ”’ "Taxi buchen" versteckt (Felder geÃ¤ndert)');
                }
            }
            
            if (pickupField) {
                pickupField.addEventListener('input', hideBookButton);
            }
            if (destField) {
                destField.addEventListener('input', hideBookButton);
            }
            
            // ğŸ”” PUSH DEAKTIVIERT - Telegram Ã¼bernimmt!
            // if ('Notification' in window && Notification.permission !== 'granted') {
            //     document.getElementById('static-notification-banner').style.display = 'block';
            // }
            
            // ğŸ”” Service Worker DEAKTIVIERT - Telegram Ã¼bernimmt!
            // initServiceWorker();
            
            // ğŸŒŸ Stammkunden-Daten laden
            loadRegularCustomer();
            
            // ğŸ’° Pricing Settings laden
            loadPricingSettings();
            
            // ğŸ”„ VERSION-CHECK lÃ¤uft jetzt automatisch im <head>!
            // âœ… v5.10.0: Auto-Update ENTFERNT - stabiler ohne!
            
            // ğŸ“± Telegram Updates prÃ¼fen (nur fÃ¼r Admins, alle 60 Sek)
            if (userRole === 'admin') {
                checkTelegramUpdates();
                setInterval(checkTelegramUpdates, 60000); // Alle 60 Sekunden
            }
            
            // ğŸ” Zeige Login-Button (wird von Auth Observer aktualisiert)
            try {
                updateUserProfile();
            } catch (error) {
                console.error('âŒ updateUserProfile Fehler:', error);
            }
            
            setTimeout(() => { 
                if (firebaseLoaded && typeof firebase !== 'undefined') initApp(true); 
                else initApp(false); 
                
                // ğŸš— Lade gespeichertes Fahrzeug
                loadSavedVehicle();
            }, 100);
            
            setInterval(() => { 
                if (pickupCoords) showAvailableTaxis(); 
                if (myCurrentRide && myCurrentRide.status === 'accepted') showRideStatus(myCurrentRide);
                
                // ğŸ”§ Wake Lock alle 30 Sek. prÃ¼fen und neu aktivieren
                if (isOnline && wakeLock === null) {
                    console.log('ğŸ”„ Wake Lock reaktivieren...');
                    requestWakeLock();
                }
            }, 30000);
            
            // ğŸ¯ Live-Update fÃ¼r Assignment-Countdown (jede Sekunde)
            setInterval(() => {
                if (currentView === 'driver') {
                    updateViews(); // Aktualisiert Countdown-Timer
                }
            }, 1000);
            
            // ğŸ“± PAGE VISIBILITY: GPS stoppen wenn App geschlossen/im Hintergrund
            document.addEventListener('visibilitychange', () => {
                console.log('ğŸ‘ï¸ Visibility changed:', document.hidden ? 'HIDDEN' : 'VISIBLE');
                
                if (document.hidden) {
                    // App im Hintergrund oder geschlossen
                    console.log('ğŸ“± App geht in Hintergrund...');
                    
                    // ğŸ†• v5.21.2: Logging im Live-Log!
                    logActivity('system', 'visibility', `ğŸ“± App geht in Hintergrund - User: ${currentUser?.email || 'nicht eingeloggt'}`, {
                        isOnline: isOnline,
                        vehicle: currentVehicle,
                        gpsMode: gpsMode
                    });
                    
                    if (watchId && currentVehicle) {
                        console.log('â¸ï¸ Pausiere GPS (App im Hintergrund)');
                        // GPS lÃ¤uft weiter, aber Wake Lock freigeben
                        if (wakeLock) {
                            wakeLock.release();
                            wakeLock = null;
                            console.log('âš ï¸ Wake Lock freigegeben (Hintergrund)');
                        }
                    }
                } else {
                    // App wieder sichtbar
                    console.log('ğŸ“± App wieder sichtbar');
                    
                    // ğŸ†• v5.21.1: Auth-Status prÃ¼fen und loggen!
                    if (auth && auth.currentUser) {
                        console.log('âœ… User noch eingeloggt:', auth.currentUser.email);
                        logActivity('system', 'visibility', `ğŸ“± App wieder aktiv - User: ${auth.currentUser.email}`, {
                            isOnline: isOnline,
                            vehicle: currentVehicle,
                            gpsMode: gpsMode
                        });
                    } else if (auth) {
                        console.log('âš ï¸ User ist NICHT mehr eingeloggt!');
                        logActivity('system', 'visibility', `âš ï¸ App wieder aktiv - KEIN USER!`, {
                            wasOnline: isOnline,
                            vehicle: currentVehicle
                        });
                        
                        // Versuche Session wiederherzustellen
                        console.log('ğŸ”„ Versuche Auth-Session wiederherzustellen...');
                    }
                    
                    // ğŸ†• v5.21.3: PrÃ¼fe ECHTEN Status in Firebase!
                    // Problem: isOnline ist noch true, aber Firebase sagt offline
                    if (currentUser && currentVehicle && isFirebaseReady) {
                        const savedOnline = localStorage.getItem('lastOnlineStatus_' + currentUser.uid);
                        
                        // PrÃ¼fe Firebase-Status
                        db.ref('drivers/' + currentVehicle).once('value').then(snapshot => {
                            const driverData = snapshot.val();
                            const firebaseOnline = driverData && driverData.online === true;
                            
                            console.log('ğŸ” Status-Check: localStorage=' + savedOnline + ', JS=' + isOnline + ', Firebase=' + firebaseOnline);
                            
                            // Wenn localStorage sagt online, aber Firebase sagt offline â†’ wiederherstellen!
                            if (savedOnline === 'true' && !firebaseOnline) {
                                console.log('ğŸ”„ Firebase offline aber sollte online sein â†’ Restore!');
                                
                                // Status wiederherstellen
                                isOnline = true;
                                const toggle = document.getElementById('online-toggle');
                                if (toggle) toggle.checked = true;
                                
                                // In Firebase wieder online setzen
                                const userContact = currentUser.email || currentUser.phoneNumber || 'Unbekannt';
                                const vehicleName = VEHICLES[currentVehicle]?.name || currentVehicle;
                                
                                db.ref('drivers/' + currentVehicle).update({
                                    online: true,
                                    userId: currentUser.uid,
                                    userEmail: userContact,
                                    lastOnline: Date.now()
                                }).then(() => {
                                    console.log('âœ… Fahrer wieder ONLINE in Firebase!');
                                    
                                    // Protokoll
                                    logActivity('driver', 'online', 
                                        `Fahrer ${userContact} (${vehicleName}) ist jetzt ONLINE (Visibility-Restore)`, {
                                        vehicle: currentVehicle,
                                        driver: vehicleName,
                                        email: userContact,
                                        reason: 'visibility_restore'
                                    });
                                });
                                
                                // GPS neu starten
                                if (gpsMode === 'standby' || gpsMode === 'off') {
                                    startStandbyTracking();
                                }
                            } else if (firebaseOnline && !isOnline) {
                                // Firebase sagt online, aber JS sagt offline â†’ JS korrigieren
                                console.log('ğŸ”„ JS offline aber Firebase online â†’ korrigiere JS');
                                isOnline = true;
                                const toggle = document.getElementById('online-toggle');
                                if (toggle) toggle.checked = true;
                            }
                        }).catch(err => {
                            console.error('âŒ Firebase Status-Check Fehler:', err);
                        });
                    }
                    
                    // ğŸ†• v5.21.6: GPS prÃ¼fen und ggf. neu starten
                    if (isOnline && currentVehicle) {
                        console.log('ğŸ”„ App aufgewacht - prÃ¼fe GPS...');
                        console.log('   watchId:', watchId, ', standbyIntervalId:', standbyIntervalId, ', gpsMode:', gpsMode);
                        
                        // PrÃ¼fe ob GPS/Standby noch lÃ¤uft
                        if (standbyIntervalId || watchId) {
                            // GPS lÃ¤uft noch! Nur Position aktualisieren
                            console.log('âœ… GPS/Standby lÃ¤uft noch - hole aktuelle Position');
                            getStandbyPosition();
                        } else {
                            // GPS wurde vom Browser gestoppt - neu starten!
                            console.log('âš ï¸ GPS/Standby wurde gestoppt - starte neu!');
                            startStandbyTracking();
                        }
                    }
                    
                    // Wake Lock reaktivieren
                    if (isOnline && !wakeLock) {
                        requestWakeLock();
                    }
                    
                    // Synchronisiere Toggle-State
                    syncToggleState();
                }
            });
            
            // ğŸšª BEFOREUNLOAD: Nur loggen, NICHT GPS stoppen!
            // ğŸ†• v5.21.6: GPS weiterlaufen lassen im Hintergrund
            // Der Browser stoppt es sowieso wenn er will, aber vielleicht
            // lÃ¤uft es noch 5-10 Minuten weiter und sendet Positionen!
            window.addEventListener('beforeunload', () => {
                console.log('ğŸšª App geht in Hintergrund - GPS lÃ¤uft weiter!');
                
                // ğŸ“œ PROTOKOLL: Nur loggen
                if (currentVehicle && isOnline) {
                    const vehicleName = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle;
                    const userContact = currentUser ? (currentUser.email || currentUser.phoneNumber || 'Unbekannt') : 'Unbekannt';
                    
                    logActivity('system', 'background', 
                        `ğŸ“± App-Wechsel: ${userContact} (${vehicleName}) - GPS lÃ¤uft weiter`, {
                        vehicle: currentVehicle,
                        driver: vehicleName,
                        email: userContact,
                        reason: 'beforeunload',
                        gpsMode: gpsMode,
                        watchId: watchId ? 'aktiv' : 'inaktiv'
                    });
                }
                
                // ğŸ†• v5.21.6: GPS NICHT stoppen!
                // Lass es weiterlaufen - der Browser entscheidet wann es stoppt
                console.log('â„¹ï¸ GPS bleibt aktiv (watchId:', watchId, ', gpsMode:', gpsMode, ')');
                
                // Wake Lock freigeben (das mÃ¼ssen wir)
                if (wakeLock) {
                    wakeLock.release();
                    console.log('âš ï¸ Wake Lock freigegeben');
                }
            });
            
            // ğŸ†• v5.21.6: GPS-HEALTH-CHECK alle 5 Minuten
            // PrÃ¼ft ob GPS noch sendet und startet es ggf. neu
            setInterval(() => {
                if (!isOnline || !currentVehicle || !currentUser) return;
                
                const now = Date.now();
                const timeSinceLastGps = lastGPSUpdate ? (now - lastGPSUpdate) / 1000 / 60 : 999; // in Minuten
                
                console.log(`ğŸ” GPS-Health-Check: Letzte GPS-Sendung vor ${timeSinceLastGps.toFixed(1)} Min`);
                console.log(`   standbyIntervalId: ${standbyIntervalId ? 'aktiv' : 'INAKTIV'}, watchId: ${watchId ? 'aktiv' : 'inaktiv'}`);
                
                // Wenn GPS lÃ¤nger als 4 Minuten nicht gesendet hat ODER kein Interval lÃ¤uft â†’ neu starten!
                if (timeSinceLastGps > 4 || (!standbyIntervalId && !watchId)) {
                    console.log('âš ï¸ GPS-Problem erkannt! Starte neu...');
                    
                    logActivity('gps', 'restart', 
                        `ğŸ”„ GPS-Neustart: ${!standbyIntervalId ? 'Interval gestoppt' : 'Position ' + timeSinceLastGps.toFixed(0) + ' Min alt'}`, {
                        vehicle: currentVehicle,
                        lastGps: lastGPSUpdate,
                        timeSinceLastGps: timeSinceLastGps.toFixed(1),
                        standbyActive: !!standbyIntervalId,
                        watchActive: !!watchId
                    });
                    
                    // GPS komplett neu starten
                    if (watchId) {
                        navigator.geolocation.clearWatch(watchId);
                        watchId = null;
                    }
                    if (standbyIntervalId) {
                        clearInterval(standbyIntervalId);
                        standbyIntervalId = null;
                    }
                    
                    // Standby-Tracking neu starten
                    startStandbyTracking();
                    console.log('âœ… GPS neu gestartet!');
                } else {
                    console.log('âœ… GPS OK - lÃ¤uft normal');
                }
            }, 5 * 60 * 1000); // Alle 5 Minuten
            
            // ğŸ“… VORBESTELLUNGS-CHECK: PrÃ¼fe alle 60 Sek. ob Vorbestellungen aktiviert werden mÃ¼ssen
            setInterval(async () => {
                if (!isFirebaseReady) return;
                
                try {
                    const snapshot = await db.ref('rides').orderByChild('status').equalTo('vorbestellt').once('value');
                    if (!snapshot.exists()) return;
                    
                    const now = Date.now();
                    snapshot.forEach(async (childSnapshot) => {
                        const ride = childSnapshot.val();
                        const rideId = childSnapshot.key;
                        
                        // ğŸ›¡ï¸ SICHERHEITS-CHECKS: Verhindere doppelte Aktivierung
                        
                        // Check 1: Wurde schon aktiviert?
                        if (ride.activatedAt) {
                            console.log('â­ï¸ Vorbestellung bereits aktiviert, Ã¼berspringe:', rideId);
                            return;
                        }
                        
                        // Check 2: Status wirklich "vorbestellt"?
                        if (ride.status !== 'vorbestellt') {
                            console.log('â­ï¸ Status nicht mehr "vorbestellt", Ã¼berspringe:', rideId, ride.status);
                            return;
                        }
                        
                        // Check 3: Nicht completed/cancelled?
                        if (ride.status === 'completed' || ride.status === 'cancelled' || ride.status === 'storniert' || ride.status === 'abgeschlossen') {
                            console.log('â­ï¸ Fahrt bereits abgeschlossen, Ã¼berspringe:', rideId);
                            return;
                        }
                        
                        // PrÃ¼fe ob Abholzeit in â‰¤ 15 Min
                        if (ride.pickupTimestamp) {
                            const minutesUntilPickup = (ride.pickupTimestamp - now) / (1000 * 60);
                            
                            if (minutesUntilPickup <= 15 && minutesUntilPickup > 0) {
                                console.log('ğŸ“… Vorbestellung wird aktiviert:', rideId, 'noch', minutesUntilPickup.toFixed(1), 'Min');
                                
                                // Status auf "new" setzen â†’ Fahrer bekommen Benachrichtigung
                                await db.ref('rides/' + rideId).update({
                                    status: 'new',
                                    activatedAt: Date.now()
                                });
                                
                                // ğŸ¯ STARTE AUTO-ASSIGNMENT fÃ¼r aktivierte Vorbestellung
                                const updatedRide = { ...ride, status: 'new', firebaseId: rideId };
                                startAutoAssignment(rideId, updatedRide);
                                console.log('ğŸ¯ Auto-Assignment gestartet fÃ¼r aktivierte Vorbestellung:', rideId);
                            } else if (minutesUntilPickup <= 0) {
                                console.log('â° Vorbestellung ist Ã¼berfÃ¤llig:', rideId, 'war vor', Math.abs(minutesUntilPickup).toFixed(1), 'Min');
                            }
                        }
                    });
                } catch (error) {
                    console.error('âŒ Fehler beim Vorbestellungs-Check:', error);
                }
            }, 60000); // Alle 60 Sekunden
            
            // ğŸ†• v5.21.6: GPS-WATCHDOG - PrÃ¼ft alle 5 Min ob GPS noch funktioniert
            setInterval(() => {
                // Nur fÃ¼r Online-Fahrer relevant
                if (!isOnline || !currentVehicle || currentView !== 'driver') return;
                
                console.log('ğŸ” GPS-Watchdog: PrÃ¼fe GPS-Status... (watchId:', watchId, ', gpsMode:', gpsMode, ')');
                
                // Wenn GPS aus ist aber Fahrer online â†’ neu starten!
                if (!watchId) {
                    console.log('âš ï¸ GPS-Watchdog: GPS ist aus - starte neu!');
                    startStandbyTracking();
                    
                    logActivity('gps', 'watchdog', 
                        `ğŸ”„ GPS-Watchdog: GPS war aus, wurde neu gestartet`, {
                        vehicle: currentVehicle,
                        gpsMode: gpsMode
                    });
                } else {
                    // GPS lÃ¤uft - hole aktuelle Position
                    console.log('âœ… GPS-Watchdog: GPS lÃ¤uft - aktualisiere Position');
                    getStandbyPosition();
                }
                
                // PrÃ¼fe auch ob letzte Position zu alt ist
                if (currentVehicle && isFirebaseReady) {
                    db.ref('drivers/' + currentVehicle + '/timestamp').once('value').then(snapshot => {
                        const lastTimestamp = snapshot.val();
                        if (lastTimestamp) {
                            const ageMinutes = (Date.now() - lastTimestamp) / (1000 * 60);
                            console.log('ğŸ“Š GPS-Watchdog: Letzte Position ist', ageMinutes.toFixed(1), 'Min alt');
                            
                            if (ageMinutes > 5) {
                                console.log('âš ï¸ GPS ist zu alt! Erzwinge neue Position...');
                                // Erzwinge neue Position
                                navigator.geolocation.getCurrentPosition(
                                    (pos) => {
                                        sendDriverLocation(pos);
                                        console.log('âœ… Neue Position erzwungen!');
                                    },
                                    (err) => {
                                        console.error('âŒ GPS-Fehler:', err.message);
                                    },
                                    { enableHighAccuracy: false, timeout: 10000, maximumAge: 0 }
                                );
                            }
                        }
                    });
                }
            }, 5 * 60 * 1000); // Alle 5 Minuten
            
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    console.log('ğŸ“± App wieder sichtbar - prÃ¼fe Wake Lock');
                    if (isOnline && (wakeLock === null || wakeLock.released)) {
                        console.log('ğŸ”„ Reaktiviere Wake Lock');
                        requestWakeLock();
                    }
                    // GPS-Position auch neu senden wenn Fahrer online
                    if (isOnline && currentView === 'driver' && watchId) {
                        navigator.geolocation.getCurrentPosition(sendDriverLocation);
                    }
                }
            });
            
            // ğŸ“± ZusÃ¤tzliche Wake Lock Reaktivierung bei User-Interaktion
            ['focus', 'touchstart', 'click'].forEach(eventType => {
                document.addEventListener(eventType, () => {
                    if (isOnline && currentView === 'driver' && (wakeLock === null || wakeLock.released)) {
                        console.log('ğŸ‘† User-Interaktion erkannt - reaktiviere Wake Lock');
                        requestWakeLock();
                    }
                }, { once: false, passive: true });
            });
        });
        
        // ğŸ†• v5.33.4: AGGRESSIVE VIEW-BEREINIGUNG - Mehrfach ausfÃ¼hren!
        window.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ v5.33.4: Aggressive View-Bereinigung...');
            
            function forcePassengerViewOnly() {
                // Verstecke ALLE Views brutal!
                const allViews = ['passenger-view', 'schedule-view', 'history-view', 'driver-view', 'admin-view'];
                allViews.forEach(viewId => {
                    const viewEl = document.getElementById(viewId);
                    if (viewEl) {
                        viewEl.style.display = 'none';
                        viewEl.style.visibility = 'hidden';
                        viewEl.classList.remove('active');
                    }
                });
                
                // Zeige NUR passenger-view
                const passengerView = document.getElementById('passenger-view');
                if (passengerView) {
                    passengerView.style.display = 'block';
                    passengerView.style.visibility = 'visible';
                    passengerView.classList.add('active');
                    console.log('âœ… Passenger-View erzwungen');
                }
                
                // Setze passenger tab als aktiv
                const passengerTab = document.querySelector('.admin-tab-btn[data-view="passenger"]');
                if (passengerTab) {
                    passengerTab.classList.add('active');
                }
            }
            
            // MEHRFACH ausfÃ¼hren um SICHER zu sein!
            forcePassengerViewOnly(); // Sofort
            setTimeout(forcePassengerViewOnly, 100); // Nach 100ms
            setTimeout(forcePassengerViewOnly, 500); // Nach 500ms
            setTimeout(forcePassengerViewOnly, 1000); // Nach 1s
            setTimeout(forcePassengerViewOnly, 2000); // Nach 2s
            
            console.log('ğŸ”’ View-Lock aktiviert - Passenger-View erzwungen!');
        });
        
        // ğŸ†• v5.33.4: VIEW-GUARD - Ãœberwacht dass nur aktive View sichtbar ist!
        setInterval(() => {
            const allViews = ['passenger-view', 'schedule-view', 'history-view', 'driver-view', 'admin-view'];
            
            allViews.forEach(viewId => {
                const viewEl = document.getElementById(viewId);
                if (!viewEl) return;
                
                // PrÃ¼fe ob View sichtbar ist obwohl sie nicht aktiv ist
                const isVisible = window.getComputedStyle(viewEl).display !== 'none';
                const isActive = viewEl.classList.contains('active');
                
                if (isVisible && !isActive) {
                    // View ist sichtbar aber nicht aktiv - VERSTECKEN!
                    console.warn('âš ï¸ View-Guard: Verstecke inaktive View:', viewId);
                    viewEl.style.display = 'none';
                    viewEl.style.visibility = 'hidden';
                }
            });
        }, 2000); // Alle 2 Sekunden prÃ¼fen
    </script>
    <!-- ğŸ” LOGIN MODAL -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ğŸ” Anmelden</div>
            
            <!-- Tab-Auswahl -->
            <div style="display:flex;margin-bottom:15px;border-radius:8px;overflow:hidden;border:2px solid #e0e0e0;">
                <button id="login-tab-email" onclick="switchLoginTab('email')" style="flex:1;padding:10px;border:none;background:#667eea;color:white;font-weight:600;cursor:pointer;">
                    âœ‰ï¸ E-Mail
                </button>
                <button id="login-tab-phone" onclick="switchLoginTab('phone')" style="flex:1;padding:10px;border:none;background:#f3f4f6;color:#333;font-weight:600;cursor:pointer;">
                    ğŸ“± Telefon
                </button>
            </div>
            
            <!-- E-Mail Login -->
            <div id="login-email-section">
                <button class="modal-btn btn-google" onclick="loginWithGoogle()">
                    <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Mit Google anmelden
                </button>
                
                <div class="modal-divider">oder</div>
                
                <input type="email" id="login-email" class="modal-input" placeholder="E-Mail">
                <input type="password" id="login-password" class="modal-input" placeholder="Passwort">
                
                <button class="modal-btn btn-primary-modal" onclick="loginWithEmail()">Anmelden</button>
                
                <div class="modal-link" onclick="showRegisterModal()">Noch kein Konto? Jetzt registrieren</div>
            </div>
            
            <!-- ğŸ“± Telefon Login (NEU!) -->
            <div id="login-phone-section" style="display:none;">
                <div style="text-align:center;margin-bottom:15px;">
                    <div style="font-size:40px;margin-bottom:5px;">ğŸ“±</div>
                    <div style="color:#666;font-size:13px;">Melde dich mit deiner Telefonnummer an.<br>Du erhÃ¤ltst einen SMS-Code.</div>
                </div>
                
                <!-- Schritt 1: Telefonnummer -->
                <div id="phone-step-1">
                    <div style="display:flex;gap:8px;margin-bottom:10px;">
                        <select id="phone-country" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
                            <option value="+49">ğŸ‡©ğŸ‡ª +49</option>
                            <option value="+43">ğŸ‡¦ğŸ‡¹ +43</option>
                            <option value="+41">ğŸ‡¨ğŸ‡­ +41</option>
                        </select>
                        <input type="tel" id="phone-number" class="modal-input" placeholder="170 1234567" style="flex:1;margin:0;">
                    </div>
                    
                    <!-- reCAPTCHA Container (invisible - lÃ¤uft im Hintergrund) -->
                    <div id="login-recaptcha-container"></div>
                    
                    <button id="send-code-btn" class="modal-btn btn-primary-modal" onclick="sendPhoneCode()" style="background:#10b981;">
                        ğŸ“² SMS-Code senden
                    </button>
                </div>
                
                <!-- Schritt 2: Code eingeben -->
                <div id="phone-step-2" style="display:none;">
                    <div style="text-align:center;margin-bottom:15px;">
                        <div style="color:#666;font-size:13px;">SMS-Code wurde gesendet an:</div>
                        <div style="font-weight:600;" id="phone-display"></div>
                    </div>
                    
                    <input type="text" id="phone-code" class="modal-input" placeholder="6-stelliger Code" maxlength="6" style="text-align:center;font-size:20px;letter-spacing:8px;">
                    
                    <button class="modal-btn btn-primary-modal" onclick="verifyPhoneCode()" style="background:#10b981;">
                        âœ… Code bestÃ¤tigen
                    </button>
                    
                    <div class="modal-link" onclick="resetPhoneLogin()">â† Andere Nummer verwenden</div>
                </div>
            </div>
            
            <div class="modal-link" onclick="closeLoginModal()">Abbrechen</div>
        </div>
    </div>
    
    <!-- ğŸ“ REGISTER MODAL -->
    <div id="register-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ğŸ“ Registrieren</div>
            
            <input type="text" id="register-name" class="modal-input" placeholder="Name">
            <input type="email" id="register-email" class="modal-input" placeholder="E-Mail">
            <input type="password" id="register-password" class="modal-input" placeholder="Passwort">
            
            <button class="modal-btn btn-primary-modal" onclick="registerWithEmail()">Registrieren</button>
            
            <div class="modal-link" onclick="showLoginModal()">Bereits ein Konto? Anmelden</div>
            <div class="modal-link" onclick="closeRegisterModal()">Abbrechen</div>
        </div>
    </div>

    <!-- ğŸš• v5.32.5: FAHRZEUG-ZUWEISUNG MODAL -->
    <div id="vehicle-assignment-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 550px; max-height: 85vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e5e7eb;">
                <h3 style="margin: 0; color: #1f2937; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 28px;">ğŸš•</span>
                    <span>Fahrzeug zuweisen</span>
                </h3>
                <button onclick="closeVehicleAssignmentModal()" 
                        style="background: none; border: none; font-size: 32px; cursor: pointer; color: #9ca3af; line-height: 1; padding: 0; transition: color 0.2s;"
                        onmouseenter="this.style.color='#ef4444'" 
                        onmouseleave="this.style.color='#9ca3af'">
                    Ã—
                </button>
            </div>
            
            <div id="vehicle-assignment-content">
                <!-- Wird dynamisch gefÃ¼llt -->
            </div>
        </div>
    </div>

    <!-- ğŸ“± v5.24.0: External JavaScript -->
    <script src="improved-gps-tracking.js"></script>
    <script src="driver-settings-manager.js"></script>

    <!-- ğŸ“… VORBESTELL-ÃœBERSICHTS-MODAL -->
    <div id="preorder-summary-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="color: #10b981;">
                ğŸ“… Vorbestellung bestÃ¤tigt
            </div>
            
            <div id="preorder-summary-content" style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <!-- Wird dynamisch gefÃ¼llt -->
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="closePreorderSummary()" class="modal-btn" style="flex: 1; background: #10b981; color: white;">
                    âœ… OK
                </button>
                <button onclick="editPreorder()" class="modal-btn" style="flex: 1; background: #3b82f6; color: white;">
                    âœï¸ Bearbeiten
                </button>
            </div>
        </div>
    </div>

    <!-- ğŸ¤– AUTO-BOOKING MODAL: ALTERNATIV-VORSCHLÃ„GE -->
    <div id="auto-booking-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="color: #f59e0b;">
                âš ï¸ Zeitslot belegt
            </div>
            
            <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
                <div style="font-weight: 600; color: #92400e; margin-bottom: 5px;">
                    ğŸ• <span id="requested-time-display"></span> ist bereits belegt
                </div>
                <div style="font-size: 13px; color: #78350f;">
                    Ein anderes Taxi ist zu dieser Zeit unterwegs
                </div>
            </div>
            
            <div style="font-weight: 600; font-size: 16px; margin-bottom: 15px; color: #1f2937;">
                ğŸ’¡ Alternative Zeiten:
            </div>
            
            <div id="alternative-times-container" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
                <!-- Wird dynamisch gefÃ¼llt -->
            </div>
            
            <!-- ğŸ“ v5.32.5i: TELEFON-OPTION -->
            <div style="margin: 20px 0; padding: 15px 0; border-top: 2px solid #e5e7eb; border-bottom: 2px solid #e5e7eb;">
                <div style="text-align: center; margin-bottom: 12px;">
                    <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">
                        â“ Keine Zeit passend?
                    </div>
                    <div style="font-weight: 600; font-size: 15px; color: #1f2937; margin-bottom: 12px;">
                        Rufen Sie uns an:
                    </div>
                    <a href="tel:038378" 
                       style="display: inline-block; padding: 15px 30px; background: linear-gradient(135deg, #10b981, #059669); color: white; text-decoration: none; border-radius: 12px; font-weight: 700; font-size: 20px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); transition: all 0.2s;"
                       onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 16px rgba(16, 185, 129, 0.4)'"
                       onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'">
                        ğŸ“ 038378 / 1234
                    </a>
                    <div style="font-size: 12px; color: #6b7280; margin-top: 8px;">
                        Wir helfen Ihnen gerne weiter!
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="closeAutoBookingModal()" class="modal-btn" style="flex: 1; background: #6b7280; color: white;">
                    âŒ Abbrechen
                </button>
                <button onclick="showCustomTimeSelection()" class="modal-btn" style="flex: 1; background: #3b82f6; color: white;">
                    âœï¸ Andere Zeit
                </button>
            </div>
        </div>
    </div>

    <!-- ğŸ†• v5.38.5: DEBUG-TOGGLE BUTTON (Footer - diskret) -->
    <div id="debug-toggle-footer" style="
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 50;
    ">
        <button onclick="toggleDebugMode()" style="
            background: rgba(0,0,0,0.6);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 10px;
            cursor: pointer;
            font-weight: 600;
            backdrop-filter: blur(10px);
        ">
            <span id="debug-icon">ğŸ›</span> Debug
        </button>
    </div>

</body>
</html>
