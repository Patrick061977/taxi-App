<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Taxi HGW">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <title>Funk Taxi Heringsdorf</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 22px; margin-bottom: 5px; }
        .status-row { display: flex; justify-content: center; gap: 20px; margin-top: 8px; font-size: 11px; }
        .status-item { display: flex; align-items: center; gap: 8px; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #f59e0b; }
        .sync-dot.online { background: #10b981; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        #gps-indicator { display: none; align-items: center; gap: 8px; font-size: 11px; }
        #gps-dot { width: 8px; height: 8px; border-radius: 50%; background: #6b7280; }
        #gps-dot.online { background: #10b981; animation: pulse 2s infinite; }
        .view-selector { display: flex; background: white; border-bottom: 2px solid #e0e0e0; position: sticky; top: 90px; z-index: 99; }
        .view-btn { flex: 1; padding: 15px; border: none; background: white; font-size: 14px; cursor: pointer; }
        .view-btn.active { color: #667eea; border-bottom: 3px solid #667eea; }
        .view { display: none; padding: 15px; }
        .view.active { display: block; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }
        .input-group input, .input-group select { width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; }
        .btn { padding: 15px 25px; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; width: 100%; }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #10b981; color: white; }
        .alert-success { background: #d1fae5; border: 2px solid #10b981; padding: 15px; border-radius: 8px; margin-bottom: 15px; color: #065f46; }
        .alert-info { background: #dbeafe; border: 2px solid #3b82f6; padding: 15px; border-radius: 8px; margin-bottom: 15px; color: #1e40af; }
        .ride-card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #e0e0e0; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0; }
        .online-toggle { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e0e0e0; }
        .toggle-switch { position: relative; width: 60px; height: 34px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(26px); }
        .available-taxis { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #10b981; }
        .taxi-item { padding: 10px; background: #f0f9ff; border-radius: 6px; margin-top: 8px; }
        #map { height: 300px; border-radius: 8px; margin-top: 15px; }
        .ride-status-box { background: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 15px; }
        .eta-display { font-size: 32px; font-weight: bold; margin: 15px 0; }
        .eta-display.green { color: #10b981; }
        .eta-display.yellow { color: #f59e0b; }
        .eta-display.red { color: #ef4444; }
        .progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin: 15px 0; }
        .progress-fill { height: 100%; transition: width 0.3s ease; }
        .autocomplete-dropdown { position: relative; background: white; border: 1px solid #e0e0e0; border-radius: 4px; margin-top: 4px; max-height: 200px; overflow-y: auto; display: none; }
        .autocomplete-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .autocomplete-item:hover { background: #f0f9ff; }
        
        /* DRIVER MAP STYLES */
        #driver-map { height: 450px; border-radius: 12px; margin: 15px 0; border: 3px solid #667eea; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .route-info-box { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .route-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px; }
        .route-stat { text-align: center; padding: 12px; background: rgba(255,255,255,0.2); border-radius: 8px; backdrop-filter: blur(10px); }
        .route-stat-value { font-size: 28px; font-weight: bold; color: white; }
        .route-stat-label { font-size: 12px; color: rgba(255,255,255,0.9); margin-top: 4px; }
        
        /* LOGIN MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; backdrop-filter: blur(5px); }
        .modal-overlay.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 16px; max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .modal-header { text-align: center; margin-bottom: 25px; }
        .modal-header h2 { font-size: 24px; margin-bottom: 8px; }
        .modal-close { position: absolute; top: 15px; right: 15px; font-size: 28px; cursor: pointer; color: #999; }
        .auth-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .auth-tab { flex: 1; padding: 12px; border: none; background: #f0f0f0; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .auth-tab.active { background: #667eea; color: white; }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .social-login { margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0; }
        .btn-google { background: white; color: #333; border: 2px solid #e0e0e0; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-google:hover { background: #f5f5f5; }
        .divider { text-align: center; margin: 15px 0; color: #999; position: relative; }
        .divider:before, .divider:after { content: ''; position: absolute; top: 50%; width: 45%; height: 1px; background: #e0e0e0; }
        .divider:before { left: 0; }
        .divider:after { right: 0; }
        .user-profile { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; gap: 15px; border: 1px solid #e0e0e0; }
        .user-avatar { width: 50px; height: 50px; border-radius: 50%; background: #667eea; color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; }
        .user-info { flex: 1; }
        .btn-logout { background: #ef4444; padding: 8px 15px; font-size: 13px; }
        
        /* UBER-STYLE BOOKING INTERFACE */
        .uber-container { position: relative; height: calc(100vh - 200px); min-height: 500px; }
        .uber-map { width: 100%; height: 100%; border-radius: 0; }
        .uber-overlay { position: absolute; top: 0; left: 0; right: 0; padding: 15px; z-index: 400; pointer-events: none; }
        .uber-overlay > * { pointer-events: auto; }
        .location-box { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 12px rgba(0,0,0,0.15); }
        .location-input { display: flex; align-items: center; gap: 12px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; background: #f9fafb; }
        .location-input input { border: none; background: none; flex: 1; font-size: 15px; outline: none; }
        .location-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
        .location-dot.pickup { background: #10b981; }
        .location-dot.dest { background: #667eea; }
        .uber-bottom { position: absolute; bottom: 0; left: 0; right: 0; background: white; border-radius: 20px 20px 0 0; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); max-height: 70%; overflow-y: auto; }
        .uber-handle { width: 40px; height: 4px; background: #d1d5db; border-radius: 2px; margin: 12px auto; }
        .vehicle-option { display: flex; align-items: center; gap: 15px; padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.2s; }
        .vehicle-option:hover { background: #f9fafb; }
        .vehicle-option.selected { background: #eff6ff; border-left: 4px solid #667eea; }
        .vehicle-icon { font-size: 32px; width: 50px; text-align: center; }
        .vehicle-info { flex: 1; }
        .vehicle-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        .vehicle-details { font-size: 13px; color: #6b7280; }
        .vehicle-price { font-size: 18px; font-weight: 700; color: #1f2937; }
        .vehicle-eta { font-size: 12px; color: #10b981; margin-top: 4px; }
        .payment-selector { padding: 15px; border-top: 1px solid #e5e7eb; }
        .payment-option { display: flex; align-items: center; gap: 12px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; margin-bottom: 8px; cursor: pointer; }
        .payment-option.selected { border-color: #667eea; background: #eff6ff; }
        .payment-icon { font-size: 24px; }
        .payment-label { flex: 1; font-size: 14px; font-weight: 500; }
        .book-button { background: #000; color: white; padding: 18px; border-radius: 12px; font-size: 16px; font-weight: 600; margin: 15px; border: none; cursor: pointer; }
        .book-button:active { background: #1f2937; }
        .price-breakdown { padding: 15px; background: #f9fafb; border-radius: 8px; margin: 15px; font-size: 13px; }
        .price-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .price-row.total { font-size: 16px; font-weight: 700; padding-top: 8px; border-top: 1px solid #e5e7eb; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöï Funk Taxi Heringsdorf</h1>
        <p style="font-size: 11px; opacity: 0.8;">Version 4.1.0 - Uber-Style üé®</p>
        <div class="status-row">
            <div class="status-item">
                <div class="sync-dot" id="sync-dot"></div>
                <span id="sync-status">üíæ Lokal</span>
            </div>
            <div class="status-item" id="gps-indicator">
                <div id="gps-dot"></div>
                <span id="gps-status">üìç GPS Off</span>
            </div>
        </div>
    </div>

    <div class="view-selector">
        <button class="view-btn active" onclick="switchView('passenger')">Fahrgast</button>
        <button class="view-btn" onclick="switchView('history')">Verlauf</button>
        <button class="view-btn" onclick="switchView('driver')">Fahrer</button>
        <button class="view-btn" onclick="switchView('admin')">Admin</button>
    </div>

    <!-- üîî BENACHRICHTIGUNGS-BANNER -->
    <div id="static-notification-banner" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;text-align:center;display:none;">
        <div style="font-size:48px;margin-bottom:10px;">üîî</div>
        <div style="margin-bottom:15px;">
            <strong style="font-size:18px;">Benachrichtigungen aktivieren?</strong><br>
            <span style="font-size:14px;opacity:0.9;margin-top:5px;display:block;">Erhalte sofort Push-Benachrichtigungen bei neuen Buchungen!</span>
        </div>
        <button onclick="requestNotificationPermission()" style="background:white;color:#667eea;border:none;padding:14px 24px;border-radius:8px;font-weight:700;cursor:pointer;margin-right:10px;font-size:15px;box-shadow:0 2px 8px rgba(0,0,0,0.2);">‚úì Jetzt aktivieren</button>
        <button onclick="document.getElementById('static-notification-banner').style.display='none'" style="background:rgba(255,255,255,0.2);color:white;border:2px solid white;padding:14px 24px;border-radius:8px;font-weight:600;cursor:pointer;font-size:15px;">Sp√§ter</button>
    </div>

    <div id="passenger-view" class="view active">
        <!-- üåü STAMMKUNDEN-SCHNELLBUCHUNG -->
        <div id="regular-customer-box" style="display:none;background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:15px;border-radius:12px;margin:15px;margin-bottom:10px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <strong style="font-size:16px;">‚≠ê Willkommen zur√ºck!</strong>
                <button onclick="clearRegularCustomer()" style="background:rgba(255,255,255,0.2);border:none;color:white;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px;">‚ùå</button>
            </div>
            <div id="regular-customer-info" style="font-size:14px;margin-bottom:10px;"></div>
            <button onclick="useRegularCustomerData()" style="background:white;color:#667eea;border:none;padding:12px;border-radius:8px;font-weight:600;cursor:pointer;width:100%;">‚ö° Schnellbuchung starten</button>
        </div>

        <!-- üéØ UBER-STYLE BOOKING INTERFACE -->
        <div class="uber-container" id="uber-booking-interface" style="display:block;">
            <!-- Karte als Hintergrund -->
            <div id="uber-map" class="uber-map"></div>
            
            <!-- Location Eingaben √ºber der Karte -->
            <div class="uber-overlay">
                <div class="location-box">
                    <div class="location-input" onclick="focusInput('pickup-uber')">
                        <div class="location-dot pickup"></div>
                        <input type="text" id="pickup-uber" placeholder="Abholort eingeben" style="width:100%;">
                    </div>
                    <div style="height:8px;"></div>
                    <div class="location-input" onclick="focusInput('destination-uber')">
                        <div class="location-dot dest"></div>
                        <input type="text" id="destination-uber" placeholder="Wohin m√∂chten Sie?" style="width:100%;">
                    </div>
                    <button onclick="useMyLocation()" style="margin-top:12px;padding:12px;border:2px solid #3b82f6;background:#dbeafe;color:#1e40af;border-radius:8px;font-weight:600;cursor:pointer;width:100%;font-size:14px;">
                        üìç Meinen Standort verwenden
                    </button>
                </div>
            </div>
            
            <!-- Bottom Sheet mit Fahrzeugauswahl -->
            <div class="uber-bottom" id="uber-bottom-sheet" style="display:none;">
                <div class="uber-handle"></div>
                
                <div style="padding:0 15px 15px 15px;">
                    <h3 style="margin-bottom:15px;font-size:18px;">Fahrzeug w√§hlen</h3>
                    
                    <!-- Fahrzeug-Optionen -->
                    <div id="vehicle-options-container">
                        <!-- Wird dynamisch gef√ºllt -->
                    </div>
                    
                    <!-- Zahlungsmethode -->
                    <div class="payment-selector">
                        <h4 style="margin-bottom:12px;font-size:15px;">üí≥ Zahlungsmethode</h4>
                        <div class="payment-option selected" onclick="selectPayment('cash')" data-payment="cash">
                            <div class="payment-icon">üí∂</div>
                            <div class="payment-label">Bargeld</div>
                            <div style="color:#667eea;font-weight:600;">‚úì</div>
                        </div>
                        <div class="payment-option" onclick="selectPayment('ec')" data-payment="ec">
                            <div class="payment-icon">üí≥</div>
                            <div class="payment-label">EC-Karte</div>
                        </div>
                        <div class="payment-option" onclick="selectPayment('credit')" data-payment="credit">
                            <div class="payment-icon">üí≥</div>
                            <div class="payment-label">Kreditkarte</div>
                        </div>
                        <div class="payment-option" onclick="selectPayment('invoice')" data-payment="invoice">
                            <div class="payment-icon">üè¢</div>
                            <div class="payment-label">Firmenrechnung</div>
                        </div>
                        <div class="payment-option" onclick="selectPayment('insurance')" data-payment="insurance">
                            <div class="payment-icon">üè•</div>
                            <div class="payment-label">Krankenkasse</div>
                        </div>
                    </div>
                    
                    <!-- Name -->
                    <div style="margin-top:15px;">
                        <label style="display:block;margin-bottom:8px;font-weight:600;font-size:14px;">üë§ Ihr Name</label>
                        <input type="text" id="customer-name-uber" placeholder="Max Mustermann" style="width:100%;padding:14px;border:2px solid #e0e0e0;border-radius:8px;font-size:15px;">
                        <label style="display:flex;align-items:center;gap:8px;font-size:13px;margin-top:8px;cursor:pointer;">
                            <input type="checkbox" id="save-customer-uber" style="width:auto;">
                            <span>üíæ Als Stammkunde speichern</span>
                        </label>
                    </div>
                    
                    <!-- Preis-Breakdown -->
                    <div class="price-breakdown" id="price-breakdown-uber" style="display:none;">
                        <div class="price-row">
                            <span>Grundgeb√ºhr</span>
                            <span id="price-base">4,00‚Ç¨</span>
                        </div>
                        <div class="price-row">
                            <span id="price-distance-label">Strecke (0 km)</span>
                            <span id="price-distance-value">0,00‚Ç¨</span>
                        </div>
                        <div class="price-row" id="price-surcharge-row" style="display:none;">
                            <span id="price-surcharge-label">Zuschlag</span>
                            <span id="price-surcharge-value">0,00‚Ç¨</span>
                        </div>
                        <div class="price-row total">
                            <span>Gesamt</span>
                            <span id="price-total-uber">0,00‚Ç¨</span>
                        </div>
                    </div>
                    
                    <!-- Buchen Button -->
                    <button class="book-button" id="uber-book-button" onclick="bookUber()" style="display:none;">
                        Taxi buchen
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Fahrt-Status (wird bei aktiver Fahrt angezeigt) -->
        <div id="ride-status-container"></div>
        <div id="confirm"></div>
    </div>

    <div id="history-view" class="view">
        <h3 style="margin: 20px 0;">Meine Fahrten</h3>
        <div id="history-list"></div>
    </div>

    <div id="driver-view" class="view">
        <h3 style="margin: 20px 0;">Fahrer Dashboard</h3>
        <div id="debug-panel" style="background:#fef3c7;border:2px solid #f59e0b;border-radius:8px;padding:12px;margin-bottom:15px;font-size:13px;">
            <strong>üêõ Debug:</strong><br>
            Firebase: <span id="debug-firebase" style="font-weight:bold;">‚ùì</span><br>
            Alle Fahrten: <span id="debug-rides" style="font-weight:bold;">‚ùì</span><br>
            Neue Fahrten: <span id="debug-new" style="font-weight:bold;">‚ùì</span><br>
            Sync: <span id="debug-sync" style="font-weight:bold;">‚ùì</span>
        </div>
        <div class="online-toggle">
            <div>
                <strong id="online-status-text">Offline</strong><br>
                <small>GPS-Tracking</small>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" id="online-toggle" onchange="toggleOnline()">
                <span class="slider"></span>
            </label>
        </div>
        <div class="input-group">
            <label>üöó Fahrzeug</label>
            <select id="vehicle" onchange="setVehicle()">
                <option value="">-- W√§hlen --</option>
                <option value="tesla_model3_1">Tesla Model 3 #1 (PW-TX 111)</option>
                <option value="tesla_model3_2">Tesla Model 3 #2 (PW-TX 222)</option>
                <option value="tesla_model3_3">Tesla Model 3 #3 (PW-TX 333)</option>
                <option value="tesla_modely_1">Tesla Model Y #1 (PW-MY 222)</option>
                <option value="tesla_modely_2">Tesla Model Y #2 (PW-MY 333)</option>
            </select>
        </div>
        <div class="stats-grid">
            <div class="stat-card"><div style="font-size: 28px;" id="d-rides">0</div><div>Fahrten</div></div>
            <div class="stat-card"><div style="font-size: 28px;" id="d-money">0‚Ç¨</div><div>Verdienst</div></div>
        </div>
        
        <!-- DRIVER MAP -->
        <div id="driver-route-info" style="display:none;">
            <div class="route-info-box">
                <h3 style="margin-bottom:10px;">üìç Navigation zum Fahrgast</h3>
                <div class="route-stats">
                    <div class="route-stat">
                        <div class="route-stat-value" id="route-distance">-</div>
                        <div class="route-stat-label">Kilometer</div>
                    </div>
                    <div class="route-stat">
                        <div class="route-stat-value" id="route-duration">-</div>
                        <div class="route-stat-label">Minuten</div>
                    </div>
                    <div class="route-stat">
                        <div class="route-stat-value" id="route-eta">-</div>
                        <div class="route-stat-label">Ankunft</div>
                    </div>
                </div>
            </div>
            <div id="driver-map"></div>
        </div>
        
        <div id="driver-current-ride"></div>
        <h3>Neue Auftr√§ge</h3>
        <div id="new-rides"></div>
    </div>

    <div id="admin-view" class="view">
        <h3 style="margin: 20px 0;">Dashboard</h3>
        <button onclick="resetDatabase()" style="width:100%;padding:15px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;margin-bottom:20px;cursor:pointer;font-size:15px;">
            üóëÔ∏è Datenbank zur√ºcksetzen (ALLE Fahrten l√∂schen)
        </button>
        <div class="stats-grid">
            <div class="stat-card"><div style="font-size: 28px;" id="a-total">0</div><div>Fahrten</div></div>
            <div class="stat-card"><div style="font-size: 28px;" id="a-revenue">0‚Ç¨</div><div>Umsatz</div></div>
            <div class="stat-card"><div style="font-size: 28px;" id="a-pending">0</div><div>Offen</div></div>
            <div class="stat-card"><div style="font-size: 28px;" id="a-active">0</div><div>Aktiv</div></div>
        </div>
        <h3 style="margin-top:20px;">üí∂ Stornierungen (kostenpflichtig)</h3>
        <div id="cancellations-list"></div>
        <h3 style="margin-top:20px;">Alle Fahrten</h3>
        <div id="all-rides"></div>
    </div>

    <!-- üîê LOGIN MODAL -->
    <div id="login-modal" class="modal-overlay">
        <div class="modal-content" style="position: relative;">
            <div class="modal-close" onclick="closeLoginModal()">√ó</div>
            
            <div class="modal-header">
                <div style="font-size: 48px; margin-bottom: 10px;">üöï</div>
                <h2>Willkommen zur√ºck!</h2>
                <p style="color: #666; font-size: 14px;">Melde dich an um deine Fahrten zu speichern</p>
            </div>

            <!-- TABS -->
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">Anmelden</button>
                <button class="auth-tab" onclick="switchAuthTab('register')">Registrieren</button>
            </div>

            <!-- LOGIN FORM -->
            <div id="login-form" class="auth-form active">
                <div class="input-group">
                    <label>E-Mail</label>
                    <input type="email" id="login-email" placeholder="deine@email.de" onkeypress="if(event.key==='Enter')loginWithEmail()">
                </div>
                <div class="input-group">
                    <label>Passwort</label>
                    <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeypress="if(event.key==='Enter')loginWithEmail()">
                </div>
                <button class="btn btn-primary" onclick="loginWithEmail()">Anmelden</button>
                
                <div class="divider">oder</div>
                
                <div class="social-login">
                    <button class="btn btn-google" onclick="loginWithGoogle()">
                        <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg"><path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.875 2.684-6.615z" fill="#4285F4"/><path d="M9.003 18c2.43 0 4.467-.806 5.956-2.18L12.05 13.56c-.806.54-1.836.86-3.047.86-2.344 0-4.328-1.584-5.036-3.711H.96v2.332C2.44 15.983 5.485 18 9.003 18z" fill="#34A853"/><path d="M3.964 10.712c-.18-.54-.282-1.117-.282-1.71 0-.593.102-1.17.282-1.71V4.96H.957C.347 6.175 0 7.55 0 9.002c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/><path d="M9.003 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.464.891 11.428 0 9.003 0 5.485 0 2.44 2.017.96 4.958L3.967 7.29c.708-2.127 2.692-3.71 5.036-3.71z" fill="#EA4335"/></svg>
                        Mit Google anmelden
                    </button>
                </div>
            </div>

            <!-- REGISTER FORM -->
            <div id="register-form" class="auth-form">
                <div class="input-group">
                    <label>Name</label>
                    <input type="text" id="register-name" placeholder="Max Mustermann" onkeypress="if(event.key==='Enter')registerWithEmail()">
                </div>
                <div class="input-group">
                    <label>E-Mail</label>
                    <input type="email" id="register-email" placeholder="deine@email.de" onkeypress="if(event.key==='Enter')registerWithEmail()">
                </div>
                <div class="input-group">
                    <label>Passwort (min. 6 Zeichen)</label>
                    <input type="password" id="register-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeypress="if(event.key==='Enter')registerWithEmail()">
                </div>
                <button class="btn btn-primary" onclick="registerWithEmail()">Registrieren</button>
                
                <div class="divider">oder</div>
                
                <div class="social-login">
                    <button class="btn btn-google" onclick="loginWithGoogle()">
                        <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg"><path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.875 2.684-6.615z" fill="#4285F4"/><path d="M9.003 18c2.43 0 4.467-.806 5.956-2.18L12.05 13.56c-.806.54-1.836.86-3.047.86-2.344 0-4.328-1.584-5.036-3.711H.96v2.332C2.44 15.983 5.485 18 9.003 18z" fill="#34A853"/><path d="M3.964 10.712c-.18-.54-.282-1.117-.282-1.71 0-.593.102-1.17.282-1.71V4.96H.957C.347 6.175 0 7.55 0 9.002c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/><path d="M9.003 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.464.891 11.428 0 9.003 0 5.485 0 2.44 2.017.96 4.958L3.967 7.29c.708-2.127 2.692-3.71 5.036-3.71z" fill="#EA4335"/></svg>
                        Mit Google registrieren
                    </button>
                </div>
            </div>

            <p style="text-align: center; margin-top: 20px; font-size: 12px; color: #999;">
                <a href="#" onclick="closeLoginModal(); return false;" style="color: #667eea;">Als Gast fortfahren</a>
            </p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let firebaseLoadTimeout, firebaseLoaded = false;
        firebaseLoadTimeout = setTimeout(() => { 
            if (!firebaseLoaded && typeof initApp === 'function') initApp(false); 
        }, 5000);
    </script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js" onload="firebaseLoaded = true;" onerror="if(typeof initApp === 'function') initApp(false);"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script>
        // CONFIGURATION
        const VEHICLES = {
            'tesla_model3_1': { name: 'Tesla Model 3 #1', id: 'tesla_model3_1', plate: 'PW-TX 111' },
            'tesla_model3_2': { name: 'Tesla Model 3 #2', id: 'tesla_model3_2', plate: 'PW-TX 222' },
            'tesla_model3_3': { name: 'Tesla Model 3 #3', id: 'tesla_model3_3', plate: 'PW-TX 333' },
            'tesla_modely_1': { name: 'Tesla Model Y #1', id: 'tesla_modely_1', plate: 'PW-MY 222' },
            'tesla_modely_2': { name: 'Tesla Model Y #2', id: 'tesla_modely_2', plate: 'PW-MY 333' }
        };
        
        // üöó FAHRZEUG-TYPEN f√ºr Uber-Style Interface
        const VEHICLE_TYPES = {
            'standard': {
                id: 'standard',
                name: 'Tesla Standard',
                icon: 'üöó',
                description: 'Model 3 ‚Ä¢ 4 Personen',
                baseFare: 4.00,
                pricePerKm: 2.20,
                capacity: 4
            },
            'comfort': {
                id: 'comfort',
                name: 'Tesla Komfort',
                icon: 'üöô',
                description: 'Model Y ‚Ä¢ 4 Personen ‚Ä¢ Mehr Platz',
                baseFare: 4.00,
                pricePerKm: 2.50,
                capacity: 4
            },
            'medical': {
                id: 'medical',
                name: 'Krankenfahrt',
                icon: 'üöë',
                description: 'Abrechnung mit Krankenkasse',
                baseFare: 0,
                pricePerKm: 0,
                capacity: 2,
                special: 'insurance'
            }
        };
        const TARIF = { grundgebuehr: 4.00, kmPreis: 2.20, nachtZuschlag: 0.20, sonntagZuschlag: 0.25, feiertagZuschlag: 0.50 };
        const USEDOM_ORTE = ['Heringsdorf', 'Ahlbeck', 'Bansin', 'Zinnowitz', '√úckeritz', 'Loddin', 'Zempin', 'Koserow', 'Karlshagen', 'Peenem√ºnde', 'Trassenheide'];
        
        // Bekannte Koordinaten f√ºr wichtige Orte (Fallback)
        const KNOWN_PLACES = {
            'heringsdorf': { lat: 53.9533, lon: 14.1633, name: 'Heringsdorf' },
            'bahnhof heringsdorf': { lat: 53.9533, lon: 14.1633, name: 'Bahnhof Heringsdorf' },
            'ahlbeck': { lat: 53.9444, lon: 14.1933, name: 'Ahlbeck' },
            'seebr√ºcke ahlbeck': { lat: 53.9444, lon: 14.1933, name: 'Seebr√ºcke Ahlbeck' },
            'bansin': { lat: 53.9633, lon: 14.1433, name: 'Bansin' },
            'seebr√ºcke bansin': { lat: 53.9633, lon: 14.1433, name: 'Seebr√ºcke Bansin' },
            'zinnowitz': { lat: 54.0908, lon: 13.9167, name: 'Zinnowitz' },
            'bahnhof zinnowitz': { lat: 54.0908, lon: 13.9167, name: 'Bahnhof Zinnowitz' },
            '√ºckeritz': { lat: 53.9878, lon: 14.0519, name: '√úckeritz' },
            'loddin': { lat: 54.0083, lon: 13.9917, name: 'Loddin' },
            'zempin': { lat: 54.0194, lon: 13.9611, name: 'Zempin' },
            'koserow': { lat: 54.0681, lon: 13.9764, name: 'Koserow' },
            'karlshagen': { lat: 54.1078, lon: 13.8333, name: 'Karlshagen' },
            'peenem√ºnde': { lat: 54.1422, lon: 13.7753, name: 'Peenem√ºnde' },
            'trassenheide': { lat: 54.0997, lon: 13.8875, name: 'Trassenheide' },
            'usedom': { lat: 53.9533, lon: 14.1633, name: 'Usedom' },
            'swinem√ºnde': { lat: 53.9167, lon: 14.2500, name: 'Swinem√ºnde' }
        };

        // STATE
        let db, isFirebaseReady = false, isConnected = false, currentVehicle = null, currentView = 'passenger', rides = [], drivers = {};
        let auth = null, currentUser = null; // üîê Firebase Auth
        let pickupCoords = null, destCoords = null, map = null, watchId = null, isOnline = false, myCurrentRide = null;
        let taxiMarker = null, pickupMarker = null, etaUpdateInterval = null, lastSoundDistance = 999;
        let wakeLock = null;
        let cancellations = []; // Neue Variable f√ºr Stornierungen
        
        // üÜï AUTO-ZUWEISUNG & PUSH
        let assignmentTimers = {}; // Timer f√ºr 30-Sek-Countdown
        let notificationPermission = null;
        let serviceWorkerRegistration = null;
        let pushSubscription = null;
        let regularCustomer = null; // Stammkunden-Daten
        
        // üé® UBER-STYLE INTERFACE
        let uberMap = null;
        let selectedVehicleType = 'standard';
        let selectedPaymentMethod = 'cash';
        let calculatedRoute = null;
        let routePolyline = null;

        console.log('üöÄ Taxi App v4.1.0 gestartet');
        
        // üåü STAMMKUNDEN-FUNKTIONEN
        function loadRegularCustomer() {
            const saved = localStorage.getItem('regularCustomer');
            if (saved) {
                regularCustomer = JSON.parse(saved);
                showRegularCustomerBox();
            }
        }
        
        function showRegularCustomerBox() {
            if (!regularCustomer) return;
            
            const box = document.getElementById('regular-customer-box');
            const info = document.getElementById('regular-customer-info');
            
            info.innerHTML = `
                üë§ <strong>${regularCustomer.name}</strong><br>
                üìç H√§ufig: ${regularCustomer.favoritePickup || 'Noch keine Fahrten'}<br>
                üöï ${regularCustomer.rideCount || 0} Fahrten bisher
            `;
            
            box.style.display = 'block';
        }
        
        function useRegularCustomerData() {
            if (!regularCustomer) return;
            
            document.getElementById('customer-name').value = regularCustomer.name;
            if (regularCustomer.favoritePickup) {
                document.getElementById('pickup').value = regularCustomer.favoritePickup;
            }
            if (regularCustomer.favoriteDestination) {
                document.getElementById('destination').value = regularCustomer.favoriteDestination;
            }
            
            alert('‚úÖ Deine Daten wurden eingef√ºgt!\n\n√úberpr√ºfe die Adresse und buche dann dein Taxi.');
        }
        
        function clearRegularCustomer() {
            if (confirm('‚ö†Ô∏è Stammkundendaten l√∂schen?\n\nDu musst beim n√§chsten Mal alles neu eingeben.')) {
                localStorage.removeItem('regularCustomer');
                regularCustomer = null;
                document.getElementById('regular-customer-box').style.display = 'none';
                alert('‚úÖ Stammkundendaten gel√∂scht');
            }
        }
        
        function saveRegularCustomerData(name, pickup, destination) {
            const saveCheckbox = document.getElementById('save-customer');
            if (!saveCheckbox || !saveCheckbox.checked) return;
            
            // Lade bestehende Daten oder erstelle neu
            let customer = regularCustomer || { name: name, rideCount: 0 };
            
            // Update
            customer.name = name;
            customer.favoritePickup = pickup;
            customer.favoriteDestination = destination;
            customer.rideCount = (customer.rideCount || 0) + 1;
            customer.lastRide = Date.now();
            
            // Speichern
            localStorage.setItem('regularCustomer', JSON.stringify(customer));
            regularCustomer = customer;
            
            console.log('üíæ Stammkunde gespeichert:', customer);
        }

        // üìÖ DATUM & ZEIT PICKER
        function handlePickupTimeChange() {
            const select = document.getElementById('pickup-time');
            const datetimePicker = document.getElementById('custom-datetime');
            const helpText = document.getElementById('datetime-help');
            
            if (select.value === 'datetime') {
                datetimePicker.style.display = 'block';
                if (helpText) helpText.style.display = 'block';
                
                // Setze Minimum auf jetzt + 15 Minuten
                const now = new Date();
                now.setMinutes(now.getMinutes() + 15);
                const minDateTime = now.toISOString().slice(0, 16);
                datetimePicker.min = minDateTime;
                
                // Setze Standard auf jetzt + 1 Stunde
                const defaultTime = new Date();
                defaultTime.setHours(defaultTime.getHours() + 1);
                datetimePicker.value = defaultTime.toISOString().slice(0, 16);
                
            } else {
                datetimePicker.style.display = 'none';
                if (helpText) helpText.style.display = 'none';
            }
        }

        function saveRegularCustomerData(name, pickup, destination) {
            const saveCheckbox = document.getElementById('save-customer');
            if (!saveCheckbox || !saveCheckbox.checked) return;
            
            // Lade bestehende Daten oder erstelle neu
            let customer = regularCustomer || { name: name, rideCount: 0 };
            
            // Update
            customer.name = name;
            customer.favoritePickup = pickup;
            customer.favoriteDestination = destination;
            customer.rideCount = (customer.rideCount || 0) + 1;
            customer.lastRide = Date.now();
            
            // Speichern
            localStorage.setItem('regularCustomer', JSON.stringify(customer));
            regularCustomer = customer;
            
            console.log('üíæ Stammkunde gespeichert:', customer);
        }

        console.log('üöÄ Taxi App v3.6.0 gestartet');

        // üîî SERVICE WORKER & PUSH NOTIFICATIONS
        async function initServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    serviceWorkerRegistration = await navigator.serviceWorker.register('/service-worker.js');
                    console.log('‚úÖ Service Worker registriert:', serviceWorkerRegistration);
                    
                    // Warte bis Service Worker aktiv ist
                    await navigator.serviceWorker.ready;
                    console.log('‚úÖ Service Worker bereit');
                    
                    // Push-Benachrichtigungen aktivieren
                    await initPushNotifications();
                } catch (err) {
                    console.error('‚ùå Service Worker Fehler:', err);
                }
            } else {
                console.warn('‚ö†Ô∏è Service Worker nicht unterst√ºtzt');
            }
        }

        async function initPushNotifications() {
            if (!('Notification' in window)) {
                console.warn('‚ö†Ô∏è Benachrichtigungen nicht unterst√ºtzt');
                return;
            }
            
            notificationPermission = Notification.permission;
            console.log('üîî Notification Permission:', notificationPermission);
            
            if (notificationPermission === 'granted') {
                console.log('‚úÖ Benachrichtigungen bereits erlaubt');
            }
        }

        function showNotificationPrompt() {
            // Entferne altes Banner falls vorhanden
            const oldBanner = document.getElementById('notification-banner');
            if (oldBanner) oldBanner.remove();
            
            const banner = document.createElement('div');
            banner.id = 'notification-banner';
            banner.style.cssText = 'position:fixed;top:140px;left:10px;right:10px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;border-radius:12px;text-align:center;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.3);animation:slideDown 0.3s ease;';
            banner.innerHTML = `
                <div style="font-size:48px;margin-bottom:10px;">üîî</div>
                <div style="margin-bottom:15px;">
                    <strong style="font-size:18px;">Benachrichtigungen aktivieren?</strong><br>
                    <span style="font-size:14px;opacity:0.9;margin-top:5px;display:block;">Erhalte sofort Push-Benachrichtigungen bei neuen Buchungen - auch wenn die App geschlossen ist!</span>
                </div>
                <button onclick="requestNotificationPermission()" style="background:white;color:#667eea;border:none;padding:14px 24px;border-radius:8px;font-weight:700;cursor:pointer;margin-right:10px;font-size:15px;box-shadow:0 2px 8px rgba(0,0,0,0.2);">‚úì Jetzt aktivieren</button>
                <button onclick="document.getElementById('notification-banner').remove()" style="background:rgba(255,255,255,0.2);color:white;border:2px solid white;padding:14px 24px;border-radius:8px;font-weight:600;cursor:pointer;font-size:15px;">Sp√§ter</button>
            `;
            
            // CSS Animation
            const style = document.createElement('style');
            style.textContent = '@keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }';
            document.head.appendChild(style);
            
            document.body.appendChild(banner);
            
            console.log('üîî Benachrichtigungs-Banner angezeigt');
        }

        async function requestNotificationPermission() {
            try {
                // Banner entfernen (beide Varianten)
                const staticBanner = document.getElementById('static-notification-banner');
                if (staticBanner) staticBanner.style.display = 'none';
                
                const banner = document.getElementById('notification-banner');
                if (banner) banner.remove();
                
                notificationPermission = await Notification.requestPermission();
                console.log('üîî Notification Permission:', notificationPermission);
                
                if (notificationPermission === 'granted') {
                    // Zeige Best√§tigung
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = 'position:fixed;top:140px;left:10px;right:10px;background:#10b981;color:white;padding:20px;border-radius:12px;text-align:center;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.3);';
                    successMsg.innerHTML = `
                        <div style="font-size:48px;margin-bottom:10px;">‚úÖ</div>
                        <div style="font-size:16px;font-weight:600;">Benachrichtigungen aktiviert!</div>
                        <div style="font-size:14px;margin-top:8px;opacity:0.9;">Du erh√§ltst jetzt Push-Benachrichtigungen f√ºr neue Fahrten</div>
                    `;
                    document.body.appendChild(successMsg);
                    
                    // Automatisch nach 3 Sekunden ausblenden
                    setTimeout(() => {
                        successMsg.style.transition = 'opacity 0.5s';
                        successMsg.style.opacity = '0';
                        setTimeout(() => successMsg.remove(), 500);
                    }, 3000);
                    
                } else if (notificationPermission === 'denied') {
                    // Zeige Hilfe-Info
                    alert('‚ö†Ô∏è Benachrichtigungen wurden blockiert.\n\nSo kannst du sie aktivieren:\n\n1. Tippe auf das üîí Schloss in der Adressleiste\n2. Gehe zu "Berechtigungen"\n3. Stelle "Benachrichtigungen" auf "Zulassen"');
                }
            } catch (err) {
                console.error('‚ùå Notification Permission Fehler:', err);
                alert('‚ùå Fehler beim Aktivieren der Benachrichtigungen.\n\nBitte versuche es √ºber die Browser-Einstellungen.');
            }
        }

        // Lokale Benachrichtigung anzeigen
        function sendLocalNotification(title, body, data = {}) {
            if (notificationPermission !== 'granted') {
                console.warn('‚ö†Ô∏è Keine Berechtigung f√ºr Benachrichtigungen');
                // Fallback: Sound abspielen
                playNotificationSound();
                return;
            }
            
            // Wenn Service Worker verf√ºgbar, nutze diesen
            if (serviceWorkerRegistration) {
                serviceWorkerRegistration.showNotification(title, {
                    body: body,
                    icon: '/icon-192.png',
                    badge: '/icon-192.png',
                    vibrate: [200, 100, 200, 100, 200],
                    tag: 'taxi-ride-' + (data.rideId || Date.now()),
                    requireInteraction: true,
                    data: data,
                    actions: [
                        { action: 'view', title: 'üëÄ Anzeigen' },
                        { action: 'close', title: '‚ùå Schlie√üen' }
                    ]
                });
            } else {
                // Fallback: Browser Notification API
                const notification = new Notification(title, {
                    body: body,
                    icon: '/icon-192.png',
                    vibrate: [200, 100, 200, 100, 200],
                    tag: 'taxi-ride-' + (data.rideId || Date.now()),
                    requireInteraction: true
                });
                
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            }
            
            // Sound abspielen
            playNotificationSound();
        }

        // üîê AUTH FUNCTIONS
        function showLoginModal() {
            document.getElementById('login-modal').classList.add('active');
        }

        function closeLoginModal() {
            document.getElementById('login-modal').classList.remove('active');
        }

        function switchAuthTab(tab) {
            // Tabs umschalten
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelectorAll('.auth-tab')[0].classList.add('active');
                document.getElementById('login-form').classList.add('active');
            } else {
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
                document.getElementById('register-form').classList.add('active');
            }
        }

        async function loginWithEmail() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                alert('Bitte E-Mail und Passwort eingeben!');
                return;
            }

            if (!auth) {
                alert('Firebase Auth nicht geladen!');
                return;
            }

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('‚úÖ Login erfolgreich:', userCredential.user.email);
                closeLoginModal();
                alert('Willkommen zur√ºck, ' + userCredential.user.email + '! üéâ');
            } catch (error) {
                console.error('‚ùå Login-Fehler:', error);
                if (error.code === 'auth/user-not-found') {
                    alert('Diese E-Mail ist nicht registriert.');
                } else if (error.code === 'auth/wrong-password') {
                    alert('Falsches Passwort!');
                } else if (error.code === 'auth/invalid-email') {
                    alert('Ung√ºltige E-Mail-Adresse!');
                } else {
                    alert('Login fehlgeschlagen: ' + error.message);
                }
            }
        }

        async function registerWithEmail() {
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;

            if (!name || !email || !password) {
                alert('Bitte alle Felder ausf√ºllen!');
                return;
            }

            if (password.length < 6) {
                alert('Passwort muss mindestens 6 Zeichen haben!');
                return;
            }

            if (!auth) {
                alert('Firebase Auth nicht geladen!');
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                console.log('‚úÖ Registrierung erfolgreich:', userCredential.user.email);
                
                // Name aktualisieren
                await userCredential.user.updateProfile({ displayName: name });
                
                // E-Mail-Verifizierung senden
                await userCredential.user.sendEmailVerification();
                
                closeLoginModal();
                alert('Registrierung erfolgreich! üéâ\n\nWir haben dir eine Best√§tigungs-E-Mail gesendet.\nBitte pr√ºfe dein Postfach.');
            } catch (error) {
                console.error('‚ùå Registrierungs-Fehler:', error);
                if (error.code === 'auth/email-already-in-use') {
                    alert('Diese E-Mail ist bereits registriert!');
                } else if (error.code === 'auth/invalid-email') {
                    alert('Ung√ºltige E-Mail-Adresse!');
                } else if (error.code === 'auth/weak-password') {
                    alert('Passwort ist zu schwach!');
                } else {
                    alert('Registrierung fehlgeschlagen: ' + error.message);
                }
            }
        }

        async function loginWithGoogle() {
            if (!auth) {
                alert('Firebase Auth nicht geladen!');
                return;
            }

            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('profile');
                provider.addScope('email');
                
                // Versuche Popup (funktioniert auf Desktop)
                try {
                    const result = await auth.signInWithPopup(provider);
                    console.log('‚úÖ Google Login erfolgreich (Popup):', result.user.email);
                    closeLoginModal();
                    alert('Willkommen, ' + (result.user.displayName || result.user.email) + '! üéâ');
                } catch (popupError) {
                    // Popup geschlossen oder blockiert ‚Üí Versuche Redirect (funktioniert auf Mobile)
                    if (popupError.code === 'auth/popup-blocked' || 
                        popupError.code === 'auth/popup-closed-by-user' ||
                        popupError.code === 'auth/cancelled-popup-request') {
                        console.log('üîÑ Popup blockiert, verwende Redirect...');
                        await auth.signInWithRedirect(provider);
                        // Nach Redirect wird Seite neu geladen und onAuthStateChanged wird gefeuert
                    } else {
                        throw popupError;
                    }
                }
            } catch (error) {
                console.error('‚ùå Google Login-Fehler:', error);
                if (error.code === 'auth/popup-closed-by-user') {
                    // User hat Popup geschlossen - kein Alert n√∂tig
                } else if (error.code === 'auth/unauthorized-domain') {
                    alert('‚ö†Ô∏è Google Login ist f√ºr diese Domain nicht autorisiert.\n\nBitte f√ºge die Domain in der Firebase Console hinzu:\n\nFirebase Console ‚Üí Authentication ‚Üí Sign-in method ‚Üí Authorized domains');
                } else {
                    alert('Google Login fehlgeschlagen: ' + error.message);
                }
            }
        }

        async function logoutUser() {
            if (!auth || !currentUser) return;
            
            try {
                await auth.signOut();
                console.log('‚úÖ Logout erfolgreich');
                alert('Erfolgreich abgemeldet!');
            } catch (error) {
                console.error('‚ùå Logout-Fehler:', error);
                alert('Logout fehlgeschlagen: ' + error.message);
            }
        }

        function onUserLoggedIn(user) {
            console.log('üë§ User eingeloggt:', user.email, user.displayName);
            currentUser = user;
            
            // User-Profil-Box in Header einf√ºgen
            updateUserProfile();
        }

        function onUserLoggedOut() {
            console.log('üë§ User ausgeloggt');
            currentUser = null;
            
            // User-Profil-Box entfernen
            updateUserProfile();
        }

        function updateUserProfile() {
            const header = document.querySelector('.header');
            let profileBox = document.getElementById('user-profile-box');
            
            if (currentUser) {
                // User ist eingeloggt - zeige Profil
                const initial = (currentUser.displayName || currentUser.email).charAt(0).toUpperCase();
                const displayName = currentUser.displayName || currentUser.email.split('@')[0];
                
                if (!profileBox) {
                    profileBox = document.createElement('div');
                    profileBox.id = 'user-profile-box';
                    profileBox.className = 'user-profile';
                    profileBox.style.marginTop = '15px';
                    header.appendChild(profileBox);
                }
                
                profileBox.innerHTML = `
                    <div class="user-avatar">${initial}</div>
                    <div class="user-info">
                        <div style="font-weight: 600;">${displayName}</div>
                        <div style="font-size: 12px; opacity: 0.8;">${currentUser.email}</div>
                    </div>
                    <button class="btn btn-logout" onclick="logoutUser()">Abmelden</button>
                `;
            } else {
                // User ist nicht eingeloggt - zeige Login-Button
                if (!profileBox) {
                    profileBox = document.createElement('div');
                    profileBox.id = 'user-profile-box';
                    profileBox.style.marginTop = '15px';
                    header.appendChild(profileBox);
                }
                
                profileBox.innerHTML = `
                    <button class="btn btn-primary" onclick="showLoginModal()" style="padding: 10px 20px; font-size: 13px;">
                        üîê Anmelden / Registrieren
                    </button>
                `;
            }
        }

        function playNotificationSound() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+');
                audio.volume = 0.5;
                audio.play().catch(e => console.log('üîá Audio blockiert'));
            } catch (e) {
                console.log('üîá Audio nicht verf√ºgbar');
            }
        }

        // INIT
        function initApp(hasFirebase) {
            clearTimeout(firebaseLoadTimeout);
            console.log('üì± App initialisiert');
            
            if (hasFirebase && typeof firebase !== 'undefined') {
                try {
                    firebase.initializeApp({
                        apiKey: "AIzaSyD2eHFuplImxBCijd3MWlKyCwXUZHLmhhE",
                        authDomain: "taxi-heringsdorf.firebaseapp.com",
                        databaseURL: "https://taxi-heringsdorf-default-rtdb.europe-west1.firebasedatabase.app",
                        projectId: "taxi-heringsdorf",
                        storageBucket: "taxi-heringsdorf.firebasestorage.app",
                        messagingSenderId: "886448081276",
                        appId: "1:886448081276:web:1b54875801c5d89f8efcf9"
                    });
                    db = firebase.database();
                    auth = firebase.auth(); // üîê Firebase Auth initialisieren
                    isFirebaseReady = true;
                    console.log('‚úÖ Firebase verbunden');
                    
                    // üîê Auth State Listener
                    auth.onAuthStateChanged((user) => {
                        if (user) {
                            console.log('üë§ User eingeloggt:', user.email);
                            onUserLoggedIn(user);
                        } else {
                            console.log('üë§ User ausgeloggt');
                            onUserLoggedOut();
                        }
                    });
                    
                    db.ref('.info/connected').on('value', (s) => { isConnected = s.val(); updateStatus(); });
                    db.ref('rides').on('value', (s) => {
                        const previousCount = rides.filter(r => r.status === 'new').length;
                        rides = [];
                        s.forEach(c => {
                            const r = c.val();
                            r.firebaseId = c.key;
                            rides.push(r);
                            if (myCurrentRide && r.id === myCurrentRide.id) {
                                myCurrentRide = r;
                                if (r.status === 'accepted' && r.driverLocation) showRideStatus(r);
                                if (r.status === 'picked_up') showRideStatus(r);
                                if (r.status === 'completed') showRideStatus(r);
                            }
                        });
                        
                        const currentCount = rides.filter(r => r.status === 'new').length;
                        if (currentCount > previousCount && currentView === 'driver') {
                            playDriverNotificationSound();
                        }
                        
                        updateViews();
                    });
                    db.ref('drivers').on('value', (s) => { 
                        drivers = {}; 
                        s.forEach(c => { drivers[c.key] = c.val(); }); 
                        showAvailableTaxis(); 
                    });
                    db.ref('cancellations').on('value', (s) => {
                        cancellations = [];
                        s.forEach(c => {
                            const cancel = c.val();
                            cancel.firebaseId = c.key;
                            cancellations.push(cancel);
                        });
                        if (currentView === 'admin') updateAdminView();
                    });
                } catch (e) { 
                    console.error('‚ùå Firebase Fehler:', e); 
                }
            } else {
                console.log('‚ö†Ô∏è Firebase nicht verf√ºgbar - Lokaler Modus');
            }
            
            updateStatus();
            updateViews(); // WICHTIG: Views auch ohne Firebase laden!
            
            // üîî SERVICE WORKER & PUSH initialisieren
            initServiceWorker();
        }

        function updateStatus() {
            const dot = document.getElementById('sync-dot');
            const status = document.getElementById('sync-status');
            if (isFirebaseReady && isConnected) {
                dot.classList.add('online');
                status.textContent = 'üü¢ Live';
            } else {
                dot.classList.remove('online');
                status.textContent = 'üíæ Lokal';
            }
        }

        // üîî SERVICE WORKER & PUSH BENACHRICHTIGUNGEN
        async function initServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    serviceWorkerRegistration = await navigator.serviceWorker.register('/service-worker.js');
                    console.log('‚úÖ Service Worker registriert:', serviceWorkerRegistration.scope);
                    
                    // Push-Berechtigung anfragen (nur beim ersten Mal oder wenn abgelehnt)
                    if ('Notification' in window) {
                        notificationPermission = await Notification.requestPermission();
                        console.log('üîî Notification Permission:', notificationPermission);
                        
                        if (notificationPermission === 'granted') {
                            console.log('‚úÖ Push-Benachrichtigungen erlaubt!');
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Service Worker Fehler:', error);
                }
            } else {
                console.warn('‚ö†Ô∏è Service Worker nicht unterst√ºtzt');
            }
        }

        // Push-Benachrichtigung senden (lokal)
        function sendLocalNotification(title, body, data = {}) {
            if ('Notification' in window && Notification.permission === 'granted') {
                if (serviceWorkerRegistration) {
                    serviceWorkerRegistration.showNotification(title, {
                        body: body,
                        icon: '/icon-192.png',
                        badge: '/badge-72.png',
                        vibrate: [200, 100, 200, 100, 200],
                        tag: 'taxi-' + (data.rideId || 'notification'),
                        requireInteraction: true,
                        data: data,
                        actions: [
                            { action: 'accept', title: '‚úì Annehmen' },
                            { action: 'dismiss', title: '‚úï Ablehnen' }
                        ]
                    });
                    
                    // Sound abspielen
                    playNotificationSound();
                }
            } else {
                console.warn('‚ö†Ô∏è Notifications nicht verf√ºgbar oder nicht erlaubt');
            }
        }

        // Sound f√ºr Benachrichtigungen
        function playNotificationSound() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ==');
                audio.volume = 1.0;
                audio.play().catch(e => console.log('üîá Audio play blocked'));
            } catch (e) {
                console.log('üîá Audio not supported');
            }
        }

        function switchView(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(view + '-view').classList.add('active');
            event.target.classList.add('active');
            currentView = view;
            
            const gpsIndicator = document.getElementById('gps-indicator');
            if (view === 'driver') gpsIndicator.style.display = 'flex';
            else gpsIndicator.style.display = 'none';
            
            if (view === 'history') loadHistory();
            
            // üé® Initialisiere Uber-Map wenn Passenger View ge√∂ffnet wird
            if (view === 'passenger') {
                setTimeout(() => initUberMap(), 100);
            }
            
            updateViews();
        }

        function updateViews() {
            // Update Debug Panel
            if (document.getElementById('debug-firebase')) {
                document.getElementById('debug-firebase').textContent = isFirebaseReady ? (isConnected ? '‚úÖ Verbunden' : '‚ö†Ô∏è Offline') : '‚ùå Fehler';
                document.getElementById('debug-rides').textContent = rides.length;
                document.getElementById('debug-new').textContent = rides.filter(r => r.status === 'new').length;
                document.getElementById('debug-sync').textContent = new Date().toLocaleTimeString('de-DE');
            }
            
            if (currentView === 'driver') updateDriverView();
            else if (currentView === 'admin') updateAdminView();
        }

        function updateDriverView() {
            const newRides = rides.filter(r => r.status === 'new');
            const myRides = currentVehicle ? rides.filter(r => r.vehicleId === currentVehicle || r.vehicle === (VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle)) : [];
            const current = myRides.find(r => r.status === 'accepted' || r.status === 'picked_up');
            const completed = myRides.filter(r => r.status === 'completed');
            
            // üö® CHECK F√úR STORNIERTE FAHRTEN
            const cancelledRides = myRides.filter(r => r.status === 'cancelled' && r.driverNotified === false);
            if (cancelledRides.length > 0) {
                cancelledRides.forEach(ride => {
                    notifyDriverOfCancellation(ride);
                });
            }
            
            // Current ride
            if (current) {
                let buttonHtml = '';
                if (current.status === 'accepted') {
                    buttonHtml = `<button class="btn btn-success" onclick="pickupCustomer('${current.firebaseId}')" style="margin-top:10px;">üöï Kunde abgeholt</button>`;
                } else if (current.status === 'picked_up') {
                    buttonHtml = `
                        <div style="margin-top:10px;padding:12px;background:#fef3c7;border-radius:8px;text-align:center;font-weight:600;color:#92400e;">
                            üöó BESETZT - Fahrt l√§uft
                        </div>
                        <button class="btn btn-success" onclick="completeRide('${current.firebaseId}')" style="margin-top:10px;">‚úì Fahrt abschlie√üen</button>
                    `;
                }
                
                document.getElementById('driver-current-ride').innerHTML = `
                    <div class="alert-info">
                        <strong>Aktuelle Fahrt #${current.id}</strong><br>
                        ${current.customerName ? `<strong>üë§ ${current.customerName}</strong><br>` : ''}
                        Von: ${current.pickup}<br>
                        Nach: ${current.destination}<br>
                        Preis: ${current.price}‚Ç¨
                        ${buttonHtml}
                    </div>`;
            } else {
                document.getElementById('driver-current-ride').innerHTML = currentVehicle && isOnline ? '<div class="alert-info">üü¢ Bereit f√ºr Auftr√§ge</div>' : '';
            }
            
            // New rides
            if (!currentVehicle) {
                document.getElementById('new-rides').innerHTML = '<div style="padding:20px;text-align:center;color:#999;">‚ö†Ô∏è Bitte erst Fahrzeug w√§hlen</div>';
            } else if (newRides.length === 0) {
                document.getElementById('new-rides').innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Keine neuen Auftr√§ge</div>';
            } else {
                let ridesHtml = newRides.map(r => {
                    // üéØ Check ob Fahrt diesem Fahrer zugewiesen ist
                    const isAssignedToMe = r.assignedTo === currentVehicle;
                    const timeLeft = r.assignmentExpiresAt ? Math.max(0, Math.ceil((r.assignmentExpiresAt - Date.now()) / 1000)) : null;
                    
                    let assignmentBadge = '';
                    let cardStyle = '';
                    
                    if (isAssignedToMe && timeLeft > 0) {
                        assignmentBadge = `<span style="background:#ef4444;color:white;padding:4px 8px;border-radius:12px;font-size:12px;font-weight:bold;animation:pulse 1s infinite;">‚è∞ DIR ZUGEWIESEN - ${timeLeft}s</span>`;
                        cardStyle = 'border:3px solid #ef4444;background:#fef2f2;';
                    } else if (r.assignedTo && r.assignedTo !== currentVehicle) {
                        assignmentBadge = `<span style="background:#94a3b8;padding:4px 8px;border-radius:12px;font-size:12px;">üë§ Zugewiesen: ${r.assignedVehicleName || r.assignedTo}</span>`;
                    } else {
                        assignmentBadge = '<span style="background:#fef3c7;padding:4px 8px;border-radius:12px;font-size:12px;">üÜï Neu</span>';
                    }
                    
                    return `
                    <div class="ride-card" style="${cardStyle}">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <strong>#${r.id}</strong>
                            ${assignmentBadge}
                        </div>
                        ${r.customerName ? `
                        <div style="margin-top:12px;padding:12px;background:#f0f9ff;border-radius:8px;border-left:4px solid #3b82f6;">
                            <div style="font-size:16px;font-weight:600;color:#1e40af;margin-bottom:8px;">
                                üë§ ${r.customerName}
                            </div>
                            <div style="font-size:14px;color:#0369a1;">
                                üïê Abholung: <strong>${r.pickupTime || 'Sofort'}</strong>
                            </div>
                        </div>
                        ` : ''}
                        <div style="margin-top:10px;font-size:14px;">
                            <strong>Von:</strong> ${r.pickup}<br>
                            <strong>Nach:</strong> ${r.destination}<br>
                            <strong>Distanz:</strong> ${r.distance} km ‚Ä¢ ${r.duration} Min<br>
                            <strong>Preis:</strong> ${r.price}‚Ç¨
                            ${r.assignmentDistance ? `<br><strong>üìç Du bist:</strong> ${r.assignmentDistance.toFixed(1)} km entfernt` : ''}<br>
                            <small style="color:#666;">Bestellt: ${r.time}</small>
                        </div>
                        ${!current ? `<button class="btn btn-success" onclick="acceptRide('${r.firebaseId}')" style="margin-top:10px;">‚úì Annehmen</button>` : '<div style="margin-top:10px;padding:8px;background:#fef3c7;border-radius:6px;font-size:13px;text-align:center;">Schlie√üe erst aktuelle Fahrt ab</div>'}
                    </div>
                    `;
                }).join('');
                
                if (!isOnline) {
                    ridesHtml = '<div class="alert-info" style="margin-bottom:15px;">‚ö†Ô∏è Du bist <strong>Offline</strong>. Schalte auf Online um Auftr√§ge anzunehmen.</div>' + ridesHtml;
                }
                
                document.getElementById('new-rides').innerHTML = ridesHtml;
            }
            
            // Stats
            const revenue = completed.reduce((sum, r) => sum + parseFloat(r.price), 0);
            document.getElementById('d-rides').textContent = completed.length;
            document.getElementById('d-money').textContent = revenue.toFixed(2) + '‚Ç¨';
        }

        function updateAdminView() {
            const completed = rides.filter(r => r.status === 'completed');
            const pending = rides.filter(r => r.status === 'new');
            const active = rides.filter(r => r.status === 'accepted' || r.status === 'picked_up');
            const revenue = completed.reduce((sum, r) => sum + parseFloat(r.price), 0);
            
            document.getElementById('a-total').textContent = completed.length;
            document.getElementById('a-revenue').textContent = revenue.toFixed(2) + '‚Ç¨';
            document.getElementById('a-pending').textContent = pending.length;
            document.getElementById('a-active').textContent = active.length;
            
            // Stornierungen anzeigen
            if (cancellations.length === 0) {
                document.getElementById('cancellations-list').innerHTML = '<div style="padding:15px;text-align:center;color:#999;background:white;border-radius:8px;">Keine Stornierungen</div>';
            } else {
                const totalFees = cancellations.reduce((sum, c) => sum + parseFloat(c.cancellationFee || 0), 0);
                document.getElementById('cancellations-list').innerHTML = 
                    `<div style="background:#fef3c7;border:2px solid #f59e0b;padding:12px;border-radius:8px;margin-bottom:15px;text-align:center;">
                        <strong>Gesamt Stornogeb√ºhren: ${totalFees.toFixed(2)}‚Ç¨</strong> (${cancellations.length} Stornierungen)
                    </div>` +
                    cancellations.slice().reverse().map(c => {
                        const cancelDate = new Date(c.cancelledAt).toLocaleString('de-DE');
                        return `<div class="ride-card" style="border-left:4px solid #f59e0b;">
                            <strong>${c.customerName || 'Unbekannt'}</strong> 
                            <span style="background:#fef3c7;padding:4px 8px;border-radius:12px;font-size:12px;color:#92400e;font-weight:600;">üí∂ ${c.cancellationFee.toFixed(2)}‚Ç¨</span>
                            <div style="margin-top:10px;font-size:14px;color:#666;">
                                <strong>Von:</strong> ${c.pickup}<br>
                                <strong>Nach:</strong> ${c.destination}<br>
                                <strong>Original-Preis:</strong> ${c.originalPrice}‚Ç¨<br>
                                <strong>Storniert:</strong> ${cancelDate}
                            </div>
                        </div>`;
                    }).join('');
            }
            
            if (rides.length === 0) {
                document.getElementById('all-rides').innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Keine Fahrten</div>';
            } else {
                document.getElementById('all-rides').innerHTML = rides.slice().reverse().map(r => {
                    let statusText = r.status;
                    let statusColor = '#fef3c7';
                    if (r.status === 'completed') { statusText = 'Abgeschlossen'; statusColor = '#d1fae5'; }
                    else if (r.status === 'accepted') { statusText = 'Unterwegs'; statusColor = '#dbeafe'; }
                    else if (r.status === 'picked_up') { statusText = 'Besetzt'; statusColor = '#fef3c7'; }
                    else if (r.status === 'new') { statusText = 'Neu'; statusColor = '#fef3c7'; }
                    
                    return `<div class="ride-card">
                        <strong>#${r.id}</strong> <span style="background:${statusColor};padding:4px 8px;border-radius:12px;font-size:12px;">${statusText}</span>
                        <div style="margin-top:10px;font-size:14px;">
                            Von: ${r.pickup}<br>
                            Nach: ${r.destination}<br>
                            ${r.distance} km<br>
                            Preis: ${r.price}‚Ç¨
                            ${r.vehicle ? '<br>Fahrzeug: '+r.vehicle : ''}
                            ${r.vehiclePlate ? ' ('+r.vehiclePlate+')' : ''}
                        </div>
                    </div>`;
                }).join('');
            }
        }

        // DATABASE FUNCTIONS
        async function saveRide(ride) {
            if (isFirebaseReady) {
                const ref = db.ref('rides').push();
                ride.firebaseId = ref.key;
                await ref.set(ride);
            }
            return ride;
        }

        async function updateRide(id, updates) {
            if (isFirebaseReady) await db.ref('rides/' + id).update(updates);
        }

        // GEOCODING & ROUTING
        async function geocode(address) {
            // Zuerst in bekannten Orten suchen
            const searchKey = address.toLowerCase().trim();
            if (KNOWN_PLACES[searchKey]) {
                console.log('‚úÖ Ort aus Cache:', KNOWN_PLACES[searchKey].name);
                return KNOWN_PLACES[searchKey];
            }
            
            // Dann via API suchen
            try {
                // Versuche zuerst mit Usedom, Deutschland
                let response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Usedom, Deutschland')}&limit=1`);
                let data = await response.json();
                
                // Wenn nichts gefunden, versuche nur mit Deutschland
                if (data.length === 0) {
                    response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Deutschland')}&limit=1`);
                    data = await response.json();
                }
                
                // Wenn immer noch nichts, versuche ohne Zusatz
                if (data.length === 0) {
                    response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
                    data = await response.json();
                }
                
                if (data.length > 0) {
                    console.log('‚úÖ Ort gefunden:', address, '‚Üí', data[0].display_name);
                    return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
                } else {
                    console.warn('‚ö†Ô∏è Ort nicht gefunden:', address);
                }
            } catch (e) { 
                console.error('‚ùå Geocoding Fehler:', e); 
            }
            return null;
        }

        async function calculateRoute(from, to) {
            try {
                const response = await fetch(`https://router.project-osrm.org/route/v1/driving/${from.lon},${from.lat};${to.lon},${to.lat}?overview=false`);
                const data = await response.json();
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    return { distance: (route.distance / 1000).toFixed(1), duration: Math.round(route.duration / 60) };
                }
            } catch (e) { console.error(e); }
            return { distance: 0, duration: 0 };
        }

        function calculatePrice(distance) {
            const now = new Date(), hour = now.getHours(), day = now.getDay();
            let base = TARIF.grundgebuehr + distance * TARIF.kmPreis, zuschlag = 0, text = [];
            if (hour >= 22 || hour < 6) { zuschlag += base * TARIF.nachtZuschlag; text.push('Nacht +20%'); }
            if (day === 0) { zuschlag += base * TARIF.sonntagZuschlag; text.push('Sonntag +25%'); }
            
            const totalRaw = base + zuschlag;
            const totalRounded = Math.round(totalRaw / 0.1) * 0.1; // Runde auf 10 Cent
            
            return { total: totalRounded.toFixed(2), zuschlagText: text, distance };
        }

        // AUTOCOMPLETE
        let autocompleteTimeout = null;
        
        function setupAutocomplete() {
            ['pickup', 'destination'].forEach(id => {
                const input = document.getElementById(id);
                const dropdown = document.getElementById(id + '-dropdown');
                
                input.addEventListener('input', (e) => {
                    // Reset coords wenn User manuell tippt
                    if (id === 'pickup') pickupCoords = null;
                    else destCoords = null;
                    
                    clearTimeout(autocompleteTimeout);
                    const value = e.target.value.trim();
                    
                    if (value.length < 3) {
                        dropdown.style.display = 'none';
                        return;
                    }
                    
                    // Zeige "L√§dt..." sofort
                    dropdown.innerHTML = '<div class="autocomplete-item" style="color:#999;">Suche...</div>';
                    dropdown.style.display = 'block';
                    
                    // Verz√∂gerte Suche (Debounce)
                    autocompleteTimeout = setTimeout(() => {
                        searchAddresses(value, id);
                    }, 300);
                });
                
                // Schlie√üe Dropdown wenn au√üerhalb geklickt
                document.addEventListener('click', (e) => {
                    if (e.target !== input && !dropdown.contains(e.target)) {
                        dropdown.style.display = 'none';
                    }
                });
            });
            
            document.getElementById('pickup-time').addEventListener('change', (e) => {
                const customTime = document.getElementById('custom-time');
                if (e.target.value === 'custom') customTime.style.display = 'block';
                else customTime.style.display = 'none';
            });
        }

        async function searchAddresses(query, inputId) {
            const dropdown = document.getElementById(inputId + '-dropdown');
            
            try {
                // Suche mit Nominatim API
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?` +
                    `format=json&` +
                    `q=${encodeURIComponent(query)}&` +
                    `countrycodes=de&` +
                    `limit=8&` +
                    `addressdetails=1`
                );
                
                const results = await response.json();
                
                if (results.length === 0) {
                    dropdown.innerHTML = '<div class="autocomplete-item" style="color:#999;">Keine Ergebnisse</div>';
                    return;
                }
                
                // Filtere nur Usedom-relevante Ergebnisse
                const usedomResults = results.filter(r => {
                    const display = r.display_name.toLowerCase();
                    return display.includes('usedom') || 
                           display.includes('heringsdorf') || 
                           display.includes('ahlbeck') ||
                           display.includes('bansin') ||
                           display.includes('zinnowitz') ||
                           display.includes('karlshagen') ||
                           display.includes('peenem√ºnde') ||
                           display.includes('koserow') ||
                           display.includes('√ºckeritz') ||
                           display.includes('loddin') ||
                           display.includes('zempin') ||
                           display.includes('trassenheide');
                });
                
                const resultsToShow = usedomResults.length > 0 ? usedomResults : results;
                
                dropdown.innerHTML = resultsToShow.map(r => {
                    const address = r.address;
                    let displayText = '';
                    let fullAddress = '';
                    
                    // üè® HOTEL, RESTAURANT, POI Namen (z.B. "Pommerscher Hof")
                    const poiName = address.amenity || address.tourism || address.building || r.name;
                    
                    // Baue Haupt-Adresszeile
                    if (address.road) {
                        fullAddress = address.road;
                        if (address.house_number) fullAddress += ' ' + address.house_number;
                    }
                    
                    // Ort
                    let city = '';
                    if (address.village) city = address.village;
                    else if (address.town) city = address.town;
                    else if (address.city) city = address.city;
                    else if (address.municipality) city = address.municipality;
                    
                    // PLZ
                    const zip = address.postcode || '';
                    
                    // üé® Baue sch√∂ne Anzeige
                    if (poiName && poiName !== fullAddress && poiName !== city) {
                        // Zeige: "üè® Pommerscher Hof" in erster Zeile
                        displayText = `<div style="font-weight:600;color:#667eea;">üè® ${poiName}</div>`;
                        // Zeige: "   Seestra√üe 41, 17424 Heringsdorf" in zweiter Zeile
                        displayText += `<div style="font-size:13px;color:#666;margin-top:2px;padding-left:20px;">`;
                        if (fullAddress) displayText += fullAddress;
                        if (zip) displayText += ', ' + zip;
                        if (city) displayText += ' ' + city;
                        displayText += '</div>';
                    } else {
                        // Normale Adresse ohne POI
                        if (fullAddress) {
                            displayText = fullAddress;
                            if (zip) displayText += ', ' + zip;
                            if (city) displayText += ' ' + city;
                        } else {
                            displayText = r.display_name;
                        }
                    }
                    
                    // F√ºr selectAddress: Vollst√§ndige Adresse als String
                    let addressString = '';
                    if (poiName && poiName !== fullAddress && poiName !== city) {
                        addressString = poiName + '\\n';
                    }
                    if (fullAddress) addressString += fullAddress;
                    if (zip) addressString += ', ' + zip;
                    if (city) addressString += ' ' + city;
                    
                    if (!addressString) addressString = r.display_name;
                    
                    return `<div class="autocomplete-item" 
                        onclick="selectAddress('${inputId}', '${addressString.replace(/'/g, "\\'")}', ${r.lat}, ${r.lon})">
                        ${displayText}
                    </div>`;
                }).join('');
                
            } catch (e) {
                console.error('Autocomplete Fehler:', e);
                dropdown.innerHTML = '<div class="autocomplete-item" style="color:#ef4444;">Fehler bei der Suche</div>';
            }
        }

        function selectAddress(inputId, address, lat, lon) {
            document.getElementById(inputId).value = address;
            document.getElementById(inputId + '-dropdown').style.display = 'none';
            
            // Speichere Koordinaten
            if (inputId === 'pickup') {
                pickupCoords = { lat: parseFloat(lat), lon: parseFloat(lon) };
                console.log('‚úÖ Abholort gespeichert:', address, pickupCoords);
                showAvailableTaxis();
            } else {
                destCoords = { lat: parseFloat(lat), lon: parseFloat(lon) };
                console.log('‚úÖ Zielort gespeichert:', address, destCoords);
            }
        }

        // LOCATION
        function useMyLocation() {
            if (!navigator.geolocation) {
                alert('‚ùå GPS nicht verf√ºgbar!');
                return;
            }
            
            // Zeige Loading
            const pickupInput = document.getElementById('pickup-uber') || document.getElementById('pickup');
            const originalPlaceholder = pickupInput.placeholder;
            pickupInput.placeholder = 'üìç Standort wird ermittelt...';
            
            navigator.geolocation.getCurrentPosition(
                async (pos) => {
                    pickupCoords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pickupCoords.lat}&lon=${pickupCoords.lon}`);
                        const data = await response.json();
                        const address = data.address;
                        const street = address.road || address.pedestrian || '';
                        const houseNumber = address.house_number || '';
                        const city = address.town || address.village || address.city || 'Heringsdorf';
                        const locationText = `${street} ${houseNumber}, ${city}`.trim();
                        
                        // F√ºlle BEIDE Input-Felder (Uber-Style und Old-Style)
                        if (document.getElementById('pickup-uber')) {
                            document.getElementById('pickup-uber').value = locationText;
                        }
                        if (document.getElementById('pickup')) {
                            document.getElementById('pickup').value = locationText;
                        }
                        
                        pickupInput.placeholder = originalPlaceholder;
                        
                        // Zeige auf Karte wenn Uber-Map aktiv ist
                        if (uberMap) {
                            uberMap.setView([pickupCoords.lat, pickupCoords.lon], 15);
                            
                            // Marker setzen
                            L.circleMarker([pickupCoords.lat, pickupCoords.lon], {
                                radius: 8,
                                fillColor: '#10b981',
                                fillOpacity: 1,
                                color: '#fff',
                                weight: 3
                            }).addTo(uberMap);
                        }
                        
                        showAvailableTaxis();
                    } catch (e) {
                        console.error(e);
                        const coordsText = `${pickupCoords.lat.toFixed(4)}, ${pickupCoords.lon.toFixed(4)}`;
                        if (document.getElementById('pickup-uber')) {
                            document.getElementById('pickup-uber').value = coordsText;
                        }
                        if (document.getElementById('pickup')) {
                            document.getElementById('pickup').value = coordsText;
                        }
                        pickupInput.placeholder = originalPlaceholder;
                    }
                },
                (err) => {
                    pickupInput.placeholder = originalPlaceholder;
                    alert('‚ùå GPS-Fehler: ' + err.message);
                }
            );
        }

        async function showAvailableTaxis() {
            if (!pickupCoords || !isFirebaseReady) return;
            
            const onlineDrivers = Object.values(drivers).filter(d => d.online && d.timestamp && (Date.now() - d.timestamp) < 60000);
            
            if (onlineDrivers.length === 0) {
                document.getElementById('available-taxis-display').innerHTML = '<div class="alert-info">‚è≥ Momentan keine Taxis verf√ºgbar</div>';
                return;
            }
            
            const taxisWithETA = await Promise.all(onlineDrivers.map(async (d) => {
                const route = await calculateRoute(d, pickupCoords);
                return { ...d, ...route };
            }));
            
            taxisWithETA.sort((a, b) => a.distance - b.distance);
            
            const html = `<div class="available-taxis"><h3>üöï ${taxisWithETA.length} Taxis verf√ºgbar</h3>` +
                taxisWithETA.slice(0, 3).map(t => {
                    const plate = VEHICLES[t.vehicleId] ? VEHICLES[t.vehicleId].plate : '';
                    return `<div class="taxi-item"><strong>${t.vehicle}</strong>${plate ? `<br>üöó ${plate}` : ''}<br>üìç ${t.distance} km entfernt (ca. ${t.duration} Min)</div>`;
                }).join('') +
                `<div style="margin-top:10px;padding:10px;background:#e0f2fe;border-radius:8px;text-align:center;"><strong>N√§chstes Taxi in ca. ${taxisWithETA[0].duration} Minuten!</strong></div></div>`;
            document.getElementById('available-taxis-display').innerHTML = html;
        }

        // BOOKING
        async function calculatePriceAndShow() {
            const pickup = document.getElementById('pickup').value.trim();
            const destination = document.getElementById('destination').value.trim();
            
            if (!pickup || !destination) {
                alert('‚ùå Bitte Abholort und Zielort eingeben!');
                return;
            }
            
            // Wenn Coords noch nicht vorhanden (User hat nicht aus Autocomplete gew√§hlt), geocode
            if (!pickupCoords) {
                pickupCoords = await geocode(pickup);
                if (!pickupCoords) {
                    alert('‚ùå Abholort "' + pickup + '" nicht gefunden!\n\nTipp: Nutze die Autocomplete-Vorschl√§ge');
                    return;
                }
            }
            
            if (!destCoords) {
                destCoords = await geocode(destination);
                if (!destCoords) {
                    alert('‚ùå Zielort "' + destination + '" nicht gefunden!\n\nTipp: Nutze die Autocomplete-Vorschl√§ge');
                    return;
                }
            }
            
            const route = await calculateRoute(pickupCoords, destCoords);
            const pricing = calculatePrice(parseFloat(route.distance));
            
            window.currentPrice = pricing.total;
            window.currentDistance = route.distance;
            window.currentDuration = route.duration;
            
            let priceHtml = `<div style="background:white;padding:15px;border-radius:8px;border:2px solid #10b981;">
                <div style="font-size:32px;font-weight:bold;color:#10b981;text-align:center;">${pricing.total}‚Ç¨</div>
                <div style="text-align:center;margin-top:8px;color:#666;">
                    ${route.distance} km ‚Ä¢ ${route.duration} Min Fahrt
                </div>`;
            
            if (pricing.zuschlagText.length > 0) {
                priceHtml += `<div style="margin-top:10px;padding:8px;background:#fef3c7;border-radius:6px;font-size:13px;text-align:center;">
                    ${pricing.zuschlagText.join(' ‚Ä¢ ')}
                </div>`;
            }
            
            priceHtml += '</div>';
            
            document.getElementById('price-display').innerHTML = priceHtml;
            document.getElementById('book-btn').style.display = 'block';
        }

        // üéØ INTELLIGENTE AUTO-ZUWEISUNG MIT 30-SEK-TIMER
        async function startAutoAssignment(rideId, ride) {
            console.log('üéØ Starte Auto-Zuweisung f√ºr Fahrt:', rideId);
            
            // Finde n√§chstes verf√ºgbares Taxi
            const nearestVehicle = findNearestAvailableVehicle(ride.pickupCoords);
            
            if (!nearestVehicle) {
                console.log('‚ö†Ô∏è Kein Taxi verf√ºgbar - Fahrt bleibt in Warteschlange');
                return;
            }
            
            console.log('‚úÖ N√§chstes Taxi gefunden:', nearestVehicle.id, 'Entfernung:', nearestVehicle.distance.toFixed(2), 'km');
            
            // Markiere Fahrt als zugewiesen
            await db.ref('rides/' + rideId).update({
                assignedTo: nearestVehicle.id,
                assignedVehicleName: nearestVehicle.name,
                assignedAt: Date.now(),
                assignmentExpiresAt: Date.now() + 30000, // 30 Sekunden
                assignmentDistance: nearestVehicle.distance
            });
            
            // Push-Benachrichtigung an Fahrer
            sendLocalNotification(
                'üöï NEUE FAHRT!',
                `${ride.customerName || 'Fahrgast'} ‚Ä¢ ${ride.pickup} ‚Üí ${ride.destination}\nüí∞ ${ride.price}‚Ç¨ ‚Ä¢ ‚è±Ô∏è 30 Sekunden Zeit!`,
                { rideId: rideId, vehicleId: nearestVehicle.id }
            );
            
            // Starte 30-Sekunden-Timer
            assignmentTimers[rideId] = setTimeout(async () => {
                // Pr√ºfe ob Fahrt in 30 Sek. angenommen wurde
                const rideCheck = await db.ref('rides/' + rideId).once('value');
                const rideData = rideCheck.val();
                
                if (rideData && rideData.status === 'new') {
                    console.log('‚è∞ TIMEOUT! Fahrt nicht angenommen - weise n√§chstem Taxi zu');
                    
                    // Zur Blacklist hinzuf√ºgen (f√ºr diese Fahrt)
                    const blacklist = rideData.assignmentBlacklist || [];
                    blacklist.push(nearestVehicle.id);
                    
                    await db.ref('rides/' + rideId).update({
                        assignedTo: null,
                        assignmentBlacklist: blacklist,
                        lastAssignmentTimeout: Date.now()
                    });
                    
                    // N√§chstes Taxi zuweisen
                    startAutoAssignment(rideId, rideData);
                }
            }, 30000);
        }

        // Finde n√§chstes verf√ºgbares Taxi nach GPS-Entfernung
        function findNearestAvailableVehicle(pickupCoords) {
            const availableVehicles = [];
            
            // Durchsuche alle Online-Fahrer
            for (const vehicleId in drivers) {
                const driver = drivers[vehicleId];
                
                // Pr√ºfungen:
                // 1. Fahrer ist online
                // 2. Hat GPS-Position
                // 3. Hat keine aktive Fahrt
                if (driver && driver.online && driver.lat && driver.lon) {
                    // Pr√ºfe ob Fahrzeug bereits eine Fahrt hat
                    const hasActiveRide = rides.some(r => 
                        (r.vehicleId === vehicleId || r.assignedTo === vehicleId) && 
                        (r.status === 'accepted' || r.status === 'picked_up')
                    );
                    
                    if (!hasActiveRide) {
                        // Berechne Entfernung
                        const distance = calculateDistance(
                            pickupCoords.lat, pickupCoords.lon,
                            driver.lat, driver.lon
                        );
                        
                        availableVehicles.push({
                            id: vehicleId,
                            name: driver.vehicle || VEHICLES[vehicleId]?.name || vehicleId,
                            distance: distance,
                            lat: driver.lat,
                            lon: driver.lon
                        });
                    }
                }
            }
            
            // Sortiere nach Entfernung (n√§chstes zuerst)
            availableVehicles.sort((a, b) => a.distance - b.distance);
            
            console.log('üìç Verf√ºgbare Taxis:', availableVehicles.length, availableVehicles);
            
            return availableVehicles.length > 0 ? availableVehicles[0] : null;
        }

        // Haversine-Formel f√ºr Entfernungsberechnung
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Erdradius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // üé® UBER-STYLE INTERFACE FUNCTIONS
        
        function initUberMap() {
            if (uberMap) {
                // Map existiert schon, nur invalidateSize aufrufen
                setTimeout(() => {
                    if (uberMap) uberMap.invalidateSize();
                }, 100);
                return;
            }
            
            console.log('üó∫Ô∏è Initialisiere Uber-Karte');
            const mapContainer = document.getElementById('uber-map');
            if (!mapContainer) {
                console.error('‚ùå uber-map Container nicht gefunden');
                return;
            }
            
            try {
                uberMap = L.map('uber-map', {
                    zoomControl: false,
                    attributionControl: false
                }).setView([53.9533, 14.1633], 12);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19
                }).addTo(uberMap);
                
                // Force map refresh nach kurzer Verz√∂gerung
                setTimeout(() => {
                    if (uberMap) {
                        uberMap.invalidateSize();
                        console.log('‚úÖ Uber-Karte initialisiert und refreshed');
                    }
                }, 200);
                
                // Autocomplete f√ºr Uber-Inputs einrichten
                setupUberAutocomplete();
                
                // Event Listeners f√ºr Adress-Eingaben
                const pickupUber = document.getElementById('pickup-uber');
                const destUber = document.getElementById('destination-uber');
                
                if (pickupUber) pickupUber.addEventListener('input', handleUberAddressInput);
                if (destUber) destUber.addEventListener('input', handleUberAddressInput);
                
            } catch (e) {
                console.error('‚ùå Fehler beim Initialisieren der Uber-Karte:', e);
            }
        }
        
        async function handleUberAddressInput() {
            const pickup = document.getElementById('pickup-uber').value.trim();
            const dest = document.getElementById('destination-uber').value.trim();
            
            // Pr√ºfe ob beide Koordinaten bereits gesetzt sind (durch Autocomplete)
            if (pickupCoords && destCoords) {
                // Route berechnen
                await calculateUberRoute(pickupCoords, destCoords);
                
                // Bottom Sheet zeigen
                showUberBottomSheet();
            }
        }
        
        async function calculateUberRoute(from, to) {
            try {
                const response = await fetch(
                    `https://router.project-osrm.org/route/v1/driving/${from.lon},${from.lat};${to.lon},${to.lat}?overview=full&geometries=geojson`
                );
                const data = await response.json();
                
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    calculatedRoute = {
                        distance: (route.distance / 1000).toFixed(1), // km
                        duration: Math.round(route.duration / 60), // min
                        geometry: route.geometry
                    };
                    
                    // Route auf Karte zeichnen
                    drawUberRoute(route.geometry);
                    
                    // Karte an Route anpassen
                    const coords = route.geometry.coordinates;
                    const latLngs = coords.map(c => [c[1], c[0]]);
                    const bounds = L.latLngBounds(latLngs);
                    uberMap.fitBounds(bounds, { padding: [50, 50] });
                    
                    console.log('‚úÖ Route berechnet:', calculatedRoute);
                }
            } catch (e) {
                console.error('‚ùå Route-Fehler:', e);
            }
        }
        
        function drawUberRoute(geometry) {
            // Entferne alte Route
            if (routePolyline) {
                uberMap.removeLayer(routePolyline);
            }
            
            // Zeichne neue Route
            const coords = geometry.coordinates;
            const latLngs = coords.map(c => [c[1], c[0]]);
            
            routePolyline = L.polyline(latLngs, {
                color: '#000',
                weight: 4,
                opacity: 0.8
            }).addTo(uberMap);
            
            // Marker f√ºr Start und Ziel
            L.circleMarker([latLngs[0][0], latLngs[0][1]], {
                radius: 8,
                fillColor: '#10b981',
                fillOpacity: 1,
                color: '#fff',
                weight: 3
            }).addTo(uberMap);
            
            L.circleMarker([latLngs[latLngs.length-1][0], latLngs[latLngs.length-1][1]], {
                radius: 8,
                fillColor: '#667eea',
                fillOpacity: 1,
                color: '#fff',
                weight: 3
            }).addTo(uberMap);
        }
        
        function showUberBottomSheet() {
            document.getElementById('uber-bottom-sheet').style.display = 'block';
            
            // Fahrzeug-Optionen anzeigen
            showVehicleOptions();
            
            // Preis berechnen
            updateUberPrice();
            
            // Buch-Button zeigen
            document.getElementById('uber-book-button').style.display = 'block';
        }
        
        function showVehicleOptions() {
            const container = document.getElementById('vehicle-options-container');
            container.innerHTML = '';
            
            // Z√§hle verf√ºgbare Taxis
            const availableTaxis = Object.values(drivers).filter(d => d.status === 'available').length;
            
            Object.values(VEHICLE_TYPES).forEach(type => {
                const price = calculateVehiclePrice(type);
                const eta = availableTaxis > 0 ? `${Math.floor(Math.random() * 5) + 3} Min` : 'Nicht verf√ºgbar';
                
                const option = document.createElement('div');
                option.className = 'vehicle-option' + (type.id === selectedVehicleType ? ' selected' : '');
                option.onclick = () => selectVehicleType(type.id);
                
                option.innerHTML = `
                    <div class="vehicle-icon">${type.icon}</div>
                    <div class="vehicle-info">
                        <div class="vehicle-name">${type.name}</div>
                        <div class="vehicle-details">${type.description}</div>
                        <div class="vehicle-eta">‚è±Ô∏è ${eta}</div>
                    </div>
                    <div class="vehicle-price">${price}</div>
                `;
                
                container.appendChild(option);
            });
        }
        
        function calculateVehiclePrice(vehicleType) {
            if (!calculatedRoute) return '‚Äî';
            
            if (vehicleType.special === 'insurance') {
                return 'Auf Rechnung';
            }
            
            const distance = parseFloat(calculatedRoute.distance);
            const basePrice = vehicleType.baseFare;
            const kmPrice = distance * vehicleType.pricePerKm;
            const total = Math.ceil((basePrice + kmPrice) * 10) / 10;
            
            return total.toFixed(2) + '‚Ç¨';
        }
        
        function selectVehicleType(typeId) {
            selectedVehicleType = typeId;
            
            // Update UI
            document.querySelectorAll('.vehicle-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.target.closest('.vehicle-option').classList.add('selected');
            
            // Update Preis
            updateUberPrice();
        }
        
        function selectPayment(method) {
            selectedPaymentMethod = method;
            
            // Update UI
            document.querySelectorAll('.payment-option').forEach(opt => {
                opt.classList.remove('selected');
                opt.querySelector('div:last-child').textContent = '';
            });
            
            const selected = document.querySelector(`[data-payment="${method}"]`);
            selected.classList.add('selected');
            selected.querySelector('div:last-child').innerHTML = '<div style="color:#667eea;font-weight:600;">‚úì</div>';
        }
        
        function updateUberPrice() {
            const vehicleType = VEHICLE_TYPES[selectedVehicleType];
            if (!vehicleType || !calculatedRoute) return;
            
            const breakdown = document.getElementById('price-breakdown-uber');
            breakdown.style.display = 'block';
            
            if (vehicleType.special === 'insurance') {
                breakdown.innerHTML = `
                    <div class="price-row" style="text-align:center;color:#10b981;font-weight:600;">
                        üè• Abrechnung mit Krankenkasse<br>
                        <span style="font-size:12px;color:#6b7280;">Kostenlos f√ºr Sie</span>
                    </div>
                `;
                document.getElementById('uber-book-button').textContent = 'Krankenfahrt buchen';
                return;
            }
            
            const distance = parseFloat(calculatedRoute.distance);
            const basePrice = vehicleType.baseFare;
            const kmPrice = distance * vehicleType.pricePerKm;
            const total = Math.ceil((basePrice + kmPrice) * 10) / 10;
            
            document.getElementById('price-base').textContent = basePrice.toFixed(2) + '‚Ç¨';
            document.getElementById('price-distance-label').textContent = `Strecke (${distance} km)`;
            document.getElementById('price-distance-value').textContent = kmPrice.toFixed(2) + '‚Ç¨';
            document.getElementById('price-total-uber').textContent = total.toFixed(2) + '‚Ç¨';
            document.getElementById('uber-book-button').textContent = `F√ºr ${total.toFixed(2)}‚Ç¨ buchen`;
        }
        
        async function bookUber() {
            const name = document.getElementById('customer-name-uber').value.trim();
            
            if (!name) {
                alert('Bitte geben Sie Ihren Namen ein!');
                return;
            }
            
            if (!pickupCoords || !destCoords) {
                alert('Bitte geben Sie Abholort und Ziel ein!');
                return;
            }
            
            const vehicleType = VEHICLE_TYPES[selectedVehicleType];
            const distance = parseFloat(calculatedRoute.distance);
            
            let price;
            if (vehicleType.special === 'insurance') {
                price = 'Krankenkasse';
            } else {
                const basePrice = vehicleType.baseFare;
                const kmPrice = distance * vehicleType.pricePerKm;
                price = Math.ceil((basePrice + kmPrice) * 10) / 10;
            }
            
            // Fahrt erstellen
            const ride = {
                id: 'R' + Date.now(),
                customerName: name,
                pickup: document.getElementById('pickup-uber').value,
                destination: document.getElementById('destination-uber').value,
                pickupCoords: pickupCoords,
                destCoords: destCoords,
                passengers: 1,
                vehicleType: selectedVehicleType,
                vehicleTypeName: vehicleType.name,
                paymentMethod: selectedPaymentMethod,
                price: price,
                distance: distance,
                status: 'new',
                timestamp: new Date().toISOString(),
                pickupTime: 'jetzt'
            };
            
            console.log('üöï Buche Fahrt:', ride);
            
            if (isFirebaseReady) {
                try {
                    await db.ref('rides').push(ride);
                    console.log('‚úÖ Fahrt in Firebase gespeichert');
                    myCurrentRide = ride;
                    localStorage.setItem('myCurrentRideId', ride.id);
                    
                    // Stammkunde speichern?
                    if (document.getElementById('save-customer-uber').checked) {
                        saveRegularCustomer(name, document.getElementById('pickup-uber').value);
                    }
                    
                    alert('‚úÖ Taxi gebucht!\n\nEin Fahrer wird Ihnen gleich zugewiesen.');
                    
                    // UI zur√ºcksetzen
                    document.getElementById('uber-bottom-sheet').style.display = 'none';
                    
                } catch (e) {
                    console.error('‚ùå Buchungsfehler:', e);
                    alert('‚ùå Fehler beim Buchen: ' + e.message);
                }
            }
        }
        
        function focusInput(id) {
            document.getElementById(id).focus();
        }
        
        function setupUberAutocomplete() {
            // Autocomplete f√ºr Uber-Style Inputs
            const pickupInput = document.getElementById('pickup-uber');
            const destInput = document.getElementById('destination-uber');
            
            if (!pickupInput || !destInput) return;
            
            // Erstelle Dropdown-Container
            const pickupDropdown = document.createElement('div');
            pickupDropdown.className = 'autocomplete-dropdown';
            pickupDropdown.id = 'pickup-uber-dropdown';
            pickupDropdown.style.cssText = 'position:absolute;background:white;border:1px solid #e0e0e0;border-radius:8px;margin-top:4px;max-height:250px;overflow-y:auto;display:none;z-index:1000;width:100%;box-shadow:0 4px 12px rgba(0,0,0,0.15);';
            pickupInput.parentElement.appendChild(pickupDropdown);
            
            const destDropdown = document.createElement('div');
            destDropdown.className = 'autocomplete-dropdown';
            destDropdown.id = 'destination-uber-dropdown';
            destDropdown.style.cssText = 'position:absolute;background:white;border:1px solid #e0e0e0;border-radius:8px;margin-top:4px;max-height:250px;overflow-y:auto;display:none;z-index:1000;width:100%;box-shadow:0 4px 12px rgba(0,0,0,0.15);';
            destInput.parentElement.appendChild(destDropdown);
            
            // Event Listeners
            pickupInput.addEventListener('input', () => handleAutocompleteInput(pickupInput, pickupDropdown, 'pickup'));
            destInput.addEventListener('input', () => handleAutocompleteInput(destInput, destDropdown, 'destination'));
            
            // Schlie√üe Dropdown wenn au√üerhalb geklickt wird
            document.addEventListener('click', (e) => {
                if (!pickupInput.contains(e.target) && !pickupDropdown.contains(e.target)) {
                    pickupDropdown.style.display = 'none';
                }
                if (!destInput.contains(e.target) && !destDropdown.contains(e.target)) {
                    destDropdown.style.display = 'none';
                }
            });
        }
        
        async function handleAutocompleteInput(input, dropdown, type) {
            const query = input.value.trim().toLowerCase();
            
            if (query.length < 2) {
                dropdown.style.display = 'none';
                return;
            }
            
            // Suche in KNOWN_PLACES
            const localResults = Object.entries(KNOWN_PLACES)
                .filter(([key, place]) => {
                    return key.toLowerCase().includes(query) || 
                           place.name.toLowerCase().includes(query);
                })
                .slice(0, 5)
                .map(([key, place]) => ({
                    name: place.name,
                    lat: place.lat,
                    lon: place.lon,
                    type: 'local'
                }));
            
            // Wenn lokale Ergebnisse gefunden, zeige sie
            if (localResults.length > 0) {
                showAutocompleteResults(localResults, dropdown, input, type);
                return;
            }
            
            // Sonst: OpenStreetMap API
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)},Usedom,Germany&limit=5`
                );
                const results = await response.json();
                
                if (results.length > 0) {
                    const formatted = results.map(r => ({
                        name: r.display_name.split(',').slice(0, 3).join(','),
                        lat: parseFloat(r.lat),
                        lon: parseFloat(r.lon),
                        type: 'osm'
                    }));
                    showAutocompleteResults(formatted, dropdown, input, type);
                } else {
                    dropdown.style.display = 'none';
                }
            } catch (e) {
                console.error('Autocomplete Fehler:', e);
                dropdown.style.display = 'none';
            }
        }
        
        function showAutocompleteResults(results, dropdown, input, type) {
            dropdown.innerHTML = results.map(r => {
                return `<div class="autocomplete-item" style="padding:12px;cursor:pointer;border-bottom:1px solid #f0f0f0;" 
                        onclick='selectAutocompleteResult(${JSON.stringify(r)}, "${input.id}", "${type}")'>
                    <div style="font-weight:500;">${r.name}</div>
                    ${r.type === 'local' ? '<div style="font-size:12px;color:#10b981;">‚≠ê Bekannter Ort</div>' : ''}
                </div>`;
            }).join('');
            
            dropdown.style.display = 'block';
        }
        
        function selectAutocompleteResult(result, inputId, type) {
            const input = document.getElementById(inputId);
            input.value = result.name;
            
            // Speichere Koordinaten
            if (type === 'pickup') {
                pickupCoords = { lat: result.lat, lon: result.lon };
            } else {
                destCoords = { lat: result.lat, lon: result.lon };
            }
            
            // Schlie√üe Dropdown
            const dropdown = document.getElementById(inputId + '-dropdown');
            if (dropdown) dropdown.style.display = 'none';
            
            // Wenn beide Adressen vorhanden, berechne Route
            if (pickupCoords && destCoords) {
                calculateUberRoute(pickupCoords, destCoords);
            }
        }

        async function book() {
            const customerName = document.getElementById('customer-name').value.trim();
            const pickupTimeSelect = document.getElementById('pickup-time').value;
            const customDateTime = document.getElementById('custom-datetime').value;
            
            if (!customerName) {
                alert('‚ùå Bitte Name eingeben!');
                return;
            }
            
            let pickupTime = 'Sofort';
            let pickupTimestamp = Date.now();
            const now = new Date();
            
            if (pickupTimeSelect === '15min') {
                pickupTime = new Date(now.getTime() + 15 * 60000).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                pickupTimestamp = now.getTime() + 15 * 60000;
            } else if (pickupTimeSelect === '30min') {
                pickupTime = new Date(now.getTime() + 30 * 60000).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                pickupTimestamp = now.getTime() + 30 * 60000;
            } else if (pickupTimeSelect === '1h') {
                pickupTime = new Date(now.getTime() + 60 * 60000).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                pickupTimestamp = now.getTime() + 60 * 60000;
            } else if (pickupTimeSelect === 'datetime' && customDateTime) {
                // Datum & Zeit aus datetime-local
                const selectedDate = new Date(customDateTime);
                pickupTimestamp = selectedDate.getTime();
                
                // Formatiere als "22.11.2024, 08:00"
                pickupTime = selectedDate.toLocaleString('de-DE', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                // Pr√ºfe ob in der Vergangenheit
                if (pickupTimestamp < Date.now()) {
                    alert('‚ùå Die Abholzeit liegt in der Vergangenheit!\n\nBitte w√§hle eine Zeit in der Zukunft.');
                    return;
                }
                
                // Warnung wenn sehr weit in der Zukunft (mehr als 7 Tage)
                const daysDiff = (pickupTimestamp - Date.now()) / (1000 * 60 * 60 * 24);
                if (daysDiff > 7) {
                    const confirm = window.confirm(
                        `üìÖ Buchung f√ºr ${Math.floor(daysDiff)} Tage im Voraus\n\n` +
                        `Abholung: ${pickupTime}\n\n` +
                        `M√∂chtest du diese Vorausbuchung best√§tigen?`
                    );
                    if (!confirm) return;
                }
            }
            
            const ride = {
                id: Date.now(),
                customerName,
                pickupTime,
                pickupTimestamp,
                pickup: document.getElementById('pickup').value,
                destination: document.getElementById('destination').value,
                passengers: document.getElementById('passengers').value,
                price: window.currentPrice,
                distance: window.currentDistance,
                duration: window.currentDuration,
                pickupCoords, destCoords,
                status: 'new',
                time: new Date().toLocaleString('de-DE'),
                createdAt: Date.now()
            };
            
            const savedRide = await saveRide(ride);
            myCurrentRide = savedRide;
            localStorage.setItem('myCurrentRideId', savedRide.firebaseId);
            
            // üíæ Stammkunde speichern wenn gew√ºnscht
            saveRegularCustomerData(customerName, ride.pickup, ride.destination);
            
            // üéØ AUTO-ZUWEISUNG starten
            if (isFirebaseReady && savedRide.firebaseId) {
                startAutoAssignment(savedRide.firebaseId, savedRide);
            }
            
            document.getElementById('booking-form').style.display = 'none';
            showRideStatus(savedRide);
            
            if (isFirebaseReady) listenToMyRide(savedRide.firebaseId);
        }

        function listenToMyRide(rideId) {
            if (!isFirebaseReady) return;
            db.ref('rides/' + rideId).on('value', (s) => {
                const ride = s.val();
                if (ride) {
                    ride.firebaseId = rideId;
                    myCurrentRide = ride;
                    showRideStatus(ride);
                }
            });
        }

        async function cancelRideConfirm(rideId) {
            const ride = myCurrentRide;
            
            let confirmMessage = 'üóëÔ∏è Fahrt wirklich stornieren?\n\nDie Buchung wird gel√∂scht.';
            let hasCancellationFee = false;
            let cancellationFee = 0;
            
            // Stornogeb√ºhr wenn Fahrer schon unterwegs
            if (ride && ride.status === 'accepted') {
                if (ride.driverLocation) {
                    // FAHRER IST UNTERWEGS - KOSTENPFLICHTIG!
                    cancellationFee = 10.00; // 10‚Ç¨ Stornogeb√ºhr
                    hasCancellationFee = true;
                    
                    confirmMessage = '‚ö†Ô∏è KOSTENPFLICHTIGE STORNIERUNG!\n\n' +
                        ride.vehicle + ' ist bereits unterwegs zu dir!\n\n' +
                        'üí∂ Stornogeb√ºhr: ' + cancellationFee.toFixed(2) + '‚Ç¨\n' +
                        '(Wird bei n√§chster Fahrt berechnet)\n\n' +
                        'Trotzdem stornieren?\n\n' +
                        '(Kostenlos stornieren: 038378 / 1234)';
                } else {
                    // Fahrer hat angenommen, aber noch nicht losgefahren
                    confirmMessage = '‚ö†Ô∏è ACHTUNG!\n\n' +
                        ride.vehicle + ' hat die Fahrt bereits angenommen!\n\n' +
                        'Stornierung noch kostenlos m√∂glich.\n\n' +
                        'Trotzdem stornieren?';
                }
            }
            
            const confirmed = confirm(confirmMessage);
            
            if (!confirmed) return;
            
            // Stornogeb√ºhr speichern
            if (hasCancellationFee) {
                const cancellation = {
                    rideId: ride.id,
                    customerName: ride.customerName,
                    pickup: ride.pickup,
                    destination: ride.destination,
                    originalPrice: ride.price,
                    cancellationFee: cancellationFee,
                    cancelledAt: Date.now(),
                    reason: 'customer_cancelled_driver_on_way'
                };
                
                // Speichere Stornierung in Firebase
                if (isFirebaseReady) {
                    await db.ref('cancellations').push(cancellation);
                    console.log('üí∂ Stornogeb√ºhr gespeichert:', cancellationFee + '‚Ç¨');
                }
            }
            
            // Setze Fahrt auf storniert (nicht l√∂schen!) damit Fahrer benachrichtigt wird
            if (isFirebaseReady && rideId) {
                await db.ref('rides/' + rideId).update({
                    status: 'cancelled',
                    cancelledAt: Date.now(),
                    cancelledBy: 'passenger',
                    cancellationFee: cancellationFee,
                    driverNotified: false  // Flag: Fahrer muss noch benachrichtigt werden
                });
                console.log('‚ùå Fahrt storniert in Firebase:', rideId);
            }
            
            // Lokalen Status zur√ºcksetzen
            localStorage.removeItem('myCurrentRideId');
            myCurrentRide = null;
            document.getElementById('ride-status-container').innerHTML = '';
            document.getElementById('booking-form').style.display = 'block';
            
            if (hasCancellationFee) {
                alert('‚úÖ Fahrt storniert!\n\nüí∂ Stornogeb√ºhr: ' + cancellationFee.toFixed(2) + '‚Ç¨\n\nWird bei deiner n√§chsten Fahrt berechnet.');
            } else {
                alert('‚úÖ Fahrt storniert!');
            }
        }

        function cancelRide() {
            localStorage.removeItem('myCurrentRideId');
            myCurrentRide = null;
            document.getElementById('ride-status-container').innerHTML = '';
            document.getElementById('booking-form').style.display = 'block';
        }

        // DRIVER FUNCTIONS
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    // Wenn bereits aktiv, nicht neu anfordern
                    if (wakeLock !== null) {
                        console.log('‚úÖ Wake Lock bereits aktiv');
                        return;
                    }
                    
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('‚úÖ Screen Wake Lock aktiviert');
                    
                    wakeLock.addEventListener('release', () => {
                        console.log('‚ö†Ô∏è Wake Lock freigegeben - versuche Reaktivierung in 1 Sek');
                        wakeLock = null;
                        
                        // Automatisch neu aktivieren wenn noch online
                        if (isOnline) {
                            setTimeout(() => {
                                if (wakeLock === null && isOnline) {
                                    requestWakeLock();
                                }
                            }, 1000);
                        }
                    });
                } else {
                    console.warn('‚ö†Ô∏è Wake Lock API nicht verf√ºgbar');
                }
            } catch (err) {
                console.error('‚ùå Wake Lock Fehler:', err);
                wakeLock = null;
                
                // Bei Fehler in 5 Sekunden nochmal versuchen
                if (isOnline) {
                    setTimeout(() => {
                        if (wakeLock === null && isOnline) {
                            requestWakeLock();
                        }
                    }, 5000);
                }
            }
        }

        function releaseWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release();
                wakeLock = null;
            }
        }

        // üö® FAHRER-BENACHRICHTIGUNG BEI STORNIERUNG
        async function notifyDriverOfCancellation(ride) {
            console.log('üö® STORNIERUNG ERKANNT:', ride);
            
            // Spiele Sound ab (falls Browser erlaubt)
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ0PVqzn77BfGQg+ltryxnMnBSh8y/DVfzEHImK38eKTPQsRXrTp66hVFApGn+DyvmwhBCl+zPDTgjMGHm7A7+OZRQ==');
                audio.play().catch(e => console.log('Audio play blocked'));
            } catch (e) {
                console.log('Audio not supported');
            }
            
            // Schlie√üe Karte falls offen
            closeDriverMap();
            
            // Gro√üe Alert-Box
            const feeText = ride.cancellationFee ? `\n\nüí∂ Stornogeb√ºhr: ${ride.cancellationFee.toFixed(2)}‚Ç¨\n(Wird dem Kunden berechnet)` : '';
            
            alert(
                `üö® FAHRT STORNIERT!\n\n` +
                `#${ride.id} - ${ride.customerName || 'Fahrgast'}\n` +
                `Von: ${ride.pickup}\n` +
                `Nach: ${ride.destination}\n\n` +
                `‚ùå Kunde hat gerade storniert!${feeText}\n\n` +
                `Fahrt wird archiviert.`
            );
            
            // Markiere als benachrichtigt in Firebase
            if (isFirebaseReady && ride.firebaseId) {
                await db.ref('rides/' + ride.firebaseId).update({
                    driverNotified: true,
                    driverNotifiedAt: Date.now()
                });
                console.log('‚úÖ Fahrer als benachrichtigt markiert');
            }
            
            // üîß WICHTIG: GPS und Wake Lock neu aktivieren!
            console.log('üîÑ Reaktiviere GPS und Wake Lock...');
            if (isOnline && currentVehicle) {
                requestWakeLock();
                // GPS l√§uft schon, nur sicherstellen dass es aktiv ist
                if (!watchId) {
                    startDriverTracking(null);
                }
            }
            
            // Nach 5 Sekunden automatisch zu "completed" verschieben f√ºr Archivierung
            setTimeout(async () => {
                if (isFirebaseReady && ride.firebaseId) {
                    await db.ref('rides/' + ride.firebaseId).update({
                        status: 'completed',
                        archivedAsCancel: true
                    });
                    updateViews();
                }
            }, 5000);
        }

        function toggleOnline() {
            isOnline = document.getElementById('online-toggle').checked;
            document.getElementById('online-status-text').textContent = isOnline ? 'Online' : 'Offline';
            document.getElementById('online-status-text').style.color = isOnline ? '#10b981' : '#666';
            
            const gpsIndicator = document.getElementById('gps-indicator');
            const gpsDot = document.getElementById('gps-dot');
            const gpsStatus = document.getElementById('gps-status');
            
            if (isOnline) {
                gpsIndicator.style.display = 'flex';
                gpsDot.style.background = '#10b981';
                gpsDot.classList.add('online');
                gpsStatus.textContent = 'üìç GPS On';
                requestWakeLock();
            } else {
                gpsDot.style.background = '#6b7280';
                gpsDot.classList.remove('online');
                gpsStatus.textContent = 'üìç GPS Off';
                releaseWakeLock();
            }
            
            if (isOnline && currentVehicle) startDriverTracking(null);
            else stopDriverTracking();
        }

        function setVehicle() {
            const vehicleId = document.getElementById('vehicle').value;
            currentVehicle = vehicleId;
            console.log('üöó Fahrzeug gew√§hlt:', currentVehicle);
            if (currentVehicle && isOnline) startDriverTracking(null);
            updateViews();
        }

        function loadSavedVehicle() {
            const dropdown = document.getElementById('vehicle');
            if (dropdown && dropdown.value) {
                currentVehicle = dropdown.value;
                console.log('üîÑ Gespeichertes Fahrzeug geladen:', currentVehicle);
                updateViews();
            }
        }

        function startDriverTracking(rideId) {
            // Wenn schon l√§uft, ignoriere
            if (watchId) {
                console.log('‚ö†Ô∏è GPS l√§uft bereits - watchId:', watchId);
                return;
            }
            
            console.log('üöÄ Starte GPS-Tracking' + (rideId ? ' f√ºr Fahrt: ' + rideId : ''));
            
            watchId = navigator.geolocation.watchPosition(
                (pos) => {
                    const location = { 
                        lat: pos.coords.latitude, 
                        lon: pos.coords.longitude, 
                        timestamp: Date.now(), 
                        vehicleId: currentVehicle,
                        vehicle: VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle,
                        online: isOnline 
                    };
                    
                    console.log('üìç GPS:', location.lat.toFixed(4), location.lon.toFixed(4));
                    
                    if (!isFirebaseReady) {
                        console.error('‚ùå Firebase nicht bereit!');
                        return;
                    }
                    
                    // Immer in drivers/ speichern
                    db.ref('drivers/' + currentVehicle).set(location).then(() => {
                        console.log('‚úÖ GPS ‚Üí drivers/' + currentVehicle);
                    });
                    
                    // Wenn rideId vorhanden, auch in Fahrt speichern
                    if (rideId) {
                        db.ref('rides/' + rideId + '/driverLocation').set(location).then(() => {
                            console.log('‚úÖ GPS ‚Üí rides/' + rideId + '/driverLocation');
                        });
                    }
                },
                (err) => {
                    console.error('‚ùå GPS Fehler:', err.message);
                    alert('‚ùå GPS Fehler: ' + err.message + '\n\nBitte Standort-Berechtigung erteilen!');
                },
                { 
                    enableHighAccuracy: true, 
                    maximumAge: 0, 
                    timeout: 30000 
                }
            );
            
            console.log('üéØ GPS watchId:', watchId);
        }

        function stopDriverTracking() {
            if (watchId) { 
                navigator.geolocation.clearWatch(watchId); 
                watchId = null; 
                console.log('üõë GPS gestoppt');
            }
            if (isFirebaseReady && currentVehicle) {
                db.ref('drivers/' + currentVehicle).remove();
                console.log('üóëÔ∏è GPS aus drivers/ entfernt');
            }
        }

        async function acceptRide(rideId) {
            if (!currentVehicle) {
                alert('‚ùå Bitte Fahrzeug w√§hlen!');
                return;
            }
            
            const ride = rides.find(r => r.firebaseId === rideId);
            if (!ride) {
                alert('‚ùå Fahrt nicht gefunden!');
                return;
            }
            
            // Zeitwarnung
            if (ride.pickupTimestamp && ride.pickupTimestamp > Date.now()) {
                const minutesUntilPickup = Math.round((ride.pickupTimestamp - Date.now()) / 60000);
                const pickupTimeStr = ride.pickupTime || 'sp√§ter';
                
                const confirm = window.confirm(
                    `‚ö†Ô∏è ACHTUNG!\n\n` +
                    `Abholung erst um ${pickupTimeStr}\n` +
                    `Das ist in ${minutesUntilPickup} Minuten!\n\n` +
                    `Trotzdem jetzt annehmen und losfahren?`
                );
                
                if (!confirm) return;
            }
            
            // Auto-Online wenn offline
            if (!isOnline) {
                document.getElementById('online-toggle').checked = true;
                toggleOnline();
            }
            
            const vehicleName = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle;
            const vehiclePlate = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].plate : '';
            
            console.log('üìù Akzeptiere Fahrt:', rideId);
            
            // üõë Stoppe Assignment-Timer
            if (assignmentTimers[rideId]) {
                clearTimeout(assignmentTimers[rideId]);
                delete assignmentTimers[rideId];
                console.log('‚è∞ Assignment-Timer gestoppt');
            }
            
            // Update Fahrt in Firebase
            await updateRide(rideId, { 
                status: 'accepted', 
                vehicleId: currentVehicle,
                vehicle: vehicleName,
                vehiclePlate: vehiclePlate,
                driver: vehicleName,
                acceptedAt: Date.now(),
                assignedTo: null, // Zur√ºcksetzen
                assignmentExpiresAt: null
            });
            
            // GPS komplett neu starten mit rideId
            if (watchId) {
                console.log('üõë Stoppe altes GPS');
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            setTimeout(() => {
                startDriverTracking(rideId);
                initDriverMap(ride);  // NEUE FUNKTION: Karte initialisieren
            }, 100);
            
            alert('‚úÖ Auftrag angenommen! GPS l√§uft...');
        }

        async function pickupCustomer(rideId) {
            await updateRide(rideId, { 
                status: 'picked_up',
                pickedUpAt: Date.now() 
            });
            alert('‚úÖ Kunde eingestiegen! Status: Besetzt');
        }

        async function completeRide(rideId) {
            await updateRide(rideId, { 
                status: 'completed', 
                driverLocation: null,
                completedAt: Date.now()
            });
            
            // Schlie√üe Karte
            closeDriverMap();
            
            if (etaUpdateInterval) { 
                clearInterval(etaUpdateInterval); 
                etaUpdateInterval = null; 
            }
            
            console.log('‚úÖ Fahrt abgeschlossen');
            
            // WICHTIG: Erst komplett stoppen
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                console.log('üõë GPS gestoppt');
            }
            
            // Dann neu starten wenn noch Online
            if (isOnline && currentVehicle) {
                console.log('üîÑ Starte GPS neu (ohne rideId)');
                // Kurz warten damit clearWatch durchl√§uft
                setTimeout(() => {
                    startDriverTracking(null);
                }, 100);
            }
            
            alert('‚úÖ Fahrt abgeschlossen! Sie sind wieder verf√ºgbar.');
        }

        function resetDatabase() {
            if (!confirm('‚ö†Ô∏è WIRKLICH alle Fahrten l√∂schen?')) return;
            if (!confirm('‚ö†Ô∏è LETZTE WARNUNG! Dies kann nicht r√ºckg√§ngig gemacht werden!')) return;
            if (isFirebaseReady) {
                db.ref('rides').remove();
                alert('‚úÖ Datenbank zur√ºckgesetzt!');
            }
        }

        // SOUNDS
        function playDriverNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const beeps = [0, 0.25, 0.5, 0.75, 1.0, 1.25, 1.5, 1.75];
                
                beeps.forEach((time) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 1400;
                    oscillator.type = 'square';
                    
                    gainNode.gain.setValueAtTime(0.8, audioContext.currentTime + time);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + time + 0.15);
                    
                    oscillator.start(audioContext.currentTime + time);
                    oscillator.stop(audioContext.currentTime + time + 0.15);
                });
            } catch (e) {
                console.error('Sound Fehler:', e);
            }
        }

        function playArrivalSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const beeps = [0, 0.15, 0.3];
                
                beeps.forEach((time) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime + time);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + time + 0.1);
                    
                    oscillator.start(audioContext.currentTime + time);
                    oscillator.stop(audioContext.currentTime + time + 0.1);
                });
            } catch (e) {
                console.error('Sound Fehler:', e);
            }
        }

        // HISTORY
        function saveToHistory(ride) {
            try {
                let history = JSON.parse(localStorage.getItem('ride-history') || '[]');
                
                if (!history.find(r => r.id === ride.id)) {
                    history.unshift({
                        id: ride.id,
                        customerName: ride.customerName,
                        pickup: ride.pickup,
                        destination: ride.destination,
                        pickupLat: ride.pickupCoords?.lat,
                        pickupLon: ride.pickupCoords?.lon,
                        destLat: ride.destCoords?.lat,
                        destLon: ride.destCoords?.lon,
                        vehicle: ride.vehicle,
                        price: ride.price,
                        distance: ride.distance,
                        time: ride.time,
                        completedAt: new Date().toLocaleString('de-DE')
                    });
                    
                    if (history.length > 50) history = history.slice(0, 50);
                    localStorage.setItem('ride-history', JSON.stringify(history));
                }
            } catch (e) {
                console.error('Fehler beim Speichern der Historie:', e);
            }
        }

        function closeRide() {
            localStorage.removeItem('myCurrentRideId');
            myCurrentRide = null;
            document.getElementById('ride-status-container').innerHTML = '';
            document.getElementById('booking-form').style.display = 'block';
            document.getElementById('confirm').innerHTML = '<div class="alert-success">‚úì Fahrt wurde in Ihrem Verlauf gespeichert</div>';
            setTimeout(() => document.getElementById('confirm').innerHTML = '', 3000);
        }

        // üîÑ ROUTE UMDREHEN
        function reverseRoute(pickup, destination, pickupLat, pickupLon, destLat, destLon) {
            // Tausche Abholort und Zielort
            document.getElementById('pickup').value = destination;
            document.getElementById('destination').value = pickup;
            
            // Tausche Koordinaten
            if (destLat && destLon) {
                pickupCoords = { lat: parseFloat(destLat), lon: parseFloat(destLon) };
            }
            if (pickupLat && pickupLon) {
                destCoords = { lat: parseFloat(pickupLat), lon: parseFloat(pickupLon) };
            }
            
            // Wechsle zur Fahrgast-Ansicht
            switchView('passenger');
            
            // Zeige Best√§tigung
            const banner = document.createElement('div');
            banner.style.cssText = 'background:#667eea;color:white;padding:15px;border-radius:8px;margin-bottom:15px;text-align:center;';
            banner.innerHTML = 'üîÑ <strong>Route wurde umgedreht!</strong><br><span style="font-size:13px;">√úberpr√ºfe die Adressen und berechne den Preis.</span>';
            
            const bookingForm = document.getElementById('booking-form');
            bookingForm.insertBefore(banner, bookingForm.firstChild);
            setTimeout(() => banner.remove(), 4000);
        }

        // üìã NOCHMAL BUCHEN
        function bookAgain(pickup, destination, pickupLat, pickupLon, destLat, destLon) {
            // F√ºlle Felder aus
            document.getElementById('pickup').value = pickup;
            document.getElementById('destination').value = destination;
            
            // Setze Koordinaten
            if (pickupLat && pickupLon) {
                pickupCoords = { lat: parseFloat(pickupLat), lon: parseFloat(pickupLon) };
            }
            if (destLat && destLon) {
                destCoords = { lat: parseFloat(destLat), lon: parseFloat(destLon) };
            }
            
            // Wechsle zur Fahrgast-Ansicht
            switchView('passenger');
            
            // Zeige Best√§tigung
            const banner = document.createElement('div');
            banner.style.cssText = 'background:#10b981;color:white;padding:15px;border-radius:8px;margin-bottom:15px;text-align:center;';
            banner.innerHTML = 'üìã <strong>Route wurde geladen!</strong><br><span style="font-size:13px;">√úberpr√ºfe die Adressen und berechne den Preis.</span>';
            
            const bookingForm = document.getElementById('booking-form');
            bookingForm.insertBefore(banner, bookingForm.firstChild);
            setTimeout(() => banner.remove(), 4000);
        }

        // ‚≠ê ALS FAVORIT SPEICHERN
        function addToFavorites(pickup, destination, pickupLat, pickupLon, destLat, destLon) {
            try {
                let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
                
                // Pr√ºfe ob bereits vorhanden
                const exists = favorites.some(f => 
                    f.pickup === pickup && f.destination === destination
                );
                
                if (exists) {
                    alert('‚≠ê Diese Route ist bereits in deinen Favoriten!');
                    return;
                }
                
                // F√ºge zu Favoriten hinzu
                favorites.push({
                    pickup: pickup,
                    destination: destination,
                    pickupLat: pickupLat,
                    pickupLon: pickupLon,
                    destLat: destLat,
                    destLon: destLon,
                    addedAt: Date.now()
                });
                
                localStorage.setItem('favorites', JSON.stringify(favorites));
                
                alert('‚≠ê Favorit gespeichert!\n\nDiese Route findest du jetzt in deinen Favoriten.');
                
                console.log('‚≠ê Favorit gespeichert:', { pickup, destination });
            } catch (e) {
                console.error('‚ùå Fehler beim Speichern des Favoriten:', e);
                alert('‚ùå Fehler beim Speichern');
            }
        }

        function closeRide() {
            localStorage.removeItem('myCurrentRideId');
            myCurrentRide = null;
            document.getElementById('ride-status-container').innerHTML = '';
            document.getElementById('booking-form').style.display = 'block';
            document.getElementById('confirm').innerHTML = '<div class="alert-success">‚úì Fahrt wurde in Ihrem Verlauf gespeichert</div>';
            setTimeout(() => document.getElementById('confirm').innerHTML = '', 3000);
        }

        function loadHistory() {
            try {
                const history = JSON.parse(localStorage.getItem('ride-history') || '[]');
                const container = document.getElementById('history-list');
                
                if (history.length === 0) {
                    container.innerHTML = '<div style="padding:40px 20px;text-align:center;color:#999;">Noch keine Fahrten</div>';
                    return;
                }
                
                container.innerHTML = history.map(r => `
                    <div class="ride-card">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <strong style="color:#667eea;">#${r.id}</strong>
                            <span style="background:#d1fae5;padding:4px 8px;border-radius:12px;font-size:12px;color:#065f46;">Abgeschlossen</span>
                        </div>
                        ${r.customerName ? `<div style="font-size:15px;font-weight:600;margin-bottom:8px;">üë§ ${r.customerName}</div>` : ''}
                        <div style="font-size:14px;color:#666;line-height:1.8;">
                            <strong>Von:</strong> ${r.pickup}<br>
                            <strong>Nach:</strong> ${r.destination}<br>
                            <strong>Fahrzeug:</strong> ${r.vehicle || 'Taxi'}<br>
                            <strong>Distanz:</strong> ${r.distance} km<br>
                            <strong>Preis:</strong> ${r.price}‚Ç¨<br>
                            <small style="opacity:0.7;">Abgeschlossen: ${r.completedAt || r.time}</small>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:15px;">
                            <button onclick="reverseRoute('${r.pickup.replace(/'/g, "\\'")}', '${r.destination.replace(/'/g, "\\'")}', ${r.pickupLat || 'null'}, ${r.pickupLon || 'null'}, ${r.destLat || 'null'}, ${r.destLon || 'null'})" 
                                style="padding:10px;border:2px solid #667eea;background:white;color:#667eea;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;">
                                üîÑ Route umdrehen
                            </button>
                            <button onclick="bookAgain('${r.pickup.replace(/'/g, "\\'")}', '${r.destination.replace(/'/g, "\\'")}', ${r.pickupLat || 'null'}, ${r.pickupLon || 'null'}, ${r.destLat || 'null'}, ${r.destLon || 'null'})" 
                                style="padding:10px;border:2px solid #10b981;background:white;color:#10b981;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;">
                                üìã Nochmal buchen
                            </button>
                        </div>
                        <button onclick="addToFavorites('${r.pickup.replace(/'/g, "\\'")}', '${r.destination.replace(/'/g, "\\'")}', ${r.pickupLat || 'null'}, ${r.pickupLon || 'null'}, ${r.destLat || 'null'}, ${r.destLon || 'null'})" 
                            style="padding:10px;border:2px solid #f59e0b;background:white;color:#f59e0b;border-radius:6px;font-weight:600;cursor:pointer;font-size:13px;width:100%;margin-top:8px;">
                            ‚≠ê Als Favorit speichern
                        </button>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Fehler beim Laden der Historie:', e);
            }
        }

        // RIDE STATUS & TRACKING
        function showRideStatus(ride) {
            const container = document.getElementById('ride-status-container');
            
            if (ride.status === 'completed') {
                container.innerHTML = `
                    <div class="ride-status-box" style="background:#d1fae5;border:2px solid #10b981;">
                        <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
                        <h3>Fahrt abgeschlossen!</h3>
                        <p style="margin-top: 10px;">Vielen Dank f√ºr Ihre Fahrt</p>
                        <div style="margin-top: 15px; font-size: 14px; color: #065f46;">
                            <strong>Fahrzeug:</strong> ${ride.vehicle || 'Taxi'}${ride.vehiclePlate ? ` (üöó ${ride.vehiclePlate})` : ''}<br>
                            <strong>Von:</strong> ${ride.pickup}<br>
                            <strong>Nach:</strong> ${ride.destination}<br>
                            <strong>Preis:</strong> ${ride.price}‚Ç¨
                        </div>
                        <button onclick="closeRide()" class="btn btn-primary" style="margin-top:20px;">‚úì Schlie√üen</button>
                    </div>
                `;
                saveToHistory(ride);
                return;
            }
            
            if (ride.status === 'picked_up') {
                container.innerHTML = `
                    <div class="ride-status-box" style="background:#dcfce7;border:2px solid #10b981;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üöó</div>
                        <h3>Gute Fahrt!</h3>
                        <p style="margin-top: 10px; font-size: 16px; color: #047857;">
                            ${ride.vehicle || 'Ihr Taxi'}${ride.vehiclePlate ? ` (üöó ${ride.vehiclePlate})` : ''} f√§hrt Sie zu Ihrem Ziel
                        </p>
                        <div style="margin-top: 15px; font-size: 14px; color: #065f46;">
                            <strong>Von:</strong> ${ride.pickup}<br>
                            <strong>Nach:</strong> ${ride.destination}<br>
                            <strong>Distanz:</strong> ${ride.distance} km<br>
                            <strong>Preis:</strong> ${ride.price}‚Ç¨
                        </div>
                    </div>
                `;
                
                if (!window.lastPickedUpRide || window.lastPickedUpRide !== ride.id) {
                    playArrivalSound();
                    window.lastPickedUpRide = ride.id;
                }
                return;
            }
            
            if (ride.status === 'new') {
                container.innerHTML = `
                    <div class="ride-status-box" style="background:#fef3c7;border:2px solid #f59e0b;">
                        <div style="font-size: 48px; margin-bottom: 10px;">‚è≥</div>
                        <h3>Warte auf Fahrer...</h3>
                        <p style="margin-top: 10px;">Deine Fahrt wird zugewiesen</p>
                        <div style="margin-top: 15px; font-size: 14px; color: #92400e;">
                            <strong>Von:</strong> ${ride.pickup}<br>
                            <strong>Nach:</strong> ${ride.destination}<br>
                            <strong>Preis:</strong> ${ride.price}‚Ç¨
                        </div>
                        <button onclick="cancelRideConfirm('${ride.firebaseId}')" style="margin-top:15px;padding:12px 24px;border:none;background:#ef4444;color:white;border-radius:8px;cursor:pointer;font-weight:600;font-size:15px;">üóëÔ∏è Fahrt stornieren</button>
                    </div>
                `;
            } else if (ride.status === 'accepted' && ride.driverLocation) {
                updateRideTracking(ride);
            } else if (ride.status === 'accepted' && !ride.driverLocation) {
                container.innerHTML = `
                    <div class="ride-status-box" style="background:#dbeafe;border:2px solid #3b82f6;">
                        <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
                        <h3>${ride.vehicle || 'Fahrer'} hat angenommen!</h3>
                        <p style="margin-top: 10px;">Warte auf GPS-Position...</p>
                        <div style="margin-top: 15px; font-size: 14px;">
                            <strong>Fahrzeug:</strong> ${ride.vehicle}${ride.vehiclePlate ? ` (${ride.vehiclePlate})` : ''}<br>
                            <strong>Von:</strong> ${ride.pickup}<br>
                            <strong>Nach:</strong> ${ride.destination}<br>
                            <strong>Preis:</strong> ${ride.price}‚Ç¨
                        </div>
                        <button onclick="cancelRideConfirm('${ride.firebaseId}')" style="margin-top:15px;padding:10px 20px;border:none;background:#ef4444;color:white;border-radius:8px;cursor:pointer;font-size:14px;">üóëÔ∏è Stornieren</button>
                    </div>
                `;
            }
        }

        async function updateRideTracking(ride) {
            const driverLoc = ride.driverLocation;
            const route = await calculateRoute(driverLoc, ride.pickupCoords);
            const distanceKm = route.distance;
            const durationMin = route.duration;
            
            const eta = new Date(Date.now() + durationMin * 60000);
            const etaTime = eta.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            
            let statusIcon = 'üöï', statusText = ride.vehicle + ' ist unterwegs', statusClass = 'status-coming';
            let etaClass = 'green', progressColor = '#10b981', progress = 80;
            
            if (durationMin <= 2) {
                statusIcon = 'üéØ';
                statusText = ride.vehicle + ' ist gleich da!';
                etaClass = 'green';
                progress = 95;
                if (lastSoundDistance > 2) {
                    playArrivalSound();
                    lastSoundDistance = durationMin;
                }
            } else if (durationMin <= 5) {
                etaClass = 'yellow';
                progressColor = '#f59e0b';
                progress = 60;
            } else {
                etaClass = 'red';
                progressColor = '#ef4444';
                progress = 30;
            }
            
            const container = document.getElementById('ride-status-container');
            container.innerHTML = `
                <div class="ride-status-box ${statusClass}">
                    <div style="font-size: 48px; margin-bottom: 10px;">${statusIcon}</div>
                    <h3>${statusText}</h3>
                    <div class="eta-display ${etaClass}">${distanceKm} km ‚Ä¢ ${durationMin} Min</div>
                    <div style="font-size: 14px; opacity: 0.8; margin-bottom: 15px;">
                        Ankunft ca. ${etaTime} Uhr
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%; background: ${progressColor};"></div>
                    </div>
                    <div style="margin-top: 15px; font-size: 14px;">
                        <strong>Fahrzeug:</strong> ${ride.vehicle}${ride.vehiclePlate ? ` (üöó ${ride.vehiclePlate})` : ''}<br>
                        <strong>Von:</strong> ${ride.pickup}<br>
                        <strong>Nach:</strong> ${ride.destination}<br>
                        <strong>Preis:</strong> ${ride.price}‚Ç¨
                    </div>
                    <button onclick="cancelRideConfirm('${ride.firebaseId}')" style="margin-top:15px;padding:8px 16px;border:none;background:#ef4444;color:white;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">üí∂ Kostenpflichtig stornieren (10‚Ç¨)</button>
                </div>
                <div id="map"></div>
            `;
            
            if (!map) {
                setTimeout(() => {
                    map = L.map('map').setView([driverLoc.lat, driverLoc.lon], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                    taxiMarker = L.marker([driverLoc.lat, driverLoc.lon]).addTo(map).bindPopup('üöï ' + ride.vehicle);
                    pickupMarker = L.marker([ride.pickupCoords.lat, ride.pickupCoords.lon]).addTo(map).bindPopup('üìç Abholort');
                    map.fitBounds([[driverLoc.lat, driverLoc.lon], [ride.pickupCoords.lat, ride.pickupCoords.lon]]);
                }, 100);
            } else {
                if (taxiMarker) taxiMarker.setLatLng([driverLoc.lat, driverLoc.lon]);
                map.setView([driverLoc.lat, driverLoc.lon], map.getZoom());
            }
        }

        // ==========================================
        // DRIVER MAP FUNCTIONS
        // ==========================================
        let driverMap = null;
        let driverMarker = null;
        let customerMarker = null;
        let routeLine = null;
        let driverMapUpdateInterval = null;

        function initDriverMap(ride) {
            console.log('üó∫Ô∏è Initialisiere Fahrer-Karte f√ºr Fahrt:', ride.id);
            
            // Zeige Karten-Container
            document.getElementById('driver-route-info').style.display = 'block';
            
            // Initialisiere Karte
            if (!driverMap) {
                setTimeout(() => {
                    const pickupCoords = ride.pickupCoords;
                    driverMap = L.map('driver-map').setView([pickupCoords.lat, pickupCoords.lon], 13);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors'
                    }).addTo(driverMap);
                    
                    // Kunden-Marker (rot)
                    const customerIcon = L.divIcon({
                        html: '<div style="background:#ef4444;color:white;padding:8px 12px;border-radius:20px;font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,0.3);">üìç ' + ride.customerName + '</div>',
                        className: '',
                        iconSize: [120, 40]
                    });
                    customerMarker = L.marker([pickupCoords.lat, pickupCoords.lon], { icon: customerIcon }).addTo(driverMap);
                    
                    // Fahrer-Marker (blau) - wird sp√§ter gesetzt
                    const driverIcon = L.divIcon({
                        html: '<div style="background:#667eea;color:white;padding:8px 12px;border-radius:20px;font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,0.3);">üöï Du</div>',
                        className: '',
                        iconSize: [100, 40]
                    });
                    
                    // Warte auf erste GPS-Position
                    const checkGPS = setInterval(() => {
                        const driver = drivers[currentVehicle];
                        if (driver && driver.lat && driver.lon) {
                            console.log('‚úÖ GPS-Position erhalten:', driver.lat, driver.lon);
                            driverMarker = L.marker([driver.lat, driver.lon], { icon: driverIcon }).addTo(driverMap);
                            
                            // Zeige beide Marker
                            driverMap.fitBounds([
                                [driver.lat, driver.lon],
                                [pickupCoords.lat, pickupCoords.lon]
                            ], { padding: [50, 50] });
                            
                            // Starte Updates
                            updateDriverRoute(ride);
                            clearInterval(checkGPS);
                        }
                    }, 500);
                    
                    // Timeout nach 10 Sekunden
                    setTimeout(() => clearInterval(checkGPS), 10000);
                }, 200);
            }
            
            // Update Route alle 5 Sekunden
            driverMapUpdateInterval = setInterval(() => {
                updateDriverRoute(ride);
            }, 5000);
        }

        async function updateDriverRoute(ride) {
            const driver = drivers[currentVehicle];
            if (!driver || !driver.lat || !driver.lon || !driverMap) return;
            
            const pickupCoords = ride.pickupCoords;
            
            // Update Fahrer-Position
            if (driverMarker) {
                driverMarker.setLatLng([driver.lat, driver.lon]);
            }
            
            // Berechne Route
            const route = await calculateRoute(
                { lat: driver.lat, lon: driver.lon },
                { lat: pickupCoords.lat, lon: pickupCoords.lon }
            );
            
            // Update Info-Box
            document.getElementById('route-distance').textContent = route.distance;
            document.getElementById('route-duration').textContent = route.duration;
            
            const eta = new Date(Date.now() + route.duration * 60000);
            document.getElementById('route-eta').textContent = eta.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            
            // Hole detaillierte Route f√ºr Linie
            try {
                const response = await fetch(
                    `https://router.project-osrm.org/route/v1/driving/${driver.lon},${driver.lat};${pickupCoords.lon},${pickupCoords.lat}?overview=full&geometries=geojson`
                );
                const data = await response.json();
                
                if (data.routes && data.routes.length > 0) {
                    const coords = data.routes[0].geometry.coordinates;
                    const latLngs = coords.map(c => [c[1], c[0]]);  // [lon,lat] ‚Üí [lat,lon]
                    
                    // Entferne alte Linie
                    if (routeLine) {
                        driverMap.removeLayer(routeLine);
                    }
                    
                    // Zeichne neue Route
                    routeLine = L.polyline(latLngs, {
                        color: '#667eea',
                        weight: 5,
                        opacity: 0.8
                    }).addTo(driverMap);
                    
                    console.log('‚úÖ Route gezeichnet:', route.distance, 'km,', route.duration, 'min');
                }
            } catch (e) {
                console.error('‚ùå Route-Fehler:', e);
            }
        }

        function closeDriverMap() {
            console.log('üó∫Ô∏è Schlie√üe Fahrer-Karte');
            
            // Stoppe Updates
            if (driverMapUpdateInterval) {
                clearInterval(driverMapUpdateInterval);
                driverMapUpdateInterval = null;
            }
            
            // Entferne Karte
            if (driverMap) {
                driverMap.remove();
                driverMap = null;
                driverMarker = null;
                customerMarker = null;
                routeLine = null;
            }
            
            // Verstecke Container
            document.getElementById('driver-route-info').style.display = 'none';
        }

        // EVENT LISTENERS
        window.addEventListener('DOMContentLoaded', () => {
            setupAutocomplete();
            
            // üîê Google Login Redirect Result abfangen
            if (typeof firebase !== 'undefined' && firebase.auth) {
                firebase.auth().getRedirectResult().then((result) => {
                    if (result.user) {
                        console.log('‚úÖ Google Login erfolgreich (Redirect):', result.user.email);
                        alert('Willkommen, ' + (result.user.displayName || result.user.email) + '! üéâ');
                    }
                }).catch((error) => {
                    if (error.code !== 'auth/popup-closed-by-user') {
                        console.error('‚ùå Redirect Error:', error);
                    }
                });
            }
            
            // üîî BENACHRICHTIGUNGS-BANNER SOFORT ANZEIGEN
            if ('Notification' in window && Notification.permission !== 'granted') {
                document.getElementById('static-notification-banner').style.display = 'block';
            }
            
            // üîî Service Worker & Push Notifications initialisieren
            initServiceWorker();
            
            // üåü Stammkunden-Daten laden
            loadRegularCustomer();
            
            // üîê Zeige Login-Button im Header (wird sp√§ter durch Auth-State ersetzt)
            updateUserProfile();
            
            // üé® Initialisiere Uber-Map
            setTimeout(() => initUberMap(), 500);
            
            setTimeout(() => { 
                if (firebaseLoaded && typeof firebase !== 'undefined') initApp(true); 
                else initApp(false); 
                
                const savedRideId = localStorage.getItem('myCurrentRideId');
                if (savedRideId && isFirebaseReady) {
                    console.log('üîÑ Lade gespeicherte Fahrt:', savedRideId);
                    listenToMyRide(savedRideId);
                }
                
                loadSavedVehicle();
            }, 100);
            
            setInterval(() => { 
                if (pickupCoords) showAvailableTaxis(); 
                if (myCurrentRide && myCurrentRide.status === 'accepted') showRideStatus(myCurrentRide);
                
                // üîß Wake Lock alle 30 Sek. pr√ºfen und neu aktivieren
                if (isOnline && wakeLock === null) {
                    console.log('üîÑ Wake Lock reaktivieren...');
                    requestWakeLock();
                }
            }, 30000);
            
            // üéØ Live-Update f√ºr Assignment-Countdown (jede Sekunde)
            setInterval(() => {
                if (currentView === 'driver') {
                    updateViews(); // Aktualisiert Countdown-Timer
                }
            }, 1000);
            
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && isOnline && wakeLock === null) {
                    requestWakeLock();
                }
            });
        });
    </script>
</body>
</html>
