<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Funk Taxi Heringsdorf</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 22px; margin-bottom: 5px; }
        .status-row { display: flex; justify-content: center; gap: 20px; margin-top: 8px; font-size: 11px; }
        .status-item { display: flex; align-items: center; gap: 8px; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #f59e0b; }
        .sync-dot.online { background: #10b981; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .view-selector { display: flex; background: white; border-bottom: 2px solid #e0e0e0; position: sticky; top: 90px; z-index: 99; }
        .view-btn { flex: 1; padding: 15px; border: none; background: white; font-size: 14px; cursor: pointer; }
        .view-btn.active { color: #667eea; border-bottom: 3px solid #667eea; }
        .view { display: none; padding: 15px; padding-bottom: 100px; }
        .view.active { display: block; }
        .input-group { margin-bottom: 15px; position: relative; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .input-group input, .input-group select { width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; }
        .autocomplete-dropdown { position: absolute; background: white; border: 2px solid #667eea; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; display: none; z-index: 1000; width: 100%; }
        .autocomplete-dropdown.show { display: block; }
        .autocomplete-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .autocomplete-item:hover { background: #f5f3ff; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 10px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-success { background: #10b981; color: white; }
        .price-display { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #10b981; border-radius: 12px; padding: 20px; margin: 20px 0; text-align: center; }
        .price-display .price { font-size: 36px; font-weight: bold; color: #047857; }
        .available-taxis { background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 12px; padding: 15px; margin: 15px 0; }
        .taxi-item { background: white; padding: 12px; border-radius: 8px; margin: 8px 0; border-left: 4px solid #10b981; }
        .ride-status-box { border-radius: 12px; padding: 20px; margin: 20px 0; text-align: center; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .status-waiting { background: #fef3c7; border: 2px solid #f59e0b; }
        .status-coming { background: #d1fae5; border: 2px solid #10b981; }
        .status-near { background: #fed7aa; border: 2px solid #ea580c; }
        .status-arrived { background: #fecaca; border: 2px solid #dc2626; }
        .eta-display { font-size: 32px; font-weight: bold; margin: 15px 0; }
        .eta-green { color: #047857; }
        .eta-orange { color: #ea580c; }
        .eta-red { color: #dc2626; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .ride-card { background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .alert-success { background: #d1fae5; color: #065f46; border: 2px solid #10b981; }
        .alert-info { background: #dbeafe; color: #1e40af; border: 2px solid #3b82f6; }
        .online-toggle { background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .toggle-switch { position: relative; width: 60px; height: 30px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; border-radius: 30px; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; border-radius: 50%; transition: .4s; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(30px); }
        #map { height: 350px; border-radius: 12px; margin: 15px 0; border: 2px solid #e0e0e0; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; }
        .progress-bar { width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; margin: 10px 0; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.5s, background 0.5s; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöï Funk Taxi Heringsdorf</h1>
        <p style="font-size: 11px; opacity: 0.8;">Version 2.9 - Besetzt Status</p>
        <div class="status-row">
            <div class="status-item">
                <div class="sync-dot" id="sync-dot"></div>
                <span id="sync-status">Starte...</span>
            </div>
            <div class="status-item" id="gps-indicator" style="display: none;">
                <div class="sync-dot" id="gps-dot" style="background: #6b7280;"></div>
                <span id="gps-status">GPS Off</span>
            </div>
        </div>
    </div>

    <div class="view-selector">
        <button class="view-btn active" onclick="switchView('passenger')">Fahrgast</button>
        <button class="view-btn" onclick="switchView('history')">Verlauf</button>
        <button class="view-btn" onclick="switchView('driver')">Fahrer</button>
        <button class="view-btn" onclick="switchView('admin')">Admin</button>
    </div>

    <div id="passenger-view" class="view active">
        <h3 style="margin: 20px 0;">Neue Fahrt buchen</h3>
        
        <div id="ride-status-container"></div>
        <div id="available-taxis-display"></div>

        <div id="booking-form">
            <div class="input-group">
                <label>üë§ Ihr Name</label>
                <input type="text" id="customer-name" placeholder="z.B. Max Mustermann">
            </div>
            <div class="input-group">
                <label>üïê Abholzeit</label>
                <select id="pickup-time">
                    <option value="jetzt">Sofort</option>
                    <option value="15min">In 15 Minuten</option>
                    <option value="30min">In 30 Minuten</option>
                    <option value="1h">In 1 Stunde</option>
                    <option value="custom">Bestimmte Uhrzeit...</option>
                </select>
                <input type="time" id="custom-time" style="display:none;margin-top:8px;padding:14px;border:2px solid #e0e0e0;border-radius:8px;width:100%;">
            </div>
            <div class="input-group">
                <label>üìç Abholort</label>
                <input type="text" id="pickup" placeholder="z.B. Bahnhof Heringsdorf">
                <button onclick="useMyLocation()" style="margin-top:8px;padding:12px;border:2px solid #3b82f6;background:#dbeafe;color:#1e40af;border-radius:8px;font-weight:600;cursor:pointer;width:100%;">üìç Meinen Standort verwenden</button>
                <div class="autocomplete-dropdown" id="pickup-dropdown"></div>
            </div>
            <div class="input-group">
                <label>üéØ Zielort</label>
                <input type="text" id="destination" placeholder="z.B. Seebr√ºcke Ahlbeck">
                <div class="autocomplete-dropdown" id="destination-dropdown"></div>
            </div>
            <div class="input-group">
                <label>üë• Personen</label>
                <select id="passengers">
                    <option value="1">1 Person</option>
                    <option value="2">2 Personen</option>
                    <option value="3">3 Personen</option>
                    <option value="4">4 Personen</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="calcPrice()">üí∞ Preis berechnen</button>
            <div id="price-result"></div>
            <button id="book-btn" class="btn btn-success" style="display: none;" onclick="book()">üöï JETZT BUCHEN</button>
        </div>
        <div id="confirm"></div>
    </div>

    <div id="history-view" class="view">
        <h3 style="margin: 20px 0;">Meine Fahrten</h3>
        <div id="history-list"></div>
    </div>

    <div id="driver-view" class="view">
        <h3 style="margin: 20px 0;">Fahrer Dashboard</h3>
        
        <div id="debug-panel" style="background:#fef3c7;border:2px solid #f59e0b;border-radius:8px;padding:12px;margin-bottom:15px;font-size:13px;">
            <strong>üêõ Debug:</strong><br>
            Firebase: <span id="debug-firebase" style="font-weight:bold;">‚ùì</span><br>
            Alle Fahrten: <span id="debug-rides" style="font-weight:bold;">‚ùì</span><br>
            Neue Fahrten: <span id="debug-new" style="font-weight:bold;">‚ùì</span><br>
            Sync: <span id="debug-sync" style="font-weight:bold;">‚ùì</span>
        </div>
        
        <div class="online-toggle">
            <div>
                <strong id="online-status-text">Offline</strong><br>
                <small>GPS-Tracking</small>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" id="online-toggle" onchange="toggleOnline()">
                <span class="slider"></span>
            </label>
        </div>
        <div class="input-group">
            <label>üöó Fahrzeug</label>
            <select id="vehicle" onchange="setVehicle()">
                <option value="">-- W√§hlen --</option>
                <option value="tesla_model3_1">Tesla Model 3 #1</option>
                <option value="tesla_model3_2">Tesla Model 3 #2</option>
                <option value="tesla_model3_3">Tesla Model 3 #3</option>
                <option value="tesla_modely_1">Tesla Model Y #1</option>
                <option value="tesla_modely_2">Tesla Model Y #2</option>
            </select>
        </div>
        <div class="stats-grid">
            <div class="stat-card"><div style="font-size: 28px;" id="d-rides">0</div><div>Fahrten</div></div>
            <div class="stat-card"><div style="font-size: 28px;" id="d-money">0‚Ç¨</div><div>Verdienst</div></div>
        </div>
        <div id="driver-current-ride"></div>
        <h3>Neue Auftr√§ge</h3>
        <div id="new-rides"></div>
    </div>

    <div id="admin-view" class="view">
        <h3 style="margin: 20px 0;">Dashboard</h3>
        
        <button onclick="resetDatabase()" style="width:100%;padding:15px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;margin-bottom:20px;cursor:pointer;font-size:15px;">
            üóëÔ∏è Datenbank zur√ºcksetzen (ALLE Fahrten l√∂schen)
        </button>
        
        <div class="stats-grid">
            <div class="stat-card"><div style="font-size: 28px;" id="a-total">0</div><div>Fahrten</div></div>
            <div class="stat-card"><div style="font-size: 28px;" id="a-revenue">0‚Ç¨</div><div>Umsatz</div></div>
            <div class="stat-card"><div style="font-size: 28px;" id="a-pending">0</div><div>Offen</div></div>
            <div class="stat-card"><div style="font-size: 28px;" id="a-active">0</div><div>Aktiv</div></div>
        </div>
        <h3>Alle Fahrten</h3>
        <div id="all-rides"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let firebaseLoadTimeout, firebaseLoaded = false;
        firebaseLoadTimeout = setTimeout(() => { if (!firebaseLoaded) initApp(false); }, 5000);
    </script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js" onload="firebaseLoaded = true;" onerror="initApp(false);"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script>
        const VEHICLES = {
            'tesla_model3_1': { name: 'Tesla Model 3 #1', id: 'tesla_model3_1' },
            'tesla_model3_2': { name: 'Tesla Model 3 #2', id: 'tesla_model3_2' },
            'tesla_model3_3': { name: 'Tesla Model 3 #3', id: 'tesla_model3_3' },
            'tesla_modely_1': { name: 'Tesla Model Y #1', id: 'tesla_modely_1' },
            'tesla_modely_2': { name: 'Tesla Model Y #2', id: 'tesla_modely_2' }
        };

        console.log('üöÄ Version 2.7 - Professional');
        const TARIF = { grundgebuehr: 4.00, kmPreis: 2.20, nachtZuschlag: 0.20, sonntagZuschlag: 0.25, feiertagZuschlag: 0.50 };
        let db, isFirebaseReady = false, isConnected = false, currentVehicle = null, currentView = 'passenger', rides = [], drivers = {};
        let pickupCoords = null, destCoords = null, map = null, watchId = null, isOnline = false, myCurrentRide = null;
        let taxiMarker = null, pickupMarker = null, etaUpdateInterval = null, lastSoundDistance = 999;
        let wakeLock = null;

        function useMyLocation() {
            if (!navigator.geolocation) {
                alert('‚ùå Dein Ger√§t unterst√ºtzt kein GPS!');
                return;
            }
            
            const pickupInput = document.getElementById('pickup');
            pickupInput.value = 'üìç Hole Position...';
            pickupInput.disabled = true;
            
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    console.log('üìç Standort:', lat, lon);
                    
                    // Speichere Koordinaten
                    pickupCoords = { lat, lon };
                    
                    // Hole Adresse via Reverse Geocoding
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                        const data = await response.json();
                        
                        if (data && data.display_name) {
                            const address = data.display_name.split(',').slice(0, 3).join(',');
                            pickupInput.value = address;
                            pickupInput.disabled = false;
                            
                            // Zeige verf√ºgbare Taxis
                            showAvailableTaxis();
                        } else {
                            pickupInput.value = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                            pickupInput.disabled = false;
                        }
                    } catch (error) {
                        console.error('Adresse konnte nicht ermittelt werden:', error);
                        pickupInput.value = `Standort: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                        pickupInput.disabled = false;
                    }
                },
                (error) => {
                    console.error('GPS Fehler:', error);
                    pickupInput.disabled = false;
                    
                    if (error.code === 1) {
                        pickupInput.value = '';
                        alert('‚ùå GPS-Berechtigung verweigert! Bitte in Browser-Einstellungen erlauben.');
                    } else if (error.code === 2) {
                        pickupInput.value = '';
                        alert('‚ö†Ô∏è GPS-Position nicht verf√ºgbar.');
                    } else {
                        pickupInput.value = '';
                        alert('‚ö†Ô∏è GPS-Timeout. Bitte nochmal versuchen.');
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        function setupAutocomplete() {
            ['pickup', 'destination'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => handleAutocomplete(e.target, id + '-dropdown'));
            });
            
            // Abholzeit Custom Time Handler
            document.getElementById('pickup-time').addEventListener('change', (e) => {
                const customTime = document.getElementById('custom-time');
                if (e.target.value === 'custom') {
                    customTime.style.display = 'block';
                } else {
                    customTime.style.display = 'none';
                }
            });
        }

        function handleAutocomplete(input, dropdownId) {
            const query = input.value.trim(), dropdown = document.getElementById(dropdownId);
            if (query.length < 3) { dropdown.classList.remove('show'); return; }
            dropdown.innerHTML = '<div style="padding:12px;">Suche...</div>';
            dropdown.classList.add('show');
            setTimeout(async () => {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&viewbox=13.7,53.9,14.2,54.1&bounded=1&limit=5`);
                    const results = await res.json();
                    if (results.length === 0) { dropdown.innerHTML = '<div style="padding:12px;">Keine Ergebnisse</div>'; return; }
                    dropdown.innerHTML = results.map(r => `<div class="autocomplete-item" onclick='selectLocation(${JSON.stringify(r)}, "${dropdownId}")'>${r.display_name.split(',').slice(0,2).join(',')}</div>`).join('');
                } catch (e) { dropdown.innerHTML = '<div style="padding:12px;">Fehler</div>'; }
            }, 500);
        }

        function selectLocation(loc, dropdownId) {
            const inputId = dropdownId.replace('-dropdown', '');
            document.getElementById(inputId).value = loc.display_name.split(',').slice(0,2).join(',');
            if (inputId === 'pickup') pickupCoords = { lat: parseFloat(loc.lat), lon: parseFloat(loc.lon) };
            else destCoords = { lat: parseFloat(loc.lat), lon: parseFloat(loc.lon) };
            document.querySelectorAll('.autocomplete-dropdown').forEach(d => d.classList.remove('show'));
        }

        async function calculateRoute(from, to) {
            try {
                const res = await fetch(`https://router.project-osrm.org/route/v1/driving/${from.lon},${from.lat};${to.lon},${to.lat}?overview=false`);
                const data = await res.json();
                if (data.code !== 'Ok') throw new Error();
                return { distance: parseFloat((data.routes[0].distance / 1000).toFixed(1)), duration: Math.round(data.routes[0].duration / 60) };
            } catch {
                const R = 6371, dLat = (to.lat - from.lat) * Math.PI / 180, dLon = (to.lon - from.lon) * Math.PI / 180;
                const a = Math.sin(dLat/2)**2 + Math.cos(from.lat * Math.PI / 180) * Math.cos(to.lat * Math.PI / 180) * Math.sin(dLon/2)**2;
                const dist = R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return { distance: parseFloat(dist.toFixed(1)), duration: Math.round(dist / 0.5 * 60) };
            }
        }

        function calculatePrice(distance) {
            const now = new Date(), hour = now.getHours(), day = now.getDay();
            let base = TARIF.grundgebuehr + distance * TARIF.kmPreis, zuschlag = 0, text = [];
            if (hour >= 22 || hour < 6) { zuschlag += base * TARIF.nachtZuschlag; text.push('Nacht +20%'); }
            if (day === 0) { zuschlag += base * TARIF.sonntagZuschlag; text.push('Sonntag +25%'); }
            
            const totalRaw = base + zuschlag;
            
            // RUNDE AUF 10 CENT
            const totalRounded = Math.round(totalRaw / 0.1) * 0.1;
            
            return { total: totalRounded.toFixed(2), zuschlagText: text, distance };
        }

        async function calcPrice() {
            if (!pickupCoords || !destCoords) { alert('‚ùå Bitte Orte aus Dropdown w√§hlen!'); return; }
            document.getElementById('price-result').innerHTML = '<div class="alert-info">Berechne...</div>';
            const route = await calculateRoute(pickupCoords, destCoords);
            const pricing = calculatePrice(route.distance);
            window.currentPrice = pricing.total;
            window.currentDistance = route.distance;
            window.currentDuration = route.duration;
            document.getElementById('price-result').innerHTML = `<div class="price-display"><div class="price">${pricing.total}‚Ç¨</div><div style="margin-top:10px;font-size:13px;color:#059669;">üìç ${route.distance} km ‚Ä¢ ‚è±Ô∏è ${route.duration} Min</div></div>`;
            document.getElementById('book-btn').style.display = 'block';
        }

        async function book() {
            const customerName = document.getElementById('customer-name').value.trim();
            const pickupTimeSelect = document.getElementById('pickup-time').value;
            const customTime = document.getElementById('custom-time').value;
            
            if (!customerName) {
                alert('‚ùå Bitte Name eingeben!');
                return;
            }
            
            // Berechne Abholzeit
            let pickupTime = 'Sofort';
            let pickupTimestamp = Date.now();
            const now = new Date();
            
            if (pickupTimeSelect === '15min') {
                pickupTime = new Date(now.getTime() + 15 * 60000).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                pickupTimestamp = now.getTime() + 15 * 60000;
            } else if (pickupTimeSelect === '30min') {
                pickupTime = new Date(now.getTime() + 30 * 60000).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                pickupTimestamp = now.getTime() + 30 * 60000;
            } else if (pickupTimeSelect === '1h') {
                pickupTime = new Date(now.getTime() + 60 * 60000).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                pickupTimestamp = now.getTime() + 60 * 60000;
            } else if (pickupTimeSelect === 'custom' && customTime) {
                pickupTime = customTime;
                const [hours, minutes] = customTime.split(':');
                const customDate = new Date();
                customDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                pickupTimestamp = customDate.getTime();
            }
            
            const ride = {
                id: Date.now(),
                customerName,
                pickupTime,
                pickupTimestamp,
                pickup: document.getElementById('pickup').value,
                destination: document.getElementById('destination').value,
                passengers: document.getElementById('passengers').value,
                price: window.currentPrice,
                distance: window.currentDistance,
                duration: window.currentDuration,
                pickupCoords, destCoords,
                status: 'new',
                time: new Date().toLocaleString('de-DE'),
                createdAt: Date.now()
            };
            
            const savedRide = await saveRide(ride);
            myCurrentRide = savedRide;
            
            localStorage.setItem('myCurrentRideId', savedRide.firebaseId);
            
            console.log('‚úÖ Fahrt gebucht:', savedRide.firebaseId);
            
            document.getElementById('booking-form').style.display = 'none';
            document.getElementById('confirm').innerHTML = `<div class="alert-success"><strong>‚úì Buchung erfolgreich!</strong><br>Kunde: <strong>${customerName}</strong><br>Abholung: <strong>${pickupTime}</strong><br>Preis: <strong>${ride.price}‚Ç¨</strong></div>`;
            showRideStatus(savedRide);
            
            if (isFirebaseReady) {
                listenToMyRide(savedRide.firebaseId);
            }
            
            setTimeout(() => document.getElementById('confirm').innerHTML = '', 5000);
        }

        function showRideStatus(ride) {
            const container = document.getElementById('ride-status-container');
            
            if (ride.status === 'completed') {
                // FAHRT ABGESCHLOSSEN
                container.innerHTML = `
                    <div class="ride-status-box" style="background:#d1fae5;border:2px solid #10b981;">
                        <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
                        <h3>Fahrt abgeschlossen!</h3>
                        <p style="margin-top: 10px;">Vielen Dank f√ºr Ihre Fahrt</p>
                        <div style="margin-top: 15px; font-size: 14px; color: #065f46;">
                            <strong>Fahrzeug:</strong> ${ride.vehicle || 'Taxi'}<br>
                            <strong>Von:</strong> ${ride.pickup}<br>
                            <strong>Nach:</strong> ${ride.destination}<br>
                            <strong>Preis:</strong> ${ride.price}‚Ç¨
                        </div>
                        <button onclick="closeRide()" class="btn btn-primary" style="margin-top:20px;">‚úì Schlie√üen</button>
                    </div>
                `;
                
                // Speichere in Historie
                saveToHistory(ride);
                return;
            }
            
            if (ride.status === 'picked_up') {
                // KUNDE EINGESTIEGEN - FAHRT L√ÑUFT
                container.innerHTML = `
                    <div class="ride-status-box" style="background:#dcfce7;border:2px solid #10b981;animation:fadeIn 0.5s;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üöó</div>
                        <h3>Gute Fahrt!</h3>
                        <p style="margin-top: 10px; font-size: 16px; color: #047857;">
                            ${ride.vehicle || 'Ihr Taxi'} f√§hrt Sie zu Ihrem Ziel
                        </p>
                        <div style="margin-top: 15px; font-size: 14px; color: #065f46;">
                            <strong>Von:</strong> ${ride.pickup}<br>
                            <strong>Nach:</strong> ${ride.destination}<br>
                            <strong>Distanz:</strong> ${ride.distance} km<br>
                            <strong>Preis:</strong> ${ride.price}‚Ç¨
                        </div>
                    </div>
                `;
                
                // SIGNALTON wenn gerade eingestiegen
                if (!window.lastPickedUpRide || window.lastPickedUpRide !== ride.id) {
                    playArrivalSound();
                    window.lastPickedUpRide = ride.id;
                }
                return;
            }
            
            if (ride.status === 'new') {
                container.innerHTML = `
                    <div class="ride-status-box status-waiting">
                        <div style="font-size: 48px; margin-bottom: 10px;">‚è≥</div>
                        <h3>Warte auf Fahrer...</h3>
                        <p style="margin-top: 10px;">Deine Fahrt wird zugewiesen</p>
                        <div style="margin-top: 15px; font-size: 14px; color: #92400e;">
                            <strong>Von:</strong> ${ride.pickup}<br>
                            <strong>Nach:</strong> ${ride.destination}<br>
                            <strong>Preis:</strong> ${ride.price}‚Ç¨<br>
                            <small style="opacity: 0.7;">Tracking-ID: ${ride.firebaseId || 'l√§dt...'}</small>
                        </div>
                        <button onclick="cancelRide()" style="margin-top:15px;padding:10px 20px;border:none;background:#ef4444;color:white;border-radius:8px;cursor:pointer;">Neue Fahrt buchen</button>
                    </div>
                `;
            } else if (ride.status === 'accepted' && ride.driverLocation) {
                updateRideTracking(ride);
            } else if (ride.status === 'accepted' && !ride.driverLocation) {
                container.innerHTML = `
                    <div class="ride-status-box status-coming">
                        <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
                        <h3>${ride.vehicle || 'Fahrer'} hat angenommen!</h3>
                        <p style="margin-top: 10px;">Warte auf GPS-Position...</p>
                        <div style="margin-top: 15px; font-size: 14px;">
                            <strong>Fahrzeug:</strong> ${ride.vehicle}<br>
                            <strong>Von:</strong> ${ride.pickup}<br>
                            <strong>Nach:</strong> ${ride.destination}<br>
                            <strong>Preis:</strong> ${ride.price}‚Ç¨
                        </div>
                    </div>
                `;
            }
        }

        function saveToHistory(ride) {
            try {
                let history = JSON.parse(localStorage.getItem('ride-history') || '[]');
                
                // Pr√ºfe ob schon vorhanden
                if (!history.find(r => r.id === ride.id)) {
                    history.unshift({ // An den Anfang
                        id: ride.id,
                        customerName: ride.customerName,
                        pickup: ride.pickup,
                        destination: ride.destination,
                        vehicle: ride.vehicle,
                        price: ride.price,
                        distance: ride.distance,
                        time: ride.time,
                        completedAt: new Date().toLocaleString('de-DE')
                    });
                    
                    // Max 50 Fahrten speichern
                    if (history.length > 50) history = history.slice(0, 50);
                    
                    localStorage.setItem('ride-history', JSON.stringify(history));
                    console.log('‚úÖ Fahrt in Historie gespeichert');
                }
            } catch (e) {
                console.error('Fehler beim Speichern der Historie:', e);
            }
        }

        function closeRide() {
            localStorage.removeItem('myCurrentRideId');
            myCurrentRide = null;
            document.getElementById('ride-status-container').innerHTML = '';
            document.getElementById('booking-form').style.display = 'block';
            
            // Zeige kurze Best√§tigung
            document.getElementById('confirm').innerHTML = '<div class="alert-success">‚úì Fahrt wurde in Ihrem Verlauf gespeichert</div>';
            setTimeout(() => document.getElementById('confirm').innerHTML = '', 3000);
        }

        function loadHistory() {
            try {
                const history = JSON.parse(localStorage.getItem('ride-history') || '[]');
                const container = document.getElementById('history-list');
                
                if (history.length === 0) {
                    container.innerHTML = '<div style="padding:40px 20px;text-align:center;color:#999;">Noch keine Fahrten</div>';
                    return;
                }
                
                container.innerHTML = history.map(r => `
                    <div class="ride-card">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <strong style="color:#667eea;">#${r.id}</strong>
                            <span style="background:#d1fae5;padding:4px 8px;border-radius:12px;font-size:12px;color:#065f46;">Abgeschlossen</span>
                        </div>
                        ${r.customerName ? `<div style="font-size:15px;font-weight:600;margin-bottom:8px;">üë§ ${r.customerName}</div>` : ''}
                        <div style="font-size:14px;color:#666;line-height:1.8;">
                            <strong>Von:</strong> ${r.pickup}<br>
                            <strong>Nach:</strong> ${r.destination}<br>
                            <strong>Fahrzeug:</strong> ${r.vehicle || 'Taxi'}<br>
                            <strong>Distanz:</strong> ${r.distance} km<br>
                            <strong>Preis:</strong> ${r.price}‚Ç¨<br>
                            <small style="opacity:0.7;">Abgeschlossen: ${r.completedAt || r.time}</small>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Fehler beim Laden der Historie:', e);
            }
        }

        function cancelRide() {
            if (confirm('Aktuelle Fahrt abbrechen und neue buchen?')) {
                localStorage.removeItem('myCurrentRideId');
                myCurrentRide = null;
                document.getElementById('ride-status-container').innerHTML = '';
                document.getElementById('booking-form').style.display = 'block';
            }
        }

        async function updateRideTracking(ride) {
            if (!ride.driverLocation || !ride.pickupCoords) return;
            
            const route = await calculateRoute(ride.driverLocation, ride.pickupCoords);
            const distanceKm = route.distance;
            const durationMin = route.duration;
            const now = new Date();
            const eta = new Date(now.getTime() + durationMin * 60000);
            const etaTime = eta.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            
            let statusClass, statusIcon, statusText, etaClass;
            
            if (distanceKm < 0.5) {
                statusClass = 'status-arrived';
                statusIcon = 'üéâ';
                statusText = 'Dein Taxi ist fast da!';
                etaClass = 'eta-red';
                if (lastSoundDistance > 0.5) { playArrivalSound(); lastSoundDistance = distanceKm; }
            } else if (distanceKm < 2) {
                statusClass = 'status-near';
                statusIcon = 'üöï';
                statusText = 'Dein Taxi ist in der N√§he';
                etaClass = 'eta-orange';
            } else {
                statusClass = 'status-coming';
                statusIcon = 'üöó';
                statusText = ride.vehicle + ' ist unterwegs';
                etaClass = 'eta-green';
            }
            
            const progress = Math.max(0, Math.min(100, 100 - (distanceKm / (ride.distance || 10)) * 100));
            let progressColor = '#10b981';
            if (distanceKm < 0.5) progressColor = '#dc2626';
            else if (distanceKm < 2) progressColor = '#ea580c';

            const container = document.getElementById('ride-status-container');
            container.innerHTML = `
                <div class="ride-status-box ${statusClass}">
                    <div style="font-size: 48px; margin-bottom: 10px;">${statusIcon}</div>
                    <h3>${statusText}</h3>
                    <div class="eta-display ${etaClass}">${distanceKm} km ‚Ä¢ ${durationMin} Min</div>
                    <div style="font-size: 14px; opacity: 0.8; margin-bottom: 15px;">
                        Ankunft ca. ${etaTime} Uhr
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%; background: ${progressColor};"></div>
                    </div>
                    <div style="margin-top: 15px; font-size: 14px;">
                        <strong>Fahrzeug:</strong> ${ride.vehicle}<br>
                        <strong>Von:</strong> ${ride.pickup}<br>
                        <strong>Nach:</strong> ${ride.destination}<br>
                        <strong>Preis:</strong> ${ride.price}‚Ç¨
                    </div>
                </div>
                <div id="map"></div>
            `;

            initMap();
            showTaxiOnMap(ride);
        }

        function initMap() {
            if (!map) {
                map = L.map('map').setView([53.99, 14.15], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);
            }
        }

        function showTaxiOnMap(ride) {
            if (!ride.driverLocation || !ride.pickupCoords) return;
            
            const loc = ride.driverLocation;
            
            if (taxiMarker) taxiMarker.setLatLng([loc.lat, loc.lon]);
            else taxiMarker = L.marker([loc.lat, loc.lon], {
                icon: L.divIcon({ html: '<div style="font-size:30px;">üöï</div>', className: '', iconSize: [30, 30] })
            }).addTo(map);
            
            if (!pickupMarker) {
                pickupMarker = L.marker([ride.pickupCoords.lat, ride.pickupCoords.lon], {
                    icon: L.divIcon({ html: '<div style="font-size:24px;">üìç</div>', className: '', iconSize: [24, 24] })
                }).addTo(map);
            }
            
            const bounds = L.latLngBounds([[loc.lat, loc.lon], [ride.pickupCoords.lat, ride.pickupCoords.lon]]);
            map.fitBounds(bounds, { padding: [50, 50] });
        }

        function playDriverNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // LANGES "d√º-d√º-d√º-d√º-d√º-d√º-d√º-d√º" Signal (8 Piept√∂ne √ºber 2 Sekunden)
                const beeps = [0, 0.25, 0.5, 0.75, 1.0, 1.25, 1.5, 1.75];
                
                beeps.forEach((time) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 1400; // Noch h√∂here Frequenz
                    oscillator.type = 'square'; // Sch√§rferer Ton
                    
                    gainNode.gain.setValueAtTime(0.8, audioContext.currentTime + time); // SEHR LAUT!
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + time + 0.15);
                    
                    oscillator.start(audioContext.currentTime + time);
                    oscillator.stop(audioContext.currentTime + time + 0.15);
                });
                
                console.log('üîî SIGNALTON: Neuer Auftrag!');
            } catch (e) {
                console.error('Sound Fehler:', e);
            }
        }

        function playArrivalSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                [800, 1000, 1200].forEach((freq, i) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.frequency.value = freq;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime + i * 0.2);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.2 + 0.3);
                    oscillator.start(audioContext.currentTime + i * 0.2);
                    oscillator.stop(audioContext.currentTime + i * 0.2 + 0.3);
                });
            } catch (e) {}
        }

        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('‚úÖ Screen Wake Lock aktiviert - Bildschirm bleibt an');
                    
                    wakeLock.addEventListener('release', () => {
                        console.log('‚ö†Ô∏è Wake Lock wurde freigegeben');
                    });
                } else {
                    console.log('‚ö†Ô∏è Wake Lock API nicht verf√ºgbar');
                }
            } catch (err) {
                console.error('Wake Lock Fehler:', err);
            }
        }

        function releaseWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release();
                wakeLock = null;
                console.log('üîì Wake Lock freigegeben');
            }
        }

        function toggleOnline() {
            isOnline = document.getElementById('online-toggle').checked;
            document.getElementById('online-status-text').textContent = isOnline ? 'Online' : 'Offline';
            document.getElementById('online-status-text').style.color = isOnline ? '#10b981' : '#666';
            
            const gpsIndicator = document.getElementById('gps-indicator');
            const gpsDot = document.getElementById('gps-dot');
            const gpsStatus = document.getElementById('gps-status');
            
            if (isOnline) {
                gpsIndicator.style.display = 'flex';
                gpsDot.style.background = '#10b981';
                gpsDot.classList.add('online');
                gpsStatus.textContent = 'üìç GPS On';
                
                // Aktiviere Wake Lock
                requestWakeLock();
            } else {
                gpsDot.style.background = '#6b7280';
                gpsDot.classList.remove('online');
                gpsStatus.textContent = 'üìç GPS Off';
                
                // Deaktiviere Wake Lock
                releaseWakeLock();
            }
            
            if (isOnline && currentVehicle) startDriverTracking(null);
            else stopDriverTracking();
        }

        function startDriverTracking(rideId) {
            if (!navigator.geolocation) {
                console.error('‚ùå GPS nicht verf√ºgbar');
                alert('‚ùå Dein Ger√§t unterst√ºtzt kein GPS!');
                return;
            }
            if (!currentVehicle) {
                console.error('‚ùå Kein Fahrzeug gew√§hlt');
                return;
            }
            
            console.log('üìç Starte GPS-Tracking f√ºr:', currentVehicle, 'Fahrt:', rideId);
            
            watchId = navigator.geolocation.watchPosition(
                (pos) => {
                    const location = { 
                        lat: pos.coords.latitude, 
                        lon: pos.coords.longitude, 
                        timestamp: Date.now(), 
                        vehicleId: currentVehicle,
                        vehicle: VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle,
                        online: isOnline 
                    };
                    
                    console.log('üìç GPS Position:', location.lat.toFixed(4), location.lon.toFixed(4));
                    
                    if (isFirebaseReady) {
                        // Speichere in drivers Liste mit ID
                        db.ref('drivers/' + currentVehicle).set(location);
                        
                        // Speichere auch in der aktuellen Fahrt
                        if (rideId) {
                            db.ref('rides/' + rideId + '/driverLocation').set(location);
                            console.log('‚úÖ Position in Fahrt gespeichert');
                        }
                    }
                },
                (error) => {
                    console.error('‚ùå GPS Fehler:', error.message);
                    if (error.code === 1) {
                        alert('‚ùå GPS-Berechtigung verweigert! Bitte in Browser-Einstellungen erlauben.');
                    } else if (error.code === 2) {
                        alert('‚ö†Ô∏è GPS-Position nicht verf√ºgbar. Bist du drau√üen?');
                    } else if (error.code === 3) {
                        console.log('‚è±Ô∏è GPS Timeout - versuche weiter...');
                    }
                },
                { 
                    enableHighAccuracy: true, 
                    maximumAge: 5000,
                    timeout: 10000
                }
            );
            
            console.log('‚úÖ GPS Watch gestartet, ID:', watchId);
        }

        function stopDriverTracking() {
            if (watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; }
            if (isFirebaseReady && currentVehicle) db.ref('drivers/' + currentVehicle).remove();
        }

        async function showAvailableTaxis() {
            if (!pickupCoords || !isFirebaseReady) return;
            
            // NUR ONLINE FAHRER mit GPS aktiv
            const onlineDrivers = Object.values(drivers).filter(d => d.online && d.timestamp && (Date.now() - d.timestamp) < 60000);
            
            if (onlineDrivers.length === 0) {
                document.getElementById('available-taxis-display').innerHTML = '<div class="alert-info">‚è≥ Momentan keine Taxis verf√ºgbar</div>';
                return;
            }
            const taxisWithETA = await Promise.all(onlineDrivers.map(async (d) => {
                const route = await calculateRoute(d, pickupCoords);
                return { ...d, ...route };
            }));
            taxisWithETA.sort((a, b) => a.distance - b.distance);
            const html = `<div class="available-taxis"><h3>üöï ${taxisWithETA.length} Taxis verf√ºgbar</h3>` +
                taxisWithETA.slice(0, 3).map(t => `<div class="taxi-item"><strong>${t.vehicle}</strong><br>üìç ${t.distance} km entfernt (ca. ${t.duration} Min)</div>`).join('') +
                `<div style="margin-top:10px;padding:10px;background:#e0f2fe;border-radius:8px;text-align:center;"><strong>N√§chstes Taxi in ca. ${taxisWithETA[0].duration} Minuten!</strong></div></div>`;
            document.getElementById('available-taxis-display').innerHTML = html;
        }

        function setVehicle() {
            const vehicleId = document.getElementById('vehicle').value;
            currentVehicle = vehicleId;
            console.log('üöó Fahrzeug gew√§hlt:', currentVehicle);
            if (currentVehicle && isOnline) startDriverTracking(null);
            updateViews(); // Force update
        }
        
        function loadSavedVehicle() {
            const dropdown = document.getElementById('vehicle');
            if (dropdown && dropdown.value) {
                currentVehicle = dropdown.value;
                console.log('üîÑ Gespeichertes Fahrzeug geladen:', currentVehicle);
                updateViews();
            }
        }

        async function acceptRide(rideId) {
            if (!currentVehicle) { alert('‚ùå Bitte Fahrzeug w√§hlen!'); return; }
            
            // Finde die Fahrt
            const ride = rides.find(r => r.firebaseId === rideId);
            if (!ride) { alert('‚ùå Fahrt nicht gefunden!'); return; }
            
            // Pr√ºfe Abholzeit
            if (ride.pickupTimestamp && ride.pickupTimestamp > Date.now()) {
                const minutesUntilPickup = Math.round((ride.pickupTimestamp - Date.now()) / 60000);
                const pickupTimeStr = ride.pickupTime || 'sp√§ter';
                
                const confirm = window.confirm(
                    `‚ö†Ô∏è ACHTUNG!\n\n` +
                    `Abholung erst um ${pickupTimeStr}\n` +
                    `Das ist in ${minutesUntilPickup} Minuten!\n\n` +
                    `Trotzdem jetzt annehmen und losfahren?`
                );
                
                if (!confirm) {
                    return; // Abgebrochen
                }
            }
            
            console.log('‚úÖ Nehme Fahrt an:', rideId);
            
            // Schalte automatisch auf Online wenn noch nicht
            if (!isOnline) {
                document.getElementById('online-toggle').checked = true;
                toggleOnline();
            }
            
            const vehicleName = VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle;
            
            await updateRide(rideId, { 
                status: 'accepted', 
                vehicleId: currentVehicle,
                vehicle: vehicleName,
                driver: vehicleName,
                acceptedAt: Date.now()
            });
            
            // Starte GPS-Tracking f√ºr diese Fahrt
            startDriverTracking(rideId);
            
            alert('‚úÖ Auftrag angenommen! GPS wird aktiviert...');
        }

        async function pickupCustomer(rideId) {
            await updateRide(rideId, { 
                status: 'picked_up',
                pickedUpAt: Date.now() 
            });
            console.log('‚úÖ Kunde abgeholt - Status: picked_up');
            alert('‚úÖ Kunde eingestiegen! Status: Besetzt');
        }

        async function completeRide(rideId) {
            await updateRide(rideId, { 
                status: 'completed', 
                driverLocation: null,
                completedAt: Date.now()
            });
            if (etaUpdateInterval) { clearInterval(etaUpdateInterval); etaUpdateInterval = null; }
            stopDriverTracking();
            alert('‚úÖ Fahrt abgeschlossen! Sie sind wieder verf√ºgbar.');
        }

        function listenToMyRide(firebaseId) {
            if (!isFirebaseReady || !firebaseId) return;
            
            console.log('üëÇ Lausche auf Fahrt:', firebaseId);
            
            db.ref('rides/' + firebaseId).on('value', (snapshot) => {
                const ride = snapshot.val();
                if (!ride) return;
                
                ride.firebaseId = firebaseId;
                myCurrentRide = ride;
                
                console.log('üîÑ Fahrt Update:', ride.status, ride.vehicle || 'kein Fahrzeug');
                
                showRideStatus(ride);
            });
        }

        function initApp(hasFirebase) {
            clearTimeout(firebaseLoadTimeout);
            if (hasFirebase && typeof firebase !== 'undefined') {
                try {
                    firebase.initializeApp({
                        apiKey: "AIzaSyD2eHFuplImxBCijd3MWlKyCwXUZHLmhhE",
                        authDomain: "taxi-heringsdorf.firebaseapp.com",
                        databaseURL: "https://taxi-heringsdorf-default-rtdb.europe-west1.firebasedatabase.app",
                        projectId: "taxi-heringsdorf",
                        storageBucket: "taxi-heringsdorf.firebasestorage.app",
                        messagingSenderId: "886448081276",
                        appId: "1:886448081276:web:1b54875801c5d89f8efcf9"
                    });
                    db = firebase.database();
                    isFirebaseReady = true;
                    db.ref('.info/connected').on('value', (s) => { isConnected = s.val(); updateStatus(); });
                    db.ref('rides').on('value', (s) => {
                        const previousCount = rides.filter(r => r.status === 'new').length;
                        rides = [];
                        s.forEach(c => {
                            const r = c.val();
                            r.firebaseId = c.key;
                            rides.push(r);
                            if (myCurrentRide && r.id === myCurrentRide.id) {
                                myCurrentRide = r;
                                if (r.status === 'accepted' && r.driverLocation) {
                                    showRideStatus(r);
                                }
                            }
                        });
                        
                        // SIGNALTON bei NEUEN Auftr√§gen
                        const currentCount = rides.filter(r => r.status === 'new').length;
                        if (currentCount > previousCount && currentView === 'driver') {
                            playDriverNotificationSound();
                        }
                        
                        updateViews();
                    });
                    db.ref('drivers').on('value', (s) => { drivers = {}; s.forEach(c => { drivers[c.key] = c.val(); }); showAvailableTaxis(); });
                } catch (e) { console.error(e); }
            }
            updateStatus();
        }

        function updateStatus() {
            const dot = document.getElementById('sync-dot'), status = document.getElementById('sync-status');
            if (isFirebaseReady && isConnected) { dot.classList.add('online'); status.textContent = 'üü¢ Live'; }
            else { dot.classList.remove('online'); status.textContent = 'üíæ Lokal'; }
        }

        async function saveRide(ride) {
            if (isFirebaseReady) {
                const ref = db.ref('rides').push();
                ride.firebaseId = ref.key;
                await ref.set(ride);
            }
            return ride;
        }

        async function updateRide(id, updates) {
            if (isFirebaseReady) await db.ref('rides/' + id).update(updates);
        }

        function updateViews() {
            // Update Debug Panel
            if (document.getElementById('debug-firebase')) {
                document.getElementById('debug-firebase').textContent = isFirebaseReady ? (isConnected ? '‚úÖ Verbunden' : '‚ö†Ô∏è Offline') : '‚ùå Fehler';
                document.getElementById('debug-rides').textContent = rides.length;
                document.getElementById('debug-new').textContent = rides.filter(r => r.status === 'new').length;
                document.getElementById('debug-sync').textContent = new Date().toLocaleTimeString('de-DE');
            }
            
            if (currentView === 'driver') updateDriverView();
            else if (currentView === 'admin') updateAdminView();
        }

        function updateDriverView() {
            const newRides = rides.filter(r => r.status === 'new');
            const myRides = currentVehicle ? rides.filter(r => r.vehicleId === currentVehicle || r.vehicle === (VEHICLES[currentVehicle] ? VEHICLES[currentVehicle].name : currentVehicle)) : [];
            const current = myRides.find(r => r.status === 'accepted' || r.status === 'picked_up');
            const completed = myRides.filter(r => r.status === 'completed');
            
            if (current) {
                let buttonHtml = '';
                if (current.status === 'accepted') {
                    buttonHtml = `<button class="btn btn-success" onclick="pickupCustomer('${current.firebaseId}')" style="margin-top:10px;">üöï Kunde abgeholt</button>`;
                } else if (current.status === 'picked_up') {
                    buttonHtml = `
                        <div style="margin-top:10px;padding:12px;background:#fef3c7;border-radius:8px;text-align:center;font-weight:600;color:#92400e;">
                            üöó BESETZT - Fahrt l√§uft
                        </div>
                        <button class="btn btn-success" onclick="completeRide('${current.firebaseId}')" style="margin-top:10px;">‚úì Fahrt abschlie√üen</button>
                    `;
                }
                
                document.getElementById('driver-current-ride').innerHTML = `
                    <div class="alert-info">
                        <strong>Aktuelle Fahrt #${current.id}</strong><br>
                        ${current.customerName ? `<strong>üë§ ${current.customerName}</strong><br>` : ''}
                        Von: ${current.pickup}<br>
                        Nach: ${current.destination}<br>
                        Preis: ${current.price}‚Ç¨
                        ${buttonHtml}
                    </div>`;
            } else {
                document.getElementById('driver-current-ride').innerHTML = currentVehicle && isOnline ? '<div class="alert-info">üü¢ Bereit f√ºr Auftr√§ge</div>' : '';
            }
            
            // ZEIGE AUFTR√ÑGE SOBALD FAHRZEUG GEW√ÑHLT IST
            if (!currentVehicle) {
                document.getElementById('new-rides').innerHTML = '<div style="padding:20px;text-align:center;color:#999;">‚ö†Ô∏è Bitte erst Fahrzeug w√§hlen</div>';
            } else if (newRides.length === 0) {
                document.getElementById('new-rides').innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Keine neuen Auftr√§ge</div>';
            } else {
                // ZEIGE ALLE NEUEN AUFTR√ÑGE
                let ridesHtml = newRides.map(r => `
                    <div class="ride-card">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <strong>#${r.id}</strong>
                            <span style="background:#fef3c7;padding:4px 8px;border-radius:12px;font-size:12px;">üÜï Neu</span>
                        </div>
                        <div style="margin-top:12px;padding:12px;background:#f0f9ff;border-radius:8px;border-left:4px solid #3b82f6;">
                            <div style="font-size:16px;font-weight:600;color:#1e40af;margin-bottom:8px;">
                                üë§ ${r.customerName || 'Kunde'}
                            </div>
                            <div style="font-size:14px;color:#0369a1;">
                                üïê Abholung: <strong>${r.pickupTime || 'Sofort'}</strong>
                            </div>
                        </div>
                        <div style="margin-top:10px;font-size:14px;">
                            <strong>Von:</strong> ${r.pickup}<br>
                            <strong>Nach:</strong> ${r.destination}<br>
                            <strong>Distanz:</strong> ${r.distance} km ‚Ä¢ ${r.duration} Min<br>
                            <strong>Preis:</strong> ${r.price}‚Ç¨<br>
                            <small style="color:#666;">Bestellt: ${r.time}</small>
                        </div>
                        ${!current ? `<button class="btn btn-success" onclick="acceptRide('${r.firebaseId}')" style="margin-top:10px;">‚úì Annehmen</button>` : '<div style="margin-top:10px;padding:8px;background:#fef3c7;border-radius:6px;font-size:13px;text-align:center;">Schlie√üe erst aktuelle Fahrt ab</div>'}
                    </div>
                `).join('');
                
                // Warnung wenn Offline
                if (!isOnline) {
                    ridesHtml = '<div class="alert-info" style="margin-bottom:15px;">‚ö†Ô∏è Du bist <strong>Offline</strong>. Schalte auf Online um Auftr√§ge anzunehmen.</div>' + ridesHtml;
                }
                
                document.getElementById('new-rides').innerHTML = ridesHtml;
            }
            
            const revenue = completed.reduce((sum, r) => sum + parseFloat(r.price), 0);
            document.getElementById('d-rides').textContent = completed.length;
            document.getElementById('d-money').textContent = revenue.toFixed(2) + '‚Ç¨';
        }

        function updateAdminView() {
            const completed = rides.filter(r => r.status === 'completed');
            const pending = rides.filter(r => r.status === 'new');
            const active = rides.filter(r => r.status === 'accepted' || r.status === 'picked_up');
            const revenue = completed.reduce((sum, r) => sum + parseFloat(r.price), 0);
            document.getElementById('a-total').textContent = completed.length;
            document.getElementById('a-revenue').textContent = revenue.toFixed(2) + '‚Ç¨';
            document.getElementById('a-pending').textContent = pending.length;
            document.getElementById('a-active').textContent = active.length;
            if (rides.length === 0) {
                document.getElementById('all-rides').innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Keine Fahrten</div>';
            } else {
                document.getElementById('all-rides').innerHTML = rides.slice().reverse().map(r => {
                    let statusText = r.status;
                    let statusColor = '#fef3c7';
                    if (r.status === 'completed') { statusText = 'Abgeschlossen'; statusColor = '#d1fae5'; }
                    else if (r.status === 'accepted') { statusText = 'Unterwegs'; statusColor = '#dbeafe'; }
                    else if (r.status === 'picked_up') { statusText = 'Besetzt'; statusColor = '#fef3c7'; }
                    else if (r.status === 'new') { statusText = 'Neu'; statusColor = '#fef3c7'; }
                    
                    return `<div class="ride-card"><strong>#${r.id}</strong> <span style="background:${statusColor};padding:4px 8px;border-radius:12px;font-size:12px;">${statusText}</span><div style="margin-top:10px;font-size:14px;">Von: ${r.pickup}<br>Nach: ${r.destination}<br>${r.distance} km<br>Preis: ${r.price}‚Ç¨${r.vehicle ? '<br>Fahrzeug: '+r.vehicle : ''}</div></div>`;
                }).join('');
            }
        }

        async function resetDatabase() {
            const confirmation = confirm('‚ö†Ô∏è ACHTUNG!\n\nALLE Fahrten werden unwiderruflich gel√∂scht!\n\nFortfahren?');
            if (!confirmation) return;
            
            const doubleCheck = confirm('üö® Letzte Warnung!\n\nWirklich ALLE Fahrten l√∂schen?\n\nDies kann nicht r√ºckg√§ngig gemacht werden!');
            if (!doubleCheck) return;
            
            if (!isFirebaseReady) {
                alert('‚ùå Firebase nicht verbunden!');
                return;
            }
            
            try {
                console.log('üóëÔ∏è L√∂sche Datenbank...');
                
                // L√∂sche alle Fahrten
                await db.ref('rides').remove();
                
                // L√∂sche alle Fahrer-Positionen
                await db.ref('drivers').remove();
                
                // Lokale Daten zur√ºcksetzen
                rides = [];
                drivers = {};
                myCurrentRide = null;
                localStorage.removeItem('myCurrentRideId');
                localStorage.removeItem('taxi-rides');
                
                alert('‚úÖ Datenbank erfolgreich zur√ºckgesetzt!\n\nAlle Fahrten wurden gel√∂scht.');
                
                // Views aktualisieren
                updateViews();
                
                console.log('‚úÖ Datenbank zur√ºckgesetzt');
            } catch (error) {
                console.error('‚ùå Fehler beim Zur√ºcksetzen:', error);
                alert('‚ùå Fehler: ' + error.message);
            }
        }

        function switchView(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(view + '-view').classList.add('active');
            event.target.classList.add('active');
            currentView = view;
            
            const gpsIndicator = document.getElementById('gps-indicator');
            if (view === 'driver') gpsIndicator.style.display = 'flex';
            else gpsIndicator.style.display = 'none';
            
            if (view === 'history') loadHistory();
            
            updateViews();
        }

        window.addEventListener('DOMContentLoaded', () => {
            setupAutocomplete();
            setTimeout(() => { 
                if (firebaseLoaded && typeof firebase !== 'undefined') initApp(true); 
                else initApp(false); 
                
                // Lade gespeicherte Fahrt wenn vorhanden
                const savedRideId = localStorage.getItem('myCurrentRideId');
                if (savedRideId && isFirebaseReady) {
                    console.log('üîÑ Lade gespeicherte Fahrt:', savedRideId);
                    listenToMyRide(savedRideId);
                }
                
                // Lade gew√§hltes Fahrzeug
                loadSavedVehicle();
            }, 100);
            setInterval(() => { 
                if (pickupCoords) showAvailableTaxis(); 
                if (myCurrentRide && myCurrentRide.status === 'accepted') showRideStatus(myCurrentRide);
            }, 30000);
            
            // Reaktiviere Wake Lock wenn Seite wieder sichtbar
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && isOnline && wakeLock === null) {
                    requestWakeLock();
                    console.log('üîÑ Wake Lock reaktiviert');
                }
            });
        });
    </script>
</body>
</html>
