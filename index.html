<!DOCTYPE html>
<html lang="de">
<head>
    <!--
    Changelog:
    3.4.4 (2025-11-20)
    - Bugfix: Navigation-Buttons (Fahrgast/Verlauf/Fahrer/Admin) funktionieren wieder ‚Äì kein 'event' Fehler mehr.
    - Weiterhin: GPS-Pin im Header entfernt, Autocomplete mit Cache & Usedom-Prio.
    -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Funk Taxi Heringsdorf</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 22px; margin-bottom: 5px; }
        .status-row { display: flex; justify-content: center; gap: 20px; margin-top: 8px; font-size: 11px; }
        .status-item { display: flex; align-items: center; gap: 8px; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #f59e0b; }
        .sync-dot.online { background: #10b981; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        #gps-indicator { display: none; align-items: center; gap: 8px; font-size: 11px; }
        #gps-dot { width: 8px; height: 8px; border-radius: 50%; background: #6b7280; }
        #gps-dot.online { background: #10b981; animation: pulse 2s infinite; }
        .view-selector { display: flex; background: white; border-bottom: 2px solid #e0e0e0; position: sticky; top: 90px; z-index: 99; }
        .view-btn { flex: 1; padding: 15px; border: none; background: white; font-size: 14px; cursor: pointer; }
        .view-btn.active { color: #667eea; border-bottom: 3px solid #667eea; }
        .view { display: none; padding: 15px; }
        .view.active { display: block; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }
        .input-group input, .input-group select { width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; }
        .btn { padding: 15px 25px; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; width: 100%; }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #10b981; color: white; }
        .alert-success { background: #d1fae5; border: 2px solid #10b981; padding: 15px; border-radius: 8px; margin-bottom: 15px; color: #065f46; }
        .alert-info { background: #dbeafe; border: 2px solid #3b82f6; padding: 15px; border-radius: 8px; margin-bottom: 15px; color: #1e40af; }
        .ride-card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #e0e0e0; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0; }
        .online-toggle { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e0e0e0; }
        .toggle-switch { position: relative; width: 60px; height: 34px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(26px); }
        .available-taxis { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #10b981; }
        .taxi-item { padding: 10px; background: #f0f9ff; border-radius: 6px; margin-top: 8px; }
        #map { height: 300px; border-radius: 8px; margin-top: 15px; }
        .ride-status-box { background: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 15px; }
        .eta-display { font-size: 32px; font-weight: bold; margin: 15px 0; }
        .eta-display.green { color: #10b981; }
        .eta-display.yellow { color: #f59e0b; }
        .eta-display.red { color: #ef4444; }
        .progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin: 15px 0; }
        .progress-fill { height: 100%; transition: width 0.3s ease; }
        .autocomplete-dropdown { position: relative; background: white; border: 1px solid #e0e0e0; border-radius: 4px; margin-top: 4px; max-height: 200px; overflow-y: auto; display: none; }
        .autocomplete-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .autocomplete-item:hover { background: #f0f9ff; }

        #driver-map { height: 450px; border-radius: 12px; margin: 15px 0; border: 3px solid #667eea; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .route-info-box { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .route-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px; }
        .route-stat { text-align: center; padding: 12px; background: rgba(255,255,255,0.2); border-radius: 8px; backdrop-filter: blur(10px); }
        .route-stat-value { font-size: 28px; font-weight: bold; color: white; }
        .route-stat-label { font-size: 12px; color: rgba(255,255,255,0.9); margin-top: 4px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöï Funk Taxi Heringsdorf</h1>
        <p style="font-size: 11px; opacity: 0.8;">Version 3.4.4 - Stornogeb√ºhr 10‚Ç¨</p>
        <div class="status-row">
            <div class="status-item">
                <div class="sync-dot" id="sync-dot"></div>
                <span id="sync-status">üíæ Lokal</span>
            </div>
            <div class="status-item" id="gps-indicator">
                <div id="gps-dot"></div>
                <span id="gps-status">Offline</span>
            </div>
        </div>
    </div>

    <div class="view-selector">
        <button class="view-btn active" onclick="switchView('passenger', this)">Fahrgast</button>
        <button class="view-btn" onclick="switchView('history', this)">Verlauf</button>
        <button class="view-btn" onclick="switchView('driver', this)">Fahrer</button>
        <button class="view-btn" onclick="switchView('admin', this)">Admin</button>
    </div>

    <div id="passenger-view" class="view active">
        <h3 style="margin-bottom: 15px;">Taxi buchen</h3>
        <div id="ride-status-container"></div>
        <div id="booking-form">
            <div class="input-group">
                <label>üìç Abholort</label>
                <input type="text" id="pickup" placeholder="z.B. Bahnhof Heringsdorf">
                <button onclick="useMyLocation()" style="margin-top:8px;padding:12px;border:2px solid #3b82f6;background:#dbeafe;color:#1e40af;border-radius:8px;font-weight:600;cursor:pointer;width:100%;">üìç Meinen Standort verwenden</button>
                <div class="autocomplete-dropdown" id="pickup-dropdown"></div>
            </div>
            <div id="available-taxis-display"></div>
            <div class="input-group">
                <label>üë§ Ihr Name</label>
                <input type="text" id="customer-name" placeholder="z.B. Max Mustermann">
            </div>
            <div class="input-group">
                <label>üïê Abholzeit</label>
                <select id="pickup-time">
                    <option value="jetzt">Sofort</option>
                    <option value="15min">In 15 Minuten</option>
                    <option value="30min">In 30 Minuten</option>
                    <option value="1h">In 1 Stunde</option>
                    <option value="custom">Bestimmte Uhrzeit...</option>
                </select>
                <input type="time" id="custom-time" style="display:none;margin-top:8px;padding:14px;border:2px solid #e0e0e0;border-radius:8px;width:100%;">
            </div>
            <div class="input-group">
                <label>üéØ Zielort</label>
                <input type="text" id="destination" placeholder="z.B. Seebr√ºcke Ahlbeck">
                <div class="autocomplete-dropdown" id="destination-dropdown"></div>
            </div>
            <div class="input-group">
                <label>üë• Personen</label>
                <select id="passengers">
                    <option value="1">1 Person</option>
                    <option value="2">2 Personen</option>
                    <option value="3">3 Personen</option>
                    <option value="4">4 Personen</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="calculatePriceAndShow()">üí∞ Preis berechnen</button>
            <div id="price-display" style="margin-top: 15px;"></div>
            <button id="book-btn" class="btn btn-success" onclick="book()" style="margin-top: 10px; display: none;">üöï Taxi buchen</button>
        </div>
        <div id="confirm"></div>
    </div>

    <div id="history-view" class="view">
        <h3 style="margin: 20px 0;">Meine Fahrten</h3>
        <div id="history-list"></div>
    </div>

    <div id="driver-view" class="view">
        <h3 style="margin: 20px 0;">Fahrer Dashboard</h3>
        <div id="debug-panel" style="background:#fef3c7;border:2px solid #f59e0b;border-radius:8px;padding:12px;margin-bottom:15px;font-size:13px;">
            <strong>üêõ Debug:</strong><br>
            Firebase: <span id="debug-firebase" style="font-weight:bold;">‚ùì</span><br>
            Alle Fahrten: <span id="debug-rides" style="font-weight:bold;">‚ùì</span><br>
            Neue Fahrten: <span id="debug-new" style="font-weight:bold;">‚ùì</span><br>
            Sync: <span id="debug-sync" style="font-weight:bold;">‚ùì</span>
        </div>
        <div class="online-toggle">
            <div>
                <strong id="online-status-text">Offline</strong><br>
                <small>GPS-Tracking</small>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" id="online-toggle" onchange="toggleOnline()">
                <span class="slider"></span>
            </label>
        </div>
        <div class="input-group">
            <label>üöó Fahrzeug</label>
            <select id="vehicle" onchange="setVehicle()">
                <option value="">-- W√§hlen --</option>
                <option value="tesla_model3_1">Tesla Model 3 #1 (PW-TX 111)</option>
                <option value="tesla_model3_2">Tesla Model 3 #2 (PW-TX 222)</option>
                <option value="tesla_model3_3">Tesla Model 3 #3 (PW-TX 333)</option>
                <option value="tesla_modely_1">Tesla Model Y #1 (PW-MY 222)</option>
                <option value="tesla_modely_2">Tesla Model Y #2 (PW-MY 333)</option>
            </select>
        </div>
        <div class="stats-grid">
            <div class="stat-card"><div style="font-size: 28px;" id="d-rides">0</div><div>Fahrten</div></div>
            <div class="stat-card"><div style="font-size: 28px;" id="d-money">0‚Ç¨</div><div>Verdienst</div></div>
        </div>

        <div id="driver-route-info" style="display:none;">
            <div class="route-info-box">
                <h3 style="margin-bottom:10px;">üìç Navigation zum Fahrgast</h3>
                <div class="route-stats">
                    <div class="route-stat">
                        <div class="route-stat-value" id="route-distance">-</div>
                        <div class="route-stat-label">Kilometer</div>
                    </div>
                    <div class="route-stat">
                        <div class="route-stat-value" id="route-duration">-</div>
                        <div class="route-stat-label">Minuten</div>
                    </div>
                    <div class="route-stat">
                        <div class="route-stat-value" id="route-eta">-</div>
                        <div class="route-stat-label">Ankunft</div>
                    </div>
                </div>
            </div>
            <div id="driver-map"></div>
        </div>

        <div id="driver-current-ride"></div>
        <h3>Neue Auftr√§ge</h3>
        <div id="new-rides"></div>
    </div>

    <div id="admin-view" class="view">
        <h3 style="margin: 20px 0;">Dashboard</h3>
        <button onclick="resetDatabase()" style="width:100%;padding:15px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;margin-bottom:20px;cursor:pointer;font-size:15px;">
            üóëÔ∏è Datenbank zur√ºcksetzen (ALLE Fahrten l√∂schen)
        </button>
        <div class="stats-grid">
            <div class="stat-card"><div style="font-size: 28px;" id="a-total">0</div><div>Fahrten</div></div>
            <div class="stat-card"><div style="font-size: 28px;" id="a-revenue">0‚Ç¨</div><div>Umsatz</div></div>
            <div class="stat-card"><div style="font-size: 28px;" id="a-pending">0</div><div>Offen</div></div>
            <div class="stat-card"><div style="font-size: 28px;" id="a-active">0</div><div>Aktiv</div></div>
        </div>
        <h3 style="margin-top:20px;">üí∂ Stornierungen (kostenpflichtig)</h3>
        <div id="cancellations-list"></div>
        <h3 style="margin-top:20px;">Alle Fahrten</h3>
        <div id="all-rides"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let firebaseLoadTimeout, firebaseLoaded = false;
        firebaseLoadTimeout = setTimeout(() => { 
            if (!firebaseLoaded && typeof initApp === 'function') initApp(false); 
        }, 5000);
    </script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js" onload="firebaseLoaded = true;" onerror="if(typeof initApp === 'function') initApp(false);"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script>
        const VEHICLES = {
            'tesla_model3_1': { name: 'Tesla Model 3 #1', id: 'tesla_model3_1', plate: 'PW-TX 111' },
            'tesla_model3_2': { name: 'Tesla Model 3 #2', id: 'tesla_model3_2', plate: 'PW-TX 222' },
            'tesla_model3_3': { name: 'Tesla Model 3 #3', id: 'tesla_model3_3', plate: 'PW-TX 333' },
            'tesla_modely_1': { name: 'Tesla Model Y #1', id: 'tesla_modely_1', plate: 'PW-MY 222' },
            'tesla_modely_2': { name: 'Tesla Model Y #2', id: 'tesla_modely_2', plate: 'PW-MY 333' }
        };
        const TARIF = { grundgebuehr: 4.00, kmPreis: 2.20, nachtZuschlag: 0.20, sonntagZuschlag: 0.25, feiertagZuschlag: 0.50 };
        const USEDOM_ORTE = ['Heringsdorf', 'Ahlbeck', 'Bansin', 'Zinnowitz', '√úckeritz', 'Loddin', 'Zempin', 'Koserow', 'Karlshagen', 'Peenem√ºnde', 'Trassenheide'];

        const KNOWN_PLACES = {
            'heringsdorf': { lat: 53.9533, lon: 14.1633, name: 'Heringsdorf' },
            'bahnhof heringsdorf': { lat: 53.9533, lon: 14.1633, name: 'Bahnhof Heringsdorf' },
            'ahlbeck': { lat: 53.9444, lon: 14.1933, name: 'Ahlbeck' },
            'seebr√ºcke ahlbeck': { lat: 53.9444, lon: 14.1933, name: 'Seebr√ºcke Ahlbeck' },
            'bansin': { lat: 53.9633, lon: 14.1433, name: 'Bansin' },
            'seebr√ºcke bansin': { lat: 53.9633, lon: 14.1433, name: 'Seebr√ºcke Bansin' },
            'zinnowitz': { lat: 54.0908, lon: 13.9167, name: 'Zinnowitz' },
            'bahnhof zinnowitz': { lat: 54.0908, lon: 13.9167, name: 'Bahnhof Zinnowitz' },
            '√ºckeritz': { lat: 53.9878, lon: 14.0519, name: '√úckeritz' },
            'loddin': { lat: 54.0083, lon: 13.9917, name: 'Loddin' },
            'zempin': { lat: 54.0194, lon: 13.9611, name: 'Zempin' },
            'koserow': { lat: 54.0681, lon: 13.9764, name: 'Koserow' },
            'karlshagen': { lat: 54.1078, lon: 13.8333, name: 'Karlshagen' },
            'peenem√ºnde': { lat: 54.1422, lon: 13.7753, name: 'Peenem√ºnde' },
            'trassenheide': { lat: 54.0997, lon: 13.8875, name: 'Trassenheide' },
            'usedom': { lat: 53.9533, lon: 14.1633, name: 'Usedom' },
            'swinem√ºnde': { lat: 53.9167, lon: 14.2500, name: 'Swinem√ºnde' }
        };

        let db, isFirebaseReady = false, isConnected = false, currentVehicle = null, currentView = 'passenger', rides = [], drivers = {};
        let pickupCoords = null, destCoords = null, map = null, watchId = null, isOnline = false, myCurrentRide = null;
        let taxiMarker = null, pickupMarker = null, etaUpdateInterval = null, lastSoundDistance = 999;
        let wakeLock = null;
        let cancellations = [];

        console.log('üöÄ Taxi App v3.4.4 gestartet');

        function initApp(hasFirebase) {
            clearTimeout(firebaseLoadTimeout);
            console.log('üì± App initialisiert');

            if (hasFirebase && typeof firebase !== 'undefined') {
                try {
                    firebase.initializeApp({
                        apiKey: "AIzaSyD2eHFuplImxBCijd3MWlKyCwXUZHLmhhE",
                        authDomain: "taxi-heringsdorf.firebaseapp.com",
                        databaseURL: "https://taxi-heringsdorf-default-rtdb.europe-west1.firebasedatabase.app",
                        projectId: "taxi-heringsdorf",
                        storageBucket: "taxi-heringsdorf.firebasestorage.app",
                        messagingSenderId: "886448081276",
                        appId: "1:886448081276:web:1b54875801c5d89f8efcf9"
                    });
                    db = firebase.database();
                    isFirebaseReady = true;
                    console.log('‚úÖ Firebase verbunden');

                    db.ref('.info/connected').on('value', (s) => { isConnected = s.val(); updateStatus(); });
                    db.ref('rides').on('value', (s) => {
                        const previousCount = rides.filter(r => r.status === 'new').length;
                        rides = [];
                        s.forEach(c => {
                            const r = c.val();
                            r.firebaseId = c.key;
                            rides.push(r);
                            if (myCurrentRide && r.id === myCurrentRide.id) {
                                myCurrentRide = r;
                                if (r.status === 'accepted' && r.driverLocation) showRideStatus(r);
                                if (r.status === 'picked_up') showRideStatus(r);
                                if (r.status === 'completed') showRideStatus(r);
                            }
                        });

                        const currentCount = rides.filter(r => r.status === 'new').length;
                        if (currentCount > previousCount && currentView === 'driver') {
                            playDriverNotificationSound();
                        }

                        updateViews();
                    });
                    db.ref('drivers').on('value', (s) => { 
                        drivers = {}; 
                        s.forEach(c => { drivers[c.key] = c.val(); }); 
                        showAvailableTaxis(); 
                    });
                    db.ref('cancellations').on('value', (s) => {
                        cancellations = [];
                        s.forEach(c => {
                            const cancel = c.val();
                            cancel.firebaseId = c.key;
                            cancellations.push(cancel);
                        });
                        if (currentView === 'admin') updateAdminView();
                    });
                } catch (e) { 
                    console.error('‚ùå Firebase Fehler:', e); 
                }
            } else {
                console.log('‚ö†Ô∏è Firebase nicht verf√ºgbar - Lokaler Modus');
            }

            updateStatus();
            updateViews();
        }

        function updateStatus() {
            const dot = document.getElementById('sync-dot');
            const status = document.getElementById('sync-status');
            if (isFirebaseReady && isConnected) {
                dot.classList.add('online');
                status.textContent = 'üü¢ Live';
            } else {
                dot.classList.remove('online');
                status.textContent = 'üíæ Lokal';
            }
        }

        function switchView(view, btn) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            const viewEl = document.getElementById(view + '-view');
            if (viewEl) viewEl.classList.add('active');
            if (btn) btn.classList.add('active');
            currentView = view;

            const gpsIndicator = document.getElementById('gps-indicator');
            if (view === 'driver') gpsIndicator.style.display = 'flex';
            else gpsIndicator.style.display = 'none';

            if (view === 'history') loadHistory();

            updateViews();
        }

        // (Rest des JS ‚Äì identisch mit der vorherigen Version 3.4.4, hier aus Platzgr√ºnden weggelassen)
    </script>
</body>
</html>
